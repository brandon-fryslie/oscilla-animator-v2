# Exploration: Fix HIGH Priority Stride Architecture Debt
Timestamp: 2026-01-26-144549

## Raw Findings

### 1. Canonical Stride System (SOURCE OF TRUTH)

**Location:** `/Users/bmf/code/oscilla-animator-v2/src/core/canonical-types.ts`

```typescript
// Lines 223-232
export const PAYLOAD_STRIDE: Record<ConcretePayloadType, number> = {
  float: 1,
  int: 1,
  bool: 1,
  vec2: 2,
  vec3: 3,
  color: 4,
  shape: 8,  // Shape descriptor has 8 scalar fields
  cameraProjection: 1,  // Single scalar slot (stored as numeric, interpreted as int32)
};

// Lines 241-247
export function strideOf(type: PayloadType): number {
  if (isPayloadVar(type)) {
    throw new Error(`Cannot get stride for payload variable ${type.id} - resolve payload first`);
  }
  return PAYLOAD_STRIDE[type as ConcretePayloadType];
}
```

**Current Usage:** 115+ imports across blocks/*, compiler/passes-v2/combine-utils.ts

### 2. Duplicated Switch Statements in IRBuilderImpl.ts

**Location:** `/Users/bmf/code/oscilla-animator-v2/src/compiler/ir/IRBuilderImpl.ts`

**First Duplicate (lines 497-519):**
```typescript
  allocTypedSlot(type: SignalType, _label?: string): ValueSlot {
    // Compute stride from payload
    let stride: number;
    switch (type.payload) {
      case 'float':
      case 'int':
      case 'bool':
      case 'cameraProjection':
        stride = 1;
        break;
      case 'vec2':
        stride = 2;
        break;
      case 'vec3':
        stride = 3;
        break;
      case 'color':
        stride = 4;
        break;
      case 'shape':
        stride = 0; // Shape slots don't occupy f64 storage
        break;
      default:
        stride = 1; // Fallback
    }
    ...
  }
```

**Second Duplicate (lines 558-580):**
```typescript
  getSlotMetaInputs(): ReadonlyMap<ValueSlot, { readonly type: SignalType; readonly stride: number }> {
    const result = new Map<ValueSlot, { readonly type: SignalType; readonly stride: number }>();
    for (const [slot, type] of this.slotTypes) {
      // Import payloadStride inline to compute stride from payload type
      let stride: number;
      switch (type.payload) {
        case 'float':
        case 'int':
        case 'bool':
        case 'cameraProjection':
          stride = 1;
          break;
        case 'vec2':
          stride = 2;
          break;
        case 'vec3':
          stride = 3;
          break;
        case 'color':
          stride = 4;
          break;
        case 'shape':
          stride = 0;
          break;
        default:
          stride = 1; // Fallback
      }
      ...
    }
  }
```

**Observations:**
- Both switches are ALMOST identical to PAYLOAD_STRIDE but handle `shape: 0` differently (PAYLOAD_STRIDE has `shape: 8`)
- Contains dangerous `default: stride = 1` fallback that masks type errors
- No `strideOf()` import despite comment "// Import payloadStride inline"

### 3. Rendering Magic Numbers

**Canvas2DRenderer.ts:** `/Users/bmf/code/oscilla-animator-v2/src/render/canvas/Canvas2DRenderer.ts`
- Lines 151-152: `position[i * 2]`, `position[i * 2 + 1]` (vec2 stride)
- Lines 163-164: `scale2[i * 2]`, `scale2[i * 2 + 1]` (vec2 stride)
- Lines 183, 193: `i * 4` for color (color stride)
- Lines 232-233, 246-247, 249, 256, 269: Similar patterns
- Lines 304-305, etc.: Path point indexing `points[pointIndex * 2]`

**SVGRenderer.ts:** `/Users/bmf/code/oscilla-animator-v2/src/render/svg/SVGRenderer.ts`
- Lines 41-42, 48-49, etc.: `points[pi * 2]` (vec2 stride)
- Lines 232-233, 246: `position[i * 2] * width`
- Lines 259, 269: `i * 4` for color
- Lines 317, 322-323: Position stride 2

**RenderAssembler.ts:** `/Users/bmf/code/oscilla-animator-v2/src/runtime/RenderAssembler.ts`
- Lines 59-64: Buffer pool allocation uses magic numbers
- Lines 79-84: ensureBufferCapacity with stride multipliers
- Lines 225-230: Position stride 2, color stride 4
- Lines 233-240: Color compaction with `* 4` stride
- Lines 257-262: scale2 stride 2
- Lines 309-322: vec2 count * 2, vec3 count * 3
- Lines 687-693, 804-815: Projection output slicing
- Lines 973-978: scale2 slicing with `* 2`

### 4. Other Files with Payload Switches

**compiler/ir/bridges.ts (lines 210-220):** Payload type switch for default values
**compiler/ir/signalExpr.ts (lines 30-39):** Payload type switch
**runtime/BufferPool.ts (lines 35-51):** Allocation size by payload type
**blocks/signal-blocks.ts (lines 85-146):** LFO lowering with payload dispatch
**stores/DebugStore.ts (lines 30-35):** Debug value rendering
**diagnostics/validators/authoringValidators.ts (lines 356-387):** Validation
**ui/components/*.tsx:** Various UI components

### 5. ContinuityApply.ts (EXCLUDED)

**Location:** `/Users/bmf/code/oscilla-animator-v2/src/runtime/ContinuityApply.ts`
**Line 321:** `const stride = semantic === 'position' ? 2 : 1;`

This is semantic-based, not payload-based. Uses `semantic: 'position' | 'radius' | 'opacity' | 'color' | 'custom'`. Different pattern - not part of this scope.

### 6. Test Status

**All 103 test files pass, 1631 tests total:**
```
Test Files  103 passed (103)
Tests  1631 passed | 5 skipped (1636)
```

### 7. Relevant Tests for Changed Files

- `/src/compiler/ir/__tests__/` - No direct IRBuilderImpl tests found
- `/src/render/__tests__/SVGRenderer.test.ts`
- `/src/render/__tests__/stroke-rendering.test.ts`
- `/src/runtime/__tests__/RenderAssembler-perf.test.ts`

### 8. Projection/Layout Kernels

**perspective-kernel.ts, ortho-kernel.ts, layout-kernels.ts:**
- Use vec3 stride (3) and vec2 stride (2) throughout
- These are low-level kernels - magic numbers are arguably acceptable here

