# Evaluation: Fix HIGH Priority Stride Architecture Debt
Timestamp: 2026-01-26-144549
Git Commit: 4d28c18

## Executive Summary
Overall: 90% scope clarity | Critical issues: 0 | Tests reliable: yes

The work scope is well-defined with clear canonical patterns to follow. The existing `strideOf()` function and `PAYLOAD_STRIDE` constant provide the single source of truth. Implementation is straightforward replacement work with low risk.

## Runtime Check Results
| Check | Status | Output |
|-------|--------|--------|
| npm run test | PASS | 1631 tests passed, 5 skipped |
| TypeScript types | PASS | No compilation errors |
| strideOf() exists | PASS | Defined in canonical-types.ts:241-247 |

## Missing Checks
None needed for this scope - existing test coverage is sufficient for regression detection.

## Findings

### 1. IRBuilderImpl Duplicate Switches
**Status**: PARTIAL (duplicated logic needs consolidation)
**Evidence**:
- `src/compiler/ir/IRBuilderImpl.ts` lines 497-519 and 558-580
- Both contain identical switch statements on `type.payload`
**Issues**:
- **Shape stride discrepancy**: Local switches use `shape: 0` while `PAYLOAD_STRIDE` has `shape: 8`
- **Dangerous default fallback**: `default: stride = 1` masks type errors silently
- **Missing strideOf() import**: Comment says "Import payloadStride inline" but doesn't call it

**Confidence: HIGH** - Clear fix path: replace switch with `strideOf()` call, handle shape special case explicitly if needed

### 2. Rendering Magic Numbers
**Status**: PARTIAL (hardcoded but consistent)
**Evidence**:
- Canvas2DRenderer.ts: 12+ instances of `* 2` for vec2, `* 4` for color
- SVGRenderer.ts: 10+ instances of same patterns
- RenderAssembler.ts: 20+ instances throughout projection and slicing code
**Issues**:
- No semantic constants defined for rendering stride operations
- Pattern is consistent (`* 2` for positions, `* 4` for colors) but not self-documenting
- Buffer pool allocation hard-codes size multipliers

**Confidence: HIGH** - Fix is mechanical: define `STRIDE_POSITION = 2`, `STRIDE_COLOR = 4`, etc. and replace

### 3. Other Payload Switches (NOT in scope)
**Status**: ACKNOWLEDGED (different purpose)
**Evidence**:
- `bridges.ts`: Default value lookup by payload
- `signalExpr.ts`: Expression type handling
- `BufferPool.ts`: Buffer allocation
- Various UI components
**Issues**:
- These are NOT stride lookups - they dispatch on payload for other purposes
- `BufferPool.ts` DOES compute allocation sizes from payload, could use strideOf()

**Confidence: MEDIUM** - BufferPool.ts is borderline in scope, others clearly out of scope

### 4. ContinuityApply.ts Line 321
**Status**: CORRECTLY EXCLUDED
**Evidence**: `const stride = semantic === 'position' ? 2 : 1;`
**Issues**: None - this is semantic-based (position vs other), not payload-based
**Confidence: HIGH** - Correctly excluded from scope

## Ambiguities Found
| Area | Question | How LLM Guessed | Impact |
|------|----------|-----------------|--------|
| Shape stride | Should shape stride be 0 or 8 in slots? | IRBuilderImpl uses 0, PAYLOAD_STRIDE uses 8 | **CLARIFICATION NEEDED** - affects slot allocation |
| BufferPool.ts | Is it in scope? | Scope says "hardcoded buffer multipliers" | LOW - could include for completeness |
| Kernel files | Are projection kernels in scope? | Listed as containing `* 3` patterns | LOW - these are performance-critical loops |

## Technical Approach Assessment

### Confidence: HIGH

**Positive signals:**
1. Clear single source of truth exists (`strideOf()` and `PAYLOAD_STRIDE`)
2. 115+ successful usages of strideOf() in blocks/* demonstrate the pattern works
3. Changes are mechanical replacements, not architectural
4. All tests pass before starting
5. No runtime behavior change expected (same stride values)

**Risk factors:**
1. Shape stride discrepancy (0 vs 8) needs clarification before proceeding
2. Some rendering code may expect compile-time constants (unlikely to matter in JS)

### Scope Assessment

**Confidence: HIGH**

The scope is appropriately bounded:
- IRBuilderImpl duplicate switches: 2 clear targets
- Rendering magic numbers: ~40 instances across 3 files
- Explicit exclusions: ContinuityApply.ts:321, kernel files (implicitly)

**Estimated changes:**
- ~5 lines in IRBuilderImpl (replace 2 switch blocks with strideOf() calls)
- ~10 lines new constants (STRIDE_POSITION, STRIDE_COLOR, STRIDE_SCALE2, STRIDE_DEPTH)
- ~40 magic number replacements across rendering files

### Implementation Risks

**Confidence: HIGH - risks are LOW**

1. **Type safety**: strideOf() throws on payload variables - this is correct behavior
2. **Performance**: Zero impact - strideOf() is a simple object lookup
3. **Backwards compatibility**: None - internal refactoring only
4. **Test coverage**: Existing tests will catch regressions in actual stride values

### Testing Strategy

**Confidence: HIGH**

The existing test suite (1631 tests) provides adequate coverage:
- Compiler tests verify IR generation
- Runtime tests verify buffer operations
- Render tests verify visual output

No new tests needed for this refactoring - it's implementation detail cleanup.

## Recommendations

1. **BEFORE STARTING**: Clarify the shape stride discrepancy
   - IRBuilderImpl uses 0 ("Shape slots don't occupy f64 storage")
   - PAYLOAD_STRIDE uses 8
   - This affects `allocTypedSlot()` behavior
   - **Recommendation**: Keep shape: 0 for slot allocation (shapes are stored in objects map, not f64 array), document this exception

2. **Define rendering stride constants** in one place:
   ```typescript
   // src/render/stride-constants.ts or add to canonical-types.ts
   export const STRIDE_VEC2 = 2;   // Position, scale2
   export const STRIDE_VEC3 = 3;   // 3D position
   export const STRIDE_COLOR = 4; // RGBA
   ```

3. **Replace IRBuilderImpl switches** with strideOf() + shape special case:
   ```typescript
   const stride = type.payload === 'shape' ? 0 : strideOf(type.payload);
   ```

4. **Replace rendering magic numbers** with constants

5. **Consider BufferPool.ts** for phase 2 (uses payload switch for buffer sizing)

## Verdict
- [x] CONTINUE - Issues clear, implementer can fix

**Remaining question before implementation:**
- Shape stride: Confirm that slot allocation should use 0 for shapes (objects map) while PAYLOAD_STRIDE's 8 is for serialization/buffer sizing

This is a minor clarification that doesn't block implementation - the implementer can handle it inline with appropriate comments.

---

## Appendix: Files to Modify

### Primary (in scope)
1. `src/compiler/ir/IRBuilderImpl.ts` - Replace 2 switch blocks
2. `src/render/canvas/Canvas2DRenderer.ts` - Replace ~12 magic numbers
3. `src/render/svg/SVGRenderer.ts` - Replace ~10 magic numbers
4. `src/runtime/RenderAssembler.ts` - Replace ~20 magic numbers
5. `src/core/canonical-types.ts` OR new file - Add stride constants

### Secondary (consider for completeness)
6. `src/runtime/BufferPool.ts` - Uses payload switch for sizing

### Explicitly Excluded
- `src/runtime/ContinuityApply.ts:321` - Semantic-based, not payload-based
- `src/projection/*.ts` - Low-level kernels, performance-critical
