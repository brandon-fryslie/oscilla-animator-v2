# TYPE SYSTEM UNIFICATION EVALUATION

**Date**: 2026-01-09T08:00:00Z
**Status**: BLOCKING
**Verdict**: FULL UNIFICATION REQUIRED

---

## EXECUTIVE SUMMARY

The codebase has **TWO PARALLEL TYPE SYSTEMS WITH A NAMING COLLISION**:

1. **Legacy TypeDesc** (`src/core/types.ts`) - 138 usages across 15 files
   - Uses `world` (signal/event/field/scalar/config/special)
   - Uses `domain` (80+ string values)
   - Uses `busEligible`, `category`, `lanes`

2. **Canonical SignalType** (`src/core/canonical-types.ts`) - 177 usages across 16 files
   - Uses `PayloadType` ('float', 'int', 'vec2', 'color', 'phase', 'bool', 'unit')
   - Uses 5-axis `Extent` (cardinality, temporality, binding, perspective, branch)

3. **IR TypeDesc** (`src/compiler/ir/program.ts`) - DIFFERENT STRUCTURE
   - Uses `axes: AxesDescIR` + `shape: ShapeDescIR`
   - For IR serialization only

**CRITICAL PROBLEM**: Two unrelated interfaces both called `TypeDesc`.

---

## USAGE MATRIX

| File | TypeDesc | SignalType | Critical |
|------|----------|-----------|----------|
| `src/core/types.ts` | 30+ | 10+ | DEFINITION |
| `src/core/canonical-types.ts` | 0 | 40+ | DEFINITION |
| `src/blocks/registry.ts` | 6 | 0 | CRITICAL |
| `src/compiler/ir/program.ts` | 3 | 4 | CRITICAL |
| `src/compiler/ir/bridges.ts` | 1 | 15+ | CRITICAL |
| `src/compiler/ir/lowerTypes.ts` | 10+ | 0 | CRITICAL |
| `src/compiler/ir/IRBuilder.ts` | 0 | 10+ | CRITICAL |
| `src/compiler/passes-v2/pass2-types.ts` | 15+ | 0 | CRITICAL |
| `src/runtime/Materializer.ts` | 0 | 6 | HIGH |

---

## THE BRIDGES (Lossy Conversions!)

### Legacy ↔ Canonical Bridge (`src/core/types.ts`)

```typescript
typeDescToSignalType(td: TypeDesc): SignalType  // Legacy → Canonical
signalTypeToTypeDesc(st: SignalType): TypeDesc  // Canonical → Legacy (LOSSY!)
```

**Information Loss**:
- `'phase'` (canonical) → `'float'` (legacy) → `'float'` (canonical) - loses `phase` semantics
- `'unit'` (canonical) → `'float'` (legacy) → `'float'` (canonical) - loses `unit` semantics
- `'trigger'` (legacy) → `'bool'` (canonical) → `'boolean'` (legacy) - loses discrete semantics

### Canonical → IR Bridge (`src/compiler/ir/bridges.ts`)

```typescript
signalTypeToTypeDescIR(st: SignalType): IRTypeDesc  // Canonical → IR format
```

This one is NOT lossy because it's a projection for serialization.

---

## ARCHITECTURAL VIOLATIONS

1. **ONE SOURCE OF TRUTH**: Violated - two type systems
2. **SINGLE ENFORCER**: Partially violated - type checking split between systems
3. **NAMING COLLISION**: `TypeDesc` means two different things

---

## MIGRATION STRATEGY (Full Unification)

**User Decision**: Full unification, blocking all other work.

### Phase 1: Rename IR TypeDesc (IMMEDIATE)
- Rename `TypeDesc` in `program.ts` → `IRTypeDesc`
- Update imports in bridges.ts, bridge.ts
- **Effort**: 2-3 hours
- **Risk**: LOW

### Phase 2: Migrate Block Registry
- Rewrite `InputDef`, `OutputDef` to use `SignalType`
- Update all block definitions
- Rewrite bus eligibility checks
- **Effort**: 3-4 days
- **Risk**: MEDIUM

### Phase 3: Migrate Pass 2 Type Validation
- Update `pass2-types.ts` to validate using SignalType
- Remove legacy TypeDesc dependency
- **Effort**: 2-3 days
- **Risk**: MEDIUM

### Phase 4: Migrate Block Lowering
- Update `lowerTypes.ts` to use SignalType
- Update `LowerCtx`, `IRPortDecl`
- **Effort**: 2-3 days
- **Risk**: MEDIUM

### Phase 5: Delete Legacy TypeDesc
- Remove adapter functions
- Remove legacy type utilities
- Remove `TypeWorld`, `Domain` types
- Keep only primitives (Vec2, Point, etc.)
- **Effort**: 1-2 days
- **Risk**: LOW

---

## CRITICAL FILES TO MODIFY

### Must Change (Core):
- `src/compiler/ir/program.ts` - Rename TypeDesc → IRTypeDesc
- `src/core/types.ts` - Eventually delete TypeDesc, keep primitives
- `src/blocks/registry.ts` - Migrate to SignalType
- `src/compiler/passes-v2/pass2-types.ts` - Migrate to SignalType

### Must Change (IR):
- `src/compiler/ir/bridges.ts` - Update imports
- `src/compiler/ir/bridge.ts` - Update imports
- `src/compiler/ir/lowerTypes.ts` - Migrate to SignalType

### Must Change (Tests):
- `src/core/__tests__/type-adapter.test.ts` - Delete or rewrite
- `src/compiler/ir/__tests__/bridges.test.ts` - Update

---

## ESTIMATED EFFORT

| Phase | Hours | Days |
|-------|-------|------|
| Phase 1: Rename IR TypeDesc | 3-4 | 0.5 |
| Phase 2: Migrate Block Registry | 24-32 | 3-4 |
| Phase 3: Migrate Pass 2 | 16-24 | 2-3 |
| Phase 4: Migrate Block Lowering | 16-24 | 2-3 |
| Phase 5: Delete Legacy | 8-16 | 1-2 |
| **Total** | **67-100** | **9-14** |

---

## RISKS

1. **Block Registry Rewrite**: All block definitions touch `InputDef`/`OutputDef`
2. **Pass 2 Complexity**: Type validation logic is intricate
3. **Test Coverage**: Need comprehensive tests for each phase
4. **Regression Risk**: Changes affect entire compilation pipeline

---

## RECOMMENDED APPROACH

Given user decision of "full unification, blocking all work":

1. **Start with Phase 1** (rename IR TypeDesc) - quick win, eliminates collision
2. **Phase 2-4 in sequence** - each phase produces working system
3. **Phase 5 last** - cleanup after all migrations complete
4. **Commit after each phase** - allows rollback if needed
