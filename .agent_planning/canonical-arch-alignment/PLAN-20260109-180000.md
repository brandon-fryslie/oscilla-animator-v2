# Sprint Plan: Canonical Architecture Type System Alignment

Generated: 2026-01-09T18:00:00Z

## Sprint Goal

Implement the canonical 5-axis type system and align tests to validate the new architecture, making the codebase typecheck-clean.

## Scope

**In scope (this sprint):**
1. Implement canonical type system module (`src/core/canonical-types.ts`)
2. Write comprehensive tests for the new type system
3. Fix existing type errors to achieve clean typecheck
4. Full migration of all blocks to new type system

**Explicitly out of scope (future sprints):**
- Runtime changes
- Renderer changes
- UI/Editor changes
- Bus system migration

## Work Items

### P0: Implement Canonical Type System Module

**Description:** Create the 5-axis type system as specified in the canonical architecture document.

**Acceptance Criteria (REQUIRED):**
- [ ] `PayloadType` union type defined: `'float' | 'int' | 'vec2' | 'color' | 'phase' | 'bool' | 'unit'`
- [ ] `AxisTag<T>` discriminated union: `{ kind: 'default' } | { kind: 'instantiated'; value: T }`
- [ ] `Cardinality` type: `zero | one | many(domain)`
- [ ] `Temporality` type: `continuous | discrete`
- [ ] `Binding` type: `unbound | weak | strong | identity`
- [ ] `Extent` interface with all 5 axes
- [ ] `SignalType = { payload: PayloadType, extent: Extent }`
- [ ] `DEFAULTS_V0` constant with canonical defaults
- [ ] `DomainDecl` and `DomainRef` types
- [ ] All types use `readonly` and discriminated unions (no optional fields)

**Technical Notes:**
- Create new file `src/core/canonical-types.ts`
- Do NOT modify existing `src/core/types.ts` yet (parallel implementation)
- Follow spec naming exactly: `kind` discriminator, PascalCase types, camelCase values
- Export from `src/core/index.ts`

### P1: Write Canonical Type System Tests

**Description:** TDD - Write tests that define expected behavior BEFORE fixing code.

**Acceptance Criteria (REQUIRED):**
- [ ] Test file: `src/core/__tests__/canonical-types.test.ts`
- [ ] Tests for `AxisTag` construction and type narrowing
- [ ] Tests for axis unification rules:
  - `default + default` → `default`
  - `default + instantiated(X)` → `instantiated(X)`
  - `instantiated(X) + instantiated(X)` → `instantiated(X)`
  - `instantiated(X) + instantiated(Y)` → error
- [ ] Tests for `SignalType` construction
- [ ] Tests for World→Axes mapping (signal→one+continuous, field→many+continuous, etc.)
- [ ] Tests for `DEFAULTS_V0` values
- [ ] All tests pass

**Technical Notes:**
- Use vitest
- Tests should match canonical architecture doc Section 3.1
- Include negative tests (invalid combinations should error)

### P2: Fix Type Errors - Achieve Clean Typecheck

**Description:** Fix existing type errors so `npm run typecheck` passes.

**Acceptance Criteria (REQUIRED):**
- [ ] `npm run typecheck` exits with code 0 (no errors)
- [ ] No `any` type assertions added to suppress errors
- [ ] All existing tests still pass (`npm run test`)
- [ ] TypeDesc construction uses helper functions (not raw objects)

**Technical Notes:**
- Most errors are missing `category`/`busEligible` in TypeDesc objects
- Use `createTypeDesc()` helper consistently
- IRBuilder methods may need stubs/implementations
- May need to add missing branded ID constructors

## Dependencies

- Canonical architecture doc is source of truth
- Must not break existing tests
- Order: P0 → P1 → P2 (type system first, tests second, fixes third)

## Risks

1. **Type errors may expose deeper architectural issues** - If fixes reveal inconsistencies with spec, document and defer
2. **Test failures may indicate spec violations** - Update tests to match spec, not vice versa
