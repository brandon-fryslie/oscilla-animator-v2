# Sprint: Renderer Local-Space Migration

**Generated**: 2026-01-22
**Bead ID**: oscilla-animator-v2-46m
**Status**: BLOCKED (Waiting on oscilla-animator-v2-583)

## Sprint Goal

Refactor Canvas2DRenderer.renderPathAtParticle to use local-space control points with instance transforms, removing viewport dimension scaling and enabling geometry reuse patterns.

## Task Breakdown

### Task 1: Update renderPathAtParticle Signature
**Estimated Time**: 5 minutes
**Dependencies**: None
**Risk**: Low

**Actions**:
1. Open `src/render/Canvas2DRenderer.ts`
2. Find `renderPathAtParticle` function (line 180)
3. Remove parameters:
   - `width: number`
   - `height: number`
4. Rename parameter: `_size` → `size` (remove underscore)
5. Add parameters:
   - `rotation: number`
   - `scale2?: [number, number]`

**Expected Result**:
```typescript
function renderPathAtParticle(
  ctx: CanvasRenderingContext2D,
  topology: PathTopologyDef,
  controlPoints: Float32Array,
  size: number,
  rotation: number,
  scale2?: [number, number]
): void
```

**Verification**: TypeScript compiler will show errors at call site (expected, will fix in Task 4)

---

### Task 2: Apply Instance Transforms
**Estimated Time**: 10 minutes
**Dependencies**: Task 1
**Risk**: Low

**Actions**:
1. In `renderPathAtParticle`, find `ctx.beginPath()` line (currently line 188)
2. Insert BEFORE `ctx.beginPath()`:
   ```typescript
   // Apply rotation (if non-zero)
   if (rotation !== 0) {
     ctx.rotate(rotation);
   }

   // Apply scale (anisotropic if scale2 present, otherwise isotropic)
   if (scale2) {
     ctx.scale(scale2[0], scale2[1]);
   } else {
     ctx.scale(size, size);
   }
   ```

**Expected Result**:
- Rotation applied conditionally
- Scale applied (anisotropic or isotropic)
- Transform ordering: rotate → scale (per spec)

**Verification**: Visual - code reads cleanly, transform order correct

---

### Task 3: Remove Viewport Scaling from Path Verbs
**Estimated Time**: 15 minutes
**Dependencies**: None (can be done in parallel with Task 1-2)
**Risk**: Low

**Actions**:
1. Find MOVE verb case (line 196)
   - Change: `const px = controlPoints[pointIndex * 2] * width;`
   - To: `const x = controlPoints[pointIndex * 2];`
   - Change: `const py = controlPoints[pointIndex * 2 + 1] * height;`
   - To: `const y = controlPoints[pointIndex * 2 + 1];`
   - Update: `ctx.moveTo(x, y);`

2. Find LINE verb case (line 205)
   - Same pattern as MOVE

3. Find CUBIC verb case (line 213)
   - Remove `* width` and `* height` from:
     - cp1x, cp1y (control point 1)
     - cp2x, cp2y (control point 2)
     - endx, endy (end point)

4. Find QUAD verb case (line 231)
   - Remove `* width` and `* height` from:
     - cpx, cpy (control point)
     - endx, endy (end point)

5. CLOSE verb (line 246)
   - No changes needed (no control points)

**Expected Result**: All control point reads are direct array access, no multiplication

**Verification**: Search for `* width` and `* height` in renderPathAtParticle - should find ZERO occurrences

---

### Task 4: Update Call Site in renderInstances2D
**Estimated Time**: 10 minutes
**Dependencies**: Task 1 (signature change)
**Risk**: Low

**Actions**:
1. Find renderInstances2D function (line 96)
2. Add after line 105 (after `const scale = pass.scale;`):
   ```typescript
   // Reference dimension for isotropic scaling (preserves circles in non-square viewports)
   const D = Math.min(width, height);
   ```

3. Find call to renderPathAtParticle (line 135)
4. Replace:
   ```typescript
   renderPathAtParticle(ctx, topology, controlPoints, scale, width, height);
   ```
   With:
   ```typescript
   // Compute reference dimension for isotropic scaling
   const sizePx = scale * D;

   // For now, rotation is always 0 (future: get from instance data)
   const rotation = 0;

   renderPathAtParticle(ctx, topology, controlPoints, sizePx, rotation);
   ```

**Expected Result**:
- D computed once at top of function
- sizePx = scale * D per spec
- rotation = 0 as placeholder
- Call site matches new signature

**Verification**: TypeScript errors should disappear

---

### Task 5: Update Documentation
**Estimated Time**: 15 minutes
**Dependencies**: Tasks 1-4 complete
**Risk**: Low

**Actions**:
1. Delete obsolete comment block (lines 154-178)
   - Starts with "ROADMAP PHASE 6 - COORDINATE SPACE ISSUE:"
   - Ends with "to output local-space coordinates instead of normalized world-space."

2. Delete obsolete parameter comment (line 184)
   - "_size: number, // Currently unused - control points already include radius"

3. Add new JSDoc before renderPathAtParticle (replace lines 180-179):
   ```typescript
   /**
    * Render a path shape at a particle position using local-space geometry.
    *
    * Assumes ctx.translate(xPx, yPx) has been applied by caller to position
    * the shape at the instance location.
    *
    * Transform sequence (canonical per spec):
    * 1. Translate to instance position (done by caller)
    * 2. Rotate by instance rotation (applied here if non-zero)
    * 3. Scale by instance size or scale2 (applied here)
    * 4. Draw path with local-space control points
    *
    * Control points are in local space:
    * - Centered at origin (0, 0)
    * - Typical magnitude |p| ≈ O(1) (e.g., unit circle has radius 1)
    * - NOT scaled by viewport dimensions
    * - NOT in normalized world [0,1] coordinates
    *
    * @param ctx - Canvas rendering context (already translated to instance position)
    * @param topology - Path topology definition with verb sequence
    * @param controlPoints - Local-space control point buffer (interleaved x,y pairs)
    * @param size - Isotropic scale factor in viewport pixels (sizePx = sizeW * D)
    * @param rotation - Instance rotation in radians (clockwise positive, Canvas2D convention)
    * @param scale2 - Optional anisotropic scale [sx, sy] in viewport pixels (overrides isotropic size)
    *
    * @see .agent_planning/_future/3-local-space-spec-deeper.md section 7 (Canvas2D backend)
    */
   ```

4. Add comment above D computation in renderInstances2D:
   ```typescript
   // Reference dimension for isotropic scaling (preserves circles in non-square viewports)
   const D = Math.min(width, height);
   ```

**Expected Result**:
- Old comments removed
- New JSDoc explains local-space semantics
- Transform sequence documented
- Spec reference included

**Verification**: Read documentation - should clearly explain local-space approach

---

### Task 6: Type Check and Compile
**Estimated Time**: 2 minutes
**Dependencies**: All previous tasks
**Risk**: Low

**Actions**:
```bash
npm run typecheck
```

**Expected Result**: Zero TypeScript errors

**If Errors**:
- Check signature matches call site
- Check optional parameter syntax (scale2?)
- Check imported types (PathTopologyDef, etc.)

---

### Task 7: Visual Test on Dev Server
**Estimated Time**: 10 minutes
**Dependencies**: Task 6 (compiles successfully)
**Risk**: Medium (might show incorrect rendering if RenderAssembler not ready)

**Actions**:
```bash
npm run dev
```

**Test Cases**:
1. Open browser to localhost (check terminal for port)
2. Open DevTools console
3. Verify no console errors
4. Check existing demos:
   - Shapes appear at positions (may be wrong position, that's OK)
   - Shapes have some size (may be wrong size, that's OK)
   - No visual artifacts (broken paths, NaN errors)
5. Resize viewport to non-square (e.g., narrow window)
   - If circles exist, verify they stay circular (not elliptical)
   - This tests D = min(width, height)

**Expected Results**:
- ✅ No console errors
- ✅ No TypeScript compilation errors in dev server
- ⚠️ Rendering may be incorrect (OK - waiting on RenderAssembler v2)
- ✅ Circles should stay circular on resize

**Document Results**:
Note any issues in bead comments or planning docs.

---

### Task 8: Code Review Self-Check
**Estimated Time**: 5 minutes
**Dependencies**: All previous tasks
**Risk**: Low

**Checklist**:
- [ ] Signature updated (no width/height, has rotation/scale2)
- [ ] All `* width` and `* height` removed from verb cases (5 verbs checked)
- [ ] Transform applied: rotation → scale
- [ ] D = Math.min(width, height) computed
- [ ] sizePx = scale * D computed
- [ ] Call site updated
- [ ] Documentation updated (old removed, new added)
- [ ] No TypeScript errors
- [ ] No console errors in dev server
- [ ] Transform ordering matches spec

**Actions**: Review code changes line by line against CONTEXT-20260122.md

---

## Timeline

**Total Estimated Time**: ~1 hour

**Parallel Work**:
- Tasks 1-2 can be done together (same function)
- Task 3 can be done in parallel with Tasks 1-2 (independent changes)
- Task 4 must wait for Task 1 (signature change)
- Task 5 can be done anytime, but clearer after Tasks 1-4
- Tasks 6-8 must be sequential (compile → test → review)

**Critical Path**: Task 1 → Task 4 → Task 6 → Task 7

---

## Risk Mitigation

### Risk: RenderAssembler v2 Not Ready
**Probability**: High (dependency is IN_PROGRESS)
**Impact**: Cannot fully test changes
**Mitigation**:
- Implement code changes anyway (enables progress)
- Accept that visual testing may fail (expected)
- Mark bead as BLOCKED until dependency complete
- Document expected vs actual rendering in notes

### Risk: Breaking Existing Rendering
**Probability**: Medium (significant coordinate space change)
**Impact**: No visible shapes, console errors
**Mitigation**:
- Keep transforms in correct order per spec
- Verify D computation is correct
- Add back viewport scaling as temporary shim if needed (rollback plan)

### Risk: Missing Rotation Data
**Probability**: High (rotation not in RenderPassIR yet)
**Impact**: Cannot test rotation transform
**Mitigation**:
- Use rotation = 0 as placeholder
- Add rotation transform code anyway (prepares for future)
- Document as "TODO: Get from instance data"

---

## Verification Checklist

Before marking bead as COMPLETE:
- [ ] All 8 tasks completed
- [ ] No TypeScript errors
- [ ] No console errors on dev server
- [ ] All `* width` and `* height` removed
- [ ] Transform order: rotate → scale
- [ ] D = min(width, height) used
- [ ] Documentation updated
- [ ] Self-review completed
- [ ] Changes committed (if requested)

---

## Notes

- This bead is **BLOCKED** until oscilla-animator-v2-583 completes
- Code can be implemented but visual testing may be unreliable
- Focus on correctness per spec, not visual output yet
- Downstream beads (4lm, qch, 0uk, ry2) are blocked by this work
