# Definition of Done: Renderer Local-Space Migration

**Generated**: 2026-01-22
**Bead ID**: oscilla-animator-v2-46m
**Plan**: PLAN-20260122.md

## Acceptance Criteria

### Code Changes

#### 1. renderPathAtParticle Signature Updated
- [ ] Removed `width: number` parameter
- [ ] Removed `height: number` parameter
- [ ] Renamed `_size` to `size` (no underscore)
- [ ] Added `rotation: number` parameter
- [ ] Added `scale2?: [number, number]` optional parameter
- [ ] Updated function JSDoc with new parameter descriptions

#### 2. Viewport Scaling Removed from Path Drawing
- [ ] MOVE verb (case 0): Removed `* width` and `* height` multiplication
- [ ] LINE verb (case 1): Removed `* width` and `* height` multiplication
- [ ] CUBIC verb (case 2): Removed `* width` and `* height` from all 3 point pairs
- [ ] QUAD verb (case 2): Removed `* width` and `* height` from both point pairs
- [ ] CLOSE verb (case 4): No changes needed (verified)
- [ ] All control point reads use direct array access without scaling

#### 3. Instance Transforms Applied
- [ ] Rotation applied via `ctx.rotate(rotation)` before path drawing
- [ ] Rotation only applied if `rotation !== 0` (optimization)
- [ ] Isotropic scale applied via `ctx.scale(size, size)` when no scale2
- [ ] Anisotropic scale applied via `ctx.scale(scale2[0], scale2[1])` when scale2 present
- [ ] Transforms applied AFTER translate, BEFORE beginPath()
- [ ] Transform ordering follows spec: rotate → scale → draw

#### 4. Call Site Updated in renderInstances2D
- [ ] Reference dimension computed: `const D = Math.min(width, height);`
- [ ] Size in pixels computed: `const sizePx = scale * D;`
- [ ] Rotation parameter passed (default 0 for now)
- [ ] Call updated: `renderPathAtParticle(ctx, topology, controlPoints, sizePx, rotation)`
- [ ] No longer passing width/height to renderPathAtParticle

#### 5. Documentation Updated
- [ ] Removed obsolete comment block (lines 154-178) about "ROADMAP PHASE 6"
- [ ] Removed comment "_size: number, // Currently unused..."
- [ ] Added JSDoc describing local-space semantics
- [ ] Added JSDoc describing transform sequence
- [ ] Added JSDoc parameter descriptions for size, rotation, scale2
- [ ] Added note about ctx.translate being done by caller
- [ ] Added note about control points being centered at origin

### Visual Verification

#### 6. Existing Rendering Still Works
- [ ] Started dev server with `npm run dev`
- [ ] Verified existing polygon demos render at correct positions
- [ ] Verified shapes render at approximately correct sizes
- [ ] No visual artifacts or distortions observed
- [ ] No console errors related to rendering

#### 7. Isotropic Scaling Preserved
- [ ] Resized viewport to non-square (e.g., 800x400)
- [ ] Verified circular shapes remain circular (not elliptical)
- [ ] Verified D = min(width, height) maintains aspect ratio
- [ ] Verified shapes scale consistently in both dimensions

### Code Quality

#### 8. Type Safety Maintained
- [ ] No new TypeScript errors introduced
- [ ] PathVerb type usage correct (number literals or enum)
- [ ] Function signature matches call site
- [ ] Optional parameters handled correctly (scale2)

#### 9. No Regressions
- [ ] Existing tests pass (if any)
- [ ] No console warnings or errors
- [ ] No broken imports or undefined references
- [ ] Code compiles successfully: `npm run typecheck`

## Exit Criteria

### For READY Status
This work is READY when:
- [ ] All 27 acceptance criteria above are verified
- [ ] Code compiles without errors
- [ ] Dev server runs without console errors
- [ ] Visual testing shows correct rendering

### For BLOCKED Status
This work remains BLOCKED until:
- [ ] oscilla-animator-v2-583 (RenderAssembler v2) is marked complete
- [ ] DrawPathInstancesOp is available in codebase
- [ ] Local-space control points are materialized by RenderAssembler

### For INTEGRATION Status
This work enables integration when:
- [ ] All acceptance criteria above are verified
- [ ] Downstream beads can begin (4lm, qch, 0uk)
- [ ] No known issues or visual regressions

## Verification Process

### Step 1: Code Review
1. Read through all changed lines in Canvas2DRenderer.ts
2. Verify width/height multiplication is completely removed
3. Verify transform sequence matches spec exactly
4. Verify documentation is accurate and complete

### Step 2: Type Checking
```bash
npm run typecheck
```
Expected: No errors

### Step 3: Dev Server Visual Test
```bash
npm run dev
```
1. Open browser to localhost (note port from terminal)
2. Check existing demos render correctly
3. Open browser DevTools console
4. Verify no errors or warnings
5. Resize viewport to non-square aspect ratio
6. Verify shapes remain proportional

### Step 4: Dependency Check
```bash
bd show oscilla-animator-v2-583 --json | jq '.status'
```
Expected: "completed" or "in_progress" (if still in progress, this bead remains blocked)

## Deferred Work

The following items are explicitly OUT OF SCOPE for this bead:

### Deferred: Full Rotation Support
**Why**: Requires RenderPassIR to include rotation field and RenderAssembler to materialize it
**Tracked in**: Future bead (not yet created)
**Impact**: rotation parameter added but always 0 for now

### Deferred: scale2 Anisotropic Scaling
**Why**: Requires design decision on how scale2 interacts with size
**Tracked in**: Future bead (not yet created)
**Impact**: scale2 parameter added but never provided yet

### Deferred: Size Parameter Activation
**Why**: Requires RenderAssembler to materialize size correctly from instance data
**Tracked in**: oscilla-animator-v2-4lm
**Impact**: size parameter active but may not show correct modulation yet

### Deferred: Polygon Radius Defaults
**Why**: Requires coordinated change to path-blocks.ts
**Tracked in**: oscilla-animator-v2-qch
**Impact**: Polygon defaults remain 0.1 for now (should be 1.0 in local-space)

### Deferred: SVG Renderer
**Why**: Requires local-space migration to be complete first
**Tracked in**: oscilla-animator-v2-0uk
**Impact**: No SVG output yet, Canvas2D only

### Deferred: Remove v1 Code Path
**Why**: v1 RenderPassIR still needed until all renderers migrate
**Tracked in**: oscilla-animator-v2-ry2
**Impact**: Both code paths coexist temporarily

## Blockers and Questions

### Blocker 1: RenderAssembler v2 Status
**Status**: oscilla-animator-v2-583 is IN_PROGRESS
**Question**: What parts of RenderAssembler v2 are ready?
**Impact**: Cannot fully test local-space rendering until DrawPathInstancesOp is available

**Resolution Path**:
1. Check RenderAssembler v2 completion status
2. If ready: Proceed with implementation
3. If not ready: Prepare code but defer testing

### Question 1: Rotation Sign Convention
**Question**: Is rotation clockwise or counter-clockwise positive?
**Spec Reference**: Section 2.1 says "radians, clockwise positive; choose and document once"
**Impact**: Need to document chosen convention

**Proposed Resolution**: Use Canvas2D convention (clockwise positive, matches ctx.rotate)

### Question 2: scale2 Combination Rule
**Question**: When both size and scale2 present, what's the combination rule?
**Spec Reference**: Section 2.3 says "size * scale2 componentwise"
**Impact**: Affects how scale2 is applied

**Proposed Resolution**: Follow spec exactly:
```typescript
if (scale2) {
  ctx.scale(size * scale2[0], size * scale2[1]);
} else {
  ctx.scale(size, size);
}
```

## Success Metrics

### Quantitative
- [ ] 0 compilation errors
- [ ] 0 runtime errors in console during visual test
- [ ] 0 visual regressions in existing demos
- [ ] 100% of path verbs updated (5/5: MOVE, LINE, CUBIC, QUAD, CLOSE)

### Qualitative
- [ ] Code is easier to understand (local-space is clearer than normalized world)
- [ ] Transform sequence matches spec exactly (traceability)
- [ ] Future SVG renderer unblocked (geometry reuse patterns enabled)
- [ ] Documentation clearly explains local-space semantics

## Rollback Plan

If this change causes visual regressions:

1. **Immediate**: Keep new signature, add back viewport scaling as temporary shim:
   ```typescript
   const xScaled = x * width;
   const yScaled = y * height;
   ctx.moveTo(xScaled, yScaled);
   ```

2. **Investigate**: Why are control points not in local space?
   - Check Materializer output
   - Check RenderAssembler transform

3. **Fix Root Cause**: Adjust upstream to produce local-space points

4. **Remove Shim**: Once upstream fixed, remove viewport scaling again

**Note**: Rollback to old signature is NOT an option - that would break RenderAssembler v2 integration.
