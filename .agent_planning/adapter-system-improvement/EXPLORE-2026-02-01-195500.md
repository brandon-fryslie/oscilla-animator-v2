# Explore: Domain Transformation System (Adapters/Lenses)
Timestamp: 2026-02-01-195500

## Raw Findings

### Test Status
- All tests pass: 136 passed, 6 skipped, 2055 tests total
- 1 unhandled error (Worker exit - unrelated to adapter system, appears to be a tinypool worker crash)
- Adapter-specific tests: `adapter-spec.test.ts` (22 tests), `PatchStore-lens.test.ts` (21 tests), `pass2-adapters.test.ts` (9 tests) - ALL PASS

### File Inventory

**Core adapter/lens files:**
- `/src/blocks/adapter-spec.ts` - AdapterSpec types + findAdapter() + pattern matching (327 lines)
- `/src/compiler/frontend/normalize-adapters.ts` - Pass 2 with Phase 1 (lenses) + Phase 2 (auto-adapters) (531 lines)
- `/src/graph/Patch.ts` - LensAttachment type, InputPort.lenses, OutputPort.lenses (future)
- `/src/types/canonical-address.ts` - LensAddress type
- `/src/ui/reactFlowEditor/typeValidation.ts` - validateConnection() uses findAdapter()
- `/src/ui/reactFlowEditor/lensUtils.ts` - getAvailableLensTypes(), findCompatibleLenses()
- `/src/ui/reactFlowEditor/menus/PortContextMenu.tsx` - Add/Remove Lens menu items
- `/src/stores/PatchStore.ts` - addLens(), removeLens(), getLensesForPort(), updateLensParams()
- `/src/graph/passes/index.ts` - Re-exports from compiler/frontend/normalize-adapters.ts
- `/src/blocks/adapter/*.ts` - 11 adapter block definitions with adapterSpec on BlockDef

**Old files removed:**
- `src/graph/adapters.ts` - GONE (confirmed)

**Adapter block registrations with adapterSpec:**
- phase-to-scalar, scalar-to-phase, scalar-to-deg, radians-to-phase, degrees-to-radians, radians-to-degrees, norm01-to-scalar, seconds-to-ms, ms-to-seconds, phase-to-radians, scalar-to-norm01-clamp, field/broadcast

### Architecture

**LensAttachment** (Patch.ts:78-120):
- id, lensType, sourceAddress, params?, sortKey
- Stored on InputPort.lenses (optional readonly array)
- OutputPort.lenses exists but marked "FUTURE - not yet implemented"

**normalize-adapters.ts** has two phases:
- Phase 1: expandExplicitLenses() - expands InputPort.lenses into blocks
- Phase 2: autoInsertAdapters() - auto-inserts adapters for type mismatches

**Doc comment contradiction**: File header (lines 1-40) says Phase 2 is "Type Validation" with "no auto-fix, no insertion" but actual Phase 2 (line 345-505) is `autoInsertAdapters()` which does auto-insert.

**adapter-spec.ts**:
- AdapterBlockSpec lives on BlockDef.adapterSpec
- findAdapter() builds rules lazily from registry, cached in module-level `cachedRules`
- No cache invalidation mechanism (if blocks register after first findAdapter() call, cache is stale)
- extentMatches() uses JSON.stringify for comparison (line 139)
- patternsAreCompatible() uses JSON.stringify for extent comparison (line 191)

**typeValidation.ts**:
- validateConnection() checks direct compatibility then falls back to findAdapter()
- canTransformDomain() is a stub that always returns false (line 251-255)
- Has TODO comment about domain transformation system

**lensUtils.ts**:
- Contains debug console.log statements (lines 111, 119, 128)
- typesMatch() only checks payload.kind and unit.kind - no extent comparison

**PatchStore lens CRUD**: addLens, removeLens, getLensesForPort, updateLensParams all implemented and tested

**PortContextMenu**: Has Add Lens and Remove Lens sections, uses findCompatibleLenses()

**diagnostics/actionExecutor.ts:229**: TODO for rewiring edges through adapter - action creates adapter block but doesn't wire it

### Sprint 3 STATUS.md says PLANNED - READY but Sprint 3 work appears largely done:
- PatchStore methods: IMPLEMENTED
- lensUtils.ts: IMPLEMENTED
- PortContextMenu lens items: IMPLEMENTED
- PatchStore-lens.test.ts: IMPLEMENTED
- Visual indicator (AdapterIndicator component): NOT FOUND
- PortInfoPopover lens extension: NOT CHECKED
- EdgeContextMenu lens items: NOT CHECKED
