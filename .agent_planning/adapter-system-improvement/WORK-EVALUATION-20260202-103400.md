# Work Evaluation - 2026-02-02-103400
Scope: adapter-system-improvement/sprint4-ui-viz
Confidence: FRESH

## Goals Under Evaluation
From SPRINT-20260202-sprint4-ui-viz-DOD.md:
1. V1: Edge data population (lenses from target InputPort)
2. V2: Custom edge component (OscillaEdge renders for all edges)
3. V3: Visual design (amber indicator, no interaction blocking)
4. V4: Multiple lenses (design documented, no collisions)
5. Regression: all tests pass, TypeScript clean, no layout regressions

## Previous Evaluation Reference
No previous evaluation for this sprint.

## Persistent Check Results
| Check | Status | Output Summary |
|-------|--------|----------------|
| `npx vitest run` | PASS | 141 files, 2114 tests passed (worker crash is infra, not code) |
| `npx tsc --noEmit` | PASS | 0 errors |
| New edge data tests | PASS | 5/5 |
| New lensUtils tests | PASS | 14/14 |

## Critical Finding: OscillaEdge Component Is Dead Code

The OscillaEdge component is registered in `GraphEditorCore.tsx:173-175` but **never renders** because the actual edge creation path produces edges with `type: 'default'`, not `type: 'oscilla'`.

### The Two Code Paths

**Path A (ACTIVE - used by the main editor):**
```
ReactFlowEditor.tsx
  -> GraphEditorCore.tsx (registers edgeTypes: { oscilla: OscillaEdge })
    -> reconcileNodesFromAdapter() from nodeDataTransform.ts
      -> createEdgeFromEdgeLike() 
        -> type: 'default'  // <-- WRONG: should be 'oscilla'
```

**Path B (UNUSED - sync.ts is exported but never imported by any component):**
```
sync.ts
  -> reconcileNodes()
    -> createEdgeFromPatchEdge() from nodes.ts
      -> type: 'oscilla'  // <-- This is correct but unreachable
```

**Evidence:**
- `grep -r "setupStructureReaction\|reconcileNodes\b" src/` shows `reconcileNodes` is only defined and called within `sync.ts` itself - no external consumer.
- `grep -r "reconcileNodesFromAdapter" src/` confirms `GraphEditorCore.tsx` (the active editor) uses the adapter path exclusively.
- `src/ui/graphEditor/nodeDataTransform.ts:225`: `createEdgeFromEdgeLike` returns `{ type: 'default' }`.

### Impact

**All V2 criteria are NOT MET in production:**
- OscillaEdge component never renders for any edge
- Lensed edges do NOT show amber indicator
- Plain edges use default ReactFlow edge component (which happens to look the same, masking the problem)
- Hover tooltips for lenses never appear

The implementation was done against `sync.ts`/`nodes.ts` (Path B) but the app uses `nodeDataTransform.ts` (Path A).

## Additional Issues

### Issue 2: MobX Reaction Does Not Track Lens Changes

`GraphEditorCore.tsx:465-487` tracks:
```typescript
() => ({
  blockCount: adapter.blocks.size,
  edgeCount: adapter.edges.length,
  blockIds: Array.from(adapter.blocks.keys()).join(','),
  edgeIds: adapter.edges.map((e) => e.id).join(','),
})
```

Adding/removing a lens changes `block.inputPorts.lenses` but does NOT change block count, edge count, block IDs, or edge IDs. The reaction would never fire for lens-only changes.

**DOD V1 criterion "Adding/removing lens causes edge to re-render with updated data" is NOT MET.**

### Issue 3: nodeDataTransform PortData Lacks Lens Fields

`src/ui/graphEditor/nodeDataTransform.ts:32-42` defines `PortData` WITHOUT `lensCount` or `lenses` fields (compare with `src/ui/reactFlowEditor/nodes.ts:36-55` which has them). Even if the reaction worked, lens data would not propagate through the adapter path.

### Issue 4: sync.ts createConnectHandler Uses type: 'default'

`src/ui/reactFlowEditor/sync.ts:421`: When a new edge is created via drag-connect, the inline edge creation uses `type: 'default'` (not `type: 'oscilla'`). This is a minor issue since sync.ts is unused, but it shows inconsistency within the implementation itself.

## Data Flow Verification
| Step | Expected | Actual | Status |
|------|----------|--------|--------|
| Lens on InputPort | Exists in Patch model | Exists | PASS |
| createEdgeFromPatchEdge reads lenses | Populates edge.data.lenses | Populates correctly | PASS (but unused path) |
| createEdgeFromEdgeLike reads lenses | Should populate | Does NOT populate | FAIL |
| Edge type = 'oscilla' (active path) | All edges use custom component | type = 'default' | FAIL |
| MobX reaction tracks lens changes | Lens add triggers re-render | Not tracked | FAIL |
| OscillaEdge renders | Shows amber indicator | Never instantiated | FAIL |

## Break-It Testing
| Attack | Expected | Actual | Severity |
|--------|----------|--------|----------|
| Add lens to port | Edge shows amber badge | No visual change | HIGH |
| Remove lens from port | Edge badge disappears | No visual change (never appeared) | HIGH |
| Multiple lenses | Count badge shows | Never renders | HIGH |

## Test Analysis

### nodes-edge-data.test.ts (5 tests)
These tests call `createEdgeFromPatchEdge` directly from `nodes.ts`. They test Path B (the unused path). They all pass because the function itself works correctly.

**Verdict: WRONG LAYER.** Tests exercise `createEdgeFromPatchEdge` (unused code path) instead of `createEdgeFromEdgeLike` (the active code path in `nodeDataTransform.ts`). A broken implementation ships while tests pass.

### lensUtils.test.ts (14 tests)
These test utility functions (`getAvailableLensTypes`, `getLensLabel`, `canApplyLens`, `findCompatibleLenses`). These are valid unit tests of helper functions. They are correctly scoped and test real behavior.

**Verdict: PASS (but they test utilities, not the UI integration).**

## Assessment

### PASS (Correct)
- `OscillaEdge.tsx` component code: The component itself is well-written with correct use of `BaseEdge`, `getBezierPath`, and `EdgeLabelRenderer`
- `OscillaEdgeData` interface: Clean, correct data shape
- `createEdgeFromPatchEdge` in `nodes.ts`: Correctly populates lens data from target port
- `lensUtils.ts`: Well-tested utility functions
- Design doc (`LENS-VISUALIZATION-DESIGN.md`): Thorough, well-reasoned
- Amber color #f59e0b used consistently
- `pointerEvents: 'all'` on indicator allows interaction without blocking handles
- TypeScript builds clean
- All existing tests pass

### FAIL (Not Working)
- **V1**: "Adding/removing lens causes edge to re-render" -- NOT MET. MobX reaction in `GraphEditorCore.tsx` does not track lens changes.
- **V2**: "OscillaEdge component renders for all edges" -- NOT MET. Active code path creates edges with `type: 'default'`, not `type: 'oscilla'`.
- **V2**: "Lensed edges show amber indicator near target port" -- NOT MET. OscillaEdge never instantiates.
- **V2**: "Indicator shows lens type on hover" -- NOT MET. Same root cause.

### Working (Incidentally)
- **V2**: "Plain edges render identically to default ReactFlow edges" -- TRUE, but vacuously: plain edges ARE default ReactFlow edges because OscillaEdge never renders.
- **V3**: All visual design criteria are untestable because the component never renders.
- **V4**: Design doc is well-written and correct.
- **Regression**: No regressions because the new code is effectively dead code in the active path.

## Ambiguities Found
| Decision | What Was Assumed | Should Have Asked | Impact |
|----------|------------------|-------------------|--------|
| Which sync path is active | `sync.ts`/`nodes.ts` is the edge creation path | Which code path do edges actually flow through? | Implementation targets dead code |
| Edge type propagation | Setting type in `createEdgeFromPatchEdge` is sufficient | Is `createEdgeFromEdgeLike` in `nodeDataTransform.ts` the actual producer? | OscillaEdge never renders |

## Missing Checks (implementer should create)

1. **Integration test: edge type in active path** -- `src/ui/graphEditor/__tests__/nodeDataTransform-edge-type.test.ts`: Assert that `createEdgeFromEdgeLike` returns `type: 'oscilla'` and includes lens data.
2. **Integration test: MobX reaction tracks lens changes** -- Test that modifying `block.inputPorts.lenses` triggers the reaction in `GraphEditorCore`.
3. **Test that exercises the full path** -- From `PatchStoreAdapter` through `reconcileNodesFromAdapter` to edge creation, verifying lens data arrives in the ReactFlow edge.

## Verdict: INCOMPLETE

## What Needs to Change

1. **`src/ui/graphEditor/nodeDataTransform.ts:218-228`** -- `createEdgeFromEdgeLike` must set `type: 'oscilla'` and populate `OscillaEdgeData` (lenses, hasAdapter, isNonContributing) from the adapter's block/edge data. Currently returns `type: 'default'` with no custom data.

2. **`src/ui/graphEditor/nodeDataTransform.ts:238-286`** -- `reconcileNodesFromAdapter` must pass block information to `createEdgeFromEdgeLike` so it can read lenses from target ports. Currently it only passes the `EdgeLike` which has no lens info.

3. **`src/ui/graphEditor/GraphEditorCore.tsx:465-487`** -- MobX reaction must track lens changes. Add lens-related observables to the reaction's data function (e.g., serialize `block.inputPorts.lenses.length` for each block).

4. **`src/ui/graphEditor/nodeDataTransform.ts:32-42`** -- `PortData` interface should include `lensCount` and `lenses` fields to match the `PortData` in `nodes.ts`.

5. **`src/ui/reactFlowEditor/__tests__/nodes-edge-data.test.ts`** -- These tests pass but test the wrong code path. Add equivalent tests that exercise `createEdgeFromEdgeLike` / `reconcileNodesFromAdapter` to verify the active path.

6. **Consider** whether `sync.ts` and its functions (`reconcileNodes`, `createEdgeFromPatchEdge`, etc.) should be deleted if they are truly dead code, to avoid future confusion.
