# Evaluation: Domain Transformation System (Adapters/Lenses)
Timestamp: 2026-02-01-195800
Git Commit: a8bce63

## Executive Summary
Overall: ~85% complete | Critical issues: 2 | Tests reliable: PARTIAL

Sprint 1 (Data Model) and Sprint 2 (Normalization) are genuinely complete and working. Sprint 3 (Editor Integration) is substantially implemented despite STATUS.md saying "PLANNED - READY". The STATUS.md is stale -- most Sprint 3 deliverables exist in the codebase. Sprint 4 (UI Visualization / AdapterIndicator on edges) is NOT STARTED.

## Runtime Check Results
| Check | Status | Output |
|-------|--------|--------|
| Full test suite | PASS | 136 files, 2055 tests pass, 1 unrelated worker crash error |
| adapter-spec.test.ts | PASS | 22 tests |
| PatchStore-lens.test.ts | PASS | 21 tests |
| pass2-adapters.test.ts | PASS | 9 tests |
| Type check | NOT RUN | (not executed in this evaluation) |

## Missing Checks
1. **Phase 1 (expandExplicitLenses) has ZERO dedicated tests.** The pass2-adapters.test.ts tests only cover Phase 2 (auto-adapter insertion). No test creates a Patch with InputPort.lenses and verifies they expand to blocks.
2. **No integration test for the full lens flow**: PatchStore.addLens() -> normalization -> lens block creation -> compilation.
3. **No test for lensUtils.ts** -- findCompatibleLenses() and canApplyLens() are untested.
4. **No test for Edge/Port context menu lens items** (UI component tests).

## Findings

### AdapterSpec on BlockDef (from closed bead oscilla-animator-v2-vqkj)
**Status**: COMPLETE
**Evidence**:
- `src/blocks/adapter-spec.ts` exists with AdapterBlockSpec and findAdapter() (327 lines)
- `src/blocks/registry.ts:377` has `adapterSpec?: AdapterBlockSpec` on BlockDef
- 12 adapter blocks have `adapterSpec:` declarations (11 in `src/blocks/adapter/` + Broadcast in `src/blocks/field/broadcast.ts`)
- Old `src/graph/adapters.ts` is gone (confirmed via glob)
- 22 tests pass in adapter-spec.test.ts
**Issues**: None.

### Sprint 1: Data Model & Addressing
**Status**: COMPLETE
**Evidence**:
- `LensAttachment` interface at `src/graph/Patch.ts:78-120` with id, lensType, sourceAddress, params, sortKey
- `InputPort.lenses` at `src/graph/Patch.ts:209` (optional readonly LensAttachment[])
- `OutputPort.lenses` at `src/graph/Patch.ts:234` (future-proofed, unused)
- `LensAddress` at `src/types/canonical-address.ts:85` with type guard `isLensAddress`
- Tests in `src/types/__tests__/canonical-address.test.ts` cover LensAddress serialization/parsing
**Issues**: None.

### Sprint 2: Normalization Pass Updates
**Status**: COMPLETE (with documentation inconsistency)
**Evidence**:
- `src/compiler/frontend/normalize-adapters.ts` has both phases:
  - Phase 1: `expandExplicitLenses()` (lines 329-338) -- expands InputPort.lenses into blocks
  - Phase 2: `autoInsertAdapters()` (lines 358-505) -- auto-inserts adapters for type mismatches
  - Orchestrator `pass2Adapters()` (lines 520-530) runs Phase 1 then Phase 2
- Invoked correctly in `src/graph/passes/index.ts:79` via `pass2Adapters(p1)`
- 9 tests pass in pass2-adapters.test.ts
**Issues**:
1. **CRITICAL: Doc comment contradiction.** The file header (lines 13-34) describes Phase 2 as "Type Validation" with "no auto-fix, no insertion" and "Type errors are reported, not silently fixed." But the actual Phase 2 implementation IS `autoInsertAdapters()` which does auto-insert adapter blocks. The header was written for the Sprint 2 redesign vision but the implementation retained the v1 auto-insert behavior. This is confusing for anyone reading the code.
2. **Phase 1 has ZERO tests.** All 9 tests in pass2-adapters.test.ts test Phase 2 (auto-adapter insertion with unit mismatches). No test constructs a Patch with `InputPort.lenses` populated and verifies Phase 1 expansion. This means Phase 1 could be completely broken and tests would still pass.
3. **JSON.stringify for structural comparison** in `extentMatches()` (adapter-spec.ts:139) and `patternsAreCompatible()` (adapter-spec.ts:191). This is fragile -- property ordering in objects is not guaranteed to be consistent across construction paths.

### Sprint 3: Editor Integration
**Status**: PARTIAL (substantially implemented, STATUS.md is stale)
**Evidence**:
- PatchStore lens CRUD methods: IMPLEMENTED (addLens at line ~650, removeLens at line ~749, getLensesForPort at line ~806, updateLensParams at line ~827)
- PatchStore-lens.test.ts: IMPLEMENTED (21 tests, all passing)
- lensUtils.ts: IMPLEMENTED (getAvailableLensTypes, getLensLabel, canApplyLens, findCompatibleLenses)
- PortContextMenu.tsx: IMPLEMENTED (Add Lens and Remove Lens sections)
- EdgeContextMenu.tsx: IMPLEMENTED (Add Lens section with findCompatibleLenses)
- PortInfoPopover.tsx: IMPLEMENTED (Lenses section showing attached lenses, line 295+)
- OscillaNode.tsx: IMPLEMENTED (Lens Indicator with amber color at line 235+)
**Issues**:
1. **Debug console.log statements left in production code** at `src/ui/reactFlowEditor/lensUtils.ts:111,119,128`. Three `console.log('[Lens Debug]...')` calls in `findCompatibleLenses()`.
2. **lensUtils.ts typesMatch() is oversimplified** (lines 85-96). It only checks `payload.kind` and `unit.kind` -- does not compare unit structure (e.g., angle{radians} vs angle{degrees} would match), does not check extent at all. This means the "compatible lenses" menu could show lenses that don't actually apply.
3. **No tests for lensUtils.ts, PortContextMenu lens behavior, or EdgeContextMenu lens behavior.**

### Sprint 4: UI Visualization (AdapterIndicator on edges)
**Status**: NOT STARTED
**Evidence**: No `AdapterIndicator` component found. No edge-level visual indicator for adapter/lens presence.

### Diagnostic Action Executor
**Status**: STUB
**Evidence**: `src/diagnostics/actionExecutor.ts:229` has TODO: "Rewire edges: source -> adapter -> target". The action creates an adapter block but does NOT wire it into the graph. This means the "Add Adapter" diagnostic action is broken -- it creates an orphan block.

### Connection Validation (typeValidation.ts)
**Status**: COMPLETE (with domain transform stub)
**Evidence**:
- `validateConnection()` (lines 339-378) checks direct compatibility then falls back to `findAdapter()`
- Returns `adapter` field on result when adapter can bridge types
- `canTransformDomain()` (line 251) is a stub returning false -- domain transformation not implemented
**Issues**: The `canTransformDomain` stub means field-to-field connections across different domains will always fail validation, even if a domain adapter exists. This is acceptable for now since domain adapters are a future feature, but it's a known gap.

### Adapter Rule Cache
**Status**: FUNCTIONAL (with invalidation gap)
**Evidence**: `src/blocks/adapter-spec.ts:234` -- `cachedRules` is a module-level variable, built lazily on first `findAdapter()` call, never invalidated.
**Issues**: If blocks are registered AFTER the first `findAdapter()` call, the cache will not include them. In practice this is likely fine since all blocks register at module load time before any adapter lookups, but there's no enforcement. No `resetCache()` function exists for testing.

## Ambiguities Found
| Area | Question | How LLM Guessed | Impact |
|------|----------|-----------------|--------|
| Phase 2 semantics | Should Phase 2 auto-insert adapters or only validate? | Header says validate-only but implementation auto-inserts. Kept auto-insert (v1 behavior). | LOW -- auto-insert is the working behavior, just misleading docs |
| typesMatch in lensUtils | How deep should type comparison be for lens compatibility? | Only checks payload.kind and unit.kind, ignores unit structure and extent | MEDIUM -- users may see incompatible lenses in menus |
| OutputPort.lenses | Should output lenses be supported? | Added field but marked "FUTURE" | LOW -- no code path reads it |

## Recommendations
1. **Write Phase 1 (expandExplicitLenses) tests.** This is the most critical gap. The entire lens expansion path is untested. Create tests that: (a) add lenses to InputPort, (b) run pass2Adapters, (c) verify lens blocks are created and edges rewired. Without these tests, the Sprint 2 "lens expansion" feature has no verification.
2. **Fix the doc comment contradiction** in normalize-adapters.ts. Either update the header to reflect that Phase 2 auto-inserts adapters (current behavior), or change Phase 2 to validate-only (as the header describes). The current state is misleading.
3. **Remove debug console.log** from lensUtils.ts:111,119,128.
4. **Fix typesMatch() in lensUtils.ts** to properly compare unit structure (not just kind). `angle{radians}` and `angle{degrees}` should not match.
5. **Fix the diagnostic action executor** stub at actionExecutor.ts:229 -- either implement edge rewiring or remove the broken action.
6. **Update STATUS.md** -- Sprint 3 is substantially implemented, not "PLANNED - READY".

## Verdict
- [x] CONTINUE - Issues clear, implementer can fix
- [ ] PAUSE - Ambiguities need clarification

The system is architecturally sound. Sprint 1 and 2 are genuinely complete. Sprint 3 is mostly done with cleanup needed (debug logs, type matching fix, tests). The critical gap is the absence of Phase 1 lens expansion tests -- this should be addressed before moving to Sprint 4.
