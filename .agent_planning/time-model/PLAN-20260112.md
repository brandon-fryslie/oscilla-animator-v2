# Sprint Plan: TimeRoot Complete Outputs

**Generated:** 2026-01-12
**Topic:** time-model
**Spec:** `design-docs/CANONICAL-oscilla-v2.5-20260109/topics/03-time-system.md`

---

## Sprint Goal

Complete TimeRoot block by adding missing palette and energy outputs, and exposing independent period configuration for phaseA/phaseB.

---

## Scope

**In scope (this sprint):**
- P0: Add palette and energy outputs to TimeRoot
- P1: Add independent periodAMs/periodBMs configuration
- P2: Update phase outputs to use 'phase' PayloadType

**Explicitly out of scope (future sprints):**
- Rail system infrastructure (buses-and-rails topic)
- Discrete pulse event model (Phase 3)
- Audio-reactive energy input (Phase 3)
- Hot-swap phase continuity API (needs runtime work)

---

## Work Items

### P0: Palette and Energy Outputs

**Goal:** Add the two missing TimeRoot outputs per spec.

**Files to modify:**
- `src/blocks/time-blocks.ts` - Add palette and energy output ports
- `src/compiler/passes-v2/pass3-time.ts` - Generate palette and energy signals
- `src/runtime/timeResolution.ts` - Compute palette and energy values

**Implementation:**

1. **timeResolution.ts** - Add to TimeState and resolveTime():
```typescript
// Add to TimeState
palette: { r: number; g: number; b: number; a: number };
energy: number;

// In resolveTime():
// palette = HSV(phaseA, 1.0, 0.5) converted to RGB
const hue = phaseA;
const sat = 1.0;
const val = 0.5;
// HSV to RGB conversion
const palette = hsvToRgb(hue, sat, val);

// energy = 0.5 + 0.5 * sin(phaseA * 2 * PI)
const energy = 0.5 + 0.5 * Math.sin(phaseA * 2 * Math.PI);
```

2. **time-blocks.ts** - Add output ports:
```typescript
outputs: {
  // ... existing outputs ...
  palette: signalTypeSignal('color'),
  energy: signalTypeSignal('float'),
}
```

3. **pass3-time.ts** - Add to TimeSignals:
```typescript
interface TimeSignals {
  // ... existing ...
  palette: SigExprId;
  energy: SigExprId;
}
```

**Acceptance Criteria:**
- [ ] TimeRoot blocks have palette and energy output ports
- [ ] pass3-time.ts generates palette and energy SigExprIds
- [ ] timeResolution.ts computes palette (HSV rainbow) and energy (sine wave)
- [ ] SignalEvaluator returns palette and energy values
- [ ] Existing time tests still pass

---

### P1: Independent Period Configuration

**Goal:** Allow phaseA and phaseB to have different periods.

**Files to modify:**
- `src/blocks/time-blocks.ts` - Add periodAMs and periodBMs params
- `src/compiler/passes-v2/pass3-time.ts` - Extract both periods to TimeModel
- `src/runtime/timeResolution.ts` - Use independent periods (already supported)

**Implementation:**

1. **time-blocks.ts** - Replace single periodMs with two params:
```typescript
params: {
  periodAMs: { type: 'float', default: 1000 },
  periodBMs: { type: 'float', default: 2000 }, // Different default for visual distinction
  // ... other params
}
```

2. **pass3-time.ts** - Extract both periods:
```typescript
const periodAMs = timeRootBlock.params.periodAMs ?? 1000;
const periodBMs = timeRootBlock.params.periodBMs ?? 2000;
```

**Acceptance Criteria:**
- [ ] TimeRoot blocks have periodAMs and periodBMs parameters
- [ ] pass3-time.ts extracts both periods to TimeModel
- [ ] phaseA and phaseB cycle at independent rates
- [ ] Default periodBMs differs from periodAMs for visual distinction

---

### P2: Phase PayloadType Correction

**Goal:** Use 'phase' PayloadType instead of 'float' for phase outputs.

**Files to modify:**
- `src/blocks/time-blocks.ts` - Update phaseA/phaseB output types

**Implementation:**

1. **time-blocks.ts** - Change output types:
```typescript
outputs: {
  phaseA: signalTypeSignal('phase'),  // was 'float'
  phaseB: signalTypeSignal('phase'),  // was 'float'
  // ...
}
```

**Acceptance Criteria:**
- [ ] phaseA output has PayloadType 'phase'
- [ ] phaseB output has PayloadType 'phase'
- [ ] Type system accepts phase ↔ float connections (for now)
- [ ] No test regressions

---

## Dependencies

- SignalType system (complete)
- PayloadType includes 'phase' (complete)
- timeResolution.ts phase computation (complete)

---

## Risks

| Risk | Mitigation |
|------|------------|
| Phase type breaks connections | Allow implicit phase↔float coercion for now |
| Color computation incorrect | Use standard HSV→RGB formula, test visually |
| Period change breaks tests | Update test fixtures with new param names |

---

## Verification

```bash
npm run typecheck && npm run build && npm test
```

All existing tests must pass. New tests for palette/energy computation.
