# Handoff: Expression Swizzle Implementation

**Date:** 2026-02-02
**Branch:** `bmf_type_system_refactor` (114 commits ahead of origin, clean)
**Epic:** oscilla-animator-v2-6044 (CLOSED)

---

## What Was Done

Fixed the expression compiler to support GLSL-style component access and swizzle (`.x`, `.xy`, `.rgb`) using generic `extract`/`construct` IR ops instead of removed named kernels.

### Changes
| File | What Changed |
|------|-------------|
| `src/expr/compile.ts` | `compileMemberAccess` emits `builder.extract`/`builder.construct` instead of dead kernel calls. Deleted `getExtractionKernel`/`getCombineKernel`. |
| `src/blocks/math/expression.ts` | `lower()` handles stride > 1: detects construct nodes, decomposes to component signals, emits `stepSlotWriteStrided`. |
| `src/runtime/ValueExprSignalEvaluator.ts` | `extract` reads from strided slot offsets when input is `slotRead`. `reduce` changed from `return 0` to `throw` (was unreachable). |
| `src/expr/__tests__/integration.test.ts` | 4 new tests: v.x, v.xy, color.rgb compile to correct IR. Removed placeholder test. |
| `src/runtime/__tests__/ValueExprSignalEvaluator.test.ts` | NEW: 5 tests for extract from strided slots at runtime. |
| `src/expr/FUNCTIONS.md` | Updated component access docs. |

### Verification
- 2109 tests pass (15 new), 140 test files
- TypeScript typecheck clean

---

## CRITICAL: Feature Is NOT End-to-End Usable

**The Expression block's vararg input only accepts `payloadType: FLOAT`** (line 50 of `src/blocks/math/expression.ts`). Users cannot wire vec3 or color signals into an Expression block, so swizzle cannot be used in practice.

The IR plumbing is correct. The integration boundary is blocked.

### What Must Happen Next

1. **Expand vararg constraint** in Expression block to accept vec3, color (and possibly all concrete payloads)
2. **Verify lowering** works when a real vec3 signal arrives through the vararg system (the `getExprType(value.id)` call at line 108 needs to return the correct CanonicalType)
3. **End-to-end test**: Const vec3 → Expression block with `v.x` → verify float output
4. **Create a bead** for this work — it's the difference between "swizzle works" and "swizzle is dead code"

### Where to Look

The vararg constraint is at `src/blocks/math/expression.ts` line 49-52:
```typescript
varargConstraint: {
  payloadType: FLOAT,        // ← Change this
  cardinalityConstraint: 'any',
},
```

Changing to accept all payloads may require verifying:
- The lowering path at lines 85-120 handles non-float input types correctly
- `blockRefs` at line 129 allows non-float payloads (currently hardcoded `[FLOAT, INT]`)
- The expression type checker resolves input types correctly for vec3/color

---

## Architecture Context

- **Multi-component signal spec**: `design-docs/_new/P0-Multi-Component-Signals.md`
  - Signal evaluation stays scalar (`evaluateSignal() → number`)
  - Multi-component values live in strided Value Slots
  - No array-returning signal APIs
- **Expression compiler emits semantic IR** (`extract`/`construct`), block lowering resolves to slot ops
- **Expression block follows Const block pattern** for multi-component outputs

## Key Files
- `src/expr/compile.ts:337` — `compileMemberAccess` (swizzle entry point)
- `src/blocks/math/expression.ts:49` — vararg constraint (THE BLOCKER)
- `src/runtime/ValueExprSignalEvaluator.ts:168` — signal extract evaluation
- `src/expr/swizzle.ts` — swizzle validation utilities
- `src/compiler/ir/IRBuilder.ts:112-115` — `extract()`/`construct()` builder API

## Beads
- oscilla-animator-v2-6044 (epic): CLOSED
- oscilla-animator-v2-5s8 (swizzle): CLOSED
- oscilla-animator-v2-81le (debug file): CLOSED
- **NEEDS BEAD**: "Expand Expression block vararg to accept vec3/color inputs for swizzle"
