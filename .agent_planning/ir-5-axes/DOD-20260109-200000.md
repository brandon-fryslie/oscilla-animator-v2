# Definition of Done: Compiler & IR 5-Axes (Unified)

**Generated**: 2026-01-09T20:00:00Z

---

## Overall Acceptance (Combined Specs)

Work is NOT complete unless ALL are true:

### 1. Single Source of Truth
- [ ] Exactly one `CompiledProgramIR` at `src/compiler/ir/program.ts`
- [ ] Runtime imports only this interface
- [ ] No legacy schema files remain

### 2. Forbidden Fields Eliminated
- [ ] tsc reports zero references to: nodes, buses, constPool, transforms, meta

### 3. Dense Execution Tables
- [ ] `signalExprs.nodes[]` is dense array
- [ ] `fieldExprs.nodes[]` is dense array
- [ ] `eventExprs.nodes[]` is dense array
- [ ] No hash-map lookups in hot path

### 4. Outputs Contract
- [ ] `program.outputs` exists and non-empty
- [ ] Runtime reads from `program.outputs[0].slot`

### 5. Slot Addressing
- [ ] Every slot has `SlotMetaEntry` with `offset: number`
- [ ] Runtime uses `slotMeta.offset` for all access
- [ ] Runtime NEVER computes offsets

### 6. Axes on Every Slot
- [ ] `SlotMetaEntry.type.axes` present on all slots
- [ ] No runtime defaults for axes
- [ ] Axes match: signal | field | event | value

### 7. Schedule Execution
- [ ] Runtime executes schedule steps only
- [ ] No node tables, no dynamic dispatch
- [ ] Phase ordering: rails → scalars → fields → events → sinks

### 8. DebugIndex Present
- [ ] `program.debugIndex` mandatory
- [ ] Contains stepToBlock, slotToBlock
- [ ] Contains ports[] with PortBindingIR

---

## Pass-Specific Criteria

### P0: Schema Foundation
- [ ] `irVersion: 1` is literal type
- [ ] All fields readonly
- [ ] Execution tables are dense arrays
- [ ] IRProgram marked @deprecated

### P1: SlotMeta + Axes
- [ ] offset required (no ?)
- [ ] storage: f64 | f32 | i32 | u32 | object
- [ ] All 5 axes defined in AxesDescIR
- [ ] Bridge functions cover all cases

### P2: Compiler Passes 0-4
- [ ] Pass 0: Invalid graphs rejected with clear errors
- [ ] Pass 1: ClosedNormalizedGraph produced
- [ ] Pass 2: SignalType assigned to all ports
- [ ] Pass 3: Type mismatches detected (strict unification)
- [ ] Pass 4: All AxisTag.default resolved

### P3: Compiler Passes 5-6
- [ ] Each node lowered to correct execution class
- [ ] Field nodes tagged with domain
- [ ] Tables dense (no gaps)
- [ ] State slots tracked

### P4: Compiler Passes 7-8
- [ ] Schedule respects dependencies
- [ ] Phase ordering deterministic
- [ ] Slot offsets per-storage
- [ ] Offsets stable-ordered (slotId ascending)

### P5: Runtime Update
- [ ] Reads from outputs[0].slot
- [ ] Uses slotMeta.offset
- [ ] O(work) execution
- [ ] No runtime type checks

### P6: DebugIndex
- [ ] All slots have entries
- [ ] Port roles: userWire | defaultSource | implicitCoerce | internalHelper
- [ ] Combine contributors tracked
- [ ] Constants pool is JSON-only

---

## Tests

### Existing
- [ ] 68 existing tests pass

### Schema
- [ ] CompiledProgramIR type validation
- [ ] SlotMetaEntry required fields
- [ ] AxesDescIR value constraints
- [ ] ShapeDescIR discriminated union

### Bridge Functions
- [ ] `bridgeExtentToAxesDescIR()` - all axis combinations
- [ ] `payloadTypeToShapeDescIR()` - all payload types

### Compiler Passes
- [ ] Pass 0: Reject invalid inputs
- [ ] Pass 1: Normalization idempotent
- [ ] Pass 2: Type assignment complete
- [ ] Pass 3: Unification strict
- [ ] Pass 4: Defaults resolved
- [ ] Pass 5: Lowering correct per extent
- [ ] Pass 6: Tables dense
- [ ] Pass 7: Schedule deterministic
- [ ] Pass 8: Offsets correct

### Runtime
- [ ] Offset addressing works
- [ ] Output slot extraction works
- [ ] No offset derivation

### Debug
- [ ] Debug index complete
- [ ] Port bindings accurate
