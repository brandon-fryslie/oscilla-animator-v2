# Definition of Done: IR and Normalization 5-Axes

**Generated**: 2026-01-09T19:55:00Z

---

## Overall Acceptance (Spec Section 5)

Work is NOT complete unless ALL are true:

### 1. Single Source of Truth
- [ ] Exactly one `CompiledProgramIR` at `src/compiler/ir/program.ts`
- [ ] Runtime imports only this interface
- [ ] No legacy schema files remain

### 2. Forbidden Fields Eliminated
- [ ] tsc reports zero references to: nodes, buses, constPool, transforms, meta

### 3. Outputs Contract
- [ ] `program.outputs` exists and non-empty
- [ ] Runtime reads from `program.outputs[0].slot`

### 4. Slot Addressing
- [ ] Every slot has `SlotMetaEntry` with `offset: number`
- [ ] Runtime uses `slotMeta.offset` for all access
- [ ] Runtime NEVER computes offsets

### 5. Axes on Every Slot
- [ ] `SlotMetaEntry.type.axes` present on all slots
- [ ] No runtime defaults for axes
- [ ] Axes match: signal | field | event | value

### 6. DebugIndex Present
- [ ] `program.debugIndex` mandatory
- [ ] Contains stepToBlock, slotToBlock
- [ ] Contains ports[] with PortBindingIR

---

## Phase-Specific Criteria

### P0: Schema Foundation
- [ ] `irVersion: 1` is literal type
- [ ] All fields readonly
- [ ] IRProgram marked @deprecated
- [ ] Runtime accepts CompiledProgramIR

### P1: SlotMeta + Axes
- [ ] offset required (no ?)
- [ ] storage: f64 | f32 | i32 | u32 | object
- [ ] All 5 axes defined in AxesDescIR
- [ ] Bridge functions cover all cases

### P2: Runtime Update
- [ ] Reads from outputs[0].slot
- [ ] Uses slotMeta.offset
- [ ] Assertion: offset !== undefined

### P3: Normalization 1-3
- [ ] Phase functions pure (no mutation)
- [ ] DefaultSource nodes created
- [ ] Combine nodes for fan-in
- [ ] Deterministic ordering

### P4: Type Legalization
- [ ] Conversion nodes inserted
- [ ] Errors include expected vs actual
- [ ] Axes never guessed

### P5: Cycle + Ordering
- [ ] Cycles without delays rejected
- [ ] Error includes cycle path
- [ ] normalize(normalize(G)) == normalize(G)

### P6: DebugIndex
- [ ] All slots have entries
- [ ] Port roles: userWire | defaultSource | implicitCoerce | internalHelper
- [ ] Combine contributors tracked

---

## Tests

- [ ] 68 existing tests pass
- [ ] Schema validation tests
- [ ] Bridge function tests (all combinations)
- [ ] Each normalization phase tested
- [ ] Offset addressing tests
- [ ] Debug index completeness tests
