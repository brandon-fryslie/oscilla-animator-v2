# Sprint Plan: Design Docs Audit & Roadmap Alignment

**Sprint Goal**: Reconcile design doc contradictions, create accurate spec index, and build phased implementation roadmap

**Date**: 2026-01-07
**Topic**: design-docs-audit
**Estimated Duration**: 1 sprint (3-5 days)

---

## In Scope

1. **Contradictions/Ambiguities Report** - Comprehensive catalog of conflicts between spec files
2. **INDEX.md Rewrite** - Accurate, thorough spec index matching actual file structure
3. **Phased Implementation Roadmap** - 3-phase plan from current state to full spec
4. **V1 Pattern Analysis** - Document which v1 patterns to preserve vs avoid in v2

## Out of Scope

- Implementing any spec features
- Modifying existing spec content (only documenting contradictions)
- Creating new spec files
- Updating code

---

## Deliverables

### P0: Contradictions & Ambiguities Report

**File**: `.agent_planning/design-docs-audit/CONTRADICTIONS-20260107_142846.md`

**Scope**:
- Catalog all contradictions between spec files
- Document spec vs final-System-Invariants conflicts
- List unresolved ambiguities from AMBIGUITIES.md with impact assessment
- Identify missing/incomplete specs referenced in INDEX.md
- Cross-reference with current v2 implementation gaps

**Structure**:
```markdown
# Critical Contradictions (blocks implementation)
- Stateful blocks count/list (4 sources with different answers)
- TimeRoot definition (spec vs invariants)
- Rails list (canonical vs mentioned)

# Spec Organization Issues
- File path mismatches in INDEX.md
- Duplicate coverage (01-type-system.md vs compiler/01-type-system.md)

# Ambiguities STATUS UPDATE
âœ… ALL 4 ambiguities from AMBIGUITIES.md have been RESOLVED by user:
- Ambiguity #1 (Custom combine mode registry): Documented as UNKNOWN, needs resolution
- Ambiguity #2 (Stateful primitive world coverage): Signal and field worlds only to start
- Ambiguity #3 (Default source catalog): Detailed implementation plan provided
- Ambiguity #4 (Event semantics): Event payload schema with metadata/data structure defined

# Spec vs Implementation Gaps
- Graph normalization (spec only)
- Bus blocks (spec only)
- Composite blocks (spec only)
- Transform catalog (spec has 50+, impl has 0)
```

**Implementation Notes**:
- Read every .md file in design-docs/spec/ and design-docs/final-System-Invariants/
- Create matrix of contradictory statements with file:line references
- Use grep to find all references to each ambiguous concept
- Cross-reference with src/ to identify implementation gaps

---

### P0: Rewrite design-docs/spec/INDEX.md

**File**: `design-docs/spec/INDEX.md` (to be rewritten)

**Scope**:
- Match actual file locations (subdirectories: compiler/, graph/, runtime/, etc.)
- Add descriptions of what each spec covers
- Indicate status (complete/partial/stub)
- Note dependencies between specs
- Reference final-System-Invariants/ as override layer
- Include AMBIGUITIES.md in index

**Structure**:
```markdown
# Unified Spec Index

## How to Use This Index
- Specs in subdirectories are organized by concern
- `final-System-Invariants/` takes precedence over conflicting content here
- See AMBIGUITIES.md for unresolved decisions

## Status Legend
- âœ… Complete - Comprehensive, no gaps
- ðŸ”„ Partial - Core defined, details incomplete
- ðŸš§ Stub - Placeholder only

## Invariants
| File | Status | Purpose |
| --- | --- | --- |
| 00-invariants.md | ðŸ”„ | Non-negotiable system invariants (has gaps) |
| AMBIGUITIES.md | âœ… | Open questions needing resolution |

## Compiler Layer
| File | Status | Purpose |
| compiler/01-type-system.md | âœ… | Worlds, TypeDesc, domains, compatibility |
| compiler/04-compilation.md | âœ… | Normalization, validation, compile pipeline |

## Graph Layer
| File | Status | Purpose |
| graph/02-time.md | âœ… | TimeRoot, TimeModel, monotonic time |
| graph/03-buses.md | âœ… | Multi-writer, combine modes, bus blocks |
| graph/06-blocks.md | ðŸ”„ | Block taxonomy (stateful list incomplete) |
| graph/07-transforms.md | âœ… | Transform catalog, lens/adapter stacks |
| graph/08-primitives-composites.md | ðŸš§ | Primitive set, composite library |
| graph/stateful-blocks.md | âœ… | 4 canonical stateful primitives |
| graph/basic-12-blocks.md | âœ… | Minimal working block set |

## Runtime Layer
| File | Status | Purpose |
| runtime/05-runtime.md | âœ… | Runtime loop, hot swap, state continuity |

## Renderer Layer
| File | Status | Purpose |
| renderer/09-renderer.md | ðŸ”„ | Renderer contract (incomplete) |
| renderer/RENDER-PIPELINE.md | ðŸš§ | Render IR details |

## Time/Phase System
| File | Status | Purpose |
| time/10-phase-matching-system.md | âœ… | Phase matching rules |
| time/11-phase-unwrap-IMPORTANT.md | âœ… | Phase unwrap semantics |

## Final System Invariants (Override Layer)
See `design-docs/final-System-Invariants/README.md`
These are FINAL and take precedence over any conflicts in spec/.
```

**Implementation Notes**:
- Use `find` and `ls` to audit actual file locations
- Read first 20 lines of each spec to understand scope
- Note file sizes to estimate completeness
- Check for TODO/FIXME markers

---

### P1: Phased Implementation Roadmap

**File**: `.agent_planning/design-docs-audit/ROADMAP-PHASED-20260107_142846.md`

**Scope**:
- Define 3 implementation phases from current v2 to full spec
- Map spec files to phases
- Identify dependencies between features
- Estimate relative complexity (S/M/L/XL)
- Note which features can be incrementally adopted

**Structure**:
```markdown
# Phase 1: Type System + Integration + Conformance (REVISED SCOPE)
Goal: Implement core type system, integrate existing components, ensure spec conformance

**Deliverables:**
1. Implement Type System (#1)
   - Complete TypeDesc implementation (Worlds, Domains, Semantics)
   - Type compatibility and conversion rules
   - Domain validation and constraints

2. Integrate blocks, compiler, and renderer (#2)
   - Ensure seamless data flow: Graph â†’ Compiler â†’ IR â†’ Runtime â†’ Renderer
   - Verify block registry integrates with compilation
   - Confirm renderer consumes IR correctly

3. Ensure ALL code conforms to spec
   - Audit all existing code against spec documents
   - Fix any deviations from invariants
   - Update code to match architectural decisions
   - Remove dead/duplicate code (e.g., unused type systems)

4. Plan next steps
   - Evaluate what's complete vs what remains
   - Define Phase 2 scope based on Phase 1 learnings

Dependencies: None (builds on current v2)
Risk: Medium (requires refactoring but scoped to current codebase)

# Phase 2+: TBD
To be defined after Phase 1 completion based on:
- What was learned during conformance audit
- Which spec features provide highest value
- Updated understanding of implementation complexity
```

**Implementation Notes**:
- Cross-reference with current ROADMAP.md
- Consider agent handoff points between phases
- Flag features that need ambiguity resolution first

---

### P2: V1 Pattern Analysis

**File**: `.agent_planning/design-docs-audit/V1-PATTERNS-20260107_142846.md`

**Scope**:
- Extract v1 insights from ANAYLSIS-WRONG-CONFUSED-AGENT.md
- Document what v1 got right that v2 should preserve
- Document what v1 got wrong that v2 must avoid
- Map v1 concepts to v2 equivalents

**Structure**:
```markdown
# V1 Patterns to Preserve

## Single Compiler Pipeline
V1 Insight: Linear compile pipeline (normalize â†’ type check â†’ lower â†’ IR)
V2 Status: âœ… Preserved in src/compiler/compile.ts

## Block Registry Pattern
V1 Insight: Centralized block registry with lower() function
V2 Status: âœ… Preserved in src/compiler/blocks/registry.ts

## IR Builder Pattern
V1 Insight: Builder interface for lowering blocks to IR
V2 Status: âœ… Preserved in src/compiler/ir/IRBuilder.ts

# V1 Patterns to Avoid

## God Blocks
V1 Problem: PositionSwirl (170 lines, 7 inputs, 4 behaviors)
V2 Solution: âœ… Split into 5 composable blocks (done in architectural refactor)

## Duplicate Type Systems
V1 Problem: src/types/index.ts vs src/core/types.ts
V2 Solution: Delete duplicates (TODO in v2)

## Incomplete Passes Framework
V1 Problem: src/compiler/passes-v2/ exists but unused
V2 Solution: Delete or integrate (TODO in v2)

# V1 to V2 Concept Mapping

| V1 Concept | V2 Equivalent | Notes |
| --- | --- | --- |
| Patch | Patch (unchanged) | User-facing graph |
| BlockDef | BlockDefinition | Spec has richer interface |
| IRProgram | IRProgram | Core IR unchanged |
| TimeModel | TimeModel | Needs TimeRoot integration |
| Signal/Field worlds | Preserved | No changes |
```

**Implementation Notes**:
- Use ANAYLSIS-WRONG-CONFUSED-AGENT.md as primary source
- Cross-reference with ARCHITECTURAL-REFACTOR-COMPLETE.md
- Look for architectural decisions that worked well

---

## Dependencies & Sequencing

```
P0 Contradictions Report â†’ P0 INDEX Rewrite â†’ P1 Roadmap
                        â†˜
                          P2 V1 Patterns (parallel)
```

**Critical Path**: Contradictions must be documented before INDEX can be accurate. Roadmap depends on understanding contradictions to plan resolution.

**Parallel Work**: V1 Patterns analysis can happen alongside other deliverables.

---

## Risks & Mitigation

### Risk 1: Contradictions Between Spec and final-System-Invariants
**Impact**: High - Don't know which is authoritative
**Mitigation**: Document all conflicts, propose "final-System-Invariants wins" as resolution rule

### Risk 2: Ambiguities Block Roadmap Planning
**Impact**: Medium - Can't plan features that aren't defined
**Mitigation**: Flag features needing ambiguity resolution, provide decision framework

### Risk 3: Scope Creep - Trying to Resolve Contradictions
**Impact**: Medium - Sprint could balloon
**Mitigation**: DOCUMENT ONLY in this sprint, resolution happens in dedicated follow-up sprint

---

## Success Criteria

- All 4 deliverables completed and committed
- Contradictions report has file:line references for every conflict
- INDEX.md accurately reflects actual file structure
- Roadmap has clear phase boundaries with dependencies
- V1 patterns provide clear guidance for future development

**Output Location**: `.agent_planning/design-docs-audit/`
