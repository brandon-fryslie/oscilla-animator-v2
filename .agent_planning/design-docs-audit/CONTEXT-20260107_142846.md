# Context Dump: Design Docs Audit

**Sprint**: design-docs-audit
**Date**: 2026-01-07
**Purpose**: Comprehensive context for write-only implementation phase

---

## Critical File Paths

### Spec Files (design-docs/spec/)

```
/Users/bmf/code/oscilla-animator-v2/design-docs/spec/00-invariants.md
/Users/bmf/code/oscilla-animator-v2/design-docs/spec/INDEX.md
/Users/bmf/code/oscilla-animator-v2/design-docs/spec/AMBIGUITIES.md
/Users/bmf/code/oscilla-animator-v2/design-docs/spec/compiler/01-type-system.md
/Users/bmf/code/oscilla-animator-v2/design-docs/spec/compiler/04-compilation.md
/Users/bmf/code/oscilla-animator-v2/design-docs/spec/graph/02-time.md
/Users/bmf/code/oscilla-animator-v2/design-docs/spec/graph/03-buses.md
/Users/bmf/code/oscilla-animator-v2/design-docs/spec/graph/06-blocks.md
/Users/bmf/code/oscilla-animator-v2/design-docs/spec/graph/07-transforms.md
/Users/bmf/code/oscilla-animator-v2/design-docs/spec/graph/08-primitives-composites.md
/Users/bmf/code/oscilla-animator-v2/design-docs/spec/graph/stateful-blocks.md
/Users/bmf/code/oscilla-animator-v2/design-docs/spec/graph/basic-12-blocks.md
/Users/bmf/code/oscilla-animator-v2/design-docs/spec/runtime/05-runtime.md
/Users/bmf/code/oscilla-animator-v2/design-docs/spec/renderer/09-renderer.md
/Users/bmf/code/oscilla-animator-v2/design-docs/spec/renderer/RENDER-PIPELINE.md
/Users/bmf/code/oscilla-animator-v2/design-docs/spec/time/10-phase-matching-system.md
/Users/bmf/code/oscilla-animator-v2/design-docs/spec/time/11-phase-unwrap-IMPORTANT.md
```

### Final System Invariants

```
/Users/bmf/code/oscilla-animator-v2/design-docs/final-System-Invariants/README.md
/Users/bmf/code/oscilla-animator-v2/design-docs/final-System-Invariants/1-Core-Laws.md
/Users/bmf/code/oscilla-animator-v2/design-docs/final-System-Invariants/13-DefaultSources.md
/Users/bmf/code/oscilla-animator-v2/design-docs/final-System-Invariants/14-Stateful-Primitives.md
/Users/bmf/code/oscilla-animator-v2/design-docs/final-System-Invariants/15-Block-Edge-Roles.md
/Users/bmf/code/oscilla-animator-v2/design-docs/final-System-Invariants/16-Graph-Normalization.md
/Users/bmf/code/oscilla-animator-v2/design-docs/final-System-Invariants/Rail.md
/Users/bmf/code/oscilla-animator-v2/design-docs/final-System-Invariants/Rail-Modulation-and-Feedback.md
/Users/bmf/code/oscilla-animator-v2/design-docs/final-System-Invariants/Palette.md
/Users/bmf/code/oscilla-animator-v2/design-docs/final-System-Invariants/Unified-Transforms-Architecture.md
```

### Analysis & Context Files

```
/Users/bmf/code/oscilla-animator-v2/design-docs/ANAYLSIS-WRONG-CONFUSED-AGENT.md
/Users/bmf/code/oscilla-animator-v2/.agent_planning/ARCHITECTURAL-REFACTOR-COMPLETE.md
/Users/bmf/code/oscilla-animator-v2/.agent_planning/ROADMAP.md
```

### Current Implementation

```
/Users/bmf/code/oscilla-animator-v2/src/compiler/compile.ts - Main compiler entry
/Users/bmf/code/oscilla-animator-v2/src/compiler/blocks/registry.ts - Block registry
/Users/bmf/code/oscilla-animator-v2/src/types/index.ts - Active type system
/Users/bmf/code/oscilla-animator-v2/src/graph/Patch.ts - User graph
/Users/bmf/code/oscilla-animator-v2/src/graph/normalize.ts - Basic normalization
```

---

## Key Concepts & Definitions

### Worlds (TypeDesc Evaluation Contexts)

From `compiler/01-type-system.md`:

| World | Meaning | Evaluation | Example |
| --- | --- | --- | --- |
| Scalar | Compile-time constant | Once at compile | `periodMs: 2000` |
| Signal | Time-indexed value | Once per frame | `phase: Signal<phase>` |
| Field | Per-element value | At render sinks | `radius: Field<number>` |
| Event | Discrete trigger | Edge detection | `pulse: Event` |

**Key Rule**: TypeDesc = { world, domain, semantics? }

### Domains (Value Types)

Core domains from spec:
- number, unit, time, phase, color, vec2, vec3, bool, event, domain, render

**Key Rule**: Phase is a distinct domain with wrap semantics, not implicitly assignable to number

### Stateful Blocks - THE CRITICAL CONTRADICTION

**Source 1**: `00-invariants.md` line 51
> 4 stateful blocks: UnitDelay, Phazor, and 2 more

**Source 2**: `graph/06-blocks.md` lines 35-40
> ONLY these 4 blocks are stateful. All others are stateless:
> - UnitDelay

(List incomplete!)

**Source 3**: `graph/stateful-blocks.md` (COMPLETE)
1. UnitDelay<T> - y(t) = x(t-1) - frame delay for feedback
2. Accumulator - y(t) = y(t-1) + x(t) - integration
3. SampleAndHold<T> - latch on trigger
4. PhaseUnwrapper - continuous phase from wrapping phase

**Source 4**: `final-System-Invariants/14-Stateful-Primitives.md` (FINAL)
1. UnitDelay - $z^{-1}$ delay
2. Lag - follower with rise/fall, linear/exponential modes
3. Phasor - 0‚Üí1 ramp generator
4. SampleAndHold - freeze on trigger

**CRITICAL DECISION NEEDED**: Which list is authoritative?
- stateful-blocks.md is most detailed and mathematically grounded
- 14-Stateful-Primitives.md is marked "Finalized" and in final-System-Invariants
- Lag vs Accumulator - different primitives!
- Phasor vs PhaseUnwrapper - different purposes!

### Buses & Rails

From `graph/03-buses.md`:

**Bus Block**: Derived block with globally addressable busId
- Input: `in` (multi-writer, CombineMode configurable)
- Output: `out`

**Rails**: Immutable system-provided bus blocks present in every patch

Canonical rails (from line 55-62):
- time
- phaseA
- phaseB
- pulse
- energy
- palette
- progress

**Key Invariant**: Rails exist in every patch even if unused, rendered differently in UI but normal blocks in compiler

### Default Sources

From `00-invariants.md` lines 28-32 and `final-System-Invariants/13-DefaultSources.md`:

- Every port has an automatic default source (lowest priority)
- Default source is a block (not a parameter)
- Default combine mode on user blocks is 'priority'
- GraphNormalization materializes default sources as blocks
- Compiler never sees default sources (only normalized graph)

**AMBIGUITY**: Default source catalog not enumerated (AMBIGUITIES.md line 13-15)

### Graph Normalization

From `final-System-Invariants/16-Graph-Normalization.md`:

**Two Graphs**:
1. **RawGraph** (UI graph) - User edits, has attachments/affordances
2. **NormalizedGraph** (compiler graph) - Fully explicit blocks+edges

**Normalization Responsibilities**:
- Expand composites/macros into blocks + edges
- Materialize DefaultSource blocks for inputs with zero writers
- Materialize BusBlocks for bus UI wiring
- Ensure global rail BusBlocks exist
- Expand lens/adapter UI transforms into explicit derived blocks
- Convert stateful wire operations into explicit stateful blocks
- Assign stable IDs using anchor-based rules

**Key Invariant** (from `00-invariants.md` line 9):
> Everything is a block or wire at compile time. Buses, default sources, lenses/adapters (transforms), and stateful infrastructure are derived blocks in the NormalizedGraph. The compiler NEVER deals with buses, default sources, lenses, etc.

### Transforms (Lens/Adapter Blocks)

From `graph/07-transforms.md`:

**Adapter block**: Changes TypeDesc (world and/or domain) for compatibility
**Lens block**: Type-preserving shaping for expressive control

**Key Rules**:
- All transforms are unary (one input, one output)
- Transforms are blocks, not edge properties
- GraphNormalization expands transform UI into block chains
- Edges are pure connections

**Transform Catalog** (50+ blocks listed in 07-transforms.md):

Adapters:
- PhaseToNumber, NumberToPhase
- UnitToNumber, NumberToUnit
- PhaseToPulse
- SignalToFieldBroadcast
- FieldReduceSum/Mean/Min/Max

Lenses (type-preserving, per domain):
- Numeric: GainBias, Polarity, Clamp, MapRange, Ease, Quantize, Deadzone, Softclip, Wavefold, Slew/Lag, Hysteresis, etc.
- Phase: PhaseOffset, PhaseScale, PingPong, WrapMode, PhaseQuantize, PhaseWindow, etc.
- Vec2: Vec2GainBias, Rotate2D, Translate2D, ClampBounds, Normalize, Swirl, etc.
- Color: ColorGain, HueShift, Saturate, Contrast, ClampGamut, MixWith
- Boolean: Invert, Debounce, Hold
- Event: Debounce, PulseStretch, Divide, Delay, GateProbability

### Combine Modes

From `graph/03-buses.md` lines 9-17:

```typescript
type CombineMode =
  | 'sum' | 'average' | 'min' | 'max' | 'mul'       // numeric, componentwise
  | 'last' | 'first' | 'layer'                      // order-dependent
  | 'or' | 'and'                                    // boolean only
  | { kind: 'custom'; id: string }                  // registered reducer
```

**Deterministic Ordering** (lines 68-80):
Order-dependent modes use stable ordering:
```
(edge.priority, edge.rolePriority, from.blockId, from.portId, edge.id)
```

**AMBIGUITY** (AMBIGUITIES.md line 5-7):
> Where do custom combine reducers live (block registry vs global combine registry)?
> How are they validated against TypeDesc?

### Time Model

From `graph/02-time.md` and `00-invariants.md`:

**Invariants**:
- Time is monotonic and unbounded (t never wraps)
- Exactly one TimeRoot per patch
- Only two TimeRoot kinds: infinite
- TimeRoot is global (not user-placeable)
- Hot-swap never resets t

**TimeRoot** provides to patch:
- t (absolute monotonic time)
- phase (0‚Üí1 wrapping)
- pulse (wrap events)
- energy (integrated phase)

### IR (Intermediate Representation)

From `compiler/ir/types.ts` (current implementation) and spec:

**Core IR Types**:
```typescript
type SigExpr =
  | SigExprConst       // Constant value
  | SigExprTime        // Time source
  | SigExprExternal    // Mouse input
  | SigExprMap         // Unary function
  | SigExprZip         // N-ary function

type FieldExpr =
  | FieldExprConst       // Constant per element
  | FieldExprSource      // Domain source (index, random)
  | FieldExprBroadcast   // Signal‚ÜíField promotion
  | FieldExprMap         // Unary per-element function
  | FieldExprZip         // N-ary per-element function
  | FieldExprZipSig      // Zip field with signals

type Step =
  | StepEvalSig        // Evaluate signal ‚Üí slot
  | StepMaterialize    // Materialize field ‚Üí buffer
  | StepRender         // Render pass
```

**OpCode Set**:
Arithmetic: Add, Sub, Mul, Div, Mod, Neg, Abs
Trigonometric: Sin, Cos, Tan
Range: Min, Max, Clamp, Lerp
Comparison: Eq, Lt, Gt
Phase: Wrap01

---

## Specific Ambiguities to Document

### From AMBIGUITIES.md

**1. Custom combine mode registry** (lines 5-7)
- Where do reducers live?
- How validated against TypeDesc?
- Who owns the registry?

**2. Stateful primitive world coverage** (lines 9-11)
- UnitDelay/Lag/SampleAndHold on all worlds (signal/field/event)?
- Or signal-only?
- If fields supported, how is element identity handled for state storage?

**3. Default source catalog** (lines 13-15)
- Standard defaults per TypeDesc not enumerated
- Where do defaults live?
- How surfaced in UI?

**4. Event semantics** (lines 17-19)
- Precise event payload shape unspecified
- Edge-detection behavior undefined
- Combine semantics for event payloads (beyond boolean fired) need rules

---

## Contradictions to Document

### Critical: Stateful Blocks

| Source | Line | Count | List |
| --- | --- | --- | --- |
| 00-invariants.md | 51 | "4" | UnitDelay, Phazor, and 2 more [INCOMPLETE] |
| 06-blocks.md | 38 | "4" | Only UnitDelay listed [INCOMPLETE] |
| stateful-blocks.md | complete | 4 | UnitDelay, Accumulator, SampleAndHold, PhaseUnwrapper |
| 14-Stateful-Primitives.md | complete | 4 | UnitDelay, Lag, Phasor, SampleAndHold |

**Conflicts**:
- Accumulator vs Lag (different primitives)
- PhaseUnwrapper vs Phasor (different purposes)
- Phazor vs Phasor (typo or different block?)

### INDEX.md File Path Issues

Current INDEX.md references:
- `01-type-system.md` ‚Üí Actually at `compiler/01-type-system.md`
- `02-time.md` ‚Üí Actually at `graph/02-time.md`
- `03-buses.md` ‚Üí Actually at `graph/03-buses.md`
- `04-compilation.md` ‚Üí Actually at `compiler/04-compilation.md`
- `05-runtime.md` ‚Üí Actually at `runtime/05-runtime.md`
- `06-blocks.md` ‚Üí Actually at `graph/06-blocks.md`
- `07-transforms.md` ‚Üí Actually at `graph/07-transforms.md`
- `08-primitives-composites.md` ‚Üí Actually at `graph/08-primitives-composites.md`
- `09-renderer.md` ‚Üí Actually at `renderer/09-renderer.md`

Missing from INDEX:
- `graph/stateful-blocks.md`
- `graph/basic-12-blocks.md`
- `renderer/RENDER-PIPELINE.md`
- `time/10-phase-matching-system.md`
- `time/11-phase-unwrap-IMPORTANT.md`

### Spec vs final-System-Invariants

**Authority Question**: Which takes precedence?

`final-System-Invariants/README.md` line 2:
> everything in this directory must be considered a core invariant that cannot be violated

But `design-docs/spec/INDEX.md` line 3:
> This is the unified specification to migrate into the new repo. It supersedes all older and conflicting docs.

**Recommendation**: final-System-Invariants wins (marked FINAL), but document where specs contradict it.

---

## V1 Codex Insights

From `ANAYLSIS-WRONG-CONFUSED-AGENT.md`:

### V1 Architecture That Worked

**Single Compiler Pipeline** (lines 18-38):
```
Patch (graph) ‚Üí Normalize ‚Üí Type Check ‚Üí Dependency Order ‚Üí Block Lowering ‚Üí IR Program
```

- Linear, predictable
- No hidden passes
- Clear separation: graph ‚Üí compiler ‚Üí IR ‚Üí runtime ‚Üí render

**Block Registry Pattern** (lines 40-55):
```typescript
interface BlockDef {
  type: string;
  inputs: PortDef[];
  outputs: PortDef[];
  lower: BlockLower;  // (context) ‚Üí Record<portId, ValueRef>
}
```

- Single global registry
- Declarative block definitions
- lower() function compiles to IR

**IR Builder Pattern** (lines 184-214):
Blocks use IRBuilder to emit IR:
```typescript
const lowerConstFloat: BlockLower = ({ b, config }) => {
  const value = config.value ?? 0;
  const id = b.sigConst(value, sigType('float'));
  return { out: { kind: 'sig', id, type: sigType('float') } };
};
```

### V1 Problems Fixed in V2

**God Blocks** (ARCHITECTURAL-REFACTOR-COMPLETE.md lines 8-21):
- PositionSwirl: 170 lines, 7 inputs, 4 behaviors
- Solution: Split into 5 composable blocks (FieldGoldenAngle, FieldAngularOffset, FieldAdd, FieldRadiusSqrt, FieldPolarToCartesian)

**Duplicate Type Systems** (lines 495-502):
- src/types/index.ts (used)
- src/core/types.ts (unused, 249 lines of dead code)
- src/blocks/registry.ts (unused, UI-only)

**Incomplete Passes Framework** (lines 450-464):
- src/compiler/passes-v2/ (700+ lines, never integrated)
- Main compile.ts reimplements logic instead of using passes

### V1 Current Implementation Status (77 TypeScript files)

**Directory Structure**:
```
src/
‚îú‚îÄ‚îÄ compiler/
‚îÇ   ‚îú‚îÄ‚îÄ compile.ts (‚úÖ main entry point)
‚îÇ   ‚îú‚îÄ‚îÄ blocks/registry.ts (‚úÖ 40 blocks registered)
‚îÇ   ‚îú‚îÄ‚îÄ ir/ (‚úÖ IR types and builder)
‚îÇ   ‚îî‚îÄ‚îÄ passes/ (TypeChecker only)
‚îú‚îÄ‚îÄ runtime/
‚îÇ   ‚îú‚îÄ‚îÄ ScheduleExecutor.ts (‚úÖ frame execution)
‚îÇ   ‚îú‚îÄ‚îÄ SignalEvaluator.ts (‚úÖ signal computation)
‚îÇ   ‚îú‚îÄ‚îÄ Materializer.ts (‚úÖ field evaluation)
‚îÇ   ‚îî‚îÄ‚îÄ BufferPool.ts (‚úÖ memory management)
‚îú‚îÄ‚îÄ render/
‚îÇ   ‚îî‚îÄ‚îÄ Canvas2DRenderer.ts (‚úÖ 2D squares only)
‚îú‚îÄ‚îÄ graph/
‚îÇ   ‚îú‚îÄ‚îÄ Patch.ts (‚úÖ user graph)
‚îÇ   ‚îî‚îÄ‚îÄ normalize.ts (‚úÖ basic normalization)
‚îî‚îÄ‚îÄ types/
    ‚îî‚îÄ‚îÄ index.ts (‚úÖ active type system)
```

**40 Blocks Implemented** (from registry):
- Time (2): InfiniteTimeRoot
- Signals (5): ConstFloat, AddSignal, MulSignal, Oscillator, MousePosition
- Domain (5): DomainN, GridDomain, Broadcast, FieldMap, FieldZipSig
- Render (12): FieldPulse, FieldGoldenAngle, FieldAngularOffset, FieldAdd, FieldRadiusSqrt, FieldPolarToCartesian, FieldHueFromPhase, HsvToRgb, FieldJitter2D, FieldAttract2D, RenderInstances2D, etc.

**Missing from Spec**:
- Graph normalization (spec only)
- Bus blocks (spec only)
- Rails (spec only)
- Default sources as blocks (spec only)
- Composite blocks (spec only)
- Transform catalog (spec has 50+, impl has 0)
- Stateful primitives (spec has 4, impl has 0)
- Multi-writer combine (spec only)

---

## Implementation Gap Matrix

| Spec Feature | Spec File | Implementation Status | Blocker |
| --- | --- | --- | --- |
| **Core Type System** | compiler/01-type-system.md | ‚úÖ Partial (src/types/index.ts) | Missing domain conversions |
| **Time Model** | graph/02-time.md | ‚úÖ Partial (TimeModel exists) | No TimeRoot integration |
| **Buses & Rails** | graph/03-buses.md | ‚ùå None | Needs graph normalization |
| **Compilation** | compiler/04-compilation.md | ‚úÖ Partial (compile.ts) | No full normalization |
| **Runtime** | runtime/05-runtime.md | ‚úÖ Partial (ScheduleExecutor) | No hot swap |
| **Blocks** | graph/06-blocks.md | ‚úÖ Partial (40 blocks) | No composites |
| **Transforms** | graph/07-transforms.md | ‚ùå None (0 of 50+) | Needs lens system |
| **Primitives** | graph/08-primitives-composites.md | üöß Stub | Not enumerated |
| **Renderer** | renderer/09-renderer.md | ‚úÖ Minimal (Canvas2D) | Only squares |
| **Stateful Blocks** | graph/stateful-blocks.md | ‚ùå None (0 of 4) | Ambiguity on which 4 |
| **Default Sources** | (invariants) | ‚ùå None | Needs normalization |
| **Graph Normalization** | 16-Graph-Normalization.md | ‚ùå None | Core blocker |
| **Phase Matching** | time/10-phase-matching-system.md | ‚ùå None | Advanced feature |

---

## Research Commands for Implementation

### Find all spec files
```bash
find /Users/bmf/code/oscilla-animator-v2/design-docs/spec -name "*.md" -type f
```

### Find all final-System-Invariants
```bash
find /Users/bmf/code/oscilla-animator-v2/design-docs/final-System-Invariants -name "*.md" -type f
```

### Search for specific concepts
```bash
# Find all references to "stateful"
grep -r "stateful" /Users/bmf/code/oscilla-animator-v2/design-docs/spec --include="*.md"

# Find all references to "UnitDelay"
grep -r "UnitDelay" /Users/bmf/code/oscilla-animator-v2/design-docs --include="*.md"

# Find all TODOs in specs
grep -r "TODO" /Users/bmf/code/oscilla-animator-v2/design-docs/spec --include="*.md"
```

### Count blocks in implementation
```bash
find /Users/bmf/code/oscilla-animator-v2/src/compiler/blocks -name "*.ts" -type f | wc -l
```

### Check for duplicate type systems
```bash
ls -la /Users/bmf/code/oscilla-animator-v2/src/types/
ls -la /Users/bmf/code/oscilla-animator-v2/src/core/
```

---

## Output File Paths

All deliverables go to:
```
/Users/bmf/code/oscilla-animator-v2/.agent_planning/design-docs-audit/
```

Files to create:
1. `CONTRADICTIONS-20260107_142846.md`
2. `ROADMAP-PHASED-20260107_142846.md`
3. `V1-PATTERNS-20260107_142846.md`

File to rewrite:
```
/Users/bmf/code/oscilla-animator-v2/design-docs/spec/INDEX.md
```

---

## Success Indicators

- Contradictions report has 15+ documented contradictions with line numbers
- INDEX.md accurately reflects all 17+ spec files with correct paths
- Roadmap defines 3 clear phases mapping all spec features
- V1 patterns provides 10+ preserve/avoid guidance items
- All cross-references between documents are valid
- Future agent can implement from these docs without needing to re-reading all specs
