# Explore: Pure Lowering Migration
Timestamp: 2026-02-06-024500
Agent: project-evaluator (manual exploration, no haiku subagent)

## Files Examined

### Core TODO Document
- `/Users/bmf/code/oscilla-animator-v2/PURE-LOWERING-TODO.md`
- Claims 78/80 blocks migrated (97.5%)
- 4 blocks remain: const.ts, expression.ts, default-source.ts, external-vec2.ts
- Design decision documented at bottom: use construct() pattern (Option 2)

### The 4 Blocked Blocks

**const.ts** (`src/blocks/signal/const.ts`):
- No `loweringPurity` annotation
- Uses `ctx.b.stepSlotWriteStrided()` at lines 132 and 158 for vec2 and color cases
- Scalar cases (float, int, bool, cameraProjection) use `ctx.b.allocSlot()` directly (also impure)
- Does NOT use effects-as-data pattern at all

**expression.ts** (`src/blocks/math/expression.ts`):
- No `loweringPurity` annotation
- Uses `ctx.b.stepSlotWriteStrided()` at lines 175 and 188 for stride > 1 results
- Uses `ctx.b.allocSlot()` directly at lines 84 and 161
- Has varargs handling complexity

**default-source.ts** (`src/blocks/signal/default-source.ts`):
- HAS `loweringPurity: 'pure'` at line 190
- Uses LowerSandbox for macro expansion
- Contains 2 TODO comments about temporary cardinality workaround (lines 49-55, 231-233)
- Does NOT use stepSlotWriteStrided
- Uses `ctx.b.allocSlot()` and `ctx.b.registerSigSlot()` directly (lines 252-257)
- Trips eslint rule `no-block-type-check-in-lower` at lines 244, 299

**external-vec2.ts** (`src/blocks/io/external-vec2.ts`):
- Has `loweringPurity: 'impure'` at line 17 (with TODO comment)
- Uses `ctx.b.stepSlotWriteStrided()` at line 55
- TODO comment at line 51-53 acknowledges violation

### Also Found Missing

**domain-index.ts** (`src/blocks/domain/domain-index.ts`):
- Uses `effects: { slotRequests: [...] }` pattern (pure-style)
- But MISSING `loweringPurity` annotation entirely
- Not mentioned in PURE-LOWERING-TODO.md

### Block Counts
- 83 files with `registerBlock(` (includes test files, .bak files, all.ts, registry.ts)
- 78 files with `loweringPurity` (includes registry.ts type definition)
- Actual production block files without `loweringPurity`: const.ts, expression.ts, domain-index.ts (3 files)
- domain-index.ts appears to be purely an annotation omission (it already uses effects pattern)

### Runtime: construct() in Signal Context

**CRITICAL FINDING**: `ValueExprSignalEvaluator.ts` line 191-193:
```typescript
case 'construct': {
  // Construct is field-extent only in practice (signal vec3 uses slotWriteStrided).
  throw new Error('construct expressions are field-extent, not signal-extent');
}
```

The signal evaluator THROWS for construct expressions. Same for hslToRgb (line 196-198).

**ScheduleExecutor.ts** line 248-250:
```typescript
if (stride !== 1) {
  throw new Error(`evalValue: expected stride=1 for scalar signal slot ${slot}, got stride=${stride}`);
}
```

The evalValue step handler THROWS for stride > 1 on f64 signals.

This means:
1. `construct()` currently only works in field context (ValueExprMaterializer.ts line 96-108)
2. Signal-context multi-component values REQUIRE `slotWriteStrided` step in the current runtime
3. Migrating to construct() for signal-context requires RUNTIME CHANGES to ValueExprSignalEvaluator

### Runtime: slotWriteStrided Step

`ScheduleExecutor.ts` lines 286-312: The `slotWriteStrided` step evaluates each component via `evaluateValueExprSignal()` and writes them contiguously into the f64 buffer. This is the ONLY mechanism for multi-component signal writes.

### Schedule Builder

`schedule-program.ts` lines 671-771: The schedule builder explicitly tracks `stridedWriteSlots` and:
- Skips those slots from evalValue step generation (they'd throw with stride > 1)
- Collects slotWriteStrided steps into a separate list
- Places them in Phase 1 alongside evalValue steps

### Binding Pass

`binding-pass.ts`: Pure binding function handles `stateDecls`, `slotRequests`, `stepRequests`, `eventSlotRequests`. No special handling for construct or strided writes.

### LowerEffects Type

`lowerTypes.ts` line 177-188: `LowerEffects` has:
- stateDecls, stepRequests, slotRequests, eventSlotRequests, evalRequests
- No field for "strided writes" or "construct outputs"

### ESLint Rules

5 custom rules exist in `eslint-rules/`:
- no-block-type-check-in-lower.js
- no-default-source-in-lower.js
- no-defaults-in-lower.js
- no-hot-path-alloc.js
- no-nullish-coalescing-defaults.js

No rule exists for enforcing pure lowering (no stepSlotWriteStrided, no allocSlot in lower()).

ESLint currently shows 46 errors across blocks (mostly `no-defaults-in-lower`).

### Test Results

147 passed, 2 failed (unrelated), 6 skipped.
- `deserialize.test.ts`: Duplicate block name test failure
- `FloatValueRenderer.test.tsx`: Case sensitivity in rendered text

### Design Doc

`design-docs/_new/pure-lowering-blocks/01-macro-lowering.md`:
- Defines pure lowering contract clearly
- Lists forbidden operations: slot allocation, schedule step registration
- Defines purity tagging: `loweringPurity: "pure" | "stateful" | "impure"`
- Mentions ESLint rule for forbidden imports but none exists yet
