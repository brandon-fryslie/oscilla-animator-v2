# Explore Output: U-33 Explicit Slot Declarations

Perfect! Now I have all the information I need. Let me compile a comprehensive answer with file paths and line numbers.

## Summary: Explicit Slot Declarations in ScheduleIR (U-33)

### **1. CURRENT ScheduleIR STRUCTURE**

**Location**: `/Users/bmf/code/oscilla-animator-v2/src/compiler/backend/schedule-program.ts:43-67`

```typescript
export interface ScheduleIR {
  readonly timeModel: TimeModel;
  readonly instances: ReadonlyMap<InstanceId, InstanceDecl>;
  readonly steps: readonly Step[];
  readonly stateSlotCount: number;           // Count of persistent state slots
  readonly stateSlots: readonly StateSlotDef[];  // Legacy format (expanded)
  readonly stateMappings: readonly StateMapping[];  // New: stable IDs for hot-swap
  readonly eventSlotCount: number;
  readonly eventExprCount: number;
}
```

**StateSlotDef** (line 72-74):
```typescript
export interface StateSlotDef {
  readonly initialValue: number;  // Single value per slot
}
```

---

### **2. STATE MANAGEMENT: StateMapping Types**

**Location**: `/Users/bmf/code/oscilla-animator-v2/src/compiler/ir/types.ts:628-665`

**StateMappingScalar** (for single-value state):
```typescript
export interface StateMappingScalar {
  readonly kind: 'scalar';
  readonly stateId: StableStateId;      // "blockId:stateKind" (survives recompilation)
  readonly slotIndex: number;            // Positional index (changes each compile)
  readonly stride: number;               // Floats per element (usually 1)
  readonly initial: readonly number[];   // Initial values (length = stride)
}
```

**StateMappingField** (for per-lane state):
```typescript
export interface StateMappingField {
  readonly kind: 'field';
  readonly stateId: StableStateId;      // Stable semantic identity
  readonly instanceId: string;           // Instance for lane mapping
  readonly slotStart: number;            // Start offset in state array
  readonly laneCount: number;            // Lanes at compile time
  readonly stride: number;               // Floats per lane (>=1)
  readonly initial: readonly number[];   // Initial values template (length = stride)
}
```

**Key Difference**: Field state maps to multiple lanes; scalar maps to single value. StableStateId enables **hot-swap migration** (lane remapping persists identity across recompilation).

---

### **3. SPEC REQUIREMENTS (Topic 04: Compilation)**

**Location**: `/Users/bmf/code/oscilla-animator-v2/design-docs/CANONICAL-oscilla-v2.5-20260109/topics/04-compilation.md:265-348`

The spec defines **Schedule as Data** (Invariant I9):
```typescript
interface Schedule {
  steps: Step[];
  stateSlots: StateSlotDecl[];      // ← Spec refs this
  fieldSlots: FieldSlotDecl[];      // ← Spec refs this
  scalarSlots: ScalarSlotDecl[];    // ← Spec refs this
}
```

**Spec's State Slot Allocation** (line 341-346):
- **Scalar**: `StateMappingScalar { stateId, slotIndex, stride, initial }`
- **Field**: `StateMappingField { stateId, instanceId, slotStart, laneCount, stride, initial }`

**Key Metadata Required**:
- `stateId`: Stable identity surviving recompilation
- `stride`: May exceed payload stride (e.g., filter stores y + dy)
- `laneCount`: For field mapping during hot-swap
- `initial`: Per-lane init values

**NOTE**: Current implementation uses `StateSlotDef[]` (expanded format) but also provides `stateMappings[]` (spec-aligned format with stable IDs).

---

### **4. USAGE PATTERNS**

**ScheduleIR Creation**: 
- **File**: `/Users/bmf/code/oscilla-animator-v2/src/compiler/backend/schedule-program.ts:415-584`
- **Function**: `pass7Schedule(unlinkedIR, validated)`
- Creates ScheduleIR from UnlinkedIRFragments at compile finalization

**State Mapping Population**:
- **File**: `/Users/bmf/code/oscilla-animator-v2/src/compiler/ir/IRBuilderImpl.ts:639-684`
- **Method**: `allocStateSlot(stableId, options?)`
  - Line 660-668: Scalar state registration
  - Line 673-681: Field state registration
  - Pushes to `stateMappings[]` array

**Schedule IR Consumers**:
- `/Users/bmf/code/oscilla-animator-v2/src/compiler/backend/index.ts`: Exports ScheduleIR
- `/Users/bmf/code/oscilla-animator-v2/src/compiler/compile.ts:20`: Imports for CompiledProgramIR
- Runtime state migration uses `stateMappings` for lane remapping

---

### **5. RELATED TYPES**

**StableStateId** (line 611):
```typescript
export type StableStateId = string & { readonly __brand: 'StableStateId' };
export function stableStateId(blockId: string, stateKind: string): StableStateId {
  return `${blockId}:${stateKind}` as StableStateId;
}
```
Format: `"blockId:stateKind"` → survives recompilation (lane index NOT included)

**Scalar vs Field Slots**:
- **Scalar**: Single value per frame (signal cardinality = `one`)
- **Field**: Array of per-lane values (cardinality = `many(instance)`)
- Both stored in contiguous state array; field state allocates `laneCount × stride` slots

---

### **6. CURRENT TYPE SAFETY ISSUES**

| Issue | Location | Problem |
|-------|----------|---------|
| Legacy expansion | schedule-program.ts:553-568 | Converts `StateMapping[]` → `StateSlotDef[]` (loses metadata) |
| No type distinction | Types.ts | Both scalar/field use `readonly number[]` for `initial` (length = stride) |
| Lane remapping docs | Comments only | How lanes remap during hot-swap not formally typed |
| Spec gap | U-33 scope | `ScalarSlotDecl` and `FieldSlotDecl` referenced but not implemented |

---

### **KEY FILES**
- **Schedule Program**: `/Users/bmf/code/oscilla-animator-v2/src/compiler/backend/schedule-program.ts`
- **IR Types**: `/Users/bmf/code/oscilla-animator-v2/src/compiler/ir/types.ts` (lines 628-665)
- **IRBuilder**: `/Users/bmf/code/oscilla-animator-v2/src/compiler/ir/IRBuilderImpl.ts` (lines 639-684)
- **Spec**: `/Users/bmf/code/oscilla-animator-v2/design-docs/CANONICAL-oscilla-v2.5-20260109/topics/04-compilation.md` (lines 265-348)
