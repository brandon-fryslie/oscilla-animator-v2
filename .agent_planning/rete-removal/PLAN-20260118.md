# Rete Removal Plan

**Date:** 2026-01-18
**Status:** PENDING APPROVAL
**Scope:** Complete removal of Rete.js from codebase

---

## Executive Summary

Rete.js is currently implemented but disabled in the UI. React Flow is the active node editor. This plan documents the functional differences and provides a comprehensive removal strategy.

---

## Part 1: Feature Comparison Analysis

### Rete-Only Features (NOT currently in React Flow)

| Feature | Rete Implementation | React Flow Status | Migration Path |
|---------|---------------------|-------------------|----------------|
| **Undo/Redo** | `rete-history-plugin` with full history stack | NOT IMPLEMENTED | Can add via `react-undo-redo` or custom implementation |
| **Auto-Arrange** | `rete-auto-arrange-plugin` with ELK layout algorithm | NOT IMPLEMENTED | Can add via dagre, elkjs, or manual layout |
| **Minimap** | `rete-minimap-plugin` for navigation | `<Controls />` only (zoom controls) | ReactFlow has `<MiniMap />` component (NOT currently used) |
| **Context Menu** | `rete-context-menu-plugin` for node right-click | NOT IMPLEMENTED | Can add via custom context menu or `react-contexify` |
| **Socket Type Compatibility** | `OscillaSocket.isCompatibleWith()` enforces Signal/Field rules | NOT IMPLEMENTED | Need to add connection validation |

### Shared Features (Both implementations have)

| Feature | Notes |
|---------|-------|
| Pan/Zoom | Both have pan and zoom capabilities |
| Node drag | Both support node dragging |
| Connection drawing | Both support connection creation |
| Node deletion | Both handle Delete/Backspace |
| Bidirectional sync | Both sync with PatchStore |
| MobX reaction | Both react to external changes |
| Block positioning | Both use grid layout for initial placement |

### React Flow Features (NOT in Rete)

| Feature | Notes |
|---------|-------|
| Built-in Background grid | `<Background />` component |
| Built-in Controls widget | `<Controls />` component |
| Selection syncing | Node/edge click updates SelectionStore |
| Better TypeScript support | React Flow has superior type definitions |
| Simpler React integration | Uses standard React hooks pattern |

---

## Part 2: Functionality Gap Assessment

### Critical Gaps (Must Address Before Production)

1. **Connection Type Validation** (HIGH PRIORITY)
   - Rete's `OscillaSocket` enforces Signal → Signal, Signal → Field (broadcast), Field → Field
   - React Flow has NO type checking on connections
   - **Impact:** Users can create invalid connections
   - **Recommendation:** Implement in `createConnectHandler` or custom edge validation

2. **Undo/Redo** (MEDIUM PRIORITY)
   - Rete has full undo/redo stack
   - React Flow has none
   - **Impact:** No way to undo mistakes
   - **Recommendation:** Implement via PatchStore action history (not UI-layer)

### Nice-to-Have Gaps (Can Add Later)

3. **Auto-Arrange** (LOW PRIORITY)
   - Rete uses ELK for automatic graph layout
   - React Flow has none
   - **Impact:** Manual node arrangement only
   - **Recommendation:** Add dagre/elkjs integration later

4. **Minimap** (LOW PRIORITY)
   - Rete has minimap for navigation
   - React Flow has `<MiniMap />` but NOT currently used
   - **Impact:** Harder to navigate large graphs
   - **Recommendation:** Simply add `<MiniMap />` component

5. **Context Menu** (LOW PRIORITY)
   - Rete has right-click context menu
   - React Flow has none
   - **Impact:** Must use keyboard for deletion
   - **Recommendation:** Add custom context menu component

---

## Part 3: Removal Plan

### Phase 1: Delete Rete Files

**Files to DELETE:**
```
src/ui/reteEditor/
├── ReteEditor.tsx          (365 lines)
├── ReteEditor.css
├── sync.ts                 (291 lines)
├── nodes.ts                (67 lines)
├── sockets.ts              (105 lines)
└── index.ts                (if exists)

src/ui/dockview/panels/
└── ReteEditorPanel.tsx     (15 lines)
```

**Total lines to delete:** ~850+ lines

### Phase 2: Update Integration Points

**Files to MODIFY:**

1. **`src/ui/dockview/panelRegistry.ts`**
   - Remove `ReteEditorPanel` import
   - Remove `'rete-editor': ReteEditorPanel` from `PANEL_COMPONENTS`
   - Remove commented-out panel definition line 54

2. **`src/ui/dockview/defaultLayout.ts`**
   - Remove `onReteEditorReady` from `LayoutCallbacks` interface
   - Remove rete-editor handling in center panels loop (lines 133-134)
   - Update comment on line 6 (remove "Rete" from list)

3. **`src/ui/dockview/DockviewProvider.tsx`**
   - Remove `onReteEditorReady` prop
   - Remove from `DockviewProviderProps` interface
   - Remove from `createDefaultLayout` call

4. **`src/ui/components/app/App.tsx`**
   - Remove `reteHandleRef` (line 25)
   - Remove `handleReteEditorReady` callback (lines 53-56)
   - Remove rete case from `handleActivePanelChange` (line 65-66)
   - Remove rete case from useEffect (lines 79-80)
   - Remove `editorsReady.rete` state (simplify to just flow)
   - Remove `activeEditorTab` 'rete-editor' type option

5. **`src/ui/editorCommon/EditorHandle.ts`**
   - Change `type: 'rete' | 'reactflow'` to just `type: 'reactflow'`
   - Consider removing the type field entirely (only one editor type)

### Phase 3: Remove Dependencies

**`package.json` - Remove these dependencies:**
```json
"rete": "^2.0.6",
"rete-area-plugin": "^2.1.5",
"rete-auto-arrange-plugin": "^2.0.2",
"rete-connection-plugin": "^2.0.5",
"rete-context-menu-plugin": "^2.0.6",
"rete-history-plugin": "^2.1.1",
"rete-minimap-plugin": "^2.0.3",
"rete-react-plugin": "^2.1.0"
```

**Total packages to remove:** 8 packages

### Phase 4: Simplify EditorHandle Architecture

After Rete removal, the `EditorHandle` abstraction becomes unnecessary complexity:

**Option A: Keep EditorHandle (Minimal Change)**
- Just remove 'rete' type option
- Keeps abstraction for potential future editors

**Option B: Inline ReactFlow Handle (Recommended)**
- Remove `EditorHandle` interface entirely
- Use `ReactFlowEditorHandle` directly
- Eliminates abstraction layer

**Recommendation:** Option A initially, Option B in follow-up cleanup sprint

---

## Part 4: Verification Checklist

### Pre-Removal
- [ ] Verify React Flow editor is working correctly
- [ ] Verify all node operations work (add, delete, connect)
- [ ] Verify bidirectional sync with PatchStore works
- [ ] Document any React Flow bugs to fix after removal

### Post-Removal
- [ ] Build passes with no errors
- [ ] TypeScript type check passes
- [ ] Application starts without console errors
- [ ] React Flow editor still functional
- [ ] No orphaned imports or references
- [ ] `npm ls rete` shows no rete packages
- [ ] Bundle size reduced (rete packages removed)

---

## Part 5: Future Work (Not Blocking)

These features should be implemented in React Flow eventually, but are NOT required for Rete removal:

1. **Connection Type Validation**
   - Create `validateConnection(source, target)` function
   - Use in `onConnect` handler
   - Port socket rules from `sockets.ts`

2. **Undo/Redo**
   - Implement at PatchStore level (not UI)
   - Track action history
   - Support Ctrl+Z / Ctrl+Y

3. **MiniMap**
   - Simply add `<MiniMap />` to ReactFlowEditor
   - One-line change

4. **Auto-Arrange**
   - Add dagre or elkjs dependency
   - Create layout function
   - Add toolbar button

5. **Context Menu**
   - Add right-click handler
   - Show node context menu
   - Include delete option

---

## Summary

| Aspect | Count |
|--------|-------|
| Files to delete | 6 |
| Files to modify | 5 |
| Lines to delete | ~850 |
| NPM packages to remove | 8 |
| Critical gaps to address later | 2 (type validation, undo/redo) |
| Nice-to-have gaps | 3 (minimap, auto-arrange, context menu) |

**Estimated effort:** ~30 minutes for removal, verification, and cleanup
