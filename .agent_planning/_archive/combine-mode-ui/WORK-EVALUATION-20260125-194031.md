# Work Evaluation - 20260125-194031
Scope: combine-mode-ui/data-model-ui
Confidence: FRESH

## Goals Under Evaluation
From SPRINT-20260125-data-model-ui-DOD.md:

**Functional:**
1. [x] Input port inspector shows "Combine Mode" dropdown
2. [x] Dropdown shows only valid modes for port type (color -> last/first/layer, bool -> last/first/or/and, etc.)
3. [x] Selecting a combine mode updates the patch
4. [x] Combine mode persists after page reload
5. [x] Output ports do NOT show combine mode control

**Technical:**
6. [x] `InputPort` interface has `combineMode: CombineMode` field (REQUIRED, not optional)
7. [x] `PatchStore.updateInputPort()` handles combineMode updates
8. [ ] TypeScript compiles without new errors related to combineMode

**Additional (user-requested):**
9. [x] Edge.enabled: boolean (was optional) - now REQUIRED
10. [x] Edge.sortKey: number (was optional) - now REQUIRED
11. [x] Edge.role: EdgeRole (was optional) - now REQUIRED

## Previous Evaluation Reference
No previous evaluation found for this sprint.

## Persistent Check Results
| Check | Status | Output Summary |
|-------|--------|----------------|
| `just typecheck` | FAIL | Multiple errors (pre-existing + new from required fields) |
| `just test` | FAIL | 39 failed / 1223 passed (mostly pre-existing failures) |
| `just smoke` | NOT FOUND | - |

### TypeScript Errors Related to CombineMode

The following errors are directly caused by making `combineMode` REQUIRED:

1. **`src/stores/__tests__/PatchStore.test.ts:284`**: Test constructs manual patches without required fields (enabled, sortKey, role on edges)
2. **`src/compiler/passes-v2/__tests__/...`**: Various test files construct InputPort objects without combineMode

These are **test maintenance issues**, not implementation bugs. The tests need to be updated to include the new required fields.

## Code Review Findings

### Data Model (Patch.ts)
- `InputPort.combineMode: CombineMode` - REQUIRED (line 69)
- `Edge.enabled: boolean` - REQUIRED (line 129)
- `Edge.sortKey: number` - REQUIRED (line 132)
- `Edge.role: EdgeRole` - REQUIRED (line 135)

### UI Implementation (BlockInspector.tsx)
- Combine Mode dropdown appears in `PortInspectorStandalone` component (lines 389-407)
- Only shown for input ports (`isInput && portDef.type`)
- Uses `getValidCombineModes()` to filter options based on payload type (lines 260-268)
- Calls `patchStore.updateInputPortCombineMode()` on change

### Store Implementation (PatchStore.ts)
- `updateInputPortCombineMode()` method implemented (lines 382-384)
- Delegates to `updateInputPort()` which handles the mutation correctly
- GraphCommitted event emitted to trigger recompilation

### Persistence (PatchPersistence.ts)
- Serialization captures inputPorts including combineMode (line 50)
- Deserialization normalizes combineMode with 'last' fallback (lines 69-72)
- Backwards-compatible with old patches

### Context Menu (PortContextMenu.tsx)
- Combine mode cycling feature available in port context menu
- Uses same validation logic for mode filtering

## Manual Runtime Testing

**Unable to perform browser verification** - Chrome DevTools MCP not available in this evaluation session. The user should verify the following manually:

### Verification Checklist
1. [ ] Open app at localhost:5174
2. [ ] Create or select a block with inputs
3. [ ] Click an input port
4. [ ] Verify "Combine Mode" dropdown appears in port inspector
5. [ ] For float port: verify modes include sum, average, max, min, mul, last, first
6. [ ] For color port: verify modes limited to last, first, layer
7. [ ] For bool port: verify modes limited to last, first, or, and
8. [ ] Change the combine mode
9. [ ] Refresh the page
10. [ ] Verify the selection persisted
11. [ ] Click an output port
12. [ ] Verify NO combine mode dropdown appears

## Assessment

### Working (Code Review Verified)
- InputPort.combineMode is REQUIRED with 'last' default on creation
- UI dropdown implemented with proper filtering by payload type
- PatchStore mutation API implemented
- Serialization/deserialization handles combineMode
- Backwards compatibility with 'last' fallback for old patches
- Output ports correctly excluded from combine mode UI

### Not Working
- **TypeScript Compilation**: Tests need updating for new required fields

### Ambiguities Found
| Decision | What Was Assumed | Should Have Asked | Impact |
|----------|------------------|-------------------|--------|
| Default value 'last' | 'last' is always safe | Is 'last' the spec-defined default? | Low - matches spec behavior |

## Missing Checks

### Tests That Should Exist
1. **`src/stores/__tests__/PatchStore.test.ts`**: Add test for `updateInputPortCombineMode()`
2. **`src/ui/components/__tests__/BlockInspector.test.tsx`**: Test combine mode dropdown rendering and validation
3. **`src/services/__tests__/PatchPersistence.test.ts`**: Test combineMode serialization/deserialization round-trip

### Test Files Needing Updates
The following tests construct manual patches and need required fields added:
- `src/stores/__tests__/PatchStore.test.ts` (line 284)
- Various compiler pass tests constructing InputPort objects

## Verdict: INCOMPLETE

The implementation is functionally complete based on code review, but TypeScript compilation fails due to test files not being updated for the new required fields on `Edge` (enabled, sortKey, role) and `InputPort` (combineMode).

## What Needs to Change

1. **`src/stores/__tests__/PatchStore.test.ts:276-281`**: Add required Edge fields (enabled, sortKey, role) to test patches
2. **All test files constructing InputPort objects**: Add `combineMode: 'last'` to InputPort construction
3. **Manual verification needed**: Browser testing to confirm UI behavior

## Next Steps

1. Fix test files to include required fields:
   - Edge: `{ ...edge, enabled: true, sortKey: 0, role: { kind: 'user', meta: {} } }`
   - InputPort: `{ id: 'portId', combineMode: 'last' }`
2. Run `just typecheck` to verify all type errors resolved
3. Run `just test` to verify tests pass
4. Perform manual browser verification with checklist above

## Notes

The implementation follows the spec correctly:
- Combine modes are validated against payload types
- 'last' is the default (consistent with spec behavior)
- Persistence handles backwards compatibility gracefully
- UI correctly shows/hides based on port direction (input vs output)

The pre-existing test failures (39 tests) appear unrelated to this feature - they involve continuity integration, multicomponent signals, and connection validation tests.
