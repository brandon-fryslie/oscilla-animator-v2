# Evaluation: Kernel Refactor Phase 1

**Topic:** Kernel Layer Semantics and Naming
**Generated:** 2026-01-21T03:55:17Z
**Verdict:** CONTINUE

## Summary

Phase 1 of the kernel roadmap focuses on locking semantics and naming conventions. The goal is to eliminate ambiguity about what lives where and what it means across the opcode, signal kernel, field kernel, and materializer layers.

## Current State Analysis

### 1. Coordinate Semantics (Documentation)

**Reference Documents:**
- `.agent_planning/_future/1-local-space.md` (206 lines)
- `.agent_planning/_future/2-local-space-end-to-end-spec.md` (216 lines)
- `.agent_planning/_future/3-local-space-spec-deeper.md` (586 lines)

**Status:** Documents exist but definitions not consolidated in code/headers.

**Canonical Definitions (from docs):**
- **Local space:** Geometry/control points, centered at (0,0), |p|≈O(1)
- **World space:** Instance placement, normalized [0,1]
- **size:** Isotropic scalar scale in world units
- **scale2:** Optional anisotropic vec2 scale, combined as S_effective

### 2. Layer Responsibilities (Current Code State)

| File | Lines | Current State | Issues |
|------|-------|---------------|--------|
| `src/runtime/OpcodeInterpreter.ts` | 1-113 | Has good header comment (lines 1-12) | Missing: floor, ceil, round, fract, sqrt, exp, log, sign, pow opcodes |
| `src/runtime/SignalEvaluator.ts` | 1-489 | Has header comment (lines 1-14) | Contains generic math (lines 258-377) that should be opcodes; uses `sin` not `oscSin` |
| `src/runtime/Materializer.ts` | 1-905 | Has minimal header (lines 1-6) | Contains scalar math kernels (lines 438-477) that should be opcodes |

### 3. Misleading Kernel Names

**Signal Kernels with Generic Names (SignalEvaluator.ts):**
| Line | Current Name | Should Be | Reason |
|------|--------------|-----------|--------|
| 207-213 | `sin` | `oscSin` | Phase-based oscillator, not radian math |
| 215-221 | `cos` | `oscCos` | Phase-based oscillator, not radian math |
| 223-229 | `tan` | `oscTan` | Phase-based oscillator, not radian math |

**Note:** Opcode sin/cos/tan (OpcodeInterpreter.ts lines 42-54) correctly operate on radians.

### 4. Generic Math Misplaced as Kernels

**SignalEvaluator.ts - Should Move to Opcodes:**
| Lines | Kernel | Should Be | Notes |
|-------|--------|-----------|-------|
| 260-265 | `abs` | Already exists as opcode | Remove from kernels |
| 267-272 | `floor` | Add as opcode | Pure math |
| 274-279 | `ceil` | Add as opcode | Pure math |
| 281-286 | `round` | Add as opcode | Pure math |
| 288-295 | `fract` | Add as opcode | Pure math |
| 297-302 | `sqrt` | Add as opcode | Pure math |
| 304-309 | `exp` | Add as opcode | Pure math |
| 311-316 | `log` | Add as opcode | Pure math |
| 318-323 | `pow` | Add as opcode | Binary math |
| 325-330 | `min` | Already exists as opcode (variadic) | Remove fixed-arity version |
| 332-337 | `max` | Already exists as opcode (variadic) | Remove fixed-arity version |
| 339-344 | `clamp` | Already exists as opcode | Remove from kernels |
| 346-352 | `mix` | Keep as kernel OR add as opcode `lerp` | Already have `lerp` opcode |
| 375-378 | `sign` | Add as opcode | Pure math |

**Materializer.ts - Should Move to Opcodes:**
| Lines | Kernel | Should Be | Notes |
|-------|--------|-----------|-------|
| 441-444 | `sqrt` | Use opcode | Pure math |
| 445-448 | `floor` | Use opcode | Pure math |
| 449-452 | `ceil` | Use opcode | Pure math |
| 453-456 | `round` | Use opcode | Pure math |

### 5. Missing Contract Comments

**Files needing explicit layer contract comments:**
| File | Current Header | Needed |
|------|----------------|--------|
| OpcodeInterpreter.ts | Good (lines 1-12) | Add arity table, list all opcodes |
| SignalEvaluator.ts | Partial (lines 1-14) | Add clear "signal kernels only" contract |
| Materializer.ts | Minimal (lines 1-6) | Add full orchestration + field kernel contract |

## Dependencies

None - Phase 1 is documentation and naming only.

## Risks

| Risk | Mitigation |
|------|------------|
| Breaking existing patches using `sin` kernel | Keep backward compat shim temporarily; deprecate in logs |
| IR references to old kernel names | Update IR builder simultaneously |

## Ambiguities (None Blocking)

All semantics are clearly defined in the roadmap documents. No blocking questions.

## Recommended Sprint Breakdown

| Sprint | Confidence | Focus |
|--------|------------|-------|
| Sprint 1: Add missing opcodes | HIGH | Add floor/ceil/round/fract/sqrt/exp/log/sign/pow to OpcodeInterpreter |
| Sprint 2: Rename signal oscillators | HIGH | sin→oscSin, cos→oscCos, tan→oscTan in SignalEvaluator |
| Sprint 3: Remove duplicate math from kernels | HIGH | Remove abs/min/max/clamp/mix from SignalEvaluator |
| Sprint 4: Remove map kernels from Materializer | HIGH | Route sqrt/floor/ceil/round through opcodes |
| Sprint 5: Add layer contract comments | HIGH | Add explicit contract headers to all 3 files |
