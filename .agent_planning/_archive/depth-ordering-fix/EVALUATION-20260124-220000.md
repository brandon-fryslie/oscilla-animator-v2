# Evaluation: Depth Ordering Fix (from Gap Analysis C-24/C-25/C-26)

Generated: 2026-01-24T22:00:00Z
Topic: depth-ordering-fix
Source: `.agent_planning/gap-analysis/critical/topic-18-camera-projection.md`

## Verdict: CONTINUE

No blockers. All three items are in the same file (`src/runtime/RenderAssembler.ts`) and the same function (`depthSortAndCompact`). The spec is unambiguous. Tests exist but assert the wrong behavior.

## Context

The gap analysis (full-spectrum audit, 2026-01-24) identified three P1 CRITICAL items in the camera/projection topic:

| ID | Issue | Spec Requirement | Current Implementation |
|----|-------|------------------|----------------------|
| C-24 | Sort direction inverted | Far-to-near (descending depth, painter's algorithm) | Near-to-far (ascending `da - db`) |
| C-25 | Per-frame allocations in hot loop | Preallocated Uint32Array reused across frames | `new number[]` + `new Float32Array(...)` every frame |
| C-26 | Missing fast-path monotone check | Two-phase: check if already ordered, skip sort if so | Sort always runs unconditionally |

## Analysis

### C-24: Sort Direction
- **Location:** `depthSortAndCompact()` line 137-141
- **Current:** `return da - db` (ascending = near first)
- **Required:** `return db - da` (descending = far first, painter's algorithm)
- **Impact:** Visual correctness — near objects drawn first then overwritten by far objects (wrong)
- **Tests:** Level 7 tests assert ascending order — they are testing the bug
- **Fix complexity:** LOW — one comparator change + test updates

### C-25: Per-Frame Allocations
- **Location:** `depthSortAndCompact()` lines 129-149 and `projectInstances()` lines 221-224
- **Current:** Creates `number[]`, multiple `Float32Array` every invocation
- **Required:** Preallocated `Uint32Array` permutation buffer, reused across frames
- **Impact:** GC pressure in the 60fps render loop
- **Fix complexity:** MEDIUM — requires a buffer cache/pool strategy

### C-26: Fast-Path Monotone Check
- **Location:** Before sort in `depthSortAndCompact()`
- **Current:** Sort always runs
- **Required:** Check if depth is already monotone decreasing; if so, skip sort
- **Impact:** Performance for common case (all instances at z=0, flat layouts)
- **Fix complexity:** LOW — linear scan before sort

## Dependency Analysis

- C-24 is independent (sort direction)
- C-25 is independent (allocation strategy)
- C-26 depends on C-24 (monotone check direction must match sort direction)
- All are in the same function, so they compose naturally into one sprint

## Risk Assessment

- **Low risk:** All changes are in one function with clear spec language
- **Test coverage:** Tests exist but assert wrong behavior — must update simultaneously
- **Downstream impact:** Renderers iterate ops in order (`for (const op of frame.ops)`) so sort order directly controls visual output. No other sort/reorder exists downstream.
