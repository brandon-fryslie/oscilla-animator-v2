# Work Evaluation - 2026-01-27T12:38:49Z

Scope: work/deprecated-removal-sprint (Final Validation)
Confidence: FRESH

## Goals Under Evaluation

From SPRINT-20260127-120000-deprecated-removal-DOD.md:

### Code Quality
1. [x] No `@deprecated` comments remain in production code
2. [x] No TypeScript errors or warnings
3. [ ] All tests pass (`npm run test`) - **9 FAILURES (pre-existing, unrelated to this sprint)**
4. [x] Build succeeds (`npm run build`)

### Specific Removals Verified
5. [x] `NumericUnit` type alias removed (only a comment reference remains)
6. [x] `PAYLOAD_STRIDE` constant removed
7. [x] `getStateSlots()` method removed  
8. [ ] `CompileError.kind` field removed - **INCOMPLETE** (see analysis)
9. [x] `CompileError.location` field - was never present
10. [x] `CompileError.severity` field - was never present
11. [x] `createRuntimeState()` - RETAINED as convenience function (documented decision)
12. [ ] `TypeEnv` type alias removed - **NOT REMOVED** (but internal-only, not exported)

### Migration Verification
13. [ ] diagnosticConversion.ts uses `error.code` - **STILL USES `error.kind`**
14. [x] pass7-schedule.ts uses `getStateMappings()`
15. [x] All typecheck() calls use TypeCheckContext

## Previous Evaluation Reference

Last evaluation: WORK-EVALUATION-20260127-052809.md
| Previous Issue | Status Now |
|----------------|------------|
| TypeScript compilation fails (28 errors) | [VERIFIED-FIXED] - Commits c660ec8, 1fab8f6 |
| 100 tests fail (createRuntimeState) | [VERIFIED-FIXED] - createRuntimeState restored |
| Build fails | [VERIFIED-FIXED] - Build succeeds |
| diagnosticConversion uses error.kind | [STILL-BROKEN] - Not addressed |
| TypeEnv still exists | [STILL-PRESENT] - But internal-only |

## Persistent Check Results

| Check | Status | Output Summary |
|-------|--------|----------------|
| `grep @deprecated` | PASS | No @deprecated found in src/ |
| `npm run typecheck` | PASS | Clean compilation |
| `npm run test` | PARTIAL | 9 failures (1641 pass) - pre-existing issues |
| `npm run build` | PASS | Built in 12.34s |

## Test Failure Analysis

The 9 test failures are **PRE-EXISTING** and **UNRELATED** to the deprecated cleanup sprint:

### canonical-name.test.ts (4 failures)
Tests expect `validateDisplayNameUniqueness()` to be called after Patch is built, but `PatchBuilder.addBlock()` now validates during construction and throws immediately on collision. Tests were written for the old API.

**Root cause**: DisplayName feature changes (commits e547d71, 2871108, c0859ba) from BEFORE this sprint.

### addressing.test.ts (5 failures)
Tests expect:
- Auto-generated displayName format: `^Const \d+$` but actual is `Constant 1`
- Fallback to blockId when displayName is null, but displayName is always auto-generated now

**Root cause**: DisplayName auto-generation feature changed expected behavior.

These failures exist because the displayName feature tests were not fully updated.

## CompileError Analysis

There are **TWO** CompileError types in the codebase:

1. **`src/compiler/types.ts`** (Modern - uses `code`)
   ```typescript
   interface CompileError {
     readonly code: CompileErrorCode | string;
     readonly message: string;
     readonly where?: CompileErrorWhere;
   }
   ```

2. **`src/compiler/compile.ts`** (Legacy - uses `kind`)
   ```typescript
   interface CompileError {
     readonly kind: string;
     readonly message: string;
     readonly blockId?: string;
   }
   ```

The `diagnosticConversion.ts` imports from `compile.ts` and uses the legacy `error.kind` field.

**Decision needed**: Unify these types or update diagnosticConversion to work with both.

## TypeEnv Analysis

`TypeEnv` exists in `src/expr/typecheck.ts:42` but:
- Is **NOT exported** from `src/expr/index.ts`
- Is **NOT imported** by any external module
- Is used only internally within `TypeCheckContext.inputs`

This is an **internal implementation detail**, not a public API surface issue. The DoD may have been overly strict in requiring its removal since it's not a deprecated public export.

## createRuntimeState Decision

Per commit 7629637 ("Clarify createRuntimeState is a convenience, not deprecated"):
- Function is RETAINED as a convenience helper
- Tests use it extensively (correctly)
- This is a documented deviation from the original DoD

This is acceptable and the DoD checkbox should be marked as "retained with justification."

## Evidence

### No @deprecated in production code
```bash
$ grep -r "@deprecated" src/ --include="*.ts"
(no output - correctly removed)
```

### TypeScript compiles cleanly
```bash
$ npm run typecheck
> tsc -b
(no errors)
```

### Build succeeds
```
✓ 13362 modules transformed
✓ built in 12.34s
```

### diagnosticConversion.ts still uses error.kind
```typescript
// Line 109:
const code = ERROR_KIND_TO_CODE[error.kind] || 'E_UNKNOWN_BLOCK_TYPE';
// Line 115:
const title = formatTitle(error.kind);
```

## Assessment

### Fully Completed
- NumericUnit type alias definition removed
- PAYLOAD_STRIDE constant removed from both locations
- getStateSlots() method removed from IRBuilder
- isTypeEnv() function removed
- pass7-schedule.ts uses getStateMappings()
- TypeScript compiles cleanly
- Build succeeds
- createRuntimeState retained (documented decision)

### Partially Complete / Documented Deviations
- TypeEnv: Still exists but internal-only (not a public API concern)
- CompileError.kind: Still used in legacy compile.ts interface (migration incomplete)
- diagnosticConversion.ts: Still uses error.kind (needs migration or dual-interface support)

### Not Related to This Sprint
- 9 test failures from displayName feature work

## Missing Checks

1. **diagnosticConversion.ts migration**: Either:
   - Option A: Update to use `error.code` and import from `types.ts`
   - Option B: Unify CompileError types across the codebase
   - Option C: Add adapter logic to handle both interfaces

2. **Pre-existing test failures**: The displayName tests need to be fixed separately:
   - `src/core/__tests__/canonical-name.test.ts` - Update for throw-on-collision behavior
   - `src/graph/__tests__/addressing.test.ts` - Update expected displayName format

## Verdict: INCOMPLETE

**Rationale**: The core deprecated items are removed and the codebase compiles/builds successfully. However:

1. **Critical**: `diagnosticConversion.ts` still uses `error.kind` instead of `error.code`
2. **Medium**: Two CompileError definitions exist (in `types.ts` and `compile.ts`)

The 9 test failures are pre-existing issues from the displayName feature and should be addressed in a separate sprint.

## What Needs to Change

### Required for Sprint Completion:
1. `/Users/bmf/code/oscilla-animator-v2/src/compiler/diagnosticConversion.ts:15,109,115,119` - Migrate from `compile.ts` CompileError (with `kind`) to `types.ts` CompileError (with `code`), OR unify the types

### Separate Sprint (Not Required):
2. `/Users/bmf/code/oscilla-animator-v2/src/core/__tests__/canonical-name.test.ts:202-274` - Fix tests for throw-on-collision behavior
3. `/Users/bmf/code/oscilla-animator-v2/src/graph/__tests__/addressing.test.ts:50,112,152,412,447` - Fix tests for new displayName format

## Recommended Path Forward

**Option A (Minimal - Complete Sprint)**:
Update `diagnosticConversion.ts` to:
1. Import CompileError from `./types` instead of `./compile`
2. Use `error.code` instead of `error.kind`
3. Update `ERROR_KIND_TO_CODE` to map from `CompileErrorCode` values

**Option B (Complete - Unify Types)**:
1. Remove CompileError from `compile.ts`
2. Use single CompileError type from `types.ts` everywhere
3. Update all error creation sites to use `code` instead of `kind`

Option B is cleaner but larger scope. Option A is sufficient for DoD completion.
