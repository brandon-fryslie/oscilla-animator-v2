# Exploration Output: oscilla-animator-v2-aql
Timestamp: 2026-01-25 06:26:08
Agent: project-evaluator (self-directed exploration)

## Task Context
Port wiring error in patches after block registration changes. Patches fail to compile with "Port does not exist" errors.

## Files Examined

### 1. Recent Commits
```
4243c1d feat: genericize field operation blocks (Sin, Cos, Mod) and remove redundant blocks
941d47a perf: preallocate depth-sort permutation buffers
3fb8e31 somehow it's rendering again
784c4bd fix type unification
```

Commit 4243c1d changed:
- Removed blocks: FieldAdd, FieldMultiply, FieldScale, FieldSin, FieldCos
- Renamed: FieldFromDomainId -> FromDomainId
- Made Sin, Cos, Mod cardinality-generic (work with both signals and fields)

### 2. localStorage Persistence (src/main.ts)
- Storage key: `oscilla-v2-patch-v9` (line 558)
- Comment says: "Bumped to force fresh load - Z wave animation"
- Serialization stores block types and port IDs in JSON

```typescript
interface SerializedPatch {
  blocks: Array<{
    id: string;
    type: string;  // <-- OLD block types stored here
    params: Record<string, unknown>;
    ...
  }>;
  edges: Array<{
    from: { blockId: string; slotId: string };  // <-- OLD port IDs stored here
    to: { blockId: string; slotId: string };
    ...
  }>;
}
```

### 3. Port Validation (src/graph/passes/pass2-adapters.ts)
Port validation happens during normalization Pass 2:
```typescript
function getPortType(blockType: string, portId: string, direction: 'input' | 'output'): CanonicalType | null {
  const blockDef = getBlockDefinition(blockType);
  if (!blockDef) return null;
  const ports = direction === 'input' ? blockDef.inputs : blockDef.outputs;
  const port = ports[portId];
  return port?.type ?? null;
}
```

If port not found, returns null and pushes UnknownPort error:
```typescript
if (!fromType) {
  errors.push({
    kind: 'UnknownPort',
    blockId: fromBlock.id,
    portId: edge.from.slotId,
    direction: 'output',
  });
}
```

### 4. Block Registry (src/blocks/registry.ts)
Registration is strict - throws on duplicate:
```typescript
export function registerBlock(def: BlockDef): void {
  if (registry.has(def.type)) {
    throw new Error(`Block type already registered: ${def.type}`);
  }
  // ...
  registry.set(def.type, def);
}
```

### 5. Current Test Status
```
Test Files  8 failed | 80 passed (88)
Tests  13 failed | 1298 passed | 3 skipped (1314)
```

TypeScript errors present in:
- src/blocks/adapter-blocks.ts (ValueRefPacked type issues)
- src/blocks/__tests__/expression-blocks.test.ts
- src/blocks/__tests__/event-blocks.test.ts

### 6. Block Changes Analysis (git diff)
**Removed blocks (no longer registered):**
- FieldFromDomainId -> renamed to FromDomainId
- FieldAdd -> use Add instead
- FieldMultiply -> use Multiply instead
- FieldScale -> removed entirely
- FieldSin -> now just Sin
- FieldCos -> now just Cos

**Port changes:**
- Sin, Cos, Mod: port signature unchanged (input -> result)
- FromDomainId: port signature unchanged (domain -> id01)

### 7. Storage Key Version
The storage key was bumped to v9, which SHOULD force a fresh load. However:
- Users who saved patches after the bump but before block changes would still have stale data
- The version bump happened for "Z wave animation", not for block refactoring

### 8. Migration/Recovery Mechanisms
**Found:**
- `clearStorageAndReload()` exposed globally on window
- Storage key versioning (currently v9)

**Not Found:**
- No automatic migration from old block types to new
- No port name migration
- No graceful degradation for unknown blocks
- No schema versioning in the serialized data

### 9. Compilation Error Path
```
compile() -> normalize() -> pass2Adapters() -> analyzeAdapters() -> getPortType()
                                                                    |
                                                                    v
                                                              UnknownPort error
```

Error message format:
```typescript
message: `Port '${e.portId}' does not exist on block '${e.blockId}' (${e.direction})`,
```

## Key Observations

1. **Root cause confirmed**: Old patches in localStorage contain block types like `FieldSin`, `FieldAdd` that no longer exist, AND port names that may differ.

2. **Storage key version is stale**: v9 was bumped for "Z wave animation" - the block genericization commit did NOT bump the version.

3. **No migration path**: The system has no mechanism to:
   - Map old block types to new equivalents
   - Map old port names to new ones
   - Gracefully handle unknown blocks

4. **TypeScript errors exist**: Unrelated to this task but indicate incomplete prior work on ValueRefPacked type changes.
