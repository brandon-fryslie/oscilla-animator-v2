# Evaluation: oscilla-animator-v2-aql
Timestamp: 2026-01-25-062608
Git Commit: 4243c1d

## Executive Summary
Overall: 70% understood | Critical issues: 2 | Tests reliable: Partially (8 failing suites)

The bug is **fully diagnosed**. localStorage holds patch data with old block types (FieldSin, FieldAdd, etc.) that were removed/renamed in commit 4243c1d. The storage key was NOT bumped when blocks changed, so stale data persists. Fix is clear: bump STORAGE_KEY version to v10.

## Runtime Check Results
| Check | Status | Output |
|-------|--------|--------|
| TypeScript | FAIL | 11+ errors in adapter-blocks.ts, test files |
| Tests | FAIL | 8 failed suites, 13 failed tests |
| Block registration | PASS | No duplicates detected |
| Storage key version | STALE | v9 (should be v10 after block changes) |

## Missing Checks
1. **Migration test**: No test verifies old patch format loads correctly after block changes
2. **Storage version invariant**: No CI check that storage key bumps when blocks change
3. **Block rename tracking**: No mechanism tracks block type renames for migration

## Findings

### localStorage Persistence
**Status**: PARTIAL (storage works, migration broken)
**Evidence**:
- `src/main.ts:558` - STORAGE_KEY = 'oscilla-v2-patch-v9'
- Comment says "Bumped to force fresh load - Z wave animation" - NOT for block changes
- `src/main.ts:567-586` - SerializedPatch stores raw block.type strings

**Issues**:
1. Version v9 was bumped for unrelated "Z wave animation" feature
2. Block genericization commit (4243c1d) did NOT bump to v10
3. Old patches contain removed block types: FieldAdd, FieldMultiply, FieldScale, FieldSin, FieldCos, FieldFromDomainId

### Port Validation
**Status**: COMPLETE (working as designed)
**Evidence**:
- `src/graph/passes/pass2-adapters.ts:96-107` - getPortType()
- `src/graph/passes/pass2-adapters.ts:132-149` - UnknownPort error generation

**Issues**: None - validation correctly rejects unknown ports. The problem is upstream (stale data).

### Block Registration
**Status**: COMPLETE
**Evidence**:
- `src/blocks/registry.ts:331-346` - Strict registration with duplicate check
- `src/blocks/field-operations-blocks.ts` - Current block definitions verified

**Issues**: None - blocks correctly renamed/removed.

### TypeScript Compilation
**Status**: BROKEN (unrelated to this task)
**Evidence**:
- `src/blocks/adapter-blocks.ts:55,86,122,155,194,227` - ValueRefPacked missing type/stride
- Multiple test files have similar issues

**Issues**: ValueRefPacked type contract changed, blocks not updated. This is a SEPARATE bug.

## Ambiguities Found
| Area | Question | How LLM Guessed | Impact |
|------|----------|-----------------|--------|
| Storage versioning | When should STORAGE_KEY increment? | Not documented | Stale data persists after block changes |
| Block migrations | Should old block types map to new ones? | No migration | Users must clear storage manually |
| Port renames | How to handle port ID changes? | No handling | Edges to renamed ports break |

## Root Cause Analysis

**The Bug**: Commit 4243c1d changed block definitions:
- Removed: FieldAdd, FieldMultiply, FieldScale
- Renamed: FieldFromDomainId -> FromDomainId, FieldSin -> Sin, FieldCos -> Cos

**Why It Manifests**:
1. Old patches serialized to localStorage contain these old block types
2. STORAGE_KEY was not bumped (still v9)
3. On load, deserializePatch() creates blocks with old types
4. Normalization pass2Adapters validates ports against registry
5. Registry doesn't have old block types -> getBlockDefinition returns undefined
6. getPortType returns null -> UnknownPort error

## Fix Options

### Option A: Bump Storage Key (Recommended - Minimal)
```typescript
// src/main.ts:558
const STORAGE_KEY = 'oscilla-v2-patch-v10'; // Was v9
```
**Pros**: Simple, forces fresh load, matches existing pattern
**Cons**: Users lose saved patches

### Option B: Add Block Migration (Complete)
```typescript
const BLOCK_MIGRATIONS: Record<string, string> = {
  'FieldFromDomainId': 'FromDomainId',
  'FieldAdd': 'Add',
  'FieldMultiply': 'Multiply',
  'FieldSin': 'Sin',
  'FieldCos': 'Cos',
  // FieldScale has no equivalent - must be removed
};

function deserializePatch(json: string): { patch: Patch; presetIndex: number } | null {
  // ... existing code ...
  for (const b of data.blocks) {
    const migratedType = BLOCK_MIGRATIONS[b.type] ?? b.type;
    blocks.set(b.id as BlockId, {
      ...b,
      type: migratedType,
      // ...
    });
  }
}
```
**Pros**: Preserves user patches
**Cons**: More complex, FieldScale has no migration target

### Option C: Graceful Degradation
Log warning and skip unknown blocks instead of failing.
**Pros**: Partial patch loads
**Cons**: Silent data loss, confusing UX

## Recommendations

1. **IMMEDIATE**: Bump STORAGE_KEY to v10 (Option A)
2. **IMMEDIATE**: Fix TypeScript errors in adapter-blocks.ts (separate task)
3. **FUTURE**: Add storage schema versioning with migration support
4. **FUTURE**: Add CI check that storage key bumps when blocks change

## Verdict
- [x] CONTINUE - Root cause clear, fix is straightforward

**Specific Next Actions**:
1. Change `STORAGE_KEY = 'oscilla-v2-patch-v10'` in src/main.ts:558
2. Optionally add migration map for graceful upgrade (Option B)
3. Document storage versioning policy
