# Plan: Add combine_* signal kernels

## Problem

Runtime error: `Unknown signal kernel: combine_last`

The `IRBuilderImpl.sigCombine()` method creates signal expressions with kernel names like `combine_last`, `combine_sum`, `combine_average`, `combine_max`, `combine_min`, but `SignalEvaluator.applySignalKernel()` has no handlers for these kernels.

## Root Cause Analysis

**src/compiler/ir/IRBuilderImpl.ts:173:**
```typescript
const fn: PureFn = { kind: 'kernel', name: `combine_${mode}` };
```

This generates kernels: `combine_sum`, `combine_average`, `combine_max`, `combine_min`, `combine_last`

**src/runtime/SignalEvaluator.ts:282-467:**
The `applySignalKernel` function has no cases for any `combine_*` kernels - falls through to default throwing "Unknown signal kernel".

## Solution

Add combine kernel handlers to `applySignalKernel()` in SignalEvaluator.ts.

### Implementation

Add cases in `applySignalKernel()` before the default case:

```typescript
// === COMBINE KERNELS (multi-input signal combination) ===

case 'combine_sum': {
  return values.reduce((a, b) => a + b, 0);
}

case 'combine_average': {
  if (values.length === 0) return 0;
  return values.reduce((a, b) => a + b, 0) / values.length;
}

case 'combine_max': {
  if (values.length === 0) return -Infinity;
  return Math.max(...values);
}

case 'combine_min': {
  if (values.length === 0) return Infinity;
  return Math.min(...values);
}

case 'combine_last': {
  if (values.length === 0) return 0;
  return values[values.length - 1];
}
```

### Verification

1. The runtime error `Unknown signal kernel: combine_last` should no longer occur
2. Multi-input signal combining (when multiple writers target the same port) should work correctly
3. Each combine mode behaves as expected:
   - `sum`: returns additive combination
   - `average`: returns arithmetic mean
   - `max`: returns maximum value
   - `min`: returns minimum value
   - `last`: returns last value (order-dependent)

## Files to Modify

1. `src/runtime/SignalEvaluator.ts` - Add combine kernel cases

## Edge Cases

- Empty inputs array: Handle gracefully (return identity values)
- Single input: Should work (sum of 1 = that value, max of 1 = that value, etc.)

## Testing

After implementation, verify:
1. App loads without `Unknown signal kernel: combine_last` errors
2. Patches with multi-writer scenarios render correctly
