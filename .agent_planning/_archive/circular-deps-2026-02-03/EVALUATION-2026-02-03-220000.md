# Evaluation: Infinite Loop in patch-dsl Parser

**Date**: 2026-02-03
**Verdict**: CONTINUE — root cause confirmed, fix is straightforward

## Root Cause: CONFIRMED

The infinite loop is in `src/patch-dsl/parser.ts`. The `parseDocument()` while loop (line 58) calls `parseBlock()` repeatedly until EOF. When `parseBlock()` encounters a non-IDENT token (like `RBRACKET`), it calls `recoverToBlockEnd()` (line 86) and returns null.

**The bug**: `recoverToBlockEnd()` (line 395) initializes `braceDepth = 1` and `bracketDepth = 0`. When the current token is `RBRACKET`, it decrements `bracketDepth` to -1 and hits `break` (line 416) **without advancing**. Control returns to `parseDocument()`, which calls `skipNewlines()` (no-op since current token is RBRACKET), checks `!isAtEnd()` (still true), and loops back — calling `parseBlock()` again on the same token. Each iteration pushes a new error into `this.errors`, growing the array until OOM.

**Exact token trace for `'invalid syntax { ] }'`:**
1. Lexer produces: `IDENT("invalid"), IDENT("syntax"), LBRACE, RBRACKET, RBRACE, EOF`
2. First `parseBlock()`: consumes "invalid", tries to find LBRACE, fails at "syntax", calls `recoverToBlockEnd()` which scans forward, hits RBRACKET at depth (brace=1, bracket=0), decrements bracket to -1, breaks. Cursor is now at RBRACKET (index 3).
3. Second `parseBlock()`: token is RBRACKET, not IDENT. Error. Calls `recoverToBlockEnd()`. Same thing — bracket goes to -1, break. Cursor still at RBRACKET.
4. Infinite loop. Each iteration pushes one error. Array grows to 169M+ elements → V8 crashes.

## Why the threshold sensitivity

The handoff doc notes that shortening metadata strings changes the crash behavior. This is because:
- The loop produces ~169M error objects (each containing error message strings)
- Larger string literals in the test file increase per-test-file memory baseline
- With shorter strings, the loop runs longer before hitting V8's array size limit
- The crash is always the same bug; only the time-to-OOM varies

## Not MobX, Not Vitest

- MobX computed properties in `CompositeEditorStore` are clean — `validationErrors` and `buildCompositeDef()` only read observables, never write
- Lexer is clean — all paths advance `this.pos`
- The bug is purely in parser error recovery

## Affected Tests

All 3 skipped tests in `composite-store-integration.test.ts` trigger the parser through `CompositeEditorStore`. Test3 (line 60-76) directly passes malformed HCL `'invalid syntax { ] }'` which triggers the loop. Tests 1 and 2 may have independent issues or may work fine once the parser is fixed — they use valid composites.

## Risk Assessment

- **Fix risk**: LOW — the fix is localized to `recoverToBlockEnd()` and `parseDocument()`
- **Regression risk**: LOW — parser tests exist and can verify error recovery
- **Scope**: Single file fix + test re-enablement
