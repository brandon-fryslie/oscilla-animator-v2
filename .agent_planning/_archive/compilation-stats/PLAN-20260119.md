# Implementation Plan: Compilation Statistics

**Date:** 2026-01-19
**Feature:** Per-session compilation statistics in Diagnostics tab

---

## Overview

Add aggregated compilation statistics (count, min, max, median, average) to DiagnosticsStore and display them in the Diagnostics Console tab.

---

## Implementation Steps

### Step 1: Add CompilationStats to DiagnosticsStore

**File:** `src/stores/DiagnosticsStore.ts`

1. Add interface and initial state:

```typescript
export interface CompilationStats {
  count: number;
  totalMs: number;
  minMs: number;
  maxMs: number;
  recentMs: number[];  // Last 20 for median
}

// In class properties:
compilationStats: CompilationStats = {
  count: 0,
  totalMs: 0,
  minMs: Infinity,
  maxMs: 0,
  recentMs: [],
};
```

2. Add MobX annotations in constructor:

```typescript
makeObservable(this, {
  // ... existing ...
  compilationStats: observable,
  avgCompileMs: computed,
  medianCompileMs: computed,
  lastCompileMs: computed,
  recordCompilation: action,
});
```

3. Add computed getters:

```typescript
get avgCompileMs(): number {
  if (this.compilationStats.count === 0) return 0;
  return this.compilationStats.totalMs / this.compilationStats.count;
}

get medianCompileMs(): number {
  const recent = this.compilationStats.recentMs;
  if (recent.length === 0) return 0;
  const sorted = [...recent].sort((a, b) => a - b);
  const mid = Math.floor(sorted.length / 2);
  return sorted.length % 2 !== 0
    ? sorted[mid]
    : (sorted[mid - 1] + sorted[mid]) / 2;
}

get lastCompileMs(): number {
  const recent = this.compilationStats.recentMs;
  return recent.length > 0 ? recent[recent.length - 1] : 0;
}
```

4. Add action method:

```typescript
recordCompilation(durationMs: number): void {
  this.compilationStats.count++;
  this.compilationStats.totalMs += durationMs;
  this.compilationStats.minMs = Math.min(this.compilationStats.minMs, durationMs);
  this.compilationStats.maxMs = Math.max(this.compilationStats.maxMs, durationMs);

  // Keep last 20 for median calculation
  this.compilationStats.recentMs.push(durationMs);
  if (this.compilationStats.recentMs.length > 20) {
    this.compilationStats.recentMs.shift();
  }
}
```

### Step 2: Wire Up Event Subscription

**File:** `src/main.ts`

Find where EventHub subscriptions are set up (near DiagnosticHub setup) and add:

```typescript
// Subscribe to CompileEnd for statistics tracking
rootStore.events.subscribe('CompileEnd', (event: CompileEndEvent) => {
  if (event.status === 'success') {
    rootStore.diagnostics.recordCompilation(event.durationMs);
  }
});
```

### Step 3: Add Stats Display to DiagnosticConsole

**File:** `src/ui/components/app/DiagnosticConsole.tsx`

Add a stats bar at the top of the console:

```tsx
// Get stats from store
const { compilationStats, avgCompileMs, medianCompileMs, lastCompileMs } = rootStore.diagnostics;
const { count, minMs, maxMs } = compilationStats;

// Format helper
const fmt = (ms: number) => ms === Infinity || ms === 0 ? '—' : `${ms.toFixed(1)}ms`;

// Stats line (at top of component return)
{count > 0 && (
  <div style={{
    padding: '0.5rem 0.75rem',
    borderBottom: `1px solid ${colors.border}`,
    fontFamily: "'SF Mono', Monaco, Consolas, monospace",
    fontSize: '0.75rem',
    color: colors.textSecondary,
    display: 'flex',
    gap: '1rem',
  }}>
    <span>Compilations: {count}</span>
    <span>Last: {fmt(lastCompileMs)}</span>
    <span>Avg: {fmt(avgCompileMs)}</span>
    <span>Med: {fmt(medianCompileMs)}</span>
    <span>Min: {fmt(minMs)}</span>
    <span>Max: {fmt(maxMs)}</span>
  </div>
)}
```

---

## Files Modified

| File | Change |
|------|--------|
| `src/stores/DiagnosticsStore.ts` | Add CompilationStats interface, state, actions, computed |
| `src/main.ts` | Add CompileEnd event subscription |
| `src/ui/components/app/DiagnosticConsole.tsx` | Add stats display bar |

---

## Verification

1. **Build:** `npm run build` - no type errors
2. **Dev server:** `npm run dev`
3. **Test scenarios:**
   - Load app → stats show "Compilations: 1" after initial compile
   - Change parameter → stats update with each recompile
   - Verify min/max track correctly (min should be small, max larger)
   - Verify median stabilizes after 20+ compiles
   - Refresh page → stats reset to 0

---

## Estimated Effort

- Step 1: 15 minutes (DiagnosticsStore changes)
- Step 2: 5 minutes (event subscription)
- Step 3: 15 minutes (UI component)
- Testing: 10 minutes

**Total:** ~45 minutes
