# Sprint Plan: Block Registry Unification

**Generated:** 2026-01-11

## Sprint Goal

Eliminate all duplicate block registries and establish ONE SINGLE DEFINITION of a block in the codebase.

## Scope

**In scope (this sprint):**
1. Merge `registerBlock` and `registerBlockType` into a single registration call
2. Delete legacy `src/compiler/blocks/` registry and orphaned block implementations
3. Fix all UI components to use the unified registry

**Explicitly out of scope (future sprints):**
- Adding new blocks
- Performance optimization of the registry
- Documentation improvements

## Work Items

### P0: Merge BlockDef and BlockTypeDecl into unified type

**Acceptance Criteria (REQUIRED):**
- [ ] `src/blocks/registry.ts` has a single `BlockDef` interface that includes the `lower` function
- [ ] `registerBlock()` accepts the unified type with lowering function
- [ ] All type exports compile without errors

**Technical Notes:**
- Add `lower` field to `BlockDef` in `src/blocks/registry.ts`
- Add `IRPortDecl` equivalent types to the same file
- Keep the same function signature for `lower` that's currently in `lowerTypes.ts`
- Export everything needed for block implementations

### P1: Update all block files to use single registration

**Acceptance Criteria (REQUIRED):**
- [ ] Each `src/blocks/*.ts` file has ONE `registerBlock()` call per block (not two)
- [ ] `registerBlockType()` calls are removed entirely
- [ ] All blocks still compile

**Technical Notes:**
- Merge the `registerBlockType({...})` data into the `registerBlock({...})` call
- Port names use `id` (from BlockDef) not `portId` (from BlockTypeDecl)
- The `lower` function stays as-is but gets embedded in `registerBlock()`

### P2: Update compiler passes to use unified registry

**Acceptance Criteria (REQUIRED):**
- [ ] `pass6-block-lowering.ts` imports only from `src/blocks/registry.ts`
- [ ] No imports from `src/compiler/ir/lowerTypes.ts` for block type registry
- [ ] Compilation pipeline still works

**Technical Notes:**
- Change `getBlockType()` to use `getBlockDefinition()` with the new unified type
- Keep `lowerTypes.ts` for `ValueRefPacked`, `LowerCtx`, `LowerArgs`, `LowerResult` types only
- Remove the `BLOCK_TYPES` registry and `registerBlockType` from `lowerTypes.ts`

### P3: Delete legacy compiler/blocks registry

**Acceptance Criteria (REQUIRED):**
- [ ] `src/compiler/blocks/registry.ts` is deleted
- [ ] `src/compiler/blocks/time/*.ts` is deleted
- [ ] `src/compiler/blocks/signal/*.ts` is deleted
- [ ] `src/compiler/blocks/domain/*.ts` is deleted
- [ ] `src/compiler/blocks/render/*.ts` is deleted
- [ ] `src/compiler/blocks/rail/index.ts` is deleted
- [ ] `src/compiler/blocks/bus/index.ts` is deleted
- [ ] `src/compiler/blocks/index.ts` is deleted
- [ ] Build still compiles

**Technical Notes:**
- Rail and Bus blocks must be migrated to `src/blocks/` BEFORE deletion
- Update `src/index.ts` to export from `src/blocks/registry.ts`
- Check for any other imports from `src/compiler/blocks/`

### P4: Fix UI components to use unified registry

**Acceptance Criteria (REQUIRED):**
- [ ] `src/ui/registry/blockTypes.ts` is deleted (already commented out)
- [ ] `BlockLibrary.tsx` imports from `src/blocks/registry.ts`
- [ ] `BlockInspector.tsx` imports from `src/blocks/registry.ts`
- [ ] `BlockLibrary.test.tsx` imports from `src/blocks/registry.ts`
- [ ] UI components compile without errors

**Technical Notes:**
- Add UI-friendly accessor functions to `src/blocks/registry.ts`:
  - `getBlockCategories()`: string[]
  - `getBlockTypesByCategory(category: string)`: BlockDef[]
  - `searchBlockTypes(query: string)`: BlockDef[]
- Update component code to use the new accessors
- Port type definitions may need mapping for UI display

### P5: Verify everything works

**Acceptance Criteria (REQUIRED):**
- [ ] `npm run build` succeeds with 0 errors
- [ ] `npm run test` passes
- [ ] App loads in browser without errors
- [ ] Block library shows all blocks

**Technical Notes:**
- Run full build before marking complete
- Check browser console for runtime errors
- Verify blocks appear in UI block library

## Dependencies

1. P0 must complete before P1 (need unified type first)
2. P1 must complete before P2 (blocks must register correctly)
3. P2 must complete before P3 (compiler must work before deleting old code)
4. P3 and P4 can run in parallel (independent changes)
5. P5 runs after P3 and P4 complete

## Risks

1. **Rail/Bus blocks** use the legacy registry - need careful migration
2. **UI components** may have runtime dependencies we don't see in static analysis
3. **Test files** may need additional updates

## Implementation Order

```
P0 → P1 → P2 → P3 (parallel with P4) → P5
                 ↘ P4 ↗
```
