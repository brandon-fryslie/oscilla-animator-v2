# Definition of Done: Compilation Pipeline Cleanup

**Date:** 2026-01-19
**Issue:** oscilla-animator-v2-k0v
**Epic:** Phase 1 Unified Plan (P3)

---

## Functional Acceptance Criteria

### FC1: Code Cleanup Complete
- [ ] Unused state API stubs removed from IRBuilder interface
- [ ] Unused state API stubs removed from IRBuilderImpl implementation
- [ ] No references to removed APIs anywhere in codebase
- [ ] Working state APIs (`allocStateSlot`, `sigStateRead`, `stepStateWrite`) remain intact

### FC2: Pass 8 Status Documented
- [ ] Index.ts export comment explains Pass 8 decision
- [ ] Pass8-link-resolution.ts has header comment with status and rationale
- [ ] Comments clearly state: "Implemented but not currently used"
- [ ] Reason explained: "Pass 6 handles all input resolution"

### FC3: Seed Management Resolved
- [ ] TODO in pass6-block-lowering.ts line 368 addressed
- [ ] Either: Proper seed allocation implemented
- [ ] Or: Documentation explains why seed=0 is correct
- [ ] Or: TODO updated with tracking info if out of scope
- [ ] Array block randomId tests still pass

---

## Technical Acceptance Criteria

### TC1: Build and TypeScript
- [ ] `npm run typecheck` passes with 0 errors
- [ ] `npm run build` succeeds
- [ ] No new TypeScript warnings introduced
- [ ] No `@ts-ignore` or `any` casts added

### TC2: Test Suite
- [ ] All 372 existing tests pass
- [ ] Zero test failures
- [ ] Exactly 4 tests skipped (Id01 tests, pre-existing)
- [ ] No new test skips introduced
- [ ] UnitDelay tests pass (verify state APIs work)
- [ ] Hash tests pass (verify state APIs work)
- [ ] Steel thread integration test passes

### TC3: No Regressions
- [ ] Compilation pipeline still works end-to-end
- [ ] State management still functional
- [ ] Stateful primitives (UnitDelay, Hash) still work
- [ ] No performance degradation

---

## Documentation Acceptance Criteria

### DC1: Code Comments
- [ ] Pass 8 decision explained in code
- [ ] State API architecture clear from remaining code
- [ ] Seed management choice documented
- [ ] No confusing or misleading comments remain

### DC2: Commit Messages
- [ ] Each commit has clear, descriptive message
- [ ] Commit messages explain "why" not just "what"
- [ ] Breaking changes clearly noted (should be none)
- [ ] Related issues referenced

### DC3: Planning Files
- [ ] CONTEXT.md accurately describes current state
- [ ] PLAN.md reflects actual work done
- [ ] DOD.md (this file) has all criteria checked
- [ ] INDEX.md updated with completion status

### DC4: Beads Issue
- [ ] Issue description updated to reflect reality
- [ ] "Passes 5-10" miscount corrected to "8 passes"
- [ ] State API stub claim removed
- [ ] Issue marked as complete when done

---

## Verification Commands

### Pre-Implementation Baseline
```bash
npm run typecheck     # Should pass
npm test              # Should show 372 passing, 4 skipped, 0 failures
grep -r "declareState\|readState\|writeState\|getTimepointMarkers" src/
# Should only show definitions (not usage)
```

### Post-Implementation Verification
```bash
npm run typecheck     # Should still pass
npm run build         # Should succeed
npm test              # Should still show 372 passing, 4 skipped, 0 failures
git diff --stat       # Should show only intended files changed
```

### Specific Test Verification
```bash
npm test src/blocks/__tests__/stateful-primitives.test.ts
# Should show UnitDelay and Hash tests passing

npm test src/compiler/__tests__/steel-thread.test.ts
# Should show integration test passing
```

---

## Definition of COMPLETE

**ALL** of the following must be true:

1. ✅ **Code Quality:** All FC1-FC3 criteria met
2. ✅ **Technical:** All TC1-TC3 criteria met
3. ✅ **Documentation:** All DC1-DC4 criteria met
4. ✅ **Verification:** All commands pass
5. ✅ **No Regressions:** Existing functionality unchanged
6. ✅ **Git Clean:** Only intended changes committed
7. ✅ **Issue Closed:** Beads issue updated and closed

---

## Exclusions (Out of Scope)

**NOT required for this issue:**
- New features
- New tests (existing coverage sufficient)
- Performance improvements
- Spec document updates
- Implementing Pass 9 or Pass 10 (they don't exist!)
- Implementing Lag, Phasor, or SampleAndHold blocks (separate task)
- Hot-swap state preservation (Phase 2)
- Event system integration (Phase 3)

---

## Acceptance Process

1. **Developer Self-Check:**
   - Run all verification commands
   - Check all criteria in this DOD
   - Verify git diff shows only intended changes

2. **Automated Verification:**
   - CI runs tests and reports results
   - TypeScript compilation checked
   - Build artifacts generated

3. **Manual Review:**
   - Code review for clarity and correctness
   - Verify architectural decisions sound
   - Check commit messages descriptive

4. **Sign-Off:**
   - Developer marks DOD complete
   - Beads issue closed
   - Roadmap updated to COMPLETED

---

## Known Risks and Mitigations

### Risk: Removing APIs breaks hidden usage
**Mitigation:** Grep verification before removal
**Rollback:** `git checkout` to revert if needed

### Risk: Pass 8 actually needed somewhere
**Mitigation:** Keeping implementation, just documenting
**Impact:** Low - can re-enable export if needed

### Risk: Seed change breaks determinism
**Mitigation:** Run tests, check output consistency
**Rollback:** Revert seed changes if tests fail

---

## Success Indicators

**Objective Measures:**
- [ ] 372 tests passing (same count as before)
- [ ] 0 lines of dead code in IRBuilder
- [ ] 0 TODO comments in compilation passes
- [ ] 0 test failures

**Subjective Measures:**
- [ ] Code is easier to understand
- [ ] No confusion about "state API stubs"
- [ ] Pass 8 decision is clear
- [ ] Beads issue description matches reality

---

## Post-Completion Tasks

1. **Update Roadmap:**
   - Mark compilation-pipeline as COMPLETED
   - Update completion timestamp
   - Add summary of work done

2. **Commit Planning Docs:**
   ```bash
   git add .agent_planning/compilation-pipeline/
   git commit -m "docs(planning): Complete compilation-pipeline cleanup planning"
   ```

3. **Notify Stakeholders:**
   - Roadmap readers see updated status
   - Future agents see clean codebase
   - No confusion about "missing passes"

---

## References

- **Planning:** `.agent_planning/compilation-pipeline/PLAN-20260119.md`
- **Context:** `.agent_planning/compilation-pipeline/CONTEXT-20260119.md`
- **Spec:** `design-docs/CANONICAL-oscilla-v2.5-20260109/topics/04-compilation.md`
- **Beads:** oscilla-animator-v2-k0v
- **Roadmap:** `.agent_planning/ROADMAP.md` lines 74-84
