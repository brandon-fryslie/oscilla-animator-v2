# Implementation Context: Dual Editor (ReactFlow + Rete)

**Topic:** dual-editor-reactflow
**Created:** 2026-01-13 21:45

---

## Key Files Reference

### Files to Create

| File | Purpose |
|------|---------|
| `src/ui/editorCommon/EditorHandle.ts` | Generic interface both editors implement |
| `src/ui/editorCommon/EditorContext.tsx` | Generic React context provider |
| `src/ui/editorCommon/index.ts` | Module exports |
| `src/ui/reactFlowEditor/ReactFlowEditor.tsx` | Main ReactFlow component |
| `src/ui/reactFlowEditor/sync.ts` | PatchStore sync for ReactFlow |
| `src/ui/reactFlowEditor/nodes.ts` | Node factory functions |
| `src/ui/reactFlowEditor/index.ts` | Module exports |

### Files to Modify

| File | Line | Change |
|------|------|--------|
| `src/ui/components/app/App.tsx` | 25 | Import from `../../editorCommon` and `../../reteEditor` |
| `src/ui/components/app/App.tsx` | 74-78 | Rename tab id/label, add ReactFlow tab |
| `src/ui/components/BlockLibrary.tsx` | 18-19 | Import from `../editorCommon`, use generic handle |
| `src/ui/components/__tests__/BlockLibrary.test.tsx` | 1 | Import from `../../editorCommon` |
| `src/ui/reteEditor/ReteEditor.tsx` | ~300 | Add EditorHandle adapter function |
| `src/ui/reteEditor/index.ts` | all | Remove EditorContext export |

---

## EditorHandle Interface

```typescript
// src/ui/editorCommon/EditorHandle.ts
import type { BlockId } from '../../types';

export interface EditorHandle {
  readonly type: 'rete' | 'reactflow';
  addBlock(blockId: BlockId, blockType: string): Promise<void>;
  removeBlock(blockId: BlockId): Promise<void>;
  zoomToFit(): Promise<void>;
  autoArrange?(): Promise<void>;
  getRawHandle(): unknown;
}
```

---

## Sync Pattern

Both editors use the same sync architecture:

```
PatchStore (MobX) ←→ sync.ts (isSyncing guard) ←→ Editor (UI State)
```

**Key pattern - isSyncing guard:**
```typescript
let isSyncing = false;

function syncFromStore() {
  if (isSyncing) return;
  isSyncing = true;
  try { /* update UI */ } finally { isSyncing = false; }
}

function onUserEdit() {
  if (isSyncing) return;
  isSyncing = true;
  try { /* update store */ } finally { isSyncing = false; }
}
```

---

## ReactFlow Integration

**Package:** `reactflow` (^11.x)

**Key hooks:**
```typescript
const [nodes, setNodes, onNodesChange] = useNodesState([]);
const [edges, setEdges, onEdgesChange] = useEdgesState([]);
```

**Node model mapping:**
```typescript
// PatchStore Block → ReactFlow Node
{
  id: block.id,
  type: 'default',
  position: { x, y },
  data: { label: block.label, blockType: block.type }
}
```

**Edge model mapping:**
```typescript
// PatchStore Edge → ReactFlow Edge
{
  id: edge.id,
  source: edge.from.blockId,
  sourceHandle: edge.from.slotId,
  target: edge.to.blockId,
  targetHandle: edge.to.slotId
}
```

---

## Tab Configuration

**Location:** `src/ui/components/app/App.tsx` lines 63-84

**Current:**
```typescript
{ id: 'editor', label: 'Editor', component: ReteEditor }
```

**Target:**
```typescript
{ id: 'rete-editor', label: 'Rete', component: ReteEditor },
{ id: 'flow-editor', label: 'Flow', component: ReactFlowEditor },
```

---

## Import Path Updates

| Current | New |
|---------|-----|
| `from '../../editor'` | `from '../../reteEditor'` + `from '../../editorCommon'` |
| `from '../editor/EditorContext'` | `from '../editorCommon'` |
| `from '../editor/sync'` | Via `editorHandle.addBlock()` |

---

## BlockLibrary Integration

**Current (Rete-specific):**
```typescript
import { addBlockToEditor } from '../editor/sync';
addBlockToEditor(editorHandle, blockId, type.type);
```

**Target (Generic):**
```typescript
editorHandle.addBlock(blockId, type.type);
```

---

## Critical Implementation Notes

1. **ReteEditor adapter** must wrap raw Rete handle to implement EditorHandle
2. **Both editors** register via `setEditorHandle()` when mounted
3. **Tab system** keeps both mounted (display: none), preserving state
4. **PatchStore** is single source of truth - editors are views
5. **MobX reactions** trigger sync when PatchStore changes externally
