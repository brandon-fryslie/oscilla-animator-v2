# Work Evaluation - 2026-01-13-224325
Scope: work/dual-editor-reactflow/P1
Confidence: FRESH

## Goals Under Evaluation
From DOD-20260113-214500.md (P1: ReactFlow Editor Core):
1. ReactFlow editor renders nodes from PatchStore
2. Pan works (drag background)
3. Zoom works (scroll wheel)
4. Nodes are draggable
5. Connections can be created by dragging
6. Delete key removes selected nodes
7. ReactFlowEditor implements EditorHandle interface

## Previous Evaluation Reference
Last evaluation: EVALUATION-20260113-214500.md (pre-implementation)
- P0 completed successfully
- P1 implementation path identified
- No previous P1 runtime evaluation

## Persistent Check Results
| Check | Status | Output Summary |
|-------|--------|----------------|
| `npm run typecheck` | PASS | 0 errors |
| `npm run test` | FAIL (pre-existing) | 3 compile.test.ts failures unrelated to P1 |
| `npm run build` | NOT RUN | - |

**Note:** Test failures are pre-existing (compile.test.ts), not introduced by P1.

## Manual Runtime Testing

**NOT PERFORMED** - P1 creates the module but does not integrate into app.
ReactFlowEditor is not imported or mounted anywhere in the UI yet (P2 adds tabs).

**Why manual testing cannot be done:**
- ReactFlowEditor component not rendered
- No UI entry point exists
- Tab integration deferred to P2

## Structural Verification

### ✅ Files Created
All required files exist:
- `/src/ui/reactFlowEditor/ReactFlowEditor.tsx` (183 lines)
- `/src/ui/reactFlowEditor/sync.ts` (217 lines)
- `/src/ui/reactFlowEditor/nodes.ts` (73 lines)
- `/src/ui/reactFlowEditor/index.ts` (10 lines)
- `/src/ui/reactFlowEditor/ReactFlowEditor.css` (62 lines)

### ✅ Dependencies
- `reactflow` v11.11.4 installed in package.json

### ✅ EditorHandle Implementation
ReactFlowEditor implements EditorHandle interface via adapter:
- `type: 'reactflow'` ✅
- `addBlock(blockId, blockType)` ✅
- `removeBlock(blockId)` ✅
- `zoomToFit()` ✅ (logs to console, actual zoom via Controls)
- `getRawHandle()` ✅

### ✅ PatchStore Sync
Bidirectional sync implemented:
- `syncPatchToReactFlow()` - Initial load ✅
- `setupPatchToReactFlowReaction()` - MobX reaction ✅
- `isSyncing` guard pattern ✅
- `createNodesChangeHandler()` ✅
- `createEdgesChangeHandler()` ✅
- `createConnectHandler()` ✅

### ✅ ReactFlow Features
Component includes:
- `useNodesState`, `useEdgesState` ✅
- `onNodesChange`, `onEdgesChange`, `onConnect` ✅
- `Background` component ✅
- `Controls` component (pan/zoom UI) ✅
- Delete key handler (lines 143-165) ✅
- `fitView` prop ✅

## Assessment

### ✅ Working (Structural)
- **Files exist**: All required files created
- **Types pass**: `npm run typecheck` passes
- **EditorHandle interface**: Fully implemented
- **Sync infrastructure**: Bidirectional sync with isSyncing guard
- **Delete handler**: Keyboard event listener for Delete/Backspace
- **MobX integration**: Reaction set up for external changes

### ❌ Not Working

#### CRITICAL: Custom Node Types Missing

**Location:** `src/ui/reactFlowEditor/nodes.ts:35`, `ReactFlowEditor.tsx`

**Issue:** Nodes use ReactFlow's default node type (`type: 'default'`) which:
1. Does not render custom handles based on node data
2. Has only generic source/target handles (one each)
3. Cannot distinguish between specific input/output ports

**Evidence:**
```typescript
// nodes.ts:35 - Creates default node
return {
  id: block.id,
  type: 'default',  // <-- Uses default ReactFlow node
  position: { x: 0, y: 0 },
  data: {
    blockId: block.id,
    blockType: block.type,
    label: block.displayName || blockDef.label,
    inputs: blockDef.inputs.map(...),    // <-- Data stored but not rendered
    outputs: blockDef.outputs.map(...),  // <-- Data stored but not rendered
  },
};
```

**Impact:** 
- Connections can be created between nodes (basic ReactFlow functionality works)
- BUT: `connection.sourceHandle` and `connection.targetHandle` will be undefined or generic
- This breaks the Oscilla semantic model where edges connect specific ports
- Multi-port blocks (inputs/outputs > 1) cannot have meaningful connections

**Example failure scenario:**
- Block A has outputs: `['frequency', 'amplitude']`
- Block B has inputs: `['input1', 'input2']`
- User drags from A to B
- Connection created with `sourceHandle: undefined` and `targetHandle: undefined`
- sync.ts:173-178 calls `addEdge({ slotId: '' }, { slotId: '' })`
- PatchStore receives edge with empty slotIds
- Connection has no semantic meaning

**Root cause:**
P1 DOD line 88 defers "Custom node styling" but custom nodes are NOT just for styling - they're required for port-specific handles.

**What's needed:**
1. Create custom node component (e.g., `OscillaNodeComponent.tsx`)
2. Render `<Handle>` components for each input/output
3. Set `type: 'oscilla'` instead of `'default'`
4. Register custom node type with ReactFlow `nodeTypes` prop

#### MINOR: MiniMap Imported But Not Used

**Location:** `ReactFlowEditor.tsx:13`

**Issue:** `MiniMap` imported but not rendered

**Evidence:**
```typescript
import ReactFlow, {
  Background,
  Controls,
  MiniMap,  // <-- Imported
  ...
} from 'reactflow';

// ...

<ReactFlow ...>
  <Background />
  <Controls />
  {/* MiniMap not rendered - correctly deferred per DOD:88 */}
</ReactFlow>
```

**Impact:** Minor - unused import, no runtime impact

**Fix:** Remove `MiniMap` from imports (deferred to later phase per DOD)

#### MINOR: Empty sourceHandle/targetHandle Fallback

**Location:** `sync.ts:173, 178`

**Issue:** Fallback to empty string when handles are undefined

**Evidence:**
```typescript
slotId: connection.sourceHandle || '',  // <-- Defaults to empty string
slotId: connection.targetHandle || '',
```

**Impact:** Connections work but with semantically invalid slotIds

**Note:** This becomes correct once custom nodes provide proper handle IDs

### ⚠️ Ambiguities Found

| Decision | What Was Assumed | Should Have Asked | Impact |
|----------|------------------|-------------------|--------|
| Node rendering | Default nodes sufficient for P1 | "Do connections need port-specific handles in P1?" | CRITICAL - breaks multi-port blocks |
| Custom nodes | Deferred as "styling" | "Are custom nodes required for functionality vs. styling?" | CRITICAL - connections non-functional |
| Handle rendering | Data structure enough | "How should port handles be rendered?" | CRITICAL - no visual connection points |

**Clarification needed:** 
The DOD says "Custom node styling (deferred)" but doesn't distinguish between:
1. **Custom node TYPES** (required for port handles) vs.
2. **Custom node APPEARANCE** (styling, colors, fonts)

The former is functionally required for P1, the latter is cosmetic.

## Missing Checks (implementer should create)

None specified yet. After custom nodes are added:

1. **Unit test for custom node rendering** (`src/ui/reactFlowEditor/__tests__/nodes.test.tsx`)
   - Renders correct number of input handles
   - Renders correct number of output handles
   - Handle IDs match slot IDs

2. **Integration test for port-specific connections** (`src/ui/reactFlowEditor/__tests__/connections.test.tsx`)
   - Connect specific output port to input port
   - Verify sourceHandle and targetHandle in connection
   - Verify PatchStore receives correct slotIds

## Verdict: INCOMPLETE

**Reason:** Custom node types missing, required for port-specific connections.

**What works:**
- Module structure complete
- EditorHandle interface implemented
- Sync infrastructure in place
- TypeScript compiles
- Basic ReactFlow features present

**What's broken:**
- Connections cannot distinguish between specific ports
- Multi-port blocks non-functional
- slotId defaults to empty string

**Blockers:**
1. Custom node component not implemented
2. Ambiguity: "custom nodes" vs "custom styling" in DOD

## What Needs to Change

### 1. Create Custom Node Component

**File:** `src/ui/reactFlowEditor/OscillaNode.tsx` (NEW)

**What's needed:**
- React component that renders node based on `OscillaNodeData`
- Render `<Handle type="source" position={Position.Right} id={output.id}>` for each output
- Render `<Handle type="target" position={Position.Left} id={input.id}>` for each input
- Display node label
- Show input/output labels

**Example structure:**
```typescript
import { Handle, Position } from 'reactflow';
import type { OscillaNodeData } from './nodes';

export const OscillaNode: React.FC<{ data: OscillaNodeData }> = ({ data }) => {
  return (
    <div className="oscilla-node">
      {data.inputs.map(input => (
        <Handle key={input.id} type="target" position={Position.Left} id={input.id} />
      ))}
      
      <div className="node-label">{data.label}</div>
      
      {data.outputs.map(output => (
        <Handle key={output.id} type="source" position={Position.Right} id={output.id} />
      ))}
    </div>
  );
};
```

### 2. Register Custom Node Type

**File:** `src/ui/reactFlowEditor/ReactFlowEditor.tsx:169-181`

**Change:**
```typescript
// Add import
import { OscillaNode } from './OscillaNode';

// Define node types
const nodeTypes = {
  oscilla: OscillaNode,
};

// Update ReactFlow component
<ReactFlow
  nodes={nodes}
  edges={edges}
  nodeTypes={nodeTypes}  // <-- Add this
  onNodesChange={handleNodesChange}
  onEdgesChange={handleEdgesChange}
  onConnect={handleConnect}
  fitView
  attributionPosition="bottom-left"
>
```

### 3. Update Node Creation to Use Custom Type

**File:** `src/ui/reactFlowEditor/nodes.ts:35`

**Change:**
```typescript
return {
  id: block.id,
  type: 'oscilla',  // <-- Change from 'default'
  position: { x: 0, y: 0 },
  data: {
    blockId: block.id,
    blockType: block.type,
    label: block.displayName || blockDef.label,
    inputs: blockDef.inputs.map((input) => ({
      id: input.id,
      label: input.label,
    })),
    outputs: blockDef.outputs.map((output) => ({
      id: output.id,
      label: output.label,
    })),
  },
};
```

### 4. Remove Unused MiniMap Import (OPTIONAL)

**File:** `src/ui/reactFlowEditor/ReactFlowEditor.tsx:13`

**Change:**
```typescript
import ReactFlow, {
  Background,
  Controls,
  // MiniMap,  // <-- Remove (deferred)
  useNodesState,
  useEdgesState,
  addEdge,
  type Node,
  type Edge,
} from 'reactflow';
```

## Questions Needing Answers

None - path forward is clear. Custom nodes are functionally required, not just styling.

## Estimated Effort

**To fix:** 1-2 hours
- Create `OscillaNode.tsx` component (30 min)
- Update `nodes.ts` to use custom type (5 min)
- Update `ReactFlowEditor.tsx` to register node type (5 min)
- Test manually or write unit tests (30-60 min)

## Evidence

**TypeScript compilation:**
```
> oscilla-animator-v2@0.0.1 typecheck
> tsc -b
```
✅ Passes

**Files created:**
```
src/ui/reactFlowEditor/
├── ReactFlowEditor.css (62 lines)
├── ReactFlowEditor.tsx (183 lines)
├── index.ts (10 lines)
├── nodes.ts (73 lines)
└── sync.ts (217 lines)
```
✅ All present

**EditorHandle adapter:**
```typescript
// ReactFlowEditor.tsx:50-72
function createReactFlowEditorAdapter(
  handle: ReactFlowEditorHandle
): EditorHandle {
  return {
    type: 'reactflow' as const,
    async addBlock(blockId: BlockId, blockType: string): Promise<void> {
      await handle.addBlock(blockId, blockType);
    },
    async removeBlock(blockId: BlockId): Promise<void> {
      await handle.removeBlock(blockId);
    },
    async zoomToFit(): Promise<void> {
      await handle.zoomToFit();
    },
    getRawHandle(): unknown {
      return handle;
    },
  };
}
```
✅ Correctly implements EditorHandle interface

**Critical bug location:**
- `nodes.ts:35` - `type: 'default'` instead of custom node
- `ReactFlowEditor.tsx` - No `nodeTypes` prop
- Missing: `OscillaNode.tsx` component file
