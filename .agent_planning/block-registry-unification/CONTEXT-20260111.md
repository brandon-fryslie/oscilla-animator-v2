# Implementation Context: Block Registry Unification

**Generated:** 2026-01-11

## File Inventory

### Files to MODIFY

| File | Changes |
|------|---------|
| `src/blocks/registry.ts` | Add `lower` field to `BlockDef`, add `LowerArgs`/`LowerResult` types, add UI accessor functions |
| `src/blocks/time-blocks.ts` | Merge `registerBlockType` into `registerBlock` |
| `src/blocks/signal-blocks.ts` | Merge `registerBlockType` into `registerBlock` |
| `src/blocks/math-blocks.ts` | Merge `registerBlockType` into `registerBlock` |
| `src/blocks/domain-blocks.ts` | Merge `registerBlockType` into `registerBlock` |
| `src/blocks/color-blocks.ts` | Merge `registerBlockType` into `registerBlock` |
| `src/blocks/identity-blocks.ts` | Merge `registerBlockType` into `registerBlock` |
| `src/blocks/geometry-blocks.ts` | Merge `registerBlockType` into `registerBlock` |
| `src/blocks/field-blocks.ts` | Merge `registerBlockType` into `registerBlock` |
| `src/blocks/render-blocks.ts` | Merge `registerBlockType` into `registerBlock` |
| `src/blocks/field-operations-blocks.ts` | Merge `registerBlockType` into `registerBlock` |
| `src/compiler/ir/lowerTypes.ts` | Remove `BLOCK_TYPES`, `registerBlockType`, `getBlockType`, `hasBlockType`, `getAllBlockTypes` |
| `src/compiler/passes-v2/pass6-block-lowering.ts` | Import from `src/blocks/registry.ts` instead |
| `src/index.ts` | Export from `src/blocks/registry.ts` |
| `src/ui/components/BlockLibrary.tsx` | Import from `src/blocks/registry.ts` |
| `src/ui/components/BlockInspector.tsx` | Import from `src/blocks/registry.ts` |
| `src/ui/components/__tests__/BlockLibrary.test.tsx` | Import from `src/blocks/registry.ts` |

### Files to DELETE

| File | Reason |
|------|--------|
| `src/compiler/blocks/registry.ts` | Legacy duplicate registry |
| `src/compiler/blocks/index.ts` | Imports legacy registry |
| `src/compiler/blocks/time/index.ts` | Legacy block loader |
| `src/compiler/blocks/time/InfiniteTimeRoot.ts` | Duplicate block impl |
| `src/compiler/blocks/signal/index.ts` | Legacy block loader |
| `src/compiler/blocks/signal/*.ts` | Duplicate block impls |
| `src/compiler/blocks/domain/index.ts` | Legacy block loader |
| `src/compiler/blocks/domain/*.ts` | Duplicate block impls |
| `src/compiler/blocks/render/index.ts` | Legacy block loader |
| `src/compiler/blocks/render/*.ts` | Duplicate block impls |
| `src/compiler/blocks/rail/index.ts` | Legacy rail impl (migrate first) |
| `src/compiler/blocks/bus/index.ts` | Legacy bus impl (migrate first) |
| `src/ui/registry/blockTypes.ts` | Dead code (commented out) |

### Files to CREATE

| File | Contents |
|------|----------|
| `src/blocks/rail-blocks.ts` | Migrated Rail block from `src/compiler/blocks/rail/` |
| `src/blocks/bus-blocks.ts` | Migrated Bus block from `src/compiler/blocks/bus/` |

## Type Definitions

### Current `BlockDef` (src/blocks/registry.ts:50-60)

```typescript
export interface BlockDef {
  readonly type: string;
  readonly label: string;
  readonly category: string;
  readonly description?: string;
  readonly form: BlockForm;
  readonly capability: Capability;
  readonly inputs: readonly InputDef[];
  readonly outputs: readonly OutputDef[];
  readonly params?: Record<string, unknown>;
}
```

### Current `BlockTypeDecl` (src/compiler/ir/lowerTypes.ts:82-90)

```typescript
export interface BlockTypeDecl {
  readonly type: string;
  readonly inputs: readonly IRPortDecl[];
  readonly outputs: readonly IRPortDecl[];
  readonly lower: (args: LowerArgs) => LowerResult;
  readonly tags?: {
    readonly irPortContract?: 'strict' | 'relaxed';
  };
}
```

### Unified `BlockDef` (TARGET)

```typescript
export interface BlockDef {
  // Identity
  readonly type: string;

  // UI metadata
  readonly label: string;
  readonly category: string;
  readonly description?: string;

  // Compilation metadata
  readonly form: BlockForm;
  readonly capability: Capability;

  // Port definitions (unified - using InputDef/OutputDef with SignalType)
  readonly inputs: readonly InputDef[];
  readonly outputs: readonly OutputDef[];

  // Block parameters
  readonly params?: Record<string, unknown>;

  // IR lowering function (from BlockTypeDecl)
  readonly lower: (args: LowerArgs) => LowerResult;

  // Optional tags (from BlockTypeDecl)
  readonly tags?: {
    readonly irPortContract?: 'strict' | 'relaxed';
  };
}
```

## Lowering Types (Keep in lowerTypes.ts)

These types should STAY in `src/compiler/ir/lowerTypes.ts`:

```typescript
// Value references
export type ValueRefPacked = ...;

// Lowering context
export interface LowerCtx { ... }
export interface LowerArgs { ... }
export interface LowerResult { ... }

// Legacy lowering types (for backward compat)
export type LoweredOutput = ...;
export interface LoweredBlock { ... }
export interface LowerContext { ... }
export type BlockLowerFn = ...;
export interface LoweredIR { ... }
```

Remove from `lowerTypes.ts`:
- `IRPortDecl` (move to registry.ts or delete - use InputDef/OutputDef)
- `BlockTypeDecl` (replaced by unified BlockDef)
- `BLOCK_TYPES` Map
- `registerBlockType()` function
- `getBlockType()` function
- `hasBlockType()` function
- `getAllBlockTypes()` function

## Pass6 Changes

Current imports:
```typescript
import { getBlockType } from "../ir/lowerTypes";
import { BLOCK_DEFS_BY_TYPE } from "../../blocks/registry";
```

After unification:
```typescript
import { getBlockDefinition, BLOCK_DEFS_BY_TYPE } from "../../blocks/registry";
import type { LowerCtx, LowerArgs, ValueRefPacked } from "../ir/lowerTypes";
```

The key change in `lowerBlockInstance()`:
```typescript
// Before
const blockType = getBlockType(block.type);

// After
const blockDef = getBlockDefinition(block.type);
// blockDef now has both metadata AND lower function
```

## UI Functions to Add (src/blocks/registry.ts)

```typescript
/**
 * Get all unique categories.
 */
export function getBlockCategories(): string[] {
  const categories = new Set<string>();
  for (const def of registry.values()) {
    categories.add(def.category);
  }
  return Array.from(categories).sort();
}

/**
 * Get blocks by category.
 */
export function getBlockTypesByCategory(category: string): BlockDef[] {
  return Array.from(registry.values())
    .filter(def => def.category === category);
}

/**
 * Search blocks by query.
 */
export function searchBlockTypes(query: string): BlockDef[] {
  const q = query.toLowerCase();
  return Array.from(registry.values())
    .filter(def =>
      def.type.toLowerCase().includes(q) ||
      def.label.toLowerCase().includes(q) ||
      (def.description?.toLowerCase().includes(q) ?? false)
    );
}
```

## Migration Notes for Rail/Bus Blocks

The Rail block in `src/compiler/blocks/rail/index.ts` uses:
```typescript
import { registerBlock, portId, sigType, eventType, type BlockLower } from '../registry';
```

This needs to migrate to:
```typescript
import { registerBlock, type LowerArgs, type LowerResult } from './registry';
import { signalType } from '../core/canonical-types';
```

The `BlockLower` type signature is:
```typescript
// OLD (legacy registry)
type BlockLower = (ctx: LowerContext) => Record<string, ValueRef>;

// NEW (unified registry)
type lower = (args: LowerArgs) => LowerResult;
```

Key differences:
- `ctx.b` → `args.ctx.b` (IRBuilder)
- `ctx.inputsById` → `args.inputsById` (same)
- `ctx.config` → `args.config` (same)
- Return `{ outputsById: {...} }` instead of just `{...}`
