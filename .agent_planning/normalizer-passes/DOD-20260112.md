# Definition of Done: Normalizer Pass Refactoring

**Sprint**: 2026-01-12
**Scope**: Extract normalize.ts into Pass 0 and Pass 1

---

## Acceptance Checklist

### Structural Requirements

- [ ] `src/compiler/passes-v2/pass0-polymorphic-types.ts` exists
- [ ] `src/compiler/passes-v2/pass1-default-sources-adapters.ts` exists
- [ ] Both files follow the existing pass pattern (single exported function, typed I/O)
- [ ] `src/compiler/passes-v2/index.ts` exports both passes and their types
- [ ] `src/graph/normalize.ts` still exports `normalize()` for backward compatibility

### Functional Requirements

- [ ] `pass0PolymorphicTypes(patch)` returns a `Patch` with resolved `payloadType` params
- [ ] `pass1DefaultSourcesAndAdapters(patch)` returns `NormalizeResult | NormalizeError`
- [ ] The combined output of Pass 0 + Pass 1 is identical to the original `normalize()` output
- [ ] Polymorphic type resolution works bidirectionally (forward and backward)
- [ ] Default sources are inserted for unconnected inputs with `defaultSource` metadata
- [ ] Adapters are inserted for type-mismatched edges
- [ ] Block indices are built deterministically (sorted by ID)
- [ ] Edges are normalized and sorted deterministically

### Error Handling

- [ ] Pass 0 does NOT throw errors (unresolved types remain `'???'`)
- [ ] Pass 1 collects errors into `NormError[]` array
- [ ] `compile.ts` converts `NormError[]` to `CompileError[]`
- [ ] All error kinds are preserved: `DanglingEdge`, `DuplicateBlockId`, `UnknownBlockType`, `UnknownPort`, `NoAdapterFound`

### Type Safety

- [ ] `npm run typecheck` passes with no errors
- [ ] All function signatures match the spec in EVALUATION
- [ ] No `any` types except where existing code uses them
- [ ] Type exports are properly re-exported through index.ts

### Tests

- [ ] `npm run test` passes with no failures
- [ ] No test file modifications required (existing tests cover behavior)
- [ ] Coverage does not decrease

### Build

- [ ] `npm run build` succeeds
- [ ] No new warnings introduced

### Code Quality

- [ ] No commented-out code in new files
- [ ] JSDoc comments on exported functions
- [ ] File headers match existing pass pattern
- [ ] No duplicate code between Pass 0, Pass 1, and normalize.ts (normalize.ts delegates)

### Pipeline Integration

- [ ] `compile.ts` calls Pass 0 then Pass 1 in sequence
- [ ] Error diagnostics include proper context

---

## Verification Commands

```bash
# All must succeed
npm run typecheck
npm run test
npm run build
```

---

## Rollback Criteria

If any of these occur, revert to original normalize.ts:
- Tests fail and cannot be fixed within 30 minutes
- Type errors indicate incompatible IR changes
- Runtime errors in compilation pipeline
