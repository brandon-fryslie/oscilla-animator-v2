# Definition of Done: Graph Normalizer Pass Refactoring

**Sprint**: 2026-01-12
**Scope**: Refactor `src/graph/normalize.ts` into `src/graph/passes/`

---

## Acceptance Checklist

### Structural Requirements

- [ ] `src/graph/passes/` directory exists
- [ ] `src/graph/passes/pass0-polymorphic-types.ts` exists
- [ ] `src/graph/passes/pass1-default-sources.ts` exists
- [ ] `src/graph/passes/pass2-adapters.ts` exists
- [ ] `src/graph/passes/pass3-indexing.ts` exists
- [ ] `src/graph/passes/index.ts` exists
- [ ] `src/graph/normalize.ts` is a thin wrapper (~20 lines)

### Functional Requirements

- [ ] `pass0PolymorphicTypes(patch)` returns `Patch` with resolved types
- [ ] `pass1DefaultSources(patch)` returns `Patch` with Const blocks inserted
- [ ] `pass2Adapters(patch)` returns `Pass2Result | Pass2Error`
- [ ] `pass3Indexing(patch)` returns `Pass3Result | Pass3Error`
- [ ] `runNormalizationPasses(patch)` chains all passes correctly
- [ ] Combined output is identical to original `normalize()` output

### Backward Compatibility

- [ ] `import { normalize } from '../graph/normalize'` works
- [ ] `import { NormalizedPatch } from '../graph/normalize'` works
- [ ] `import { getInputEdges, getOutputEdges } from '../graph/normalize'` works
- [ ] All existing code that imports from normalize.ts continues to work

### Error Handling

- [ ] Pass 0 and Pass 1 do NOT return errors
- [ ] Pass 2 collects `UnknownPort` errors
- [ ] Pass 3 collects `DanglingEdge`, `DuplicateBlockId` errors
- [ ] All errors collected before returning (not thrown on first)

### Type Safety

- [ ] `npm run typecheck` passes
- [ ] All pass functions have explicit input/output types
- [ ] No `any` types added

### Tests

- [ ] `npm run test` passes
- [ ] No test modifications required

### Build

- [ ] `npm run build` succeeds

### Compiler Unchanged

- [ ] No files in `src/compiler/` modified
- [ ] Compiler still imports from `src/graph/normalize`

---

## Verification Commands

```bash
npm run typecheck
npm run test
npm run build

# Verify compiler imports unchanged
grep -r "from.*graph/normalize" src/compiler/
```
