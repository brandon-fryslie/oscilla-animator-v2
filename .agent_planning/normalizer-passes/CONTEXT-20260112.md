# Implementation Context: Normalizer Pass Refactoring

**Date**: 2026-01-12
**Purpose**: Comprehensive context for implementing Pass 0 and Pass 1

---

## File Paths

### Files to Create

| File | Purpose |
|------|---------|
| `src/compiler/passes-v2/pass0-polymorphic-types.ts` | Pass 0: Polymorphic type resolution |
| `src/compiler/passes-v2/pass1-default-sources-adapters.ts` | Pass 1: Default sources + adapters + indexing |

### Files to Modify

| File | Changes |
|------|---------|
| `src/compiler/passes-v2/index.ts` | Add exports for Pass 0 and Pass 1 |
| `src/compiler/compile.ts` | Update pipeline to call Pass 0 + Pass 1 |
| `src/graph/normalize.ts` | Update to delegate to Pass 0 + Pass 1 |

---

## Source Extraction: Lines to Extract from normalize.ts

### For Pass 0 (`pass0-polymorphic-types.ts`)

Extract lines **181-273** from `src/graph/normalize.ts`:

```typescript
// Lines 181-273: resolvePolymorphicTypes function
function resolvePolymorphicTypes(patch: Patch): Patch {
  const updatedBlocks = new Map(patch.blocks);
  // ... (full implementation)
  return { blocks: updatedBlocks, edges: patch.edges };
}
```

**Key dependencies to import**:
- `Patch`, `Block` from `../../graph/Patch`
- `BlockId` from `../../types`
- `getBlockDefinition` from `../../blocks/registry`

### For Pass 1 (`pass1-default-sources-adapters.ts`)

Extract multiple sections from `src/graph/normalize.ts`:

1. **Type definitions** (lines 24-67):
   - `BlockIndex` branded type
   - `NormalizedPatch` interface
   - `NormalizedEdge` interface
   - `NormalizeResult` interface
   - `NormalizeError` interface
   - `NormError` type union

2. **Default source helpers** (lines 73-164):
   - `DefaultSourceInsertion` interface
   - `hasIncomingEdge()` function
   - `generateDefaultSourceId()` function
   - `analyzeDefaultSources()` function
   - `applyDefaultSourceInsertions()` function (lines 278-302)

3. **Adapter helpers** (lines 308-496):
   - `AdapterInsertion` interface
   - `generateAdapterId()` function
   - `getPortType()` function
   - `analyzeAdapters()` function
   - `applyAdapterInsertions()` function

4. **Indexing and normalization** (lines 502-580):
   - Block index building
   - Edge normalization
   - Edge sorting
   - Result construction

---

## Function Signatures

### Pass 0

```typescript
/**
 * Pass 0: Polymorphic Type Resolution
 *
 * Resolves '???' (polymorphic) types by propagating concrete types
 * bidirectionally through edges.
 *
 * @param patch - Raw patch from user/editor
 * @returns Patch with resolved payloadType params
 */
export function pass0PolymorphicTypes(patch: Patch): Patch
```

### Pass 1

```typescript
/**
 * Pass 1: Default Sources + Adapter Insertion + Indexing
 *
 * Combines three transformations:
 * 1. Materialize default sources (insert Const blocks)
 * 2. Insert adapters for type mismatches
 * 3. Build dense block index and convert edges
 *
 * @param patch - Patch with resolved polymorphic types (from Pass 0)
 * @returns NormalizeResult on success, NormalizeError on failure
 */
export function pass1DefaultSourcesAndAdapters(
  patch: Patch
): NormalizeResult | NormalizeError
```

---

## Import Statements

### pass0-polymorphic-types.ts

```typescript
import type { BlockId } from '../../types';
import type { Block, Patch } from '../../graph/Patch';
import { getBlockDefinition } from '../../blocks/registry';
```

### pass1-default-sources-adapters.ts

```typescript
import type { BlockId, PortId, BlockRole, DefaultSource } from '../../types';
import type { SignalType } from '../../core/canonical-types';
import type { Block, Edge, Patch } from '../../graph/Patch';
import { getBlockDefinition, type InputDef } from '../../blocks/registry';
import { findAdapter, type AdapterSpec } from '../../graph/adapters';
```

---

## Updated passes-v2/index.ts

Add these exports (around line 14, before Pass 2):

```typescript
// Pass 0: Polymorphic Type Resolution
export { pass0PolymorphicTypes } from "./pass0-polymorphic-types";

// Pass 1: Default Sources + Adapters + Indexing
export { pass1DefaultSourcesAndAdapters } from "./pass1-default-sources-adapters";
export type {
  BlockIndex,
  NormalizedPatch,
  NormalizedEdge,
  NormalizeResult,
  NormalizeError,
  NormError,
} from "./pass1-default-sources-adapters";
```

Update the header comment to list passes 0-8.

---

## Updated compile.ts

### Import Changes (around line 18)

**Before**:
```typescript
import { normalize, type NormalizedPatch } from '../graph/normalize';
```

**After**:
```typescript
import { pass0PolymorphicTypes, pass1DefaultSourcesAndAdapters } from './passes-v2';
import type { NormalizedPatch, NormError } from './passes-v2';
```

### Pipeline Changes (find the normalize() call)

**Before**:
```typescript
const normResult = normalize(patch);
```

**After**:
```typescript
// Pass 0: Polymorphic Type Resolution
const patchWithResolvedTypes = pass0PolymorphicTypes(patch);

// Pass 1: Default Sources + Adapters + Indexing
const normResult = pass1DefaultSourcesAndAdapters(patchWithResolvedTypes);
```

### Error Conversion Helper (add near compile function)

```typescript
/**
 * Convert NormError array to CompileError array.
 */
function convertNormErrorsToCompileErrors(errors: readonly NormError[]): CompileError[] {
  return errors.map((e) => {
    switch (e.kind) {
      case 'DanglingEdge':
        return {
          kind: e.kind,
          message: `Edge references missing block (${e.missing})`,
        };
      case 'DuplicateBlockId':
        return {
          kind: e.kind,
          message: `Duplicate block ID: ${e.id}`,
        };
      case 'UnknownBlockType':
        return {
          kind: e.kind,
          message: `Unknown block type: ${e.blockType}`,
        };
      case 'UnknownPort':
        return {
          kind: e.kind,
          message: `Unknown ${e.direction} port: ${e.portId}`,
        };
      case 'NoAdapterFound':
        return {
          kind: e.kind,
          message: `No adapter found: ${e.fromType} -> ${e.toType}`,
        };
    }
  });
}
```

---

## Updated normalize.ts (Backward Compatibility)

Replace the `normalize()` function body to delegate:

```typescript
import { pass0PolymorphicTypes } from '../compiler/passes-v2/pass0-polymorphic-types';
import { pass1DefaultSourcesAndAdapters } from '../compiler/passes-v2/pass1-default-sources-adapters';

// Keep all type exports - they're re-exported from pass1

export function normalize(patch: Patch): NormalizeResult | NormalizeError {
  // Pass 0: Resolve polymorphic types
  const patchWithResolvedTypes = pass0PolymorphicTypes(patch);

  // Pass 1: Default sources + adapters + indexing
  return pass1DefaultSourcesAndAdapters(patchWithResolvedTypes);
}

// Keep query helpers (getInputEdges, getOutputEdges) as-is
```

**Key decision**: Types will be exported from pass1-default-sources-adapters.ts, and normalize.ts will re-export them for backward compatibility.

---

## Type Flow Diagram

```
User Graph (Patch)
    │
    ▼ Pass 0: pass0PolymorphicTypes()
    │
Patch (with resolved payloadTypes)
    │
    ▼ Pass 1: pass1DefaultSourcesAndAdapters()
    │
NormalizedPatch (with indices)
    │
    ▼ Pass 2: pass2TypeGraph()
    │
TypedPatch
    │
    ▼ Pass 3-8: (unchanged)
```

---

## Gotchas and Edge Cases

### 1. Circular Import Prevention
Pass 0 and Pass 1 should NOT import from `src/graph/normalize.ts`. Import directly from:
- `src/types` for BlockId, PortId, etc.
- `src/graph/Patch` for Patch, Block, Edge types
- `src/blocks/registry` for getBlockDefinition
- `src/graph/adapters` for findAdapter

### 2. Type Branding
`BlockIndex` is a branded number type. Ensure the brand is preserved:
```typescript
export type BlockIndex = number & { readonly __brand: 'BlockIndex' };
```

### 3. Immutability
Both passes must return new objects, never mutate inputs:
- Pass 0: Creates new `Map(patch.blocks)` before modifying
- Pass 1: Creates new blocks/edges arrays

### 4. Deterministic Ordering
Pass 1 must maintain deterministic ordering:
- Blocks sorted by ID: `[...expandedPatch.blocks.keys()].sort()`
- Edges sorted by target then source

### 5. Error Collection
Pass 1 collects ALL errors before returning:
```typescript
if (errors.length > 0) {
  return { kind: 'error', errors };
}
```

---

## Verification Commands

```bash
npm run typecheck  # Must pass
npm run test       # Must pass
npm run build      # Must succeed
```

---

## Rollback Plan

If implementation fails:
1. Delete `pass0-polymorphic-types.ts` and `pass1-default-sources-adapters.ts`
2. Revert changes to `compile.ts`
3. Revert changes to `passes-v2/index.ts`
4. Keep `normalize.ts` unchanged

The original `normalize()` function will continue to work as before.
