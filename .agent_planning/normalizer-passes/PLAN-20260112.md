# Sprint Plan: Normalizer Pass Refactoring

**Date**: 2026-01-12
**Sprint Goal**: Extract the monolithic `normalize.ts` into explicit Pass 0 and Pass 1 files following the compiler pipeline pattern.

---

## Sprint Goal (One Sentence)

Refactor the 607-line `src/graph/normalize.ts` into two explicit pass files (`pass0-polymorphic-types.ts` and `pass1-default-sources-adapters.ts`) in `src/compiler/passes-v2/`, maintaining backward compatibility and all existing test behavior.

---

## Deliverables (2)

### D1: Pass 0 - Polymorphic Type Resolution
**File**: `src/compiler/passes-v2/pass0-polymorphic-types.ts`

Extract `resolvePolymorphicTypes()` from normalize.ts into a standalone pass that:
- Takes `Patch` as input
- Returns `Patch` with resolved `payloadType` params
- No structural changes (no blocks/edges added)
- No errors thrown (unresolved types stay as `'???'`)

### D2: Pass 1 - Default Sources + Adapters + Indexing
**File**: `src/compiler/passes-v2/pass1-default-sources-adapters.ts`

Extract phases 1-3 from normalize.ts into a combined pass that:
- Takes `Patch` (output of Pass 0) as input
- Returns `NormalizeResult | NormalizeError`
- Combines: default source materialization + adapter insertion + indexing
- Exports `NormError` type for error handling

---

## Out of Scope

- New functionality beyond what exists in normalize.ts
- Changes to `NormalizedPatch` or other IR types
- Fixpoint iteration for polymorphic type resolution
- 'rail' kind default source implementation
- New adapters or adapter rule changes
- Changes to downstream passes (Pass 2+)
- Test file reorganization

---

## Work Items

### WI-1: Create Pass 0 File
**Acceptance Criteria**:
- [ ] File exists at `src/compiler/passes-v2/pass0-polymorphic-types.ts`
- [ ] Exports `pass0PolymorphicTypes(patch: Patch): Patch`
- [ ] Logic extracted from `resolvePolymorphicTypes()` in normalize.ts (lines 181-273)
- [ ] All imports correctly resolved
- [ ] No errors thrown - unresolved types remain `'???'`

### WI-2: Create Pass 1 File
**Acceptance Criteria**:
- [ ] File exists at `src/compiler/passes-v2/pass1-default-sources-adapters.ts`
- [ ] Exports `pass1DefaultSourcesAndAdapters(patch: Patch): NormalizeResult | NormalizeError`
- [ ] Logic extracted from phases 1-3 in normalize.ts
- [ ] Exports `NormError`, `NormalizeResult`, `NormalizeError` types
- [ ] Exports `NormalizedPatch`, `NormalizedEdge`, `BlockIndex` types

### WI-3: Update compile.ts Pipeline
**Acceptance Criteria**:
- [ ] Import `pass0PolymorphicTypes` from passes-v2
- [ ] Import `pass1DefaultSourcesAndAdapters` from passes-v2
- [ ] Pipeline calls Pass 0 then Pass 1 instead of `normalize()`
- [ ] Error conversion from `NormError[]` to `CompileError[]` works correctly
- [ ] All existing tests pass

### WI-4: Update passes-v2/index.ts Exports
**Acceptance Criteria**:
- [ ] Export `pass0PolymorphicTypes` from pass0-polymorphic-types
- [ ] Export `pass1DefaultSourcesAndAdapters` from pass1-default-sources-adapters
- [ ] Export `NormError`, `NormalizeResult`, `NormalizeError` types
- [ ] Comment updated to list passes 0-8

### WI-5: Maintain Backward Compatibility
**Acceptance Criteria**:
- [ ] `src/graph/normalize.ts` still exports `normalize()` function
- [ ] `normalize()` internally calls Pass 0 + Pass 1
- [ ] All existing imports of `normalize` continue to work
- [ ] `npm run test` passes
- [ ] `npm run typecheck` passes
- [ ] `npm run build` succeeds

---

## Dependencies

1. **WI-1 must complete before WI-3** (compile.ts needs Pass 0)
2. **WI-2 must complete before WI-3** (compile.ts needs Pass 1)
3. **WI-1 and WI-2 can proceed in parallel**
4. **WI-4 can proceed after WI-1 and WI-2**
5. **WI-5 is verification after WI-3 and WI-4**

---

## Risks

| Risk | Likelihood | Impact | Mitigation |
|------|------------|--------|------------|
| Circular import between passes-v2 and graph | Low | Medium | Pass 0/1 import from types/core, not from graph |
| Helper functions not properly extracted | Medium | Low | Keep helpers inline in each pass file |
| Edge cases in polymorphic resolution | Low | Medium | Existing tests cover known cases |
| Error type mismatch with compile.ts | Low | Medium | Use explicit type conversion function |

---

## Verification

```bash
# Must all pass
npm run typecheck
npm run test
npm run build
```
