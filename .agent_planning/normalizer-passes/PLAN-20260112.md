# Sprint Plan: Graph Normalizer Pass Refactoring

**Date**: 2026-01-12
**Sprint Goal**: Refactor `src/graph/normalize.ts` into explicit pass modules within `src/graph/passes/`

---

## Sprint Goal (One Sentence)

Split the 607-line `src/graph/normalize.ts` into 4 focused pass files in `src/graph/passes/`, with an orchestrator and backward-compatible exports.

---

## Deliverables (2)

### D1: Pass Modules
Create 4 explicit pass files in `src/graph/passes/`:
- `pass0-polymorphic-types.ts` - Type inference
- `pass1-default-sources.ts` - Insert Const blocks
- `pass2-adapters.ts` - Insert adapter blocks
- `pass3-indexing.ts` - Build block index and normalize edges

### D2: Orchestrator + Backward Compatibility
- `passes/index.ts` - Orchestrates all passes, exports types
- Update `normalize.ts` - Thin wrapper with re-exports

---

## Out of Scope

- Changes to the compiler (`src/compiler/*`)
- New functionality
- Changes to `Patch`, `adapters.ts`, or other graph types
- Test file modifications
- Performance optimizations

---

## Work Items

### WI-1: Create Pass 0 - Polymorphic Types
**File**: `src/graph/passes/pass0-polymorphic-types.ts`

**Acceptance Criteria**:
- [ ] Exports `pass0PolymorphicTypes(patch: Patch): Patch`
- [ ] Logic extracted from lines 181-273 of normalize.ts
- [ ] No errors thrown (unresolved types stay `'???'`)

### WI-2: Create Pass 1 - Default Sources
**File**: `src/graph/passes/pass1-default-sources.ts`

**Acceptance Criteria**:
- [ ] Exports `pass1DefaultSources(patch: Patch): Patch`
- [ ] Logic extracted from lines 73-164, 278-302 of normalize.ts
- [ ] Inserts Const blocks for unconnected inputs with defaultSource

### WI-3: Create Pass 2 - Adapters
**File**: `src/graph/passes/pass2-adapters.ts`

**Acceptance Criteria**:
- [ ] Exports `pass2Adapters(patch: Patch): Pass2Result | Pass2Error`
- [ ] Logic extracted from lines 308-496 of normalize.ts
- [ ] Returns errors for `UnknownPort`, collects all before returning

### WI-4: Create Pass 3 - Indexing
**File**: `src/graph/passes/pass3-indexing.ts`

**Acceptance Criteria**:
- [ ] Exports `pass3Indexing(patch: Patch): Pass3Result | Pass3Error`
- [ ] Exports `NormalizedPatch`, `NormalizedEdge`, `BlockIndex` types
- [ ] Exports `getInputEdges()`, `getOutputEdges()` query helpers
- [ ] Logic extracted from lines 517-580 of normalize.ts
- [ ] Returns errors for `DanglingEdge`, `DuplicateBlockId`

### WI-5: Create Orchestrator
**File**: `src/graph/passes/index.ts`

**Acceptance Criteria**:
- [ ] Exports `runNormalizationPasses(patch: Patch): NormalizeResult | NormalizeError`
- [ ] Calls Pass 0 → Pass 1 → Pass 2 → Pass 3 in sequence
- [ ] Returns early on Pass 2 or Pass 3 errors
- [ ] Re-exports all pass functions and types

### WI-6: Update normalize.ts
**File**: `src/graph/normalize.ts`

**Acceptance Criteria**:
- [ ] Becomes thin wrapper (~20 lines)
- [ ] Re-exports `normalize` as alias for `runNormalizationPasses`
- [ ] Re-exports all types: `NormalizedPatch`, `NormalizedEdge`, `BlockIndex`, `NormError`, etc.
- [ ] Re-exports query helpers: `getInputEdges`, `getOutputEdges`
- [ ] All existing imports continue to work

### WI-7: Verification
**Acceptance Criteria**:
- [ ] `npm run typecheck` passes
- [ ] `npm run test` passes
- [ ] `npm run build` succeeds
- [ ] No changes to compiler files

---

## Dependencies

1. WI-1, WI-2, WI-3, WI-4 can proceed in parallel
2. WI-5 requires WI-1, WI-2, WI-3, WI-4
3. WI-6 requires WI-5
4. WI-7 is final verification

---

## Risks

| Risk | Likelihood | Impact | Mitigation |
|------|------------|--------|------------|
| Import cycles | Low | Medium | Passes import from ../Patch, not each other |
| Missing type exports | Medium | High | Verify all types re-exported from normalize.ts |
| Helper function duplication | Low | Low | Keep helpers local to each pass |

---

## Verification

```bash
npm run typecheck
npm run test
npm run build
```
