# Evaluation: Continuity System Fix

**Generated**: 2026-01-26T05:02:00
**Topic**: Continuity System Investigation and Fix
**Verdict**: CONTINUE

---

## Current State

### Test Failures

Two failing tests in `src/runtime/__tests__/continuity-integration.test.ts`:

1. **"blends old and new buffers linearly over time window"** (line 384)
   - Expected: `outputBuffer[0]` ≈ 10 (old value)
   - Actual: `outputBuffer[0]` = 100 (new base value)

2. **"uses smoothstep curve when specified"** (line 450)
   - Expected: `outputBuffer[0]` ≈ 0 (old value)
   - Actual: `outputBuffer[0]` = 100 (new base value)

### Root Cause Analysis

**PRIMARY BUG: Test Helper API Mismatch**

The `createMockRuntimeState` function in `src/__tests__/runtime-test-helpers.ts`:

```typescript
export function createMockRuntimeState(
  slotCount: number = 100,
  overrides?: Partial<RuntimeState>
): RuntimeState
```

But tests call it with an object as the first argument:

```typescript
const state = createMockRuntimeState({
  continuity,
  values: { objects: new Map() },
});
```

TypeScript compilation confirms this error:
```
TS2345: Argument of type '{ continuity: ContinuityState; values: ... }' is not assignable to parameter of type 'number'.
```

**Consequence**: The test's custom `continuity` state (with pre-populated `slewBuffer = [10, 20, 30]`) is NOT being used. Instead, `createRuntimeState(objectAsNumber)` creates a fresh runtime state with a brand new continuity object.

This means:
1. The test creates `continuity` and sets up `targetState.slewBuffer`
2. `createMockRuntimeState({continuity, ...})` passes the object as slotCount, ignores overrides
3. `createRuntimeState()` returns a fresh state with a different `continuity` object
4. When `applyContinuity` runs, `state.continuity` has no targets → `hadPreviousState = false`
5. Crossfade falls through to "no previous state" path → uses base values

### Type Errors in Test File

Additional type errors in `continuity-integration.test.ts`:
- Line 393: `InstanceId` not assignable to `StableTargetId`
- Lines 403-404: `number` not assignable to `ValueSlot`
- Lines 421, etc.: Type mismatches in lambda return types

---

## Existing Implementation Quality

The continuity system implementation (`ContinuityApply.ts`, `ContinuityState.ts`, `ContinuityMapping.ts`) appears well-designed:

| Component | Status | Notes |
|-----------|--------|-------|
| Slew filter | ✅ Working | Verified by passing tests |
| Additive gauge | ✅ Working | Verified by passing tests |
| Element mapping (byId, byPosition) | ✅ Working | 19 tests pass |
| State management | ✅ Working | Structure is correct |
| Crossfade policy | ⚠️ Possibly broken | Obscured by test bug |

The crossfade logic at lines 562-622 of `ContinuityApply.ts` may have issues, but the test helper bug is preventing proper validation.

---

## Work Required

### Sprint 1: Fix Test Infrastructure

1. **Fix `createMockRuntimeState` signature** - Change to accept overrides as first optional parameter
2. **Fix type errors in test file** - Use proper branded types (`StableTargetId`, `ValueSlot`)
3. **Verify crossfade tests pass** - After fixing infrastructure

### Sprint 2: Validate/Fix Crossfade Logic (if needed)

Only if tests still fail after Sprint 1:
1. Investigate `oldEffectiveSnapshot` capture logic
2. Ensure crossfade properly uses pre-existing slew buffer values
3. Add edge case tests

---

## Confidence Assessment

| Work Item | Confidence | Rationale |
|-----------|------------|-----------|
| Fix test helper API | HIGH | Clear signature mismatch, simple fix |
| Fix type errors in tests | HIGH | TypeScript errors guide the fix |
| Verify crossfade logic | MEDIUM | Need to see if tests pass after fix |

---

## Recommendation

Proceed with Sprint 1 (test infrastructure fixes). High confidence that this will resolve the failing tests. If crossfade tests still fail after, proceed to Sprint 2.
