# Plan: Add Auto-Arrange Layout to React Flow Editor

**Bead:** `oscilla-animator-v2-8fp`
**Date:** 2026-01-18
**Status:** PENDING APPROVAL

---

## Goal

Add automatic graph layout functionality to the React Flow editor using ELKjs, allowing users to arrange nodes in a clean left-to-right layered layout with a single click.

---

## Approach: ELKjs Library

**Decision:** Use `elkjs` (Eclipse Layout Kernel for JavaScript)

**Rationale:**
- More powerful layout algorithm for complex directed graphs
- Better optimization for graphs with dozens of nodes
- Supports layered layout with configurable direction, spacing
- Same algorithm Rete used (familiar results)
- React Flow has official ELKjs example

**Behavior:** On-demand only (user clicks button to trigger layout)

---

## Implementation Plan

### Step 1: Add Dependency

```bash
npm install elkjs
```

Note: elkjs includes TypeScript types, no separate @types package needed.

### Step 2: Create Layout Utility

**File:** `src/ui/reactFlowEditor/layout.ts`

```typescript
/**
 * Auto-arrange layout using ELKjs.
 * Computes node positions for a layered left-to-right graph.
 */
import ELK from 'elkjs/lib/elk.bundled.js';
import type { Node, Edge } from 'reactflow';

const elk = new ELK();

// Default node dimensions (can be overridden per-node)
const DEFAULT_NODE_WIDTH = 200;
const DEFAULT_NODE_HEIGHT = 120;

export interface LayoutOptions {
  direction?: 'RIGHT' | 'DOWN' | 'LEFT' | 'UP';
  nodeSpacing?: number;
  layerSpacing?: number;
}

const DEFAULT_OPTIONS: LayoutOptions = {
  direction: 'RIGHT',
  nodeSpacing: 100,
  layerSpacing: 80,
};

/**
 * Compute layout for React Flow nodes using ELK algorithm.
 * Returns new node array with updated positions.
 */
export async function getLayoutedElements(
  nodes: Node[],
  edges: Edge[],
  options: LayoutOptions = {}
): Promise<{ nodes: Node[]; edges: Edge[] }> {
  const { direction, nodeSpacing, layerSpacing } = { ...DEFAULT_OPTIONS, ...options };

  // Build ELK graph structure
  const elkGraph = {
    id: 'root',
    layoutOptions: {
      'elk.algorithm': 'layered',
      'elk.direction': direction,
      'elk.spacing.nodeNode': String(nodeSpacing),
      'elk.layered.spacing.nodeNodeBetweenLayers': String(layerSpacing),
      'elk.padding': '[top=20,left=20,bottom=20,right=20]',
    },
    children: nodes.map((node) => ({
      id: node.id,
      width: node.width ?? DEFAULT_NODE_WIDTH,
      height: node.height ?? DEFAULT_NODE_HEIGHT,
    })),
    edges: edges.map((edge) => ({
      id: edge.id,
      sources: [edge.source],
      targets: [edge.target],
    })),
  };

  // Run ELK layout algorithm
  const layoutedGraph = await elk.layout(elkGraph);

  // Map positions back to React Flow nodes
  const layoutedNodes = nodes.map((node) => {
    const elkNode = layoutedGraph.children?.find((n) => n.id === node.id);
    if (elkNode) {
      return {
        ...node,
        position: {
          x: elkNode.x ?? 0,
          y: elkNode.y ?? 0,
        },
      };
    }
    return node;
  });

  return { nodes: layoutedNodes, edges };
}
```

### Step 3: Update ReactFlowEditor

**File:** `src/ui/reactFlowEditor/ReactFlowEditor.tsx`

Add imports:
```typescript
import { Panel, useReactFlow } from 'reactflow';
import { getLayoutedElements } from './layout';
```

Add state for layout in progress:
```typescript
const [isLayouting, setIsLayouting] = React.useState(false);
const { fitView } = useReactFlow();
```

Add handler:
```typescript
const handleAutoArrange = useCallback(async () => {
  if (isLayouting) return;
  setIsLayouting(true);

  try {
    const { nodes: layoutedNodes } = await getLayoutedElements(nodes, edges);
    setNodes(layoutedNodes);
    // Fit view after layout completes
    setTimeout(() => fitView({ padding: 0.1 }), 50);
  } finally {
    setIsLayouting(false);
  }
}, [nodes, edges, setNodes, isLayouting, fitView]);
```

Add Panel with button:
```typescript
<Panel position="top-left" className="react-flow-panel">
  <button
    onClick={handleAutoArrange}
    disabled={isLayouting}
    className="auto-arrange-btn"
  >
    {isLayouting ? 'Arranging...' : 'Auto Arrange'}
  </button>
</Panel>
```

**Important:** Need to wrap in `ReactFlowProvider` for `useReactFlow` hook to work. Check if already wrapped or add wrapper.

### Step 4: Implement EditorHandle.autoArrange()

Update the handle creation to include autoArrange:

```typescript
const handle: ReactFlowEditorHandle = {
  // ... existing methods ...

  async autoArrange(): Promise<void> {
    await handleAutoArrange();
  },
};
```

Update interface:
```typescript
export interface ReactFlowEditorHandle {
  addBlock(blockId: BlockId, blockType: string): Promise<void>;
  removeBlock(blockId: BlockId): Promise<void>;
  zoomToFit(): Promise<void>;
  autoArrange(): Promise<void>;
}
```

### Step 5: Add Button Styling

**File:** `src/ui/reactFlowEditor/ReactFlowEditor.css`

```css
.react-flow-panel {
  background: rgba(0, 0, 0, 0.7);
  padding: 8px;
  border-radius: 4px;
  border: 1px solid rgba(255, 255, 255, 0.2);
}

.auto-arrange-btn {
  padding: 6px 12px;
  background: #333;
  color: #fff;
  border: 1px solid #666;
  border-radius: 4px;
  cursor: pointer;
  font-size: 12px;
  font-weight: 500;
  min-width: 100px;
}

.auto-arrange-btn:hover:not(:disabled) {
  background: #444;
  border-color: #888;
}

.auto-arrange-btn:active:not(:disabled) {
  background: #555;
}

.auto-arrange-btn:disabled {
  opacity: 0.6;
  cursor: not-allowed;
}
```

---

## Files Changed

| File | Change |
|------|--------|
| `package.json` | Add `elkjs` dependency |
| `src/ui/reactFlowEditor/layout.ts` | NEW - ELK layout utility |
| `src/ui/reactFlowEditor/ReactFlowEditor.tsx` | Add toolbar, handler, update handle |
| `src/ui/reactFlowEditor/ReactFlowEditor.css` | Add button styles |

---

## Out of Scope (Future Work)

- **Undo/redo of layout changes** - Tracked in `oscilla-animator-v2-8bi`
- **Persisting node positions** - Not needed with on-demand layout
- **Custom node dimensions per block type** - Uses default 200x120, can enhance later
- **Animation during layout transition** - Instant snap for now

---

## Verification

1. **Build passes:** `npm run typecheck && npm run build`
2. **Visual test:**
   - Open editor with multiple nodes
   - Click "Auto Arrange" button
   - Nodes should arrange left-to-right in layers
   - Button shows "Arranging..." while computing
   - View auto-fits after layout
3. **Handle works:** Call `editorHandle.autoArrange()` programmatically
4. **Performance:** Test with 20+ nodes, should complete in <1 second

---

## Sources

- [React Flow ELKjs Example](https://reactflow.dev/examples/layout/elkjs)
- [ELKjs Documentation](https://eclipse.dev/elk/)
