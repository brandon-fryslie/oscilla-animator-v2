# Evaluation: IR Type System Alignment

**Bead:** oscilla-animator-v2-eir
**Date:** 2026-01-20
**Verdict:** PAUSE (Ambiguities & Gaps)

## What Types Exist in Code (src/compiler/ir/types.ts)

### Signal Expressions (SigExpr)
- SigExprConst, SigExprSlot, SigExprTime, SigExprExternal, SigExprMap, SigExprZip, SigExprStateRead

### Field Expressions (FieldExpr)
- FieldExprConst, FieldExprIntrinsic, FieldExprBroadcast, FieldExprMap, FieldExprZip, FieldExprZipSig, FieldExprArray, FieldExprLayout

### Event Expressions (EventExpr)
- EventExprPulse, EventExprWrap, EventExprCombine, EventExprNever

### Pure Functions (PureFn)
- opcode-based (OpCode enum with 20+ operators), expr strings, kernel names

### Instance System
- InstanceDecl (with id, domainType, count, layout, lifecycle, identityMode)
- LayoutSpec (unordered, grid, circular, linear, random, along-path, custom)
- DomainInstance (with count, elementId, identityMode, posHintXY)

### Continuity System
- ContinuityPolicy (none, preserve, slew, crossfade, project)
- GaugeSpec (add, mul, affine, phaseOffset01)

### Schedule Steps
- StepEvalSig, StepMaterialize, StepRender, StepStateWrite, StepContinuityMapBuild, StepContinuityApply

### Time Model
- TimeModel (infinite with optional periods)

---

## What the Spec Requires

### From ESSENTIAL-SPEC.md (Compilation section)
- Schedule steps include: eval_scalar, eval_field, eval_event, state_read, state_write, combine, render
- Slot types: ScalarSlot, FieldSlot, EventSlot, StateSlot
- CompiledProgramIR with Schedule, stateSlots, fieldSlots, scalarSlots

### From 04-compilation.md (full spec)
- Domain declarations with shape variants: fixed_count, grid_2d, voices, mesh_vertices
- Type resolution with SignalType (payload + 5-axis Extent)
- Cycle validation using Tarjan's SCC
- Step types matching MVP schedule structure

### From 11-continuity-system.md
- ContinuityPolicy types, GaugeSpec, StepContinuityMapBuild, StepContinuityApply are all present
- Continuity targets, element mapping (byId, byPosition, identity)
- Field target keys with semantic role

### From 05-runtime.md
- StateSlot with scalar/array values
- FieldSlot with domain reference
- EventSlot with EventPayload buffers

---

## GAPS (Spec Requires But Code Doesn't Have)

1. **EventSlot type missing** - Not defined in types.ts, only referenced in comments. Spec 05-runtime requires it as runtime slot type.

2. **Domain shape variants missing** - Code has `InstanceDecl` but no `DomainDecl` or domain shape type (fixed_count, grid_2d, voices, mesh_vertices)

3. **Schedule interface missing** - Spec 04-compilation defines a full Schedule type with `{ steps, stateSlots, fieldSlots, scalarSlots }` but types.ts only has Step types

4. **StateSlotDecl, FieldSlotDecl, ScalarSlotDecl types missing** - Required by Schedule but not defined

5. **Step types incomplete** - Code has: EvalSig, Materialize, Render, StateWrite, ContinuityMapBuild, ContinuityApply. Spec shows additional types: eval_field, eval_event, combine

6. **MappingState type missing** - Spec 11-continuity-system.md ยง3.3 defines mapping types (identity, byId, byPosition) used by StepContinuityMapBuild

7. **Explicit error types missing** - Spec shows TypeError, GraphError structures but types.ts has none

---

## ORPHANS (Code Has But Spec Doesn't Explicitly Mention in IR)

1. **IntrinsicPropertyName union** - Spec mentions intrinsics abstractly but doesn't enumerate them in IR spec. (Documented in rules/compiler/intrinsics.md)

2. **FieldExprIntrinsic with instanceId** - Not explicitly mentioned in 04-compilation.md IR section

3. **FieldExprLayout with layoutSpec** - Present in code but spec 04-compilation doesn't show layout expressions in the Step/Op model

4. **FieldExprZipSig** - Combines fields + signals; not shown in 04-compilation IR model

5. **OpCode enum** - Detailed here but 04-compilation.md shows generic UnaryOp/BinaryOp/ReduceOp strings

6. **TimeModel.periodAMs, periodBMs** - Present in code, may be correct but not verified against time spec

7. **StepRender.size and shape as conditional slots** - Code structure is more complex than spec implies

---

## MISALIGNMENTS (Code Differs From Spec Semantics)

1. **Step variant naming** - Code uses camelCase (`StepEvalSig`) while spec 04-compilation shows snake_case (`eval_scalar`, `eval_field`). These should align.

2. **Slot references** - Code stores `ValueSlot` (branded type from Indices) but spec shows explicit types `ScalarSlot`, `FieldSlot`, `EventSlot`

3. **Domain representation** - Code uses string domainType in InstanceDecl, but spec defines DomainTypeId as distinct type and DomainDecl structures

4. **StepContinuityMapBuild.outputMapping** - Stored as string key, but spec ยง5.1 shows output mapping should be MappingState type

5. **FieldExprArray and FieldExprLayout** - Spec 04-compilation doesn't show these in lowered Op model; they're mid-level IR but not part of final schedule steps

---

## Questions for Clarification

1. **Step naming convention**: Should Step type names use snake_case (spec style) or camelCase (current style)?

2. **Field expression hierarchy**: Are FieldExprArray/Layout correct mid-level IR, or should they be materialization outputs rather than expressions?

3. **OpCode granularity**: Should OpCode be generic (UnaryOp/BinaryOp) or enumerated (current)?

4. **Slot type distinction**: Should code distinguish ScalarSlot/FieldSlot/EventSlot or continue with unified ValueSlot?

5. **Domain shape variants**: Are grid_2d, voices, mesh_vertices planned features or spec-only concepts?

---

## Recommended Actions

### HIGH Priority (Critical Gaps)
1. Define MappingState type for continuity mapping
2. Add Schedule interface with slot declaration arrays
3. Clarify Step naming convention (code vs spec)

### MEDIUM Priority (Alignment)
4. Add EventSlot type if needed by runtime
5. Verify FieldExpr hierarchy against final schedule
6. Document orphan types as implementation details vs spec deviations

### LOW Priority (Polish)
7. Add domain shape variants if planned for implementation
8. Add explicit error types (TypeError, GraphError)
9. Standardize naming convention across spec and code

---

## Files Referenced
- `/Users/bmf/code/oscilla-animator-v2/src/compiler/ir/types.ts` (453 lines)
- `/Users/bmf/code/oscilla-animator-v2/design-docs/CANONICAL-oscilla-v2.5-20260109/ESSENTIAL-SPEC.md`
- `/Users/bmf/code/oscilla-animator-v2/design-docs/CANONICAL-oscilla-v2.5-20260109/topics/04-compilation.md`
- `/Users/bmf/code/oscilla-animator-v2/design-docs/CANONICAL-oscilla-v2.5-20260109/topics/11-continuity-system.md`
- `/Users/bmf/code/oscilla-animator-v2/design-docs/CANONICAL-oscilla-v2.5-20260109/topics/05-runtime.md`
