Perfect. Now I have comprehensive raw facts. Let me create a structured summary:

---

## RAW FACTS: CanonicalType System Migration Readiness

### 1. CORE TYPE SYSTEM FILES

**File: `src/core/canonical-types.ts` (888 lines)**
- **Shape of CanonicalType**: `{ readonly payload: PayloadType; readonly extent: Extent; readonly unit: Unit }` (L559-563)
- **Payload Types**: 8 concrete kinds (float, int, bool, vec2, vec3, color, shape, cameraProjection) with intrinsic stride (L163-171)
- **Unit System**: Closed discriminated union with 16 kinds + var for unresolved (L32-48), NO OPTIONAL fields
- **Extent (5 axes)**:
  - Cardinality: zero | one | many(instanceRef) (L365-368)
  - Temporality: continuous | discrete (L401-403)
  - Binding: unbound | weak | strong | identity (L453-457)
  - Perspective: string ID or default (L519)
  - Branch: string ID or default (L520)
- **AxisTag Pattern**: Replaces optional fields with `{ kind: 'default' } | { kind: 'instantiated'; value: T }` (L300-302)
- **Invariants Documented**: Lines 14-16 explicitly state no optional fields, runtime erasure, single source of truth
- **NO TODO/FIXME/XXX comments** (verified L1-888)

**File: `src/compiler/ir/types.ts` (709 lines)**
- **SigExpr Union** (L84-94): 9 variants all carry `type: CanonicalType`
  - SigExprConst, SigExprSlot, SigExprTime, SigExprExternal, SigExprMap, SigExprZip, SigExprStateRead, SigExprShapeRef, SigExprReduceField, SigExprEventRead
- **FieldExpr Union** (L213-223): 10 variants, ALL carry `type: CanonicalType`
  - FieldExprConst, FieldExprIntrinsic, FieldExprBroadcast, FieldExprMap, FieldExprZip, FieldExprZipSig, FieldExprArray, FieldExprStateRead, FieldExprPathDerivative, FieldExprPlacement
- **EventExpr Union** (L323-328): 5 variants, **NONE carry type: CanonicalType** ‚ö†Ô∏è
  - EventExprConst (L330-333): only has `readonly fired: boolean`
  - EventExprPulse, EventExprWrap, EventExprCombine, EventExprNever
- **String Leakage**:
  - InstanceId defined in Indices.ts (L71), NOT core/ids.ts ‚ö†Ô∏è
  - Step types use `readonly instanceId: string` not `readonly instanceId: InstanceId`:
    - L540: StepMaterialize
    - L546: StepRender
    - L587: StepContinuityMapBuild
    - L598: StepContinuityApply
  - InstanceDecl (L435): `readonly id: string // InstanceId` (comment indicates string leakage)
  - StateMappingField (L681): `readonly instanceId: string`

**File: `src/compiler/ir/Indices.ts` (166 lines)**
- **Branded IDs Defined Here**:
  - InstanceId (L71): `string & { readonly __brand: 'InstanceId' }`
  - DomainTypeId (L65): `string & { readonly __brand: 'DomainTypeId' }`
  - Plus 12 other branded types (NodeIndex, PortIndex, ValueSlot, StateSlotId, etc.)
- **Problem**: Boundary violation ‚Äî core/canonical-types.ts cannot import these; they're in compiler IR module
- **Factory functions**: instanceId(), domainTypeId() defined L159-161

**File: `src/core/ids.ts` (45 lines) ‚Äî EXISTS but incomplete**
- ‚úÖ **PARTIAL IMPLEMENTATION**: Core IDs exist but NOT complete
- **Current exports**: CardinalityVarId, TemporalityVarId, BindingVarId, PerspectiveVarId, BranchVarId (L9-13), BlockId, PortId, WireId, KernelId (L18-22), ValueExprId, ValueSlot (L24-25)
- **Missing from canonical-types.ts**: InstanceId, DomainTypeId should be here, not in Indices.ts
- **No TODO comments indicating status** ‚úì

---

### 2. GAP ANALYSIS DOCUMENTS

**File: `.agent_planning/gap-analysis/SUMMARY.md` (302 lines) ‚Äî FINAL STATE**

**8 Critical Items (C-1 through C-8)**:

| # | Item | Status | Evidence | Blocked By |
|---|------|--------|----------|-----------|
| **C-1** | EventExpr Typing | ‚ùå NOT DONE | L323-354 in types.ts: no type field | none (P1) |
| **C-2** | Shared IDs Module | ‚ö†Ô∏è PARTIAL | ids.ts exists but InstanceId not migrated | none (P1) |
| **C-3** | reduce_field Naming | ‚ùå NOT DONE | L167 in types.ts: `'reduce_field'` (snake_case) | none (P1) |
| **C-4** | Axis Enforcement | ‚ùå NOT DONE | No validation pass exists | C-1 |
| **C-5** | Remove instanceId from FieldExpr | ‚ùå NOT DONE | L265, 273, 282: `instanceId?: InstanceId` | C-1, C-2 |
| **C-6** | Fix string leakage in Steps | ‚ùå NOT DONE | L540, 546, 587, 598: `instanceId: string` | C-2 |
| **C-7** | Delete FieldExprArray | ‚ùå NOT DONE | L285-289: no semantics/backing | none (P1) |
| **C-8** | ConstValue Discriminated Union | ‚ùå NOT DONE | No ConstValue type in impl, but spec exists | C-5 |

**Dependency Graph** (SUMMARY.md L95-106):
```
C-2 (shared IDs) ‚îÄ‚îÄenables‚îÄ‚îÄ> C-5 (remove instanceId, add getManyInstance)
                 ‚îÄ‚îÄenables‚îÄ‚îÄ> C-6 (fix string leakage)

C-1 (EventExpr typing) ‚îÄ‚îÄenables‚îÄ‚îÄ> C-4 (axis enforcement)
                       ‚îÄ‚îÄenables‚îÄ‚îÄ> C-5

C-4 (axis enforcement) ‚îÄ‚îÄGATES‚îÄ‚îÄ> U-1 (ValueExpr IR ‚Äî must not start until C-4 passing)
```

---

### 3. SPECIFICATION DOCUMENTS (Key Excerpts)

**File: `design-docs/canonical-types/00-exhaustive-type-system.md` (authoritative reference)**
- Defines core/ids.ts structure (L1-45) with complete branded ID table
- Specifies ConstValue as discriminated union (L275-293): keyed by payload.kind, NOT `number|string|boolean`
- Example: `{ readonly kind: 'vec2'; readonly value: readonly [number, number] }`
- Defines getManyInstance helper (L230-235): extracts InstanceRef from type or returns null
- No TODO indicators found in spec

**File: `design-docs/canonical-types/15-FiveAxesTypeSystem-Conclusion.md` (FINAL CONTRACT)**
- **5 Hard Invariants** (L69-100):
  - **I1. Single authority**: No field duplicates type authority (e.g., `FieldExprMap.instanceId` forbidden)
  - **I2. Only explicit ops change axes**: Perspective/branch/cardinality/temporality/binding changes must be explicit blocks
  - **I3. Axis enforcement is centralized**: Exactly one canonical frontend validation gate after normalization, inference, type assignment
  - **I4. State scoped by axes**: Storage keyed by branch and instance lane identity
  - **I5. Const literal shape matches payload**: ConstValue must be discriminated union keyed by payload kind
- **Axis Meanings** (L18-51): Cardinality only place instance identity lives; temporality distinguishes discrete events
- **12 Common Traps** (L103-128): T1 warns against storing instanceId for convenience, T2 warns events need temporality=discrete enforcement

**File: `design-docs/canonical-types/10-RulesForNewTypes.md` (12 Rules)**
- Rule 1: Only one semantic type carrier (CanonicalType)
- Rule 2: No "signal/field/event" in names or enums
- Rule 5: Payload and unit inseparable contracts
- Rule 6: Literal representation must be payload-shaped (discriminated union)
- Rule 7: Don't store derived info in CanonicalType
- Rule 12: New type work isn't done until used end-to-end

---

### 4. EVENTEXPR IMPLEMENTATION (C-1 Focus)

**Current State** (`src/compiler/ir/types.ts:323-354`):
```typescript
export type EventExpr =
  | EventExprConst          // L324
  | EventExprPulse
  | EventExprWrap
  | EventExprCombine
  | EventExprNever;

export interface EventExprConst {
  readonly kind: 'const';
  readonly fired: boolean;    // ‚ö†Ô∏è NO type field
}

export interface EventExprPulse {
  readonly kind: 'pulse';
  readonly source: 'timeRoot';  // ‚ö†Ô∏è NO type field
}

export interface EventExprWrap {
  readonly kind: 'wrap';
  readonly signal: SigExprId;    // ‚ö†Ô∏è NO type field
}

export interface EventExprCombine {
  readonly kind: 'combine';
  readonly events: readonly EventExprId[];
  readonly mode: 'any' | 'all';  // ‚ö†Ô∏è NO type field
}

export interface EventExprNever {
  readonly kind: 'never';        // ‚ö†Ô∏è NO type field
}
```

**Required by spec** (SUMMARY.md L61):
```typescript
// MUST add type: CanonicalType with HARD INVARIANTS:
type.payload.kind === 'bool'           // fired/not-fired only
type.unit.kind === 'none'              // events don't have units
type.extent.temporality === discrete   // DEFINITION OF EVENT
// cardinality may be one OR many(instance)
```

**NOT FOUND**: getManyInstance helper does not exist in implementation ‚ö†Ô∏è

---

### 5. IDS MODULE STATUS (C-2 Focus)

**File exists**: `src/core/ids.ts` ‚úì
- **Current exports** (lines 1-45):
  - CardinalityVarId, TemporalityVarId, BindingVarId, PerspectiveVarId, BranchVarId (axis variables)
  - BlockId, PortId, WireId, KernelId
  - ValueExprId (numeric), ValueSlot (numeric)
  - ‚úÖ instanceId factory function (L34)
  - ‚úÖ domainTypeId factory function (L35)

**Problem**: InstanceId and DomainTypeId types are **not exported from core/ids.ts** ‚ùå
- They're defined in `src/compiler/ir/Indices.ts:65-71` instead
- canonical-types.ts uses string not branded type (L344: `readonly instanceId: string`)

**Current import from canonical-types** (types.ts L20):
```typescript
import type { CanonicalType } from '../../core/canonical-types';
// canonical-types.ts L1 imports from core/ not compiler
```

---

### 6. FIELD NAMING (C-3 Focus)

**Search Results**: 17 matches for `reduce_field` | `reduceField`

| Location | Context | Count |
|----------|---------|-------|
| src/runtime/SignalEvaluator.ts | Opcode/operation | 1 |
| src/runtime/__tests__/reduce-op.test.ts | Test | 11 |
| design-docs/* | Design/planning | 3 |
| types.ts + planning files | Implementation + planning | 2 |

**Evidence of snake_case usage** (`src/compiler/ir/types.ts:166-170`):
```typescript
export interface SigExprReduceField {
  readonly kind: 'reduce_field';  // ‚ö†Ô∏è INCONSISTENT: all others are camelCase
  readonly field: FieldExprId;
  readonly op: 'min' | 'max' | 'sum' | 'avg';
  readonly type: CanonicalType;
}
```

---

### 7. AXIS ENFORCEMENT (C-4 Focus)

**Current State**: ‚ùå **NO VALIDATION PASS EXISTS**
- No file found with "axis.*validation" or "axis.*checker" pattern
- No diagnostic type for `AxisInvalid` found
- Validation files exist in `src/compiler/passes-v2/` but not for axes:
  - cardinality-specialization.test.ts
  - unit-validation.test.ts (units, not axes)
  - payload-validation.test.ts (payload, not axes)

**Spec Requirement** (SUMMARY.md L69, 00-exhaustive.md L394-461):
- Pure checker, axis-shape validity ONLY
- MUST check: axis-shape per expression family (Sig/Field/Event)
- MUST NOT: type inference, adapter insertion, scheduling, coercions
- Output: Single diagnostic category `AxisInvalid`

---

### 8. INSTANCEID IN FIELDEXPR (C-5 Focus)

**FieldExprIntrinsic** (L235-240):
```typescript
export interface FieldExprIntrinsic {
  readonly kind: 'intrinsic';
  readonly instanceId: InstanceId;  // ‚úì REQUIRED (needed for intrinsic value lookup)
  readonly intrinsic: IntrinsicPropertyName;
  readonly type: CanonicalType;
}
```

**FieldExprMap** (L260-266):
```typescript
export interface FieldExprMap {
  readonly kind: 'map';
  readonly input: FieldExprId;
  readonly fn: PureFn;
  readonly type: CanonicalType;
  readonly instanceId?: InstanceId;  // ‚ö†Ô∏è OPTIONAL DUPLICATION
}
```

**FieldExprZip** (L268-274):
```typescript
export interface FieldExprZip {
  readonly kind: 'zip';
  readonly inputs: readonly FieldExprId[];
  readonly fn: PureFn;
  readonly type: CanonicalType;
  readonly instanceId?: InstanceId;  // ‚ö†Ô∏è OPTIONAL DUPLICATION
}
```

**FieldExprZipSig** (L276-283):
```typescript
export interface FieldExprZipSig {
  readonly kind: 'zipSig';
  readonly field: FieldExprId;
  readonly signals: readonly SigExprId[];
  readonly fn: PureFn;
  readonly type: CanonicalType;
  readonly instanceId?: InstanceId;  // ‚ö†Ô∏è OPTIONAL DUPLICATION
}
```

**Problem**: Duplicates authority from `type.extent.cardinality` (which already contains instance via many(instanceRef))

**Spec Fix** (SUMMARY.md L70-76):
1. REMOVE instanceId from FieldExprMap/Zip/ZipSig
2. Add `getManyInstance(type)` helper (currently does NOT exist in impl)
3. Enforce: FieldExprMap output cardinality = input cardinality

---

### 9. STRING LEAKAGE (C-6 Focus)

**In types.ts** (InstanceId should replace all of these):

| Location | Current Type | Target |
|----------|--------------|--------|
| L237 | InstanceId | ‚úì Correct type |
| L248 | InstanceId | ‚úì Correct type |
| L265 | InstanceId? | ‚úì Correct type (but optional) |
| L273 | InstanceId? | ‚úì Correct type (but optional) |
| L282 | InstanceId? | ‚úì Correct type (but optional) |
| L287 | InstanceId | ‚úì Correct type |
| L298 | InstanceId | ‚úì Correct type |
| L435 | string | ‚ùå Should be InstanceId |
| L540 | string | ‚ùå Should be InstanceId |
| L546 | string | ‚ùå Should be InstanceId |
| L587 | string | ‚ùå Should be InstanceId |
| L598 | string | ‚ùå Should be InstanceId |
| L681 | string | ‚ùå Should be InstanceId |

**Count**: 5 instances of `readonly instanceId: string // InstanceId` (comment indicates intent)

---

### 10. FIELDEXPRARRAY STATUS (C-7 Focus)

**Exists**: YES, `src/compiler/ir/types.ts:285-289`

```typescript
export interface FieldExprArray {
  readonly kind: 'array';
  readonly instanceId: InstanceId;
  readonly type: CanonicalType;
}
```

**Problem**: No defined semantics
- No slot/channel/state backing reference
- No lifetime rules
- No storage contract
- **Status**: Placeholder marked for deletion (DEFERRED in `.agent_planning/render-pipeline-cleanup/DEFERRED-ms5.12-FieldExprArray.md`)

**Spec Directive** (SUMMARY.md L64): Delete until it has concrete backing store, lifetime rules, runtime storage contract

**Search Results**: 12 matches for `FieldExprArray`
- 2 in types.ts (definition + union member)
- 10 in planning/design docs (planning context only, not used in actual IR)

---

### 11. CONSTVALUE STRUCTURE (C-8 Focus)

**NOT FOUND in implementation** ‚ùå

**Spec Definition** (`design-docs/canonical-types/00-exhaustive-type-system.md:293-300`):
```typescript
export type ConstValue =
  | { readonly kind: 'float'; readonly value: number }
  | { readonly kind: 'int'; readonly value: number }
  | { readonly kind: 'bool'; readonly value: boolean }
  | { readonly kind: 'vec2'; readonly value: readonly [number, number] }
  | { readonly kind: 'vec3'; readonly value: readonly [number, number, number] }
  | { readonly kind: 'color'; readonly value: readonly [number, number, number, number] }
  | { readonly kind: 'cameraProjection'; readonly value: string };

export function constValueMatchesPayload(payload: PayloadType, v: ConstValue): boolean {
  return payload.kind === v.kind;
}
```

**Current Implementation** (`src/compiler/ir/types.ts:98`):
```typescript
export interface SigExprConst {
  readonly kind: 'const';
  readonly value: number | string | boolean;  // ‚ö†Ô∏è LOOSE UNION
  readonly type: CanonicalType;
}
```

**Problem**: Value type disconnected from payload; should be discriminated union keyed by payload kind

---

### 12. TEST COVERAGE

**Test Files for Canonical Types**:
- `src/core/__tests__/canonical-types.test.ts` (100+ lines) ‚Äî tests AxisTag, Cardinality, Temporality, Binding, Extent, CanonicalType construction and unification
- `src/compiler/ir/__tests__/hash-consing.test.ts` ‚Äî tests IR expression hash consistency
- `src/compiler/ir/__tests__/bridges.test.ts` ‚Äî tests adapter insertion

**Missing**:
- ‚ùå No tests for EventExpr typing invariants
- ‚ùå No tests for axis enforcement
- ‚ùå No tests for getManyInstance helper (doesn't exist)
- ‚ùå No tests validating ConstValue discrimination
- ‚úì Tests exist for unification, construction, helpers

**Test Quality**: Tests verify happy paths and constructor semantics, NOT invariant violation detection

---

### 13. RECENT CHANGES & WIP INDICATORS

**No TODO/FIXME/XXX in core files** ‚úì
- `src/core/canonical-types.ts`: 0 TODO indicators
- `src/compiler/ir/types.ts`: 0 TODO indicators
- `src/core/ids.ts`: 0 TODO indicators

**Deferred Work** (planning files indicate):
- `.agent_planning/render-pipeline-cleanup/DEFERRED-ms5.12-FieldExprArray.md` ‚Äî FieldExprArray marked for deferred deletion
- `.agent_planning/gap-analysis/SUMMARY.md` ‚Äî 8 critical items explicitly listed with P1/P2/P3/P4 priority

**Migration Status**: Infrastructure 60% complete (CanonicalType exists, UnitSystem exists, Extent 5-axes exist), but integration 0% complete (EventExpr untyped, validation pass missing, type authority duplication unfixed)

---

## SUMMARY TABLE: MIGRATION READINESS

| Item | Status | Evidence | Severity |
|------|--------|----------|----------|
| **CanonicalType shape** | ‚úÖ DONE | payload + extent + unit, all 3 required | ‚Äî |
| **PayloadType (8 kinds)** | ‚úÖ DONE | FLOAT, INT, BOOL, VEC2, VEC3, COLOR, SHAPE, CAMERA_PROJECTION | ‚Äî |
| **Unit system (16 kinds)** | ‚úÖ DONE | No optional fields, discriminated union | ‚Äî |
| **5-axis Extent** | ‚úÖ DONE | All 5 axes defined with proper semantics | ‚Äî |
| **SigExpr typing** | ‚úÖ DONE | 10 variants, all carry type: CanonicalType | ‚Äî |
| **FieldExpr typing** | ‚úÖ DONE | 10 variants, all carry type: CanonicalType | ‚Äî |
| **EventExpr typing** | ‚ùå **CRITICAL** | 5 variants, NONE carry type: CanonicalType | P1-BLOCKER |
| **Shared IDs (core/ids.ts)** | ‚ö†Ô∏è PARTIAL | File exists but InstanceId/DomainTypeId not there | P1-BLOCKER |
| **reduce_field naming** | ‚ùå INCONSISTENT | snake_case vs camelCase everywhere else | P1-COSMETIC |
| **Axis validation pass** | ‚ùå MISSING | No checker exists | P2-BLOCKER |
| **FieldExpr.instanceId removal** | ‚ùå NOT STARTED | 3 fields still optional duplicate | P2-DEPENDENT |
| **String‚ÜíInstanceId migration** | ‚ùå NOT STARTED | 5 Step fields still using string | P2-DEPENDENT |
| **FieldExprArray deletion** | ‚ùå NOT STARTED | Marked deferred, still in union | P1-NO-DEP |
| **ConstValue discrimination** | ‚ùå NOT STARTED | No impl; spec exists | P2-DEPENDENT |
| **getManyInstance helper** | ‚ùå NOT IMPLEMENTED | Spec defines, impl missing | P2-DEPENDENT |
| **EventExpr hard invariants** | üìã SPECIFIED | Payload=bool, unit=none, temporality=discrete (spec L61-65) | P1-REQUIREMENT |

---

**CONCLUSION**: Infra ~60% complete, integration 0% complete. All P1 items are blocking. No TODO comments indicating partial work. System is ready for phased migration starting with C-2, C-7, C-1 in parallel.
