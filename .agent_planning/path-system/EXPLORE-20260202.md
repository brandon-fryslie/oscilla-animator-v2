# Explore: Path System
Timestamp: 2026-02-02

## Files Examined

### Block Definitions
- `src/blocks/shape/path-field.ts` - PathField block (tangent, arcLength, position, index outputs)
- `src/blocks/shape/procedural-polygon.ts` - ProceduralPolygon block (regular polygon with N sides)
- `src/blocks/shape/procedural-star.ts` - ProceduralStar block (star with N points)
- `src/blocks/shape/ellipse.ts` - Ellipse block (exists, not examined in detail)
- `src/blocks/shape/rect.ts` - Rect block (exists, not examined in detail)
- `src/blocks/shape/index.ts` - Shape blocks barrel export

### IR/Compiler
- `src/compiler/ir/value-expr.ts` - ValueExpr union type, includes pathDerivative as KernelId variant
- `src/compiler/ir/IRBuilderImpl.ts` - pathDerivative builder at line 208-210
- `src/compiler/ir/IRBuilder.ts` - pathDerivative interface at line 90
- `src/compiler/backend/schedule-program.ts` - pathDerivative dependency tracking at line 812-813
- `src/compiler/resolve-kernels.ts` - pathDerivative explicitly skipped (no PureFn), line 96

### Runtime
- `src/runtime/ValueExprMaterializer.ts` - fillBufferTangent (line 710-741), fillBufferArcLength (line 761-788)
  - pathDerivative case at line 525-537
  - NO topology access in pathDerivative path
  - Input is vec2 field, output tangent is vec3 (stride 3), output arcLength is float (stride 1)

### Shapes
- `src/shapes/types.ts` - PathTopologyDef with verbs, pointsPerVerb, totalControlPoints, closed
- `src/shapes/registry.ts` - Dynamic topology registration (IDs 100+), built-in ellipse/rect (IDs 0-1)

### Rendering
- Canvas2DRenderer handles all 5 verb types: MOVE, LINE, CUBIC, QUAD, CLOSE
- SVGRenderer handles all 5 verb types
- Both already support bezier curves in rendering

### Tests
- `src/blocks/__tests__/path-field.test.ts` - 13 tests, all passing
  - CRITICAL: Tests duplicate the algorithm locally instead of testing production code
  - Test fillBufferTangent uses stride 2 (vec2 output)
  - Production fillBufferTangent uses stride 3 (vec3 output with z=0)
  - Tests would pass even if production code is wrong/deleted

### Spec
- ESSENTIAL-SPEC.md references PathGeometryTemplate, DrawPathInstancesOp, PathTopologyDef
- Renderer spec (06-renderer.md) defines verbs including CUBIC and QUAD
- No specific spec section dedicated to path derivatives/tangent/arcLength
- PathTopologyDef glossary: "Immutable structural definition of a path shape - the verbs (move, line, quad, cubic, close) and their arities"

## Key Observations

1. pathDerivative ValueExpr has NO topology reference - only `field: ValueExprId` and `op: 'tangent' | 'arcLength'`
2. materializer processes pathDerivative with only control point data, no verb/topology info
3. Both ProceduralPolygon and ProceduralStar only produce LINE paths (no bezier verbs)
4. Renderers already handle CUBIC/QUAD verbs - rendering path is ready for beziers
5. No blocks exist that produce bezier path topologies
6. Test-production code divergence: tests use their own implementation, not the real one
