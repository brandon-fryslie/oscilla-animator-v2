# Sprint Plan: Dual Editor Implementation (ReactFlow + Rete)

**Generated:** 2026-01-13 21:45
**Topic:** dual-editor-reactflow

---

## Sprint Goal

Implement a ReactFlow-based editor alongside the existing Rete.js editor with shared abstractions, allowing comparison of both libraries.

---

## Scope

### In Scope (This Sprint)

**P0: Directory Restructure + EditorHandle Abstraction**
- Rename `src/ui/editor/` → `src/ui/reteEditor/`
- Create `src/ui/editorCommon/` with generic EditorHandle interface
- Update imports in App.tsx, BlockLibrary.tsx, BlockLibrary.test.tsx
- ReteEditor implements generic EditorHandle

**P1: ReactFlow Editor Core**
- Install `reactflow` package
- Create `src/ui/reactFlowEditor/` with core component
- Implement pan/zoom, node drag, add/delete, connections
- ReactFlowEditor implements generic EditorHandle

**P2: Tab Integration + PatchStore Sync**
- Rename 'Editor' tab to 'Rete Editor'
- Add 'Flow Editor' tab
- Bidirectional PatchStore sync for ReactFlow
- BlockLibrary works with either editor

### Out of Scope (Defer)

- ReactFlow minimap
- ReactFlow auto-layout
- ReactFlow undo/redo
- Custom node styling
- Performance optimization

---

## Work Items

### P0: Directory Restructure + EditorHandle Abstraction

**Step 1: Create editorCommon module**

Create `src/ui/editorCommon/EditorHandle.ts`:
```typescript
import type { BlockId } from '../../types';

export interface EditorHandle {
  readonly type: 'rete' | 'reactflow';
  addBlock(blockId: BlockId, blockType: string): Promise<void>;
  removeBlock(blockId: BlockId): Promise<void>;
  zoomToFit(): Promise<void>;
  autoArrange?(): Promise<void>;
  getRawHandle(): unknown;
}
```

Create `src/ui/editorCommon/EditorContext.tsx`:
- Generic provider using `EditorHandle` interface
- `useEditor()` hook returns generic handle

Create `src/ui/editorCommon/index.ts`:
- Export EditorHandle, EditorProvider, useEditor

**Step 2: Rename editor → reteEditor**
```bash
git mv src/ui/editor src/ui/reteEditor
```

**Step 3: Create ReteEditorHandle adapter**

Update ReteEditor.tsx to create adapter implementing EditorHandle.

**Step 4: Update imports**

| File | Update |
|------|--------|
| App.tsx | `../../editor` → `../../reteEditor` + `../../editorCommon` |
| BlockLibrary.tsx | Use generic `editorHandle.addBlock()` |
| BlockLibrary.test.tsx | `../../editor/EditorContext` → `../../editorCommon` |

---

### P1: ReactFlow Editor Core

**Step 1: Install ReactFlow**
```bash
npm install reactflow
```

**Step 2: Create directory structure**
```
src/ui/reactFlowEditor/
├── ReactFlowEditor.tsx
├── ReactFlowEditor.css
├── sync.ts
├── nodes.ts
└── index.ts
```

**Step 3: Implement ReactFlowEditor.tsx**
- Use `useNodesState`, `useEdgesState` hooks
- Implement pan/zoom (native)
- Handle node drag, delete
- Handle connection create/delete
- Create EditorHandle adapter

**Step 4: Implement sync.ts**
- `syncPatchToReactFlow()` - Load PatchStore into ReactFlow
- `setupPatchToReactFlowReaction()` - MobX reaction for changes
- Use `isSyncing` guard pattern

---

### P2: Tab Integration + Sync

**Step 1: Add tabs in App.tsx**
```typescript
{ id: 'rete-editor', label: 'Rete', component: ReteEditor },
{ id: 'flow-editor', label: 'Flow', component: ReactFlowEditor },
```

**Step 2: Update BlockLibrary**
```typescript
// Use generic interface
editorHandle.addBlock(blockId, type.type);
```

**Step 3: Verify bidirectional sync**
- Changes in Rete → appear in ReactFlow
- Changes in ReactFlow → appear in Rete
- No sync loops

---

## Files Summary

### Create
- `src/ui/editorCommon/EditorHandle.ts`
- `src/ui/editorCommon/EditorContext.tsx`
- `src/ui/editorCommon/index.ts`
- `src/ui/reactFlowEditor/ReactFlowEditor.tsx`
- `src/ui/reactFlowEditor/ReactFlowEditor.css`
- `src/ui/reactFlowEditor/sync.ts`
- `src/ui/reactFlowEditor/nodes.ts`
- `src/ui/reactFlowEditor/index.ts`

### Rename
- `src/ui/editor/` → `src/ui/reteEditor/`

### Modify
- `src/ui/components/app/App.tsx`
- `src/ui/components/BlockLibrary.tsx`
- `src/ui/components/__tests__/BlockLibrary.test.tsx`
- `src/ui/reteEditor/ReteEditor.tsx`
- `src/ui/reteEditor/index.ts`

---

## Dependencies

```bash
npm install reactflow
```

---

## Risks

| Risk | Mitigation |
|------|------------|
| Import path breaks | Run typecheck after each step |
| Sync loops | Use isSyncing guard in both editors |
| ReactFlow version incompatibility | Use stable v11.x |

---

## Success Criteria

1. Both tabs visible (Rete, Flow)
2. Both editors render nodes from PatchStore
3. Add/delete/connect works in both
4. Tab switching preserves state
5. `npm run typecheck` passes
6. `npm run test` passes
