# Sprint Plan: UI Store Wiring - React Conversion

**Generated**: 2026-01-10 20:00
**Topic**: ui-store-wiring
**Source**: TODO-ui-store-wiring.md

## Current State

### Existing Infrastructure
- **MobX Stores**: RootStore, PatchStore, SelectionStore, ViewportStore, PlaybackStore, DiagnosticsStore (all complete)
- **React Context**: StoreProvider, useStores, useStore hooks available
- **Working React Components**: ConnectionMatrix.tsx, InspectorContainer.tsx

### Problem: Dual Selection State
There is a **custom SelectionState singleton** at `src/ui/state/selection.ts` that predates the MobX stores. Components currently use this instead of `rootStore.selection`. This needs to be reconciled.

### Components Requiring Conversion

| Component | Current | Conversion Effort |
|-----------|---------|-------------------|
| BlockInspector.ts | Vanilla DOM class | Medium |
| BlockLibrary.ts | Vanilla DOM class | Medium |
| TableView.ts | Vanilla DOM class | Medium-High |
| DomainsPanel.ts | Vanilla DOM class | Low |
| ConnectionMatrixWrapper.ts | Wrapper for React | Delete after wiring |
| TabbedContent.ts | Vanilla framework | Keep as-is |

---

## Sprint Goal

Convert vanilla DOM components to React with MobX observer pattern. Wire all UI interactions through rootStore. Enable functional editing workflow (add blocks, select, inspect).

---

## Scope

**In scope:**
1. Migrate SelectionState to use rootStore.selection (or reconcile)
2. Convert DomainsPanel to React
3. Convert BlockLibrary to React with addBlock wiring
4. Convert BlockInspector to React with selection observation
5. Convert TableView to React with selection wiring
6. Wire main.ts to render React component tree
7. Delete ConnectionMatrixWrapper (use ConnectionMatrix directly)

**Out of scope:**
- Keyboard shortcuts (Delete key)
- Context menus
- Edge creation UI
- Param editing (beyond display)
- Auto-recompile on patch changes (deferred)

---

## Architecture Decisions

### Decision 1: Selection State Strategy
**Options:**
- A) Migrate SelectionState to use rootStore.selection under the hood
- B) Delete SelectionState, update all usages to rootStore.selection directly
- C) Keep both, sync them

**Recommendation: Option B** - Delete the custom SelectionState, use rootStore.selection directly. The custom singleton is redundant now that SelectionStore exists.

### Decision 2: Component Mounting Strategy
**Options:**
- A) Keep main.ts vanilla, use React roots for each component
- B) Make main.ts render a React app root, compose components in React

**Recommendation: Option A initially** - Minimize blast radius. Each component gets its own React root. This allows incremental conversion. Later, can consolidate to single React root.

### Decision 3: TabbedContent
**Keep as vanilla** - It's a layout orchestrator that manages DOM containers. React components can render into its containers via React roots. Converting it offers little value and high risk.

---

## Work Items

### Phase 0: Foundation

#### 0.1: Reconcile Selection State
**Goal**: Single source of truth for selection

**Tasks:**
1. Compare `src/ui/state/selection.ts` with `src/stores/SelectionStore.ts`
2. Identify any functionality in SelectionState not in SelectionStore
3. Migrate any missing functionality to SelectionStore
4. Update `getSelectionState()` to return an adapter that uses rootStore.selection
5. Update all usages to use rootStore.selection directly
6. Delete legacy SelectionState file

**Files:**
- `src/ui/state/selection.ts` - Delete after migration
- `src/stores/SelectionStore.ts` - Enhance if needed
- All components using getSelectionState() - Update imports

---

### Phase 1: Simple Conversions

#### 1.1: DomainsPanel → React
**Goal**: Convert simplest component first as template

**Current behavior:**
- Receives patch via setPatch()
- Displays domains as expandable cards
- Pure display, no store interaction

**Target:**
- React functional component with observer()
- useState for expandedDomains
- Observe rootStore.patch for changes

**Files:**
- `src/ui/components/DomainsPanel.ts` → `DomainsPanel.tsx`

---

#### 1.2: BlockLibrary → React
**Goal**: Convert block library with preview + addBlock wiring

**Current behavior:**
- Shows block types in categories
- Search/filter functionality
- Logs clicks but doesn't wire to store

**Target:**
- React functional component
- useState for search, expanded categories
- Click block type → set previewType in selection state (shows preview in Inspector)
- Double-click OR "Add" button → rootStore.patch.addBlock()
- After add, select the new block

**Files:**
- `src/ui/components/BlockLibrary.ts` → `BlockLibrary.tsx`

---

### Phase 2: Selection-Dependent Components

#### 2.1: BlockInspector → React
**Goal**: Convert inspector with full selection observation

**Current behavior:**
- Subscribes to SelectionState manually
- Shows selected block details
- Port connections with navigation

**Target:**
- React functional component with observer()
- Observe rootStore.selection.selectedBlockId
- Click connection → navigate to that block
- Use InspectorContainer for layout

**Files:**
- `src/ui/components/BlockInspector.ts` → `BlockInspector.tsx`

---

#### 2.2: TableView → React
**Goal**: Convert table view with selection wiring

**Current behavior:**
- Shows blocks in expandable table
- Row selection wired to SelectionState
- Connection navigation

**Target:**
- React functional component with observer()
- Click row → rootStore.selection.selectBlock()
- Expand/collapse rows with useState
- Observe selection state for highlighting

**Files:**
- `src/ui/components/TableView.ts` → `TableView.tsx`

---

### Phase 3: Integration

#### 3.1: Wire Components in main.ts
**Goal**: Mount React components in existing layout

**Tasks:**
1. Import createRoot from react-dom/client
2. For each converted component:
   - Get container from TabbedContent/layout
   - Create React root
   - Render component with observer
3. Remove old vanilla component instantiation
4. Delete ConnectionMatrixWrapper usage

**Files:**
- `src/main.ts`

---

#### 3.2: Cleanup
**Goal**: Remove obsolete files

**Tasks:**
1. Delete `src/ui/components/ConnectionMatrixWrapper.ts`
2. Delete `src/ui/state/selection.ts` (after migration)
3. Delete old `.ts` component files replaced by `.tsx`
4. Update `src/ui/components/index.ts` exports

---

## Dependencies

```
Phase 0 (Selection reconciliation)
    ↓
Phase 1.1 (DomainsPanel) ← Template for others
    ↓
Phase 1.2 (BlockLibrary) ← Independent
    ↓
Phase 2.1 (BlockInspector) ← Uses selection
    ↓
Phase 2.2 (TableView) ← Uses selection
    ↓
Phase 3 (Integration & Cleanup)
```

---

## Verification

### Automated
- [ ] TypeScript compiles (`npm run typecheck`)
- [ ] Tests pass (`npm run test`)
- [ ] Build succeeds (`npm run build`)

### Runtime
- [ ] App loads without console errors
- [ ] Block library displays block types
- [ ] Click block type → block added to patch
- [ ] Table view shows blocks
- [ ] Click row → block selected, inspector updates
- [ ] Inspector shows selected block details
- [ ] Connection navigation works
- [ ] Domains panel shows domains

---

## Risks

1. **Selection state migration** - Need to ensure all selection functionality is preserved
2. **React roots in vanilla DOM** - May have cleanup issues if TabbedContent destroys containers
3. **MobX observer reactivity** - Components may not update if not properly observed
4. **Typing** - Converting to TSX requires proper React typing

---

## Estimated Effort

| Phase | Work | Estimate |
|-------|------|----------|
| 0.1 Selection reconciliation | Migrate selection state | 1-2 hours |
| 1.1 DomainsPanel | Simple conversion | 1 hour |
| 1.2 BlockLibrary | Conversion + addBlock | 2 hours |
| 2.1 BlockInspector | Complex conversion | 2-3 hours |
| 2.2 TableView | Complex conversion | 2-3 hours |
| 3.1 main.ts wiring | Integration | 1-2 hours |
| 3.2 Cleanup | Delete old files | 30 mins |
| **Total** | | **10-14 hours** |

---

## User Decisions

1. **Should clicking a block type in Library just preview it or immediately add it?**
   - **Decision: Preview first** - Click shows preview in Inspector, double-click or explicit button to add
   - This matches the P8 feature from ui-features-v2 plan

2. **Do we need auto-recompile when patch changes?**
   - Deferred - manual recompile button for now

3. **What happens when no block is selected?**
   - Inspector shows "No selection" state
