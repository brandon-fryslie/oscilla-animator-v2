# Evaluation: Remove TypeEnv from typecheck.ts

**Topic**: Remove TypeEnv legacy type and migrate to TypeCheckContext
**Bead ID**: oscilla-animator-v2-6n6
**Evaluated**: 2026-01-27

## Summary

This is a well-scoped cleanup task to remove a deprecated backwards-compatibility pattern. `TypeEnv` was the original simple type environment (`ReadonlyMap<string, PayloadType>`), which was later wrapped by `TypeCheckContext` to add optional block reference support.

## Current State Analysis

### TypeEnv Definition (typecheck.ts:42)
```typescript
export type TypeEnv = ReadonlyMap<string, PayloadType>;
```

### TypeCheckContext Definition (typecheck.ts:60-65)
```typescript
export interface TypeCheckContext {
  readonly inputs: TypeEnv;  // Uses TypeEnv internally
  readonly blockRefs?: BlockReferenceContext;
}
```

### Backwards Compatibility Pattern
- **Deprecated overload** (line 122): `typecheck(node: ExprNode, env: TypeEnv): ExprNode`
- **Type guard** (lines 159-161): `isTypeEnv()` discriminates between TypeEnv and TypeCheckContext
- **Auto-conversion** (lines 125-127): Wraps TypeEnv into TypeCheckContext

### Usage Sites

| File | Line | Usage |
|------|------|-------|
| `src/expr/typecheck.ts` | 42 | Definition |
| `src/expr/typecheck.ts` | 62 | Used as `inputs` field type in TypeCheckContext |
| `src/expr/typecheck.ts` | 122 | Deprecated overload signature |
| `src/expr/typecheck.ts` | 123, 159-161 | Union handling & type guard |
| `src/expr/index.ts` | 29 | Import |
| `src/expr/index.ts` | 141 | Return type of `extractPayloadTypes()` |
| `src/expr/index.ts` | 151 | Re-export |
| `src/expr/__tests__/typecheck.test.ts` | multiple | Tests use `new Map()` directly (duck-typed) |

### External Consumers
**None found.** The only public caller is `src/expr/index.ts` which uses the internal `extractPayloadTypes()` function.

## Verdict: CONTINUE

**Confidence: HIGH**

This is a straightforward cleanup with:
- Clear scope (2 files + tests)
- No external consumers of the `TypeEnv` export
- Well-defined migration path
- Full test coverage already exists

## Work Items

### P0: Update typecheck.ts
1. Remove deprecated overload signature (line 122)
2. Remove `isTypeEnv()` type guard (lines 159-161)
3. Remove auto-conversion in implementation (lines 124-127)
4. Keep `TypeEnv` as internal type alias (still useful for `inputs` field)

### P1: Update index.ts
1. Remove `TypeEnv` from import (line 29)
2. Change `extractPayloadTypes()` return type from `TypeEnv` to `ReadonlyMap<string, PayloadType>` (line 141)
3. Update call site to pass TypeCheckContext (line 91)
4. Remove `TypeEnv` re-export (line 151)

### P2: Update tests
1. Update test cases that pass raw Map to use `{ inputs: map }` instead
2. Verify all tests pass with the new API

## Risks

| Risk | Likelihood | Mitigation |
|------|------------|------------|
| Breaking external consumers | Low | Grep confirmed no external usage |
| Test failures | Low | Update tests as part of migration |

## Dependencies

None - this is a leaf cleanup task.

## Implementation Order

1. Update `src/expr/index.ts` to pass TypeCheckContext (makes tests pass)
2. Update tests to use new API
3. Remove deprecated code from `typecheck.ts`
4. Verify build and tests pass
