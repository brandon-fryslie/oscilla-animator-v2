# Work Evaluation - 20260125-060800
Scope: depth-sort-prealloc - Preallocate Depth-Sort Permutation Buffers
Status: COMPLETE

## Goals Under Evaluation
From SPRINT-20260125-055700-buffer-prealloc-DOD.md

## Acceptance Criteria Verification

### 1. Module-Level Buffer Pool
| Criterion | Status | Evidence |
|-----------|--------|----------|
| `pooledIndices: Uint32Array` declared | PASS | Line 57 |
| `pooledScreenPos: Float32Array` (stride 2) | PASS | Line 58 |
| `pooledRadius: Float32Array` (stride 1) | PASS | Line 59 |
| `pooledDepth: Float32Array` (stride 1) | PASS | Line 60 |
| `pooledColor: Uint8ClampedArray` (stride 4) | PASS | Line 61 |
| `pooledRotation: Float32Array` (stride 1) | PASS | Line 62 |
| `pooledScale2: Float32Array` (stride 2) | PASS | Line 63 |
| Initial capacity >= 256 | PASS | INITIAL_POOL_CAPACITY = 256 (line 55) |

### 2. Grow-Only Resize Helper
| Criterion | Status | Evidence |
|-----------|--------|----------|
| `ensureBufferCapacity(count)` exists | PASS | Lines 72-84 |
| Early return if sufficient | PASS | Line 73 |
| All buffers grow together | PASS | Lines 77-83 |
| Uses 2x growth factor | PASS | Line 75: `pooledIndices.length * 2` |

### 3. depthSortAndCompact Updated
| Criterion | Status | Evidence |
|-----------|--------|----------|
| Calls ensureBufferCapacity | PASS | Line 172 |
| Uses Uint32Array for indices | PASS | Lines 175-179 use pooledIndices |
| Writes to pooled buffers | PASS | Lines 215-251 |
| Returns properly sized arrays | PASS | Lines 257-260 use subarray |
| Interface unchanged | PASS | Same return type signature |

### 4. Tests Pass
| Test | Status | Result |
|------|--------|--------|
| `npm run typecheck` | PRE-EXISTING FAILURES | Unrelated type errors in other files |
| `npm test RenderAssembler.test.ts` | PASS | 12/12 |
| `npm test RenderAssembler-per-instance-shapes.test.ts` | PASS | 8/8 |

### 5. No Behavior Change
| Criterion | Status | Evidence |
|-----------|--------|----------|
| Existing callers work | PASS | Tests pass without modification |
| Sort order unchanged | PASS | Same sorting logic (far-to-near, stable) |
| Fast-path works | PASS | Lines 184-196 preserve fast-path |

## Design Decision: Fresh Copies vs Subarrays

The implementation returns fresh copies (`new Float32Array(subarray)`) rather than pure subarray views. This is necessary because:
1. Multiple topology groups may call `depthSortAndCompact` per frame
2. Returning views would cause subsequent calls to overwrite previous results
3. Fresh copies ensure caller independence

The performance win comes from:
- Eliminating repeated allocations during index building and sorting
- Using Uint32Array instead of boxing to number[]
- Amortized O(1) buffer growth

## Verdict: COMPLETE

All acceptance criteria from the DoD are met. The implementation is correct and well-tested.

## Bead Status
Closed: oscilla-animator-v2-la0
Commit: 941d47a
