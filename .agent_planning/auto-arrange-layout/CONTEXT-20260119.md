# Context: Auto-Arrange Layout Implementation

**Date:** 2026-01-19
**Issue:** oscilla-animator-v2-8fp
**Epic:** patch-editor-ui Sprint 2B Phase 1

---

## Issue Background

**Issue Description:**
> Add auto-arrange layout to React Flow editor
>
> Implement automatic graph layout for React Flow editor.
>
> Rete used rete-auto-arrange-plugin with ELK layout algorithm:
> - elk.algorithm: 'layered'
> - elk.direction: 'RIGHT' (left-to-right flow)
> - elk.spacing.nodeNode: '100'
> - elk.layered.spacing.nodeNodeBetweenLayers: '80'
>
> Options:
> 1. Add dagre dependency (simpler, good enough)
> 2. Add elkjs dependency (more powerful, what Rete used)
>
> Add toolbar button to trigger layout.

**Priority:** P1 (High)
**Issue Type:** Feature
**Created:** 2026-01-18

---

## Historical Context

### Migration from Rete.js to React Flow

**Key Commits:**
- `5806139` - "refactor(ui): Remove Rete.js node editor" (2026-01-15)
- `295a676` - "Fix react flow editor" (2026-01-16)
- `87b5b2a` - "continuity-ui" (includes React Flow improvements)

**Why Migration Happened:**
Rete.js was removed in favor of React Flow for:
1. Better TypeScript support
2. Simpler integration with React/MobX
3. Standard React patterns, less boilerplate
4. Built-in features (Background, Controls)
5. More active maintenance

**What Was Lost in Migration:**
From `.agent_planning/rete-removal/ANALYSIS-rete-vs-reactflow.md`:
1. ✅ **Undo/Redo** - COMPLETED in Sprint 2A
2. ⚠️ **Auto-Arrange** - THIS ISSUE (partially implemented)
3. ❌ **Minimap** - Component exists but not used
4. ✅ **Context Menu** - COMPLETED in Sprint 2A
5. ❌ **Socket Type Validation** - Tracked separately (oscilla-animator-v2-wc9)

### Previous Sprint Work

**Sprint 2A (COMPLETED 2026-01-13):**
- Undo/redo (50 steps) ✅
- Keyboard shortcuts (Ctrl+Z/Y) ✅
- Context menu delete ✅
- Pan/zoom navigation ✅
- 275 tests passing ✅

**Sprint 2B Phase 1 (PARTIAL - 2026-01-13):**
- Auto-layout plugin integrated for Rete ✅
- Minimap plugin integrated for Rete ✅
- **BUT:** Rete was then removed, so work needs to be re-evaluated

---

## Current Implementation State

### What Exists

**Files:**
1. **src/ui/reactFlowEditor/layout.ts** (82 lines)
   - ELK layout algorithm implementation
   - `getLayoutedElements(nodes, edges, options)` function
   - Configuration: direction, nodeSpacing, layerSpacing
   - Default options: RIGHT, 100px, 80px ✅

2. **src/ui/reactFlowEditor/ReactFlowEditor.tsx** (330 lines)
   - Lines 166-182: `handleAutoArrange` callback
   - Lines 302-310: Auto-arrange button UI
   - Lines 100-104: State refs for nodes/edges

3. **package.json**
   - Line 22: `"elkjs": "^0.11.0"` ✅

**Implementation Analysis:**

**✅ CORRECT:**
- ELK algorithm chosen (matches Rete, more powerful than dagre)
- Configuration matches requirements (RIGHT, 100px, 80px)
- Button integrated into UI panel
- Loading state management (`isLayouting`)
- Zoom-to-fit after layout
- Uses refs to access latest state

**⚠️ INCOMPLETE:**
- No empty graph check
- No single node optimization
- No error handling (try/catch)
- No E2E tests
- Runtime behavior not verified

**❌ MISSING:**
- E2E tests
- Completion documentation
- Roadmap/beads updates

---

## Architecture Context

### React Flow Structure

```
src/ui/
├── reactFlowEditor/
│   ├── ReactFlowEditor.tsx        # Main component
│   ├── OscillaNode.tsx            # Custom node component
│   ├── layout.ts                  # ELK layout (THIS ISSUE)
│   ├── typeValidation.ts          # Connection validation
│   ├── sync.ts                    # PatchStore sync
│   ├── nodes.ts                   # Node factory
│   └── index.ts                   # Exports
├── editorCommon/
│   └── EditorContext.tsx          # Generic editor interface
└── dockview/
    └── panels/
        └── ReactFlowEditorPanel.tsx  # Dockview wrapper
```

### Data Flow

```
User clicks "Auto Arrange"
  ↓
handleAutoArrange()
  ↓
getLayoutedElements(nodes, edges)  ← THIS ISSUE
  ↓
ELK layout algorithm
  ↓
New node positions computed
  ↓
setNodes(layoutedNodes)
  ↓
React Flow re-renders
  ↓
fitView({ padding: 0.1 })
  ↓
All nodes visible in viewport
```

### Integration Points

**Inputs:**
- `nodes: Node[]` - Current React Flow nodes with positions
- `edges: Edge[]` - Current React Flow edges (connections)
- `options?: LayoutOptions` - Optional layout configuration

**Outputs:**
- `{ nodes: Node[], edges: Edge[] }` - Nodes with updated positions

**Side Effects:**
- React Flow state update (`setNodes`)
- Viewport update (`fitView`)
- UI state update (`setIsLayouting`)

**No Changes To:**
- PatchStore (positions not persisted)
- Edges (only nodes repositioned)
- Node properties (only position changes)

---

## Requirements Reference

### From Beads Issue Description

1. **Algorithm:** ELK 'layered' ✅ (src/ui/reactFlowEditor/layout.ts:44)
2. **Direction:** 'RIGHT' (left-to-right) ✅ (layout.ts:21, 45)
3. **Node Spacing:** 100px ✅ (layout.ts:22, 46)
4. **Layer Spacing:** 80px ✅ (layout.ts:47)
5. **Toolbar Button:** ✅ (ReactFlowEditor.tsx:302-310)

### From Analysis Document

From `.agent_planning/rete-removal/ANALYSIS-rete-vs-reactflow.md`:

**Priority:** EXTREMELY HIGH
**Risk if Missing:** Manual node positioning only

**Requirements:**
- Configurable options (algorithm, direction, spacing) ✅
- Toolbar button triggers layout ✅
- Zoom-to-fit after layout completes ✅

**Migration Path:** Add dagre or elkjs dependency, create layout function, add toolbar button ✅

---

## Spec Alignment

**No canonical spec document for UI layout.**

This is a pure UI/UX feature, not part of the Oscilla animation system spec. Requirements come from:
1. User experience needs (editor usability)
2. Parity with Rete.js implementation (migration goal)
3. Standard graph editor conventions (left-to-right flow)

**CLAUDE.md Guidelines:**
- ✅ Single source of truth: ELK algorithm in layout.ts
- ✅ One-way dependencies: layout.ts depends on nothing
- ⚠️ Goals must be verifiable: Need E2E tests! (THIS IS KEY)

---

## Dependencies

### Runtime Dependencies
- **elkjs@^0.11.0** - ELK layout algorithm ✅ INSTALLED
- **reactflow@^11.11.4** - React Flow library ✅ INSTALLED

### Development Dependencies
- **playwright@^1.57.0** - E2E testing ✅ INSTALLED
- **vitest@^2.1.8** - Unit testing ✅ INSTALLED

### Code Dependencies
- `src/ui/reactFlowEditor/sync.ts` - No dependency (standalone)
- React Flow hooks: `useReactFlow`, `useNodesState`

### Blocked By
- None (ready to implement)

### Blocks
- None (this is an independent feature)

---

## Technical Constraints

### Performance
- Layout computation: <500ms for 50 nodes (target)
- Layout computation: <2s for 100 nodes (acceptable)
- UI responsiveness: No jank during layout
- Memory: ELK runs in-process (no web workers)

### Browser Compatibility
- ELK works in all modern browsers ✅
- No IE11 support needed ✅

### Type Safety
- ELK types available from `elkjs` package ✅
- React Flow types available from `reactflow` package ✅

### Integration
- Must not break existing functionality:
  - Undo/redo (works at PatchStore level, safe)
  - Selection (cleared by layout? Check!)
  - Pan/zoom (replaced by fitView, expected)
  - Connections (edges unchanged, safe)

---

## Known Issues and Risks

### Implementation Risks

**LOW RISK:**
- Configuration already correct ✅
- Core implementation exists and compiles ✅
- ELK is proven (used in Rete previously) ✅

**MEDIUM RISK:**
- Runtime behavior not verified ⚠️
- No E2E tests (regressions possible) ⚠️
- Error handling missing ⚠️

**HIGH RISK:**
- None identified

### Technical Debt

**Existing Debt:**
- Type casting to `any` in Rete version (now removed)
- No persistent layout (positions reset on reload)

**New Debt:**
- If we skip E2E tests: ❌ UNACCEPTABLE per CLAUDE.md
- If we skip error handling: ⚠️ Risky but acceptable
- If we skip edge cases: ⚠️ Risky but acceptable

**DECISION:** E2E tests are REQUIRED per "Goals must be verifiable" principle.

---

## Testing Strategy

### Test Pyramid

**E2E Tests (Required):**
1. Button visibility
2. Empty graph edge case
3. Single node edge case
4. Multiple nodes - no overlap
5. Loading state
6. Zoom-to-fit

**Integration Tests (Optional):**
- Layout function with various graph topologies
- Performance benchmarking

**Unit Tests (Not Needed):**
- ELK algorithm is external, not our code
- React Flow integration too coupled for unit tests

### Manual Testing Scenarios

**Core Scenarios:**
1. Empty graph
2. Single node
3. 2-5 nodes (simple graph)
4. 10+ nodes (complex graph)
5. Multiple layers (hierarchical)

**Edge Cases:**
6. Disconnected nodes
7. Cyclic connections
8. Very large graphs (50+ nodes)

**Error Scenarios:**
9. ELK failure (network error if CDN loaded)
10. Invalid node dimensions
11. Concurrent layout operations

---

## Success Criteria Summary

**Functional:**
- ✅ Button works
- ✅ Layout produces no overlaps
- ✅ Zoom-to-fit shows all nodes
- ✅ Edge cases handled

**Code Quality:**
- ✅ TypeScript clean
- ✅ Error handling present
- ✅ Code documented

**Testing:**
- ✅ E2E tests pass
- ✅ Manual verification complete

**Documentation:**
- ✅ Completion doc written
- ✅ Roadmap updated
- ✅ Beads closed

---

## References

**Beads Issue:**
- oscilla-animator-v2-8fp (this issue)

**Related Issues:**
- oscilla-animator-v2-wc9 - Connection type validation
- oscilla-animator-v2-31g - Minimap (lower priority)

**Planning Documents:**
- `.agent_planning/rete-removal/ANALYSIS-rete-vs-reactflow.md`
- `.agent_planning/patch-editor-ui/PLAN-SPRINT2B-20260113-192900.md`
- `.agent_planning/patch-editor-ui/WORK-EVALUATION-sprint2b-phase1-20260113-195607.md`

**Git Commits:**
- `5806139` - Rete removal
- `295a676` - React Flow fix

**Spec Documents:**
- None (UI feature, no canonical spec)

**CLAUDE.md Principles:**
- Goals must be verifiable → E2E tests required
- One source of truth → layout.ts is canonical
- Single enforcer → ELK algorithm in one place
