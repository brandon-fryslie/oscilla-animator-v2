# Implementation Plan: Auto-Arrange Layout for React Flow

**Date:** 2026-01-19
**Issue:** oscilla-animator-v2-8fp
**Epic:** patch-editor-ui (Phase 2B continuation)
**Scope:** Complete and verify auto-arrange layout functionality in React Flow editor

---

## Executive Summary

Auto-arrange layout has been **partially implemented** in React Flow but needs verification, refinement, and documentation. The ELK layout algorithm is integrated (src/ui/reactFlowEditor/layout.ts), button exists (ReactFlowEditor.tsx:302-310), but we need to:

1. Verify it works correctly
2. Ensure configuration matches requirements
3. Add tests
4. Document any gaps

**Current State:**
- ✅ elkjs dependency installed (package.json:22)
- ✅ Layout function exists (src/ui/reactFlowEditor/layout.ts)
- ✅ Auto-arrange button integrated (ReactFlowEditor.tsx:166-182, 302-310)
- ⚠️ Configuration uses defaults (need to verify spacing/direction)
- ❌ No E2E tests
- ❌ Runtime behavior not verified

---

## Sprint Structure

### P0: Verification & Refinement (REQUIRED)
Verify current implementation works and meets acceptance criteria from original Rete analysis.

### P1: Testing (REQUIRED)
Add E2E tests to ensure functionality works and prevent regressions.

### P2: Documentation (OPTIONAL)
Document usage and update planning files.

---

## P0: Verification & Refinement

### Step 1: Review Current Implementation

**Files to examine:**
1. `src/ui/reactFlowEditor/layout.ts` - ELK layout algorithm
2. `src/ui/reactFlowEditor/ReactFlowEditor.tsx:166-182, 302-310` - Button/handler
3. `package.json:22` - elkjs dependency

**What to verify:**
- Layout configuration (direction, spacing)
- Edge cases handling (empty graph, single node)
- Zoom-to-fit integration
- Performance characteristics

### Step 2: Manual Runtime Testing

**Test Scenarios:**
1. **Empty graph** - Button should be clickable but no-op
2. **Single node** - Should center/zoom to node
3. **2-5 nodes** - Should arrange left-to-right with proper spacing
4. **10+ nodes** - Should arrange in layers with no overlap
5. **Complex graph** - Multiple layers, verify readability

**Configuration Requirements (from ANALYSIS-rete-vs-reactflow.md):**
- Algorithm: 'layered' (hierarchical)
- Direction: 'RIGHT' (left-to-right flow)
- Node spacing: 100px minimum
- Layer spacing: 80px minimum
- Padding: reasonable margins

**Current Implementation Check:**
```typescript
// From layout.ts:44-48
layoutOptions: {
  'elk.algorithm': 'layered',
  'elk.direction': direction,  // Default: 'RIGHT' ✅
  'elk.spacing.nodeNode': String(nodeSpacing),  // Default: 100 ✅
  'elk.layered.spacing.nodeNodeBetweenLayers': String(layerSpacing),  // Default: 80 ✅
  'elk.padding': '[top=20,left=20,bottom=20,right=20]',  // ✅
}
```

**Verdict:** Configuration looks correct! Matches Rete configuration.

### Step 3: Edge Cases Verification

**Code Review (ReactFlowEditor.tsx:166-182):**

```typescript
const handleAutoArrange = useCallback(async () => {
  if (isLayouting) return;  // ✅ Prevent concurrent operations
  setIsLayouting(true);     // ✅ Loading state

  try {
    const { nodes: layoutedNodes } = await getLayoutedElements(
      nodesRef.current,
      edgesRef.current
    );
    setNodes(layoutedNodes);
    // Fit view after layout completes
    setTimeout(() => fitView({ padding: 0.1 }), 50);  // ✅ Zoom-to-fit
  } finally {
    setIsLayouting(false);
  }
}, [isLayouting, setNodes, fitView]);
```

**Missing Edge Cases:**
- ❌ Empty graph: No explicit check (ELK should handle, but should verify)
- ❌ Single node: No special case (ELK will still run algorithm)
- ❌ Error handling: No catch block (errors will crash UI)

**Refinements Needed:**
1. Add empty graph check (no-op return)
2. Add error handling with user notification
3. Consider single-node optimization (just zoom, skip layout)

### Step 4: Implement Refinements

**File:** `src/ui/reactFlowEditor/ReactFlowEditor.tsx`

**Change:** Update handleAutoArrange (lines 166-182)

```typescript
const handleAutoArrange = useCallback(async () => {
  if (isLayouting) return;

  // Edge case: empty graph
  if (nodesRef.current.length === 0) {
    return; // No-op
  }

  setIsLayouting(true);

  try {
    // Edge case: single node - just zoom to it
    if (nodesRef.current.length === 1) {
      setTimeout(() => fitView({ padding: 0.1 }), 50);
      return;
    }

    const { nodes: layoutedNodes } = await getLayoutedElements(
      nodesRef.current,
      edgesRef.current
    );
    setNodes(layoutedNodes);

    // Fit view after layout completes
    setTimeout(() => fitView({ padding: 0.1 }), 50);
  } catch (error) {
    console.error('Auto-arrange failed:', error);
    // TODO: Show user notification (toast/snackbar)
  } finally {
    setIsLayouting(false);
  }
}, [isLayouting, setNodes, fitView]);
```

**Verification:**
- Run dev server
- Test empty graph, single node, multi-node scenarios
- Verify no crashes, reasonable layout

---

## P1: Testing

### Step 5: Create E2E Tests

**File (new):** `tests/e2e/auto-arrange.test.ts`

```typescript
import { test, expect } from '@playwright/test';

test.describe('Auto-arrange Layout', () => {
  test.beforeEach(async ({ page }) => {
    await page.goto('http://localhost:5177/');
    // Wait for editor to load
    await page.waitForSelector('.react-flow-wrapper');
  });

  test('auto-arrange button exists', async ({ page }) => {
    const button = page.locator('button:has-text("Auto Arrange")');
    await expect(button).toBeVisible();
  });

  test('empty graph - button clickable, no crash', async ({ page }) => {
    const button = page.locator('button:has-text("Auto Arrange")');
    await button.click();
    // Should not crash, button should re-enable
    await expect(button).not.toBeDisabled();
  });

  test('single node - zooms to node', async ({ page }) => {
    // Add a single node
    await page.click('[data-testid="block-library-item-Oscillator"]');

    // Get initial position
    const node = page.locator('.react-flow__node').first();
    const initialBounds = await node.boundingBox();

    // Pan away from node
    await page.mouse.move(400, 300);
    await page.mouse.down();
    await page.mouse.move(100, 100);
    await page.mouse.up();

    // Auto-arrange should center the node
    await page.click('button:has-text("Auto Arrange")');
    await page.waitForTimeout(200); // Wait for animation

    const finalBounds = await node.boundingBox();
    // Node should be approximately centered (not testing exact values)
    expect(finalBounds).toBeTruthy();
  });

  test('multiple nodes - arranges left-to-right with no overlap', async ({ page }) => {
    // Add 5 nodes
    for (let i = 0; i < 5; i++) {
      await page.click('[data-testid="block-library-item-Oscillator"]');
      await page.waitForTimeout(50);
    }

    // Auto-arrange
    await page.click('button:has-text("Auto Arrange")');
    await page.waitForTimeout(500); // Wait for layout computation

    // Get all node bounding boxes
    const nodes = page.locator('.react-flow__node');
    const count = await nodes.count();
    expect(count).toBe(5);

    const boxes = [];
    for (let i = 0; i < count; i++) {
      const box = await nodes.nth(i).boundingBox();
      boxes.push(box);
    }

    // Check no overlaps (bounding boxes don't intersect)
    for (let i = 0; i < boxes.length; i++) {
      for (let j = i + 1; j < boxes.length; j++) {
        const a = boxes[i];
        const b = boxes[j];
        const overlap = !(
          a.x + a.width < b.x ||
          b.x + b.width < a.x ||
          a.y + a.height < b.y ||
          b.y + b.height < a.y
        );
        expect(overlap).toBe(false);
      }
    }

    // Verify left-to-right ordering (nodes should generally increase in X)
    const xPositions = boxes.map(b => b.x).sort((a, b) => a - b);
    expect(xPositions[1] - xPositions[0]).toBeGreaterThan(50); // Minimum spacing
  });

  test('button shows loading state during layout', async ({ page }) => {
    // Add multiple nodes
    for (let i = 0; i < 10; i++) {
      await page.click('[data-testid="block-library-item-Oscillator"]');
      await page.waitForTimeout(20);
    }

    const button = page.locator('button:has-text("Auto Arrange")');

    // Click and immediately check loading state
    await button.click();
    const loadingText = await button.textContent();
    expect(loadingText).toContain('Arranging');

    // Wait for completion
    await page.waitForTimeout(500);
    const finalText = await button.textContent();
    expect(finalText).toContain('Auto Arrange');
  });

  test('zoom-to-fit after layout', async ({ page }) => {
    // Add nodes and spread them out manually
    // ... implementation ...

    // Auto-arrange should bring all nodes into view
    await page.click('button:has-text("Auto Arrange")');
    await page.waitForTimeout(500);

    // All nodes should be visible in viewport
    const nodes = page.locator('.react-flow__node');
    for (let i = 0; i < await nodes.count(); i++) {
      await expect(nodes.nth(i)).toBeInViewport();
    }
  });
});
```

**Note:** The test implementation above assumes certain test IDs and UI structure. Adjust based on actual implementation.

### Step 6: Run Tests

```bash
npm run test:e2e  # Run Playwright tests
```

**Expected Results:**
- All tests pass
- No flakiness (tests stable across multiple runs)
- Coverage of all acceptance criteria

---

## P2: Documentation

### Step 7: Update Planning Files

**File:** `.agent_planning/auto-arrange-layout/COMPLETION-20260119.md`

Document:
- What was implemented
- Test results
- Any limitations or known issues
- Usage instructions

**File (update):** `.agent_planning/ROADMAP.md`

Update patch-editor-ui Sprint 2B status:
- Mark Phase 1 (Auto-layout) as COMPLETED
- Update completion summary

### Step 8: Update Beads Issue

```bash
bd update oscilla-animator-v2-8fp --status closed --json
bd close oscilla-animator-v2-8fp --reason "Auto-arrange layout verified and tested. ELK algorithm integra ed with left-to-right flow, 100px node spacing, 80px layer spacing. E2E tests ensure no overlap and proper zoom-to-fit. Edge cases (empty/single node) handled gracefully." --json
```

---

## Acceptance Criteria

From `.agent_planning/rete-removal/ANALYSIS-rete-vs-reactflow.md` and beads issue:

### AC1: Toolbar Button Visible
- ✅ Button exists with label "Auto Arrange"
- ✅ Button has loading state ("Arranging...")
- ✅ Button disabled during layout operation

### AC2: Layout Algorithm Works
- ✅ Uses ELK 'layered' algorithm
- ✅ Left-to-right direction ('RIGHT')
- ✅ Node spacing: 100px minimum
- ✅ Layer spacing: 80px minimum
- ⚠️ **TO VERIFY:** No overlapping nodes after layout

### AC3: Zoom-to-Fit Integration
- ✅ Zoom-to-fit called after layout completes
- ⚠️ **TO VERIFY:** All nodes visible in viewport after layout

### AC4: Edge Cases Handled
- ⚠️ **TO IMPLEMENT:** Empty graph (no-op)
- ⚠️ **TO IMPLEMENT:** Single node (zoom only, skip layout)
- ✅ Concurrent operations prevented (isLayouting guard)
- ⚠️ **TO IMPLEMENT:** Error handling (catch block)

### AC5: E2E Tests
- ❌ **TO CREATE:** Button visibility test
- ❌ **TO CREATE:** Layout no-overlap test
- ❌ **TO CREATE:** Zoom-to-fit test
- ❌ **TO CREATE:** Edge case tests
- ❌ **TO CREATE:** Loading state test

---

## Technical Notes

### Current Implementation Status

**✅ Working:**
- ELK layout algorithm integrated
- Button and handler exist
- Configuration matches requirements (direction, spacing)
- Loading state management

**⚠️ Needs Verification:**
- Actual runtime behavior (does it work?)
- Layout quality (no overlaps, good spacing)
- Performance (smooth with 10+ nodes)
- Zoom-to-fit behavior

**❌ Missing:**
- Edge case handling (empty/single node)
- Error handling (catch block)
- E2E tests
- Completion documentation

### Files to Modify

1. **src/ui/reactFlowEditor/ReactFlowEditor.tsx** (lines 166-182)
   - Add empty graph check
   - Add single node optimization
   - Add error handling

2. **tests/e2e/auto-arrange.test.ts** (NEW)
   - Create comprehensive E2E tests

3. **.agent_planning/auto-arrange-layout/COMPLETION-20260119.md** (NEW)
   - Document completion summary

4. **.agent_planning/ROADMAP.md** (update)
   - Update patch-editor-ui Sprint 2B status

### Dependencies

**Runtime:**
- elkjs@^0.11.0 (already installed ✅)
- reactflow@^11.11.4 (already installed ✅)

**Testing:**
- playwright@^1.57.0 (already installed ✅)

### Configuration Reference

From `src/ui/reactFlowEditor/layout.ts:14-24`:

```typescript
export interface LayoutOptions {
  direction?: 'RIGHT' | 'DOWN' | 'LEFT' | 'UP';
  nodeSpacing?: number;
  layerSpacing?: number;
}

const DEFAULT_OPTIONS: LayoutOptions = {
  direction: 'RIGHT',    // ✅ Left-to-right per requirements
  nodeSpacing: 100,      // ✅ Matches Rete config
  layerSpacing: 80,      // ✅ Matches Rete config
};
```

**Verdict:** Configuration is correct and matches requirements!

---

## Risk Assessment

### LOW RISK
- Configuration already correct
- Core implementation exists and compiles
- ELK is proven layout algorithm (used in Rete previously)

### MEDIUM RISK
- Runtime behavior not yet verified
- No E2E tests (regressions possible)
- Error handling missing

### MITIGATION
1. **Manual verification first** - Test in dev server before declaring complete
2. **Comprehensive E2E tests** - Prevent future regressions
3. **Error handling** - Graceful failures, user-friendly messages

---

## Success Metrics

### Definition of Done

**Code Quality:**
- ✅ TypeScript compiles with no errors
- ✅ No ESLint warnings
- ✅ Edge cases handled (empty, single, errors)

**Functionality:**
- ✅ Button visible and clickable
- ✅ Layout produces no overlaps
- ✅ Zoom-to-fit works correctly
- ✅ Performance acceptable (smooth with 10+ nodes)

**Testing:**
- ✅ E2E tests created and passing
- ✅ Manual verification completed
- ✅ All acceptance criteria met

**Documentation:**
- ✅ Completion summary written
- ✅ Roadmap updated
- ✅ Beads issue closed

---

## Timeline Estimate

**P0 (Verification & Refinement):** 1-2 hours
- Code review: 15 minutes
- Manual testing: 30 minutes
- Implement refinements: 30-45 minutes
- Verify refinements: 15-30 minutes

**P1 (Testing):** 1-2 hours
- Create E2E tests: 45-60 minutes
- Run and debug tests: 30-60 minutes
- Fix any issues found: 0-30 minutes

**P2 (Documentation):** 30 minutes
- Write completion summary: 15 minutes
- Update roadmap/beads: 15 minutes

**Total:** 2.5-4.5 hours

**Note:** Actual time may be faster if everything works perfectly on first try!

---

## Next Steps

1. **START HERE:** Review current implementation (Step 1)
2. Manual runtime testing (Step 2-3)
3. Implement refinements if needed (Step 4)
4. Create E2E tests (Step 5-6)
5. Document completion (Step 7-8)

---

## References

- **Beads Issue:** oscilla-animator-v2-8fp
- **Original Analysis:** `.agent_planning/rete-removal/ANALYSIS-rete-vs-reactflow.md`
- **Sprint 2B Plan:** `.agent_planning/patch-editor-ui/PLAN-SPRINT2B-20260113-192900.md`
- **Rete Implementation (removed):** `5806139` - "refactor(ui): Remove Rete.js node editor"
- **React Flow Implementation:** `src/ui/reactFlowEditor/` (current)
