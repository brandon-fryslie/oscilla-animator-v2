# Explore Agent Output: U-32 DomainDecl in NormalizedGraph
Timestamp: 2026-01-28-060712
Agent: explore (haiku)

---

## **FACTS: U-32 DomainDecl in NormalizedGraph**

### **1. Current NormalizedPatch Structure** (IMPLEMENTED)

**File**: `/Users/bmf/code/oscilla-animator-v2/src/compiler/frontend/normalize-indexing.ts`

**Lines 67–79 (actual structure)**:
```typescript
export interface NormalizedPatch {
  /** Original patch (for reference) */
  readonly patch: Patch;

  /** Map from BlockId to dense BlockIndex */
  readonly blockIndex: ReadonlyMap<BlockId, BlockIndex>;

  /** Blocks in index order (includes adapter blocks) */
  readonly blocks: readonly Block[];

  /** Edges with block indices instead of IDs */
  readonly edges: readonly NormalizedEdge[];
}
```

**CRITICAL**: `NormalizedPatch` does **NOT** include domains. It only handles block indexing and edge normalization. This is by design — Pass 3 (normalize-indexing.ts) explicitly states in its contract (lines 27–50):
> "What this file MUST NOT do: NO adapter insertion, NO default-source materialization, NO special-casing of particular block types."

---

### **2. DomainDecl in Spec** (CANONICAL SOURCE)

**File**: `/Users/bmf/code/oscilla-animator-v2/design-docs/CANONICAL-oscilla-v2.5-20260109/topics/04-compilation.md`

**Lines 167–181**:
```typescript
type DomainDecl =
  | { kind: 'domain_decl'; id: DomainId; shape: { kind: 'fixed_count'; count: number } }
  | { kind: 'domain_decl'; id: DomainId; shape: { kind: 'grid_2d'; width: number; height: number } }
  | { kind: 'domain_decl'; id: DomainId; shape: { kind: 'voices'; maxVoices: number } }
  | { kind: 'domain_decl'; id: DomainId; shape: { kind: 'mesh_vertices'; assetId: string } };
```

**Spec constraint**: "v0 invariant: Every domain compiles to dense lanes 0..N-1."

**In NormalizedGraph** (`04-compilation.md`, lines 82–87):
```typescript
type NormalizedGraph = {
  domains: DomainDecl[];    // <-- DomainDecl array required
  nodes: Node[];
  edges: Edge[];
};
```

**Glossary entry** (`GLOSSARY.md`, lines 952–970):
- **Definition**: "Canonical compile-time representation the compiler consumes"
- **Structure**: Shows `domains: DomainDecl[]` as top-level field
- **Source**: Topic 04-compilation.md

---

### **3. InstanceDecl Structure** (IR Layer - Actual Code)

**File**: `/Users/bmf/code/oscilla-animator-v2/src/compiler/ir/types.ts`

**Lines 417–425**:
```typescript
export interface InstanceDecl {
  readonly id: string; // InstanceId
  readonly domainType: string; // DomainTypeId
  readonly count: number | 'dynamic';
  readonly lifecycle: 'static' | 'dynamic' | 'pooled';
  // Continuity System: Identity specification
  readonly identityMode: 'stable' | 'none';
  readonly elementIdSeed?: number; // For deterministic ID generation
}
```

**Distinction** (from spec and refactor plan):
- `DomainDecl` = **resource/classification** (what it is)
- `InstanceDecl` = **instantiation/configuration** (how many, what lifecycle)

---

### **4. Domain Handling — Current State** (REFACTORED as of 2026-01-17)

**Critical Finding**: The old `DomainDecl` type has been **completely refactored** and **deleted from the codebase**.

**Refactor Completion** (`COMPLETION-20260117.md`):
- **Date**: 2026-01-17
- **Commit**: cfe765c - "refactor(domain): Sprint 8 - Delete old DomainDef types"
- **Result**: ALL old domain types removed from canonical-types.ts and IR

**What was deleted**:
- Old `DomainId` (simple string alias)
- Old `DomainRef` interface
- Old `DomainShape` union type
- Old `DomainDecl` interface (the one from spec)
- Factories: `domainRef()`, `domainDeclFixedCount()`, `domainDeclGrid2d()`, `domainDeclVoices()`, `domainDeclMeshVertices()`

**What replaced it**:
- `DomainTypeId` (branded string) — classification only
- `InstanceDecl` — instantiation (count, layout, lifecycle)
- `src/core/domain-registry.ts` — central registry

**Verification** (COMPLETION-20260117.md, lines 104–114):
```bash
grep -r "DomainDecl" src/ --include="*.ts"  # ✅ No matches
grep -r "DomainRef" src/ --include="*.ts"   # ✅ No matches
grep -r "DomainShape" src/ --include="*.ts" # ✅ No matches
```

---

### **5. Current Domain Handling Locations**

**File**: `/Users/bmf/code/oscilla-animator-v2/src/core/domain-registry.ts`
- **Added**: Sprint 1 (Commit ba1cabe)
- **Contains**: Domain type constants, intrinsic properties, hierarchy system, registry API

**File**: `/Users/bmf/code/oscilla-animator-v2/src/compiler/ir/types.ts`
- **Lines 407–425**: `InstanceDecl` (new model)
- **Lines 435–447**: `DomainInstance` (runtime representation)

**Instance creation pipeline**:
- **Sprint 3** (Commit a6b2eda): Added instance blocks (`CircleInstance`, `RectangleInstance`)
- **Sprint 6** (Commit 6bd8299): Updated compiler passes (pass7-schedule) to use instances
- **Sprint 7** (Commit d5a62eb): Updated runtime (Materializer, ScheduleExecutor)

---

### **6. Recent Changes Timeline**

**Entire domain refactor: Jan 17, 2026** (8 sprints)

| Sprint | Commit | Change |
|--------|--------|--------|
| 1 | ba1cabe | Foundation types + registry |
| 2 | ebb148d, 86fe7a1, 800101f | IR migration (InstanceDecl) |
| 3 | a6b2eda | Instance blocks |
| 4 | 8601781 | Field operations migration |
| 5 | 223248e | Render blocks |
| 6 | 6bd8299 | Compiler passes |
| 7 | d5a62eb | Runtime migration |
| 8 | cfe765c | Delete old types |

**Key constraint**: All old `DomainDecl` references are gone. The spec's `DomainDecl` type is **not implemented** in current codebase — it's been replaced by the instance model.

---

## **IMPLEMENTATION READINESS ASSESSMENT**

**Gap**: NormalizedGraph spec (04-compilation.md, line 83) requires `domains: DomainDecl[]`, but:
1. DomainDecl (as specified) no longer exists in code
2. NormalizedPatch (Pass 3 output) has **no** domain field
3. Domain/instance collection happens in IR layer, not graph normalization layer

**Action Required**: Either:
- A) Implement missing `domains` field in actual NormalizedGraph structure (architecture change)
- B) Update spec to reflect current instance-based model where domains are registry lookups, not graph data
