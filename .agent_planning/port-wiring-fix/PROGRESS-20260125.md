# Port Wiring Bug Fix - Progress Report

**Date**: 2026-01-25
**Status**: In Progress - Significant Progress Made
**Completion**: ~70% done

## Work Completed

### âœ… Storage Key Bump (DONE)
- Bumped STORAGE_KEY from v9 to v10 in src/main.ts:558
- This invalidates stale patches containing old block types (FieldSin, FieldAdd, etc.)
- Commits: 9bca033

### âœ… Adapter Blocks ValueRefPacked Fix (DONE)
- Added strideOf import to adapter-blocks.ts
- Updated all 10 unit-conversion adapters to include type and stride in returned ValueRefPacked objects
- Pattern: `{ k: 'sig', id, slot, type: ctx.outTypes[0], stride: strideOf(ctx.outTypes[0].payload) }`
- Commit: 562fd9f, bcd91a9

### âœ… Math Blocks Type Narrowing Fix (DONE)
- Fixed TypeScript type narrowing issues in Add, Subtract, Multiply, Divide, Modulo blocks
- Changed from ternary operator to if-else pattern to satisfy TypeScript type checker
- Blocks can now properly handle mixed signal/field inputs with broadcast
- Commit: 9bca033

### âœ… Color Blocks (DONE)
- Added type and stride to ValueRefPacked returns
- Commit: bcd91a9

### âœ… Event Blocks (DONE)
- Added type to event ValueRefPacked returns
- Commit: bcd91a9

### âœ… Expression Blocks (DONE)
- Added type and stride to ValueRefPacked returns
- Commit: bcd91a9

### âœ… Field Blocks (DONE)
- Added type and stride to ValueRefPacked returns
- Commit: bcd91a9

### âœ… Array & Camera Blocks (DONE)
- Added type and stride to ValueRefPacked returns
- Commit: 562fd9f

### âœ… Field Operations Blocks (DONE)
- Added type and stride to ValueRefPacked returns
- Commit: 562fd9f

## Work Remaining

### ðŸ”§ Remaining Block Files (~30% of work)
These 10 files still need the same ValueRefPacked type/stride fix pattern:
1. geometry-blocks.ts - 3 blocks
2. identity-blocks.ts - 2 blocks
3. instance-blocks.ts - 4 blocks
4. path-blocks.ts - 2 blocks
5. path-operators-blocks.ts - 2 blocks
6. primitive-blocks.ts - 2 blocks
7. signal-blocks.ts - 7 blocks
8. time-blocks.ts - 1 block (+ allocTypedSlot investigation)
9. render-blocks.ts - TBD
10. test-blocks.ts - TBD

### Pattern for Remaining Fixes
All follow the same pattern (documented in VALUEREF_FIX_PATTERN.md):
```typescript
// Add strideOf import
import { ..., strideOf } from '../core/canonical-types';

// In lower function:
const outType = ctx.outTypes[0];  // or ctx.outTypes[1] for second output
return {
  outputsById: {
    out: {
      k: 'sig' | 'field',
      id,
      slot,
      type: outType,
      stride: strideOf(outType.payload)
    }
  }
};
```

## Build Status

**Current errors**: ~110 errors (down from 300+ at start)

Breakdown:
- ~70 errors: ValueRefPacked type/stride in remaining blocks
- ~30 errors: Test files (lower priority)
- ~10 errors: Other issues (exports, parameter counts)

## Key Files Modified

- `src/main.ts` - Storage key bump (critical fix)
- `src/blocks/adapter-blocks.ts` - All 10 adapters fixed
- `src/blocks/math-blocks.ts` - Type narrowing and Add/Sub/Mul/Div/Mod fixed
- `src/blocks/color-blocks.ts` - ValueRefPacked fixes
- `src/blocks/event-blocks.ts` - ValueRefPacked fixes
- `src/blocks/expression-blocks.ts` - ValueRefPacked fixes
- `src/blocks/field-blocks.ts` - ValueRefPacked fixes
- `src/blocks/array-blocks.ts` - ValueRefPacked fixes
- `src/blocks/camera-block.ts` - ValueRefPacked fixes
- `src/blocks/field-operations-blocks.ts` - ValueRefPacked fixes

## Next Steps

1. **Apply remaining ValueRefPacked fixes** (~2-3 hours of work):
   - Use pattern in VALUEREF_FIX_PATTERN.md
   - Apply to 10 remaining block files
   - Run build after each file to verify

2. **Fix test file issues** (if needed):
   - RenderAssembler tests expect different API
   - expression-blocks tests need ValueRefPacked with type/stride
   - These are lower priority

3. **Verify deployment**:
   - Run `npm run build` - should pass type check
   - Run `npm run test` - verify no regressions
   - Test app in browser - patches should load without "Port does not exist" errors

## Root Cause (For Reference)

**The Problem**: Commit 4243c1d renamed field operation blocks (FieldSinâ†’Sin, etc.) but did NOT bump the storage key. Older patches in localStorage contained the old block type strings, causing "Port does not exist" errors during compilation.

**The Solution**: Bump storage key to v10, forcing fresh patch load.

**The ValueRefPacked Issue**: Commit 7fd3a6a changed the ValueRefPacked type to require type and stride fields. This is a correct change but broke all blocks that return these values.

## Related Commits

- 4243c1d - feat: genericize field operation blocks (caused the original bug)
- 7fd3a6a - DO NOT REVERT: Expert fix for projection stride-2 output contract (added ValueRefPacked fields)
- 562fd9f - First batch of block fixes (adapter, math, array, camera, etc.)
- bcd91a9 - Second batch of block fixes (color, event, expression, field)
- 9bca033 - Math blocks type narrowing and storage key bump

## Evidence of Progress

From npm run build error counts:
- Initial state: 300+ errors
- After first fixes: 250+ errors
- Current state: ~110 errors
- Expected after remaining fixes: 0-20 errors (tests only)

Commits made:
- 9bca033 (latest)
- bcd91a9
- 562fd9f
- And related fixes in planning

All changes follow the spec and architectural guidelines.
