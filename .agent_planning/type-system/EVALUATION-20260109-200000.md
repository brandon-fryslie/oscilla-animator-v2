# TYPE SYSTEM EVALUATION: P4-P6 Remaining Work

**Generated**: 2026-01-09T20:00:00Z
**Status**: EVALUATION COMPLETE
**Focus**: P4 (Runtime Migration), P5 (IR Constraint Solving), P6 (Bus System Migration)

---

## Executive Summary

The type system foundation (P0-P3) is **COMPLETE and canonical**. The next three phases require:

1. **P4: Runtime Migration** - Integrate SignalType metadata into runtime evaluator and value slots
2. **P5: IR Constraint Solving** - Implement cardinality inference, temporality checking, domain alignment
3. **P6: Bus System Migration** - Add bus port type declarations and combine mode rules

**Key Finding**: The two type systems (old `TypeDesc` / new `SignalType`) coexist with 94 remaining TypeDesc references. This transitional state is intentional and manageable.

---

## Current State: What Exists

### P0-P3 Complete
- **Canonical Type System** (`src/core/canonical-types.ts`, 583 lines)
  - 5-axis coordinate (Cardinality, Temporality, Binding, Perspective, Branch)
  - AxisTag pattern for default semantics
  - Axis unification with strict join rules
  - Domain declarations (fixed_count, grid_2d, voices, mesh_vertices)
  - Helper functions: `signalTypeSignal()`, `signalTypeField()`, etc.

- **Type Tests** (`src/core/__tests__/canonical-types.test.ts`, 52 tests)
  - Full coverage of construction and unification

- **Block Registry** (25 blocks migrated)
  - All blocks use SignalType for port declarations

### Coexisting Systems
- **Old TypeDesc** (`src/core/types.ts`): 94 references remain
  - Still used in: IR program.ts, compiler passes, runtime Materializer
  - Contains: world (signal/event/field/scalar/config), domain, category, busEligible, lanes

- **New SignalType** (`src/core/canonical-types.ts`): Primary system
  - Used by all new blocks, IR types, spec documents

---

## P4: Runtime Migration

**Goal**: Integrate SignalType metadata into runtime evaluation and value slot management.

### What Exists Now
- `src/runtime/RuntimeState.ts` - Frame execution container, no type metadata in slots
- `src/runtime/SignalEvaluator.ts` - Unified signal evaluation, no type metadata used
- `src/runtime/Materializer.ts` - Uses expr.type (SignalType from IR) already
- `src/runtime/BufferPool.ts` - Uses payload type for buffer allocation

### What Needs to Happen
1. **SlotMetaEntry Type Metadata** - Add axes + shape to slot metadata
2. **ValueSlot Metadata Lookup** - Cached slot type info for O(1) lookup
3. **Runtime Type Assertions** - Debug mode validation hooks
4. **Cardinality Handling** - Track cardinality to validate operations

### Files Needing Changes
| File | Change | Priority |
|------|--------|----------|
| `src/runtime/RuntimeState.ts` | Add type metadata to slots | HIGH |
| `src/compiler/ir/program.ts` | Populate slotMeta with types | HIGH |
| `src/runtime/SignalEvaluator.ts` | Type assertions (debug) | MEDIUM |
| `src/compiler/ir/builder.ts` | Assign axes to expressions | MEDIUM |

---

## P5: IR Constraint Solving

**Goal**: Implement cardinality inference, temporality checking, and domain alignment.

### What Needs to Happen
1. **Cardinality Inference** - Backward propagation from sinks
2. **Temporality Compatibility** - Continuous/discrete checking
3. **Domain Alignment** - many(D1) + many(D2) only if D1 === D2
4. **Combine Mode Rules** - Per-mode validation

### Files to Create
| File | Purpose | Est. Lines |
|------|---------|-----------|
| `src/compiler/ir/constraintSolver.ts` | Orchestrator | 100-150 |
| `src/compiler/ir/cardinalityInference.ts` | Backward inference | 150-200 |
| `src/compiler/ir/temporalityCheck.ts` | Temporal validation | 100-150 |
| `src/compiler/ir/domainAlignment.ts` | Domain checking | 80-120 |

---

## P6: Bus System Migration

**Goal**: Migrate bus port declarations to SignalType and implement combine modes.

### What Needs to Happen
1. **Bus Port Declaration** - Update Bus interface to use SignalType + CombineMode
2. **Combine Mode Validation** - Mode-specific constraint checking
3. **Reserved Bus Types** - Compile-time validation (phaseA, pulse, energy, palette)

### Files Needing Changes
| File | Change | Priority |
|------|--------|----------|
| `src/types/index.ts` | Update Bus interface | HIGH |
| `src/compiler/passes-v2/combine-utils.ts` | Mode validation | MEDIUM |
| `src/compiler/passes-v2/resolveWriters.ts` | Type-check validity | MEDIUM |

---

## Key Ambiguities

**A1: TypeDesc → SignalType Migration Strategy**
- Keep both during P4, consolidate in P5
- Create adapter function for interop

**A2: Default Combine Mode**
- Default to `writerWins`, warn in compiler

**A3: Phase Type Checking Location**
- Enforce in P5 constraint solver (compile time)

**A4: Perspective/Branch in v0**
- Store but don't enforce; add validation later

**A5: Cardinality Mismatch Handling**
- Error in v0 with suggestion (no auto-fix)

---

## Dependencies and Ordering

```
P4 Runtime Migration
├─ depends on: P0-P3 (complete)
├─ blocks: P5
└─ provides: Type metadata infrastructure

P5 IR Constraint Solving
├─ depends on: P4 (slotMeta)
├─ blocks: P6
└─ provides: Type safety in compilation

P6 Bus System Migration
├─ depends on: P5 (combine validation)
└─ provides: Complete migration
```

**Critical Path**: P4 → P5 → P6 (sequential)

---

## Verdict: CONTINUE

Ready for planning. All gaps are well-understood and unblocked by P0-P3 foundation.
