# Explore: Render Pipeline Technical Debt Cleanup (ms5)
Timestamp: 2026-01-24-042900
Git Commit: 9e4f11e

## Files Examined

### Key Source Files
- `/Users/bmf/code/oscilla-animator-v2/src/compiler/ir/program.ts` - CompiledProgramIR with OutputSpecIR definition
- `/Users/bmf/code/oscilla-animator-v2/src/compiler/ir/types.ts` - StepRender, PureFn, FieldExprArray, IntrinsicPropertyName
- `/Users/bmf/code/oscilla-animator-v2/src/compiler/compile.ts` - convertLinkedIRToProgram (line 452: outputs = empty array)
- `/Users/bmf/code/oscilla-animator-v2/src/runtime/ScheduleExecutor.ts` - executeFrame with outputs handling
- `/Users/bmf/code/oscilla-animator-v2/src/runtime/RenderAssembler.ts` - assembleRenderPass, assembleDrawPathInstancesOp
- `/Users/bmf/code/oscilla-animator-v2/src/runtime/SignalEvaluator.ts` - PureFn 'expr' kind throws "not yet implemented"
- `/Users/bmf/code/oscilla-animator-v2/src/runtime/Materializer.ts` - FieldExprArray is placeholder (fills with index)
- `/Users/bmf/code/oscilla-animator-v2/src/runtime/FieldKernels.ts` - fieldGoldenAngle with hardcoded turns=50
- `/Users/bmf/code/oscilla-animator-v2/src/blocks/render-blocks.ts` - RenderCircle, RenderRect, RenderInstances2D
- `/Users/bmf/code/oscilla-animator-v2/src/render/future-types.ts` - DrawPathInstancesOp, RenderFrameIR_Future
- `/Users/bmf/code/oscilla-animator-v2/src/runtime/ContinuityApply.ts` - contains debug console.log statements

### Findings

#### ms5.4 - OutputSpecIR
- `compile.ts:452-453`: `const outputs: any[] = [];` with comment "TBD - for now return empty array"
- `ScheduleExecutor.ts:536-558`: Runtime DOES handle outputs, but relies on fallback path at line 558 (returns frame directly when outputs is empty)
- OutputSpecIR type defined but never populated by compiler

#### ms5.5 - RenderCircle/RenderRect
- Both blocks exist in `src/blocks/render-blocks.ts`
- Their lower() functions return `{ outputsById: {} }` (empty - render blocks are sinks)
- They do NOT produce StepRender with shape info - no topology wiring
- Comment at line 11: "Shape encoding (for shape input): 0 = circle, 1 = square, 2 = triangle" - LEGACY numeric encoding
- RenderInstances2D is the proper replacement (uses topology-based shapes)

#### ms5.7 - DrawPrimitiveInstancesOp
- `RenderAssembler.ts:918-920`: Explicit early-return for primitive topologies with comment "Future work: DrawPrimitiveInstancesOp"
- `future-types.ts`: DrawOp union is `DrawPathInstancesOp` only - no primitive variant defined
- Primitive topologies (ellipse, rect) silently produce empty arrays from assembleDrawPathInstancesOp

#### ms5.8 - v1->v2 migration
- Both v1 path (assembleRenderPass -> RenderPassIR) and v2 path (assembleDrawPathInstancesOp -> DrawPathInstancesOp) coexist
- ScheduleExecutor.ts only calls v1 path (assembleRenderPass at line 298)
- v2 path exists but is never called from the main execution loop
- RenderFrameIR version is 1, RenderFrameIR_Future version is 2

#### ms5.9 - .bak files and debug logging
- No .bak files found (already cleaned by commit 89f4c5a)
- Debug console.log statements found in ContinuityApply.ts (lines 346-348, 401, 413, 416, 418, 434, 437, 453, 488, 533, 543)
- Also debug logs in test files (project-policy-domain-change.test.ts)

#### ms5.11 - Intrinsics documentation
- IntrinsicPropertyName in types.ts: 'index' | 'normalizedIndex' | 'randomId' (3 items)
- .claude/rules/compiler/intrinsics.md documents 5: index, normalizedIndex, randomId, position, radius
- position and radius are NOT in the type union
- Domain registry (domain-registry.ts) references INTRINSICS.radius for circles

#### ms5.12 - FieldExprArray placeholder
- Materializer.ts line 352-362: case 'array' fills with `arr[i] = i` (just index)
- Comment says "TODO: Support actual element values when blocks provide them"
- FieldExprArray type only has instanceId and type - no element-value expression

#### ms5.13 - fieldGoldenAngle turns
- FieldKernels.ts line 362: `const turns = 50;` (hardcoded)
- Block definition (field-operations-blocks.ts line 544): has `turns` input with value: 50, but it's `hidden: true` and `exposedAsPort: false`
- The block's lower() function uses fieldZip but doesn't pass turns signal through
- Kernel receives no signal inputs, so turns cannot be dynamic

#### ms5.14 - StepRender shape/scale optionality
- StepRender.shape is typed as optional (`readonly shape?: ...`)
- StepRender.scale is typed as optional (`readonly scale?: ...`)
- RenderAssembler.ts resolveShape (line 269): throws if shape is undefined
- RenderAssembler.ts resolveScale (line 238): throws if scale is undefined
- Types say optional, runtime says required - contradiction

#### ms5.15 - rotation and scale2 through IR
- RenderPassIR has rotation? and scale2? fields defined
- RenderAssembler.ts:937-938: `undefined, // rotation - not yet wired through IR` and `undefined  // scale2 - not yet wired through IR`
- StepRender type has NO rotation or scale2 fields
- assemblePerInstanceShapes (line 722-723): same comments

#### ms5.17 - PureFn 'expr' kind
- types.ts line 302: `{ readonly kind: 'expr'; readonly expr: string }`
- SignalEvaluator.ts line 233: `case 'expr': throw new Error("PureFn kind 'expr' not yet implemented")`
- No parser or evaluator exists for expression DSL

#### ms5.18 - future-types.ts migration comments
- Lines 197-217: Migration path comments reference "Phase 6" as future
- Lines 147-149: "CURRENT STATE: Definition only" / "FUTURE STATE: Primary render operation"
- v2 assembler functions exist and work (tested), but comments say "not yet used"

## Build/Test Status
- TypeScript typechecks clean
- 79 test files, 1250 tests all pass
- No .bak files remain
