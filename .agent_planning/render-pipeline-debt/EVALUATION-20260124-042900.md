# Evaluation: Render Pipeline Technical Debt Cleanup (ms5)
Timestamp: 2026-01-24-042900
Git Commit: 9e4f11e

## Executive Summary
Overall: 33% complete (6/18 closed) | Critical issues: 2 | Tests reliable: yes (all 1250 pass)

The 12 open items have clear dependency ordering. The critical finding is that **ms5.4 (OutputSpecIR)** and **ms5.8 (v1->v2 migration)** are the structural backbone -- most other items are either prerequisites for ms5.8 or independent cleanups. The codebase is in a consistent state: types check clean, tests pass, and the v1 path works. The v2 path code exists but is never called from the main execution loop.

## Runtime Check Results
| Check | Status | Output |
|-------|--------|--------|
| TypeScript typecheck | PASS | Clean (no errors) |
| Test suite | PASS | 79 files, 1250 tests, 0 failures |
| .bak files | RESOLVED | None found (commit 89f4c5a cleaned them) |
| Debug logging in runtime | PRESENT | 13 console.log statements in ContinuityApply.ts |

## Findings

### ms5.4 - Wire OutputSpecIR
**Status**: STUB
**Evidence**: `src/compiler/compile.ts:452-453`: `const outputs: any[] = [];` with comment "TBD - for now return empty array"
**Issues**:
- The type is defined (`OutputSpecIR` in program.ts:133-138)
- The runtime consumer exists (ScheduleExecutor.ts:536-554 handles outputs)
- But the compiler never populates the array
- Runtime falls through to line 558 fallback: `return frame;` which works but bypasses the outputs contract
- This means the "Runtime MUST read from program.outputs[0].slot" invariant (program.ts:131) is currently violated -- runtime works via fallback, not via spec
**Complexity**: LOW -- allocate a slot in the compiler, push an OutputSpecIR entry, done
**Blockers**: None

### ms5.5 - Replace RenderCircle/RenderRect
**Status**: PARTIAL (dead code, but replacement exists)
**Evidence**:
- `src/blocks/render-blocks.ts:17-116`: Both blocks registered, lower() returns empty `outputsById`
- `RenderInstances2D` (same file, line 122-171) is the proper replacement with topology-based shapes
- `render-blocks.ts:6-9`: Legacy comment "Shape encoding: 0=circle, 1=square, 2=triangle" still present
- Test references: `cardinality-metadata.test.ts:84` and `cardinality-specialization.test.ts:81` reference RenderCircle
**Issues**:
- RenderCircle/RenderRect lower() functions don't emit StepRender at all (they're no-ops as sinks)
- They exist for backward compatibility with old patches but produce no render output
- Need to either: (a) remove them and redirect to RenderInstances2D, or (b) make them emit proper topology-based StepRender
- Tests reference them for cardinality metadata validation (these tests need updating if blocks removed)
**Complexity**: MEDIUM -- removing them requires updating tests and patch migration

### ms5.7 - DrawPrimitiveInstancesOp
**Status**: NOT_STARTED
**Evidence**: `src/runtime/RenderAssembler.ts:917-920`:
```typescript
if (resolvedShape.mode !== 'path') {
    // For now, return empty array for primitive topologies
    // Future work: DrawPrimitiveInstancesOp
    return [];
}
```
- `src/render/future-types.ts:194`: `export type DrawOp = DrawPathInstancesOp;` (no primitive variant)
**Issues**:
- Primitive topologies (ellipse, rect) silently produce empty arrays from the v2 path
- No type definition exists for DrawPrimitiveInstancesOp
- v1 path handles primitives fine via `resolvedShape.mode === 'primitive'` + params
**Complexity**: MEDIUM -- need to define the type, add assembly logic, update DrawOp union
**Blocker for ms5.8**: YES -- cannot complete v2 migration if primitives silently drop

### ms5.8 - Complete v1->v2 migration
**Status**: PARTIAL (v2 code exists, not wired to execution)
**Evidence**:
- `ScheduleExecutor.ts:298`: Only calls `assembleRenderPass` (v1 path)
- `RenderAssembler.ts:962-977`: `assembleRenderFrame_v2()` exists and is tested but never called from executeFrame
- Two complete parallel paths exist: v1 (RenderPassIR) and v2 (DrawPathInstancesOp)
**Issues**:
- This is the META-GOAL. Completing it requires:
  1. ms5.7 (primitives in v2)
  2. ms5.15 (rotation/scale2 in v2)
  3. ms5.4 (outputs contract -- nice to have, not strictly required)
  4. Switching executeFrame to call v2 path
  5. Updating renderer to consume RenderFrameIR_Future
  6. Removing v1 path
- The renderer consumer side hasn't been examined in this evaluation
**Complexity**: HIGH -- orchestrating the switchover with renderer changes
**Blockers**: ms5.7, ms5.15

### ms5.9 - Remove .bak files and debug logging
**Status**: PARTIAL (bak files resolved, logging remains)
**Evidence**:
- .bak files: 0 found (cleaned in commit 89f4c5a)
- Debug logging: 13 `console.log` statements in `src/runtime/ContinuityApply.ts` (lines 346-348, 401, 413, 416, 418, 434, 437, 453, 488, 533, 543)
- Additional debug logs in test file `project-policy-domain-change.test.ts` (lines 552-580)
**Issues**:
- ContinuityApply debug logs are unconditional -- they fire every time continuity runs
- These will pollute browser console in production
- Test logs are acceptable (tests are verbose by design)
**Complexity**: LOW -- delete the console.log lines or gate behind a debug flag

### ms5.11 - Align intrinsics documentation
**Status**: NOT_STARTED
**Evidence**:
- `.claude/rules/compiler/intrinsics.md` documents 5 intrinsics: index, normalizedIndex, randomId, position, radius
- `src/compiler/ir/types.ts:174-177`: `IntrinsicPropertyName = 'index' | 'normalizedIndex' | 'randomId'` (only 3)
- `src/core/domain-registry.ts:111`: References `INTRINSICS.radius` for circle domain
- `src/runtime/Materializer.ts`: No case for 'position' or 'radius' intrinsics in fillBuffer
**Issues**:
- Documentation claims position and radius are intrinsics
- Type system and runtime don't support them as IntrinsicPropertyName members
- Position and radius ARE computed by layout kernels (circleLayout, etc.) but NOT as intrinsics
- Question: Should docs be updated to match code, or code to match docs?
**Complexity**: LOW if updating docs, MEDIUM if adding position/radius to type union + materializer

### ms5.12 - FieldExprArray placeholder
**Status**: STUB
**Evidence**: `src/runtime/Materializer.ts:352-362`:
```typescript
case 'array': {
    // Array field expression: Stage 2 of three-stage architecture
    // This represents the identity field of the instance
    // For now, we'll fill with the index as a placeholder
    // TODO: Support actual element values when blocks provide them
    const arr = buffer as Float32Array;
    for (let i = 0; i < N; i++) {
        arr[i] = i;
    }
    break;
}
```
- `FieldExprArray` in types.ts only has `instanceId` and `type` -- no expression or value reference
**Issues**:
- Currently produces the same output as `intrinsic 'index'` -- making it redundant
- The type would need an `elements` field to carry actual per-element values
- Unclear what "element-value materialization" means specifically -- is this a user-provided array literal? A computed array? An external data source?
**Complexity**: MEDIUM -- requires design decision on what FieldExprArray semantically means

### ms5.13 - fieldGoldenAngle turns configurable
**Status**: STUB (infrastructure exists but not wired)
**Evidence**:
- `src/runtime/FieldKernels.ts:362`: `const turns = 50;` (hardcoded constant)
- `src/blocks/field-operations-blocks.ts:544`: Block declares `turns` input with `value: 50, exposedAsPort: false, hidden: true`
- Block's lower() uses `ctx.b.fieldZip([id01.id], goldenAngleFn, ...)` -- passes only id01, no turns signal
**Issues**:
- The block declares turns as an input but never passes it to the kernel
- Making it configurable requires:
  1. Change kernel to zipSig (field + signal inputs)
  2. Pass turns signal from block lower()
  3. Update kernel to read turns from signal input
- Or: keep it as a constant but make the constant come from the block config at compile time
**Complexity**: LOW-MEDIUM -- well-defined change with existing infrastructure patterns

### ms5.14 - StepRender shape/scale optionality
**Status**: NOT_STARTED (type/runtime contradiction exists)
**Evidence**:
- `types.ts:464`: `readonly scale?: { ... }` (optional)
- `types.ts:466`: `readonly shape?: ...` (optional)
- `RenderAssembler.ts:238-242`: `if (scaleSpec === undefined) { throw new Error(...) }`
- `RenderAssembler.ts:269-273`: `if (shapeSpec === undefined) { throw new Error(...) }`
**Issues**:
- Types say optional, runtime throws if undefined
- This means TypeScript won't catch a compiler bug that forgets to set shape/scale
- Fix options: (a) make types required (non-optional), or (b) make runtime handle undefined gracefully
- Given the RenderAssembler comments say "MUST be provided", the correct fix is making types required
**Complexity**: LOW -- change `?:` to `:` in type definition, fix any compile errors

### ms5.15 - Wire rotation and scale2
**Status**: NOT_STARTED
**Evidence**:
- `RenderAssembler.ts:937-938`: `undefined, // rotation - not yet wired through IR` and `undefined  // scale2 - not yet wired through IR`
- `RenderAssembler.ts:722-723`: Same in per-instance path
- `StepRender` type (types.ts:456-471): No rotation or scale2 fields
- `RenderPassIR` (ScheduleExecutor.ts:114-121): HAS rotation? and scale2? fields
- `InstanceTransforms` (future-types.ts:130-131): HAS rotation? and scale2? fields
**Issues**:
- The output types support rotation/scale2 but the IR input type (StepRender) has no way to carry them
- Need: add fields to StepRender, have block lowering emit them, have assembler read them
- Prerequisite question: which blocks produce rotation/scale2? Only RenderInstances2D? Are there signal-level rotation inputs?
**Complexity**: MEDIUM -- requires IR extension + compiler wiring + assembler reading
**Blocker for ms5.8**: YES -- v2 migration incomplete without these transform channels

### ms5.17 - PureFn 'expr' kind
**Status**: NOT_STARTED (type exists, runtime throws)
**Evidence**: `src/runtime/SignalEvaluator.ts:232-233`:
```typescript
case 'expr':
    throw new Error(`PureFn kind 'expr' not yet implemented`);
```
- `types.ts:302`: `{ readonly kind: 'expr'; readonly expr: string }`
- No parser, no evaluator, no tests for expression evaluation
**Issues**:
- The type is in the PureFn union, which means exhaustive checks include it
- But it's a pure throw -- using it causes runtime failure
- Question: Is this needed now? What expressions would it evaluate? Is this a user DSL?
- If not needed near-term, could be removed from union to make it impossible to emit
**Complexity**: HIGH if implementing a real expression evaluator, LOW if removing from type

### ms5.18 - Update future-types.ts migration comments
**Status**: NOT_STARTED (comments outdated)
**Evidence**:
- `future-types.ts:147-149`: "CURRENT STATE: Definition only, not yet used" / "FUTURE STATE: Primary render operation emitted by RenderAssembler"
- Reality: `assembleRenderFrame_v2()` and `assembleDrawPathInstancesOp()` exist and ARE used (tested)
- `future-types.ts:197-217`: Migration path references "Phase 6 Prep (current)" and "Phase 6 Implementation (future)"
- Several Phase 6 items are already implemented
**Issues**:
- Comments suggest nothing is done, but substantial v2 assembly code exists
- Comments should reflect that v2 assembly exists but isn't wired to the main loop yet
**Complexity**: LOW -- update text in comments

## Dependency Graph

```
Independent (can be done in parallel, no deps):
  ms5.9  - Remove debug logging (trivial)
  ms5.11 - Align intrinsics docs (trivial if doc-only)
  ms5.13 - fieldGoldenAngle turns (localized)
  ms5.14 - StepRender optionality fix (type-only)
  ms5.18 - Update comments (trivial)

Sequential chain (blockers for ms5.8):
  ms5.4  - Wire OutputSpecIR (independent, but nice-to-have for ms5.8)
  ms5.7  - DrawPrimitiveInstancesOp (REQUIRED for ms5.8)
  ms5.15 - Wire rotation/scale2 (REQUIRED for ms5.8)
  ms5.8  - Complete v1->v2 migration (depends on ms5.7, ms5.15)
  ms5.5  - Replace RenderCircle/RenderRect (depends on ms5.8 for clean removal)

Needs design clarification first:
  ms5.12 - FieldExprArray (semantics unclear)
  ms5.17 - PureFn 'expr' (scope unclear -- remove or implement?)
```

## Ambiguities Found
| Area | Question | How LLM Guessed | Impact |
|------|----------|-----------------|--------|
| ms5.11 | Should intrinsics docs match code (remove position/radius from docs) or code match docs (add them)? | Not guessed -- left as mismatch | LOW -- doesn't block other work |
| ms5.12 | What does FieldExprArray *mean* semantically? User-provided literals? Computed arrays? | Guessed "identity field" and filled with index | MEDIUM -- placeholder is functionally identical to 'index' intrinsic |
| ms5.17 | Is PureFn 'expr' needed at all? What expressions? | Left as throw | LOW if unused, HIGH if user-facing DSL is planned |
| ms5.5 | Remove RenderCircle/RenderRect or convert to topology-based? | Left both coexisting | LOW -- they're no-ops currently |
| ms5.15 | Which blocks produce rotation/scale2? Signal or field? | Left undefined in StepRender | MEDIUM -- needed for full v2 migration |

## Recommendations
1. **Quick wins first (parallel, no deps)**: ms5.9, ms5.14, ms5.18, ms5.11 (doc-only) -- all trivial, clean up noise
2. **ms5.4 (OutputSpecIR)**: Low complexity, fixes an architectural invariant violation. Do this next.
3. **ms5.7 (DrawPrimitiveInstancesOp)**: Required blocker for ms5.8. Define type, implement assembly.
4. **ms5.15 (rotation/scale2)**: Required blocker for ms5.8. Add fields to StepRender, wire through.
5. **ms5.8 (v1->v2 migration)**: Only after ms5.7 + ms5.15. Switch executeFrame to v2 path.
6. **Clarify before implementing**: ms5.12 (what are array elements?), ms5.17 (remove or implement expr?)
7. **ms5.5 last**: Remove dead blocks only after ms5.8 proves the replacement works.
8. **ms5.13**: Low priority, well-defined -- can be done anytime.

## Verdict
- [x] CONTINUE - Issues clear, implementer can fix

All items are well-defined enough to implement without further clarification EXCEPT:
- ms5.12: Needs a design decision on what FieldExprArray semantically represents
- ms5.17: Needs a decision on whether to implement or remove

Neither of these blocks the critical path (ms5.7 -> ms5.15 -> ms5.8).
