# Exploration: Domain Transformation System (Adapters)
Generated: 2026-01-25-084700
Epic: oscilla-animator-v2-8m2

## Raw Facts Gathered

### Current Adapter Implementation Status

**Unit Adapters (COMPLETE):**
- `src/graph/adapters.ts` - Full adapter registry with 10 unit adapters + Broadcast
- `src/blocks/adapter-blocks.ts` - All 10 adapter block definitions registered
- `src/graph/passes/pass2-adapters.ts` - Compiler pass for auto-insertion
- Tests passing: 31 tests in adapters.test.ts and pass2-adapters.test.ts

**Implemented Adapters:**
1. PhaseToScalar01, ScalarToPhase01
2. PhaseToRadians, RadiansToPhase01
3. DegreesToRadians, RadiansToDegrees
4. MsToSeconds, SecondsToMs
5. ScalarToNorm01Clamp, Norm01ToScalar
6. Broadcast (cardinality: one -> many)
7. ScalarToDeg (additional)

### The `canTransformDomain` Stub

Located at `src/ui/reactFlowEditor/typeValidation.ts:175-179`:
```typescript
function canTransformDomain(fromDomain: string, toDomain: string): boolean {
  // Stub: No transformation system implemented yet
  // When domain transformation system is ready, check it here
  return false;
}
```

Called from `isTypeCompatible()` at line 238:
```typescript
// For 'many' cardinality, check domain compatibility
if (fromCard.kind === 'many' && toCard.kind === 'many') {
  const fromInstance = fromCard.instance;
  const toInstance = toCard.instance;
  if (!fromInstance || !toInstance) return false;
  if (fromInstance.instanceId !== toInstance.instanceId) return false;
  if (fromInstance.domainType === toInstance.domainType) {
    return true;
  }
  return canTransformDomain(fromInstance.domainType, toInstance.domainType);
}
```

### Domain System Implementation

**Domain Registry** (`src/core/domain-registry.ts`):
- Domain types: shape, circle, rectangle, control, event
- Hierarchy: circle/rectangle extend shape
- `isSubdomainOf()` exists for subtype checking
- No transformation registry

**InstanceRef structure** (`src/core/canonical-types.ts:257-261`):
```typescript
interface InstanceRef {
  readonly kind: 'instance';
  readonly domainType: string; // DomainTypeId
  readonly instanceId: string; // InstanceId
}
```

### What "Domain Transformation" Actually Means

From epic description: "position -> normalized_position"

Looking at the codebase:
- `position` is NOT a domain - it's an intrinsic property of shapes
- Domain types are: shape, circle, rectangle, control, event
- The epic example doesn't align with current domain model

**Key distinction:**
- Unit adapters: float:phase01 -> float:radians (same cardinality, different unit)
- Domain transformation: Field<T>[circles-1] -> Field<T>[shapes-1] (same type, different instance)

### Compiler Domain Handling

`src/compiler/passes-v2/pass2-types.ts:117-119`:
```typescript
// Instances match if both domainType and instanceId are equal
return fromInstance.domainType === toInstance.domainType &&
       fromInstance.instanceId === toInstance.instanceId;
```

The compiler requires **exact** instance matching - both domainType AND instanceId must match.

### Spec References

**Type system spec** (`design-docs/CANONICAL-oscilla-v2.5-20260109/topics/01-type-system.md`):
- Line 436-438: "Subtyping rules: Operations valid for shape are valid for all subtypes... Field<circle> can be passed where Field<shape> expected (covariance)"
- This describes **domain subtyping** not domain transformation

**Units-and-Adapters spec** (`design-docs/_new/0-Units-and-Adapters.md`):
- Covers only unit adapters (payload, unit) -> (payload, unit)
- No mention of domain transformation
- Part B covers adapter registry - only for unit conversion

### PortHighlightStore Integration

`src/stores/PortHighlightStore.ts`:
- Uses `validateConnection()` from typeValidation.ts
- `validateConnection()` already checks for adapter availability via `findAdapter()`
- Will automatically highlight compatible ports when adapter is found

### Existing Planning Documents

`.agent_planning/units-and-adapters/SPRINT-2026-01-22-adapter-editor-PLAN.md`:
- Status: RESEARCH REQUIRED
- Focuses on editor UI for adapters (badges, auto-insertion UX)
- Research tasks: ReactFlow rendering, storage location, undo/redo
- Does not address domain transformation specifically

### Test Evidence

All 31 adapter tests pass - the unit adapter system works.
No domain transformation tests exist.
