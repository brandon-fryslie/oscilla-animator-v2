# Evaluation: Domain Transformation System (Adapters)
Timestamp: 2026-01-25-084700
Git Commit: 141705b
Epic: oscilla-animator-v2-8m2

## Executive Summary
Overall: 15% complete | Critical issues: 3 | Tests reliable: yes (for existing scope)

**Key Finding**: The epic conflates three distinct concepts that are currently at different implementation stages:
1. **Unit Adapters** - COMPLETE (10 adapters, tests passing)
2. **Domain Subtyping** - PARTIALLY IMPLEMENTED (hierarchy exists, covariance NOT enforced)
3. **Domain Transformation** - NOT STARTED (stub exists, no spec)

The epic description example "position -> normalized_position" is not a domain transformation - `position` is an intrinsic property, not a domain. This suggests the epic was written with a different mental model than the current architecture.

## Runtime Check Results

| Check | Status | Output |
|-------|--------|--------|
| npm run test adapters | PASS | 31 tests pass |
| npm run typecheck | PASS | No type errors |
| canTransformDomain stub | STUB | Returns false always |
| Domain subtyping in pass2-types | EXACT | Requires exact match |

## Missing Checks

1. **E2E test for domain covariance** - No test verifies Field<circle> can connect to Field<shape> port
2. **Integration test for adapter UI highlighting** - No test that PortHighlightStore shows transformable ports
3. **Spec for domain transformation** - No canonical spec defines what transformations are valid

## Findings

### 1. Unit Adapter System
**Status**: COMPLETE
**Evidence**:
- `src/graph/adapters.ts:75-208` - All 10 required adapters plus Broadcast
- `src/blocks/adapter-blocks.ts` - All block definitions with lower() implementations
- `src/graph/__tests__/adapters.test.ts` - 22 tests covering all conversions
- `src/graph/__tests__/pass2-adapters.test.ts` - 9 tests for compiler pass
**Issues**: None. This component is fully functional and tested.

### 2. The `canTransformDomain` Stub
**Status**: STUB
**Evidence**: `src/ui/reactFlowEditor/typeValidation.ts:175-179`
```typescript
function canTransformDomain(fromDomain: string, toDomain: string): boolean {
  // Stub: No transformation system implemented yet
  return false;
}
```
**Issues**:
- Stub always returns false
- No registry or spec to check against
- Epic example "position -> normalized_position" is not a domain transformation

### 3. Domain Subtyping (Covariance)
**Status**: PARTIAL
**Evidence**:
- `src/core/domain-registry.ts:154-159` - `isSubdomainOf()` correctly implements hierarchy
- `src/compiler/passes-v2/pass2-types.ts:117-119` - DOES NOT use isSubdomainOf, requires exact match
- Spec states (01-type-system.md:438): "Field<circle> can be passed where Field<shape> expected (covariance)"
**Issues**:
- Spec says covariance should work, but compiler enforces exact match
- This is a spec-code contradiction that must be resolved

### 4. Domain Transformation Concept Confusion
**Status**: UNCLEAR
**Evidence**: Epic description says "position -> normalized_position" but:
- `position` is an intrinsic property of shape domain (domain-registry.ts:77)
- `normalized_position` doesn't exist in codebase
- This appears to describe a coordinate transformation, not a domain transformation
**Issues**:
- Epic may be describing a **different feature** than what the stub implies
- Need clarification on what "domain transformation" actually means

### 5. PortHighlightStore Integration
**Status**: READY (when domain logic is implemented)
**Evidence**: `src/stores/PortHighlightStore.ts:66-84` - Already calls validateConnection
**Issues**: None - will work automatically when canTransformDomain returns true

## Ambiguities Found

| Area | Question | How LLM Guessed | Impact |
|------|----------|-----------------|--------|
| Epic scope | What does "position -> normalized_position" mean? | Assumed domain transformation | Entire feature design may be wrong |
| Domain covariance | Should Field<circle> connect to Field<shape>? | Spec says yes, code says no | Core type system contradiction |
| Instance identity | Can Field[inst-A] connect to Field[inst-B] of compatible domain? | Assumed no (current behavior) | Determines if adapters are needed |
| Transformation registry | Where should domain transformations be defined? | No guess made | No implementation path without spec |

## Critical Design Questions (MUST RESOLVE)

### Q1: What is a "domain transformation"?

**Current understanding**: Domains are ontological types (shape, circle, control, event). The only "transformation" that makes sense is:
- **Covariance**: circle can be treated as shape
- **Reprojection**: same domain, different instance (not currently supported)

The epic example suggests something else entirely. Need clarification.

### Q2: Should domain subtyping (covariance) work?

**Spec says yes**: "Field<circle> can be passed where Field<shape> expected"
**Code says no**: pass2-types.ts requires exact domainType AND instanceId match

One of these must be wrong. If spec is correct, this is a bug to fix. If code is correct, spec needs updating.

### Q3: What about instance identity?

Current code requires `instanceId` to match exactly. This means Field<circle>[circles-1] cannot connect to Field<circle>[circles-2] even though domain is same.

Is this intentional? If domain transformation allows connecting different instances of same/compatible domain, what are the semantics?

### Q4: Where is the spec for domain transformations?

- `0-Units-and-Adapters.md` only covers unit adapters
- No spec file defines domain transformation rules
- Cannot implement without authoritative design

## Recommendations

### 1. Clarify Epic Intent (BEFORE ANY WORK)
The epic description doesn't match the architecture. Before implementation:
- Is this about **domain covariance** (circle -> shape)?
- Is this about **coordinate space transformation** (world -> screen)?
- Is this about **instance reprojection** (different instance, same domain)?

### 2. Fix Spec-Code Contradiction
Either:
- Update pass2-types.ts to use isSubdomainOf() for covariance
- Or update spec to remove covariance claim

### 3. Write Domain Transformation Spec
If domain transformation is a real feature, it needs a spec covering:
- Valid transformations
- Adapter semantics (what does the adapter actually DO?)
- Instance identity rules
- Compile-time vs runtime behavior

### 4. Scope to What's Actually Needed
Based on exploration, the most likely actual needs are:
- **Sprint A**: Domain covariance (circle -> shape) - fix type checker
- **Sprint B**: UI highlighting for domain-compatible ports
- **Sprint C**: (If needed) Cross-instance domain adapters

## Breakdown for Planning

### If Domain Covariance Only (HIGH confidence)

| Task | Confidence | Complexity | Depends On |
|------|------------|------------|------------|
| Fix pass2-types to use isSubdomainOf | HIGH | LOW | Nothing |
| Add covariance tests | HIGH | LOW | Fix |
| Update validateConnection for covariance | HIGH | LOW | Fix |
| PortHighlightStore works automatically | N/A | N/A | validateConnection |

**Total**: 1 day work, HIGH confidence

### If Domain Transformation Registry (MEDIUM confidence)

| Task | Confidence | Complexity | Depends On |
|------|------------|------------|------------|
| Write spec for domain transformations | MEDIUM | MEDIUM | User clarification |
| Create domain transformation registry | MEDIUM | LOW | Spec |
| Define what adapters actually do | LOW | HIGH | Spec |
| Implement canTransformDomain | HIGH | LOW | Registry |
| Add domain adapter blocks | MEDIUM | MEDIUM | Semantics |
| UI highlighting | HIGH | LOW | canTransformDomain |

**Total**: 3-5 days work, MEDIUM confidence (blocked on spec)

### If Instance Reprojection (LOW confidence)

This would be a substantial new feature involving:
- New adapter semantics
- Potential runtime implications
- Complex type system changes

**Not recommended without clear need and spec**.

## Verdict

- [ ] CONTINUE - Issues clear, implementer can fix
- [X] PAUSE - Ambiguities need clarification

**Reason for PAUSE:**

1. **Epic description doesn't match architecture** - "position -> normalized_position" is not a domain transformation. What is actually wanted?

2. **Spec-code contradiction** - Covariance is specified but not implemented. Is this a bug or intentional?

3. **No spec for domain transformation** - Unlike unit adapters which have a complete spec, domain transformation has no design document.

**Questions for user before proceeding:**

1. What does "position -> normalized_position" actually mean in context of this epic?
2. Should Field<circle> automatically be compatible with Field<shape> (covariance)?
3. What is the use case that drives this epic? What user action is blocked?
4. Is there an existing design document or spec for this feature?

---

```
project-evaluator complete
  Scope: domain-transformation-adapters | Completion: 15% | Gaps: 3 critical
  Workflow: PAUSE ("3 questions need answers before implementation can proceed")
  -> Clarify epic intent with user
```
