# Evaluation: Scheduling Bug - Time Slot Never Written

**Generated**: 2026-01-25T10:00:00
**Status**: INVESTIGATION COMPLETE

## Bug Report

```
[Error] Error: [DebugService.getEdgeValue] Slot 6 has no value.
Runtime has started but this slot was never written to - this is a scheduling bug.
```

Source: `DebugService.ts:195` (line 314-316 in current version)

## Root Cause Analysis

### Executive Summary

Time signals (tMs, dt, phaseA, phaseB, palette, energy) allocate slots during block lowering but those slots are never written to. When the debug probe queries an edge connected to a time output, it finds the slot mapping but no value.

### Flow Analysis

1. **Block Lowering** (`time-blocks.ts:40-81`):
   - `InfiniteTimeRoot.lower()` creates `sigTime()` expressions
   - Allocates slots via `ctx.b.allocSlot()`
   - Returns outputs with `{ k: 'sig', id, slot, ... }`

2. **Slot Registration** (`pass6-block-lowering.ts:424-430`):
   ```typescript
   if (ref.k === 'sig') {
     const sigExpr = builder.getSigExpr(ref.id);
     const isTimeSignal = sigExpr?.kind === 'time';
     if (!isTimeSignal) {
       builder.registerSigSlot(ref.id, ref.slot);  // TIME SIGNALS EXCLUDED
     }
   }
   ```
   Time signals are intentionally excluded from registration.

3. **Debug Index** (`compile.ts:508-543`):
   - Built from `unlinkedIR.blockOutputs`
   - INCLUDES time outputs (they have slots)
   - Maps edges from time outputs to slots

4. **Runtime** (`ScheduleExecutor.ts`):
   - Time values read from `state.time.*` in SignalEvaluator
   - Time slots NEVER written
   - Debug tap only records during `evalSig` steps

5. **Debug Query** (`DebugService.ts:307-319`):
   - Finds slot in mapping
   - No value exists
   - Throws "scheduling bug" error

### The Disconnect

| Component | Time Signals |
|-----------|-------------|
| Block outputs (slots allocated) | YES |
| Debug index (edge-to-slot mapping) | YES |
| evalSig steps generated | NO |
| Slots written at runtime | NO |
| Debug tap records value | NO |

## Impact

- Debug probe throws error when hovering edges from time outputs
- Affects: phaseA, phaseB, tMs, dt, palette, energy edges
- Does NOT affect downstream signals (they get evaluated normally)

## Fix Options

### Option A: Don't register time outputs in debug index (RECOMMENDED)

Skip time signal outputs when building debug index. Users can't meaningfully debug time edges anyway.

**Files**: `compile.ts` (debug index population)
**Risk**: LOW
**Effort**: LOW

### Option B: Write time values to slots in runtime

Add explicit slot writes for time signals after time resolution.

**Files**: `ScheduleExecutor.ts`
**Risk**: MEDIUM (runtime change)
**Effort**: LOW

### Option C: Handle time signals in DebugService

Recognize time signals and read from state.time instead of slots.

**Files**: `DebugService.ts`, requires access to runtime state
**Risk**: MEDIUM (coupling)
**Effort**: MEDIUM

### Option D: Generate evalSig for time signals

Remove `isTimeSignal` check - let time signals get evalSig steps.

**Files**: `pass6-block-lowering.ts`
**Risk**: LOW (SignalEvaluator already handles time kind)
**Effort**: LOWEST

## Recommendation

**Option D** is recommended because:
1. Uniform handling of all signal types
2. Debug probe works for time edges
3. Minimal code change (remove special case)
4. SignalEvaluator already handles time expressions correctly
5. No coupling between services
6. Tiny runtime cost (evalSig is fast, 7 time signals per frame)

## Verification Plan

1. Remove `isTimeSignal` exclusion in `pass6-block-lowering.ts`
2. Run existing tests (should pass)
3. Manually verify debug probe works on time edges
4. Check no console errors in browser
