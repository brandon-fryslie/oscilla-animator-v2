# Explore: ValueExpr Unification
Timestamp: 2026-01-30-170000

## Raw Facts Gathered

### Current Expression Types (src/compiler/ir/types.ts)

**SigExpr** (10 variants):
- const, slot, time, external, map, zip, stateRead, shapeRef, reduceField, eventRead

**FieldExpr** (9 variants):
- const, intrinsic, broadcast, map, zip, zipSig, stateRead, pathDerivative, placement

**EventExpr** (5 variants):
- const, pulse, wrap, combine, never

**Total: 24 variants across 3 families**

### Separate ID Types (src/compiler/ir/Indices.ts)
- SigExprId (line 36): `number & { readonly __brand: 'SigExprId' }`
- FieldExprId (line 39): `number & { readonly __brand: 'FieldExprId' }`
- EventExprId (line 42): `number & { readonly __brand: 'EventExprId' }`

### IRBuilderImpl (src/compiler/ir/IRBuilderImpl.ts)
- Three separate arrays: `sigExprs: SigExpr[]`, `fieldExprs: FieldExpr[]`, `eventExprs: EventExpr[]`
- Three separate hash-consing caches: `sigExprCache`, `fieldExprCache`, `eventExprCache`
- Three separate slot maps: `sigSlots`, `fieldSlots`, `eventSlots`

### ValueRefPacked (src/compiler/ir/lowerTypes.ts)
- Discriminated union with `k: 'sig' | 'field' | 'event' | 'instance' | 'scalar'`
- Each sig/field/event variant carries its own ID type and a `type: CanonicalType`
- `assertKindAgreement` function validates k tag against deriveKind(type)

### LoweredOutput/LoweredInput (src/compiler/ir/lowerTypes.ts)
- Also uses `kind: 'signal' | 'field' | 'scalar' | 'instance'` discriminant
- These carry both the family-specific ID AND CanonicalType

### CompiledProgramIR (src/compiler/ir/program.ts)
- Has separate `signalExprs`, `fieldExprs`, `eventExprs` DenseTables

### ScheduleExecutor (src/runtime/ScheduleExecutor.ts)
- Step dispatch switch on `step.kind` with 8 step types
- Steps reference SigExprId/FieldExprId/EventExprId
- Calls separate evaluateSignal/materialize/evaluateEvent functions

### Three Separate Evaluators
- SignalEvaluator.ts: switch on expr.kind for SigExpr
- Materializer.ts: switch on expr.kind for FieldExpr
- EventEvaluator.ts: switch on expr.kind for EventExpr

### deriveKind Usage (5 source files)
- src/core/canonical-types.ts: Definition and helpers
- src/blocks/field-operations-blocks.ts: 1 call
- src/types/index.ts: Re-export
- src/compiler/frontend/axis-validate.ts: Multiple calls in validation
- src/compiler/ir/lowerTypes.ts: assertKindAgreement

### Files importing SigExprId/FieldExprId/EventExprId (38 files in src/)
Major consumers:
- All block definition files (math-blocks, color-blocks, geometry-blocks, etc.)
- All runtime evaluators
- Compiler passes
- Types index
- Expression DSL compiler
- Test files

### instanceId on FieldExpr nodes
Lines with instanceId in types.ts:
- FieldExprIntrinsic: `readonly instanceId: InstanceId` (required)
- FieldExprPlacement: `readonly instanceId: InstanceId` (required)
- FieldExprMap: `readonly instanceId: InstanceId | undefined` (optional)
- FieldExprZip: `readonly instanceId: InstanceId | undefined` (optional)
- FieldExprZipSig: `readonly instanceId: InstanceId | undefined` (optional)
- FieldExprStateRead: `readonly instanceId: InstanceId` (required)

### Test Results (at commit ea5725d)
- 4 test files failed, 120 passed (124 total)
- 3 tests failed, 1982 passed, 15 skipped (2000 total)
- Failures are NOT related to ValueExpr work (NoTimeRoot validation, LayoutAlongPath block)

### ValueExpr existence check
- No `value-expr.ts` file exists in src/
- Only 1 file in src/ mentions `ValueExpr`: src/core/canonical-types.ts (in deprecation comments)

### Prior Plan exists
- `.agent_planning/gap-analysis/SPRINT-20260129-200000-valueexpr-adapter-deferred-PLAN.md`
- Defines 7 work items (P0-1 through P1-7)
- Status: READY (no research gates)
- Zero implementation progress
