# Evaluation: Gap Analysis — Critical Items Final Assessment
Timestamp: 2026-01-25-234400
Git Commit: 1358381

## Executive Summary
Overall: 100% of actionable critical items complete | Critical issues: 0 active | Tests reliable: yes
1284/1284 tests pass, typecheck clean. One critical item (C-12) remains correctly deferred behind a design dependency (U-21).

## Runtime Check Results
| Check | Status | Output |
|-------|--------|--------|
| npm run test | PASS | 1284 passed, 3 skipped (10.03s) |
| npx tsc --noEmit | PASS | No errors |
| v1 render code removed | CONFIRMED | No matches for RenderFrameIR_Future or future-types.ts in src/ |
| EventPayload type exists | CONFIRMED | src/runtime/RuntimeState.ts:66 |
| Events cleared each frame | CONFIRMED | src/runtime/ScheduleExecutor.ts:86-92 |
| Monotonicity enforced | CONFIRMED | src/runtime/timeResolution.ts:124 |
| PAYLOAD_STRIDE exists | CONFIRMED | src/core/canonical-types.ts:138 |
| isStateful in BlockDef | CONFIRMED | src/blocks/registry.ts:254, used at src/compiler/passes-v2/pass5-scc.ts:115 |

## Missing Checks
None needed for critical items. All checks pass.

## Findings

### P1 Critical Items (12 items)
**Status**: COMPLETE
**Evidence**: All items (C-7, C-14, C-15, C-17, C-18, C-20, C-21, C-22, C-23, C-1, C-3, C-19) resolved in commits c3694de and 09e404f. Verified by tests and code inspection.
**Issues**: None.

### P2 Critical Items (8 items)
**Status**: COMPLETE (7 done, 1 correctly deferred)
**Evidence**:
- C-2 (vec3): DONE — PAYLOAD_STRIDE at src/core/canonical-types.ts:138 includes vec3 stride=3
- C-8 (EventPayload): DONE — type at src/runtime/RuntimeState.ts:66, Map storage at :515, clearing at ScheduleExecutor.ts:90
- C-9 (v1 removal): DONE — no matches for assembleRenderPass/renderV1/RenderPassIR in functional code (only test comments)
- C-10 (phase): DONE — resolved by R-5 (phase01 is correct, no code change)
- C-11 (PathVerb): DONE — code is canonical, spec needs update
- C-12 (PathStyle blend/layer): DEFERRED — PathStyle at src/render/types.ts:47 has no blend/layer fields. Correctly blocked by U-21.
- C-13 (rotation/scale2): DONE — commit c7206be
- C-16 (slot lookup): DONE — commit 129ea87
**Issues**: None for done items. C-12 deferral is appropriate.

### C-8 EventPayload — Quality Assessment
**Status**: COMPLETE but infrastructure-only
**Evidence**: The EventPayload type and Map storage exist, events clear each frame, tests verify the infrastructure.
**Concern**: No block currently consumes EventPayload data. The SampleHold block (src/blocks/event-blocks.ts:53) uses `sigEventRead` which reads from `eventScalars` (boolean flags) at src/runtime/SignalEvaluator.ts:208, NOT from the EventPayload Map. The dual-path approach is intentional but the new path has zero consumers.
**Impact**: Low. The infrastructure is correctly designed and ready. The first consumer (a payload-aware block or SampleHold enhancement to read key/value data) will exercise it.

### U-6 SampleAndHold — Gap Analysis Accuracy Issue
**Status**: PARTIALLY INACCURATE in gap-analysis docs
**Evidence**: The gap-analysis SUMMARY.md says U-6 is "unblocked" and "NOW READY" for implementation. However:
1. SampleHold already exists at src/blocks/event-blocks.ts:53-113
2. It is registered, tested (src/blocks/__tests__/event-blocks.test.ts:165-410), and functional
3. It uses boolean triggers (eventScalars), not EventPayload data
4. The spec name is "SampleAndHold" but the code registers as "SampleHold" (minor naming discrepancy)
**Impact**: The gap-analysis next-priority recommendation is misleading. U-6 is already implemented at the boolean level. What remains is either:
  - (a) Enhancing SampleHold to optionally read EventPayload values (not just boolean fire/no-fire), or
  - (b) Considering U-6 done since the basic latch-on-trigger semantics work correctly

### P3 User Decisions (R-2, R-6, R-7, R-8)
**Status**: PENDING user engagement
**Evidence**: All four items remain in to-review/ files. No user decisions recorded.
**Impact**: These are architectural direction questions. None block immediate functional work:
- R-2: Unit type system vs payload-only — code already has full Unit system, no regression risk
- R-6: Float64 vs Float32 — code uses Float64, working correctly
- R-7: Stamp vs CacheKey — stamp-based works, potentially wasteful but correct
- R-8: Expression trees vs op-level IR — expression trees in use, working
**Recommendation**: These can be resolved as spec-updates (accept current code approach) since all four cases have working implementations that diverge from spec in a "better" direction.

### Stateful Primitives (U-4, U-5)
**Status**: NOT STARTED
**Evidence**: No Lag or Phasor block registrations in src/blocks/. UnitDelay exists (src/blocks/signal-blocks.ts:230), SampleHold exists (src/blocks/event-blocks.ts:54).
**Impact**: These are MVP-required per spec (design-docs/CANONICAL-oscilla-v2.5-20260109/RESOLUTION-LOG.md:64). Lag and Phasor are the remaining 2 of 4 MVP stateful primitives.

## Ambiguities Found
| Area | Question | How LLM Guessed | Impact |
|------|----------|-----------------|--------|
| U-6 Status | Is SampleHold done or does it need EventPayload consumption? | Gap analysis says "unblocked, ready" — implies not done | LOW: block works for boolean triggers, spec may require payload reading |
| SampleHold naming | Spec says "SampleAndHold", code says "SampleHold" | Shortened name in implementation | NONE: functional, cosmetic difference |
| EventPayload consumers | When will a block actually read from events Map? | None yet — infrastructure sits unused | LOW: no functional gap until payload-aware event blocks needed |

## Priority Assessment: Next Actionable Sprint

### Tier 1: Immediate (no blockers, clear spec, high value)
1. **U-4 (Lag block)** — MVP stateful primitive, pattern established by UnitDelay. Straightforward implementation.
2. **U-5 (Phasor block)** — MVP stateful primitive, similar pattern. Phase accumulator with wrap.
3. **U-8 (Noise, Length, Normalize)** — Pure utility blocks, no dependencies, well-defined math.

### Tier 2: Design decisions needed
4. **U-21 (Layer system)** — Unblocks C-12. Requires architectural decision (layer ordering, BlendMode enum).
5. **P3 decisions (R-2, R-6, R-7, R-8)** — Spec updates to accept current code. Low effort if user agrees.

### Tier 3: Medium complexity, standalone
6. **U-7 (PortBinding with CombineMode)** — Refactor to block/port types. C-1 already done.
7. **U-25 (RenderBackend interface)** — Extract interface from Canvas2D/SVG renderers. Refactor only.
8. **U-15 (RuntimeError type)** — Structured error discriminated union. Standalone.

### Not recommended yet:
- U-12 (Deterministic replay) — Large scope, low immediate value
- U-13 (Atomic hot-swap) — Needs frame-boundary sync, complex
- U-17 (Hash-consing) — Optimization, not correctness
- U-19 (Stride-aware allocation) — Complex, C-2 done but this is a separate concern
- U-26/U-27 (3D coordinate/camera) — Large feature, lower priority

## Recommendations
1. **Close U-6 as DONE** — SampleHold exists and works. If EventPayload consumption is needed later, it can be tracked as a separate enhancement.
2. **Next sprint: U-4 + U-5 (Lag + Phasor)** — Completes the 4 MVP stateful primitives. Both follow established patterns (UnitDelay, SampleHold). High confidence, low risk.
3. **Consider U-8 in same sprint** — 3 pure utility blocks, no state, easy to implement.
4. **Resolve P3 as spec-updates** — All 4 items (R-2, R-6, R-7, R-8) have working implementations that are arguably better than spec. Recommend accepting code and updating spec.

## Verdict
- [x] CONTINUE - Issues clear, implementer can fix
- [ ] PAUSE - Ambiguities need clarification

All critical work is genuinely done. The gap-analysis planning documents are accurate except for U-6 status (already implemented). Next sprint should target MVP stateful primitive completion (Lag + Phasor).
