# Evaluation: Gap Analysis — Post-Vec3 Migration State
Timestamp: 2026-01-24-190000
Git Commit: 46de4d5

## Executive Summary
Overall: 85% complete (of originally identified critical items) | Critical issues: 1 (test failure) | Tests reliable: NO (1 broken test)

The vec3 migration for layout kernels is structurally complete. All layout kernels (circleLayout, lineLayout, gridLayout, fieldPolarToCartesian, makeVec3) correctly produce stride-3 output. The type system, BufferPool, block definitions, and RenderAssembler all handle vec3 consistently. TypeScript compiles clean. However, one test is broken (uses a removed block type), and the FieldJitter2D block remains vec2-only by design (control points, not positions). The RenderAssembler has a vec2-to-vec3 promotion path that keeps the pipeline functional even when a vec2 buffer reaches a position slot.

## Runtime Check Results
| Check | Status | Output |
|-------|--------|--------|
| TypeScript typecheck | PASS | No errors |
| Vitest full suite | FAIL | 1258 pass, 1 fail |
| Failing test | FAIL | `level1-vec3-data.test.ts` uses removed `ConstColor` block |

## Missing Checks
- No integration test covering the FieldJitter2D(vec2) -> RenderInstances2D(vec3 position) path to verify runtime promotion works
- No test asserting that `sliceInstanceBuffers` handles stride-3 correctly with non-contiguous indices in the full pipeline (unit tests exist but no integration test through compile->execute)

## Findings

### Layout Kernels (FieldKernels.ts)
**Status**: COMPLETE
**Evidence**:
- `circleLayout` (line 479-509): outputs stride-3, z=0.0 explicit
- `lineLayout` (line 592-621): outputs stride-3, z=0.0 explicit
- `gridLayout` (line 622-658): outputs stride-3, z=0.0 explicit
- `fieldPolarToCartesian` (line 263-294): outputs stride-3, z=0.0 explicit
- `makeVec3` (line 82-101): outputs stride-3, z=0.0 explicit
**Issues**: None. All layout/position kernels consistently use stride-3 with explicit z=0.0.

### BufferPool (vec3 support)
**Status**: COMPLETE
**Evidence**:
- `BufferPool.ts:24`: `vec3f32` format type added
- `BufferPool.ts:45-46`: PayloadType `vec3` maps to `vec3f32`
- `BufferPool.ts:177-178`: allocates `Float32Array(count * 3)` for vec3f32
**Issues**: None.

### Block Definitions (Layout blocks)
**Status**: COMPLETE
**Evidence**:
- `instance-blocks.ts:55`: GridLayout output typed as `signalTypeField('vec3', 'default')`
- `instance-blocks.ts:134`: LinearLayout output typed as `signalTypeField('vec3', 'default')`
- `instance-blocks.ts:220`: CircleLayout output typed as `signalTypeField('vec3', 'default')`
- `render-blocks.ts:33,83,135`: All render blocks accept `signalTypeField('vec3', 'default')` for position
**Issues**: None.

### RenderAssembler (vec3 handling)
**Status**: COMPLETE
**Evidence**:
- `RenderAssembler.ts:194-209`: Detects stride-3 (vec3) or stride-2 (vec2) position buffers, promotes vec2 to vec3 with z=0 when camera projection is active
- `sliceInstanceBuffers` (line 592-628): Uses stride-3 for all position operations
**Issues**: None. The vec2-to-vec3 promotion path is a correct fallback for legacy/non-position vec2 fields.

### Kernel Signatures (kernel-signatures.ts)
**Status**: COMPLETE
**Evidence**:
- `kernel-signatures.ts:201-229`: circleLayout, lineLayout, gridLayout all documented with vec3 output
- `kernel-signatures.ts:234-239`: makeVec3 signature present
**Issues**: Minor: output unit says `'scalar'` with description `'Position (vec3)'` - technically imprecise but acceptable since these are documentation/validation only (line 8-9 of file confirms this).

### Canonical Types (PayloadType)
**Status**: COMPLETE
**Evidence**:
- `canonical-types.ts:126`: `vec3` is a PayloadType
- `canonical-types.ts:143`: `PAYLOAD_STRIDE.vec3 = 3`
- `canonical-types.ts:77`: `vec3` allowed units: `['ndc3', 'world3']`
**Issues**: None.

### Failing Test (level1-vec3-data.test.ts)
**Status**: BROKEN
**Evidence**:
- `level1-vec3-data.test.ts:196`: uses `b.addBlock('ConstColor', ...)`
- `color-blocks.ts:221`: `ConstColor` was removed, replaced by polymorphic `Const` block
- Error: `Unknown block type: "ConstColor" is not registered`
**Issues**: Test references a block that no longer exists. Must update to use the current API.

### FieldJitter2D / attract2d (vec2 kernels)
**Status**: INTENTIONALLY VEC2 (not a gap)
**Evidence**:
- `field-operations-blocks.ts:705,711`: FieldJitter2D accepts/outputs `vec2`
- `FieldKernels.ts:125-158`: jitter2d kernel outputs stride-2
- `FieldKernels.ts:159-200`: attract2d kernel outputs stride-2
- Comments explicitly state: "Use case: Control points, tangent vectors (NOT instance positions)"
**Issues**:
- **Runtime gap**: In `main.ts:151`, the golden spiral patch wires `jitter.out` (vec2) -> `render.pos` (vec3). This works at runtime due to RenderAssembler's vec2-to-vec3 promotion (line 202-208), but it's a type mismatch at the block-definition level. The compiler likely produces a vec2 buffer that the RenderAssembler silently promotes. This is not a bug per se (the promotion is explicit code), but it creates a dual code path for position data.
- This is acceptable for now since the promotion code handles it correctly, but a future cleanup should either: (a) add a vec3 jitter kernel for position fields, or (b) make the FieldJitter2D block output vec3 when used in a position context.

### C-2 (shape -> shape2d rename)
**Status**: NOT STARTED (cosmetic, low priority)
**Evidence**: `'shape'` used across 34 files (97 occurrences). The type is called `'shape'` everywhere, not `'shape2d'`. The BufferFormat uses `'shape2d'` internally but PayloadType is `'shape'`.
**Issues**: This is purely cosmetic. The `shape` PayloadType name is canonical and consistent. Renaming to `shape2d` would be a large churn for zero functional benefit. Recommend marking as WON'T FIX or deferring indefinitely.

## Ambiguities Found
| Area | Question | How LLM Guessed | Impact |
|------|----------|-----------------|--------|
| fieldGoldenAngle turns | Why 50? (line 389) | Hardcoded without explanation | LOW - purely visual parameter, works |
| FieldJitter2D → position | Should jitter output vec3 for position use? | Left as vec2, relies on RenderAssembler promotion | LOW - works via promotion fallback |
| kernel-signatures output unit | Should layout kernels output unit be 'world3' not 'scalar'? | Used 'scalar' with description noting vec3 | NEGLIGIBLE - validation-only metadata |

## Remaining Critical Items Priority

### 1. Test Fix (IMMEDIATE - blocks test suite reliability)
- Fix `level1-vec3-data.test.ts` to use `Const` block instead of removed `ConstColor`
- Effort: 5 minutes

### 2. C-9: RenderPassIR Migration (LARGE - ms5 epic)
- instances2d -> DrawPathInstancesOp migration
- Well-understood, tracked in beads
- Blocked by nothing, just large effort
- Priority: HIGH (most impactful structural improvement remaining)

### 3. C-8: EventPayload Design (MEDIUM - architectural)
- Boolean flags -> EventPayload[]
- Blocks SampleAndHold and data-carrying events
- Needs design document before implementation
- Priority: MEDIUM (blocks future features, not current functionality)

### 4. C-12: PathStyle blend/layer (BLOCKED)
- Blocked by U-21 layer system design
- Cannot proceed until layer system is designed
- Priority: LOW (blocked, can't act)

## Verdict
- [x] CONTINUE - Issues clear, implementer can fix

The vec3 migration is functionally complete. The one failing test is trivial to fix (wrong block name). The remaining critical items (C-8, C-9, C-12) are all correctly sequenced behind their dependencies. No new issues were introduced by the vec3 migration beyond the test using a removed block type.

## Action Items
1. Fix `src/projection/__tests__/level1-vec3-data.test.ts:196` - replace `ConstColor` with the current polymorphic `Const` block API
2. Consider adding integration test for vec2-position-to-vec3-promotion path (low priority, works but untested as integration)
3. Mark C-2 shape->shape2d rename as WON'T FIX (cosmetic only, 97 occurrences across 34 files for zero benefit)
