# Explore: GCC-style Compiler Flag System
Timestamp: 2026-02-02-104500

## Raw Facts Gathered

### Error Code Inventory

**Pass 1 (TypeConstraintErrorKind) - analyze-type-constraints.ts:37-45:**
- ConflictingUnits
- ConflictingPayloads
- UnresolvedUnit
- UnresolvedPayload
- MissingBlockDef
- MissingPortDef
- CardinalityConflict
- UnresolvedCardinality

**CompileErrorCode (types.ts:23-43):**
- TypeMismatch, PortTypeMismatch, UnconnectedInput, Cycle
- UnknownBlockType, BlockMissing, NotImplemented
- IRValidationFailed, UpstreamError, TransformError
- CardinalityMismatch, InstanceMismatch, LaneCoupledDisallowed, ImplicitBroadcastDisallowed
- PayloadNotAllowed, PayloadCombinationNotAllowed, UnitMismatch, ImplicitCastDisallowed

**String-typed codes from lowering (diagnosticConversion.ts:88-90):**
- ExprSyntaxError, ExprTypeError, ExprCompileError

**DiagnosticCode union (diagnostics/types.ts:90-143):**
- 31 distinct codes across time, type, cardinality, payload, const, graph, warning, perf, expression, and info categories

### Error Flow Architecture

1. **Pass 1 errors** (compile.ts:188-196): All treated as fatal. Pass1Result is TypeResolvedPatch | Pass1Error. No warning path exists. On error, immediate `emitFailure()`.

2. **Pass 6 errors** (compile.ts:270-330): Partitioned by reachability. Reachable errors -> fail. Unreachable errors -> warnings (W_BLOCK_UNREACHABLE_ERROR). This is the ONLY place severity is configurable today.

3. **diagnosticConversion.ts:176**: `severity: 'error'` is hardcoded for ALL compile errors.

### Settings Infrastructure

- `defineSettings()` in src/settings/defineSettings.ts creates typed tokens
- SettingsStore (MobX) in src/stores/SettingsStore.ts: register, get, update, reset
- Supports controls: toggle, number, select, text, slider
- Auto-persists to localStorage, debounced 500ms
- SettingsPanel.tsx auto-renders UI from registered tokens
- 3 existing tokens: debug (1 field), editor (1 field), app (unknown)

### Compiler-Settings Boundary

- **Zero coupling today**: No settings imports in src/compiler/
- **No settings in CompileOrchestrator.ts**: compile() is called without settings
- CompileOptions has: patchId, patchRevision, events (EventHub)
- compile() is a pure function that takes Patch + CompileOptions

### Two Error Type Systems

1. **compile.ts CompileError** (line 52-58): `{ kind: string, message, blockId?, connectionId?, portId? }` - legacy format
2. **types.ts CompileError** (line 49-61): `{ code: CompileErrorCode|string, message, where?, details? }` - new format

These are TWO DIFFERENT interfaces both named CompileError. diagnosticConversion.ts handles both via isLegacyError().

### Test State

- 141 tests pass, 6 skipped, 1 unhandled error (worker exit, not test failure)
- No existing tests for compiler flags (feature doesn't exist yet)

### CompileResult Type

compile.ts defines its own CompileResult (line 60-70):
```typescript
type CompileResult = CompileSuccess | CompileFailure;
```
Not the same as types.ts CompileResult<T> (line 82-84):
```typescript
type CompileResult<T> = { ok: true; value: T; warnings } | { ok: false; errors; warnings };
```

Note: types.ts CompileResult has a `warnings` field. compile.ts CompileResult does NOT.
