# Definition of Done: Primitives Catalog - MVP Stateful Blocks

**Sprint:** primitives-catalog
**Generated:** 2026-01-09T20:00:00Z

---

## Deliverable 1: UnitDelay Block

**Definition of Done:**

### IR Infrastructure
- [ ] File `/src/compiler/ir/types.ts` contains `SigExprStateRead` interface
- [ ] File `/src/compiler/ir/types.ts` contains `StepStateWrite` interface
- [ ] Type `StateSlotId` is a branded number type in `/src/compiler/ir/Indices.ts`
- [ ] File `/src/compiler/ir/builder.ts` contains `allocStateSlot()` method
- [ ] File `/src/compiler/ir/builder.ts` contains `sigStateRead()` method
- [ ] File `/src/compiler/ir/builder.ts` contains `stepStateWrite()` method

### Runtime Infrastructure
- [ ] File `/src/runtime/RuntimeState.ts` contains `state: Float64Array` field
- [ ] File `/src/runtime/SignalEvaluator.ts` handles `stateRead` expression kind
- [ ] File `/src/runtime/ScheduleExecutor.ts` handles `stateWrite` step kind

### Block Implementation
- [ ] File `/src/compiler/blocks/signal/UnitDelay.ts` exists
- [ ] Block is registered with input `in` (signal:float) and output `out` (signal:float)
- [ ] Block is exported from `/src/compiler/blocks/signal/index.ts`
- [ ] Block is accessible via `getBlock('UnitDelay')` from registry

### Behavioral Correctness
- [ ] Frame 1: Output is 0.0 (initial state)
- [ ] Frame N (N > 1): Output is input value from frame N-1
- [ ] State persists correctly across any number of frames

---

## Deliverable 2: Hash Block

**Definition of Done:**

### OpCode Addition
- [ ] File `/src/compiler/ir/types.ts` enum `OpCode` contains `Hash = 'hash'`
- [ ] File `/src/runtime/OpcodeInterpreter.ts` handles `hash` opcode

### Block Implementation
- [ ] File `/src/compiler/blocks/signal/Hash.ts` exists
- [ ] Block is registered with input `value` (required), `seed` (optional, default=0)
- [ ] Block output `out` is signal:float in range [0, 1)
- [ ] Block is exported from `/src/compiler/blocks/signal/index.ts`

### Behavioral Correctness
- [ ] Hash(42, 0) always returns the same value
- [ ] Hash(42, 1) returns a different value than Hash(42, 0)
- [ ] Output is always in range [0, 1)
- [ ] Distribution appears uniform

---

## Deliverable 3: Id01 Block

**Definition of Done:**

### Block Implementation
- [ ] File `/src/compiler/blocks/signal/Id01.ts` exists
- [ ] Block is registered with inputs `index` and `count` (both signal:float)
- [ ] Block output `out` is signal:float
- [ ] Block is exported from `/src/compiler/blocks/signal/index.ts`

### Behavioral Correctness
- [ ] Id01(5, 10) = 0.5
- [ ] Id01(0, 10) = 0.0
- [ ] Id01(9, 10) = 0.9
- [ ] Id01(0, 0) = 0.0 (safe division)
- [ ] Id01(0, 1) = 0.0

---

## Deliverable 4: Unit Tests

**Definition of Done:**

### Test File
- [ ] File `/src/compiler/blocks/__tests__/stateful.test.ts` exists

### UnitDelay Tests
- [ ] Test: "UnitDelay outputs 0 on first frame"
- [ ] Test: "UnitDelay outputs previous input on subsequent frames"
- [ ] Test: "UnitDelay maintains correct delay over 10 frames"

### Hash Tests
- [ ] Test: "Hash is deterministic"
- [ ] Test: "Hash with different seeds produces different results"
- [ ] Test: "Hash output is in [0, 1) range"

### Id01 Tests
- [ ] Test: "Id01 normalizes index correctly"
- [ ] Test: "Id01 handles count=0 safely"
- [ ] Test: "Id01 handles count=1"

### Test Execution
- [ ] Command `npm run test` passes with all new tests green
- [ ] No regressions in existing tests

---

## Verification Checklist

**Must pass ALL of these:**

### Compilation
- [ ] `npm run typecheck` returns 0 errors
- [ ] `npm run build` completes successfully

### Registration
- [ ] `getBlock('UnitDelay')` returns block definition
- [ ] `getBlock('Hash')` returns block definition
- [ ] `getBlock('Id01')` returns block definition

### Tests
- [ ] All 9+ new tests pass
- [ ] All existing tests pass (no regressions)

### Integration
- [ ] Can create a patch with UnitDelay and compile it
- [ ] Can create a patch with Hash and compile it
- [ ] Can create a patch with Id01 and compile it

---

## Acceptance Criteria Summary

| Block | Compiles | Registers | Tests Pass | Behavior Correct |
|-------|----------|-----------|------------|------------------|
| UnitDelay | [ ] | [ ] | [ ] | [ ] |
| Hash | [ ] | [ ] | [ ] | [ ] |
| Id01 | [ ] | [ ] | [ ] | [ ] |

---

## Sign-Off

When all criteria are met:

```
Definition of Done SATISFIED
   Date: [completion date]
   Blocks added: 3 (UnitDelay, Hash, Id01)
   Tests added: 9+
   Test failures: 0
   Ready for: Remaining stateful primitives (Lag, Phasor, SampleAndHold)
```
