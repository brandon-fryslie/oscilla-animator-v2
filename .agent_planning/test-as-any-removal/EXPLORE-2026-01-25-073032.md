# Exploration: Remove 'as any' casts from test files
Timestamp: 2026-01-25-073032
Git Commit: 25ae615

## Current State

### Total 'as any' count: 112 instances across 20 files

Previously ~145 as cited in beads issue. Recent commits (25ae615, 0d647ae) already removed ~30 casts.

### File-by-file breakdown:
```
30 src/runtime/__tests__/field-kernel-contracts.test.ts
11 src/ui/debug-viz/ValueRenderer.test.ts
10 src/blocks/__tests__/expression-blocks.test.ts
 9 src/services/CompilationInspectorService.test.ts
 9 src/services/__tests__/exportFormats.test.ts
 8 src/runtime/__tests__/continuity-integration.test.ts
 6 src/runtime/__tests__/local-space-sanity.test.ts
 6 src/runtime/__tests__/EventEvaluator.test.ts
 4 src/projection/__tests__/level6-mode-toggle.test.ts
 4 src/expr/__tests__/integration.test.ts
 3 src/render/__tests__/stroke-rendering.test.ts
 2 src/stores/__tests__/PatchStore.test.ts
 2 src/compiler/__tests__/compile.test.ts
 2 src/blocks/__tests__/event-blocks.test.ts
 1 src/ui/debug-viz/DebugMiniView.test.tsx
 1 src/ui/debug-viz/charts/Sparkline.test.tsx
 1 src/stores/__tests__/integration.test.ts
 1 src/projection/__tests__/level10-golden-tests.test.ts
 1 src/compiler/passes-v2/__tests__/combine-utils.test.ts
 1 src/compiler/__tests__/steel-thread-rect.test.ts
```

## Pattern Analysis

### Category 1: Field kernel type params (~30 instances)
File: `field-kernel-contracts.test.ts`

Pattern: `type as any` passed to applyFieldKernel/applyFieldKernelZipSig

Example:
```typescript
const type = { payload: 'vec2', cardinality: 'many' } as const;
applyFieldKernel(out, [x, y], 'makeVec2', 3, type as any);
```

Root cause: The type parameter expects `CanonicalType` but tests are passing partial type literals.
Factory `canonicalType()` exists but produces different shape than expected by the kernel function.

### Category 2: SigExprId branded type (~16 instances)
Files: `expression-blocks.test.ts`, `integration.test.ts`, `EventEvaluator.test.ts`, `event-blocks.test.ts`

Pattern: `0 as any` for SigExprId

Example:
```typescript
{ kind: 'wrap', signal: 0 as any }, // SigExprId = 0
```

Fix available: Import and use `sigExprId(0)` from types module.

### Category 3: Internal builder access (~10 instances)
File: `expression-blocks.test.ts`

Pattern:
```typescript
const sigId = (outputRef as any).id;
const sigExpr = builder['sigExprs'][sigId as any];
```

Root cause: Tests access private `sigExprs` array via bracket notation.
The `SigRef` type has `k: 'sig'` but `id` property isn't properly exposed.

### Category 4: CompilationInspector output (~9 instances)
File: `CompilationInspectorService.test.ts`

Pattern:
```typescript
const output = snapshot?.passes[0].output as any;
expect(output.a).toBe(1);
```

Root cause: Pass output is typed as `unknown` since passes have heterogeneous output types.

### Category 5: Block definition mocking (~9 instances)
File: `exportFormats.test.ts`

Pattern:
```typescript
inputs: {
  count: { type: { payload: 'float' } as any, value: 100 },
},
```

Root cause: Incomplete CanonicalType literals passed to mock block definitions.

### Category 6: React props access (~11 instances)
File: `ValueRenderer.test.ts`

Pattern:
```typescript
expect((el.props as any)['data-renderer']).toBe('exact-float-phase');
```

Root cause: JSX element props type doesn't expose data-* attributes.
Could use typed test helpers or data-testid with proper types.

### Category 7: Mock canvas context (~8 instances)
Files: `continuity-integration.test.ts`, `stroke-rendering.test.ts`, `DebugMiniView.test.tsx`, `Sparkline.test.tsx`

Pattern:
```typescript
(ctx.fill as any).mockImplementation(() => calls.push('fill'));
HTMLCanvasElement.prototype.getContext = vi.fn(() => mockCtx) as any;
```

Root cause: Mock implementations don't satisfy full CanvasRenderingContext2D interface.

### Category 8: CanonicalType for field kernels (~6 instances)
File: `local-space-sanity.test.ts`

Pattern:
```typescript
applyFieldKernelZipSig(out, indices, signals, 'polygonVertex', N, vec2Type as any);
```

Same as Category 1 - partial type literals.

## Existing Infrastructure

### Branded ID constructors (already exist):
- `sigExprId(n: number): SigExprId` - src/compiler/ir/Indices.ts:101
- `blockId(s: string): BlockId` - src/types/index.ts:130
- `valueSlot(n: number): ValueSlot` - src/compiler/ir/Indices.ts:89
- `eventSlotId(n: number): EventSlotId` - src/compiler/ir/Indices.ts:113

### CanonicalType constructors (already exist):
- `canonicalType(payload: PayloadType): CanonicalType` - src/core/canonical-types.ts
- `signalTypeField(payload: PayloadType): CanonicalType`
- `signalTypeSignal(payload: PayloadType): CanonicalType`

### What's missing:
1. Test helper for creating proper CanonicalType for field kernels
2. Typed test utilities for React element prop access
3. Properly typed mock canvas context helper

## Recent Work (commits 25ae615, 0d647ae)

Categories already addressed:
- Schedule access pattern - Now using typed ScheduleIR properties
- Parser AST access - Added type guards (isLiteral, isBinary, etc.)
- Some branded type usage - Using blockId(), valueSlot()

Categories deferred in previous work:
- Field kernel types (Category 1, 8) - "architectural gaps where test code was incomplete"
- Mock patterns (Category 7) - Not addressed
- CompilationInspector output (Category 4) - Not addressed
