# Implementation Context: Phase 1 Remaining Work

**Generated**: 2026-01-09T21:00:00Z
**Purpose**: Comprehensive context for implementing Phase 1 remaining work

---

## Source Files Reference

### Type System (Foundation - 90% Complete)

**Primary Source**: `src/core/canonical-types.ts` (522 lines)
```typescript
// Key types already implemented:
type PayloadType = 'float' | 'int' | 'vec2' | 'color' | 'phase' | 'bool' | 'unit';

type AxisTag<T> =
  | { kind: 'default' }
  | { kind: 'instantiated'; value: T };

type Cardinality =
  | { kind: 'zero' }
  | { kind: 'one' }
  | { kind: 'many'; domain: DomainRef };

type Temporality =
  | { kind: 'continuous' }
  | { kind: 'discrete' };

type Extent = {
  cardinality: AxisTag<Cardinality>;
  temporality: AxisTag<Temporality>;
  binding: AxisTag<Binding>;
  perspective: AxisTag<PerspectiveId>;
  branch: AxisTag<BranchId>;
};

type SignalType = {
  payload: PayloadType;
  extent: Extent;
};
```

**Helpers**: Lines 200-400 contain `sigType()`, `fieldType()`, `createTypeDesc()`, etc.

**Tests**: `src/core/__tests__/canonical-types.test.ts` (52 tests)

---

### IR Schema

**Primary Source**: `src/compiler/ir/program.ts` (142+ lines)
```typescript
// Current CompiledProgramIR (needs expansion)
interface CompiledProgramIR {
  readonly irVersion: 1;
  readonly signalExprs: SignalExprTable;
  readonly fieldExprs: FieldExprTable;
  readonly eventExprs: EventExprTable;
  readonly constants: { readonly json: readonly unknown[] };
  readonly schedule: ScheduleIR;
  readonly outputs: readonly OutputSpecIR[];
  readonly slotMeta: readonly SlotMetaEntry[];
  readonly debugIndex: DebugIndexIR;
}

interface SlotMetaEntry {
  readonly slot: ValueSlot;
  readonly storage: "f64" | "f32" | "i32" | "u32" | "object";
  readonly offset: number;  // REQUIRED
  readonly type: TypeDesc;
  readonly debugName?: string;
}
```

**Location for AxesDescIR**: Add to `src/compiler/ir/types.ts`

---

### Compiler Passes

**Pass 0-1**: `src/graph/normalize.ts`, `src/compiler/compile.ts`
**Pass 2**: `src/compiler/passes-v2/pass2-types.ts` (TypedPatch)
**Pass 3**: `src/compiler/passes-v2/pass3-time.ts` (TimeResolvedPatch)
**Pass 4**: `src/compiler/passes-v2/pass4-depgraph.ts`
**Pass 5**: `src/compiler/passes-v2/pass5-scc.ts` (cycle detection only)
**Pass 6**: `src/compiler/passes-v2/pass6-block-lowering.ts` (16.5KB, partial)

**Missing Files to Create**:
- `src/compiler/passes-v2/pass5-execution-class.ts` (NEW)
- `src/compiler/passes-v2/pass6-tables.ts` (NEW)
- `src/compiler/passes-v2/pass7-schedule.ts` (NEW)
- `src/compiler/passes-v2/pass8-slots.ts` (NEW)
- `src/compiler/passes-v2/pass10-debug.ts` (NEW)

---

### Runtime

**Primary Source**: `src/runtime/RuntimeState.ts`
```typescript
interface RuntimeState {
  readonly values: ValueStore;
  readonly cache: FrameCache;
  readonly time: TimeState;
  readonly inputs: ExternalInputs;
}

interface ValueStore {
  f64: Float64Array;
  objects: Map<number, unknown>;
}
```

**Time Resolution**: `src/runtime/timeResolution.ts` (complete)
**Schedule Execution**: `src/runtime/ScheduleExecutor.ts` (needs update)
**Materialization**: `src/runtime/Materializer.ts` (16.5KB)

---

### Block Definitions

**Location**: `src/compiler/blocks/`

**Existing Blocks** (30 files):
```
signal/    - ConstFloat, AddSignal, MulSignal, Oscillator, MousePosition
time/      - InfiniteTimeRoot, FiniteTimeRoot
domain/    - DomainN, GridDomain, FieldBroadcast, FieldMap, FieldZipSig
render/    - RenderInstances2D, FieldHueFromPhase, HueRainbow, etc.
```

**Block Registry**: `src/compiler/blocks/registry.ts`
```typescript
interface LowerContext {
  program: CompiledProgramIR;
  allocSlot(type: SignalType): ValueSlot;
  getInputSlot(portId: string): ValueSlot;
  // ...
}

type BlockLower = (ctx: LowerContext, block: Block) => void;
```

---

## Key Patterns

### AxisTag Pattern
```typescript
// Creating instantiated axis
const oneCard: AxisTag<Cardinality> = {
  kind: 'instantiated',
  value: { kind: 'one' }
};

// Creating default axis
const defaultCard: AxisTag<Cardinality> = { kind: 'default' };

// Checking axis
if (axis.kind === 'instantiated') {
  // axis.value is available
}
```

### SignalType Construction
```typescript
// Signal (one + continuous + float)
const sig = sigType('float');

// Field (many + continuous + color)
const field = fieldType('color', { kind: 'domain', id: 'particles' });

// Event (one + discrete + unit)
const event: SignalType = {
  payload: 'unit',
  extent: {
    cardinality: { kind: 'instantiated', value: { kind: 'one' } },
    temporality: { kind: 'instantiated', value: { kind: 'discrete' } },
    binding: { kind: 'default' },
    perspective: { kind: 'default' },
    branch: { kind: 'default' },
  }
};
```

### Slot Allocation (Current)
```typescript
// In block lowering
const outSlot = ctx.allocSlot(sigType('float'));
ctx.emitSignalExpr({
  kind: 'binary',
  op: 'add',
  a: ctx.getInputSlot('a'),
  b: ctx.getInputSlot('b'),
  out: outSlot,
});
```

### Schedule Step Types (To Implement)
```typescript
type ScheduleStep =
  | { kind: 'update_rails' }
  | { kind: 'eval_scalar'; nodes: number[] }
  | { kind: 'eval_field'; domain: DomainId; nodes: number[] }
  | { kind: 'eval_events'; nodes: number[] }
  | { kind: 'write_sinks' };
```

---

## Spec Excerpts (Critical)

### From 01-type-system.md

**Axis Unification Rules (v0)**:
```
default + default                → default
default + instantiated(X)        → instantiated(X)
instantiated(X) + instantiated(X) → instantiated(X)
instantiated(X) + instantiated(Y), X≠Y → TYPE ERROR
```

**V0 Canonical Defaults**:
```typescript
const DEFAULTS_V0 = {
  cardinality: { kind: 'canonical', value: { kind: 'one' } },
  temporality: { kind: 'canonical', value: { kind: 'continuous' } },
  binding:     { kind: 'canonical', value: { kind: 'unbound' } },
  perspective: { kind: 'canonical', value: 'global' },
  branch:      { kind: 'canonical', value: 'main' },
};
```

### From 03-time-system.md

**TimeRoot Outputs**:
| Output | Cardinality | Temporality | Payload |
|--------|-------------|-------------|---------|
| `tMs` | one | continuous | int |
| `phaseA` | one | continuous | phase |
| `phaseB` | one | continuous | phase |
| `progress` | one | continuous | unit |
| `pulse` | one | discrete | unit |

**Phase Wrap**:
```typescript
function wrapPhase(value: number): number {
  return value - Math.floor(value);
}
```

### From 04-compilation.md

**Execution Classes**:
| Extent Pattern | Execution Class |
|----------------|-----------------|
| `one + continuous` | Scalar continuous |
| `many(domain) + continuous` | Field continuous |
| `one + discrete` | Scalar discrete |
| sinks | Render endpoints |

**Scheduling Phases**:
1. Read external inputs
2. Update time (tMs, phases)
3. Evaluate in topological order
4. Process events
5. Write to render sinks

### From 05-runtime.md

**Slot Access (Target)**:
```typescript
function readSlot(state: RuntimeState, meta: SlotMetaEntry): unknown {
  return state.stores[meta.storage][meta.offset];
}
```

---

## Test Patterns

### Canonical Types Tests
```typescript
// src/core/__tests__/canonical-types.test.ts
describe('SignalType', () => {
  it('creates signal type with correct extent', () => {
    const sig = sigType('float');
    expect(sig.payload).toBe('float');
    expect(sig.extent.cardinality).toEqual({
      kind: 'instantiated',
      value: { kind: 'one' }
    });
  });
});
```

### Compiler Tests
```typescript
// src/compiler/__tests__/compile.test.ts
describe('compile', () => {
  it('produces valid CompiledProgramIR', () => {
    const ir = compile(patch);
    expect(ir.irVersion).toBe(1);
    expect(ir.slotMeta).toBeInstanceOf(Array);
    expect(ir.slotMeta.every(m => typeof m.offset === 'number')).toBe(true);
  });
});
```

### Steel-Thread Integration
```typescript
// src/__tests__/steel-thread.test.ts
describe('steel-thread', () => {
  it('renders particle animation', () => {
    const patch = createParticlePatch();
    const ir = compile(patch);
    const runtime = createRuntime(ir);
    const frame = runtime.tick(16.67);
    expect(frame.instances.length).toBeGreaterThan(0);
  });
});
```

---

## Implementation Order

1. **AxesDescIR** (P1.1) - Add to IR types
2. **Bridge Functions** (P1.2) - Connect types to IR
3. **Pass 5 Execution Class** (P3.1) - Classify nodes
4. **Pass 6 Tables** (P3.2) - Build dense arrays
5. **Pass 7 Schedule** (P3.3) - Phase ordering
6. **Pass 8 Slots** (P3.4) - Offset planning
7. **Runtime Update** (P4) - Use offsets
8. **Combine System** (P5.1-5.2) - Multi-writer
9. **Default Sources** (P5.3) - Unconnected ports
10. **Primitives** (P6) - Complete catalog

---

## Known Issues

1. **Time units**: Current impl uses seconds, spec uses milliseconds
2. **Pass numbering**: pass5-scc.ts does cycle detection, need execution class in new file
3. **Combine utils**: `combine-utils.ts` exists but usage unclear
4. **Test coverage**: No per-block unit tests

---

## Related Files (Quick Reference)

```
src/
├── core/
│   ├── canonical-types.ts     # 5-axis type system (COMPLETE)
│   ├── types.ts               # Legacy TypeDesc (migrate away)
│   └── __tests__/             # 52 type tests
├── compiler/
│   ├── ir/
│   │   ├── program.ts         # CompiledProgramIR
│   │   ├── types.ts           # IR types (add AxesDescIR here)
│   │   └── schedule.ts        # Schedule types
│   ├── passes-v2/
│   │   ├── pass2-types.ts     # Type assignment
│   │   ├── pass3-time.ts      # Time topology
│   │   ├── pass5-scc.ts       # Cycle detection
│   │   └── pass6-*.ts         # Block lowering (partial)
│   ├── blocks/
│   │   └── *.ts               # ~30 block definitions
│   └── compile.ts             # Main compiler
├── runtime/
│   ├── RuntimeState.ts        # State container
│   ├── timeResolution.ts      # Time system (COMPLETE)
│   ├── ScheduleExecutor.ts    # Execution loop
│   └── Materializer.ts        # Field materialization
└── graph/
    └── normalize.ts           # Graph normalization
```
