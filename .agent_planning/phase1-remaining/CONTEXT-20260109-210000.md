# Implementation Context: Phase 1 Remaining Work

**Generated:** 2026-01-09T21:00:00Z
**Purpose:** Comprehensive reference for implementing the sprint plan

---

## Critical Files

### For DerivedBlockMeta Types

**File:** `src/types/index.ts`

Current definition (lines ~68-74):
```typescript
export type DerivedBlockMeta =
  | { readonly kind: "defaultSource"; readonly target: { readonly kind: "port"; readonly port: PortRef } }
  | { readonly kind: "wireState";     readonly target: { readonly kind: "wire"; readonly wire: WireId } }
  | { readonly kind: "lens";          readonly target: { readonly kind: "node"; readonly node: NodeRef } };
```

Add `bus` and `rail` variants per spec.

---

### For Rail Blocks

**File:** `src/compiler/blocks/rail/index.ts`

All 6 typed rail blocks already exist:
- PhaseARail (lines 21-36)
- PhaseBRail (lines 42-56)
- TimeRail (lines 62-76)
- PulseRail (lines 82-97)
- PaletteRail (lines 103-118)
- EnergyRail (lines 124-139)

Each follows the pattern:
```typescript
const lowerPhaseARail: BlockLower = ({ b, inputsById }) => {
  const input = inputsById.in;
  if (!input || input.kind !== 'sig') {
    const defaultPhase = b.sigConst(0, sigType('phase'));
    return { out: { kind: 'sig', id: defaultPhase, type: sigType('phase') } };
  }
  return { out: input };
};
```

---

### For Stateful Blocks

**Pattern file:** `src/compiler/blocks/signal/UnitDelay.ts`

Key pattern:
```typescript
const lowerUnitDelay: BlockLower = ({ b, inputsById }) => {
  const input = sig(inputsById, 'in');

  // 1. Allocate state slot
  const stateSlot = b.allocStateSlot(0);

  // 2. Read previous value FIRST
  const prevId = b.sigStateRead(stateSlot, sigType('float'));

  // 3. Schedule state write for end of frame
  b.stepStateWrite(stateSlot, input.id);

  // 4. Return the read value
  return { out: { kind: 'sig', id: prevId, type: sigType('float') } };
};
```

---

### For Normalization

**File:** `src/graph/normalize.ts`

Integration point is after TimeRoot detection. Create new file `src/graph/normalize-rails.ts`.

---

## IRBuilder API Reference

**File:** `src/compiler/ir/builder.ts`

### State Operations

```typescript
// Allocate persistent state slot
allocStateSlot(initialValue: number): StateSlotId

// Read state from previous frame
sigStateRead(stateSlot: StateSlotId, type: CanonicalType): SigExprId

// Schedule state write for end of frame
stepStateWrite(stateSlot: StateSlotId, value: SigExprId): void
```

### Signal Operations

```typescript
// Constant signal
sigConst(value: number, type: CanonicalType): SigExprId

// Time system values
sigTime(name: 'tMs' | 'dt' | 'phaseA' | 'phaseB', type: CanonicalType): SigExprId

// Binary operation
sigBinOp(a: SigExprId, b: SigExprId, op: OpCode, type: CanonicalType): SigExprId

// Unary operation
sigUnaryOp(input: SigExprId, op: OpCode, type: CanonicalType): SigExprId
```

### OpCodes

```typescript
enum OpCode {
  Add, Sub, Mul, Div,    // Arithmetic
  Sin, Cos,              // Trig
  Wrap01,                // Phase wrapping
  Min, Max, Clamp,       // Range
}
```

---

## Spec References

### Block Roles (02-block-system.md)

```typescript
type BlockRole =
  | { kind: "user" }
  | { kind: "derived"; meta: DerivedBlockMeta };

type DerivedBlockMeta =
  | { kind: "defaultSource"; target: { kind: "port"; port: PortRef } }
  | { kind: "wireState";     target: { kind: "wire"; wire: WireId } }
  | { kind: "bus";           target: { kind: "bus"; busId: BusId } }
  | { kind: "rail";          target: { kind: "bus"; busId: BusId } }
  | { kind: "lens";          target: { kind: "node"; node: NodeRef } };

type EdgeRole =
  | { kind: "user" }
  | { kind: "default"; meta: { defaultSourceBlockId: BlockId } }
  | { kind: "busTap";  meta: { busId: BusId } }
  | { kind: "auto";    meta: { reason: "portMoved" | "rehydrate" | "migrate" } };
```

### MVP Rails (03-time-system.md)

| Rail | Output Type | Source |
|------|-------------|--------|
| time | one + continuous + int | TimeRoot.tMs |
| phaseA | one + continuous + phase | TimeRoot.phaseA |
| phaseB | one + continuous + phase | TimeRoot.phaseB |
| pulse | one + discrete + unit | TimeRoot.pulse |
| palette | one + continuous + color | TimeRoot.palette |
| energy | one + continuous + float | TimeRoot.energy |

### Stateful Primitives (02-block-system.md)

| Block | Behavior |
|-------|----------|
| UnitDelay | y(t) = x(t-1) |
| Lag | y(t) = y(t-1) + smoothing * (target - y(t-1)) |
| Phasor | phase(t) = wrap01(phase(t-1) + freq * dt / 1000) |
| SampleAndHold | if trigger: y(t) = x(t) else y(t) = y(t-1) |

---

## Formulas

### Lag Block

Exponential smoothing with half-life:
```
smoothing = dt / (halfLife + dt)
y(t) = y(t-1) + smoothing * (target(t) - y(t-1))
```

### Phasor Block

Phase accumulation with wrap:
```
dtSec = dt / 1000  // Convert ms to seconds
phase(t) = wrap01(phase(t-1) + frequency * dtSec)
```

---

## Test Helper

From `src/compiler/blocks/__tests__/stateful.test.ts`:

```typescript
function compileAndExtract(blockType: string, inputs: Record<string, number>): {
  program: CompiledProgramIR;
  extractOutput: (frameIndex: number) => number;
}
```

---

## Running Tests

```bash
# All tests
npm test

# Specific file
npm test -- src/compiler/blocks/__tests__/stateful.test.ts

# Pattern match
npm test -- --grep "Lag"

# Watch mode
npm run test:watch
```

---

## Directory Structure

```
src/
├── types/index.ts              # DerivedBlockMeta, EdgeRole, BusId
├── graph/
│   ├── normalize.ts            # Main normalization
│   └── normalize-rails.ts      # NEW: Rail injection
├── compiler/
│   ├── blocks/
│   │   ├── signal/
│   │   │   ├── UnitDelay.ts    # Pattern reference
│   │   │   ├── Lag.ts          # NEW
│   │   │   ├── Phasor.ts       # NEW
│   │   │   └── SampleAndHold.ts # NEW
│   │   └── rail/index.ts       # Typed rails (exist)
│   └── __tests__/
│       ├── stateful.test.ts    # Add Lag, Phasor, S&H tests
│       └── passes.test.ts      # NEW: Pass 2-4 tests
```
