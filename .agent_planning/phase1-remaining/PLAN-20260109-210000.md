# Sprint Plan: Phase 1 Remaining Work

**Generated:** 2026-01-09T21:00:00Z
**Status:** READY FOR IMPLEMENTATION
**Estimated Effort:** 4-6 hours
**Dependencies:** None (all prerequisites complete)

---

## Sprint Goal

Complete Phase 1 Core Foundation by delivering block role types, automatic rail injection, remaining stateful primitives, and compilation validation tests.

---

## Scope

**In scope (this sprint):**
- P0: Block role types (DerivedBlockMeta variants) + rail normalization injection
- P1: Stateful primitives (Lag, Phasor, SampleAndHold)
- P2: Compilation pass testing (passes 2-4 validation)

**Explicitly out of scope (future sprints):**
- Hot-swap state preservation (Phase 2)
- Event-driven SampleAndHold (full implementation when event system complete)
- Mixed storage class offsets (optimization)
- UI integration for rail/bus editing

---

## Work Items

### P0: Block Role Types + Rail Normalization

**P0.1: Complete DerivedBlockMeta Types**

Location: `src/types/index.ts`

Add `bus` and `rail` variants to DerivedBlockMeta:

```typescript
export type DerivedBlockMeta =
  | { readonly kind: "defaultSource"; readonly target: { readonly kind: "port"; readonly port: PortRef } }
  | { readonly kind: "wireState";     readonly target: { readonly kind: "wire"; readonly wire: WireId } }
  | { readonly kind: "bus";           readonly target: { readonly kind: "bus"; readonly busId: BusId } }
  | { readonly kind: "rail";          readonly target: { readonly kind: "bus"; readonly busId: BusId } }
  | { readonly kind: "lens";          readonly target: { readonly kind: "node"; readonly node: NodeRef } };
```

Add `busTap` variant to EdgeRole, add `BusId` type alias.

**P0.2: Typed Rail Blocks**

Location: `src/compiler/blocks/rail/`

The 6 rail blocks already exist in `src/compiler/blocks/rail/index.ts`:
- PhaseARail, PhaseBRail, TimeRail, PulseRail, PaletteRail, EnergyRail

Each rail:
- Has optional input, required output
- Passes through input if connected
- Reads from TimeRoot default if disconnected

**P0.3: Rail Normalization Injection**

Location: Create `src/graph/normalize-rails.ts`

Function `injectRails()` that:
1. Creates 6 rail blocks as derived blocks
2. Wires each rail to corresponding TimeRoot output
3. Sets proper role metadata on blocks and edges

Integrate into `normalize()` pipeline.

---

### P1: Remaining Stateful Primitives

**P1.1: Lag Block (Exponential Smoothing)**

Location: `src/compiler/blocks/signal/Lag.ts`

Inputs:
- `target` (float): Value to smooth toward
- `halfLife` (float, optional, default=100): Time constant in ms

Output:
- `out` (float): Smoothed value

Formula: `y(t) = y(t-1) + (dt / (halfLife + dt)) * (target - y(t-1))`

**P1.2: Phasor Block (Phase Accumulator)**

Location: `src/compiler/blocks/signal/Phasor.ts`

Inputs:
- `frequency` (float): Cycles per second (Hz)

Output:
- `out` (phase): Accumulated phase [0, 1)

Formula: `phase(t) = wrap01(phase(t-1) + frequency * dt / 1000)`

**P1.3: SampleAndHold Block (Event Latch)**

Location: `src/compiler/blocks/signal/SampleAndHold.ts`

Inputs:
- `in` (float): Value to sample
- `trigger` (event, optional): When to capture

Output:
- `out` (float): Held value

MVP behavior: Pass through input (full event handling in Phase 2).

---

### P2: Compilation Testing

**Location:** `src/compiler/__tests__/passes.test.ts`

Test cases:
1. Type propagation through connections
2. Type error detection for mismatches
3. TimeRoot requirement (exactly one)
4. Cycle detection without stateful blocks
5. Legal cycles with UnitDelay
6. Topological sort correctness

---

## Implementation Sequence

```
Phase 1 (2-3 hours):
├── 1. DerivedBlockMeta types (30 min)
├── 2. BusId type + EdgeRole busTap (15 min)
├── 3. Rail normalization function (1 hour)
└── 4. Integration into normalize.ts (30 min)

Phase 2 (2 hours):
├── 5. Lag block + tests (40 min)
├── 6. Phasor block + tests (40 min)
└── 7. SampleAndHold block + tests (40 min)

Phase 3 (1 hour):
└── 8. Pass 2-4 integration tests (1 hour)
```

---

## Dependencies

- Rail blocks: Already exist, need role metadata only
- Stateful patterns: UnitDelay provides reference implementation
- Type system: canonical-types.ts complete and tested
- IR builder: State API complete (allocStateSlot, sigStateRead, stepStateWrite)

---

## Risks

| Risk | Mitigation |
|------|------------|
| Rail injection breaks tests | Run test suite after each step |
| SampleAndHold needs events | MVP with simplified trigger handling |
| Type narrowing complexity | Exhaustive switch with never default |

---

## Verification

```bash
npm run typecheck && npm run build && npm test
```

Success: All 123+ tests pass, no TypeScript errors, new tests added.
