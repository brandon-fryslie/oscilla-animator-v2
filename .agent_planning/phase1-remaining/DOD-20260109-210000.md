# Definition of Done: Phase 1 Remaining Work

**Generated:** 2026-01-09T21:00:00Z
**Plan Reference:** PLAN-20260109-210000.md

---

## P0: Block Role Types + Rail Normalization

### P0.1: DerivedBlockMeta Types

- [ ] `DerivedBlockMeta` has exactly 5 variants: `defaultSource`, `wireState`, `bus`, `rail`, `lens`
- [ ] Each variant has correct `target` structure per spec (02-block-system.md)
- [ ] `BusId` type alias exists as branded string
- [ ] `EdgeRole` has `busTap` variant with `busId` in meta
- [ ] Type narrowing tests pass for all variants

### P0.2: Typed Rail Blocks

For each rail (PhaseARail, PhaseBRail, TimeRail, PulseRail, PaletteRail, EnergyRail):
- [ ] Block exists and is registered in registry
- [ ] Input is optional
- [ ] Output type matches spec
- [ ] Connected input passes through unchanged
- [ ] Disconnected input reads from TimeRoot

### P0.3: Rail Normalization Injection

- [ ] `injectRails()` function exists in `src/graph/normalize-rails.ts`
- [ ] Returns 6 rail blocks with correct types
- [ ] Each rail wired to corresponding TimeRoot output
- [ ] Rail blocks have `{ kind: 'derived', meta: { kind: 'rail', ... } }` role
- [ ] Edges have `{ kind: 'auto', meta: { reason: 'rehydrate' } }` role
- [ ] Integration test: compile patch, verify rails exist in normalized output

---

## P1: Stateful Primitives

### P1.1: Lag Block

- [ ] Block registered as `Lag`
- [ ] Inputs: `target` (float), `halfLife` (float, optional, default=100)
- [ ] Output: `out` (float)
- [ ] Uses state slot for smoothed value
- [ ] Implements exponential smoothing formula

Test cases:
- [ ] Initial frame outputs 0
- [ ] Converges toward constant target
- [ ] Larger halfLife = slower convergence

### P1.2: Phasor Block

- [ ] Block registered as `Phasor`
- [ ] Inputs: `frequency` (float)
- [ ] Output: `out` (phase)
- [ ] Uses state slot for accumulated phase
- [ ] Phase wraps at 1.0 back to 0.0

Test cases:
- [ ] Initial frame outputs 0
- [ ] 1 Hz frequency advances ~0.0167 per frame at 60fps
- [ ] Phase wraps correctly (0.99 + 0.02 = 0.01)

### P1.3: SampleAndHold Block

- [ ] Block registered as `SampleAndHold`
- [ ] Inputs: `in` (float), `trigger` (event, optional)
- [ ] Output: `out` (float)
- [ ] Uses state slot for held value
- [ ] Initial value is 0

Test cases:
- [ ] Held value persists across frames
- [ ] State initializes to 0

---

## P2: Compilation Testing

### Pass 2-4 Tests

- [ ] Type propagation test: SignalType flows through connections
- [ ] TimeRoot requirement test: No TimeRoot = clear error message
- [ ] Cycle detection test: Cycle without stateful block = error
- [ ] Legal cycle test: Cycle with UnitDelay compiles successfully

---

## Overall Success Criteria

- [ ] All 123+ existing tests pass
- [ ] All new tests pass (minimum 15 new tests)
- [ ] No TypeScript errors (`npm run typecheck`)
- [ ] Build succeeds (`npm run build`)

**Final Verification:**
```bash
npm run typecheck && npm run build && npm test
```

---

## Acceptance Criteria Summary

| Deliverable | Compiles | Registers | Tests Pass |
|-------------|----------|-----------|------------|
| DerivedBlockMeta types | [ ] | N/A | [ ] |
| Rail normalization | [ ] | N/A | [ ] |
| Lag block | [ ] | [ ] | [ ] |
| Phasor block | [ ] | [ ] | [ ] |
| SampleAndHold block | [ ] | [ ] | [ ] |
| Pass 2-4 tests | N/A | N/A | [ ] |
