# Definition of Done: Port/Wire Type Checking

**Date:** 2026-01-19

---

## Acceptance Criteria

### Mandatory

- [ ] Type validation utility created (`src/ui/reactFlowEditor/typeValidation.ts`)
- [ ] `isValidConnection` callback added to ReactFlow component
- [ ] Incompatible connections are prevented at UI level
- [ ] Compatible connections work as before
- [ ] Polymorphic `'???'` types connect to any concrete type
- [ ] `npm run typecheck` passes
- [ ] `npm run build` passes

### Type Checking Rules Implemented

- [ ] Payload types must match (float→float, color→color, etc.)
- [ ] `'???'` (polymorphic) types unify with any concrete type
- [ ] Temporality must match (continuous ≠ discrete)
- [ ] Cardinality must match (one ≠ many)
- [ ] For `many` cardinality, instance (domainType + instanceId) must match

---

## Verification Commands

```bash
# Type check
npm run typecheck

# Build
npm run build

# Start dev and test manually
npm run dev
```

## Manual Test Cases

### Test 1: Incompatible Payload Types
1. Create an `Oscillator` block (outputs `Signal<float>`)
2. Create an `HSV to RGB` block (expects `Signal<color>` on input)
3. Try to connect Oscillator output to HSV to RGB's color input
4. **Expected:** Connection is prevented (no snap, can't connect cursor)

### Test 2: Incompatible Cardinality (Signal vs Field)
1. Create a `Const` block (outputs `Signal<float>`)
2. Create a `Field Add` block (expects `Field<float>` inputs)
3. Try to connect Const output to Field Add input
4. **Expected:** Connection is prevented

### Test 3: Compatible Connection
1. Create an `Oscillator` block (outputs `Signal<float>`)
2. Create an `Add` block (expects `Signal<float>` inputs)
3. Connect Oscillator output to Add input
4. **Expected:** Connection succeeds normally

### Test 4: Polymorphic Type (`???`)
1. Create a `Const` block (outputs polymorphic `???` type)
2. Create any block with typed input
3. Connect Const to the typed input
4. **Expected:** Connection succeeds (polymorphic unifies with any)

### Test 5: Field-to-Field Same Instance
1. Create an `Array` block (creates a domain instance)
2. Create two `Field` blocks downstream using the same instance
3. Connect outputs between them
4. **Expected:** Connection succeeds (same instance)

### Test 6: Field-to-Field Different Instance
1. Create two separate `Array` blocks (different domain instances)
2. Try to connect field output from one to field input requiring the other instance
3. **Expected:** Connection is prevented (different instances)

---

## Files Changed

| File | Change |
|------|--------|
| `src/ui/reactFlowEditor/typeValidation.ts` | NEW - Type validation utility |
| `src/ui/reactFlowEditor/ReactFlowEditor.tsx` | Add `isValidConnection` callback |
