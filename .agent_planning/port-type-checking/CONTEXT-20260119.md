# Context: Port/Wire Type Checking

**Date:** 2026-01-19

---

## Background

The Oscilla v2 node editor currently allows any port to connect to any other port. Type errors are only caught during compilation (Pass 2). This creates a poor user experience - users can create invalid graphs that fail at compile time.

## Key Architecture Insights

### Type System (5-Axis)

Located in `src/core/canonical-types.ts`:

```typescript
type CanonicalType = {
  payload: PayloadType;  // 'float'|'int'|'vec2'|'color'|'phase'|'bool'|'unit'|'???'
  extent: Extent;        // 5-axis coordinate
};

type Extent = {
  cardinality: AxisTag<Cardinality>;  // zero|one|many(instance)
  temporality: AxisTag<Temporality>;  // continuous|discrete
  binding: AxisTag<Binding>;          // v0: 'unbound' only
  perspective: AxisTag<string>;       // v0: 'global' only
  branch: AxisTag<string>;            // v0: 'main' only
};
```

### Type Compatibility (from Pass 2)

Located in `src/compiler/passes-v2/pass2-types.ts`:

1. **Payload** - Must match exactly, except `'???'` is polymorphic
2. **Temporality** - `continuous` ≠ `discrete`
3. **Cardinality** - `zero` ≠ `one` ≠ `many`
4. **Instance** - If both are `many`, domainType + instanceId must match

### Block Registry

Located in `src/blocks/registry.ts`:

- `getBlockDefinition(blockType)` returns block definition with typed ports
- Each port has a `type: CanonicalType` field
- Registry is the source of truth for port types

### ReactFlow Integration

- `isValidConnection` callback can prevent invalid connections
- Returns `true` to allow, `false` to prevent
- Called before `onConnect` - prevents bad connections from being created

### Current Connection Flow

`sync.ts` → `createConnectHandler`:
```typescript
// NO validation - just adds edge
handle.patchStore.addEdge(from, to);
```

## Key Files

| File | Purpose |
|------|---------|
| `src/core/canonical-types.ts` | Type system definitions |
| `src/compiler/passes-v2/pass2-types.ts` | Reference implementation of `isTypeCompatible` |
| `src/blocks/registry.ts` | Block definitions with port types |
| `src/ui/reactFlowEditor/sync.ts` | Connection handlers (currently no validation) |
| `src/ui/reactFlowEditor/ReactFlowEditor.tsx` | ReactFlow component (add `isValidConnection`) |

## Design Decisions

### Why validate at UI level?

1. **Immediate feedback** - User sees invalid before completing connection
2. **Better UX** - No "create then delete" workflow
3. **Compiler still validates** - Belt and suspenders approach

### Why reuse Pass 2 logic?

1. **Single source of truth** - Same rules UI and compiler
2. **No divergence** - Can't have UI allow what compiler rejects
3. **Proven correct** - Already tested in compilation

### Why not validate in PatchStore?

- Could add defensive validation there too
- But UI validation provides better UX (prevents vs. rejects)
- Compiler is the authoritative validator anyway

## Polymorphic Types (`'???'`)

The `'???'` payload type means "infer from context":
- Used by blocks like `Const` that output generic values
- Compiler resolves to concrete type based on connected port
- UI validation must treat `'???'` as compatible with everything
