# Context: Compilation Statistics Feature

**Date:** 2026-01-19
**Feature:** Per-session compilation statistics

---

## Problem Statement

Currently, compilation duration is logged per-compile (`Compiled in X.Xms`) but there's no aggregation or historical tracking. Users cannot see:
- How many compilations have occurred
- What the typical compile time is
- Whether compile times are getting worse
- Min/max bounds for comparison

With the reduced debounce (16ms), compilations happen frequently during parameter edits. Understanding compilation performance is valuable for:
1. Detecting performance regressions
2. Understanding system behavior
3. Diagnosing slowdowns

---

## Current Infrastructure

### CompileEndEvent (src/events/types.ts:86-94)

```typescript
export interface CompileEndEvent {
  readonly type: 'CompileEnd';
  readonly compileId: string;
  readonly patchId: string;
  readonly patchRevision: number;
  readonly status: 'success' | 'failure';
  readonly durationMs: number;  // <-- Already tracked
  readonly diagnostics: readonly Diagnostic[];
}
```

### Compilation Duration Tracking (src/compiler/compile.ts)

```typescript
const startTime = performance.now();
// ... compilation ...
const durationMs = performance.now() - startTime;
options.events.emit({
  type: 'CompileEnd',
  durationMs,
  // ...
});
```

### Existing Stats Display (src/ui/components/app/Toolbar.tsx)

FPS counter in header: `FPS: 60 | Elements: 5000 | 2.3/1.5ms`

### DiagnosticsStore (src/stores/DiagnosticsStore.ts)

MobX store wrapping DiagnosticHub. Already:
- Tracks diagnostics by domain (compile, authoring, runtime)
- Provides computed properties (errorCount, warningCount)
- Has log() method for general logging

### Bottom Panel Structure (src/ui/dockview/)

Three tabs in bottom-left: Console, Logs, Continuity
- Registered in `panelRegistry.ts`
- Layout in `defaultLayout.ts`
- Panel wrappers in `panels/` directory

---

## Requirements

### Functional

1. Track per-session compilation statistics:
   - Count: Total successful compilations
   - Last: Most recent compile time
   - Avg: Average compile time (total / count)
   - Med: Median of recent 20 compiles
   - Min: Fastest compile
   - Max: Slowest compile

2. Display stats in Diagnostics tab (Console)

3. Reset on page refresh (per-session only)

### Non-Functional

1. No performance impact on compilation
2. Minimal memory footprint (only track recent 20 for median)
3. Reactive updates via MobX

---

## Placement Decision

**Evaluated Options:**

| Option | Verdict |
|--------|---------|
| Diagnostics tab | ✅ SELECTED - natural fit, low overhead |
| New Stats panel | ❌ Overkill for current needs |
| Header bar | ❌ Space-constrained |
| New Compilation panel | ❌ Too specialized |

**Rationale:**
- Compilation success/failure already displays in Console
- "Compilation health" naturally belongs with diagnostics
- Can split out to dedicated panel later if needed
- Lowest implementation overhead

---

## Technical Approach

### Data Flow

```
Compilation
    ↓
CompileEnd event (with durationMs)
    ↓
EventHub subscription in main.ts
    ↓
rootStore.diagnostics.recordCompilation(durationMs)
    ↓
DiagnosticsStore updates observable stats
    ↓
DiagnosticConsole re-renders (MobX observer)
```

### Stats Structure

```typescript
interface CompilationStats {
  count: number;      // Total compilations
  totalMs: number;    // Sum for average calculation
  minMs: number;      // Fastest (initially Infinity)
  maxMs: number;      // Slowest (initially 0)
  recentMs: number[]; // Last 20 for median (ring buffer behavior)
}
```

### Median Calculation

Keep last 20 compile times, sort copy, take middle value(s).
- Even count: average of two middle values
- Odd count: middle value
- Empty: show "—" or 0

---

## Related Systems

- **DiagnosticHub** - Event-based diagnostic management
- **EventHub** - Central event bus for CompileEnd events
- **HealthMonitor** - Runtime health tracking (different concern)
- **ContinuityStore** - Domain change tracking (analogous pattern)

---

## Future Considerations

- Dedicated "Compilation" panel if more stats needed
- Graph/sparkline of compile times over session
- "Slow compilation" warnings (>50ms threshold)
- localStorage persistence for cross-session trends
- Breakdown by compilation phase (type checking, lowering, etc.)
