# Diagnostics System - Definition of Done (Sprint 2)

## Deliverable 1: Runtime Health Monitoring

### Acceptance Criteria
1. ✅ **RuntimeHealthSnapshot events emit at 2-5 Hz**: Health snapshots emit every 200ms during animation (not per-frame)
2. ✅ **NaN detection is batched**: Multiple NaN occurrences in 100ms window → single occurrence count increment
3. ✅ **Frame budget diagnostic**: P_FRAME_BUDGET_EXCEEDED diagnostic appears when worst frame > 25ms
4. ✅ **Runtime diagnostics integration**: DiagnosticHub receives runtime diagnostics via RuntimeHealthSnapshot event with diagnosticsDelta
5. ✅ **UI displays runtime diagnostics**: P_NAN_DETECTED and P_FRAME_BUDGET_EXCEEDED diagnostics appear in DiagnosticConsole with occurrence counts

---

## Deliverable 2: Diagnostics Settings Panel

### Acceptance Criteria
1. ✅ **Settings persistence**: DiagnosticsSettingsStore persists settings to localStorage
2. ✅ **Settings panel UI**: Settings panel displays all configurable options with labeled controls
3. ✅ **Runtime health toggle**: Runtime health monitoring respects `runtimeHealthEnabled` toggle
4. ✅ **Snapshot interval**: Health snapshot interval is configurable via slider (100ms-1000ms range)
5. ✅ **Frame budget threshold**: Frame budget threshold is configurable via slider (8ms-100ms range)
6. ✅ **Target FPS selector**: Target FPS selector (30/60/120) auto-adjusts frame budget threshold
7. ✅ **NaN/Inf toggles**: NaN and Infinity detection can be individually enabled/disabled
8. ✅ **Bus warnings toggle**: Bus warnings can be enabled/disabled globally
9. ✅ **Individual bus warning toggles**: Empty buses and no-publishers warnings can be individually toggled
10. ✅ **Reset to defaults**: "Reset to Defaults" button restores DEFAULT_DIAGNOSTICS_SETTINGS
11. ✅ **Immediate application**: Settings changes apply immediately via MobX reactivity (no save button needed)

---

## Deliverable 3: Bus Validation Warnings

### Acceptance Criteria
1. ✅ **W_BUS_EMPTY diagnostic**: Appears when bus has publishers but no listeners
2. ✅ **W_BUS_NO_PUBLISHERS diagnostic**: Appears when bus has listeners but no publishers (silent value message)
3. ✅ **UI displays bus warnings**: Bus warnings appear in DiagnosticConsole after successful compilation
4. ✅ **Only after successful compilation**: Bus warnings do NOT appear on compilation failure (only after success)
5. ✅ **Test coverage**: >80% coverage for bus validation logic

---

## Deliverable 4 (Optional): Basic Quick Fix - createTimeRoot

### Acceptance Criteria
1. ✅ **Action included in diagnostic**: E_TIME_ROOT_MISSING diagnostic includes "Create TimeRoot" action in actions array
2. ✅ **Action execution**: Clicking action button adds InfiniteTimeRoot block to patch at center position
3. ✅ **Diagnostic resolves**: After action executes, diagnostic disappears (authoring validators re-run, detect TimeRoot)
4. ✅ **Action logging**: Action execution is logged and can be undone via standard undo mechanism
5. ✅ **UI displays actions**: UI shows action buttons inline with diagnostic message in DiagnosticConsole

---

## General Acceptance Criteria

### Code Quality
- ✅ All new code has TSDoc comments for public APIs
- ✅ Zero TypeScript errors (strict mode)
- ✅ No `any` types (use `unknown` with type guards where needed)
- ✅ All discriminated unions have exhaustive switch statements
- ✅ Performance overhead <1% (health monitoring doesn't impact frame rate)

### Testing
- ✅ Unit test coverage >80% for HealthMonitor, busValidation, quickFixes
- ✅ Integration test: NaN occurs → snapshot emitted → diagnostic appears in UI
- ✅ Integration test: Bus with publishers but no listeners → W_BUS_EMPTY appears
- ✅ Integration test: Click "Create TimeRoot" → block added → diagnostic disappears
- ✅ Performance test: Health snapshot overhead <1ms per snapshot
- ✅ Performance test: NaN detection overhead <0.01ms per signal evaluation

### Documentation
- ✅ Update `src/diagnostics/README.md` with Sprint 2 features
- ✅ Code comments explain batching strategy for NaN/Inf detection
- ✅ Diagnostic code enum has inline comments for new P_* and W_* codes

### Non-Regression
- ✅ All existing tests pass (303/303 baseline from Sprint 1)
- ✅ Animation loop performance maintained (no visible frame drops)
- ✅ Existing diagnostics (compile, authoring) continue to work

---

## Definition of DONE

Sprint 2 is DONE when:
1. All 27 acceptance criteria above are met (22 required for P0-P2, 5 optional for Deliverable 4/P3)
2. Code review approved by one peer
3. All tests pass in CI
4. Demo shows:
   - NaN during animation → runtime diagnostic appears
   - Bus with no listeners → compile warning appears
   - (Optional) Click "Create TimeRoot" → TimeRoot added, diagnostic clears
5. No P0 bugs remain open
6. Performance regression <1% (measured via frame timing)
