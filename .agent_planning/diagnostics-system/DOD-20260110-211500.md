# Diagnostics System - Definition of Done (Sprint 1)

## Deliverable 1: Core Type System & Event Infrastructure

### Acceptance Criteria
1. ✅ **TargetRef type safety**: TargetRef discriminated union enforces exhaustiveness checking. TypeScript compiler error if switch statement missing a case.
2. ✅ **Diagnostic ID determinism**: Given same (code, target, patchRevision), `generateDiagnosticId()` returns identical string. Verified with snapshot tests.
3. ✅ **EventHub synchronous execution**: `EventHub.emit()` calls all listeners synchronously before returning. Verified with execution order test.
4. ✅ **EventHub exception isolation**: If one listener throws, other listeners still execute. Verified with error-throwing listener test.
5. ✅ **Event type safety**: `EventHub.on<'CompileEnd'>()` provides event with correct shape (status, diagnostics, etc.). TypeScript enforces payload structure.

---

## Deliverable 2: DiagnosticHub State Manager

### Acceptance Criteria
1. ✅ **Authoring validator performance**: Authoring validators complete in <10ms for 50-block patch, <50ms for 200-block patch. Verified with performance.now() timing.
2. ✅ **Compile snapshot replacement**: After CompileEnd with 3 diagnostics, `hub.getCompileSnapshot(rev)` returns exactly 3 diagnostics (not merged with previous). Verified with test emitting multiple CompileEnd events.
3. ✅ **Active diagnostics union**: `hub.getActive()` returns diagnostics from compile snapshot + authoring snapshot (no duplicates by ID).
4. ✅ **TimeRoot validation**: Missing TimeRoot → `E_TIME_ROOT_MISSING` diagnostic. Multiple TimeRoots → `E_TIME_ROOT_MULTIPLE` diagnostic. Verified with test patches.
5. ✅ **MobX reactivity**: When `hub.incrementRevision()` is called, `DiagnosticStore.revision` computed updates, triggering UI re-render. Verified with MobX reaction test.

---

## Deliverable 3: Compiler Integration & Basic UI

### Acceptance Criteria
1. ✅ **Compiler event emissions**: Calling `compile()` emits CompileBegin before compilation, CompileEnd after. Verified by capturing events in test.
2. ✅ **Error-to-diagnostic conversion**: Compiler error with `code: 'TypeMismatch'` converts to `Diagnostic` with `code: 'E_TYPE_MISMATCH'`, correct target, and stable ID.
3. ✅ **UI reactive updates**: Adding block → PatchStore mutation → GraphCommitted emission → authoring validators run → DiagnosticConsole updates (no manual refresh needed). Verified in integration test.
4. ✅ **Diagnostic row display**: DiagnosticRow shows severity icon (❌/⚠️/ℹ️), title, message, and formatted target string. Verified with snapshot test.
5. ✅ **GraphCommitted on mutations**: PatchStore.addBlock() triggers GraphCommitted emission with correct patchRevision. Verified with event capture test.

---

## General Acceptance Criteria

### Code Quality
- ✅ All new code has TSDoc comments for public APIs
- ✅ Zero TypeScript errors (strict mode)
- ✅ No `any` types (use `unknown` with type guards where needed)
- ✅ All discriminated unions have exhaustive switch statements

### Testing
- ✅ Unit test coverage >80% for DiagnosticHub, EventHub, validators
- ✅ Integration test: Add block → compile with error → diagnostic appears in UI
- ✅ Performance test: Authoring validators <10ms for 50-block patch

### Documentation
- ✅ README updated with EventHub and DiagnosticHub architecture
- ✅ Code comments explain five-event contract
- ✅ Diagnostic code enum has inline comments for each code

### Non-Regression
- ✅ All existing tests pass (no breaking changes to PatchStore, compiler, UI)
- ✅ Existing DiagnosticsStore consumers (if any) migrated or shimmed

---

## Definition of DONE

Sprint 1 is DONE when:
1. All 15 acceptance criteria above are met
2. Code review approved by one peer
3. All tests pass in CI
4. Demo to team shows: compile error → diagnostic appears in UI with stable ID
5. No P0 bugs remain open
