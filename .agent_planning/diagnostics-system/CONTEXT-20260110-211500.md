# Diagnostics System - Implementation Context

This document provides comprehensive context for implementing the Diagnostics System Sprint 1.

## Key Files & Locations

### Existing Files to Modify

1. **`src/stores/RootStore.ts`** - Wire EventHub and DiagnosticHub
   - Lines 16-34: Store initialization in constructor
   - Add: EventHub, DiagnosticHub, patchRevision tracking
   - Add: MobX reaction to emit GraphCommitted on patch changes

2. **`src/compiler/compile.ts`** - Add event emissions
   - Line 46: Function signature - add EventHub parameter
   - After line 46: Emit CompileBegin
   - Line 75-77: Error handling - emit CompileEnd with failure
   - Before line 128: Emit CompileEnd with success

3. **`src/stores/DiagnosticsStore.ts`** - Rewrite to wrap DiagnosticHub
   - Current: Simple error/warning/log tracking with sequential IDs
   - New: MobX wrapper exposing computed properties from DiagnosticHub

4. **`src/ui/components/app/App.tsx`** - Add DiagnosticConsole
   - Add DiagnosticConsole component to layout

### New Files to Create

1. **`src/diagnostics/types.ts`** - Core type definitions
   - TargetRef discriminated union (7 kinds)
   - Diagnostic interface
   - DiagnosticCode type
   - Severity and Domain enums
   - Helper type createDiagnostic()

2. **`src/diagnostics/diagnosticId.ts`** - Stable ID generation
   - serializeTargetRef()
   - generateDiagnosticId()

3. **`src/events/EventHub.ts`** - Event bus
   - EventHub class with emit/on/subscribe
   - Type-safe event filtering
   - Exception isolation

4. **`src/events/types.ts`** - Event definitions
   - EditorEvent discriminated union
   - 5 core event interfaces (GraphCommitted, CompileBegin, CompileEnd, ProgramSwapped, RuntimeHealthSnapshot)

5. **`src/diagnostics/DiagnosticHub.ts`** - State manager
   - Five-event subscription contract
   - Compile/authoring/runtime snapshot management
   - Query methods (getActive, getByRevision, etc.)

6. **`src/diagnostics/validators/authoringValidators.ts`** - Fast validators
   - runAuthoringValidators() - <10ms budget
   - TimeRoot checks
   - Disconnected block detection

7. **`src/compiler/diagnosticConversion.ts`** - Error conversion
   - convertCompileErrorToDiagnostic()
   - extractTargetFromError()

8. **`src/ui/components/app/DiagnosticConsole.tsx`** - UI component
   - DiagnosticConsole observer component
   - DiagnosticRow component
   - Severity filtering and display

## Key Patterns & Implementation Notes

### TargetRef Discriminated Union
```typescript
type TargetRef =
  | { kind: 'block'; blockId: string }
  | { kind: 'port'; blockId: string; portId: string }
  | { kind: 'bus'; busId: string }
  | { kind: 'binding'; bindingId: string; busId: string; blockId: string; direction: 'publish' | 'subscribe' }
  | { kind: 'timeRoot'; blockId: string }
  | { kind: 'graphSpan'; blockIds: string[]; spanKind?: 'cycle' | 'island' | 'subgraph' }
  | { kind: 'composite'; compositeDefId: string; instanceId?: string };
```

### Stable ID Generation
```typescript
function generateDiagnosticId(
  code: DiagnosticCode,
  primaryTarget: TargetRef,
  patchRevision: number,
  signature?: string
): string {
  const targetStr = serializeTargetRef(primaryTarget);
  return `${code}:${targetStr}:rev${patchRevision}${signature ? `:${signature}` : ''}`;
}
```

### EventHub Type-Safe Subscriptions
```typescript
const unsubscribe = events.on('CompileEnd', (event) => {
  // TypeScript knows event has status, durationMs, diagnostics
  if (event.status === 'success') {
    console.log(`Compiled in ${event.durationMs}ms`);
  }
});
```

### Five-Event Subscription Contract

| Event | DiagnosticHub Action |
|-------|---------------------|
| `GraphCommitted` | Run authoring validators, update authoring snapshot |
| `CompileBegin` | Set pendingCompileRevision |
| `CompileEnd` | **Replace** compile snapshot (not merge) |
| `ProgramSwapped` | Set activeRevision pointer |
| `RuntimeHealthSnapshot` | Update/merge runtime diagnostics (Sprint 2) |

### MobX Reactivity Pattern
```typescript
class DiagnosticHub {
  private diagnosticsRevision: number = 0;

  private incrementRevision() {
    this.diagnosticsRevision++;
  }

  getDiagnosticsRevision(): number {
    return this.diagnosticsRevision;
  }
}

class DiagnosticStore {
  get revision(): number {
    return this.hub.getDiagnosticsRevision(); // MobX tracks this
  }

  get activeDiagnostics(): Diagnostic[] {
    this.revision; // Force dependency on revision
    return this.hub.getActive();
  }
}
```

### Authoring Validators Performance
```typescript
// Fast, synchronous validators (<10ms budget)
function runAuthoringValidators(patch: Patch, patchRevision: number): Diagnostic[] {
  const diags: Diagnostic[] = [];

  // Check 1: TimeRoot presence
  const timeRoots = Array.from(patch.blocks.values()).filter(
    b => b.type === 'InfiniteTimeRoot' || b.type === 'FiniteTimeRoot'
  );

  if (timeRoots.length === 0) {
    diags.push(createDiagnostic({
      code: 'E_TIME_ROOT_MISSING',
      severity: 'error',
      domain: 'authoring',
      primaryTarget: { kind: 'graphSpan', blockIds: [] },
      title: 'No TimeRoot',
      message: 'Patch must have exactly one TimeRoot block',
      patchRevision,
    }));
  }

  if (timeRoots.length > 1) {
    diags.push(createDiagnostic({
      code: 'E_TIME_ROOT_MULTIPLE',
      severity: 'error',
      domain: 'authoring',
      primaryTarget: { kind: 'graphSpan', blockIds: timeRoots.map(b => b.id) },
      title: 'Multiple TimeRoots',
      message: `Found ${timeRoots.length} TimeRoot blocks. Only one allowed.`,
      patchRevision,
    }));
  }

  return diags;
}
```

## Specification References

### Diagnostic System Spec
**Location**: `design-docs/CANONICAL-oscilla-v2.5-20260109/topics/07-diagnostics-system.md`
- Lines 259-268: TargetRef definition
- Lines 273-285: Severity levels
- Lines 297-333: Full Diagnostic interface
- Lines 338-365: Stable ID generation rules
- Lines 469-525: Diagnostic codes organized by category

### Event System Spec
**Location**: `design-docs/CANONICAL-oscilla-v2.5-20260109/topics/12-event-hub.md`
- Event-driven coordination architecture
- Type-safe event subscriptions
- Five core events for diagnostics

### Event-Diagnostics Integration Spec
**Location**: `design-docs/CANONICAL-oscilla-v2.5-20260109/topics/13-event-diagnostics-integration.md`
- Five-event subscription contract
- DiagnosticHub state management
- Snapshot replacement semantics

## Ambiguity Resolutions (from EVAL)

1. **Muting**: Removed for errors - errors always show
2. **Compile races**: Queue next compile (simplest approach)
3. **Runtime expiry**: Configurable time/count-based, default to no expiry
4. **Validator timing**: Immediate, no debounce
5. **TargetRef**: Hard IDs only, no semantic paths needed
6. **Multi-patch**: One DiagnosticHub per RootStore
7. **Action idempotency**: Yes, actions are idempotent

## Critical Implementation Notes

### Compiler Function Signature Change
**Old**:
```typescript
export function compile(patch: Patch): CompileResult | CompileFailure
```

**New**:
```typescript
export function compile(
  patch: Patch,
  options: {
    events: EventHub;
    patchRevision: number;
    patchId: string;
  }
): CompileResult | CompileFailure
```

### RootStore GraphCommitted Emission
```typescript
constructor() {
  // ... existing store creation ...

  this.events = new EventHub();
  this.diagnosticHub = new DiagnosticHub(this.events, 'patch-0');
  this.diagnostics = new DiagnosticStore(this.diagnosticHub);

  // Wire patch mutations to emit GraphCommitted
  reaction(
    () => ({
      blockCount: this.patch.blocks.size,
      edgeCount: this.patch.edges.length,
    }),
    () => {
      this.patchRevision++;
      this.events.emit({
        type: 'GraphCommitted',
        patchId: 'patch-0',
        patchRevision: this.patchRevision,
        reason: 'userEdit',
        diffSummary: {
          blocksAdded: 0,
          blocksRemoved: 0,
          edgesChanged: 0,
        },
      });
    }
  );
}
```

## Diagnostic Codes (Sprint 1 Subset)

### Time & Topology Errors
- `E_TIME_ROOT_MISSING` - Patch has no TimeRoot block
- `E_TIME_ROOT_MULTIPLE` - Patch has multiple TimeRoot blocks

### Type System Errors
- `E_TYPE_MISMATCH` - Port types cannot unify
- `E_DOMAIN_MISMATCH` - Domain cardinalities conflict

### Graph Structure Errors
- `E_CYCLE_DETECTED` - Cycle has no stateful boundary
- `E_MISSING_INPUT` - Required input not connected
- `E_UNKNOWN_BLOCK_TYPE` - Block type not recognized

### Graph Quality Warnings
- `W_GRAPH_DISCONNECTED_BLOCK` - Block not reachable from TimeRoot
- `W_GRAPH_UNUSED_OUTPUT` - Block output not connected

### Authoring Hints
- `I_SILENT_VALUE_USED` - Unconnected input using default

## Performance Targets

| Operation | Target | Measurement |
|-----------|--------|-------------|
| Authoring validators | <10ms | 50-block patch |
| Authoring validators | <50ms | 200-block patch |
| Event emission overhead | <1ms | per event |
| Diagnostic ID generation | <0.1ms | per ID |

## Testing Strategy

### Unit Tests
- DiagnosticId generation: determinism, uniqueness
- EventHub: emit/subscribe/unsubscribe, exception isolation
- DiagnosticHub: snapshot replacement, query methods
- Authoring validators: TimeRoot checks, performance

### Integration Tests
- End-to-end: Add block → GraphCommitted → validators → UI update
- Compile flow: Compile with error → CompileEnd → diagnostic in console
- Snapshot replacement: Two compiles → only latest diagnostics shown

## Implementation Order (Critical Path)

1. Core type definitions (TargetRef, Diagnostic, DiagnosticCode, events)
2. EventHub implementation
3. DiagnosticHub with five-event subscriptions
4. RootStore wiring (EventHub, GraphCommitted emission)
5. Compiler event emissions
6. Authoring validators
7. DiagnosticConsole UI component
8. Integration testing and polish

## Files Modified Summary

**Existing files modified**: 4
- `src/compiler/compile.ts`
- `src/stores/RootStore.ts`
- `src/stores/DiagnosticsStore.ts`
- `src/ui/components/app/App.tsx`

**New files created**: ~15
- Core types and utilities (5 files)
- Event system (2 files)
- DiagnosticHub and validators (3 files)
- UI components (2 files)
- Tests (3+ files)

## See Also

- EVALUATION-20260110-211500.md - Current state analysis
- EVAL-20260110-211500.md - Gap analysis and ambiguity resolutions
- PLAN-20260110-211500.md - Full sprint plan with detailed steps
- DOD-20260110-211500.md - Acceptance criteria
- design-docs/CANONICAL-oscilla-v2.5-20260109/topics/07-diagnostics-system.md - Full spec
