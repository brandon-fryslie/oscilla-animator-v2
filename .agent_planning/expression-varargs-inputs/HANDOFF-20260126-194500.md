# Handoff: Autocomplete Varargs Wiring - Debug Phase

**Date**: 2026-01-26 19:45:00
**Topic**: expression-varargs-inputs (autocomplete wiring)
**Status**: THREE BUGS BLOCKING COMPLETION

## What Was Implemented

✅ **Complete** - All code written and committed (commit 3ad1f49)

1. **OutputSuggestion type** - Block.port suggestions (e.g., "Circle.radius")
2. **suggestAllOutputs() method** - Returns flat list of all outputs from patch blocks
3. **filterSuggestions() integration** - Includes outputs in default autocomplete results
4. **AutocompleteDropdown icon** - Added '→' icon for 'output' type
5. **PatchStore.addVarargConnection()** - Wires vararg connections on selection
6. **Expression block lowering** - Already processes varargConnections via unified code path

Tests: 49/49 passing (suggestions + autocomplete)

## Three Bugs Blocking Functionality

### Bug 1: No Blocks in Suggestion List
**Symptom**: Autocomplete shows functions and inputs, but NO block.port suggestions

**Root Cause**: `suggestAllOutputs()` returns empty array
- Patch clearly has blocks (b0, b1, b2 visible in UI)
- But `this.patch.blocks.values()` appears empty or all blocks filtered out by `excludeBlockId`

**Files Involved**:
- `src/expr/suggestions.ts` line 314-342 (suggestAllOutputs method)
- `src/ui/components/BlockInspector.tsx` line 1951-1954 (filterSuggestions call with blockId)

**Investigation Needed**:
- Is `patch.blocks` actually populated when SuggestionProvider is created?
- Is `excludeBlockId` accidentally filtering ALL blocks?
- Is there a race condition where patch blocks aren't available yet?

---

### Bug 2: Autocomplete Menu Rendered Offscreen
**Symptom**: Dropdown menu appears but is positioned completely off the visible area

**Root Cause**: Position calculation in AutocompleteDropdown or getCursorPosition

**Files Involved**:
- `src/ui/expression-editor/AutocompleteDropdown.tsx` (positioning logic)
- `src/ui/expression-editor/cursorPosition.ts` (cursor position calculation)

**Investigation Needed**:
- Check position calculation in getCursorPosition()
- Verify adjustPositionForViewport() logic
- Ensure dropdown doesn't exceed viewport bounds

---

### Bug 3: Selecting Item Doesn't Insert Text
**Symptom**: Click suggestion → nothing happens, text unchanged, dropdown closes

**Root Cause**: `insertSuggestion()` function doesn't handle 'output' type

**Files Involved**:
- `src/ui/components/BlockInspector.tsx` line 1860-1895 (insertSuggestion function)

**Current Behavior**:
- Handles 'function' type (positions cursor inside parens)
- Handles 'block' type (adds trailing dot)
- MISSING 'output' type case

**Fix**:
```typescript
// Add to insertSuggestion function around line 1883:
if (suggestion.type === 'output') {
  cursorOffset = insertText.length; // After the output reference
}
```

---

## Code State

**Latest Commit**: 3ad1f49 - feat(expr): Implement autocomplete varargs wiring for block references

**Modified Files**:
- src/expr/suggestions.ts - OutputSuggestion type + suggestAllOutputs() method
- src/ui/expression-editor/AutocompleteDropdown.tsx - Added 'output' icon
- src/ui/components/BlockInspector.tsx - handleSelectSuggestion wiring logic + insertSuggestion case
- src/stores/PatchStore.ts - addVarargConnection() action

**All Tests Pass**: 49/49 (suggestions, autocomplete)

---

## Next Agent Instructions

1. **Start with Bug 3** (easiest) - Add 'output' case to insertSuggestion()
2. **Debug Bug 1** - Check why suggestAllOutputs() is empty
   - Add console.log in suggestAllOutputs to see if blocks are accessible
   - Check if excludeBlockId is correct value
3. **Fix Bug 2** - Position dropdown correctly
   - Check getCursorPosition() and adjustPositionForViewport()

Once all three fixed, the feature should work end-to-end:
- User types expression, sees block.port suggestions
- Selects suggestion → text inserted + vararg connection wired
- Expression compiles with new block reference

---

## Files to Check

```
src/expr/suggestions.ts
  - Line 314: suggestAllOutputs() method
  - Line 359-396: filterSuggestions() with excludeBlockId parameter

src/ui/components/BlockInspector.tsx
  - Line 1860: insertSuggestion() function (ADD 'output' CASE HERE)
  - Line 1951-1954: filterSuggestions calls with blockId
  - Line 2072-2090: handleSelectSuggestion (wiring logic)

src/ui/expression-editor/AutocompleteDropdown.tsx
  - Line 55-68: getTypeIcon() (has 'output' case)
  - Positioning logic for dropdown

src/ui/expression-editor/cursorPosition.ts
  - getCursorPosition() function
  - adjustPositionForViewport() function
```
