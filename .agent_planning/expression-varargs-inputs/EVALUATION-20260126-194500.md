# Evaluation: Autocomplete Varargs Wiring

**Date**: 2026-01-26 19:45:00
**Topic**: expression-varargs-inputs (autocomplete wiring phase)
**Verdict**: CONTINUE

## Context

The unified varargs system for Expression block is implemented (Sprint: unified-varargs). Now we need to connect the autocomplete UI to wire vararg connections when users select block.port suggestions.

## Current State

### What Exists

1. **SuggestionProvider** (`src/expr/suggestions.ts`):
   - `suggestFunctions()` - returns math functions (sin, cos, lerp, etc.)
   - `suggestInputs()` - returns in0-in4 (hardcoded, not connected to actual ports)
   - `suggestBlocks()` - returns block names from patch (NOT currently included in filterSuggestions default)
   - `suggestBlockPorts(blockName)` - returns ports for a specific block
   - `filterSuggestions()` - combines functions + inputs + blocks (but NOT block.port combinations)

2. **AutocompleteDropdown** (`src/ui/expression-editor/AutocompleteDropdown.tsx`):
   - Renders suggestions with type icons
   - Keyboard navigation (arrows, enter, escape)
   - Calls `onSelect(suggestion)` when user selects

3. **ExpressionEditor** in BlockInspector:
   - Has access to `patchStore` for mutations
   - `handleSelectSuggestion()` - inserts text but does NOT wire connections
   - Has `blockId` (the Expression block being edited)

4. **Patch Varargs API**:
   - `PatchBuilder.addVarargConnection(blockId, portId, sourceAddress, sortKey, alias?)`
   - `VarargConnection { sourceAddress, alias?, sortKey }`

5. **Expression Block Lowering**:
   - Already processes varargConnections via unified code path
   - Uses `conn.alias ?? conn.sourceAddress` as the identifier

### What's Missing

1. **Flat block.port suggestions**: No method returns all block.port combinations as a flat list
2. **Connection wiring on select**: `handleSelectSuggestion` only inserts text, doesn't wire vararg
3. **sortKey calculation**: Need to compute `max(existing sortKeys) + 1`

## Work Items

| Item | Confidence | Notes |
|------|------------|-------|
| Add `suggestAllOutputs()` method | HIGH | Iterate blocks, iterate outputs, return flat list |
| Include outputs in `filterSuggestions()` | HIGH | Add to default suggestion set |
| Wire vararg connection on select | HIGH | Call `patchStore.addVarargConnection()` |
| Calculate sortKey from existing connections | HIGH | Simple max + 1 logic |
| Update suggestion type for block.port | HIGH | May need new type or reuse 'port' |

## Dependencies

- ✅ Unified varargs system implemented (SPRINT-20260126-unified-varargs)
- ✅ VarargConnection type and Patch API exist
- ✅ Expression block lowering processes varargConnections

## Risks

| Risk | Mitigation |
|------|------------|
| Expression block not found when wiring | Check that selected block is Expression type |
| Port not a vararg input | Verify 'refs' port exists with isVararg: true |
| Duplicate connections | Could check if connection already exists (optional) |

## Recommendation

Single sprint, all HIGH confidence. Ready for implementation.
