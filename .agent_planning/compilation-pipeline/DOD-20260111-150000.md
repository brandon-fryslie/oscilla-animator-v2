# Definition of Done: Compilation Pipeline - Wire passes-v2

Generated: 2026-01-11 15:00:00

## P0: Fix Intermediate Patch Types and Data Flow

- [ ] All intermediate patch types include `blocks: readonly Block[]` property
- [ ] All intermediate patch types include `edges: readonly NormalizedEdge[]` property
- [ ] NormalizedEdge uses index-based properties: `fromBlock`, `toBlock`, `fromPort`, `toPort`
- [ ] `npm run typecheck` passes for `src/compiler/ir/patches.ts`

## P1: Rewrite All Passes with Correct Signatures

- [ ] Pass 2: Single parameter `(patch: NormalizedPatch)`, uses NormalizedEdge properties
- [ ] Pass 3: Single parameter `(patch: TypedPatch)`, accesses `patch.blocks` directly
- [ ] Pass 3: Throws `NoTimeRoot` error when no TimeRoot block exists
- [ ] Pass 3: Throws `MultipleTimeRoots` error when >1 TimeRoot block exists
- [ ] Pass 4: Single parameter, uses `blockIndex` not `blockIndexMap`
- [ ] Pass 4: Works with NormalizedEdge (fromBlock/toBlock indices)
- [ ] Pass 5: Single parameter, gets blocks from patch
- [ ] Pass 6: Single parameter, gets blocks and edges from patch
- [ ] Pass 8: Single parameter, all imports resolved
- [ ] All passes use hybrid error pattern: collect errors, throw at end if non-empty
- [ ] Error kinds preserved through pipeline (NoTimeRoot, MultipleTimeRoots, TypeMismatch, etc.)
- [ ] `npm run typecheck` passes with zero errors

## P2: Implement Pass 7 and IR Conversion

- [ ] `pass7Schedule` function exists in `pass7-schedule.ts`
- [ ] `pass7Schedule` exported from `passes-v2/index.ts`
- [ ] Pass 7 produces topologically sorted execution order
- [ ] `convertLinkedIRToProgram` produces valid `CompiledProgramIR`
- [ ] CompiledProgramIR includes: signalExprs, schedule, slotMeta
- [ ] All 11 tests in `compile.test.ts` pass
- [ ] End-to-end: `compile(patch)` returns `{kind: 'ok', program: CompiledProgramIR}`

## Final Verification

- [ ] `npm run typecheck` - Zero errors
- [ ] `npm run test -- compile.test.ts` - 11/11 tests pass
- [ ] `npm run build` - Builds successfully
