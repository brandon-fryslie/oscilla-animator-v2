# Definition of Done: Domain Unification Sprint

**Sprint:** 2026-01-09
**Topic:** Compilation Pipeline - Domain Unification
**Scope:** Implement domain compatibility checking for field expressions

---

## Acceptance Criteria

### AC-1: IR Types Updated
- [ ] `FieldExprZip` has optional `domain?: DomainId` field
- [ ] `FieldExprMap` has optional `domain?: DomainId` field
- [ ] `FieldExprZipSig` has optional `domain?: DomainId` field
- [ ] Types compile without errors
- [ ] Optional fields don't break existing code

### AC-2: Domain Inference Works
- [ ] `inferFieldDomain(sourceField)` returns the domain from FieldExprSource
- [ ] `inferFieldDomain(mapField)` propagates domain from input
- [ ] `inferFieldDomain(zipField)` returns unified domain from inputs
- [ ] `inferFieldDomain(broadcastField)` returns undefined
- [ ] Domain mismatch in fieldZip throws clear error

### AC-3: Domain Stored in IR
- [ ] `fieldMap()` stores inferred domain in FieldExprMap
- [ ] `fieldZip()` stores inferred domain in FieldExprZip
- [ ] `fieldZipSig()` stores inferred domain in FieldExprZipSig
- [ ] Built IR contains domain information on composite field expressions

### AC-4: Render Sink Validation
- [ ] RenderInstances2D validates pos field domain matches sink domain
- [ ] RenderInstances2D validates color field domain matches sink domain
- [ ] Domain mismatch produces clear error with both domain IDs
- [ ] Valid aligned fields compile and render correctly

### AC-5: Tests Pass
- [ ] `npm run typecheck` passes with 0 errors
- [ ] `npm run test` passes all existing tests (68+)
- [ ] New domain unification tests pass
- [ ] `npm run dev` renders correctly

### AC-6: Error Quality
- [ ] Domain mismatch errors include both domain IDs
- [ ] Errors identify which operation caused the mismatch
- [ ] Errors are actionable (user knows how to fix)

---

## Verification Checklist

```bash
# 1. Type checking
npm run typecheck
# Expected: 0 errors

# 2. All tests pass
npm run test
# Expected: All tests pass (68+ existing + new domain tests)

# 3. Manual verification
npm run dev
# Expected: Animation renders correctly

# 4. Domain mismatch test (manual)
# Create test with fields from different domains
# Expected: Clear compile error with domain IDs
```

---

## Test Cases Required

### Domain Inference Tests
```typescript
it('infers domain from FieldExprSource')
it('propagates domain through FieldExprMap')
it('unifies domain across FieldExprZip inputs')
it('propagates domain through FieldExprZipSig')
it('returns undefined for broadcast/const fields')
```

### Domain Validation Tests
```typescript
it('accepts fieldZip with same-domain inputs')
it('rejects fieldZip with different-domain inputs')
it('accepts render with aligned field domains')
it('rejects render with misaligned pos field')
it('rejects render with misaligned color field')
```

---

## What "Done" Means

This sprint is complete when:
1. Field expressions track their domain through composition
2. Domain mismatches are caught at compile time
3. Clear error messages help users fix domain issues
4. All tests pass and application runs

---

## What "Done" Does NOT Mean

- TypeChecker DomainRef ID equality (may need type system changes)
- Broadcast domain assignment from context
- Domain-based optimization
- Dead domain detection
- ScheduleIR typing
