# COMPILATION PIPELINE INTEGRATION EVALUATION

**Date:** 2026-01-11 14:00:00
**Topic:** Wire passes-v2 to main compile pipeline
**Status:** CRITICAL INTEGRATION ISSUES IDENTIFIED

## EXECUTIVE SUMMARY

The compilation pipeline has **75 type errors** preventing integration. The issues fall into three categories:

1. **Function Signature Mismatches** - Passes expect different parameters than compile.ts provides
2. **Type Definition Gaps** - Missing exports and type imports in pass files
3. **Data Structure Incompatibilities** - NormalizedPatch vs TypedPatch vs TimeResolvedPatch inconsistencies

**Critical Blockers:**
- pass3 and pass5 have wrong signatures and accept error parameters that compile.ts doesn't track
- pass7 is not exported from index.ts (function doesn't exist yet)
- pass8 has massive import/type coverage issues
- NormalizedPatch structure doesn't match what passes expect

---

## 1. WHAT EXISTS: CURRENT STATE ANALYSIS

### 1.1 Main Entry Point (compile.ts) - Partial Implementation
- **Status:** 70% complete
- **What it does:** Orchestrates 8 passes in sequence
- **What it provides:**
  - Pass 1: Normalize (works, handles errors correctly)
  - Passes 2-8: Calls functions that have signature mismatches
  - Error handling: Try/catch around entire pipeline
  - Event emission for diagnostics (begin/end)
  - Format conversion stub (convertLinkedIRToProgram - returns empty IR)

### 1.2 Passes Implemented (passes-v2/)
- **pass2-types.ts** - Type validation (WORKS, collects errors, throws at end)
- **pass3-time.ts** - Time model extraction (BROKEN - wrong signature)
- **pass4-depgraph.ts** - Dependency graph (BROKEN - accesses wrong properties)
- **pass5-scc.ts** - Cycle validation (INCOMPLETE - signature mismatch, missing blocks parameter)
- **pass6-block-lowering.ts** - IR lowering (PARTIALLY WORKS - some validation issues)
- **pass7-schedule.ts** - Schedule construction (NOT EXPORTED - function missing)
- **pass8-link-resolution.ts** - Link resolution (BROKEN - huge import gaps)
- **index.ts** - Module exports (INCOMPLETE - missing pass7, wrong exports)

### 1.3 Tests (compile.test.ts)
- Tests compiled but expect specific behavior
- Tests check for:
  - TimeRoot validation (no TimeRoot, multiple TimeRoots)
  - Signal compilation (constants, connections)
  - Domain compilation (GridDomain, DomainN)
  - Field compilation (broadcasts)
  - Error handling (unknown block types)

---

## 2. WHAT'S MISSING: SIGNATURE & TYPE MISMATCHES

### 2.1 Pass Function Signature Mismatches

**Pass 2 (pass2TypeGraph):**
- Current: `(normalized: NormalizedPatch) => TypedPatch`
- **Status:** ‚úì CORRECT - but has issues with edge type access

**Pass 3 (pass3TimeTopology):**
- Current signature in code: `(typed: TypedPatch, errors: string[]) => TimeResolvedPatch`
- Compile.ts calls: `pass3TimeTopology(typedPatch)` - **1 argument**
- **Issue:** Function expects 2 arguments, gets 1
- **Additional issue:** Accesses `typed.normalizedPatch.blocks.find()` but TypedPatch doesn't have normalizedPatch property

**Pass 4 (pass4DepGraph):**
- Current: `(timeResolved: TimeResolvedPatch) => DepGraphWithTimeModel`
- **Status:** Signature looks correct BUT...
- **Issue:** Accesses `timeResolved.blockIndexMap` which doesn't exist
  - Should be: `timeResolved.blockIndex` (from NormalizedPatch)
- **Issue:** Receives `NormalizedEdge[]` (with fromBlock/fromPort/toBlock/toPort)
  - But tries to access `edge.from.blockId` and `edge.to.blockId` (Edge type structure)

**Pass 5 (pass5CycleValidation):**
- Current: `(depGraphWithTime: DepGraphWithTimeModel, blocks: readonly Block[]) => AcyclicOrLegalGraph`
- Compile.ts calls: `pass5CycleValidation(depGraphPatch)` - **1 argument**
- **Issue:** Function requires 2 arguments, gets 1
- **Issue:** Pass needs blocks array to check state boundaries, but compile.ts doesn't provide it

**Pass 6 (pass6BlockLowering):**
- Current: `(validated: AcyclicOrLegalGraph, blocks: readonly Block[], edges?: readonly Edge[]) => UnlinkedIRFragments`
- Compile.ts calls: `pass6BlockLowering(acyclicPatch)` - **1 argument**
- **Issue:** Function requires 2-3 arguments, gets 1
- **Issue:** Receives NormalizedEdge[] but expects Edge[] (different structure)

**Pass 7 (pass7Schedule):**
- Current: NOT EXPORTED from index.ts
- **File:** pass7-schedule.ts only defines types (ScheduleIR, StateSlotDef)
- **Missing:** Actual `export function pass7Schedule(...)` implementation
- Compile.ts calls: `pass7Schedule(unlinkedIR)` - **1 argument**
- **Issue:** Function doesn't exist

**Pass 8 (pass8LinkResolution):**
- Current: `(fragments: UnlinkedIRFragments, blocks: readonly Block[], edges: readonly Edge[]) => LinkedGraphIR`
- Compile.ts calls: `pass8LinkResolution(scheduleIR)` - **1 argument**
- **Issue:** Function requires 3 arguments, gets 1
- **Issue:** Receives ScheduleIR (completely wrong type) instead of LinkedGraphIR

### 2.2 Missing Type Exports

**From passes-v2/index.ts:**
```
- ValueRefPacked (declared in pass6 but not exported)
- pass7Schedule function (doesn't exist)
- ScheduleStep, PhaseGroup, ExecutionPhase, ExecutionClass (not in pass7-schedule.ts)
```

**From pass8-link-resolution.ts:**
```
Missing imports:
- ValueRefPacked (not imported)
- BlockIndex (not imported)
- IRBuilder (not imported)
- CompileError (not imported)
- getBlockType, getBlockDefinition (not imported)
- TRANSFORM_REGISTRY (not imported)
- TransformStep, AdapterStep, TransformIRCtx (not imported)
```

---

## 3. DATA STRUCTURE INCOMPATIBILITIES

### 3.1 NormalizedPatch vs TypedPatch Structure

**NormalizedPatch (from normalize.ts):**
```typescript
interface NormalizedPatch {
  readonly patch: Patch;
  readonly blockIndex: ReadonlyMap<BlockId, BlockIndex>;  // ‚Üê KEY: blockIndex
  readonly blocks: readonly Block[];
  readonly edges: readonly NormalizedEdge[];
}
```

**NormalizedEdge:**
```typescript
interface NormalizedEdge {
  readonly fromBlock: BlockIndex;
  readonly fromPort: PortId;
  readonly toBlock: BlockIndex;
  readonly toPort: PortId;
}
```

**TypedPatch extends NormalizedPatch** but:
- **Pass 3 tries to access:** `typed.normalizedPatch.blocks` - **WRONG**
  - Should be: `typed.blocks` (direct property)
- **Pass 2 tries to access edges as:** `readonly Edge[]`
  - But receives: `readonly NormalizedEdge[]`
  - These have different property names (fromBlock vs from.blockId)

### 3.2 TimeResolvedPatch Property Access

**Expected:** extends TypedPatch with timeModel and timeSignals
**Pass 4 accesses:** `timeResolved.blockIndexMap`
**Actually exists:** `timeResolved.blockIndex`

### 3.3 Edge Type Mismatch Through Pipeline

- **Pass 1 outputs:** NormalizedEdge[] (with fromBlock/fromPort/toBlock/toPort)
- **Pass 2 expects:** Edge[] (with from.blockId/from.slotId/to.blockId/to.slotId)
- **Pass 4 expects:** Edge[] but receives NormalizedEdge[]
- **Pass 6 expects:** Edge[] but receives NormalizedEdge[]
- **Pass 8 expects:** Edge[]

**The Fix Needed:** Either:
1. Convert NormalizedEdge ‚Üí Edge after normalization, OR
2. Update all passes to work with NormalizedEdge structure

---

## 4. ERROR HANDLING PATTERN MISMATCHES

### 4.1 Current Error Handling Patterns

**Pass 2 (Type Graph):**
- Collects errors in array
- Throws single Error at end with summary
- Does NOT propagate errors to caller
- **Pattern:** "Throw everything at end"

**Pass 4 (DepGraph):**
- Collects errors in array
- Throws single Error at end with summary
- **Pattern:** "Throw everything at end"

**Pass 5 (SCC):**
- Collects errors in `IllegalCycleError[]`
- Returns them in result object (`AcyclicOrLegalGraph.errors`)
- **Pattern:** "Return errors in result"
- **Issue:** Compile.ts doesn't check for returned errors!

**Pass 6 (Block Lowering):**
- Collects errors in `CompileError[]`
- Returns them in result object (`UnlinkedIRFragments.errors`)
- **Pattern:** "Return errors in result"
- **Issue:** Compile.ts doesn't check for returned errors!

**Pass 8 (Link Resolution):**
- Inherits errors from Pass 6
- Adds new errors to the list
- Returns them in result object (`LinkedGraphIR.errors`)
- **Pattern:** "Return errors in result"
- **Issue:** Compile.ts doesn't check for returned errors!

### 4.2 Compile.ts Error Handling

```typescript
try {
  // All passes here
  const typedPatch = pass2TypeGraph(normalized);  // Throws on error
  const timeResolvedPatch = pass3TimeTopology(typedPatch);  // WRONG SIGNATURE
  // ...
} catch (e) {
  // Only catches exceptions, not accumulated errors
  const errors = [{
    kind: 'CompileError',
    message: e.message
  }];
  return emitFailure(...);
}
```

**Issue:** Passes that return errors (5, 6, 8) aren't checked before proceeding!

---

## 5. BLOCKING ISSUES SUMMARY

| Issue | Severity | Impact | File |
|-------|----------|--------|------|
| pass3 wrong signature (expects 2 args, gets 1) | üî¥ CRITICAL | Pipeline stops | compile.ts:106 |
| pass3 accesses `.normalizedPatch` (doesn't exist) | üî¥ CRITICAL | Runtime error | pass3-time.ts:19 |
| pass4 accesses `.blockIndexMap` (should be `.blockIndex`) | üî¥ CRITICAL | Runtime error | pass4-depgraph.ts:67 |
| pass4 edge type mismatch (NormalizedEdge vs Edge) | üî¥ CRITICAL | Runtime error | pass4-depgraph.ts:82 |
| pass5 missing blocks parameter | üî¥ CRITICAL | Pipeline stops | compile.ts:112 |
| pass5 returned errors not checked | üü° MAJOR | Silent failures | compile.ts:112 |
| pass6 missing blocks/edges parameters | üî¥ CRITICAL | Pipeline stops | compile.ts:115 |
| pass6 returned errors not checked | üü° MAJOR | Silent failures | compile.ts:115 |
| pass7 function doesn't exist | üî¥ CRITICAL | Pipeline stops | compile.ts:118 |
| pass7-schedule.ts incomplete (no implementation) | üî¥ CRITICAL | Missing pass | pass7-schedule.ts |
| pass8 massive import gaps (20+ missing imports) | üî¥ CRITICAL | Won't compile | pass8-link-resolution.ts |
| pass8 returned errors not checked | üü° MAJOR | Silent failures | compile.ts:121 |
| convertLinkedIRToProgram stub | üü° MAJOR | No output | compile.ts:198 |

---

## 6. AMBIGUITIES & OPEN QUESTIONS

### 6.1 Data Flow Questions

**Q1: What should be the edge type throughout the pipeline?**
- Is NormalizedEdge (with block/port indices) the canonical form?
- Or should Pass 1 convert to Edge (with endpoint objects) immediately?
- Current code is inconsistent - some passes expect Edge, but receive NormalizedEdge

**RESOLVED**: User confirmed NormalizedEdge is canonical, passes should use indices

**Q2: Should errors be thrown or returned?**
- Passes 2, 4 throw errors
- Passes 5, 6, 8 return errors in results
- What's the architectural decision?

**RESOLVED**: User wants hybrid - collect all errors in pass, throw at end if any

**Q3: Pass 7 - What's the input/output?**
- Input: UnlinkedIRFragments (from Pass 6)
- Output: ScheduleIR (not visible in file)
- Current file only has type definitions, no implementation
- **Critical:** What does this pass actually DO?

**Q4: Pass 8 - Schedule vs LinkedGraph confusion**
- Compile.ts calls `pass8LinkResolution(scheduleIR)` (wrong type)
- Should be `pass8LinkResolution(unlinkedIR, blocks, edges)` (3 args)
- Current code is in wrong state

### 6.2 Design Questions

**Q5: Error Accumulation Strategy**
- Currently: Mix of throw and return patterns
- Should we standardize on returning `{kind:'ok'|'error', ...}`?
- Or standardize on throwing with accumulated error arrays?

**RESOLVED**: Throw with accumulated arrays (hybrid approach)

**Q6: Parameter Threading**
- Blocks and edges are passed separately through the pipeline
- NormalizedPatch has blocks but passes need to reconstruct edge connections
- Should these be stored in intermediate patch types?

**Q7: Backwards Compatibility**
- The test file expects specific error kinds (NoTimeRoot, MultipleTimeRoots)
- But Pass 3 doesn't validate multiple TimeRoot blocks
- Are these tests outdated or unimplemented?

---

## 7. FILES REQUIRING CHANGES

**Must Fix (Blocking):**
1. `src/compiler/compile.ts`
2. `src/compiler/passes-v2/pass3-time.ts`
3. `src/compiler/passes-v2/pass4-depgraph.ts`
4. `src/compiler/passes-v2/pass5-scc.ts`
5. `src/compiler/passes-v2/pass6-block-lowering.ts`
6. `src/compiler/passes-v2/pass7-schedule.ts`
7. `src/compiler/passes-v2/pass8-link-resolution.ts`
8. `src/compiler/passes-v2/index.ts`

---

## STATUS: CONTINUE WITH PLANNING

All critical ambiguities have been resolved through user input. Ready to proceed with implementation planning.
