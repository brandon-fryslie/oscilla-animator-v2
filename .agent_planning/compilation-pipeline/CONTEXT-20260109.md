# Implementation Context: Type Error Resolution

**For:** Write-only implementation agents
**Sprint:** 2026-01-09
**Topic:** Compilation Pipeline - P0 Type Errors

---

## Summary

Fix 8 type errors in 3 files to complete the IRProgram to CompiledProgramIR migration in the runtime integration layer.

---

## File Changes Required

### File 1: `/Users/bmf/code/oscilla-animator-v2/src/compiler/ir/builder.ts`

**Problem:** Line 421 - `stepToBlock` is `Map<number, BlockId>` but DebugIndexIR requires `ReadonlyMap<StepId, BlockId>`.

**Location:** Line 61
**Current:**
```typescript
private stepToBlock = new Map<number, BlockId>(); // StepId → BlockId
```

**Change to:**
```typescript
private stepToBlock = new Map<StepId, BlockId>(); // StepId → BlockId
```

**Also required:** Add import for `StepId` from `./program` (line 29 already has this import).

**Location:** Lines 289, 305, 322 - Where stepToBlock.set() is called
**Current:**
```typescript
this.stepToBlock.set(stepId, sourceBlock);
```

**Change to:**
```typescript
this.stepToBlock.set(stepId as unknown as StepId, sourceBlock);
```

**Why:** The `stepId` local variable is a `number` (from `this.steps.length`), but we need to store it as branded `StepId` to match the DebugIndexIR interface.

---

### File 2: `/Users/bmf/code/oscilla-animator-v2/src/runtime/RuntimeState.ts`

**Problem:** Lines 122, 214, 222 in ScheduleExecutor.ts use numeric offset as Map key, but Map is typed `Map<ValueSlot, unknown>`.

**Location:** Line 23
**Current:**
```typescript
objects: Map<ValueSlot, unknown>;
```

**Change to:**
```typescript
objects: Map<number, unknown>;
```

**Also required:** Remove the `ValueSlot` import from line 8 if it's no longer used. Check if `ValueSlot` is used elsewhere in the file first.

**Why:** `resolveSlotOffset()` returns a numeric offset within the object storage class, not a global ValueSlot. The f64 array already uses numeric indexing; objects Map should match.

---

### File 3: `/Users/bmf/code/oscilla-animator-v2/src/main.ts`

**Problem:** Lines 175 and 180 reference legacy IRProgram properties that don't exist on CompiledProgramIR.

**Location:** Lines 173-176
**Current:**
```typescript
const program = result.program;
log(
  `Compiled: ${program.signals.size} signals, ${program.fields.size} fields, ${program.steps.length} steps`,
);
```

**Change to:**
```typescript
const program = result.program;
const schedule = program.schedule as { steps: readonly unknown[] };
log(
  `Compiled: ${program.signalExprs.nodes.length} signals, ${program.fieldExprs.nodes.length} fields, ${schedule.steps.length} steps`,
);
```

**Location:** Line 180
**Current:**
```typescript
currentState = createRuntimeState(program.slotCount);
```

**Change to:**
```typescript
currentState = createRuntimeState(program.slotMeta.length);
```

**Why:** CompiledProgramIR uses:
- `signalExprs.nodes` (readonly array) instead of `signals` (Map)
- `fieldExprs.nodes` (readonly array) instead of `fields` (Map)
- `schedule.steps` instead of `steps` (schedule is typed as `unknown` so needs cast)
- `slotMeta.length` instead of `slotCount`

---

## Type Mappings Reference

| Legacy IRProgram | CompiledProgramIR |
|-----------------|-------------------|
| `program.signals` (Map) | `program.signalExprs.nodes` (readonly array) |
| `program.fields` (Map) | `program.fieldExprs.nodes` (readonly array) |
| `program.steps` (array) | `program.schedule.steps` (via cast) |
| `program.slotCount` (number) | `program.slotMeta.length` |
| `program.domains` (Map) | `program.schedule.domains` (via cast) |

---

## Verification Commands

After making changes, run:
```bash
npm run typecheck  # Should pass with 0 errors
npm run test       # Should pass all tests (68+)
npm run dev        # Should render animation in browser
```

---

## Do NOT Change

- Do not modify `ScheduleExecutor.ts` - errors 6-8 will resolve from RuntimeState.ts change
- Do not add new files
- Do not modify the compiler or block lowering
- Do not remove the `as any` cast on schedule in builder.ts line 440 (pre-existing, future work)
- Do not attempt to properly type ScheduleIR (future work)

---

## Key Files for Reference (Read-Only)

- `/Users/bmf/code/oscilla-animator-v2/src/compiler/ir/program.ts` - CompiledProgramIR schema (lines 52-76)
- `/Users/bmf/code/oscilla-animator-v2/src/compiler/ir/Indices.ts` - Branded type definitions (StepId line 19)
- `/Users/bmf/code/oscilla-animator-v2/src/runtime/ScheduleExecutor.ts` - Runtime consumer (lines 119-227)

---

## Error Resolution Matrix

| Error | File | Line | Root Cause | Fix Location |
|-------|------|------|------------|--------------|
| 1 | builder.ts | 421 | Map type mismatch | builder.ts:61, 289, 305, 322 |
| 2-4 | main.ts | 175 | Legacy property names | main.ts:174-176 |
| 5 | main.ts | 180 | slotCount doesn't exist | main.ts:180 |
| 6-8 | ScheduleExecutor.ts | 122,214,222 | ValueSlot vs number | RuntimeState.ts:23 |
