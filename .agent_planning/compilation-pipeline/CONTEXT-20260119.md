# Context: Compilation Pipeline Cleanup

**Date:** 2026-01-19
**Issue:** oscilla-animator-v2-k0v
**Epic:** Phase 1 Unified Plan (P3)
**Status:** Investigation Complete → Ready for Implementation

---

## TL;DR

The "Passes 5-10" in the beads issue is **a miscount**. There are only **8 compilation passes**, and **all are implemented and working**. The remaining work is minor cleanup:
- Remove 4 unused state API stubs
- Document Pass 8 decision (exists but not needed)
- Resolve seed management TODO

**Estimated effort:** 1.5 hours

---

## Current State

### What's Implemented ✅

**All 8 Compilation Passes:**
1. ✅ Pass 1: Normalization (`normalize.ts`)
2. ✅ Pass 2: Type Graph (`pass2-types.ts`)
3. ✅ Pass 3: Time Topology (`pass3-time.ts`)
4. ✅ Pass 4: Dependency Graph (`pass4-depgraph.ts`)
5. ✅ Pass 5: SCC Validation (`pass5-scc.ts`)
6. ✅ Pass 6: Block Lowering (`pass6-block-lowering.ts`)
7. ✅ Pass 7: Schedule Construction (`pass7-schedule.ts`)
8. ✅ Pass 8: Link Resolution (`pass8-link-resolution.ts` - exists but not used)

**Working State APIs:**
- ✅ `allocStateSlot()` - Line 486-490, fully functional
- ✅ `sigStateRead()` - Line 492-496, fully functional
- ✅ `stepStateWrite()` - Line 498-500, fully functional
- ✅ UnitDelay block uses all three APIs successfully
- ✅ Hash block uses state APIs successfully
- ✅ 12 stateful primitive tests passing

**Completed Sprints:**
- ✅ Domain Unification (2026-01-09)
- ✅ Graph Normalization Adapters (2026-01-12)
- ✅ Domain→Instance Migration (2026-01-19)

### Test Status

```
Test Files: 24 passed | 5 skipped (29)
Tests: 372 passing | 34 skipped (406)
Failures: 0
```

**Skipped tests:**
- 4 in `stateful-primitives.test.ts` (Id01 fragile value-finding)
- 30 in e2e tests (Playwright tests, not run in unit suite)

**Zero test failures!**

---

## What Remains

### Issue #1: Pass 8 Export Confusion

**Status:** Implemented but not exported/used

**Location:** `src/compiler/passes-v2/index.ts` line 40-41
```typescript
// TODO: Fix pass8LinkResolution exports
// export { pass8LinkResolution } from "./pass8-link-resolution";
```

**Investigation:**
- Pass 8 implementation exists (657 lines, fully implemented)
- BUT it's not needed because Pass 6 handles all input resolution
- `compile.ts` has comment: "Pass 8 is only needed for camera blocks with deferred lowering. Pass 6 handles standard input resolution"
- Camera blocks are lowered in Pass 6, not deferred

**Decision needed:**
- Keep Pass 8 as reference implementation (document why not used)
- OR remove Pass 8 entirely
- **Recommendation:** Keep with clear documentation

---

### Issue #2: Unused State API Stubs

**Status:** Old APIs, never used, causing confusion

**Location:** `src/compiler/ir/IRBuilderImpl.ts` lines 642-666

**Methods to remove:**
```typescript
getTimepointMarkers() { return null; }  // TODO stub
declareState() { /* empty */ }          // TODO stub
readState() { return this.sigConst(); } // TODO stub
writeState() { /* empty */ }            // TODO stub
```

**Why remove:**
- These were replaced by working state slot APIs
- Never called anywhere in codebase
- Cause confusion about "state API stubs pending primitives-catalog"
- UnitDelay and Hash blocks work without them

**Verification:**
```bash
grep -r "declareState\|readState\|writeState\|getTimepointMarkers" src/
```
Expected: No references found (except the definitions themselves)

---

### Issue #3: Seed Management TODO

**Status:** Minor TODO, needs resolution

**Location:** `src/compiler/passes-v2/pass6-block-lowering.ts` line 368
```typescript
// TODO: Proper seed management
seedConstId: 0,
```

**Options:**
1. Implement proper seed allocation (if needed)
2. Remove TODO if current approach is correct
3. Document why seed=0 is acceptable

**Investigation needed:**
- Check if seed value matters for correctness
- Look at how randomId intrinsic uses seed
- Determine if multiple instances need different seeds

---

### Issue #4: Beads Issue Description Mismatch

**Current description:**
> "Passes 5-10: execution class, tables, schedule, slots, debug. Note: State APIs in IRBuilderImpl (declareState, readState, writeState, getTimepointMarkers) are stubs pending primitives-catalog (UnitDelay)."

**Reality:**
- There are only 8 passes (not 10)
- State APIs are fully working (not stubs)
- UnitDelay is implemented and passing tests

**Action needed:**
- Update beads issue description to reflect actual state
- Close issue when cleanup complete

---

## Blockers

**None!** All work is independent cleanup.

---

## Architecture Context

### Compilation Pipeline Flow

```
RawGraph (user input)
  ↓
Pass 1: Normalization
  ↓ NormalizedGraph
Pass 2: Type Graph (type resolution)
  ↓ TypedPatch
Pass 3: Time Topology
  ↓ TimeResolvedPatch
Pass 4: Dependency Graph
  ↓ DepGraphWithTimeModel
Pass 5: SCC Validation (cycle check)
  ↓ AcyclicOrLegalGraph
Pass 6: Block Lowering
  ↓ UnlinkedIRFragments
Pass 7: Schedule Construction
  ↓ ScheduleIR
[Pass 8: Link Resolution] ← NOT USED
  ↓
Runtime Execution
```

### State Management Architecture

**Working State Slot System:**
```typescript
// 1. Allocate state slot
const stateSlot = builder.allocStateSlot(initialValue, type);

// 2. Read from state
const readExpr = builder.sigStateRead(stateSlot, type);

// 3. Write to state
builder.stepStateWrite(stateSlot, valueExpr);
```

**Used by:**
- UnitDelay: Stores previous value, reads on next frame
- Hash: Stores deterministic random state per element
- (Future) Lag, Phasor, SampleAndHold

**Old unused APIs:**
- declareState, readState, writeState, getTimepointMarkers
- Not used anywhere, can be removed

---

## Files Involved

### Primary Files (will modify):
1. `src/compiler/passes-v2/index.ts` - Document Pass 8 decision
2. `src/compiler/ir/IRBuilderImpl.ts` - Remove unused state APIs
3. `src/compiler/ir/IRBuilder.ts` - Remove interface declarations
4. `src/compiler/passes-v2/pass6-block-lowering.ts` - Resolve seed TODO
5. `src/compiler/passes-v2/pass8-link-resolution.ts` - Add header comment

### Reference Files (read only):
- `design-docs/CANONICAL-oscilla-v2.5-20260109/topics/04-compilation.md` - Spec
- `src/compiler/compile.ts` - Pipeline orchestration
- `src/blocks/state-blocks.ts` - UnitDelay, Hash implementations
- `src/compiler/__tests__/steel-thread.test.ts` - Integration test

---

## Related Work

### Completed Dependencies:
- ✅ Domain→Instance Migration (2026-01-19)
- ✅ Graph Normalization (2026-01-12)
- ✅ Type System (2026-01-09)
- ✅ IR 5-Axes (2026-01-09)

### Future Work (out of scope):
- Lag, Phasor, SampleAndHold blocks (primitives-catalog task)
- Hot-swap state preservation (Phase 2)
- Event system integration (Phase 3)
- Performance optimization (Phase 3)

---

## Success Criteria

**Definition of Complete:**
1. No unused/stub code in IRBuilder
2. Pass 8 status clearly documented
3. All TODOs in compilation passes resolved
4. All 372 tests still passing
5. Beads issue description accurate and closed

**Not Required:**
- New features
- Performance improvements
- Additional tests (already comprehensive)
- Spec updates (spec is accurate)

---

## References

- **Beads Issue:** oscilla-animator-v2-k0v
- **Spec:** `design-docs/CANONICAL-oscilla-v2.5-20260109/topics/04-compilation.md`
- **Roadmap:** `.agent_planning/ROADMAP.md` line 74-84
- **Old Plan:** `.agent_planning/phase1-remaining/PLAN-20260109-210000.md` (STALE)
