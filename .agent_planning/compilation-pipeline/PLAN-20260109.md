# Sprint Plan: Compilation Pipeline - Next Phase

**Created:** 2026-01-09
**Topic:** Compilation Pipeline
**Current Status:** P0 type errors resolved, build green, 68 tests passing

---

## Context

**Previous Sprint Completed:**
The P0 type errors (IRBuilder brand types, main.ts property access, ScheduleExecutor ValueSlot types) have already been resolved:
- `npm run typecheck` passes with 0 errors
- `npm run test` passes all 68 tests
- Application builds and runs

**Current State:**
- Compiler produces `CompiledProgramIR` correctly
- Runtime integration complete (main.ts, ScheduleExecutor.ts work)
- Linear pipeline functional: normalize → typecheck → depgraph → lower → build

**Remaining Gaps (from Evaluation):**
The compilation pipeline is ~54% spec-compliant. Major gaps:
1. Multi-pass architecture incomplete (passes-v2/ excluded from build)
2. No graph normalization (default sources, buses, lenses)
3. ScheduleIR still abstract (`unknown`)
4. Combine semantics unimplemented
5. Domain unification missing

---

## Sprint Goal

Define the next phase of work for the compilation pipeline. Choose one focus area from the P1 priorities.

---

## P1 Priority Options

### Option A: Graph Normalization (Recommended)

**Goal:** Implement the normalization pass that materializes implicit structure.

**Scope:**
- Default source materialization
- Bus/rail expansion
- Canonical type assignment
- Lens application hooks

**Value:** Enables complex graph patterns from spec, unblocks advanced use cases.

**Risk:** Medium - requires spec clarification on some edge cases.

---

### Option B: ScheduleIR Definition

**Goal:** Define proper ScheduleIR type instead of `unknown`.

**Scope:**
- Define ScheduleIR interface in program.ts
- Move step/domain typing into ScheduleIR
- Remove `schedule as any` cast in builder.ts
- Update runtime to use typed ScheduleIR

**Value:** Type safety, cleaner API, enables schedule optimization.

**Risk:** Low - mostly type refactoring.

---

### Option C: Multi-Pass Architecture

**Goal:** Integrate passes-v2 or refactor to explicit staged pipeline.

**Scope:**
- Evaluate passes-v2 code (currently excluded)
- Decide: complete or replace
- Implement explicit stage functions with typed I/O
- Add pass-level testing

**Value:** Better modularity, easier debugging, spec compliance.

**Risk:** High - significant refactoring, may break things.

---

### Option D: Domain Unification

**Goal:** Implement domain compatibility checking for fields.

**Scope:**
- Domain compatibility rules
- Field broadcast domain propagation
- Cross-domain connection validation
- Domain conflict errors

**Value:** Catches domain mismatches at compile time.

**Risk:** Low-Medium - well-scoped, spec has clear rules.

---

## Recommendation

**Start with Option B (ScheduleIR Definition)** because:
1. Low risk - no architectural changes
2. Immediate type safety benefit
3. Removes technical debt (`unknown` type, `as any` cast)
4. Enables future schedule optimization work
5. Self-contained, can be completed in one sprint

After Option B, proceed to Option A (Graph Normalization) which is higher value but requires more investigation.

---

## Next Steps

To proceed with implementation:
1. User approves focus area (A, B, C, or D)
2. Create detailed sprint plan for chosen option
3. Implement with `/do:it`

---

## Files Reference

**Compiler core:**
- `src/compiler/compile.ts` - Main entry point
- `src/compiler/ir/builder.ts` - IR construction
- `src/compiler/ir/program.ts` - Schema definitions

**Passes (current):**
- `src/compiler/passes/TypeChecker.ts` - Type validation

**Passes (excluded):**
- `src/compiler/passes-v2/*.ts` - Incomplete multi-pass code

**Runtime integration:**
- `src/main.ts` - Application entry
- `src/runtime/ScheduleExecutor.ts` - IR execution
