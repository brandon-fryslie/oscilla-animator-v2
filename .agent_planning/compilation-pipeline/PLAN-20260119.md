# Implementation Plan: Compilation Pipeline Cleanup

**Date:** 2026-01-19
**Issue:** oscilla-animator-v2-k0v
**Status:** READY FOR IMPLEMENTATION
**Estimated Effort:** 1.5 hours

---

## Sprint Goal

Clean up compilation pipeline code by removing unused state API stubs, documenting Pass 8 decision, and resolving remaining TODOs. All 8 passes are implemented and working; this is code hygiene only.

---

## Task Breakdown

### Task 1: Document Pass 8 Decision (30 minutes)

**Rationale:**
Pass 8 (Link Resolution) exists and is fully implemented, but it's not used because Pass 6's `resolveInputsWithMultiInput` handles all connection resolution. Camera blocks are lowered in Pass 6, not deferred to Pass 8.

#### Step 1.1: Update Pass Index Export Comment

**File:** `src/compiler/passes-v2/index.ts`
**Lines:** 39-41

**Current code:**
```typescript
// Pass 8: Link Resolution
// TODO: Fix pass8LinkResolution exports
// export { pass8LinkResolution } from "./pass8-link-resolution";
```

**Change to:**
```typescript
// Pass 8: Link Resolution
// Note: Pass 8 is fully implemented but not currently used.
// Pass 6's resolveInputsWithMultiInput handles all input resolution.
// Camera blocks are lowered in Pass 6 (not deferred to Pass 8).
// Keeping this implementation as reference for potential future use.
//
// If needed in future, uncomment:
// export { pass8LinkResolution } from "./pass8-link-resolution";
```

#### Step 1.2: Add Header Comment to Pass 8

**File:** `src/compiler/passes-v2/pass8-link-resolution.ts`
**Location:** Top of file (line 1-20)

**Add after existing header:**
```typescript
/**
 * Pass 8: Link Resolution
 *
 * Resolves all ValueRefs to concrete node IDs and creates BlockInputRootIR
 * and BlockOutputRootIR tables.
 *
 * STATUS: Fully implemented but not currently used in compilation pipeline.
 *
 * RATIONALE:
 * - Pass 6's resolveInputsWithMultiInput handles all standard input resolution
 * - Camera blocks are lowered in Pass 6, not deferred to Pass 8
 * - No blocks currently require deferred link resolution
 *
 * FUTURE USE:
 * - May be needed if we add blocks that require post-schedule link resolution
 * - Useful reference implementation for advanced resolution strategies
 *
 * HISTORY:
 * - Workstream 04 (2026-01-03): Split camera lowering to Pass 6
 * - Phase 0.5 Sprint 4 (2026-01-03): Removed unused _wires parameter
 */
```

#### Verification:
- No functional changes
- TypeScript compiles cleanly
- All tests pass

---

### Task 2: Remove Unused State API Stubs (45 minutes)

**Rationale:**
Four methods in IRBuilderImpl are stubs that were replaced by working state slot APIs (`allocStateSlot`, `sigStateRead`, `stepStateWrite`). They're never called and cause confusion.

#### Step 2.1: Verify No Usage

**Command:**
```bash
grep -r "declareState\|readState\|writeState\|getTimepointMarkers" src/ --exclude-dir=node_modules
```

**Expected result:** Only definitions in IRBuilder.ts and IRBuilderImpl.ts

**If unexpected:** Stop and investigate usage before removing!

#### Step 2.2: Remove from IRBuilder Interface

**File:** `src/compiler/ir/IRBuilder.ts`

**Find and remove these method signatures:**
```typescript
declareState(...): ...;
readState(...): ...;
writeState(...): ...;
getTimepointMarkers(...): ...;
```

**Notes:**
- These should be near other state-related methods
- Keep `allocStateSlot`, `sigStateRead`, `stepStateWrite` (they work!)

#### Step 2.3: Remove from IRBuilderImpl

**File:** `src/compiler/ir/IRBuilderImpl.ts`
**Lines:** Approximately 642-666

**Remove these implementations:**
```typescript
public getTimepointMarkers(...): ... {
  return null; // TODO: ...
}

public declareState(...): ... {
  // TODO stub
}

public readState(...): ... {
  return this.sigConst(...); // TODO stub
}

public writeState(...): ... {
  // TODO stub
}
```

#### Step 2.4: Run Tests

**Command:**
```bash
npm run typecheck
npm test
```

**Expected:**
- TypeScript: 0 errors
- Tests: 372 passing, 4 skipped, 0 failures

**If tests fail:** Revert changes and investigate!

#### Verification:
- No references to removed methods in codebase
- All tests still pass
- UnitDelay and Hash blocks still work

---

### Task 3: Resolve Seed Management TODO (15 minutes)

**Rationale:**
Minor TODO at line 368 of pass6-block-lowering.ts needs resolution.

#### Step 3.1: Investigate Seed Usage

**File:** `src/compiler/passes-v2/pass6-block-lowering.ts`
**Line:** 368

**Current code:**
```typescript
// TODO: Proper seed management
seedConstId: 0,
```

**Questions to answer:**
1. How is `seedConstId` used?
2. Does randomId intrinsic depend on seed value?
3. Do multiple instances need different seeds?
4. Is seed=0 acceptable for all cases?

**Check files:**
- `src/runtime/Materializer.ts` - How randomId uses seed
- `src/blocks/array-blocks.ts` - How Array block provides randomId

#### Step 3.2: Take Action

**Option A: If seed=0 is correct**
```typescript
// Seed value 0 is used for all randomId intrinsic calculations.
// Per-element randomness is deterministic based on element index,
// so a single seed value is sufficient for reproducible output.
seedConstId: 0,
```

**Option B: If proper allocation needed**
```typescript
// Allocate unique seed for each instance to ensure
// independent random sequences across instances
const seedExpr = this.sigConst(instance.count, INT_TYPE);
seedConstId: seedExpr,
```

**Option C: If out of scope**
```typescript
// TODO: Proper seed management (tracked in primitives-catalog)
// Current: Single seed=0 for all instances (sufficient for MVP)
seedConstId: 0,
```

#### Verification:
- Array block tests still pass (esp. randomId tests)
- No regression in deterministic output
- Documentation clear about choice

---

### Task 4: Update Beads Issue (10 minutes)

**Rationale:**
Beads issue description doesn't match reality. Update to reflect actual state.

#### Step 4.1: Edit Issue Description

**Command:**
```bash
bd update oscilla-animator-v2-k0v --json
```

**Current description:**
> Passes 5-10: execution class, tables, schedule, slots, debug. Note: State APIs in IRBuilderImpl (declareState, readState, writeState, getTimepointMarkers) are stubs pending primitives-catalog (UnitDelay).

**New description:**
```
Compilation Pipeline Cleanup

Clean up code after successful implementation of all 8 compilation passes:
- Remove unused state API stubs (declareState, readState, writeState, getTimepointMarkers)
- Document Pass 8 decision (implemented but not used)
- Resolve seed management TODO in Pass 6

All 8 passes implemented and working:
✅ Pass 1: Normalization
✅ Pass 2: Type Graph
✅ Pass 3: Time Topology
✅ Pass 4: Dependency Graph
✅ Pass 5: SCC Validation
✅ Pass 6: Block Lowering
✅ Pass 7: Schedule Construction
✅ Pass 8: Link Resolution (reference implementation)

Working state APIs: allocStateSlot(), sigStateRead(), stepStateWrite()
Test status: 372 passing, 0 failures

**Note:** "Passes 5-10" was a miscount. There are 8 passes total.
```

#### Step 4.2: Close Issue (after tasks complete)

**Command:**
```bash
bd close oscilla-animator-v2-k0v --reason "Compilation pipeline cleanup complete. Removed unused state API stubs, documented Pass 8 decision, resolved seed management TODO. All 8 passes working, 372 tests passing." --json
```

---

## Implementation Sequence

```
Phase 1: Investigation (0 hours - already done by Plan agent)
└── Verified current state, identified cleanup tasks

Phase 2: Documentation (30 min)
├── Update Pass 8 export comment (10 min)
└── Add Pass 8 header comment (20 min)

Phase 3: Code Cleanup (45 min)
├── Verify no usage of old APIs (5 min)
├── Remove from IRBuilder interface (10 min)
├── Remove from IRBuilderImpl (10 min)
├── Run tests (5 min)
└── Commit (15 min)

Phase 4: TODO Resolution (15 min)
├── Investigate seed usage (5 min)
├── Update code and comments (5 min)
└── Verify tests pass (5 min)

Phase 5: Issue Update (10 min)
└── Update and close beads issue

Total: 1.5 hours
```

---

## Verification Checklist

After each task:
- [ ] TypeScript compiles (`npm run typecheck`)
- [ ] All tests pass (`npm test`)
- [ ] No console warnings
- [ ] Git diff shows only intended changes

Final verification:
- [ ] 372 tests passing (same as before)
- [ ] 0 test failures
- [ ] No new TODOs introduced
- [ ] Clean commit message
- [ ] Beads issue updated

---

## Rollback Plan

If something breaks:
1. `git diff` to see what changed
2. `git checkout <file>` to revert specific file
3. Re-run tests to verify rollback
4. Investigate why change caused issue
5. Try alternative approach

---

## Commit Strategy

**Task 1 commit:**
```
docs(compiler): Document Pass 8 status and decision

Pass 8 (Link Resolution) is fully implemented but not currently
used because Pass 6 handles all input resolution. Keeping as
reference implementation for potential future use.

- Update index.ts export comment with explanation
- Add detailed header comment to pass8-link-resolution.ts
```

**Task 2 commit:**
```
refactor(compiler): Remove unused state API stubs

Remove declareState, readState, writeState, and getTimepointMarkers
from IRBuilder and IRBuilderImpl. These were old APIs replaced by
the working state slot system (allocStateSlot, sigStateRead, stepStateWrite).

Verification: All 372 tests passing, UnitDelay and Hash blocks working.
```

**Task 3 commit:**
```
fix(compiler): Resolve seed management TODO in Pass 6

[Option A] Seed=0 is correct for all cases (document why)
[Option B] Implement proper seed allocation (explain approach)
[Option C] Document as out of scope for MVP
```

---

## Risk Mitigation

**Risk:** Removing "stub" APIs breaks something unexpectedly
**Mitigation:** Grep verification + run full test suite before committing

**Risk:** Pass 8 might actually be needed
**Mitigation:** Keeping implementation, just documenting why not used

**Risk:** Seed change breaks determinism
**Mitigation:** Run randomId tests, check output consistency

---

## Success Metrics

**Code Quality:**
- No unused/dead code in IRBuilder
- All TODOs resolved or documented
- Clear comments explaining architectural decisions

**Testing:**
- All 372 tests passing
- No new test failures
- No test regressions

**Documentation:**
- Pass 8 decision clearly explained
- State API architecture documented
- Beads issue reflects reality

---

## Next Steps After Completion

1. Mark compilation-pipeline as COMPLETED in roadmap
2. Move to next Phase 1 task (type-system, time-model, etc.)
3. Consider if primitives-catalog (Lag, Phasor, SampleAndHold) should be next

---

## References

- **Context:** `.agent_planning/compilation-pipeline/CONTEXT-20260119.md`
- **DOD:** `.agent_planning/compilation-pipeline/DOD-20260119.md`
- **Spec:** `design-docs/CANONICAL-oscilla-v2.5-20260109/topics/04-compilation.md`
- **Beads:** oscilla-animator-v2-k0v
