# Recap: Units and Type Inference Work

Generated: 2026-01-24T18:50:00Z

## Current Task: Units and Type Inference Refactor

**Status**: Partially complete. The core architectural fix is done but revealed a pre-existing issue.

### Completed

1. ✅ Removed unit inference from `pass0-payload-resolution.ts` (pass0 now only resolves payload, not unit)
2. ✅ Updated `pass1-type-constraints.ts` to use per-block-instance unit variables (fixes the shared `unitVar('const_out')` conflict)
3. ✅ Fixed exhaustive switch in `typeValidation.ts` for `unit.kind === 'var'`

### Remaining

- The unit conflict errors are fixed (down from 16 to ~6 failures)
- But we exposed a **pre-existing issue**: `pass2-adapters.ts` is NOT inserting `FieldBroadcast` adapters when a Signal (one) connects to a Field (many) input
- This causes cardinality mismatch: `one+continuous<float, unit:scalar> to many+continuous<float, unit:scalar>`

---

## Larger Goal: Camera Block Implementation

**Status**: The camera system is already fully implemented per spec. The "hardcoded bullshit" the user mentioned turned out to be the broken test state from in-progress type system changes, not architectural violations.

### Remaining

- Fix the adapter insertion issue (FieldBroadcast not being created)
- Get all 86 test files passing

---

## Deferred Work Discovered

1. **RenderAssembler buffer type mismatch** (2 tests): `fillColor` is `Float32Array`, tests expect `Uint8ClampedArray` - unrelated to unit inference
2. **Connection validation tests** (2 tests): Testing that Const can connect to concrete types and that Signal→Field gets adapter - depends on adapter fix
3. **TimeRoot validation tests** (2 tests): `rejects a patch with no TimeRoot` - may be a separate issue

---

## Architectural/System Problems Identified

### 1. Shared Unit Variable IDs (FIXED)

All Const blocks shared `unitVar('const_out')`, causing constraint solver conflicts when different Const blocks needed different units.

**Fix**: Creating per-instance variables in `pass1-type-constraints.ts` using the port key as the variable ID.

### 2. Redundant Inference Passes (FIXED)

Pass0 was doing ad-hoc unit inference, pass1 was doing constraint solving - they didn't coordinate.

**Fix**: Made pass1 the single source of truth for unit resolution. Pass0 now only handles payload type inference.

### 3. Adapter Pass Not Inserting FieldBroadcast (BLOCKING)

`pass2-adapters.ts` in graph passes should automatically insert `FieldBroadcast` when connecting Signal→Field, but it's not doing so. This is why steel-thread and other tests fail with cardinality mismatch.

**Evidence**: Debug test showed `Const.out -> FieldHueFromPhase.phase` connection remains direct with no adapter inserted.

**Impact**: This appears to be a pre-existing bug that was masked before, now exposed by the type system fixes.

### 4. Git State

The git stash was interrupted. Changes are currently stashed. Need to `git stash pop` to restore work.

---

## Files Modified

| File | Change |
|------|--------|
| `src/graph/passes/pass0-payload-resolution.ts` | Removed unit inference (only payload now) |
| `src/compiler/passes-v2/pass1-type-constraints.ts` | Per-instance unit variables |
| `src/ui/reactFlowEditor/typeValidation.ts` | Handle `unit.kind === 'var'` in switch |
| `src/projection/__tests__/level10-golden-tests.test.ts` | Added missing type imports |

---

## Next Steps

1. `git stash pop` to restore changes
2. Investigate why `pass2-adapters.ts` is not inserting FieldBroadcast
3. Fix adapter insertion
4. Verify all tests pass
