Agent: iterative-implementer | 2026-01-11 15:17:50
Mode: tdd
Completed: Registered 5 missing block types | Files: 8 | Commits: 1
Tests: 9 passing, 2 failing
Cache invalidated: None (no cache entries related to modified files)
Status: in_progress

## Work Completed

### Block Registrations
1. **ConstFloat** - Constant float signal block
   - BlockDef registration in src/blocks/registry.ts
   - IR lowering function using ctx.b.sigConst()
   - Test: PASSING

2. **Oscillator** - Waveform generator block
   - BlockDef with phase input and out output
   - IR lowering using ctx.b.sigCall()
   - Test: FAILING (input resolution issue)

3. **GridDomain** - 2D grid domain block
   - BlockDef with rows/cols params
   - Uses ctx.b.createDomain('grid', ...)
   - Test: PASSING

4. **DomainN** - 1D N-element domain block
   - BlockDef with n and seed params
   - Uses ctx.b.createDomain('n', ...)
   - Test: PASSING

5. **FieldBroadcast** - Signal-to-field broadcast block
   - BlockDef with signal input, field output
   - IR lowering using ctx.b.fieldBroadcast()
   - Test: FAILING (depends on Oscillator wiring)

### Compiler Fixes
1. **Pass6 validation**: Fixed to allow blocks with zero outputs (domain blocks)
2. **Pass6 error kinds**: Changed "NotImplemented" to "UnknownBlockType" for missing block types
3. **Pass7 schedule**: Added domains retrieval from IRBuilder via getDomains()
4. **Compile imports**: Added imports for signal-blocks, domain-blocks, field-blocks

## Test Results

### Passing (9/11)
- compile > TimeRoot validation > fails if no TimeRoot block
- compile > TimeRoot validation > fails if multiple TimeRoot blocks
- compile > TimeRoot validation > succeeds with exactly one TimeRoot
- compile > signal compilation > compiles constant signals
- compile > domain compilation > compiles grid domain
- compile > domain compilation > compiles domain N
- compile > error handling > reports unknown block types
- TimeModel > InfiniteTimeRoot sets infinite time model
- TimeModel > FiniteTimeRoot sets finite time model with duration

### Failing (2/11)
- compile > signal compilation > compiles connected signal blocks
  Error: "No writers for required input b1.phase"
  Issue: Multi-input resolution not finding wire from InfiniteTimeRoot.phaseA to Oscillator.phase

- compile > field compilation > broadcasts signal to field
  Error: Same as above (depends on Oscillator working)
  Issue: Cascading failure from Oscillator input resolution

## Remaining Work

### P0: Fix Oscillator Input Resolution
The test creates a wire: `b.wire(time, 'phaseA', osc, 'phase')`
But resolveBlockInputs() in pass6 reports "No writers for required input b1.phase"

Possible causes:
1. Edge not being normalized correctly
2. BlockDef input ID mismatch (though 'phase' is correctly registered)
3. Block processing order issue (though TimeRoot should be processed first)
4. resolveWriters not finding the wire edge

Investigation needed:
- Verify edge structure in normalized patch
- Check if blockOutputs has InfiniteTimeRoot outputs when Oscillator is processed
- Debug resolveBlockInputs to see why it's not finding the writer

### P1: Complete Pass7 Implementation
Current stub returns empty steps array. Needs:
- Topological ordering of execution steps
- State slot counting
- Phase grouping

## Files Modified
- src/blocks/signal-blocks.ts (NEW)
- src/blocks/domain-blocks.ts (NEW)
- src/blocks/field-blocks.ts (NEW)
- src/compiler/compile.ts
- src/compiler/passes-v2/pass6-block-lowering.ts
- src/compiler/passes-v2/pass7-schedule.ts
- src/compiler/__tests__/compile.test.ts

## Architecture Notes

### Block Registration Pattern
Blocks require TWO registrations:
1. BlockDef via registerBlock() - for editor/UI
2. BlockTypeDecl via registerBlockType() - for IR lowering

The lower function signature:
```typescript
lower: ({ ctx, inputs, inputsById, config }) => LowerResult
```

Where:
- ctx: LowerCtx with builder (ctx.b) and metadata
- inputs: ValueRefPacked[] in port order
- inputsById: Record<string, ValueRefPacked> by port ID
- config: Block params (from block.params)

### Domain Blocks Pattern
Domain blocks have zero outputs but register domains via:
```typescript
ctx.b.createDomain(kind, count, params)
```

Domains are retrieved in pass7 via:
```typescript
unlinkedIR.builder.getDomains()
```

## Next Steps
1. Debug Oscillator input resolution issue
2. Add detailed logging to resolveBlockInputs
3. Verify edge normalization preserves port IDs correctly
4. Consider if BlockDef/BlockTypeDecl port ID mismatch exists
