# Sprint Plan: patch-editor-ui

**Date:** 2026-01-12
**Topic:** patch-editor-ui
**Sprint Duration:** Estimated 4-6 hours implementation time
**Reference:** EVALUATION-20260112-180000.md

---

## Sprint Goal

Implement patch editing capabilities: add blocks via Library, delete blocks via context menu, edit parameters in Inspector, with full undo/redo support.

---

## Scope

**In scope (this sprint):**
1. Command pattern infrastructure with undo/redo
2. Add block via Library double-click
3. Delete block via context menu
4. Parameter editing in BlockInspector
5. Undo/Redo toolbar buttons + keyboard shortcuts

**Explicitly out of scope (future sprints):**
- Canvas graph editor (Phase 3 per spec)
- Type validation on edges (after type-system complete)
- Drag-and-drop (spec explicitly forbids)
- Custom parameter widgets (sliders, color pickers)
- Batch undo (compound commands)
- Edge creation/deletion (P1)

---

## Work Items

### P0: Command Infrastructure

**Goal:** Create the foundational command pattern for undo/redo support.

**Acceptance Criteria:**
- [ ] `Command` interface defined with `execute()`, `undo()`, `description`
- [ ] `CommandStore` created with observable `history`, `historyIndex`
- [ ] `execute(cmd)` adds to history and calls `cmd.execute()`
- [ ] `undo()` calls current command's `undo()` and decrements index
- [ ] `redo()` increments index and calls command's `execute()`
- [ ] `canUndo`/`canRedo` computed getters work correctly
- [ ] CommandStore integrated into RootStore

**Technical Notes:**
- Create `src/commands/types.ts` for Command interface
- Create `src/stores/CommandStore.ts` as MobX store
- Follow existing store patterns (observable, action decorators)
- History capped at 100 commands to prevent memory issues

**Files:**
- `src/commands/types.ts` (new)
- `src/stores/CommandStore.ts` (new)
- `src/stores/RootStore.ts` (modify)
- `src/stores/index.ts` (modify)

---

### P1: Add Block Command

**Goal:** Wire BlockLibrary double-click to create new blocks with undo support.

**Acceptance Criteria:**
- [ ] Double-clicking a block type in BlockLibrary creates a new block
- [ ] New block appears in TableView immediately
- [ ] New block uses correct type and default params from registry
- [ ] Undo removes the added block
- [ ] Redo re-adds the block

**Technical Notes:**
- Create `AddBlockCommand` that wraps `PatchStore.addBlock()`
- Store created blockId for undo
- Wire to existing `handleBlockDoubleClick` at BlockLibrary.tsx:111-114

**Files:**
- `src/commands/AddBlockCommand.ts` (new)
- `src/ui/components/BlockLibrary.tsx` (modify line 111-114)

---

### P2: Delete Block Command

**Goal:** Enable block deletion via context menu with full undo support.

**Acceptance Criteria:**
- [ ] Right-clicking a block row in TableView shows context menu
- [ ] Context menu includes "Delete" option
- [ ] Clicking "Delete" removes the block from the patch
- [ ] All edges connected to the deleted block are also removed
- [ ] Undo restores the block AND all connected edges
- [ ] Redo re-deletes the block and edges

**Technical Notes:**
- Create `RemoveBlockCommand` that captures block + edges before deletion
- Add `restoreBlock()` and `restoreEdge()` methods to PatchStore for undo
- Use MUI Menu component for context menu
- Clear selection if deleting selected block

**Files:**
- `src/commands/RemoveBlockCommand.ts` (new)
- `src/stores/PatchStore.ts` (add restore methods)
- `src/ui/components/TableView.tsx` (add context menu)

---

### P3: Parameter Editing

**Goal:** Enable editing block parameters directly in the Inspector.

**Acceptance Criteria:**
- [ ] BlockInspector shows editable inputs for block parameters
- [ ] Changing a parameter value updates the block in PatchStore
- [ ] Changes applied on blur or Enter key
- [ ] Undo reverts parameter to previous value
- [ ] Redo re-applies the parameter change
- [ ] Number parameters parse correctly from string input
- [ ] Invalid input shows error state (does not crash)

**Technical Notes:**
- Create `UpdateParamsCommand` storing old/new param values
- Replace read-only JSON display with form inputs
- For MVP: basic text inputs, parse numbers/booleans from strings
- Use block registry's InputDef for field metadata

**Files:**
- `src/commands/UpdateParamsCommand.ts` (new)
- `src/ui/components/BlockInspector.tsx` (major modification)

---

### P4: Undo/Redo UI

**Goal:** Provide visible undo/redo controls in toolbar and keyboard shortcuts.

**Acceptance Criteria:**
- [ ] Toolbar displays Undo button (↶) and Redo button (↷)
- [ ] Buttons disabled when canUndo/canRedo is false
- [ ] Clicking buttons executes undo/redo operation
- [ ] Ctrl+Z (Cmd+Z on Mac) triggers undo
- [ ] Ctrl+Shift+Z (Cmd+Shift+Z on Mac) triggers redo
- [ ] Ctrl+Y triggers redo (Windows alternative)

**Technical Notes:**
- Make Toolbar an observer to react to CommandStore state
- Add global keydown listener in App.tsx
- Prevent shortcuts from interfering with text input fields

**Files:**
- `src/ui/components/app/Toolbar.tsx` (modify)
- `src/ui/components/app/App.tsx` (add keyboard handler)

---

## Dependencies

### Internal
- PatchStore mutation methods (exist)
- SelectionStore (exists)
- Block registry for type info (exists)
- MUI components (already installed)

### External
- None required

---

## Risks

| Risk | Likelihood | Impact | Mitigation |
|------|------------|--------|------------|
| Block ID collision on restore | Medium | High | Implement restoreBlock to use existing ID |
| Edge restoration order | Low | Medium | Restore block first, then edges |
| Parameter parsing errors | Medium | Low | Try-catch with error display |
| Keyboard shortcut conflicts | Low | Low | Check activeElement before handling |

---

## Verification

### Automated
- [ ] TypeScript compiles without errors
- [ ] All existing tests pass
- [ ] New tests added for CommandStore and Commands

### Manual Runtime
- [ ] Add block via double-click works
- [ ] Delete block via context menu works
- [ ] Parameter editing works
- [ ] Undo/redo buttons enable/disable correctly
- [ ] Keyboard shortcuts work
- [ ] No console errors
