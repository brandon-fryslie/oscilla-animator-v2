# Definition of Done: patch-editor-ui

**Date:** 2026-01-12
**Topic:** patch-editor-ui
**Plan:** PLAN-20260112-180000.md

---

## Acceptance Criteria

### P0: Command Infrastructure

- [ ] `Command` interface defined with `execute()`, `undo()`, `description`
- [ ] `CommandStore` created with observable `history`, `historyIndex`
- [ ] `CommandStore.execute(cmd)` adds to history and calls `cmd.execute()`
- [ ] `CommandStore.undo()` calls current command's `undo()` and decrements index
- [ ] `CommandStore.redo()` increments index and calls command's `execute()`
- [ ] `canUndo` returns true when historyIndex >= 0
- [ ] `canRedo` returns true when historyIndex < history.length - 1
- [ ] CommandStore integrated into RootStore

### P1: Add Block

- [ ] Double-clicking a block type in BlockLibrary creates a new block
- [ ] New block appears in TableView immediately
- [ ] New block uses correct type from registry
- [ ] Undo removes the added block
- [ ] Redo re-adds the block

### P2: Delete Block

- [ ] Right-clicking a block row in TableView shows context menu
- [ ] Context menu includes "Delete" option
- [ ] Clicking "Delete" removes the block from the patch
- [ ] All edges connected to the deleted block are also removed
- [ ] Undo restores the block AND all its connected edges
- [ ] Redo re-deletes the block and edges

### P3: Parameter Editing

- [ ] BlockInspector shows editable inputs for block parameters (when block selected)
- [ ] Changing a parameter value updates the block in PatchStore
- [ ] Changes are applied on blur or Enter key
- [ ] Undo reverts parameter to previous value
- [ ] Redo re-applies the parameter change
- [ ] Number parameters parse correctly from string input
- [ ] Invalid input shows error state (does not crash)

### P4: Undo/Redo UI

- [ ] Toolbar displays Undo button with ↶ icon
- [ ] Toolbar displays Redo button with ↷ icon
- [ ] Undo button disabled when canUndo is false
- [ ] Redo button disabled when canRedo is false
- [ ] Clicking Undo executes undo operation
- [ ] Clicking Redo executes redo operation
- [ ] Ctrl+Z (Cmd+Z on Mac) triggers undo
- [ ] Ctrl+Shift+Z (Cmd+Shift+Z on Mac) triggers redo
- [ ] Ctrl+Y triggers redo (Windows alternative)

### System Integrity

- [ ] All mutations still go through PatchStore actions
- [ ] GraphCommitted events fire on each mutation
- [ ] Diagnostics update after mutations
- [ ] No console errors during normal operation
- [ ] All existing tests pass
- [ ] New tests added for CommandStore and Commands (minimum 5 tests)

---

## Verification Checklist

### Manual Testing

1. **Add Block Flow**
   - [ ] Open application
   - [ ] Find a block type in BlockLibrary
   - [ ] Double-click the block type
   - [ ] Verify block appears in TableView
   - [ ] Verify Undo button becomes enabled
   - [ ] Click Undo - verify block is removed
   - [ ] Click Redo - verify block reappears

2. **Delete Block Flow**
   - [ ] Select a block in TableView
   - [ ] Right-click the block row
   - [ ] Verify context menu appears with "Delete"
   - [ ] Click Delete - verify block removed
   - [ ] Click Undo - verify block restored
   - [ ] Verify all edges restored too

3. **Parameter Edit Flow**
   - [ ] Select a block with editable parameters
   - [ ] In BlockInspector, edit a parameter value
   - [ ] Press Enter or click away
   - [ ] Verify value persists
   - [ ] Click Undo - verify parameter reverts

4. **Keyboard Shortcuts**
   - [ ] Press Ctrl+Z - verify undo works
   - [ ] Press Ctrl+Shift+Z - verify redo works
   - [ ] Verify shortcuts don't interfere with text input

5. **Edge Cases**
   - [ ] Delete block with multiple connected edges
   - [ ] Undo block delete - verify all edges restored
   - [ ] Multiple undos in sequence
   - [ ] New action after undo clears redo stack

### Automated Testing

- [ ] `npm run test` passes all tests
- [ ] `npm run typecheck` passes with no errors
- [ ] `npm run build` completes successfully
