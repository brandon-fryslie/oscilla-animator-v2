# Definition of Done: patch-editor-ui (Rete.js Integration)

**Date:** 2026-01-12 19:00
**Topic:** patch-editor-ui
**Plan:** PLAN-20260112-190000.md

---

## Acceptance Criteria

### P0: Rete.js Setup & Basic Rendering

- [ ] Rete packages installed: rete, rete-react-plugin, rete-area-plugin, rete-connection-plugin
- [ ] ReteEditor component exists at `src/ui/editor/ReteEditor.tsx`
- [ ] "Editor" tab added to center panel tabs (alongside Blocks/Matrix/Preview)
- [ ] Editor renders with grid/background
- [ ] Pan works (drag on background)
- [ ] Zoom works (mouse scroll)
- [ ] No console errors on load

### P1: Socket Type System

- [ ] OscillaSocket class defined with `isCompatibleWith()` method
- [ ] Socket instances exist for: signal_float, signal_int, signal_phase, field_float, field_int, field_vec2, domain
- [ ] Signal → Signal (same payload): COMPATIBLE
- [ ] Signal → Field (same payload): COMPATIBLE (broadcast)
- [ ] Field → Signal: INCOMPATIBLE
- [ ] Field → Field (same payload): COMPATIBLE
- [ ] Field → Field (different payload): INCOMPATIBLE
- [ ] Incompatible drag shows visual rejection (connection not created)

### P2: OscillaNode Class

- [ ] OscillaNode class extends ClassicPreset.Node
- [ ] OscillaNode stores blockId and blockType
- [ ] OscillaNode creates inputs from BlockDef with correct sockets
- [ ] OscillaNode creates outputs from BlockDef with correct sockets
- [ ] Node displays block label/displayName
- [ ] `createNodeFromBlock()` factory function works
- [ ] `createNodeFromBlockDef()` factory function works

### P3: Bidirectional Sync

- [ ] `syncPatchToEditor()` loads PatchStore blocks into Rete
- [ ] `syncPatchToEditor()` loads PatchStore edges as Rete connections
- [ ] Rete noderemoved → PatchStore.removeBlock() called
- [ ] Rete connectioncreated → PatchStore.addEdge() called
- [ ] Rete connectionremoved → PatchStore.removeEdge() called
- [ ] No infinite sync loops (isSyncing guard works)
- [ ] Changes visible in TableView/ConnectionMatrix after Rete edit

### P4: Add Block from Library

- [ ] Double-click block type in BlockLibrary creates block
- [ ] New block appears in Rete editor
- [ ] New block appears in TableView
- [ ] New block positioned in viewport (not at 0,0 off-screen)
- [ ] Diagnostics update (GraphCommitted event fires)

### P5: Delete Block

- [ ] Right-click node in Rete shows context menu
- [ ] Context menu has "Delete" option
- [ ] Clicking Delete removes node from editor
- [ ] Deleted node removed from PatchStore
- [ ] Connected edges also removed
- [ ] TableView/Matrix update to reflect deletion

### System Integrity

- [ ] PatchStore remains source of truth (editor reads from it)
- [ ] Compiler still works (reads from PatchStore, not Rete)
- [ ] All existing tests pass
- [ ] TypeScript compiles without errors
- [ ] No console errors during normal operation

---

## Verification Checklist

### Manual Testing

1. **Basic Editor**
   - [ ] Navigate to Editor tab
   - [ ] Verify grid/background renders
   - [ ] Pan by dragging background
   - [ ] Zoom with scroll wheel
   - [ ] No errors in console

2. **Add Block Flow**
   - [ ] In Library, double-click "Constant Float"
   - [ ] Verify node appears in editor
   - [ ] Verify node has output port
   - [ ] Switch to Blocks tab - verify block in list
   - [ ] Switch to Matrix tab - verify block in matrix

3. **Create Connection Flow**
   - [ ] Add two blocks (e.g., ConstFloat and FieldPulse)
   - [ ] Drag from ConstFloat output to FieldPulse "base" input
   - [ ] Verify connection line appears
   - [ ] Switch to Matrix - verify connection shown

4. **Type Validation Flow**
   - [ ] Add Domain block and FieldPulse block
   - [ ] Try to drag Domain output to FieldPulse "base" input (float)
   - [ ] Verify connection is REJECTED (domain ≠ float)
   - [ ] Drag Domain output to a domain input - verify ACCEPTED

5. **Delete Block Flow**
   - [ ] Add a block with connections
   - [ ] Right-click the block
   - [ ] Verify context menu appears with "Delete"
   - [ ] Click Delete
   - [ ] Verify node and connections removed from editor
   - [ ] Verify removed from TableView/Matrix

6. **Sync Verification**
   - [ ] Make changes in editor
   - [ ] Verify TableView updates
   - [ ] Verify ConnectionMatrix updates
   - [ ] Verify DiagnosticsConsole shows compile result

### Automated Testing

- [ ] `npm run test` passes
- [ ] `npm run typecheck` passes
- [ ] `npm run build` succeeds

---

## Out of Scope (Sprint 2)

- Undo/redo (History plugin)
- Auto-layout (Auto-arrange plugin)
- Minimap
- Custom node rendering/styling
- Parameter editing within nodes
- Block search in editor
- Keyboard shortcuts (Delete key, etc.)
