# Sprint Plan: patch-editor-ui (Sprint 2A - Stabilization & Undo/Redo)

**Date:** 2026-01-13 03:46
**Topic:** patch-editor-ui Sprint 2A
**Approach:** Stabilize Sprint 1 foundation + add undo/redo
**Reference:** EVALUATION-SPRINT2-20260113-034305.md

---

## Sprint Goal

Fix Sprint 1 critical blockers and implement undo/redo functionality to create a stable, reliable editor foundation. Sprint 2A ensures the core editor workflows function correctly before adding advanced features.

---

## Scope

**In scope (this sprint):**
1. Fix all Sprint 1 critical blockers (add block, socket validation, delete, pan/zoom)
2. Integrate History plugin for undo/redo
3. Add keyboard shortcuts (Ctrl+Z, Ctrl+Y)
4. Verify bidirectional sync stability
5. Comprehensive E2E testing for core workflows

**Explicitly out of scope (deferred to Sprint 2B):**
- Auto-layout (Auto-arrange plugin)
- Minimap
- Custom node rendering
- Parameter editing in nodes
- Block search in editor
- Advanced keyboard shortcuts

---

## Work Items

### D1: Fix Sprint 1 Critical Blockers

**Goal:** Debug and fix all non-functional features from Sprint 1.

**Deliverables:**

#### D1.1: Fix Add Block from Library
- **Issue:** Double-click registered but node doesn't appear
- **Root Cause Analysis:**
  - Verify `editorHandle` initialization timing
  - Check viewport coordinate calculation
  - Validate async/await in node creation
  - Ensure EditorContext provides editor instance
- **Fix:** Correct timing issues and ensure proper editor access
- **Acceptance Criteria:**
  - [ ] Double-click block in Library → node appears in editor
  - [ ] Node positioned at viewport center (not off-screen)
  - [ ] Node has correct inputs/outputs based on block type
  - [ ] Node visible in TableView and Matrix after creation
  - [ ] No console errors during add operation

#### D1.2: Verify Socket Type Validation
- **Issue:** `isCompatibleWith()` implemented but not runtime-verified
- **Testing Required:**
  - Signal → Signal (same payload): should connect
  - Signal → Field (same payload): should connect (broadcast)
  - Field → Signal: should be rejected
  - Field → Field (same payload): should connect
  - Field → Field (different payload): should be rejected
  - Domain → Domain: should connect
- **Fix:** Correct socket compatibility logic if issues found
- **Acceptance Criteria:**
  - [ ] All socket compatibility rules verified at runtime
  - [ ] Incompatible connections visually rejected (no connection line)
  - [ ] Compatible connections created successfully
  - [ ] Socket types correctly mapped from CanonicalType definitions

#### D1.3: Fix Delete Block Flow
- **Issue:** Context menu implementation unclear, delete untested
- **Implementation:**
  - Install and configure `rete-context-menu-plugin`
  - Add "Delete" option to node context menu
  - Verify node removal syncs to PatchStore
  - Ensure connected edges removed automatically
- **Acceptance Criteria:**
  - [ ] Right-click node shows context menu
  - [ ] Context menu has "Delete" option
  - [ ] Clicking Delete removes node from editor
  - [ ] Node removal syncs to PatchStore
  - [ ] Connected edges also removed
  - [ ] Selection cleared after deletion

#### D1.4: Verify Pan/Zoom Functionality
- **Issue:** Core navigation not verified, may need extensions
- **Testing:**
  - Pan: drag background to move view
  - Zoom: scroll wheel to zoom in/out
  - Zoom to fit: double-click background
- **Acceptance Criteria:**
  - [ ] Pan works (drag on editor background)
  - [ ] Zoom works (mouse scroll/trackpad)
  - [ ] Zoom limits respected (min/max zoom levels)
  - [ ] No errors during navigation

**Estimated Effort:** 2-3 days

---

### D2: Undo/Redo Implementation (History Plugin)

**Goal:** Integrate History plugin for undo/redo with proper PatchStore sync.

**Technical Approach:**

```typescript
import { HistoryPlugin } from 'rete-history-plugin';

// Install package
npm install rete-history-plugin

// Setup
const history = new HistoryPlugin<Schemes>();
editor.use(history);

// Configure history
history.setup();

// Track changes that should be undoable
editor.addPipe(context => {
  if (isSyncing) return context; // Don't commit during sync

  if (context.type === 'nodecreated' ||
      context.type === 'noderemoved' ||
      context.type === 'connectioncreated' ||
      context.type === 'connectionremoved') {
    // Commit user action to history
    history.push();
  }

  return context;
});
```

**Key Requirements:**
- History only commits on user actions (not programmatic sync)
- Must work with existing `isSyncing` guard
- Undo/redo must update PatchStore (maintain source of truth)
- History depth: 50 steps (configurable)

**Acceptance Criteria:**
- [ ] History plugin installed and configured
- [ ] Ctrl+Z triggers undo
- [ ] Ctrl+Y triggers redo
- [ ] Undo after add block → block removed from editor and PatchStore
- [ ] Undo after delete block → block restored with connections
- [ ] Undo after create connection → connection removed
- [ ] Undo after delete connection → connection restored
- [ ] Undo/redo works after patch switching
- [ ] History cleared when new patch loaded
- [ ] No sync conflicts during undo/redo

**Estimated Effort:** 1-2 days

---

### D3: Enhanced Sync & Stability

**Goal:** Strengthen bidirectional sync and add stability measures.

**Deliverables:**

#### D3.1: Extend Sync Layer
```typescript
// src/ui/editor/sync.ts - Enhanced operations
interface EditorSync {
  // Existing
  syncBlocks(): Promise<void>;
  syncConnections(): Promise<void>;

  // New operations
  pushHistoryState(): void;
  undo(): void;
  redo(): void;
  isHistoryAvailable(): { undo: boolean; redo: boolean };
}
```

#### D3.2: Add State Validation
- Verify PatchStore remains source of truth
- Detect and prevent sync conflicts
- Add error handling for failed sync operations
- Log sync operations for debugging

**Acceptance Criteria:**
- [ ] Sync layer extended with history operations
- [ ] No infinite sync loops detected
- [ ] Failed sync operations logged with context
- [ ] State consistency verified after undo/redo
- [ ] Performance: sync operations complete <100ms

**Estimated Effort:** 0.5-1 day

---

### D4: E2E Testing

**Goal:** Comprehensive E2E tests for all core workflows.

**Test Suites:**

#### D4.1: Block Operations
```typescript
// tests/e2e/editor-block-operations.test.ts
test('add block from library', async () => {
  await page.dblclick('[data-block-type="Constant"]');
  const nodes = await page.locator('.rete-node').count();
  expect(nodes).toBe(1);

  // Verify in TableView
  await page.click('[data-tab="blocks"]');
  await expect(page.locator('text=Constant')).toBeVisible();
});
```

#### D4.2: Connection Operations
```typescript
test('create connection with type validation', async () => {
  // Add two blocks
  await page.dblclick('[data-block-type="Constant"]');
  await page.dblclick('[data-block-type="FieldPulse"]');

  // Try incompatible connection (should fail)
  await drag('[data-socket="domain"]', '[data-socket="float"]');
  const connections = await page.locator('.rete-connection').count();
  expect(connections).toBe(0);

  // Try compatible connection (should succeed)
  await drag('[data-socket="float"]', '[data-socket="base"]');
  expect(await page.locator('.rete-connection').count()).toBe(1);
});
```

#### D4.3: Undo/Redo
```typescript
test('undo/redo workflow', async () => {
  await page.dblclick('[data-block-type="Constant"]');
  await page.dblclick('[data-block-type="FieldPulse"]');

  let nodeCount = await page.locator('.rete-node').count();
  expect(nodeCount).toBe(2);

  // Undo last add
  await page.keyboard.press('Control+Z');
  nodeCount = await page.locator('.rete-node').count();
  expect(nodeCount).toBe(1);

  // Redo
  await page.keyboard.press('Control+Y');
  nodeCount = await page.locator('.rete-node').count();
  expect(nodeCount).toBe(2);
});
```

**Acceptance Criteria:**
- [ ] E2E tests for add block flow
- [ ] E2E tests for delete block flow
- [ ] E2E tests for connection creation/deletion
- [ ] E2E tests for socket type validation
- [ ] E2E tests for undo/redo operations
- [ ] All tests pass in CI pipeline
- [ ] Test coverage: 80%+ for editor module

**Estimated Effort:** 1 day

---

## Dependencies

### NPM Packages (New)
```json
{
  "rete-history-plugin": "^2.0.0"
}
```

### Internal Dependencies
- Sprint 1 foundation (Rete editor, sockets, nodes, basic sync)
- PatchStore (source of truth)
- Block registry (existing)
- EditorContext (existing)

### Prerequisites
- Sprint 1 critical bugs identified and root causes understood
- Test environment with Playwright configured
- Access to existing editor codebase

---

## Risks

| Risk | Likelihood | Impact | Mitigation |
|------|------------|--------|------------|
| **Add block timing issues complex** | Medium | High | Debug with editor logs, verify initialization order |
| **Sync conflicts with undo/redo** | High | High | Careful isSyncing guard, test thoroughly |
| **History plugin compatibility** | Low | Medium | Test with current Rete version, version lock |
| **Performance degradation** | Medium | Medium | Monitor history size, implement cleanup |
| **E2E test flakiness** | Medium | Low | Use stable selectors, adequate waits |

---

## Timeline

**Total Estimated Effort:** 4-5 days

| Day | Work Item | Focus |
|-----|-----------|-------|
| Day 1 | D1.1, D1.2 | Debug add block + verify socket validation |
| Day 2 | D1.3, D1.4 | Fix delete + verify pan/zoom |
| Day 3 | D2 | Implement History plugin + keyboard shortcuts |
| Day 4 | D3 | Enhanced sync + stability measures |
| Day 5 | D4 | E2E testing + bug fixes |

**Buffer:** 1 day for unexpected issues (total: 5-6 days)

---

## Success Criteria

- [ ] All Sprint 1 blockers fixed and verified
- [ ] Add block from Library works reliably
- [ ] Socket type validation tested and correct
- [ ] Delete block works with context menu
- [ ] Pan/zoom navigation works smoothly
- [ ] Undo/redo works for all editor operations
- [ ] Keyboard shortcuts (Ctrl+Z, Ctrl+Y) functional
- [ ] Bidirectional sync stable (no loops or conflicts)
- [ ] All E2E tests pass consistently
- [ ] No regressions in existing functionality
- [ ] Performance: Editor responsive with 50+ nodes
- [ ] TypeScript compiles without errors
- [ ] All existing tests pass

---

## Post-Sprint Validation

Before proceeding to Sprint 2B:
1. **Code Review:** All changes reviewed and approved
2. **Performance Check:** Editor remains responsive with large graphs
3. **User Acceptance:** Core workflows validated by stakeholder
4. **Regression Testing:** No breaking changes to existing features
5. **Technical Debt:** Code quality meets standards