# EVALUATION: patch-editor-ui

**Date:** 2026-01-12
**Topic:** patch-editor-ui
**Topic Directory:** .agent_planning/patch-editor-ui/
**Status:** PROPOSED (no planning files exist yet)

## Executive Summary

patch-editor-ui is the next critical feature following the completion of ui-features-v2. The goal is to implement **editing capabilities** for the visual patch graph - the ability for users to add blocks, create edges, delete blocks/edges, and edit parameters. Currently, all UI infrastructure is **read-only visualization** only.

The system has strong foundations in place:
- **PatchStore** is the single source of truth with mutation actions already defined
- **SelectionStore** tracks UI state (selected blocks/edges, preview mode)
- **RootStore** provides event/diagnostic coordination
- **UI Components** exist for Library (browsable), Inspector (detail view), and Connection Matrix (topology view)
- **Block Registry** has all 25+ block types defined with ports and capabilities

**Critical Gaps:**
1. No undo/redo system (mutation history)
2. Double-click to add block not implemented (BlockLibrary has TODO at line 112)
3. No visual patch editor (only table/matrix views - no graph canvas)
4. No edge drag-and-drop interaction
5. No delete/edit interactions
6. No command pattern for structured mutations

## 1. What Exists

### 1.1 Mutation Infrastructure (PatchStore)

**File:** `src/stores/PatchStore.ts`

PatchStore already has complete mutation actions:
- `addBlock(type, params, options)` â†’ BlockId
- `removeBlock(id)` â†’ removes block + all connected edges
- `updateBlockParams(id, params)` â†’ shallow merge
- `updateBlockDisplayName(id, displayName)`
- `addEdge(from, to, options)` â†’ edge ID
- `removeEdge(id)`
- `updateEdge(id, updates)` â†’ update enabled/sortKey
- `loadPatch(patch)` â†’ replace entire patch
- `clear()` â†’ reset to empty

**Status:** âœ… COMPLETE - All core mutations exist

### 1.2 UI State Management (SelectionStore)

**File:** `src/stores/SelectionStore.ts`

Tracks UI selection state:
- `selectedBlockId / selectedEdgeId` - which block/edge is selected
- `hoveredBlockId / hoveredPortRef` - hover state
- `previewType` - block type preview mode (from Library)
- Computed getters for `relatedBlockIds`, `highlightedBlockIds`

**Status:** âœ… COMPLETE

### 1.3 Block Library Component

**File:** `src/ui/components/BlockLibrary.tsx`

Current state:
- âœ… Search with debounce
- âœ… Category collapse/expand
- âœ… Single-click preview (sets `previewType` in SelectionStore)
- âŒ **Double-click to add block NOT IMPLEMENTED** (line 112: `console.log('Add block:', type.type)`)
- âœ… TimeRoot blocks filtered from view

**Status:** ðŸŸ¡ HALF-DONE - Preview works, but double-click action missing

### 1.4 Block Inspector Component

**File:** `src/ui/components/BlockInspector.tsx`

Shows detailed view of selected block parameters, input/output ports, default sources, and type preview.

**Status:** âœ… READ-ONLY COMPLETE - Shows configuration but cannot edit it yet

### 1.5 UI Layout

**File:** `src/ui/components/app/App.tsx`

Current 3-column layout:
- **Left:** Split sidebar - BlockLibrary (top) + BlockInspector (bottom) [280px]
- **Center:** Tabbed workspace - Blocks table view, Connection Matrix, Canvas preview
- **Right:** Tabbed panels - Domains, Help [280px]

**Status:** âœ… SUITABLE FOR EDITING

## 2. What's Missing

### 2.1 Command Pattern / Undo-Redo System

**Current State:** NO command infrastructure exists

**Needed:**
- Command interface with execute/undo methods
- UndoRedoManager with history tracking
- Concrete commands: AddBlockCommand, RemoveBlockCommand, UpdateParamsCommand, etc.

### 2.2 Add Block Action

**Current:** BlockLibrary double-click logs to console only
**Needed:** Wire double-click to `PatchStore.addBlock()`

### 2.3 Edge Creation/Deletion Interactions

**Current:** No interaction at all
**Needed:** Context menu or click-based edge creation

### 2.4 Delete Interactions

**Current:** PatchStore has `removeBlock()` but no UI trigger
**Needed:** Right-click context menu or keyboard shortcut

### 2.5 Parameter Editing

**Current:** BlockInspector shows params as read-only JSON
**Needed:** Click parameter â†’ edit field, calls `PatchStore.updateBlockParams()`

### 2.6 Block Display Name Editing

**Current:** Shows displayName but cannot edit
**Needed:** Click to edit, calls `PatchStore.updateBlockDisplayName()`

## 3. Architecture Considerations

### 3.1 Single Source of Truth

PatchStore is THE source of truth. SelectionStore only stores IDs, derives actual data via computed getters. **Maintain this pattern.**

### 3.2 Command Pattern for Undo/Redo

All mutations should go through Commands that wrap PatchStore actions:

```typescript
interface Command {
  execute(): void;
  undo(): void;
  getDescription(): string;
}

class UndoRedoManager {
  history: Command[] = []
  index: number = -1
  execute(cmd: Command) {...}
  undo() {...}
  redo() {...}
}
```

### 3.3 Spec Guidance on Editor Style

From `design-docs/spec/10-linear-graph-editor.md`:
> "A graph editor where blocks are automatically positioned in a linear flow. Users navigate by selecting blocks and rotating perspective to focus on different subgraphs. **No manual positioning, no drag-and-drop.**"

**Recommendation:** Use list/matrix views for editing. Canvas editor can come later.

## 4. Dependencies and Risks

### 4.1 Phase 1 Dependencies

- **type-system** (PLANNING) - Type checking for ports - can defer validation
- **buses-and-rails** (PLANNING) - Multi-input combine - can defer

**Risk Level:** MEDIUM - Can implement basic editing now, add validation later

### 4.2 Phase 2 Dependencies

- âœ… **ui-framework** (COMPLETED)
- âœ… **diagnostics-system** (COMPLETED)
- âœ… **ui-features-v2** (COMPLETED)

**Risk Level:** LOW - All foundations are done

## 5. Key Ambiguities

1. **Visual Representation**: List-based or canvas-based?
   - **Recommendation:** Use enhanced Connection Matrix + inline editors for MVP

2. **Edge Creation UX**: How do users CREATE edges?
   - **Recommendation:** Click input port â†’ context menu to select source

3. **Validation Timing**: Prevent invalid connections or allow with warnings?
   - **Recommendation:** Allow connections, show warnings in diagnostics

4. **Parameter Editing Complexity**: Simple text inputs or custom editors per type?
   - **Recommendation:** Start with basic text inputs, enhance later

## 6. Recommended First Sprint Scope

**Priority P0 (MVP):**
1. UndoRedoManager + Command pattern infrastructure
2. Wire BlockLibrary double-click to add block
3. Delete block context menu in TableView/Matrix
4. Parameter editing in BlockInspector (basic form inputs)
5. Undo/Redo toolbar buttons + keyboard shortcuts

**Priority P1 (Extended):**
6. Block display name editing
7. Edge creation via port context menu
8. Edge deletion

**Out of Scope:**
- Canvas graph editor (Phase 3)
- Type validation (after type-system complete)
- Drag-and-drop (spec says no)

## 7. Success Criteria

1. User can add block by double-clicking in Library
2. User can delete block via context menu
3. User can edit block parameters in Inspector
4. User can undo/redo all editing operations (Ctrl+Z / Ctrl+Shift+Z)
5. All mutations go through PatchStore
6. Diagnostics update immediately on edit
7. All tests pass

## Verdict: CONTINUE

Ready to generate detailed sprint plan.
