# Evaluation: CanonicalType System Implementation

**Generated**: 2026-01-29T01:20:28Z
**Topic**: Bringing codebase into alignment with `design-docs/canonical-types/00-exhaustive-type-system.md`
**Verdict**: CONTINUE (no blockers, extensive work required)

---

## Executive Summary

Item-by-item audit reveals the codebase is **~20% aligned** with the spec. The previous gap analysis was catastrophically wrong, claiming 10 items done when most were superficially present but architecturally incorrect.

**Scope of misalignment:**
- **Axis type system**: Fundamentally wrong (no type variables)
- **Entire files missing**: `value-expr.ts`, `axis-validate.ts`
- **Core constructors missing**: `canonicalSignal`, `canonicalField`, `canonicalEventOne`, `canonicalEventField`
- **Derived helpers missing**: `deriveKind`, `getManyInstance`, `assertSignalType`, `assertFieldType`, `assertEventType`
- **Structure mismatches**: UnitType flattened, InstanceRef uses strings, BindingValue has extra fields

---

## Item-by-Item Audit Results

### 1. AXIS TYPE SYSTEM — ❌ FUNDAMENTALLY WRONG

| Spec | Actual | Gap |
|------|--------|-----|
| `Axis<T, V> = { kind: 'var'; var: V } \| { kind: 'inst'; value: T }` | `AxisTag<T> = { kind: 'default' } \| { kind: 'instantiated'; value: T }` | No type variables |
| `CardinalityAxis = Axis<CardinalityValue, CardinalityVarId>` | Does not exist | Type alias missing |
| `TemporalityAxis = Axis<TemporalityValue, TemporalityVarId>` | Does not exist | Type alias missing |
| `BindingAxis = Axis<BindingValue, BindingVarId>` | Does not exist | Type alias missing |
| `PerspectiveAxis = Axis<PerspectiveValue, PerspectiveVarId>` | Does not exist | Type alias missing |
| `BranchAxis = Axis<BranchValue, BranchVarId>` | Does not exist | Type alias missing |

**Impact**: Breaks polymorphism and type inference. Cannot track "these two unknown cardinalities must unify to the same value."

### 2. AXIS VALUE TYPES — ⚠️ PARTIALLY CORRECT

| Type | Spec | Actual | Status |
|------|------|--------|--------|
| `CardinalityValue` | `zero \| one \| many{instance}` | Same | ✓ |
| `TemporalityValue` | `continuous \| discrete` | Same | ✓ |
| `BindingValue` | `unbound \| weak \| strong \| identity` | Has extra `referent: ReferentRef` on weak/strong/identity | ⚠️ Extra field |
| `PerspectiveValue` | `{ kind: 'default' }` | `type PerspectiveId = string` | ❌ Wrong type |
| `BranchValue` | `{ kind: 'default' }` | `type BranchId = string` | ❌ Wrong type |

### 3. INSTANCEREF — ❌ WRONG

| Spec | Actual | Gap |
|------|--------|-----|
| `instanceId: InstanceId` (branded) | `instanceId: string` | Plain string |
| `domainTypeId: DomainTypeId` (branded) | `domainType: string` | Plain string, wrong name |
| No `kind` field | Has `kind: 'instance'` | Extra discriminator |

### 4. UNITTYPE — ❌ WRONG STRUCTURE

| Spec | Actual | Gap |
|------|--------|-----|
| `{ kind: 'angle'; unit: 'radians' \| 'degrees' \| 'phase01' }` | `{ kind: 'radians' }`, `{ kind: 'degrees' }`, `{ kind: 'phase01' }` | Flattened |
| `{ kind: 'time'; unit: 'ms' \| 'seconds' }` | `{ kind: 'ms' }`, `{ kind: 'seconds' }` | Flattened |
| 5 structured kinds | 16+ flat kinds + `{ kind: 'var' }` | Expanded beyond spec |

### 5. PAYLOADTYPE — ⚠️ DIFFERENT

| Spec | Actual | Gap |
|------|--------|-----|
| 7 kinds (no var, no stride) | 7 kinds + `{ kind: 'var'; id: string }` + `stride` on each | Extra features |
| No `shape` kind | Has `{ kind: 'shape'; stride: 8 }` | Extra kind |

### 6. CANONICALTYPE INTERFACE — ⚠️ MINOR DIFFERENCE

| Spec | Actual | Gap |
|------|--------|-----|
| `payload, unit, extent` order | `payload, extent, unit` order | Field order |
| `unit: UnitType` | `unit: Unit` | Type name |

### 7. CANONICAL CONSTRUCTORS — ❌ ALL MISSING

| Spec Function | Actual | Status |
|---------------|--------|--------|
| `canonicalSignal(payload, unit)` | Does not exist | ❌ MISSING |
| `canonicalField(payload, unit, instance)` | Does not exist | ❌ MISSING |
| `canonicalEventOne()` | Does not exist | ❌ MISSING |
| `canonicalEventField(instance)` | Does not exist | ❌ MISSING |

**What exists instead**: `signalTypeSignal`, `signalTypeField`, `eventTypeScalar`, `eventTypePerInstance` — different names, different signatures.

### 8. DEFAULT CONSTANTS — ❌ ALL MISSING

| Spec | Actual | Status |
|------|--------|--------|
| `DEFAULT_BINDING: BindingValue = { kind: 'unbound' }` | Does not exist | ❌ MISSING |
| `DEFAULT_PERSPECTIVE: PerspectiveValue = { kind: 'default' }` | Does not exist | ❌ MISSING |
| `DEFAULT_BRANCH: BranchValue = { kind: 'default' }` | Does not exist | ❌ MISSING |

### 9. DERIVED CLASSIFICATION HELPERS — ❌ ALL MISSING

| Spec Function | Actual | Status |
|---------------|--------|--------|
| `deriveKind(t): DerivedKind` | Does not exist | ❌ MISSING |
| `getManyInstance(t): InstanceRef \| null` | Does not exist | ❌ MISSING |
| `assertSignalType(t): void` | Does not exist | ❌ MISSING |
| `assertFieldType(t): InstanceRef` | Does not exist | ❌ MISSING |
| `assertEventType(t): void` | Does not exist | ❌ MISSING |

### 10. CONSTVALUE — ✓ CORRECT

| Spec | Actual | Status |
|------|--------|--------|
| 7-kind discriminated union | Same | ✓ |
| `constValueMatchesPayload(payload, v)` | Exists | ✓ |

### 11. STRIDE HELPER — ❌ WRONG APPROACH

| Spec | Actual | Gap |
|------|--------|-----|
| `payloadStride(p): 1\|2\|3\|4` (computed) | `strideOf(type)` reads embedded `stride` | Different approach |

### 12. VALUE-EXPR.TS — ❌ ENTIRE FILE MISSING

| Spec Component | Actual | Status |
|----------------|--------|--------|
| `src/compiler/ir/value-expr.ts` file | Does not exist | ❌ MISSING |
| `ValueExpr` unified type | Does not exist | ❌ MISSING |
| `ValueExprConst` | Does not exist | ❌ MISSING |
| `ValueExprExternal` | Does not exist | ❌ MISSING |
| `ValueExprIntrinsic` | Does not exist | ❌ MISSING |
| `ValueExprKernel` | Does not exist | ❌ MISSING |
| `ValueExprState` | Does not exist | ❌ MISSING |
| `ValueExprTime` | Does not exist | ❌ MISSING |
| `IntrinsicWhich` type | Does not exist | ❌ MISSING |
| `StateOp` type | Does not exist | ❌ MISSING |

**What exists instead**: Separate `SigExpr`, `FieldExpr`, `EventExpr` unions — the "old world" the spec explicitly says to unify.

### 13. AXIS-VALIDATE.TS — ❌ ENTIRE FILE MISSING

| Spec Component | Actual | Status |
|----------------|--------|--------|
| `src/compiler/frontend/axis-validate.ts` file | Does not exist | ❌ MISSING |
| `AxisViolation` interface | Does not exist | ❌ MISSING |
| `validateAxes(exprs)` function | Does not exist | ❌ MISSING |

### 14. ADAPTER-SPEC.TS — ❌ WRONG LOCATION/STRUCTURE

| Spec | Actual | Gap |
|------|--------|-----|
| Location: `src/blocks/adapter-spec.ts` | `src/graph/adapters.ts` | Wrong location |
| `ExtentPattern` | Does not exist | ❌ MISSING |
| `ExtentTransform` | Does not exist | ❌ MISSING |
| `TypePattern { payload, unit, extent }` | `TypeSignature { payload, unit, cardinality, temporality }` | Flattened |
| `AdapterSpec.from/to` | Split into separate `AdapterRule` | Different structure |
| `AdapterSpec.purity` | Does not exist | ❌ MISSING |
| `AdapterSpec.stability` | Does not exist | ❌ MISSING |

### 15. FIELDEXPR INSTANCEID VIOLATION — ❌ STILL PRESENT

| Invariant | Actual | Status |
|-----------|--------|--------|
| I1: No field may duplicate type authority | `FieldExprMap.instanceId?`, `FieldExprZip.instanceId?`, `FieldExprZipSig.instanceId?` | ❌ VIOLATES |

---

## Summary Statistics

| Category | Items | Correct | Partial | Wrong/Missing |
|----------|-------|---------|---------|---------------|
| Axis Type System | 6 | 0 | 0 | 6 |
| Axis Value Types | 5 | 2 | 1 | 2 |
| InstanceRef | 3 | 0 | 0 | 3 |
| UnitType | 1 | 0 | 0 | 1 |
| PayloadType | 1 | 0 | 1 | 0 |
| CanonicalType | 1 | 0 | 1 | 0 |
| Canonical Constructors | 4 | 0 | 0 | 4 |
| Default Constants | 3 | 0 | 0 | 3 |
| Derived Helpers | 5 | 0 | 0 | 5 |
| ConstValue | 2 | 2 | 0 | 0 |
| Stride Helper | 1 | 0 | 0 | 1 |
| value-expr.ts | 10 | 0 | 0 | 10 |
| axis-validate.ts | 3 | 0 | 0 | 3 |
| adapter-spec.ts | 7 | 0 | 0 | 7 |
| FieldExpr Violations | 3 | 0 | 0 | 3 |
| **TOTAL** | **55** | **4 (7%)** | **3 (5%)** | **48 (87%)** |

---

## Verdict: CONTINUE

No external blockers. This is a large refactoring effort requiring careful sequencing to avoid breaking the existing system while migrating to the new architecture.

---

## Reference Documents (MUST READ)

1. `design-docs/canonical-types/00-exhaustive-type-system.md` — **AUTHORITATIVE SOURCE**
2. `design-docs/canonical-types/15-FiveAxesTypeSystem-Conclusion.md` — 5 invariants, 6 traps
3. `design-docs/canonical-types/10-RulesForNewTypes.md` — 12 rules preventing old-world leakage
