# Evaluation: Fix Tests and Typecheck Issues

**Generated**: 2026-01-20T15:00:00
**Topic**: Fix all failing tests and typecheck issues
**Verdict**: CONTINUE

## Summary

There are two categories of issues:
1. **TypeScript compilation errors** (19 errors in 2 files)
2. **Test failures** (4 failures in DiagnosticHub.test.ts)

All issues stem from the same root cause: **the DiagnosticHub tests use outdated event shapes and expect missing methods**.

## Issue Analysis

### 1. TypeScript Errors in `DiagnosticHub.test.ts` (18 errors)

The tests emit events with outdated shapes that don't match the current `EditorEvent` type definitions.

#### A. GraphCommittedEvent - Missing required properties
**Errors at lines**: 44, 178

Current test code:
```typescript
events.emit({
  type: 'GraphCommitted',
  patchId: 'patch-0',
  patchRevision: 1,
});
```

Required per `src/events/types.ts:35-46`:
```typescript
interface GraphCommittedEvent {
  readonly type: 'GraphCommitted';
  readonly patchId: string;
  readonly patchRevision: number;
  readonly reason: 'userEdit' | 'macroExpand' | 'import' | 'undo' | 'redo'; // MISSING
  readonly diffSummary: {  // MISSING
    readonly blocksAdded: number;
    readonly blocksRemoved: number;
    readonly edgesChanged: number;
  };
  readonly affectedBlockIds?: readonly string[];
}
```

#### B. CompileBeginEvent - Missing `trigger` property
**Errors at lines**: 55, 83, 110, 128, 151, 184

Current test code:
```typescript
events.emit({
  type: 'CompileBegin',
  patchId: 'patch-0',
  patchRevision: 1,
  compileId: 'compile-1',
});
```

Required per `src/events/types.ts:64-70`:
```typescript
interface CompileBeginEvent {
  readonly type: 'CompileBegin';
  readonly compileId: string;
  readonly patchId: string;
  readonly patchRevision: number;
  readonly trigger: 'graphCommitted' | 'manual' | 'startup'; // MISSING
}
```

#### C. CompileEndEvent - Using wrong properties
**Errors at lines**: 67, 95, 122, 140, 163, 196

Current test code (WRONG):
```typescript
events.emit({
  type: 'CompileEnd',
  patchId: 'patch-0',
  patchRevision: 1,
  compileId: 'compile-1',
  success: false,  // WRONG - should be status: 'success' | 'failure'
  errors: [...]    // WRONG - should be diagnostics: Diagnostic[]
});
```

Required per `src/events/types.ts:86-94`:
```typescript
interface CompileEndEvent {
  readonly type: 'CompileEnd';
  readonly compileId: string;
  readonly patchId: string;
  readonly patchRevision: number;
  readonly status: 'success' | 'failure';  // Not 'success: boolean'
  readonly durationMs: number;              // MISSING in tests
  readonly diagnostics: readonly Diagnostic[];  // Not 'errors'
}
```

#### D. Missing methods: `getBySeverity` and `getByDomain`
**Errors at lines**: 170, 173, 200, 201

The tests call methods that don't exist on `DiagnosticHub`:
- `hub.getBySeverity('error')` - Does not exist
- `hub.getByDomain('authoring')` - Does not exist

The `DiagnosticHub` has a `filter()` method that accepts a `DiagnosticFilter` object, but no direct `getBySeverity` or `getByDomain` convenience methods.

### 2. TypeScript Error in `SignalEvaluator.ts` (1 error)

**Error at line 111**: `Property 'progress' does not exist on type 'EffectiveTime'`

The `EffectiveTime` interface in `src/runtime/timeResolution.ts` defines:
```typescript
export interface EffectiveTime {
  tAbsMs: number;
  tMs: number;
  dt: number;
  phaseA: number;
  phaseB: number;
  pulse: number;
  // NO 'progress' property
}
```

But `SignalEvaluator.ts:111` attempts to access:
```typescript
case 'progress':
  return state.time.progress ?? 0;  // ERROR: 'progress' doesn't exist
```

### 3. Test Failures (4 failures)

All 4 test failures in `DiagnosticHub.test.ts` are consequences of the TypeScript issues:

1. **"replaces compile snapshot on CompileEnd (not merge)"**
   - Fails because `event.diagnostics is not iterable` (tests pass `errors` not `diagnostics`)

2. **"deduplicates by stable ID across revisions"**
   - Fails because `hub.getActive()[0]` is undefined (no diagnostics processed)

3. **"filters by severity"**
   - Fails because `hub.getBySeverity is not a function`

4. **"filters by domain"**
   - Fails because `hub.getByDomain is not a function`

## Root Cause

The `DiagnosticHub.test.ts` was written against an older event schema. The event types were later updated but the tests were not synchronized.

Additionally, convenience methods `getBySeverity` and `getByDomain` were planned but never implemented on `DiagnosticHub`.

## Solution Approach

Two options:

### Option A: Update Tests to Match Current Types (Recommended)

1. Fix all event emissions in tests to use correct shapes
2. Either:
   - Add `getBySeverity` and `getByDomain` methods to `DiagnosticHub`, OR
   - Update tests to use the existing `filter()` method
3. Add `progress` property to `EffectiveTime` interface

**Pros**: Tests will verify actual behavior against real types
**Cons**: None

### Option B: Create Test Helpers with Type Assertions

Create helper functions that construct events with partial data using type assertions.

**Pros**: Less code change
**Cons**: Tests won't catch future type drift; hides bugs

## Dependencies

None - these are self-contained fixes.

## Risks

- **Low**: Changes are confined to test files and one type definition
- **No behavioral changes** to production code (except adding `progress` to `EffectiveTime`)

## Estimated Scope

- 1 file: `src/diagnostics/__tests__/DiagnosticHub.test.ts` - Update all event emissions and method calls
- 1 file: `src/runtime/timeResolution.ts` - Add `progress` property to `EffectiveTime`
- Optional: `src/diagnostics/DiagnosticHub.ts` - Add convenience methods

## Recommendation

Proceed with **Option A**. The changes are straightforward and will result in more accurate tests.

## Files to Modify

| File | Changes |
|------|---------|
| `src/diagnostics/__tests__/DiagnosticHub.test.ts` | Update all event shapes, update filter method calls |
| `src/runtime/timeResolution.ts` | Add `progress?: number` to `EffectiveTime` |
