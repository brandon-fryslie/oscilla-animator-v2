# Evaluation: Make ConcretePayloadType an object carrying stride intrinsically

Timestamp: 2026-01-26-150532
Git Commit: 4d28c18

## Executive Summary

| Metric | Value |
|--------|-------|
| Overall completion | 0% (proposed change, not started) |
| Critical issues | 1 (hardcoded stride heuristic in ContinuityApply.ts:321) |
| Tests reliable | Yes (but one test encodes the bug) |
| Estimated effort | Small (1 sprint max) |

## Runtime Check Results

| Check | Status | Output |
|-------|--------|--------|
| npm run test | PASS | 103 files, 1631 tests passed, 5 skipped |
| TypeScript compile | PASS | No errors |

## Missing Checks

None needed - all tests pass. However, one test needs to be updated as part of this work because it asserts the buggy behavior exists.

## Findings

### 1. ContinuityApply.ts - The Critical Bug

**Status**: BUG (requires fix)
**Evidence**: `src/runtime/ContinuityApply.ts:321`
```typescript
const stride = semantic === 'position' ? 2 : 1;
```

**Issues**:
1. Assumes `position` is always `vec2` (stride 2)
2. Assumes everything else is `float` (stride 1)
3. Completely wrong for:
   - `color` semantic: payload is `color` with stride 4
   - `custom` semantic: could be `shape` (stride 8), `vec3` (stride 3), etc.
   - `radius` semantic: correctly float (stride 1) - happens to work by accident

**Root Cause**: `StepContinuityApply` contains only `semantic`, not the actual payload type or stride. The compiler knows the stride when creating this step but doesn't pass it through.

### 2. ConcretePayloadType Definition

**Status**: ADEQUATE (works, but proposal would improve it)
**Evidence**: `src/core/canonical-types.ts:157-165`
```typescript
export type ConcretePayloadType =
  | 'float'
  | 'int'
  | 'vec2'
  | 'vec3'
  | 'color'
  | 'bool'
  | 'shape'
  | 'cameraProjection';
```

**Issues**:
- Stride is a derived property that must be looked up via `strideOf()` or `PAYLOAD_STRIDE`
- All 110+ call sites do `strideOf(outType.payload)` - this works fine

### 3. PAYLOAD_STRIDE Lookup

**Status**: ADEQUATE
**Evidence**: `src/core/canonical-types.ts:223-232`

**Issues**: None - this is the single source of truth for stride values.

### 4. strideOf() Function

**Status**: ADEQUATE
**Evidence**: `src/core/canonical-types.ts:241-247`

**Issues**: None - correctly throws for unresolved payload variables, returns from lookup table for concrete types.

### 5. Test That Encodes The Bug

**Status**: NEEDS UPDATE
**Evidence**: `src/projection/__tests__/level9-continuity-decoupling.test.ts:52-53`
```typescript
expect(source).toMatch(/const stride = semantic === 'position' \? 2 : 1/);
```

**Issues**: This test asserts that the buggy code exists! When fixing the bug, this test will need to be updated to verify the correct behavior instead.

## Ambiguities Found

| Area | Question | How LLM Guessed | Impact |
|------|----------|-----------------|--------|
| Proposed change scope | Should ConcretePayloadType become an object OR just add stride to StepContinuityApply? | N/A - evaluating both options | Medium |
| vec3 usage | Are vec3 positions currently used with continuity? | Probably not (tests use vec2) | Low |
| color continuity | Is color continuity actually exercised? | Unknown | Medium |

## Analysis: Two Possible Solutions

### Option A: Change ConcretePayloadType to Object (Proposed)

Change from:
```typescript
type ConcretePayloadType = 'float' | 'vec2' | 'color' | ...
```
To:
```typescript
type ConcretePayloadType =
  | { readonly kind: 'float'; readonly stride: 1 }
  | { readonly kind: 'vec2'; readonly stride: 2 }
  | { readonly kind: 'color'; readonly stride: 4 }
  // ...
```

**Pros**:
- Stride is always available where payload type is known
- No separate lookup needed
- TypeScript literal types provide compile-time stride values

**Cons**:
- Massive refactor: 110+ `strideOf()` calls need updating
- All comparisons change from `payload === 'float'` to `payload.kind === 'float'`
- All 6 files using ConcretePayloadType need updates
- ALLOWED_UNITS, TYPE_COLORS, and other Record types need restructuring

**Estimated changes**:
- ~6 files with type usage: moderate changes
- ~22 files with strideOf() calls: trivial changes (could keep strideOf working)
- ~20+ files with payload comparisons: unknown scope

### Option B: Add stride to StepContinuityApply (Simpler Fix)

Add `stride: number` to StepContinuityApply interface and populate it in pass7-schedule.ts:

```typescript
export interface StepContinuityApply {
  readonly kind: 'continuityApply';
  // ... existing fields
  readonly stride: number;  // NEW
}
```

**Pros**:
- Fixes the bug with minimal changes
- Only 2 files need modification:
  1. `src/compiler/ir/types.ts` - add field
  2. `src/compiler/passes-v2/pass7-schedule.ts` - populate field
  3. `src/runtime/ContinuityApply.ts` - use field instead of heuristic
- Much lower risk

**Cons**:
- Doesn't make stride intrinsic to ConcretePayloadType
- Other code paths might have similar issues in the future

## Recommendation

**Option B (add stride to StepContinuityApply) should be done first** because:
1. It directly fixes the critical bug
2. Very low risk
3. Can be done in <1 hour

**Option A (refactor ConcretePayloadType) is a separate, larger undertaking** that:
1. Has architectural merit but isn't urgent
2. Should be done as a follow-up if desired
3. Is orthogonal to fixing the immediate bug

## Impact Assessment

| Payload Type | Stride | Current Behavior | Correct Behavior | Risk |
|--------------|--------|------------------|------------------|------|
| float | 1 | Works (heuristic returns 1) | Works | None |
| int | 1 | Works (heuristic returns 1) | Works | None |
| bool | 1 | Works (heuristic returns 1) | Works | None |
| vec2 | 2 | Works (position heuristic) | Works | None |
| vec3 | 3 | WRONG (returns 1) | Should be 3 | **HIGH** |
| color | 4 | WRONG (returns 1) | Should be 4 | **HIGH** |
| shape | 8 | WRONG (returns 1) | Should be 8 | **HIGH** |
| cameraProjection | 1 | Works (heuristic returns 1) | Works | None |

## Recommendations

1. **Highest priority**: Fix ContinuityApply.ts by adding stride to StepContinuityApply
2. **Update test**: Change level9-continuity-decoupling.test.ts to test correct behavior
3. **Optional follow-up**: Refactor ConcretePayloadType if architectural benefits are desired

## Verdict

- [x] CONTINUE - Issues clear, implementer can fix
- [ ] PAUSE - Ambiguities need clarification

The bug is well-understood. Option B (add stride to StepContinuityApply) is the recommended fix. Option A (refactor ConcretePayloadType to an object) is a larger architectural change that could be done separately.

## Files to Modify (Option B - Recommended Fix)

1. `src/compiler/ir/types.ts:530-538` - Add `stride: number` field to StepContinuityApply
2. `src/compiler/passes-v2/pass7-schedule.ts:313-321` - Populate stride field when creating step
3. `src/runtime/ContinuityApply.ts:321` - Use `step.stride` instead of hardcoded heuristic
4. `src/projection/__tests__/level9-continuity-decoupling.test.ts:52-53,75` - Update test assertions

## Files to Modify (Option A - Full Refactor, if chosen)

Core changes:
1. `src/core/canonical-types.ts` - Change type definition, PAYLOAD_STRIDE, strideOf(), ALLOWED_UNITS, etc.

Files using ConcretePayloadType (need comparison updates):
2. `src/compiler/ir/bridges.ts`
3. `src/compiler/ir/signalExpr.ts`
4. `src/compiler/passes-v2/pass1-type-constraints.ts`
5. `src/ui/reactFlowEditor/typeValidation.ts`
6. `src/ui/debug-viz/types.ts`

Files using strideOf (may work unchanged if strideOf signature preserved):
7. All 22 files with strideOf() calls (~110 call sites)
