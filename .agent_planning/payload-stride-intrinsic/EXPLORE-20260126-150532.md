# Exploration: payload-stride-intrinsic
Timestamp: 2026-01-26-150532

## Raw Exploration Output

### Test Results
- All 103 test files pass
- 1631 tests passed, 5 skipped
- Duration: 16.60s

### ConcretePayloadType Usages (6 files)

1. **src/core/canonical-types.ts** (definition + utilities)
   - Line 157-165: Type definition (string union)
   - Line 223-232: PAYLOAD_STRIDE lookup table
   - Line 241-247: strideOf() function
   - Line 96: ALLOWED_UNITS record
   - Line 199: isConcretePayload() guard

2. **src/compiler/ir/bridges.ts** (casting)
   - Line 25: Import
   - Line 208: Cast `as ConcretePayloadType`

3. **src/compiler/ir/signalExpr.ts** (casting)
   - Line 7: Import
   - Line 28: Cast `as ConcretePayloadType`

4. **src/compiler/passes-v2/pass1-type-constraints.ts** (type inference)
   - Line 17: Import
   - Line 137: Cast `as ConcretePayloadType`
   - Line 475: Cast `as ConcretePayloadType`

5. **src/ui/reactFlowEditor/typeValidation.ts** (UI colors)
   - Line 9: Import
   - Line 21: TYPE_COLORS record
   - Line 41: Cast `as ConcretePayloadType`

6. **src/ui/debug-viz/types.ts** (debug display)
   - Line 8: Import
   - Line 92: Cast `as ConcretePayloadType`

### strideOf() Call Sites (22 files, ~110 call sites)

Heavy users (most calls in block lowering):
- src/blocks/math-blocks.ts (18 calls)
- src/blocks/field-operations-blocks.ts (28 calls)
- src/blocks/adapter-blocks.ts (12 calls)
- src/blocks/signal-blocks.ts (10 calls)
- src/blocks/geometry-blocks.ts (4 calls)
- src/blocks/color-blocks.ts (4 calls)
- src/blocks/instance-blocks.ts (4 calls)
- src/blocks/path-blocks.ts (4 calls)
- src/blocks/time-blocks.ts (6 calls)
- src/blocks/io-blocks.ts (2 calls)

All call sites follow identical pattern:
```typescript
stride: strideOf(outType.payload)
```

### Critical Bug Location

**File:** src/runtime/ContinuityApply.ts
**Line:** 321

```typescript
const stride = semantic === 'position' ? 2 : 1;
```

This hardcoded heuristic:
- Assumes position is vec2 (stride=2), everything else is float (stride=1)
- Breaks for: vec3 (stride=3), color (stride=4), shape (stride=8)
- The `semantic` field comes from StepContinuityApply type which has 5 values:
  - 'position' | 'radius' | 'opacity' | 'color' | 'custom'
- But stride should be derived from payload type, NOT semantic

### Test That Encodes The Bug

**File:** src/projection/__tests__/level9-continuity-decoupling.test.ts
**Lines:** 52-53, 75

```typescript
// Test 1: The key line: const stride = semantic === 'position' ? 2 : 1;
expect(source).toMatch(/const stride = semantic === 'position' \? 2 : 1/);
```

This test asserts the bug exists! It was written as a verification test for "continuity operates on world-space" but inadvertently locks in the incorrect stride calculation.

### StepContinuityApply Definition

**File:** src/compiler/ir/types.ts
**Lines:** 530-538

```typescript
export interface StepContinuityApply {
  readonly kind: 'continuityApply';
  readonly targetKey: string;
  readonly instanceId: string;
  readonly policy: ContinuityPolicy;
  readonly baseSlot: ValueSlot;
  readonly outputSlot: ValueSlot;
  readonly semantic: 'position' | 'radius' | 'opacity' | 'color' | 'custom';
}
```

Note: No payload type or stride information available at runtime. The compiler knows the payload type when creating this step, but doesn't pass it through.

### Where StepContinuityApply is Created

**File:** src/compiler/passes-v2/pass7-schedule.ts
**Lines:** 313-321

The compiler has access to field type information when creating the step, but doesn't include stride:

```typescript
continuityApplySteps.push({
  kind: 'continuityApply',
  targetKey,
  instanceId,
  policy,
  baseSlot,
  outputSlot,
  semantic,  // Only semantic, no stride!
});
```

### PAYLOAD_STRIDE Table

```typescript
export const PAYLOAD_STRIDE: Record<ConcretePayloadType, number> = {
  float: 1,
  int: 1,
  bool: 1,
  vec2: 2,
  vec3: 3,
  color: 4,
  shape: 8,
  cameraProjection: 1,
};
```
