# Definition of Done: Rails Foundation Sprint

**Timestamp**: 2026-01-09T07:35:00Z
**Sprint ID**: SPRINT-RAILS-001

---

## Overall Sprint DoD

- [ ] All P0, P1, P2 work items complete
- [ ] All existing tests pass (`npm run test`)
- [ ] TypeScript compiles without errors (`npm run typecheck`)
- [ ] No spec violations introduced
- [ ] Implementation matches spec in `design-docs/CANONICAL-oscilla-v2.5-20260109/topics/`

---

## P0: BlockRole & DerivedBlockMeta Types

### Acceptance Criteria

- [ ] `BlockRole` type defined with `kind: "user"` and `kind: "derived"` branches
- [ ] `DerivedBlockMeta` type defined with all 5 variants:
  - `defaultSource`, `wireState`, `bus`, `rail`, `lens`
- [ ] `EdgeRole` type defined with 4 variants:
  - `user`, `default`, `busTap`, `auto`
- [ ] All discriminators use `kind` property (not `type`)
- [ ] No optional fields in meta types
- [ ] Types exported from `src/types/index.ts`
- [ ] `npm run typecheck` passes

### Verification Steps

1. Run `npm run typecheck`
2. Create test type instantiations in a scratch file
3. Verify exhaustive pattern matching works

---

## P1: TimeRoot Output Corrections

### Acceptance Criteria

**InfiniteTimeRoot**:
- [ ] Output `tMs` exists (int, not float)
- [ ] Output `phaseA` exists (renamed from `phase`)
- [ ] Output `phaseB` exists (new, different period)
- [ ] Output `pulse` exists (discrete temporality)
- [ ] Output `palette` exists (color)
- [ ] Output `energy` exists (float, kept)
- [ ] `dt` output removed or renamed to `dtMs`

**FiniteTimeRoot**:
- [ ] Same as InfiniteTimeRoot PLUS:
- [ ] Output `progress` exists (unit, 0-1 over duration)

**Type Correctness**:
- [ ] `tMs` uses `int` payload type
- [ ] `pulse` uses discrete temporality (`signalTypeTrigger()`)
- [ ] `palette` uses `color` payload type
- [ ] `eventType()` helper fixed to use `signalTypeTrigger()`

**Tests**:
- [ ] Update existing tests to use new output names
- [ ] All tests pass after rename

### Verification Steps

1. Run `npm run test`
2. Check `compile.test.ts` wires use `phaseA` not `phase`
3. Inspect compiled output for correct signal types

---

## P2: Rail Blocks & Normalization Injection

### Acceptance Criteria

**Rail Block Definitions**:
- [ ] `TimeRail` block registered
- [ ] `PhaseARail` block registered
- [ ] `PhaseBRail` block registered
- [ ] `PulseRail` block registered
- [ ] `PaletteRail` block registered
- [ ] `EnergyRail` block registered
- [ ] All rails are pass-through (input -> output)
- [ ] All rails have correct SignalType for output

**Normalization**:
- [ ] `normalize()` injects 6 rail blocks into output
- [ ] Rails appear in `NormalizedPatch.blocks`
- [ ] Rails are wired to TimeRoot outputs
- [ ] Existing normalization behavior preserved (block indexing, edge validation)

**Role Metadata** (if Block type updated):
- [ ] Rail blocks have `role.kind === 'derived'`
- [ ] Rail blocks have `role.meta.kind === 'rail'`
- [ ] Rail blocks have `role.meta.target.busId` matching rail name

### Verification Steps

1. Run `npm run test`
2. Add test: normalize patch, verify 6 rail blocks exist
3. Add test: rail blocks are connected to TimeRoot
4. Verify no regressions in existing compiler tests

---

## Quality Gates

### Must Pass

- [ ] `npm run typecheck` - No TypeScript errors
- [ ] `npm run test` - All tests pass
- [ ] `npm run build` - Build succeeds

### Should Pass

- [ ] Test coverage for new rail blocks
- [ ] Test coverage for normalization injection
- [ ] No console warnings or errors

---

## Out of Scope Verification

Verify these are NOT implemented:

- [ ] No BusBlock implementation
- [ ] No multi-writer combine logic
- [ ] No DefaultSource injection
- [ ] No EdgeRole enforcement at runtime
