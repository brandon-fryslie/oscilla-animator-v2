# Implementation Context: Rails Foundation Sprint

**Timestamp**: 2026-01-09T07:35:00Z
**Sprint ID**: SPRINT-RAILS-001

---

## Existing File Locations

### Core Type Definitions

| File | Purpose | Relevance |
|------|---------|-----------|
| `src/types/index.ts` | Central type re-exports | **ADD BlockRole, EdgeRole types here** |
| `src/core/canonical-types.ts` | SignalType 5-axis system | Reference for type patterns |
| `src/graph/Patch.ts` | Block, Edge, Patch interfaces | May need role field added to Block |

### TimeRoot Blocks

| File | Purpose | Relevance |
|------|---------|-----------|
| `src/compiler/blocks/time/InfiniteTimeRoot.ts` | Infinite time source | **MODIFY outputs** |
| `src/compiler/blocks/time/index.ts` | Time block exports | Add rail imports |

### Block Registry

| File | Purpose | Relevance |
|------|---------|-----------|
| `src/compiler/blocks/registry.ts` | Block registration pattern | **PATTERN TO FOLLOW + FIX eventType()** |
| `src/compiler/blocks/index.ts` | All block imports | Add rail imports |

### Normalization

| File | Purpose | Relevance |
|------|---------|-----------|
| `src/graph/normalize.ts` | Graph normalization | **MODIFY to inject rails** |

### Tests

| File | Purpose | Relevance |
|------|---------|-----------|
| `src/compiler/__tests__/compile.test.ts` | Compiler tests | **UPDATE wire references** |
| `src/core/__tests__/canonical-types.test.ts` | Type system tests | Pattern reference |

---

## Type Definitions to Add

### Add to `src/types/index.ts`

```typescript
// =============================================================================
// Block Roles (from spec 02-block-system.md)
// =============================================================================

/**
 * Every block has an explicit role declaration.
 * Roles exist for the editor, not the compiler.
 */
export type BlockRole =
  | { readonly kind: "user" }
  | { readonly kind: "derived"; readonly meta: DerivedBlockMeta };

/**
 * Metadata for derived blocks specifying their purpose.
 */
export type DerivedBlockMeta =
  | { readonly kind: "defaultSource"; readonly target: { readonly kind: "port"; readonly port: PortRef } }
  | { readonly kind: "wireState";     readonly target: { readonly kind: "wire"; readonly wire: WireId } }
  | { readonly kind: "bus";           readonly target: { readonly kind: "bus"; readonly busId: BusId } }
  | { readonly kind: "rail";          readonly target: { readonly kind: "bus"; readonly busId: BusId } }
  | { readonly kind: "lens";          readonly target: { readonly kind: "node"; readonly node: NodeRef } };

/**
 * Wire identifier (for wireState targeting).
 */
export type WireId = string & { readonly __brand: 'WireId' };

/**
 * Node reference (for lens targeting).
 */
export interface NodeRef {
  readonly kind: 'node';
  readonly id: string;
}

// =============================================================================
// Edge Roles (from spec 02-block-system.md)
// =============================================================================

/**
 * Every edge has an explicit role declaration.
 */
export type EdgeRole =
  | { readonly kind: "user" }
  | { readonly kind: "default"; readonly meta: { readonly defaultSourceBlockId: BlockId } }
  | { readonly kind: "busTap";  readonly meta: { readonly busId: BusId } }
  | { readonly kind: "auto";    readonly meta: { readonly reason: "portMoved" | "rehydrate" | "migrate" } };

// =============================================================================
// Rail IDs (MVP rail identifiers)
// =============================================================================

export type RailId =
  | 'time'
  | 'phaseA'
  | 'phaseB'
  | 'pulse'
  | 'palette'
  | 'energy';
```

---

## Block Registry Pattern

### Pattern to Follow (from `registry.ts`)

```typescript
import {
  registerBlock,
  portId,
  sigType,
  type BlockLower,
} from '../registry';

const lowerMyBlock: BlockLower = ({ b, config, inputsById }) => {
  // 1. Extract inputs
  const myInput = sig(inputsById, 'myInput');

  // 2. Create IR expressions
  const result = b.sigConst(42, sigType('float'));

  // 3. Return outputs keyed by port ID
  return {
    out: { kind: 'sig', id: result, type: sigType('float') },
  };
};

registerBlock({
  kind: 'MyBlock',
  inputs: [
    { portId: portId('myInput'), type: sigType('float') },
  ],
  outputs: [
    { portId: portId('out'), type: sigType('float') },
  ],
  lower: lowerMyBlock,
});
```

---

## SignalType Helpers

### From `canonical-types.ts`

```typescript
// Use these for correct types:

// Signal (one + continuous)
signalTypeSignal('float')   // one + continuous + float
signalTypeSignal('int')     // one + continuous + int
signalTypeSignal('phase')   // one + continuous + phase
signalTypeSignal('color')   // one + continuous + color

// Trigger/Event (one + discrete)
signalTypeTrigger('unit')   // one + discrete + unit

// Static (zero + continuous)
signalTypeStatic('float')   // zero + continuous + float
```

### From `registry.ts` (convenience wrappers)

```typescript
sigType('float')   // -> signalTypeSignal('float')
sigType('int')     // -> signalTypeSignal('int')
sigType('phase')   // -> signalTypeSignal('phase')
sigType('color')   // -> signalTypeSignal('color')

// BROKEN - needs fix:
eventType('unit')  // -> signalTypeSignal('unit') <- WRONG, should use signalTypeTrigger
```

### Fix Required for `eventType()`

In `src/compiler/blocks/registry.ts`, change:
```typescript
export function eventType(payload: PayloadType = 'float'): SignalType {
  return signalTypeTrigger(payload);  // Was: signalTypeSignal(payload)
}
```

---

## TimeRoot Output Changes

### Current Output Structure (InfiniteTimeRoot)

```typescript
// CURRENT (wrong):
outputs: [
  { portId: portId('t'), type: sigType('float') },      // Wrong name, wrong type
  { portId: portId('dt'), type: sigType('float') },
  { portId: portId('phase'), type: sigType('phase') },  // Wrong name
  { portId: portId('pulse'), type: eventType('float') }, // Wrong temporality
  { portId: portId('energy'), type: sigType('float') },
],
```

### Target Output Structure (InfiniteTimeRoot)

```typescript
// TARGET (correct):
outputs: [
  { portId: portId('tMs'), type: sigType('int') },        // Renamed, int type
  { portId: portId('dtMs'), type: sigType('int') },       // Renamed
  { portId: portId('phaseA'), type: sigType('phase') },   // Renamed
  { portId: portId('phaseB'), type: sigType('phase') },   // New
  { portId: portId('pulse'), type: signalTypeTrigger('unit') }, // Discrete
  { portId: portId('palette'), type: sigType('color') },  // New
  { portId: portId('energy'), type: sigType('float') },   // Kept
],
```

## Palette Implementation

Palette is the chromatic reference frame - a time-indexed color signal.

For MVP, use HSV rainbow:
```typescript
// palette = HSV(phaseA, 1.0, 0.5) -> RGB color
const paletteHue = sig(inputsById, 'phaseA'); // or reference phase accumulator
const paletteColor = b.hsv2rgb(paletteHue, b.sigConst(1.0), b.sigConst(0.5));
return { palette: paletteColor };
```

---

## Rail Block Template

### Create: `src/compiler/blocks/time/rails/TimeRail.ts`

```typescript
import {
  registerBlock,
  portId,
  sigType,
  sig,
  type BlockLower,
} from '../../registry';

const lowerTimeRail: BlockLower = ({ inputsById }) => {
  const input = sig(inputsById, 'in');
  return { out: input }; // Pass-through
};

registerBlock({
  kind: 'TimeRail',
  inputs: [
    { portId: portId('in'), type: sigType('int') },
  ],
  outputs: [
    { portId: portId('out'), type: sigType('int') },
  ],
  lower: lowerTimeRail,
});
```

### Rail Directory Structure

```
src/compiler/blocks/time/
├── index.ts              # Add rail imports
├── InfiniteTimeRoot.ts
└── rails/
    ├── index.ts          # Export all rails
    ├── TimeRail.ts
    ├── PhaseARail.ts
    ├── PhaseBRail.ts
    ├── PulseRail.ts
    ├── PaletteRail.ts
    └── EnergyRail.ts
```

---

## Normalization Changes

### Current Structure (`normalize.ts`)

```typescript
export function normalize(patch: Patch): NormalizeResult | NormalizeError {
  // 1. Build block index map
  // 2. Sort blocks by ID for deterministic ordering
  // 3. Normalize edges
  // 4. Return NormalizedPatch
}
```

### Target Structure

```typescript
export function normalize(patch: Patch): NormalizeResult | NormalizeError {
  // 1. Find or inject TimeRoot
  // 2. Inject 6 rail blocks
  // 3. Wire rails to TimeRoot
  // 4. Build block index map (including rails)
  // 5. Sort blocks by ID for deterministic ordering
  // 6. Normalize edges (including rail wires)
  // 7. Return NormalizedPatch
}
```

### Injection Logic

```typescript
function injectRails(blocks: Map<BlockId, Block>, edges: Edge[]): { blocks: Map<BlockId, Block>, edges: Edge[] } {
  // Find TimeRoot
  const timeRoot = [...blocks.values()].find(b =>
    b.type === 'InfiniteTimeRoot'
  );

  if (!timeRoot) return { blocks, edges }; // Error handled elsewhere

  const newBlocks = new Map(blocks);
  const newEdges = [...edges];

  const railDefs: Array<{ id: RailId, type: string, inputType: SignalType, sourcePort: string }> = [
    { id: 'time', type: 'TimeRail', inputType: sigType('int'), sourcePort: 'tMs' },
    { id: 'phaseA', type: 'PhaseARail', inputType: sigType('phase'), sourcePort: 'phaseA' },
    { id: 'phaseB', type: 'PhaseBRail', inputType: sigType('phase'), sourcePort: 'phaseB' },
    { id: 'pulse', type: 'PulseRail', inputType: signalTypeTrigger('unit'), sourcePort: 'pulse' },
    { id: 'palette', type: 'PaletteRail', inputType: sigType('color'), sourcePort: 'palette' },
    { id: 'energy', type: 'EnergyRail', inputType: sigType('float'), sourcePort: 'energy' },
  ];

  for (const rail of railDefs) {
    const railBlockId = `__rail_${rail.id}__` as BlockId;

    newBlocks.set(railBlockId, {
      id: railBlockId,
      type: rail.type,
      params: {},
      // role: { kind: 'derived', meta: { kind: 'rail', target: { kind: 'bus', busId: rail.id } } }
    });

    newEdges.push({
      id: `__rail_edge_${rail.id}__`,
      from: { kind: 'port', blockId: timeRoot.id, slotId: rail.sourcePort },
      to: { kind: 'port', blockId: railBlockId, slotId: 'in' },
    });
  }

  return { blocks: newBlocks, edges: newEdges };
}
```

---

## Test Updates Required

### `compile.test.ts` - Wire Reference Updates

```typescript
// BEFORE:
b.wire(time, 'phase', osc, 'phase');

// AFTER:
b.wire(time, 'phaseA', osc, 'phase');
```

```typescript
// BEFORE:
b.wire(time, 't', ...)

// AFTER:
b.wire(time, 'tMs', ...)
```

---

## Spec References

| Document | Location | Relevance |
|----------|----------|-----------|
| Block System | `design-docs/CANONICAL-oscilla-v2.5-20260109/topics/02-block-system.md` | BlockRole, DerivedBlockMeta, Rail definitions |
| Time System | `design-docs/CANONICAL-oscilla-v2.5-20260109/topics/03-time-system.md` | TimeRoot outputs, Rail types |
| Block Edge Roles | `design-docs/final-System-Invariants/15-Block-Edge-Roles.md` | Detailed role invariants |
| Palette | `design-docs/final-System-Invariants/Palette.md` | Palette as chromatic reference frame |
| Rail | `design-docs/final-System-Invariants/Rail.md` | Rail definition |

---

## Critical Files Summary

1. **`src/types/index.ts`** - Add BlockRole, EdgeRole, DerivedBlockMeta types (P0)

2. **`src/compiler/blocks/time/InfiniteTimeRoot.ts`** - Fix output names/types, add palette/phaseB (P1)

4. **`src/compiler/blocks/registry.ts`** - Fix `eventType()` helper (P1)

5. **`src/compiler/blocks/time/rails/`** - New directory with 6 rail blocks (P2)

6. **`src/graph/normalize.ts`** - Add rail injection logic (P2)

7. **`src/compiler/__tests__/compile.test.ts`** - Update wire references (P1)
