# BUSES AND RAILS IMPLEMENTATION EVALUATION

**Evaluation Date**: 2026-01-09T07:12:00Z
**Status**: CONTINUE (major gaps but no blockers to planning)

---

## EXECUTIVE SUMMARY

The buses and rails infrastructure is **partially implemented** with significant gaps:

**Implemented**:
- TimeRoot block (InfiniteTimeRoot)
- IR builder foundations with time model support
- Canonical 5-axis type system (SignalType)
- Block registry pattern

**Missing / Incomplete**:
- BlockRole and DerivedBlockMeta types (spec-required discriminated unions)
- BusBlock and RailBlock implementations
- Rail creation during normalization (time, phaseA, phaseB, pulse, palette)
- Bus/rail handling in GraphNormalization
- Edge roles (user, default, busTap, auto)
- Multi-writer input resolution for buses
- Combine policy type system

---

## DETAILED FINDINGS

### 1. BLOCKREOLE AND DERIVEDBLOCKMETA TYPES

**Status**: NOT IMPLEMENTED

**What's Missing**:
```typescript
// From spec (02-block-system.md):
type BlockRole =
  | { kind: "user" }
  | { kind: "derived"; meta: DerivedBlockMeta };

type DerivedBlockMeta =
  | { kind: "defaultSource"; target: { kind: "port"; port: PortRef } }
  | { kind: "wireState";     target: { kind: "wire"; wire: WireId } }
  | { kind: "bus";           target: { kind: "bus"; busId: BusId } }
  | { kind: "rail";          target: { kind: "bus"; busId: BusId } }
  | { kind: "lens";          target: { kind: "node"; node: NodeRef } };
```

**Current State**:
- `src/graph/Patch.ts` defines `Block` with only `id`, `type`, and `params`
- No `role` property exists on Block
- No BlockRole or DerivedBlockMeta types found in codebase

**Impact**: Violates Invariant I6 (Compiler never mutates graph) and core architectural principle that "every block has an explicit role declaration."

**Risk**: HIGH - Without roles, the system cannot distinguish user-created from system-derived blocks, breaking undo/redo, persistence, and editor UI filtering.

---

### 2. TIMEROOT BLOCK IMPLEMENTATION

**Status**: PARTIAL - Structure exists, but incomplete

**What Exists**:
- `src/compiler/blocks/time/InfiniteTimeRoot.ts` - Registered block with outputs: t, dt, phase, pulse, energy
- Both use IR builder to emit time expressions

**Specification Gaps**:

1. **Output Names Wrong**:
   - Spec says: `tMs` (milliseconds), `phaseA`, `phaseB`, `progress`, `pulse`, `palette`
   - Implementation has: `t` (floats, not ms), `dt`, `phase` (not phaseA/B), missing `palette` rail entirely
   - Energy is present but not in spec

2. **Signal Type Mismatches**:
   - Spec: `tMs` should be `one + continuous + int`
   - Implementation: Uses `float` for time (via `b.sigTime('t')`)
   - Spec: `phase` should be `one + continuous + phase` (PayloadType)
   - Implementation: Uses generic `phase` type without payload specification

3. **Missing Palette Rail**:
   - Spec 03-time-system.md: "Palette rail...provides default color atmosphere"
   - Implementation: No palette output
   - Status: NOT IMPLEMENTED

4. **Single TimeRoot Per Patch**:
   - Spec: "Exactly one per patch. System-managed - not user-placeable"
   - Implementation: No enforcement mechanism
   - No automatic injection during normalization

**Code Location**: `/Users/bmf/code/oscilla-animator-v2/src/compiler/blocks/time/`

---

### 3. RAILS (SYSTEM-PROVIDED BUSES)

**Status**: NOT IMPLEMENTED

**Spec Requirements** (03-time-system.md):

MVP Rails that must exist in every patch:
| Rail | Output Type | Source |
|------|-------------|--------|
| `time` | `one + continuous + int` | TimeRoot.tMs |
| `phaseA` | `one + continuous + phase` | TimeRoot.phaseA |
| `phaseB` | `one + continuous + phase` | TimeRoot.phaseB |
| `pulse` | `one + discrete + unit` | TimeRoot.pulse |
| `palette` | `one + continuous + color` | System color reference |

Rails are blocks with role:
```typescript
{
  kind: 'derived',
  meta: { kind: 'rail', target: { kind: 'bus', busId: 'time' } }
}
```

**Current Implementation**:
- No rail blocks exist
- No automatic rail creation in normalization
- No rail block definitions in registry
- No way to reference time/phaseA/phaseB/pulse/palette globally

**Missing Pieces**:
1. RailBlock definitions (5 blocks minimum)
2. GraphNormalization logic to inject rails into every patch
3. Rail output port definitions (matching TimeRoot outputs)
4. Palette color cycle generation
5. Rail invariant validation

**Risk**: CRITICAL - Without rails, the fundamental modulation signal structure is missing. No patches can express time-based animation.

---

### 4. BUSBLOCK IMPLEMENTATION

**Status**: NOT IMPLEMENTED

**Spec Requirements** (03-buses.md, 02-block-system.md):

BusBlock structure:
```typescript
// A bus is represented as a BusBlock with globally addressable busId
{
  id: 'colorBus',  // user-created
  kind: 'BusBlock',
  role: {
    kind: 'derived',
    meta: { kind: 'bus', target: { kind: 'bus', busId: 'colorBus' } }
  },
  inputs: [{ id: 'in', combine: CombineMode }],  // multi-writer
  outputs: [{ id: 'out' }]
}
```

**Current State**:
- No BusBlock type in block registry
- No bus creation mechanism
- No multi-writer input handling for buses
- `resolveWriters.ts` mentions BusBlock but doesn't implement it

**From resolveWriters.ts**:
```typescript
// Line 44: "This includes BusBlock.out edges and DSConst.out edges"
// But no code actually materializes BusBlock.out edges
```

**Missing**:
1. BusBlock definition and registration
2. Bus IDs and bus indexing system
3. Multi-writer input combine modes for buses
4. Bus creation from UI (would be in editor, not in this codebase)
5. Bus-to-block edge rewriting (bus publish/subscribe ‚Üí wires)

---

### 5. BLOCKEDGE ROLES

**Status**: NOT IMPLEMENTED

**Spec Requires** (02-block-system.md):
```typescript
type EdgeRole =
  | { kind: "user" }
  | { kind: "default"; meta: { defaultSourceBlockId: BlockId } }
  | { kind: "busTap";  meta: { busId: BusId } }
  | { kind: "auto";    meta: { reason: "portMoved" | "rehydrate" | "migrate" } };
```

**Current State** (src/graph/Patch.ts):
```typescript
interface Edge {
  id: string;
  from: Endpoint;
  to: Endpoint;
  enabled?: boolean;
  sortKey?: number;  // Only property related to ordering
}
```

**Missing**:
1. Edge role discrimination
2. Default edge metadata (for defaultSource tracking)
3. BusTap role (for bus connection UI tracking)
4. Auto role for editor-maintained edges

**Impact**: Violates Invariant 5 (Role invariants are validatable) - no way to validate which edges are maintained by editor vs. user-created.

---

### 6. MULTI-WRITER INPUTS AND COMBINE MODES

**Status**: PARTIALLY SPECIFIED, NOT INTEGRATED

**What Exists**:
- `src/compiler/passes-v2/combine-utils.ts` - Defines CombinePolicy type
- `src/compiler/passes-v2/resolveWriters.ts` - Writer enumeration and sorting
- Deterministic ordering implemented with writerSortKey()

**What's Missing**:
1. **CombineMode not in main types**: Defined in types/index.ts as simple string union, not fully spec-compliant:
   ```typescript
   // Current:
   type CombineMode = 'last' | 'first' | 'sum' | 'average' | 'max' | 'min';

   // Spec (03-buses.md):
   type CombineMode =
     | 'sum' | 'average' | 'min' | 'max' | 'mul'
     | 'last' | 'first' | 'layer'
     | 'or' | 'and'
     | { kind: 'custom'; id: string };
   ```

2. **CombinePolicy**: Lives in passes-v2 (WIP code), not main system
3. **Default source insertion**: Comment says DSConst blocks should be materialized by GraphNormalizer, but:
   - No DefaultSource block implementation
   - No normalization step that creates DSConst blocks
   - No integration with actual graph construction

4. **Bus combine behavior**: Spec says BusBlock input has CombineMode parameter, but:
   - No BusBlock definition to carry this
   - No per-port combine mode configuration

---

### 7. GRAPH NORMALIZATION

**Status**: MINIMAL

**Current Implementation** (src/graph/normalize.ts):
- Only does block indexing and edge validation
- No bus/rail creation
- No default source injection
- No role assignment
- ~130 lines of code

**Spec Requirements** (16-Graph-Normalization.md):
1. **Inject Rails**: Create 5 rail blocks (time, phaseA, phaseB, pulse, palette)
2. **Inject TimeRoot**: Create one TimeRoot block (kind depends on patch configuration)
3. **Inject DefaultSource blocks**: For each unconnected input
4. **Rewrite Bus Edges**: Convert publish/subscribe UI to block edges
5. **Assign Roles**: Mark blocks and edges with their roles
6. **Validate Invariants**: Check that all blocks have roles, all inputs have sources, etc.

**Missing All of Above**

---

### 8. TYPE SYSTEM ALIGNMENT

**Status**: TWO PARALLEL SYSTEMS, NOT UNIFIED

**System 1 - Old TypeDesc** (`src/core/types.ts`):
```typescript
interface TypeDesc {
  world: TypeWorld;  // 'signal' | 'field' | 'scalar' | 'event' | 'config'
  domain: Domain;    // String union of 80+ types
  category: TypeCategory;  // 'core' | 'internal'
  busEligible: boolean;
  lanes?: number[];
  semantics?: string;
}
```

**System 2 - New Canonical SignalType** (`src/core/canonical-types.ts`):
```typescript
interface SignalType {
  payload: PayloadType;  // 'float' | 'int' | 'vec2' | 'color' | 'phase' | 'bool' | 'unit'
  extent: {
    cardinality: Cardinality;      // zero | one | many(domain)
    temporality: Temporality;      // continuous | discrete
    binding: AxisTag<Binding>;     // default | instantiated
    perspective: AxisTag<Perspective>;
    branch: AxisTag<Branch>;
  }
}
```

**Issue**:
- TimeRoo blocks registered with SignalType (canonical)
- Most of compiler uses TypeDesc (old)
- No bridge/adapter between systems
- Pass 2 has comments about handling both but doesn't fully implement it

---

### 9. PALETTE RAIL

**Status**: NOT IMPLEMENTED

**Spec** (03-time-system.md):
- "Palette rail is the chromatic reference frame"
- "Exists whether or not the patch references it"
- "Default value is a smooth color cycle"
- "Can be overridden by connecting to it"
- Output type: `one + continuous + color`

**Current**:
- No palette generation
- No palette rail block
- No color cycle algorithm

---

## DEPENDENCY AND RISK ANALYSIS

### Critical Path Dependencies

```
1. BlockRole + DerivedBlockMeta types
   ‚Üì
2. Block definition updates (add role field)
   ‚Üì
3. RailBlock definitions (5 blocks)
   ‚îú‚Üí Palette color cycle generation
   ‚îî‚Üí TimeRoot fixes (correct output names, types)
   ‚Üì
4. GraphNormalization enhancements
   ‚îú‚Üí Auto-inject TimeRoot
   ‚îú‚Üí Auto-inject 5 rails
   ‚îú‚Üí Auto-inject DefaultSource blocks
   ‚îî‚Üí Assign roles to all blocks/edges
   ‚Üì
5. BusBlock definition
   ‚îú‚Üí BusId type and indexing
   ‚îî‚Üí CombineMode for inputs
   ‚Üì
6. Test coverage for all above
```

### Blockage Points

1. **Type System**: SignalType vs TypeDesc mismatch blocks full canonical implementation
2. **Block Role Types**: Missing types block normalization logic
3. **Palette Generation**: No algorithm defined in spec for "smooth color cycle"

---

## SPECIFICATION AMBIGUITIES

1. **Palette Default Cycle**: Spec says "smooth color cycle" but doesn't define:
   - HSV rainbow? RGB gradient?
   - Duration? (tied to phaseA?)
   - Static pattern or computed?

2. **Rail Inputs**: Spec says "Rails can have inputs overridden and be driven by feedback" but:
   - How are override inputs connected?
   - What's the combine mode for rail inputs?
   - Can you connect to timeRoot.tMs directly or must you go through time rail?

3. **Energy Rail**: Mentioned in passes but not in canonical spec:
   - Is it MVP or future?
   - What's the output signal type?
   - How is it computed?

4. **Discrete Pulse**: Spec says `pulse: one + discrete + unit` but:
   - When does pulse fire? (phase wrap? frame tick? both?)

---

## SUMMARY TABLE

| Component | Status | Spec Match | Implementation                         |
|-----------|--------|-----------|----------------------------------------|
| BlockRole | ‚ùå MISSING | 02-block-system | None                                   |
| DerivedBlockMeta | ‚ùå MISSING | 02-block-system | None                                   |
| TimeRoot blocks | üü° PARTIAL | 03-time-system | InfiniteTimeRoot                       |
| Rails (5 blocks) | ‚ùå MISSING | 03-time-system | None                                   |
| Palette rail | ‚ùå MISSING | 03-time-system | None                                   |
| BusBlock | ‚ùå MISSING | 03-buses | None                                   |
| MultiWriter inputs | üü° PARTIAL | 03-buses | resolveWriters.ts but no integration   |
| CombineMode | üü° PARTIAL | 03-buses | Incomplete type, no custom support     |
| GraphNormalization | üü° MINIMAL | 16-Graph-Normalization | Basic structure only                   |
| EdgeRole | ‚ùå MISSING | 02-block-system | None                                   |
| Default sources | ‚ùå MISSING | 02-block-system | Mentioned but not implemented          |
| Type system | üü° DUAL | 01-type-system | SignalType + TypeDesc (not integrated) |
