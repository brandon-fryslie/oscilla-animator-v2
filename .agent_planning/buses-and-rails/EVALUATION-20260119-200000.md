# Evaluation: Simplified Default Sources & TimeRoot

**Generated**: 2026-01-19T20:00:00Z
**Topic**: buses-and-rails (simplified)
**Verdict**: CONTINUE - clear path, HIGH confidence

---

## Context Change

User discussion simplified the scope:
1. **No separate rail blocks** - TimeRoot outputs ARE the rails
2. **Unified DefaultSource type** - All defaults reference block outputs
3. **TimeRoot is special** - Always exists, immovable, special UI
4. **No 'none' option** - Every input MUST have a default source

---

## Current State

### DefaultSource Type (src/types/index.ts:208-211)
```typescript
export type DefaultSource =
  | { readonly kind: 'rail'; readonly railId: string }
  | { readonly kind: 'constant'; readonly value: unknown }
  | { readonly kind: 'none' };
```

### Usage in Codebase

| Pattern | Files | Count |
|---------|-------|-------|
| `defaultSourceConstant(value)` | primitive-blocks, array-blocks, render-blocks, etc. | ~20 uses |
| `defaultSourceRail('phaseA')` | field-operations-blocks.ts | 3 uses |
| `defaultSourceNone()` | array-blocks.ts | 1 use |

### pass1-default-sources.ts

Currently handles `{ kind: 'constant' }` only:
- Creates Const blocks for constant defaults
- Has TODO at line 97: "Handle 'rail' kind for phaseA/phaseB etc."
- Does NOT handle 'none' (port stays unconnected)

---

## Proposed Model

### New DefaultSource Type
```typescript
export type DefaultSource = {
  readonly blockType: string;
  readonly output: string;
  readonly params?: Record<string, unknown>;
};
```

### Semantics
- **TimeRoot outputs**: `{ blockType: 'TimeRoot', output: 'phaseA' }` → wire to existing TimeRoot
- **Block instances**: `{ blockType: 'Const', output: 'out', params: { value: 0.5 } }` → create derived block

### Helper Functions
```typescript
// Replace defaultSourceConstant
export function defaultSource(blockType: string, output: string, params?: Record<string, unknown>): DefaultSource {
  return { blockType, output, params };
}

// Convenience for constants (most common case)
export function defaultSourceConst(value: unknown): DefaultSource {
  return { blockType: 'Const', output: 'out', params: { value } };
}

// Convenience for TimeRoot outputs
export function defaultSourceTimeRoot(output: 'tMs' | 'phaseA' | 'phaseB' | 'pulse' | 'palette' | 'energy'): DefaultSource {
  return { blockType: 'TimeRoot', output };
}
```

---

## Work Required

### 1. Type System Changes
- Update `DefaultSource` type in `src/types/index.ts`
- Update helper functions
- Remove `defaultSourceNone()`, `defaultSourceRail()`

### 2. Block Definition Updates
- Update ~20 uses of `defaultSourceConstant()` → `defaultSourceConst()`
- Update 3 uses of `defaultSourceRail('phaseA')` → `defaultSourceTimeRoot('phaseA')`
- Fix 1 use of `defaultSourceNone()` → provide actual default

### 3. pass1-default-sources.ts
- Handle TimeRoot specially (wire to existing block)
- Handle other blocks (create derived instance)
- Remove TODO comment

### 4. TimeRoot Outputs (optional for this sprint)
- Add pulse, palette, energy outputs to time-blocks.ts
- These don't block the DefaultSource work

---

## Dependencies

None - this is a standalone refactor.

---

## Risks

### 1. Breaking Existing Patches
**Risk**: Saved patches may reference old DefaultSource shape
**Mitigation**: DefaultSource is internal, not serialized in patches

### 2. Missing Default for 'none' Case
**Risk**: array-blocks.ts has `defaultSourceNone()` for 'element' input
**Mitigation**: Need to decide what default makes sense (likely a Const block with appropriate value)

---

## Confidence: HIGH

All changes are well-defined:
- Type change is mechanical
- Helper function updates are grep+replace
- pass1-default-sources logic is clear
- No architectural unknowns
