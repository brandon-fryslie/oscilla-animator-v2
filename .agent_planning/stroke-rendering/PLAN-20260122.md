# Sprint Plan: Stroke Rendering in DrawPathInstancesOp

**Generated**: 2026-01-22
**Bead ID**: oscilla-animator-v2-02h
**Confidence**: HIGH
**Status**: READY FOR IMPLEMENTATION
**Dependencies**: oscilla-animator-v2-583 (RenderAssembler v2) - MUST BE COMPLETE FIRST

## Sprint Goal

Implement complete stroke rendering support in DrawPathInstancesOp, enabling fill-only, stroke-only, and fill+stroke modes with configurable stroke appearance (width, line joins, line caps, dash patterns).

## Scope

### Deliverables

1. **PathStyle Interface Extension**: Populate all stroke-related fields in PathStyle interface
2. **Stroke Width Calculation**: Implement viewport-relative stroke width (strokeWidthPx = strokeWidth × D, where D = min(width, height))
3. **Rendering Modes**: Support fill-only, stroke-only, and combined fill+stroke rendering
4. **Stroke Appearance**: Implement lineJoin, lineCap configuration
5. **Dash Patterns**: Support dashPattern and dashOffset for dashed/dotted strokes

### Out of Scope (Deferred)

- Gradient strokes (deferred to gradient system)
- Advanced blend modes beyond globalAlpha (future work)
- Per-vertex stroke width variation (requires geometry shader approach)
- Stroke-to-fill conversion for vector export

## Work Items

### P0: Extend PathStyle Interface with Stroke Properties

**Spec Reference**: `.agent_planning/_future/9-renderer.md` section 4 • `src/render/future-types.ts` lines 46-61

#### Description

Complete the PathStyle interface by populating the currently optional/commented stroke fields. These fields must support both uniform (single value) and per-instance (typed array) values for maximum flexibility.

#### Acceptance Criteria

- [ ] `strokeColor` defined as optional `Uint8ClampedArray` (RGBA, either uniform 4 bytes or per-instance count*4 bytes)
- [ ] `strokeWidth` defined as optional `number | Float32Array` (normalized world units, NOT pixels)
- [ ] `lineJoin` defined as optional `'miter' | 'bevel' | 'round'` (defaults to 'miter')
- [ ] `lineCap` defined as optional `'butt' | 'round' | 'square'` (defaults to 'butt')
- [ ] `dashPattern` defined as optional `number[]` (alternating dash/gap lengths in world units)
- [ ] `dashOffset` defined as optional `number` (offset into dash pattern, in world units)
- [ ] Documentation comments explain viewport scaling rules (strokeWidthPx = strokeWidth × D)

#### Technical Notes

- All stroke properties are optional to maintain backward compatibility with fill-only rendering
- `strokeWidth` in world units (not pixels) ensures stroke width responds to viewport size changes
- D = min(width, height) provides isotropic scaling (prevents aspect ratio distortion)
- dashPattern/dashOffset also in world units, scaled same as strokeWidth

---

### P0: Implement Stroke Width Viewport Scaling

**Spec Reference**: `.agent_planning/_future/9-renderer.md` section 4

#### Description

Implement the viewport-relative stroke width calculation that converts normalized world-space stroke width to pixel-space stroke width using the minimum viewport dimension as the scaling factor.

#### Acceptance Criteria

- [ ] Function `calculateStrokeWidthPx(strokeWidth: number, width: number, height: number): number` created
- [ ] Calculation uses `D = Math.min(width, height)` as scaling factor
- [ ] Returns `strokeWidth * D` for pixel-space width
- [ ] Function is pure (no side effects) and unit tested
- [ ] Documentation explains why min dimension is used (isotropic scaling, aspect-ratio independence)

#### Technical Notes

- This matches the coordinate space model: sizes are isotropic scalars
- Using min(width, height) ensures stroke doesn't become invisibly thin on narrow viewports
- Stroke width should scale uniformly with viewport size, like instance `size` property

---

### P1: Implement Rendering Mode Dispatch

**Spec Reference**: `src/render/Canvas2DRenderer.ts` lines 180-259 (current fill-only path)

#### Description

Extend the path rendering logic to support three distinct rendering modes based on which style properties are present: fill-only (current behavior), stroke-only (new), and fill+stroke (new).

#### Acceptance Criteria

- [ ] Mode detection logic checks `style.fillColor` and `style.strokeColor` presence
- [ ] Fill-only mode: Only calls `ctx.fill()` (current behavior preserved)
- [ ] Stroke-only mode: Only calls `ctx.stroke()` when fillColor absent but strokeColor present
- [ ] Fill+stroke mode: Calls both `ctx.fill()` then `ctx.stroke()` when both colors present
- [ ] Error or warning if neither fillColor nor strokeColor provided (no-op path)
- [ ] Rendering order is fill-first, stroke-second (prevents stroke being covered by fill)

#### Technical Notes

- Canvas2D API requires stroke AFTER fill to prevent fill covering stroke
- Stroke is centered on path (half inside, half outside), so fill+stroke increases visual size
- Consider future optimization: batch by rendering mode to minimize ctx state changes

---

### P1: Apply Stroke Style Configuration

**Spec Reference**: `src/render/Canvas2DRenderer.ts` renderPathAtParticle function

#### Description

Configure the canvas context stroke appearance properties (strokeStyle, lineWidth, lineJoin, lineCap) before calling ctx.stroke(). Handle both uniform and per-instance values.

#### Acceptance Criteria

- [ ] `ctx.strokeStyle` set from `style.strokeColor` (convert RGBA to CSS string)
- [ ] `ctx.lineWidth` set from calculated `strokeWidthPx` (scaled by viewport)
- [ ] `ctx.lineJoin` set from `style.lineJoin` if present (default 'miter')
- [ ] `ctx.lineCap` set from `style.lineCap` if present (default 'butt')
- [ ] Per-instance strokeColor handled correctly (index into Uint8ClampedArray by instance index)
- [ ] Per-instance strokeWidth handled correctly (index into Float32Array by instance index)
- [ ] Stroke style only configured when stroke-only or fill+stroke mode active

#### Technical Notes

- strokeColor format matches fillColor: RGBA in Uint8ClampedArray
- Uniform strokeColor: array length 4 (single color)
- Per-instance strokeColor: array length count*4 (one color per instance)
- strokeWidth scaling must happen per-instance when using Float32Array
- Reuse existing RGBA-to-CSS conversion logic from fillStyle

---

### P2: Implement Dash Pattern Support

**Spec Reference**: `.agent_planning/_future/9-renderer.md` section 4

#### Description

Add support for dashed and dotted strokes using canvas setLineDash() and lineDashOffset. Scale dash pattern from world units to pixel units using same D factor as stroke width.

#### Acceptance Criteria

- [ ] `ctx.setLineDash(dashPatternPx)` called when `style.dashPattern` present
- [ ] Dash pattern scaled from world units to pixels: `dashPatternPx[i] = dashPattern[i] * D`
- [ ] `ctx.lineDashOffset` set from `style.dashOffset * D` when present
- [ ] `ctx.setLineDash([])` called to reset dash when no pattern (solid stroke)
- [ ] Dash pattern validation: even-length array (alternating dash/gap), positive values
- [ ] Empty dash pattern `[]` treated as solid stroke

#### Technical Notes

- Canvas2D setLineDash() takes pixel-space lengths, hence scaling needed
- Dash pattern persists across paths, must reset when switching modes
- lineDashOffset useful for animating "marching ants" effect
- Consider state tracking to avoid redundant setLineDash calls (optimization)

---

### P2: Add Stroke Rendering Tests

**Spec Reference**: Testing best practices

#### Description

Create comprehensive unit tests for stroke rendering logic covering all rendering modes, style configurations, and edge cases.

#### Acceptance Criteria

- [ ] Test: fill-only mode (strokeColor absent) renders without stroke
- [ ] Test: stroke-only mode (fillColor absent) renders without fill
- [ ] Test: fill+stroke mode renders both in correct order
- [ ] Test: strokeWidth scaling calculation correct for various viewport sizes
- [ ] Test: uniform strokeColor applies to all instances
- [ ] Test: per-instance strokeColor applies correct color per instance
- [ ] Test: lineJoin/lineCap configuration applied to canvas context
- [ ] Test: dash pattern scaled correctly to pixel space
- [ ] Test: dashOffset applied correctly
- [ ] Test: empty/missing dash pattern results in solid stroke

#### Technical Notes

- Use mock canvas context to verify API calls
- Test edge cases: zero stroke width, negative dash values, odd-length dash array
- Verify no stroke state leaks between passes (ctx.save/restore)
- Test viewport scaling at different aspect ratios

---

## Dependencies

**CRITICAL**: This work CANNOT begin until oscilla-animator-v2-583 (RenderAssembler v2) is complete.

### Why RenderAssembler v2 is Required

RenderAssembler v2 transforms RenderPassIR into DrawPathInstancesOp structures. The stroke rendering implementation depends on:

1. **PathStyle Materialization**: RenderAssembler must assemble style from scalar banks (including future stroke properties)
2. **Geometry Resolution**: Control points must be in local space (not normalized world space) per Phase 6 spec
3. **Instance Transform Application**: Renderer must receive explicit instance transforms (position, size, rotation, scale2)
4. **DrawPathInstancesOp Contract**: Renderer consumes DrawOp structures, not RenderPassIR

### Coordination Points

- RenderAssembler must populate PathStyle.strokeColor, strokeWidth from scalar banks
- Field kernels or material definitions must expose stroke properties as modulatable fields
- Renderer changes here assume RenderAssembler provides fully-resolved DrawPathInstancesOp

---

## Risks & Mitigations

### Risk: RenderAssembler v2 Delayed

**Impact**: Cannot implement stroke rendering without DrawPathInstancesOp structures
**Mitigation**: Block this work explicitly. Use time to prepare tests, documentation, or prototype in isolation
**Contingency**: If urgency high, could add stroke to CURRENT renderer as interim (technical debt), then migrate

### Risk: Stroke Width Scaling Unintuitive

**Impact**: Users expect pixel-perfect stroke widths, get viewport-relative instead
**Likelihood**: Medium
**Mitigation**: Document clearly in UI tooltips and spec. Consider future "absolute pixel mode" flag
**Contingency**: Add strokeWidthMode: 'world' | 'pixels' enum if user feedback demands it

### Risk: Performance Degradation with Per-Instance Stroke Colors

**Impact**: Batching optimization harder when every instance has different stroke style
**Likelihood**: Low (canvas2D already state-heavy, not GPU-accelerated)
**Mitigation**: Profile before optimizing. Consider batching by style hash if needed
**Contingency**: Document performance characteristics, recommend uniform stroke color for large instance counts

---

## Implementation Strategy

### Phase 1: Type Definitions (Day 1)

1. Extend PathStyle interface in `src/render/future-types.ts`
2. Add JSDoc comments explaining viewport scaling
3. Update DrawPathInstancesOp example usage in comments

### Phase 2: Stroke Width Calculation (Day 1)

1. Add `calculateStrokeWidthPx()` utility function
2. Write unit tests for various viewport dimensions
3. Document D = min(width, height) rationale

### Phase 3: Rendering Mode Dispatch (Day 2)

1. Implement mode detection logic (fill-only / stroke-only / fill+stroke)
2. Update renderPathAtParticle to conditionally call fill/stroke
3. Add tests for each mode

### Phase 4: Stroke Style Application (Day 2-3)

1. Extract RGBA-to-CSS conversion as reusable utility
2. Implement uniform and per-instance strokeColor handling
3. Apply lineJoin, lineCap configuration
4. Test stroke appearance matches expectations

### Phase 5: Dash Pattern Support (Day 3)

1. Implement dash pattern scaling
2. Apply lineDashOffset
3. Test solid vs dashed rendering
4. Document dash pattern animation patterns

### Phase 6: Integration & Testing (Day 4)

1. Integration test with RenderAssembler v2 (once available)
2. Visual regression tests for stroke appearance
3. Performance profiling (instance count vs stroke complexity)
4. Documentation updates

---

## Success Criteria

### Functional

- [ ] All three rendering modes (fill-only, stroke-only, fill+stroke) work correctly
- [ ] Stroke width scales with viewport using D = min(width, height)
- [ ] Stroke appearance (color, width, join, cap) configurable via PathStyle
- [ ] Dash patterns render correctly with proper scaling
- [ ] Per-instance stroke colors apply independently

### Quality

- [ ] All acceptance criteria met with passing tests
- [ ] No visual artifacts (stroke clipping, color bleeding)
- [ ] Performance acceptable for 10k instances with unique stroke colors
- [ ] Code follows existing renderer patterns (ctx.save/restore, state hygiene)

### Documentation

- [ ] PathStyle fields documented with viewport scaling rules
- [ ] Rendering mode selection logic explained
- [ ] Example usage in comments or docs
- [ ] Known limitations documented (e.g., no gradient strokes yet)

---

## Notes

This work completes the stroke rendering pipeline for DrawPathInstancesOp. It does NOT include:

- **RenderAssembler changes**: That's oscilla-animator-v2-583's responsibility
- **Field kernel updates**: Stroke properties exposed via existing material/modulator system
- **UI controls**: Stroke style editors are separate UI work

This is purely renderer-side implementation consuming an already-populated PathStyle.
