# Definition of Done: Stroke Rendering

**Generated**: 2026-01-22
**Bead ID**: oscilla-animator-v2-02h
**Confidence**: HIGH
**Plan**: PLAN-20260122.md

## Acceptance Criteria

### PathStyle Interface Extension

- [ ] `strokeColor` field added: `readonly strokeColor?: Uint8ClampedArray`
- [ ] `strokeWidth` field added: `readonly strokeWidth?: number | Float32Array`
- [ ] `lineJoin` field added: `readonly lineJoin?: 'miter' | 'bevel' | 'round'`
- [ ] `lineCap` field added: `readonly lineCap?: 'butt' | 'round' | 'square'`
- [ ] `dashPattern` field added: `readonly dashPattern?: number[]`
- [ ] `dashOffset` field added: `readonly dashOffset?: number`
- [ ] JSDoc comments document viewport scaling: strokeWidthPx = strokeWidth × min(width, height)

### Stroke Width Calculation

- [ ] `calculateStrokeWidthPx(strokeWidth, width, height)` function implemented
- [ ] Calculation uses `D = Math.min(width, height)`
- [ ] Returns `strokeWidth * D`
- [ ] Function is pure (no side effects)
- [ ] Unit tests cover square viewports (width === height)
- [ ] Unit tests cover wide viewports (width > height)
- [ ] Unit tests cover tall viewports (height > width)

### Rendering Mode Dispatch

- [ ] Fill-only mode: `ctx.fill()` called when fillColor present, strokeColor absent
- [ ] Stroke-only mode: `ctx.stroke()` called when strokeColor present, fillColor absent
- [ ] Fill+stroke mode: `ctx.fill()` then `ctx.stroke()` called when both colors present
- [ ] No-op handling: warning or skip when neither fillColor nor strokeColor present
- [ ] Rendering order verified: fill before stroke (prevents stroke being covered)

### Stroke Style Configuration

- [ ] `ctx.strokeStyle` set from strokeColor (RGBA → CSS conversion)
- [ ] `ctx.lineWidth` set from `calculateStrokeWidthPx()` result
- [ ] `ctx.lineJoin` applied when `style.lineJoin` present (defaults to 'miter')
- [ ] `ctx.lineCap` applied when `style.lineCap` present (defaults to 'butt')
- [ ] Uniform strokeColor: single RGBA color applied to all instances
- [ ] Per-instance strokeColor: correct color index per instance (i * 4 offset)
- [ ] Uniform strokeWidth: single width applied to all instances
- [ ] Per-instance strokeWidth: correct width index per instance

### Dash Pattern Support

- [ ] `ctx.setLineDash()` called with pixel-scaled pattern when `dashPattern` present
- [ ] Dash pattern scaling: `dashPatternPx[i] = dashPattern[i] * D`
- [ ] `ctx.lineDashOffset` set from `dashOffset * D` when present
- [ ] Solid stroke when dashPattern absent: `ctx.setLineDash([])` called
- [ ] Empty dashPattern `[]` treated as solid stroke
- [ ] Dash pattern persists correctly across instances (no state leakage)

### Testing

- [ ] Unit test: fill-only mode renders without stroke call
- [ ] Unit test: stroke-only mode renders without fill call
- [ ] Unit test: fill+stroke mode calls both in correct order
- [ ] Unit test: strokeWidth scaling correct for various D values
- [ ] Unit test: uniform strokeColor applied correctly
- [ ] Unit test: per-instance strokeColor indexed correctly
- [ ] Unit test: lineJoin configuration applied to context
- [ ] Unit test: lineCap configuration applied to context
- [ ] Unit test: dash pattern scaled to pixels correctly
- [ ] Unit test: dashOffset applied correctly

### Code Quality

- [ ] No stroke style leaks between passes (ctx.save/restore used)
- [ ] RGBA-to-CSS conversion reused (DRY principle)
- [ ] Stroke configuration only happens when stroke mode active (no wasted work)
- [ ] Code follows existing Canvas2DRenderer patterns
- [ ] TypeScript types enforce correct usage
- [ ] No console warnings or errors in integration

### Documentation

- [ ] PathStyle fields have JSDoc explaining purpose and units
- [ ] Viewport scaling rationale documented (why min dimension)
- [ ] Rendering mode selection logic commented
- [ ] Example usage of stroke properties in code comments
- [ ] Known limitations documented (e.g., no gradient strokes, no per-vertex width)

---

## Exit Criteria

### For HIGH Confidence Implementation

- [ ] All acceptance criteria above met
- [ ] Code merged to main branch
- [ ] Integration with RenderAssembler v2 verified working
- [ ] Visual regression tests pass
- [ ] No performance regressions (10k instances < 16ms frame time)

### Blocked Until

- [ ] oscilla-animator-v2-583 (RenderAssembler v2) STATUS = completed
- [ ] DrawPathInstancesOp structure available in runtime

---

## Deferred

These items are explicitly OUT OF SCOPE for this sprint:

- **Gradient Strokes**: Complex fill/stroke patterns (requires gradient system)
- **Advanced Blend Modes**: Beyond globalAlpha (future compositing work)
- **Per-Vertex Stroke Width**: Variable width along path (requires geometry shader approach)
- **Stroke-to-Fill Conversion**: Vector export features (future export system)
- **Miter Limit Configuration**: Advanced join control (low priority, use default)
- **Stroke Alignment**: Inner/center/outer stroke modes (Canvas2D limitation)

---

## Success Metrics

### Functional Correctness

- Manual visual inspection: strokes appear at correct width, color, style
- Automated tests: 100% pass rate
- Integration test: RenderAssembler → DrawPathInstancesOp → Canvas2DRenderer round-trip

### Performance

- Benchmark: 10,000 instances with uniform stroke < 16ms/frame (60fps)
- Benchmark: 10,000 instances with per-instance stroke colors < 33ms/frame (30fps)
- No memory leaks after 1000 frames

### Code Quality

- TypeScript compilation: 0 errors
- Linter: 0 warnings
- Test coverage: >90% for new stroke rendering code
- Code review: approved by at least one maintainer
