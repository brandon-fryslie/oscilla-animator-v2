# Evaluation: Color System Implementation

Generated: 2026-02-01

## Topic
Implement the color system as specified in `design-docs/_new/colors/01-colors.md` and `02-color-units.md`.

## Verdict: CONTINUE

No blockers. The codebase has strong foundations already in place.

## Current State Assessment

### Already Implemented (solid foundation)
- **Color payload type**: `{ kind: 'color' }` exists in `ConcretePayloadType`, stride = 4
- **Color ConstValue**: `colorConst(r,g,b,a)` constructor exists
- **payloadStride**: Returns 4 for color
- **`extract` / `construct` intrinsics**: ValueExpr variants exist with IRBuilder API
- **rgba01 unit**: `{ kind: 'color', unit: 'rgba01' }` exists in UnitType
- **Required opcodes**: `Wrap01`, `Clamp(x,0,1)`, `Lerp`, `Floor`, `Add`, `Sub`, `Mul`, `Div` all exist
- **Block registration pattern**: Well-established via `registerBlock()`
- **Adapter block pattern**: `radians-to-phase.ts` provides a template for unit conversion adapters

### Partially Implemented
- **FieldConstColor block**: Exists but broken — uses removed `broadcastColor` kernel. Needs rewrite to use `construct` intrinsic.

### Missing (to be built)
1. **HSL unit**: `{ kind: 'color', unit: 'hsl' }` — simple addition to `UnitType` union
2. **`unitHsl()` constructor** — trivial
3. **7 color blocks** from design spec:
   - ColorPicker (source)
   - MakeColorHSL (pack)
   - SplitColorHSL (unpack)
   - HueShift
   - MixColor (shortest-arc hue blend)
   - AlphaMultiply
   - HslToRgba (adapter)
4. **HSL→RGB conversion kernel** — domain-specific, needs new kernel or ValueExpr intrinsic
5. **Fix FieldConstColor** — use `construct` intrinsic

## Key Design Decisions (already resolved by spec)

1. **HSL vs RGB distinguished by UnitType, not payload kind** — confirmed by `02-color-units.md`
2. **extract/construct are structural intrinsics** (ValueExpr kinds, not registry kernels) — already implemented
3. **HSL→RGB is a registry kernel or dedicated intrinsic** — only color-space-specific operation
4. **MakeColorHSL is the enforcement point** (wrap hue, clamp s/l/a) — per spec
5. **All blocks are cardinality-polymorphic** — same lowering, extent-aware

## Risks
- **HSL→RGB kernel**: The only operation that doesn't map to existing opcodes. Needs either a new opcode (recommended: `HslToRgb` as a 3-in-3-out opcode) or a multi-step lowering into existing opcodes (more complex but no new runtime support needed).
- **FieldConstColor rewrite**: Small scope, but must be done correctly using `construct`.

## Dependencies
- No external dependencies. All required infrastructure exists.
- The `shape` payload kind work (beads `oscilla-animator-v2-3kh6`) is independent.
