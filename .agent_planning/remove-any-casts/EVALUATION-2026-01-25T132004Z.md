# Evaluation: Remove 'as any' Casts from Test Files

**Date:** 2026-01-25T13:20:04Z
**Topic:** remove-any-casts
**Verdict:** CONTINUE

## Scope Assessment

Actual count: **~210 'as any' casts** across test files (slightly larger than initial estimate of 145).

## Categories Breakdown

### Category 1: Branded Type Literals (~35 instances)
- **Files:** PatchStore.test.ts, SelectionStore.test.ts, expression-blocks.test.ts
- **Pattern:** `'b0' as any` for BlockId, `0 as any` for SigExprId/ValueSlot
- **Fix:** Use existing factory functions: `blockId('b0')`, `sigExprId(0)`, etc.
- **Effort:** 15 minutes (trivial, mechanical replacement)
- **Risk:** Low

### Category 2: Schedule Access Pattern (~60 instances)
- **Files:** event-blocks.test.ts, stateful-primitives.test.ts, EventEvaluator.test.ts, integration.test.ts
- **Pattern:** `program.schedule as any` to access steps, stateSlotCount, etc.
- **Fix:** Single type assertion: `as ScheduleIR` replaces all schedule access casts
- **Effort:** 30 minutes (one change, many fixes)
- **Risk:** Low

### Category 3: Field Kernel Type Parameters (~30 instances)
- **Files:** field-kernel-contracts.test.ts
- **Pattern:** `type as any` passed to applyFieldKernel/applyFieldKernelZipSig
- **Fix:** Use existing `canonicalType()` and `signalTypeField()` factory functions
- **Effort:** 20 minutes
- **Risk:** Low

### Category 4: Parser AST Access (~48 instances)
- **Files:** parser.test.ts
- **Pattern:** `(ast as any).value`, `(ast as any).op`, `(ast as any).left`
- **Fix:** Add type narrowing patterns or assertion helpers for AST node types
- **Effort:** 45 minutes (requires understanding parser union types)
- **Risk:** Medium (may need to update test logic)

### Category 5: Mock/Stub Patterns (~20 instances)
- **Files:** DebugMiniView.test.tsx, Sparkline.test.tsx, stroke-rendering.test.ts, continuity-integration.test.ts
- **Pattern:** Mock objects cast to `any` to satisfy interfaces
- **Fix:** Use `vi.fn()` with proper generics or create test factory functions
- **Effort:** 30 minutes (some acceptable, others need utilities)
- **Risk:** Medium (may expose missing test utilities)

### Category 6: CompilationInspector Output Access (~15 instances)
- **Files:** CompilationInspectorService.test.ts
- **Pattern:** `snapshot?.passes[0].output as any`
- **Fix:** Type output field as discriminated union or create typed test helper
- **Effort:** Varies (may require inspection of CompilationInspector API)
- **Risk:** Medium-High (may indicate incomplete type definitions)

## Recommended Execution Order

1. **Category 1: Branded type literals** - Trivial, no dependencies, quick win
2. **Category 2: Schedule access** - Single fix, high impact
3. **Category 3: Field kernel params** - Straightforward factory usage
4. **Category 4: Parser AST access** - Medium complexity, builds on earlier work
5. **Category 5: Mock patterns** - Requires test utility decisions
6. **Category 6: CompilationInspector access** - Last, lowest priority (can document)

## No Production Code Changes Required

All fixes can be implemented in test files only using existing production type definitions and factory functions.

## Key Files to Reference

- `/src/compiler/ir/Indices.ts` - Branded ID factory functions
- `/src/types/index.ts` - blockId, portId, paramId factories
- `/src/compiler/passes-v2/pass7-schedule.ts` - ScheduleIR type definition
- `/src/core/canonical-types.ts` - canonicalType factories
