# Diagnostics System - Sprint 2 Implementation Plan (REVISED)

**Generated**: 2026-01-11 20:35:00
**Sprint Goal**: Runtime health monitoring and bus validation warnings with configurable settings
**Scope**: P0 Runtime diagnostics + P1 Config object (no UI) + P2 Bus warnings (+ Optional P3 createTimeRoot quick fix)

**REVISION NOTE**: Replaced full Settings Panel UI (Deliverable 2) with simple configuration object approach, since user is building app-wide settings panel later. This avoids building temporary UI that will be replaced.

---

## Sprint 2 Deliverables (REVISED)

### Deliverable 1: Runtime Health Monitoring (P0)

**Estimated Effort**: 16-20 hours

**Objective**: Emit RuntimeHealthSnapshot events from animation loop with NaN detection and frame budget monitoring

**Files to Create**:
1. `/Users/bmf/code/oscilla-animator-v2/src/runtime/HealthMonitor.ts` - Health snapshot generation
2. `/Users/bmf/code/oscilla-animator-v2/src/diagnostics/__tests__/runtimeDiagnostics.test.ts` - Runtime diagnostic tests

**Files to Modify**:
1. `/Users/bmf/code/oscilla-animator-v2/src/main.ts` (lines 211-267) - Integrate health monitoring in animation loop
2. `/Users/bmf/code/oscilla-animator-v2/src/runtime/RuntimeState.ts` (after line 119) - Add HealthMetrics interface
3. `/Users/bmf/code/oscilla-animator-v2/src/runtime/SignalEvaluator.ts` (lines 23-49) - Add NaN/Inf detection
4. `/Users/bmf/code/oscilla-animator-v2/src/diagnostics/types.ts` - Add P_NAN_DETECTED, P_INFINITY_DETECTED, P_FRAME_BUDGET_EXCEEDED codes

**Implementation**: See original PLAN-20260111-100000.md for detailed implementation steps.

---

### Deliverable 2: Diagnostics Configuration Object (P1) - REVISED

**Estimated Effort**: 2-4 hours (down from 8-12 hours)

**Objective**: Create simple configuration object for diagnostics settings (easy to migrate into app-wide settings later)

**Files to Create**:
1. `/Users/bmf/code/oscilla-animator-v2/src/diagnostics/config.ts` - Configuration object with defaults

**Files to Modify**:
1. `/Users/bmf/code/oscilla-animator-v2/src/runtime/HealthMonitor.ts` - Read from config object
2. `/Users/bmf/code/oscilla-animator-v2/src/runtime/SignalEvaluator.ts` - Read from config object
3. `/Users/bmf/code/oscilla-animator-v2/src/compiler/compile.ts` - Read from config object

**Implementation**:

#### Step 2.1: Create Configuration Object

**New File**: `src/diagnostics/config.ts`

```typescript
/**
 * Diagnostics System Configuration
 *
 * Simple configuration object for diagnostics settings.
 * TODO: Migrate to app-wide settings panel when available.
 */

export interface DiagnosticsConfig {
  // Runtime health monitoring
  runtimeHealthEnabled: boolean;
  healthSnapshotIntervalMs: number;  // 5 Hz = 200ms, 2 Hz = 500ms
  nanBatchWindowMs: number;          // Aggregate NaN in this window

  // Frame budget thresholds
  frameBudgetThresholdMs: number;    // Warn if frame > this value
  targetFPS: number;                 // 30, 60, 120

  // NaN/Inf detection
  nanDetectionEnabled: boolean;
  infDetectionEnabled: boolean;

  // Bus warnings
  busWarningsEnabled: boolean;
  warnEmptyBuses: boolean;           // W_BUS_EMPTY
  warnNoPublishers: boolean;         // W_BUS_NO_PUBLISHERS

  // Performance monitoring
  perfMonitoringEnabled: boolean;
  frameBudgetWarningsEnabled: boolean;
}

/**
 * Default diagnostics configuration
 *
 * Users can override these defaults by modifying this object
 * or (later) through app-wide settings panel.
 */
export const DIAGNOSTICS_CONFIG: DiagnosticsConfig = {
  // Runtime health
  runtimeHealthEnabled: true,
  healthSnapshotIntervalMs: 200,  // 5 Hz
  nanBatchWindowMs: 100,

  // Frame budget
  frameBudgetThresholdMs: 25,     // 25ms for 60 FPS
  targetFPS: 60,

  // Detection toggles
  nanDetectionEnabled: true,
  infDetectionEnabled: true,

  // Bus warnings
  busWarningsEnabled: true,
  warnEmptyBuses: true,
  warnNoPublishers: true,

  // Performance
  perfMonitoringEnabled: true,
  frameBudgetWarningsEnabled: true,
};

/**
 * Helper to calculate frame budget threshold based on target FPS
 */
export function getFrameBudgetForFPS(fps: number): number {
  return Math.round((1000 / fps) * 1.5);
}
```

#### Step 2.2: Update HealthMonitor to Read Config

**Location**: `src/runtime/HealthMonitor.ts`

Import config:
```typescript
import { DIAGNOSTICS_CONFIG } from '../diagnostics/config';
```

Update functions to read from config:
```typescript
export function shouldEmitSnapshot(state: RuntimeState): boolean {
  if (!DIAGNOSTICS_CONFIG.runtimeHealthEnabled) return false;

  const now = performance.now();
  const interval = DIAGNOSTICS_CONFIG.healthSnapshotIntervalMs;
  return now - state.health.lastSnapshotTime >= interval;
}

export function emitHealthSnapshot(
  state: RuntimeState,
  events: EventHub,
  patchId: string,
  activePatchRevision: number,
  tMs: number
): void {
  const h = state.health;
  const config = DIAGNOSTICS_CONFIG;

  // ... frame metrics calculation ...

  const raised: Diagnostic[] = [];

  // P_NAN_DETECTED (only if enabled)
  if (config.nanDetectionEnabled && h.nanCount > 0 && h.lastNanBlockId) {
    raised.push(/* ... */);
  }

  // P_INFINITY_DETECTED (only if enabled)
  if (config.infDetectionEnabled && h.infCount > 0 && h.lastInfBlockId) {
    raised.push(/* ... */);
  }

  // P_FRAME_BUDGET_EXCEEDED (only if enabled, use config threshold)
  if (config.frameBudgetWarningsEnabled && worstFrameMs > config.frameBudgetThresholdMs) {
    raised.push(/* ... */);
  }

  // ... emit event ...
}
```

#### Step 2.3: Update SignalEvaluator to Read Config

**Location**: `src/runtime/SignalEvaluator.ts`

```typescript
import { DIAGNOSTICS_CONFIG } from '../diagnostics/config';

// In evaluateSignal():
if (Number.isNaN(value) && DIAGNOSTICS_CONFIG.nanDetectionEnabled) {
  // ... batching logic ...
}

if (!Number.isFinite(value) && !Number.isNaN(value) && DIAGNOSTICS_CONFIG.infDetectionEnabled) {
  // ... batching logic ...
}
```

#### Step 2.4: Update Bus Validation to Read Config

**Location**: `src/compiler/compile.ts`

```typescript
import { DIAGNOSTICS_CONFIG } from '../diagnostics/config';

// Generate bus warnings (only if enabled)
let busWarnings: Diagnostic[] = [];
if (DIAGNOSTICS_CONFIG.busWarningsEnabled) {
  busWarnings = generateBusWarnings(
    normResult.patch,
    options.patchRevision,
    {
      warnEmptyBuses: DIAGNOSTICS_CONFIG.warnEmptyBuses,
      warnNoPublishers: DIAGNOSTICS_CONFIG.warnNoPublishers,
    }
  );
}
```

**Acceptance Criteria (REVISED)**:
1. ‚úÖ DIAGNOSTICS_CONFIG object exported from `src/diagnostics/config.ts`
2. ‚úÖ All default values set appropriately (runtimeHealthEnabled: true, healthSnapshotIntervalMs: 200, etc.)
3. ‚úÖ HealthMonitor reads config for all intervals and thresholds
4. ‚úÖ SignalEvaluator respects nanDetectionEnabled and infDetectionEnabled toggles
5. ‚úÖ Bus validation respects busWarningsEnabled toggle
6. ‚úÖ Config object is well-documented with JSDoc comments
7. ‚úÖ TODO comment references future migration to app-wide settings

**Migration Path**: When app-wide settings panel is built later, simply:
1. Move `DiagnosticsConfig` interface into app settings
2. Replace `DIAGNOSTICS_CONFIG` imports with `appSettings.diagnostics`
3. No other code changes needed

---

### Deliverable 3: Bus Validation Warnings (P2)

**Estimated Effort**: 8-12 hours

(Same as original plan - no changes)

**Files to Create**:
1. `/Users/bmf/code/oscilla-animator-v2/src/compiler/passes/busValidation.ts`
2. `/Users/bmf/code/oscilla-animator-v2/src/compiler/__tests__/busValidation.test.ts`

**Files to Modify**:
1. `/Users/bmf/code/oscilla-animator-v2/src/compiler/compile.ts`
2. `/Users/bmf/code/oscilla-animator-v2/src/diagnostics/types.ts`

See original PLAN for implementation details.

---

### Deliverable 4 (Optional): Basic Quick Fix - createTimeRoot (P3)

**Estimated Effort**: 6-8 hours

(Same as original plan - no changes)

See original PLAN for implementation details.

---

## Summary of Changes from Original Plan

### Removed (Deliverable 2 in original plan):
- ‚ùå DiagnosticsSettingsStore (MobX store)
- ‚ùå DiagnosticsSettingsPanel UI component
- ‚ùå RootStore integration
- ‚ùå localStorage persistence
- ‚ùå UI sliders, toggles, buttons
- ‚ùå "Reset to defaults" functionality
- ‚ùå 11 UI-related acceptance criteria

### Added (Revised Deliverable 2):
- ‚úÖ Simple `DIAGNOSTICS_CONFIG` object in `src/diagnostics/config.ts`
- ‚úÖ Config import in HealthMonitor, SignalEvaluator, compile.ts
- ‚úÖ 7 simplified acceptance criteria
- ‚úÖ Clear migration path documented

### Benefits:
- ‚ö° Faster implementation (2-4 hours vs 8-12 hours)
- üéØ No temporary UI that will be replaced
- üîß Easy migration to app-wide settings later
- ‚úÖ All values still configurable (user requirement met)

### Effort Savings:
- Original: 32-44 hours (P0+P1+P2)
- Revised: 26-36 hours (P0+P1revised+P2)
- **Saved: 6-8 hours**

---

## Files Summary

**New Files (8)**: (down from 10)
1. `src/runtime/HealthMonitor.ts`
2. `src/compiler/passes/busValidation.ts`
3. `src/diagnostics/config.ts` ‚≠ê REVISED (replaces store + UI)
4. `src/diagnostics/actions/quickFixes.ts` (optional P3)
5. `src/ui/components/diagnostics/DiagnosticActions.tsx` (optional P3)
6. + 3 test files

**Modified Files (6)**: (down from 9)
1. `src/main.ts`
2. `src/runtime/RuntimeState.ts`
3. `src/runtime/SignalEvaluator.ts`
4. `src/compiler/compile.ts`
5. `src/diagnostics/types.ts`
6. `src/diagnostics/validators/authoringValidators.ts`

**Removed from scope**:
- `src/stores/DiagnosticsSettingsStore.ts`
- `src/ui/components/settings/DiagnosticsSettingsPanel.tsx`
- `src/diagnostics/__tests__/DiagnosticsSettingsStore.test.ts`

---

## Revised Acceptance Criteria Total

**Total**: 17 acceptance criteria (down from 27)
- **Required (P0-P2)**: 12 criteria (down from 22)
- **Optional (P3)**: 5 criteria (unchanged)

**Breakdown**:
- Deliverable 1 (Runtime Health): 5 criteria
- Deliverable 2 (Config Object): 7 criteria (down from 11)
- Deliverable 3 (Bus Warnings): 5 criteria
- Deliverable 4 (Quick Fix): 5 criteria (optional)

---

## Implementation Order (REVISED)

1. **Day 1**: Create config.ts, RuntimeState HealthMetrics
2. **Day 1-2**: HealthMonitor with config integration
3. **Day 2-3**: NaN/Inf detection in SignalEvaluator (reading config)
4. **Day 3-4**: Animation loop integration
5. **Day 4-5**: Bus validation pass + config integration
6. **Day 5-6**: Compiler integration for bus warnings
7. **Day 6-7**: Quick fix infrastructure (optional)
8. **Day 7**: Testing, polish, documentation

**Total Estimated Effort**: 26-36 hours (P0+P1+P2), 32-44 hours with P3
