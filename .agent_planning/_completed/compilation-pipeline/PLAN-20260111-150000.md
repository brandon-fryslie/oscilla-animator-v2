# Sprint Plan: Compilation Pipeline - Wire passes-v2

Generated: 2026-01-11 15:00:00

## Sprint Goal

Rewrite the compilation pipeline to properly integrate all passes-v2 with correct data types, error handling, and full implementation of Pass 7 and IR conversion.

## Scope

**In scope (this sprint):**
1. **P0: Fix intermediate patch types and data flow** - Store blocks/edges in patch types, use NormalizedEdge throughout
2. **P1: Rewrite all passes with correct signatures and error handling** - Passes 2-8 with hybrid error pattern
3. **P2: Implement Pass 7 (Schedule Construction) and convertLinkedIRToProgram** - Complete the pipeline

**Explicitly out of scope (future sprints):**
- Performance optimization
- Additional block types beyond current catalog
- UI integration testing
- Advanced cycle detection optimizations

---

## Work Items

### P0: Fix Intermediate Patch Types and Data Flow

**Priority:** P0 (Must complete first - other work depends on this)

**Acceptance Criteria:**
- [ ] All intermediate patch types (TypedPatch, TimeResolvedPatch, DepGraph, AcyclicOrLegalGraph) include `blocks` and `edges` properties
- [ ] All passes work with NormalizedEdge (fromBlock/fromPort/toBlock/toPort indices)
- [ ] No pass requires separate blocks/edges parameters - all data flows through patch types
- [ ] TypeScript compiles with no type errors in ir/patches.ts

**Technical Notes:**

Files to modify:
- `src/compiler/ir/patches.ts` - Add blocks/edges to all patch types
- `src/graph/normalize.ts` - Verify NormalizedEdge structure is correct

Key changes:
```typescript
// Each patch type extends previous and includes data
interface TypedPatch extends NormalizedPatch {
  readonly blockOutputTypes: ReadonlyMap<string, ReadonlyMap<string, SignalType>>;
  // blocks and edges inherited from NormalizedPatch
}

interface TimeResolvedPatch extends TypedPatch {
  readonly timeModel: TimeModelIR;
  readonly timeSignals: TimeSignals;
}

// Continue pattern through all patch types...
```

---

### P1: Rewrite All Passes with Correct Signatures and Error Handling

**Priority:** P1 (Core work)

**Acceptance Criteria:**
- [ ] All passes accept single patch parameter (no separate blocks/edges params)
- [ ] All passes use hybrid error pattern: collect errors, throw at end if any
- [ ] Pass 3 validates TimeRoot constraints (NoTimeRoot, MultipleTimeRoots errors)
- [ ] Error kinds are preserved (not converted to generic CompileError)
- [ ] compile.ts orchestrates passes without try/catch around entire pipeline
- [ ] `npm run typecheck` passes with no errors

**Technical Notes:**

**Pass 2 (pass2-types.ts):**
- Current: Works but accesses edges incorrectly
- Fix: Use NormalizedEdge properties (fromBlock, toBlock, fromPort, toPort)
- Error pattern: Already correct (collect + throw)

**Pass 3 (pass3-time.ts):**
- Current: Wrong signature `(typed, errors)`, wrong property access
- Fix: Single param `(typed: TypedPatch)`, access `typed.blocks` directly
- Add: TimeRoot validation (NoTimeRoot, MultipleTimeRoots)
- Error pattern: Collect + throw

**Pass 4 (pass4-depgraph.ts):**
- Current: Wrong property `blockIndexMap`, wrong edge access
- Fix: Use `blockIndex`, use NormalizedEdge properties
- Error pattern: Already correct (collect + throw)

**Pass 5 (pass5-scc.ts):**
- Current: Requires separate blocks param, returns errors in result
- Fix: Get blocks from patch, throw errors at end
- Error pattern: Change to collect + throw

**Pass 6 (pass6-block-lowering.ts):**
- Current: Requires blocks/edges params, returns errors
- Fix: Get from patch, throw errors at end
- Error pattern: Change to collect + throw

**Pass 8 (pass8-link-resolution.ts):**
- Current: Massive import gaps, wrong params
- Fix: Add all imports, get data from patch
- Error pattern: Change to collect + throw

**compile.ts changes:**
- Remove try/catch around entire pipeline
- Each pass throws on error, propagates naturally
- Preserve error kinds in CompileError

---

### P2: Implement Pass 7 and convertLinkedIRToProgram

**Priority:** P2 (Completes the pipeline)

**Acceptance Criteria:**
- [ ] pass7Schedule function exists and is exported from index.ts
- [ ] Pass 7 takes UnlinkedIRFragments, returns ScheduleIR with execution order
- [ ] convertLinkedIRToProgram produces valid CompiledProgramIR
- [ ] All 11 tests in compile.test.ts pass
- [ ] End-to-end compilation works: Patch â†’ CompiledProgramIR

**Technical Notes:**

**Pass 7 (pass7-schedule.ts):**
- Input: UnlinkedIRFragments (block IR fragments, dependency info)
- Output: ScheduleIR with:
  - Execution order (topologically sorted)
  - Phase grouping (parallel execution phases)
  - State slot assignments
- Algorithm: Use SCC result from Pass 5, order by dependencies

**convertLinkedIRToProgram (compile.ts:198):**
- Input: LinkedGraphIR from Pass 8
- Output: CompiledProgramIR with:
  - signalExprs: Dense array of signal expressions
  - fieldExprs: Dense array of field expressions
  - schedule: Execution schedule
  - slotMeta: Metadata for runtime
  - debugIndex: Source mapping for diagnostics

**index.ts:**
- Add: `export { pass7Schedule } from "./pass7-schedule"`
- Add: `export type { ScheduleIR } from "./pass7-schedule"`

---

## Dependencies

- P0 must complete before P1 (passes need correct patch types)
- P1 must complete before P2 (Pass 7 depends on earlier passes working)
- Block registry must have all referenced block types
- IRBuilderImpl must be complete for Pass 6/7/8

## Risks

1. **Scope creep** - Pass 7 implementation may reveal additional requirements
   - Mitigation: Implement minimal viable schedule first, enhance later

2. **Type system complexity** - NormalizedEdge change may cascade
   - Mitigation: P0 establishes types first, validates with typecheck

3. **Test assumptions** - Tests may expect behaviors not in spec
   - Mitigation: Review tests alongside implementation, document discrepancies

4. **IR format ambiguity** - CompiledProgramIR structure may need clarification
   - Mitigation: Reference existing ir/program.ts definitions

---

## Verification

After implementation:
1. `npm run typecheck` - Zero errors
2. `npm run test -- compile.test.ts` - All 11 tests pass
3. Manual verification: Create test patch, verify CompiledProgramIR output structure
