# Definition of Done: Compilation Pipeline - Wire passes-v2

Generated: 2026-01-11 15:00:00
Completed: 2026-01-12 19:19:00

## P0: Fix Intermediate Patch Types and Data Flow

- [x] All intermediate patch types include `blocks: readonly Block[]` property
- [x] All intermediate patch types include `edges: readonly NormalizedEdge[]` property
- [x] NormalizedEdge uses index-based properties: `fromBlock`, `toBlock`, `fromPort`, `toPort`
- [x] `npm run typecheck` passes for `src/compiler/ir/patches.ts`

## P1: Rewrite All Passes with Correct Signatures

- [x] Pass 2: Single parameter `(patch: NormalizedPatch)`, uses NormalizedEdge properties
- [x] Pass 3: Single parameter `(patch: TypedPatch)`, accesses `patch.blocks` directly
- [x] Pass 3: Throws `NoTimeRoot` error when no TimeRoot block exists
- [x] Pass 3: Throws `MultipleTimeRoots` error when >1 TimeRoot block exists
- [x] Pass 4: Single parameter, uses `blockIndex` not `blockIndexMap`
- [x] Pass 4: Works with NormalizedEdge (fromBlock/toBlock indices)
- [x] Pass 5: Single parameter, gets blocks from patch
- [x] Pass 6: Single parameter, gets blocks and edges from patch
- [x] Pass 8: Single parameter, all imports resolved
- [x] All passes use hybrid error pattern: collect errors, throw at end if non-empty
- [x] Error kinds preserved through pipeline (NoTimeRoot, MultipleTimeRoots, TypeMismatch, etc.)
- [x] `npm run typecheck` passes with zero errors

## P2: Implement Pass 7 and IR Conversion

- [x] `pass7Schedule` function exists in `pass7-schedule.ts`
- [x] `pass7Schedule` exported from `passes-v2/index.ts`
- [x] Pass 7 produces topologically sorted execution order
- [x] `convertLinkedIRToProgram` produces valid `CompiledProgramIR`
- [x] CompiledProgramIR includes: signalExprs, schedule, slotMeta
- [x] All 11 tests in `compile.test.ts` pass
- [x] End-to-end: `compile(patch)` returns `{kind: 'ok', program: CompiledProgramIR}`

## Final Verification

- [x] `npm run typecheck` - Zero errors
- [x] `npm run test -- compile.test.ts` - 11/11 tests pass
- [x] `npm run build` - Builds successfully

## Summary

All acceptance criteria have been met. The compilation pipeline is now fully functional with:
- All intermediate patch types properly include blocks and edges
- All passes use correct signatures with single patch parameters
- Hybrid error handling pattern implemented throughout
- Pass 7 (schedule construction) fully implemented
- convertLinkedIRToProgram function implemented and integrated
- All 11 tests passing
- Clean TypeScript compilation
- Successful build
