# Handoff: Compilation Pipeline - Wire passes-v2

**Created**: 2026-01-11 16:00:00
**For**: do:iterative-implementer agent
**Status**: IN-PROGRESS (blocking issues remaining)

---

## Objective

Complete the compilation pipeline rewrite so the application compiles and runs successfully. Tests pass (11/11), but runtime compilation fails with 55 "PortTypeUnknown" errors.

## Current State

### What's Been Done
- P0: Fixed intermediate patch types (blocks/edges flow through pipeline)
- P1: Rewrote passes 2-8 with correct signatures and error handling
- P2 partial: Pass 7 stub, createStubProgramIR implemented
- All 11 unit tests in compile.test.ts pass
- TypeCheck passes, build succeeds
- Registered 15+ block types (time, math, color, geometry, identity, render)
- Fixed NormalizedEdge vs Edge type mismatch throughout pipeline

### What's In Progress
1. **BLOCKING**: Diagnostics panel not showing compilation errors (only browser console)
2. **BLOCKING**: 55 PortTypeUnknown errors at runtime - many block types used by main.ts are NOT registered

### What Remains
1. Fix diagnostics panel to show compile errors
2. Register ALL block types used by the demo patch in main.ts
3. Verify application runs end-to-end

## Context & Background

### Why We're Doing This
The passes-v2 compilation pipeline was never fully wired up. Pass signatures didn't match, edge types were inconsistent (Edge vs NormalizedEdge), and many blocks weren't registered. This prevents the application from compiling any real patches.

### Key Decisions Made
| Decision | Rationale | Date |
|----------|-----------|------|
| Use NormalizedEdge throughout | Index-based (fromBlock/toBlock) is canonical after normalization | 2026-01-11 |
| Store blocks/edges in patch types | No separate params to passes - data flows through patch | 2026-01-11 |
| Hybrid error pattern | Collect errors in pass, throw at end if any | 2026-01-11 |
| Preserve error kinds | NoTimeRoot, MultipleTimeRoots etc. propagate to UI | 2026-01-11 |

### Important Constraints
- Must use `src/blocks/registry.ts` for block registration (NOT src/compiler/blocks/)
- Blocks need BOTH `registerBlock()` (UI registry) AND `registerBlockType()` (IR lowering)
- Side-effect imports in compile.ts trigger block registration
- All passes use single parameter (patch type with blocks/edges)

## Acceptance Criteria

- [ ] Compilation errors appear in diagnostics panel (not just console)
- [ ] All block types in main.ts demo patch are registered
- [ ] Application compiles and runs the demo patch
- [ ] All 11 compile.test.ts tests continue to pass
- [ ] npm run typecheck passes
- [ ] npm run build succeeds

## Scope

### Files to Modify

**Priority 1: Diagnostics Panel**
- `src/main.ts` - log() function at line 32-40 logs to diagnostics store
- `src/ui/components/app/LogPanel.tsx` - Check if it reads from diagnostics store
- `src/stores/diagnosticsStore.ts` - Verify log entries are being stored

**Priority 2: Missing Block Registrations**
These block types are used in main.ts but NOT registered:

From main.ts lines 50-110:
- `DomainN` - DONE (domain-blocks.ts)
- `FieldFromDomainId` - MISSING
- `FieldPulse` - MISSING
- `FieldGoldenAngle` - MISSING
- `FieldAngularOffset` - MISSING
- `FieldAdd` - MISSING
- `FieldRadiusSqrt` - MISSING
- `FieldPolarToCartesian` - MISSING
- `FieldJitter2D` - MISSING
- `FieldHueFromPhase` - MISSING
- `HsvToRgb` - PARTIAL (registered as HSVToColor)
- `RenderInstances2D` - MISSING (have RenderCircle/RenderRect)

### Related Components
- `src/blocks/registry.ts` - Block definition registry
- `src/compiler/ir/lowerTypes.ts` - IR lowering registry (registerBlockType)
- `src/compiler/passes-v2/pass2-types.ts` - Uses getBlockDefinition()

### Out of Scope
- Pass 7 full implementation (stub is acceptable)
- convertLinkedIRToProgram full implementation (stub is acceptable)
- Performance optimization
- Additional block types beyond demo patch

## Implementation Approach

### Step 1: Fix Diagnostics Panel
1. Check src/stores/diagnosticsStore.ts - is log() working?
2. Check LogPanel.tsx - is it subscribed to diagnosticsStore?
3. Add debug logging to verify the data flow

### Step 2: Register Missing Blocks
For each missing block type:

```typescript
// In src/blocks/<category>-blocks.ts

registerBlock({
  type: 'BlockName',
  label: 'Human Label',
  category: 'category',
  description: 'What it does',
  form: 'primitive',
  capability: 'pure', // or 'time', 'identity', 'render', etc.
  inputs: [
    { id: 'inputPort', label: 'Input', type: canonicalType('float') },
  ],
  outputs: [
    { id: 'outputPort', label: 'Output', type: canonicalType('float') },
  ],
  params: {},
});

registerBlockType({
  type: 'BlockName',
  inputs: [{ portId: 'inputPort', type: canonicalType('float') }],
  outputs: [{ portId: 'outputPort', type: canonicalType('float') }],
  lower: ({ ctx, inputsById, config }) => {
    // Use ctx.b methods: sigMap, sigZip, fieldSource, Broadcast, etc.
    // Use ctx.b.kernel('kernelName') for function calls
    // Use ctx.b.opcode(OpCode.Add) for operations
    return {
      outputsById: {
        outputPort: { k: 'sig', id: sigId, slot },
      },
    };
  },
});
```

### Step 3: Add Imports to compile.ts
Ensure all block files are imported at top of src/compiler/compile.ts:
```typescript
import '../blocks/field-operations-blocks'; // New file for field ops
```

### Patterns to Follow
- See `src/blocks/time-blocks.ts` for correct pattern
- See `src/blocks/math-blocks.ts` for binary operations
- See `src/blocks/geometry-blocks.ts` for field operations
- Use `canonicalType('float')` for scalar signals
- Use `signalTypeField('float', 'default')` for field signals

### Known Gotchas
- `phaseValue.id` is `number` but IRBuilder expects `SigExprId` - cast with `as SigExprId`
- Use `OpCode.Add` not `'add'` for opcode() calls
- Block type names must match EXACTLY what main.ts uses (case-sensitive)
- Both registries must have the block (registerBlock AND registerBlockType)

## Reference Materials

### Planning Documents
- [PLAN-20260111-150000.md](.agent_planning/compilation-pipeline/PLAN-20260111-150000.md) - Full implementation plan
- [DOD-20260111-150000.md](.agent_planning/compilation-pipeline/DOD-20260111-150000.md) - Acceptance criteria
- [CONTEXT-20260111-150000.md](.agent_planning/compilation-pipeline/CONTEXT-20260111-150000.md) - Implementation details

### Codebase References
- `src/blocks/time-blocks.ts` - Good reference for block registration
- `src/blocks/math-blocks.ts` - Binary operation examples
- `src/blocks/geometry-blocks.ts` - Field operation examples
- `src/compiler/ir/IRBuilder.ts` - Available builder methods
- `src/compiler/ir/types.ts:229` - OpCode enum definition

## Questions & Blockers

### Current Blockers
1. **Diagnostics panel**: User cannot see errors in UI - only console. Needs investigation.
2. **Missing blocks**: ~12 block types need registration before demo patch compiles

### Need User Input On
- None currently - path forward is clear

## Testing Strategy

### Existing Tests
- `src/compiler/__tests__/compile.test.ts` - 11 tests, ALL PASSING

### Manual Testing
1. Start dev server: `npm run dev`
2. Open browser console
3. Check diagnostics panel for errors
4. Verify canvas shows animation (demo patch running)

## Success Metrics

- Diagnostics panel shows compilation errors (not just console)
- Application compiles demo patch without errors
- Canvas displays the particle animation
- All 11 unit tests continue to pass

---

## Next Steps for Agent

**Immediate actions**:
1. Read `src/main.ts` lines 46-170 to see all block types used
2. Check which of those types are NOT in src/blocks/*.ts
3. Create new block registrations for missing types

**Priority order**:
1. Fix diagnostics panel first (user needs to see errors)
2. Then register missing field operation blocks
3. Test with `npm run dev` after each batch of registrations

**When complete**:
- Run full test suite: `npm run typecheck && npm run test`
- Start dev server and verify app works
- Update this handoff with completion status
