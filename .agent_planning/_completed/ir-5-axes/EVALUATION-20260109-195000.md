# EVALUATION: IR and Normalization 5-Axes Implementation

**Generated**: 2026-01-09T19:50:00Z
**Spec Reference**: `design-docs/IR-and-normalization-5-axes.md`
**Status**: MAJOR GAPS - Spec largely unimplemented

---

## Executive Summary

The spec defines a comprehensive IR structure with 5-axis type metadata on every slot. Current implementation has **significant gaps**:
- No CompiledProgramIR root interface
- No slotMeta with offsets
- No axes exposed in IR (CanonicalType exists but unused)
- Graph normalization only has Phase 0 (of 6)

---

## 1. Current State

### IR Structure (`src/compiler/ir/`)
- **types.ts**: IRProgram with timeModel, signals, fields, events, domains, steps, slotCount
- **schedule.ts**: TimeModel and step execution types
- **builder.ts**: IRBuilder for emitting expressions
- **patches.ts**: Transformation types for compilation passes

### 5-Axis System (`src/core/canonical-types.ts`)
- ✅ CanonicalType with 5-axis Extent (P0-P3 complete)
- ✅ Cardinality, Temporality, Binding, Perspective, Branch
- ❌ NOT exposed in IR schema

### Graph Normalization (`src/graph/normalize.ts`)
- ✅ Phase 0: Basic structural normalization
- ❌ Phases 1-6: Not implemented

---

## 2. Gap Analysis: Spec vs Current

### Missing Mandatory Fields

| Field | Spec Requires | Current | Status |
|-------|--------------|---------|--------|
| `irVersion: 1` | Literal number | None | **MISSING** |
| `outputs: OutputSpecIR[]` | Required | None | **MISSING** |
| `slotMeta: SlotMetaEntry[]` | With offset | None | **MISSING** |
| `debugIndex: DebugIndexIR` | Mandatory | None | **MISSING** |
| Axes on every slot type | §1.7 mandatory | None | **MISSING** |

### Forbidden Tables (Good)
- ✅ No `program.nodes`
- ✅ No `program.buses`
- ✅ No `program.constPool`

### Missing Normalization Phases

| Phase | Description | Status |
|-------|-------------|--------|
| 0 | Sanity + canonical IDs | ✅ Exists |
| 1 | Build per-input source sets + defaults | ❌ Missing |
| 2 | Explicit fan-in via Combine nodes | ❌ Missing |
| 3 | Structural desugaring | ❌ Missing |
| 4 | Axes boundary legalization | ❌ Missing |
| 5 | Cycle check | ❌ Missing |
| 6 | Canonical ordering | ❌ Missing |

---

## 3. Relationship to Recent Work

**CanonicalType (P0-P3)** contains 5-axis system:
```typescript
interface CanonicalType {
  payload: PayloadType;
  extent: Extent;  // cardinality, temporality, binding, perspective, branch
}
```

**Gap**: This maps to spec's AxesDescIR but IR doesn't use it.

**Decision Needed**: Bridge CanonicalType.extent → IR's TypeDesc.axes

---

## 4. Critical Path

1. **P0: CompiledProgramIR schema** (blocks everything)
   - Create `src/compiler/ir/program.ts`
   - Add irVersion, outputs, slotMeta, debugIndex

2. **P1: SlotMeta with offsets** (blocks runtime)
   - Compiler assigns offsets
   - Runtime uses offsets (no derivation)

3. **P2: Expose axes in IR** (blocks type-directed compilation)
   - Bridge CanonicalType.extent to AxesDescIR

4. **P3+: Graph normalization phases 1-6** (multi-week)
   - DefaultSource, Combine, Coerce nodes
   - Cycle detection

---

## 5. Risks

1. **No stable IR contract** - Runtime has no authoritative schema
2. **Axes not in IR** - Can't validate type mismatches
3. **No offset metadata** - Slot addressing undefined
4. **67% of normalization missing** - No defaults/combines/coercions

---

## Recommendation

**Sprint 1**: Define CompiledProgramIR + SlotMeta + expose axes in IR.
This is the foundation everything else builds on.
