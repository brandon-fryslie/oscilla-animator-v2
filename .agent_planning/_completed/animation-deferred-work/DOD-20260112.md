    # Definition of Done: Animation Deferred Work

Generated: 2026-01-12
**Status: COMPLETE** (verified 2026-01-12)

## Sprint Acceptance Criteria

### P0: Signal Kernel Support - REQUIRED FOR SPRINT COMPLETION

- [x] **Functional**: Oscillator block with `sin` waveform renders without crash
- [x] **Functional**: Oscillator block with `cos` waveform renders without crash
- [x] **Code**: `SignalEvaluator.applyPureFn` handles `fn.kind === 'kernel'`
- [x] **Code**: Signal kernels implemented: `sin`, `cos`, `tan`
- [x] **Error Handling**: vec2 signal kernels throw informative "not yet implemented" error

### P0: Field Kernel Implementations - REQUIRED FOR SPRINT COMPLETION

- [x] **Functional**: Circle block renders particles in circular layout
- [x] **Functional**: Circle block with phase animation rotates smoothly
- [x] **Code**: `circleLayout` kernel in Materializer.ts `applyKernelZipSig`
- [x] **Code**: `circleAngle` kernel in Materializer.ts `applyKernelZipSig`
- [x] **Visual**: 100-particle circle layout is geometrically correct

### P1: Size Type Disambiguation - REQUIRED FOR SPRINT COMPLETION

- [x] **Code**: `StepRender.size` is discriminated union type in `types.ts`
- [x] **Code**: `pass7-schedule.ts` emits discriminated size object
- [x] **Code**: No array bounds heuristic in ScheduleExecutor (`isSignal`/`isField` checks removed)
- [x] **Code**: Fallback `size = 10` only when size input is undefined (not as error recovery)
- [x] **Functional**: Signal-based size input produces uniform particle size
- [x] **Functional**: Field-based size input produces per-particle varied sizes
- [x] **Type Safety**: TypeScript compilation succeeds with strict mode

### Integration Verification

- [x] Demo patch plays without console errors
- [x] No `PureFn kind kernel not implemented` errors
- [x] No `Unknown kernel function` errors
- [x] Animation runs at stable 60fps (no performance regression)
- [x] Type check passes: `npm run typecheck`

## Additional Fixes During Implementation

- [x] Fixed `fieldPolarToCartesian` kernel input order mismatch (was causing particles to render at incorrect positions)
- [x] Fixed canvas remounting issue (App.tsx was creating new canvas every ~500ms)
- [x] Fixed canvas callback timing (ref initialization for immediate availability)

## Verification Commands

```bash
# Type check
npm run typecheck

# Run tests
npm run test

# Manual verification
npm run dev
# Test scenarios:
# 1. Add Oscillator block with sin waveform -> should not crash
# 2. Add Circle block with 100 particles -> should show circular arrangement
# 3. Connect field to render size input -> should show per-particle sizes
# 4. Connect signal to render size input -> should show uniform sizes
```

## Out of Scope Confirmation

These items are explicitly NOT part of this sprint's DoD:
- Pass 8 link resolution
- createStubProgramIR replacement
- Multi-domain support
- vec2 signal support (field-level vec2 works)
- Kernel registry refactoring
