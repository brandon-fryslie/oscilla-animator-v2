# Sprint Plan: Animation Deferred Work - Runtime Crash Fixes

Generated: 2026-01-12

## Sprint Goal

Eliminate all runtime crashes caused by missing kernel implementations and fragile type heuristics.

## Scope

**In scope:**
- Signal kernel support in SignalEvaluator (unblocks Oscillator)
- Field kernel implementations for geometry blocks (unblocks Circle, OffsetPosition)
- Size type disambiguation via discriminated union (removes array bounds heuristic)

**Explicitly out of scope (future sprints):**
- Pass 8 link resolution implementation
- createStubProgramIR replacement with proper IR conversion
- Kernel registry refactoring (string-based dispatch is acceptable for now)
- Multi-domain support (MVP limitation acceptable)
- evalSig/materialize/stateWrite step generation in Pass 7
- vec2 signal support (requires RuntimeState storage changes)

## Work Items

### P0: Signal Kernel Support

**Problem**: `SignalEvaluator.ts:154-161` throws `PureFn kind kernel not implemented` when blocks use kernels at the signal level (e.g., Oscillator with `sin`, `cos`).

**Root Cause**: The `applyPureFn` function only handles `fn.kind === 'opcode'`, ignoring `fn.kind === 'kernel'`.

**Acceptance Criteria (REQUIRED):**
- [ ] `applyPureFn` in `SignalEvaluator.ts` handles `fn.kind === 'kernel'`
- [ ] Kernels `sin`, `cos`, `tan` are supported for signal-level evaluation
- [ ] Oscillator block renders without crashing
- [ ] No `PureFn kind kernel not implemented` errors at runtime

**Technical Notes:**
- Signal-level kernels for trig functions can delegate to Math.sin/cos/tan
- vec2 signal kernels (`polarToCartesian`, `offsetPosition`) should throw informative error for now - field-level versions work
- Add new `applySignalKernel` function with switch statement

### P0: Field Kernel Implementations

**Problem**: Geometry blocks (Circle, OffsetPosition) use field kernels that aren't implemented.

**Root Cause**: `Materializer.ts:applyKernelZipSig` lacks implementations for:
- `circleLayout` - Circle block position output
- `circleAngle` - Circle block angle output

**Acceptance Criteria (REQUIRED):**
- [ ] `circleLayout` kernel implemented in Materializer
  - Input: `[indexField]` (normalized 0-1), Signals: `[radius, phase]`
  - Output: vec2 positions arranged in circle
  - Formula: `x = cx + r * cos(2π * (index + phase))`, `y = cy + r * sin(...)`
- [ ] `circleAngle` kernel implemented in Materializer
  - Input: `[indexField]`, Signals: `[phase]`
  - Output: angle in radians
  - Formula: `angle = 2π * (index + phase)`
- [ ] Circle block renders particles in circular arrangement
- [ ] Test: 100-particle circle with phase animation

**Technical Notes:**
- Both are `zipSig` kernels: field input + signal modifiers
- Add to `applyKernelZipSig` function in Materializer.ts
- Use (0.5, 0.5) center for normalized coords

### P1: Size Type Disambiguation

**Problem**: `ScheduleExecutor.ts:167-188` uses fragile array bounds heuristic to determine if `step.size` is a signal or field ID.

**Root Cause**: `StepRender.size` is typed as `SigExprId | FieldExprId` (union of branded numbers) with no discriminator. Type information is available in pass7-schedule (`sizeRef.k`) but lost.

**Acceptance Criteria (REQUIRED):**
- [ ] `StepRender.size` changed to discriminated union:
  ```typescript
  size?: { k: 'sig'; id: SigExprId } | { k: 'field'; id: FieldExprId }
  ```
- [ ] `pass7-schedule.ts` updated to emit discriminated size
- [ ] `ScheduleExecutor.ts` updated to use discriminator instead of heuristic
- [ ] Remove array bounds check and hardcoded fallback `size = 10`
- [ ] Both signal-based and field-based size inputs work correctly

**Technical Notes:**
- Pattern matches existing `ValueRefPacked` type structure
- Change is localized: types.ts, pass7-schedule.ts, ScheduleExecutor.ts
- Keep `size = 10` as default only when no size input connected (valid case)

## Dependencies

1. **P0 Signal Kernels** and **P0 Field Kernels** are independent - can be done in parallel
2. **P1 Size Disambiguation** is independent of kernel work
3. All items block on each other for final integration testing

## Risks

| Risk | Likelihood | Impact | Mitigation |
|------|------------|--------|------------|
| vec2 signal kernels needed | Low | Medium | Document as known limitation, field versions work |
| Kernel math errors | Low | Medium | Test with known good values |
| StepRender type change cascade | Low | Low | Type change is additive |

## Verification

After sprint completion:
1. Oscillator block: Add to patch, connect to animation, verify sine wave output
2. Circle block: Add 100-particle Circle, verify circular arrangement
3. Size inputs: Test both signal (uniform) and field (per-particle) size inputs
4. No console errors during demo patch playback
5. Animation runs at stable 60fps
