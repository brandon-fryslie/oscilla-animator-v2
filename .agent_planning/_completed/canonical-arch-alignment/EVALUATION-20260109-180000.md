# Evaluation: Canonical Architecture Alignment

Generated: 2026-01-09T18:00:00Z
Topic: Align tests and code with CANONICAL-ARCHITECTURE-oscilla-v2.5

## Current State

### Type System Gap Analysis

**Current Implementation (Old Model):**
- Uses `TypeWorld = 'signal' | 'event' | 'field' | 'scalar' | 'config' | 'special'`
- Uses `TypeDesc` with flat structure: `{ world, domain, category, busEligible, lanes?, semantics?, unit? }`
- Domain conflates payload types with cardinality concepts
- No explicit axis decomposition

**Canonical Architecture (New 5-Axis Model):**
- `PayloadType = 'float' | 'int' | 'vec2' | 'color' | 'phase' | 'bool' | 'unit'`
- `Extent = { cardinality, temporality, binding, perspective, branch }`
- `SignalType = { payload: PayloadType, extent: Extent }`
- Uses `AxisTag<T>` pattern for default vs instantiated values
- `Cardinality = zero | one | many(domain)` (replaces World)
- `Temporality = continuous | discrete` (replaces event detection)

### Key Naming Changes

| Old | New |
|-----|-----|
| `TypeWorld` | decomposed into `Cardinality` + `Temporality` |
| `TypeDesc` | `SignalType` |
| `Domain` (type) | `PayloadType` |
| `Block.type` | `Block.kind` |
| `signal` world | `one + continuous` |
| `field` world | `many(domain) + continuous` |
| `scalar` world | `zero + continuous` |
| `event` world | `discrete` temporality |

### Codebase Health

**Typecheck Status: FAILING**
- 40+ type errors across compiler, blocks, passes
- Missing IRBuilder methods (`sigBinOp`, `sigUnaryOp`, `domainN`, etc.)
- TypeDesc construction errors (missing `category`, `busEligible`)
- Branded ID type mismatches
- Export conflicts

**Existing Tests:**
1. `compile.test.ts` - Basic compilation tests (TimeRoot, signals, domains, fields)
2. `steel-thread.test.ts` - Full animated particles pipeline
3. `integration.test.ts` - Runtime execution tests

**Test Coverage Gaps:**
- No tests for new 5-axis type system
- No tests for AxisTag pattern
- No tests for axis unification rules
- Tests reference old type constructs (world-based)

## What Needs to Change

### 1. Type System Overhaul (Core)
- Add `PayloadType`, `Extent`, `SignalType`, `AxisTag`, `Cardinality`, `Temporality`, `Binding`
- Add `DomainDecl`, `DomainRef`, `ReferentRef`
- Add `DEFAULTS_V0` constants
- Deprecate/migrate `TypeWorld`, `TypeDesc`

### 2. Block System Updates
- Rename `Block.type` to `Block.kind` everywhere
- Update block registry for new type signatures
- Update all block definitions

### 3. Test Alignment
- Write canonical type system unit tests
- Update existing tests to use new terminology
- Add axis unification tests
- Add SignalType construction tests

### 4. Fix Existing Type Errors
- IRBuilder methods missing
- TypeDesc construction
- Branded ID mismatches

## Dependencies

- Type system changes affect ALL other components
- Must maintain backward compatibility during transition OR do big-bang migration
- Tests should be written FIRST (TDD) to define expected behavior

## Risks

1. **Scope creep** - Type system is foundational; changes cascade everywhere
2. **Breaking changes** - All blocks, compiler, runtime depend on types
3. **Test rot** - Existing tests may mask incorrect behavior

## Verdict: CONTINUE

The gap is clear. We can proceed with planning. The recommended approach is:
1. Define new type system in parallel (new module)
2. Write tests for new type system
3. Migrate incrementally with adapters
4. Fix existing type errors as we migrate
