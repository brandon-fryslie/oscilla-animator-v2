# Implementation Context: Canonical Architecture Type System

Generated: 2026-01-09T18:00:00Z

This document provides all context needed for an agent to implement the plan.

## Source of Truth

**Canonical Architecture Doc:** `design-docs/spec/CANONICAL-ARCHITECTURE-oscilla-v2.5-20260109-160000.md`

## Key Type Definitions (from spec Section 3.1)

### PayloadType (Section 3.1.1)
```ts
type PayloadType = 'float' | 'int' | 'vec2' | 'color' | 'phase' | 'bool' | 'unit';
```
- Does NOT include 'event' or 'domain' - these are axis/resource concepts

### AxisTag (Section 3.1.4)
```ts
type AxisTag<T> =
  | { kind: 'default' }
  | { kind: 'instantiated'; value: T };
```
- No optional fields - explicit union for "default unless instantiated"

### Cardinality (Section 3.1.5)
```ts
type DomainId = string;
type DomainRef = { kind: 'domain'; id: DomainId };

type Cardinality =
  | { kind: 'zero' }                      // compile-time constant
  | { kind: 'one' }                       // single lane (was "signal")
  | { kind: 'many'; domain: DomainRef };  // N lanes (was "field")
```

### Temporality (Section 3.1.6)
```ts
type Temporality =
  | { kind: 'continuous' }  // every frame
  | { kind: 'discrete' };   // events only
```

### Binding (Section 3.1.7)
```ts
type ReferentId = string;
type ReferentRef = { kind: 'referent'; id: ReferentId };

type Binding =
  | { kind: 'unbound' }
  | { kind: 'weak'; referent: ReferentRef }
  | { kind: 'strong'; referent: ReferentRef }
  | { kind: 'identity'; referent: ReferentRef };
```

### Extent (Section 3.1.2)
```ts
type Extent = {
  cardinality: AxisTag<Cardinality>;
  temporality: AxisTag<Temporality>;
  binding: AxisTag<Binding>;
  perspective: AxisTag<PerspectiveId>;
  branch: AxisTag<BranchId>;
};
```

### SignalType (Section 3.1.3)
```ts
type SignalType = {
  payload: PayloadType;
  extent: Extent;
};
```

### Defaults (Section 3.1.8)
```ts
const DEFAULTS_V0 = {
  cardinality: { kind: 'canonical', value: { kind: 'one' } },
  temporality: { kind: 'canonical', value: { kind: 'continuous' } },
  binding:     { kind: 'canonical', value: { kind: 'unbound' } },
  perspective: { kind: 'canonical', value: 'global' },
  branch:      { kind: 'canonical', value: 'main' },
};
```
**NOTE:** Spec uses `kind: 'canonical'` but `AxisTag` uses `kind: 'default'`. Align to AxisTag (use 'default').

### World to Axes Mapping (Section 3.1.9)
| Old World | Cardinality | Temporality |
|-----------|-------------|-------------|
| static | zero | continuous |
| signal | one | continuous |
| field(domain) | many(domain) | continuous |
| event | one OR many(domain) | discrete |

### DomainDecl (Section 3.2.1)
```ts
type DomainDecl =
  | { kind: 'domain_decl'; id: DomainId; shape: { kind: 'fixed_count'; count: number } }
  | { kind: 'domain_decl'; id: DomainId; shape: { kind: 'grid_2d'; width: number; height: number } }
  | { kind: 'domain_decl'; id: DomainId; shape: { kind: 'voices'; maxVoices: number } }
  | { kind: 'domain_decl'; id: DomainId; shape: { kind: 'mesh_vertices'; assetId: string } };
```

## File Locations

### Create New
- `src/core/canonical-types.ts` - New type system
- `src/core/__tests__/canonical-types.test.ts` - Tests

### Modify for Type Fixes
- `src/compiler/blocks/domain/DomainN.ts:34` - TypeDesc missing fields
- `src/compiler/blocks/domain/GridDomain.ts:43` - TypeDesc missing fields
- `src/compiler/blocks/registry.ts:124,128,132` - TypeDesc missing fields
- `src/compiler/blocks/render/FieldFromDomainId.ts:24` - TypeDesc missing fields
- `src/compiler/blocks/render/RenderInstances2D.ts:64` - TypeDesc missing fields
- `src/compiler/blocks/time/FiniteTimeRoot.ts:59` - TypeDesc missing fields
- `src/compiler/blocks/time/InfiniteTimeRoot.ts:46` - TypeDesc missing fields

### IRBuilder Method Stubs Needed
- `sigBinOp` - Used in FieldAngularOffset, AddSignal, MulSignal, Oscillator, TimeRoots
- `sigUnaryOp` - Used in Oscillator, TimeRoots
- `domainN` - Used in DomainN
- `domainGrid` - Used in GridDomain
- `stepRender` - Used in RenderInstances2D

Location: `src/compiler/ir/IRBuilder.ts` or `src/compiler/ir/builder.ts`

## Existing Type Helpers

In `src/core/types.ts`:
```ts
export function createTypeDesc(
  worldOrOptions: TypeWorld | { world: TypeWorld; domain: Domain; category?: TypeCategory; busEligible?: boolean },
  domain?: Domain,
  category?: TypeCategory,
  busEligible?: boolean,
  options?: { ... }
): TypeDesc
```

Use this for fixing TypeDesc construction errors.

## Test Patterns (vitest)

```ts
import { describe, it, expect } from 'vitest';

describe('AxisTag', () => {
  it('creates default tag', () => {
    const tag: AxisTag<Cardinality> = { kind: 'default' };
    expect(tag.kind).toBe('default');
  });
});
```

## Axis Unification Logic (Section 3.5.3)

```ts
function unifyAxis<T>(a: AxisTag<T>, b: AxisTag<T>): AxisTag<T> | Error {
  if (a.kind === 'default' && b.kind === 'default') return { kind: 'default' };
  if (a.kind === 'default') return b;
  if (b.kind === 'default') return a;
  // Both instantiated
  if (deepEqual(a.value, b.value)) return a;
  return new Error('Axis mismatch');
}
```

## Success Criteria

1. `npm run typecheck` → exit code 0
2. `npm run test` → all tests pass
3. New canonical-types module exports all types from spec
4. Tests cover all axis unification rules
