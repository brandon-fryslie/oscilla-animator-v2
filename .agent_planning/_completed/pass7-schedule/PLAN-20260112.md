# Sprint Plan: Pass 7 Schedule Construction

Generated: 2026-01-12

## Sprint Goal

Implement Pass 7 to generate execution steps so the demo patch renders in the browser.

## Scope

**In scope (this sprint):**
- P0: Generate `render` steps for RenderInstances2D blocks
- P1: Wire render step inputs (position, color, size) from Pass 6 blockOutputs
- P2: Domain resolution for render steps

**Explicitly out of scope (future sprints):**
- `evalSig` step generation (runtime handles inline)
- `materialize` step generation (runtime handles inline)
- `stateWrite` step generation (no stateful blocks in demo)
- Multiple domain support
- State slot management

## Work Items

### P0: Generate Render Steps

**Acceptance Criteria (REQUIRED):**
- [ ] Pass 7 returns non-empty `steps` array for demo patch
- [ ] Each render block produces exactly one `StepRender`
- [ ] `schedule.steps.length > 0` assertion passes

**Technical Notes:**
- Scan `validated.blocks` for blocks with `capability === 'render'`
- Create `StepRender` for each render block found
- Use `getBlockDefinition(block.type).capability` to identify render blocks

### P1: Wire Render Inputs

**Acceptance Criteria (REQUIRED):**
- [ ] `StepRender.position` contains valid FieldExprId from pos input
- [ ] `StepRender.color` contains valid FieldExprId from color input
- [ ] `StepRender.size` contains valid SigExprId or FieldExprId (optional)
- [ ] Inputs traced via normalized edges to source block outputs

**Technical Notes:**
- Use `validated.edges` to find edges targeting render block inputs
- Look up source ValueRef from `unlinkedIR.blockOutputs`
- Port names: 'pos', 'color', 'size', 'domain'

### P2: Domain Resolution

**Acceptance Criteria (REQUIRED):**
- [ ] `StepRender.domain` contains valid DomainId
- [ ] Runtime can look up domain count from `schedule.domains`
- [ ] Canvas renders 5000 particles (demo patch particle count)

**Technical Notes:**
- MVP: Use first domain from `builder.getDomains()`
- Future: Trace domain input wire to source DomainN block

## Dependencies

- Pass 6 must produce valid `blockOutputs` (DONE - verified working)
- IRBuilder must expose `getDomains()` (DONE - method exists)
- Block registry must have `getBlockDefinition()` (DONE - method exists)

## Risks

| Risk | Likelihood | Impact | Mitigation |
|------|------------|--------|------------|
| Render input port names mismatch | Medium | High | Verify against render-blocks.ts definitions |
| Domain resolution complexity | Low | Medium | MVP uses first domain |
| Runtime expects more step types | Low | Low | Runtime handles missing evalSig/materialize inline |
