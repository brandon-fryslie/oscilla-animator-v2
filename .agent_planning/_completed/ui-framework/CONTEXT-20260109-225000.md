# Implementation Context: UI Framework Foundation
Generated: 2026-01-09 22:50:00

This document contains everything needed for implementation.

## Project Location
- Main project: `/Users/bmf/code/oscilla-animator-v2`
- jsPanel4 fork: `/Users/bmf/code/brandon-fryslie_jsPanel4`

## Current Build System
- Vite dev server: `npm run dev`
- TypeScript: `npm run typecheck`
- Tests: `npm run test`
- Build: `npm run build`

## Existing Files to Modify

### `package.json` (line 14-15)
Current dependencies:
```json
"dependencies": {
  "mermaid": "^11.4.1"
}
```
Add:
```json
"dependencies": {
  "mermaid": "^11.4.1",
  "@mui/material": "^5.15.0",
  "@emotion/react": "^11.11.0",
  "@emotion/styled": "^11.11.0"
}
```

### `public/index.html` (full file, 272 lines)
Replace the hard-coded layout structure. Keep:
- The `<style>` section (will be mostly replaced)
- The `<script type="module" src="/src/main.ts">` tag

New structure needed:
```html
<body>
  <div id="app-container">
    <header id="toolbar">...</header>
    <main id="workspace">
      <div id="region-left" class="panel-region"></div>
      <div id="region-center" class="panel-region"></div>
      <div id="region-right" class="panel-region"></div>
    </main>
    <div id="region-bottom" class="panel-region"></div>
  </div>
  <script type="module" src="/src/main.ts"></script>
</body>
```

### `src/main.ts` (446 lines)
This is the steel-thread demo. Currently it:
- Creates DOM element references directly (lines 18-19, 42, 111, 281, 437-438)
- Initializes PatchViewer (line 112)
- Sets up canvas zoom/pan (lines 289-352)
- Runs animation loop (lines 376-427)
- Handles slider control (lines 437-445)

**Integration approach:**
1. Import new UI system at top
2. Initialize AppLayout before accessing DOM
3. Get containers from AppLayout instead of `document.getElementById`
4. Keep all business logic (compile, animate, etc.) unchanged

Key DOM elements currently referenced:
- `#log` - log output div
- `#stats` - performance stats overlay
- `#block-inspector` - block inspector panel
- `#patch-viewer` - patch visualization container
- `#canvas` - animation canvas
- `#particleSlider`, `#particleCount` - slider controls

## New Files to Create

### `src/ui/types/jspanel.d.ts`
Minimal TypeScript declarations for jsPanel4:

```typescript
declare module 'jspanel4' {
  export interface JsPanelOptions {
    id?: string;
    headerTitle?: string;
    position?: JsPanelPosition | string;
    panelSize?: { width: number | string; height: number | string };
    container?: string | HTMLElement;
    theme?: string;
    dragit?: boolean | 'disabled' | object;
    resizeit?: boolean | object;
    headerControls?: { size: string };
    content?: string | HTMLElement | ((panel: JsPanel) => void);
    callback?: (panel: JsPanel) => void;
    onclosed?: ((panel: JsPanel, closedByUser: boolean) => boolean)[];
    onstatuschange?: ((panel: JsPanel, status: string) => void)[];
  }

  export interface JsPanelPosition {
    my?: string;
    at?: string;
    of?: string | HTMLElement;
    offsetX?: number;
    offsetY?: number;
  }

  export interface JsPanel extends HTMLElement {
    close: () => void;
    minimize: () => void;
    maximize: () => void;
    normalize: () => void;
    smallify: () => void;
    front: () => void;
    setHeaderTitle: (title: string) => void;
    resize: (options: { width?: number | string; height?: number | string }) => void;
    reposition: (position?: JsPanelPosition) => void;
    content: HTMLElement;
    options: JsPanelOptions;
    status: 'normalized' | 'maximized' | 'minimized' | 'smallified';
  }

  export interface JsPanelStatic {
    create: (options: JsPanelOptions, callback?: (panel: JsPanel) => void) => JsPanel;
    defaults: JsPanelOptions;
    zi: { next: () => number };
    extensions: Record<string, unknown>;
  }

  const jsPanel: JsPanelStatic;
  export default jsPanel;
}
```

### `src/ui/theme.ts`
MUI dark theme configuration:

```typescript
import { createTheme } from '@mui/material/styles';

export const darkTheme = createTheme({
  palette: {
    mode: 'dark',
    primary: { main: '#4ecdc4' },      // Matches existing accent color
    secondary: { main: '#ff6b6b' },    // Matches existing error color
    background: {
      default: '#1a1a2e',
      paper: '#16213e',
    },
  },
  typography: {
    fontFamily: "-apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif",
    fontSize: 14,
  },
  components: {
    MuiTab: {
      styleOverrides: {
        root: {
          textTransform: 'none',
          minHeight: 36,
          padding: '6px 12px',
        },
      },
    },
  },
});
```

### `src/ui/panel/types.ts`
Panel configuration types:

```typescript
export interface PanelConfig {
  id: string;
  title: string;
  region: 'left' | 'center' | 'right' | 'bottom';
  contentFactory: (container: HTMLElement) => void | (() => void);
  resizable?: boolean;
  minWidth?: number;
  minHeight?: number;
  initialWidth?: number | string;
  initialHeight?: number | string;
}

export interface PanelInstance {
  id: string;
  config: PanelConfig;
  panel: any; // jsPanel instance
  destroy: () => void;
}
```

### `src/ui/panel/PanelManager.ts`
Panel management singleton:

```typescript
import type { PanelConfig, PanelInstance } from './types';

export class PanelManager {
  private static instance: PanelManager;
  private panels: Map<string, PanelInstance> = new Map();
  private jsPanel: any; // Will be set after dynamic import

  static getInstance(): PanelManager {
    if (!PanelManager.instance) {
      PanelManager.instance = new PanelManager();
    }
    return PanelManager.instance;
  }

  async init(): Promise<void> {
    // Dynamic import of jsPanel4
    const jsPanelModule = await import('jspanel4');
    this.jsPanel = jsPanelModule.default;

    // Also import CSS
    await import('jspanel4/dist/jspanel.css');
  }

  createPanel(config: PanelConfig): PanelInstance {
    // Implementation...
  }

  getPanel(id: string): PanelInstance | undefined {
    return this.panels.get(id);
  }

  destroyPanel(id: string): boolean {
    const instance = this.panels.get(id);
    if (instance) {
      instance.panel.close();
      this.panels.delete(id);
      return true;
    }
    return false;
  }

  destroyAll(): void {
    for (const [id] of this.panels) {
      this.destroyPanel(id);
    }
  }
}
```

### `src/ui/layout/regions.ts`
Layout region definitions:

```typescript
export interface LayoutRegion {
  id: string;
  selector: string;
  defaultWidth?: string;
  defaultHeight?: string;
  resizeDirection?: 'horizontal' | 'vertical' | 'both';
}

export const REGIONS: Record<string, LayoutRegion> = {
  left: {
    id: 'region-left',
    selector: '#region-left',
    defaultWidth: '280px',
    resizeDirection: 'horizontal',
  },
  center: {
    id: 'region-center',
    selector: '#region-center',
    resizeDirection: 'both',
  },
  right: {
    id: 'region-right',
    selector: '#region-right',
    defaultWidth: '300px',
    resizeDirection: 'horizontal',
  },
  bottom: {
    id: 'region-bottom',
    selector: '#region-bottom',
    defaultHeight: '150px',
    resizeDirection: 'vertical',
  },
};
```

### `src/ui/layout/AppLayout.ts`
Main layout orchestrator:

```typescript
import { PanelManager } from '../panel/PanelManager';
import { REGIONS } from './regions';
import type { PanelConfig } from '../panel/types';

export class AppLayout {
  private panelManager: PanelManager;
  private initialized = false;

  constructor() {
    this.panelManager = PanelManager.getInstance();
  }

  async init(): Promise<void> {
    if (this.initialized) return;

    await this.panelManager.init();
    this.setupRegions();
    this.initialized = true;
  }

  private setupRegions(): void {
    // Verify all regions exist in DOM
    for (const region of Object.values(REGIONS)) {
      const el = document.querySelector(region.selector);
      if (!el) {
        throw new Error(`Layout region not found: ${region.selector}`);
      }
    }
  }

  createPanelInRegion(config: PanelConfig): void {
    this.panelManager.createPanel(config);
  }

  getContainer(region: 'left' | 'center' | 'right' | 'bottom'): HTMLElement {
    const regionConfig = REGIONS[region];
    const el = document.querySelector(regionConfig.selector);
    if (!el) throw new Error(`Region not found: ${region}`);
    return el as HTMLElement;
  }
}
```

### `src/ui/components/TabbedContent.ts`
Wrapper for MUI Tabs (vanilla TS, not React):

```typescript
// Note: MUI is React-based, so we have two options:
// 1. Use a thin React wrapper just for tabs
// 2. Build custom tabs without MUI
//
// For sprint 1, recommend option 2 (custom tabs) to avoid
// React dependency complexity. MUI can be added for forms/controls later.

export interface TabConfig {
  id: string;
  label: string;
  contentFactory: (container: HTMLElement) => void;
}

export class TabbedContent {
  private container: HTMLElement;
  private tabs: TabConfig[];
  private activeTabId: string;
  private tabBar: HTMLElement;
  private contentArea: HTMLElement;

  constructor(container: HTMLElement, tabs: TabConfig[]) {
    this.container = container;
    this.tabs = tabs;
    this.activeTabId = tabs[0]?.id ?? '';
    this.render();
  }

  private render(): void {
    // Create tab bar
    this.tabBar = document.createElement('div');
    this.tabBar.className = 'tab-bar';

    // Create content area
    this.contentArea = document.createElement('div');
    this.contentArea.className = 'tab-content';

    // Render tabs
    for (const tab of this.tabs) {
      const tabEl = document.createElement('button');
      tabEl.className = 'tab-button';
      tabEl.textContent = tab.label;
      tabEl.dataset.tabId = tab.id;
      tabEl.onclick = () => this.setActiveTab(tab.id);
      if (tab.id === this.activeTabId) {
        tabEl.classList.add('active');
      }
      this.tabBar.appendChild(tabEl);
    }

    this.container.appendChild(this.tabBar);
    this.container.appendChild(this.contentArea);

    // Render initial content
    this.renderContent();
  }

  setActiveTab(tabId: string): void {
    if (tabId === this.activeTabId) return;

    // Update tab bar
    this.tabBar.querySelectorAll('.tab-button').forEach(btn => {
      btn.classList.toggle('active', (btn as HTMLElement).dataset.tabId === tabId);
    });

    this.activeTabId = tabId;
    this.renderContent();
  }

  private renderContent(): void {
    this.contentArea.innerHTML = '';
    const tab = this.tabs.find(t => t.id === this.activeTabId);
    if (tab) {
      tab.contentFactory(this.contentArea);
    }
  }
}
```

## jsPanel4 Integration Details

### Import Path
From the fork's es6module directory:
```typescript
import jsPanel from 'jspanel4/es6module/jspanel.js';
```

### npm link Setup
```bash
# In jsPanel4 fork directory
cd ~/code/brandon-fryslie_jsPanel4
npm link

# In oscilla project
cd ~/code/oscilla-animator-v2
npm link jspanel4
```

### jsPanel4 Key Options for Fixed Layout

```typescript
jsPanel.create({
  id: 'my-panel',
  headerTitle: 'Panel Title',
  container: '#region-left',  // Place in specific container
  position: {
    my: 'left-top',
    at: 'left-top',
    of: '#region-left',
  },
  panelSize: {
    width: '100%',
    height: '100%',
  },
  dragit: 'disabled',  // Prevent dragging
  resizeit: {
    handles: 'e',      // Only resize on east edge (right side)
  },
  headerControls: {
    size: 'xs',        // Small header controls
  },
});
```

## CSS Requirements

New CSS classes needed (add to `public/index.html` or create `src/ui/styles.css`):

```css
/* Layout regions */
#app-container {
  display: flex;
  flex-direction: column;
  height: 100vh;
  overflow: hidden;
}

#toolbar {
  flex-shrink: 0;
  height: 48px;
  background: #16213e;
  border-bottom: 1px solid #0f3460;
}

#workspace {
  flex: 1;
  display: flex;
  min-height: 0;
  overflow: hidden;
}

.panel-region {
  position: relative;
  overflow: hidden;
}

#region-left {
  flex: 0 0 280px;
  min-width: 200px;
  max-width: 500px;
}

#region-center {
  flex: 1;
  min-width: 400px;
}

#region-right {
  flex: 0 0 300px;
  min-width: 200px;
  max-width: 500px;
}

#region-bottom {
  flex: 0 0 150px;
  min-height: 100px;
  max-height: 400px;
  border-top: 1px solid #0f3460;
}

/* Tab styling */
.tab-bar {
  display: flex;
  gap: 2px;
  padding: 4px;
  background: #16213e;
  border-bottom: 1px solid #0f3460;
}

.tab-button {
  padding: 6px 12px;
  background: transparent;
  border: none;
  color: #888;
  font-size: 0.875rem;
  cursor: pointer;
  border-radius: 4px 4px 0 0;
}

.tab-button:hover {
  background: rgba(255, 255, 255, 0.05);
  color: #ccc;
}

.tab-button.active {
  background: #0f0f23;
  color: #4ecdc4;
}

.tab-content {
  flex: 1;
  overflow: auto;
  background: #0f0f23;
}
```

## Existing Component Wiring

### PatchViewer (`src/viewer/PatchViewer.ts`)
- Constructor takes container element
- Has `render(patch)` and `setOnBlockClick(callback)` methods
- Wire into center panel tab

### Canvas
- Currently `<canvas id="canvas">`
- Needs: zoom/pan handlers, animation loop connection
- Wire into center panel tab

### Log Panel
- Currently direct DOM append to `#log`
- Wire into bottom panel content

### Block Inspector
- Currently direct DOM manipulation of `#block-inspector`
- Wire into left sidebar (bottom portion)

### Controls (slider)
- Currently floating overlay
- Could become toolbar item or dedicated control panel
