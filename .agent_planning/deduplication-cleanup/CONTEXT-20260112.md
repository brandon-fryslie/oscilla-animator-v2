# Implementation Context - Deduplication & Cleanup Sprint 1

Detailed file paths, line numbers, and code to change.

---

## P0: Delete bridge.ts

### File to Delete
**Path:** `/Users/bmf/code/oscilla-animator-v2/src/compiler/ir/bridge.ts`
**Lines:** 161 total
**Action:** Delete entire file

### Verification Commands
```bash
# Confirm no imports (should return empty)
grep -r "from.*bridge['\"]" src/ --include="*.ts" | grep -v bridges

# After deletion
npm run typecheck
```

---

## P1: Delete Viewer Module

### Directory to Delete
**Path:** `/Users/bmf/code/oscilla-animator-v2/src/viewer/`

**Contents:**
- `index.ts` (9 lines, just `export {}`)

**Action:** Delete entire directory

### Verification
```bash
# Confirm no imports (should return empty)
grep -r "from.*viewer" src/ --include="*.ts"

# After deletion
npm run typecheck
```

---

## P2: Remove Debug Console Statements

### File 1: DiagnosticHub.ts
**Path:** `/Users/bmf/code/oscilla-animator-v2/src/diagnostics/DiagnosticHub.ts`

**Line 172 - Delete:**
```typescript
    console.log('[DiagnosticHub] CompileEnd event:', event);
```

**Line 177 - Delete:**
```typescript
    console.log('[DiagnosticHub] Compile snapshot set:', event.patchRevision, event.diagnostics.length);
```

**Line 186 - Delete:**
```typescript
    console.log('[DiagnosticHub] Diagnostics revision:', this.diagnosticsRevision);
```

**Context:** All 3 are in `handleCompileEnd()` method (lines 166-187)

### File 2: pass7-schedule.ts
**Path:** `/Users/bmf/code/oscilla-animator-v2/src/compiler/passes-v2/pass7-schedule.ts`

**Line 127 - Delete:**
```typescript
    console.warn('[pass7-schedule] No domains found, cannot create render steps');
```

**Line 139 - Delete:**
```typescript
      console.warn(`[pass7-schedule] Render block ${block.id} missing or invalid 'pos' input (field expected)`);
```

**Line 143 - Delete:**
```typescript
      console.warn(`[pass7-schedule] Render block ${block.id} missing or invalid 'color' input (field expected)`);
```

**Context:** All 3 are in `createRenderSteps()` function (lines 117-165)

### File 3: pass6-block-lowering.ts
**Path:** `/Users/bmf/code/oscilla-animator-v2/src/compiler/passes-v2/pass6-block-lowering.ts`

**Line 286 - Delete:**
```typescript
  console.debug(`[IR] Using IR lowering for ${block.type} (${block.id})`);
```

**Context:** In `lowerBlock()` function, before try/catch block

### Verification
```bash
npm run typecheck
npm run test
```

---

## P3: Restore Type Compatibility Validation

### Location
**Path:** `/Users/bmf/code/oscilla-animator-v2/src/compiler/passes-v2/pass6-block-lowering.ts`
**Lines:** 112-129 (commented-out validation block)

### Current State (to be replaced)
```typescript
    // TODO: Fix validation for new CanonicalType structure
    //       if (!modeValidation.valid) {
    // TODO: Fix validation for new CanonicalType structure
    //         errors.push({
    // ... (9 lines of identical TODO + commented code)
```

### What Validation Is Needed

Combined inputs must have compatible types. Key constraint: **all writers must have the same time axis**.

**Data available in context:**
- `spec.portType: CanonicalType` - the target port's expected type
- `spec.writers: Writer[]` - each has `from.blockId` and `from.slotId`
- `blockOutputs: Map<BlockIndex, Map<string, ValueRefPacked>>` - output refs by block
- `combine.mode: CombineMode` - the combine mode ('sum', 'last', etc.)

**Validation needed:**
1. Look up each writer's CanonicalType from the source block's output slot
2. Check time axis compatibility: all writers should have same time (or compatible)
3. Call `validateCombineMode(combine.mode, world, payload)` for mode/domain validation
4. Push `PortTypeMismatch` error if validation fails

### Related Files
- `combine-utils.ts:75` - `validateCombineMode()` function (already imported in pass6)
- `resolveWriters.ts:54` - `ResolvedInputSpec` type definition
- Block definitions have output slot types

### Implementation Approach

```typescript
// After line 110 (after validateCombinePolicy check), replace commented block with:

// Validate combine mode is valid for this world/domain
if (writers.length > 1) {
  const world = portType.world ?? 'signal';
  const payload = portType.payload ?? 'float';
  const modeValidation = validateCombineMode(combine.mode, world, payload);
  if (!modeValidation.valid) {
    errors.push({
      code: 'PortTypeMismatch',
      message: `${modeValidation.reason} for port ${endpoint.blockId}.${endpoint.slotId}`,
      where: { blockId: endpoint.blockId, port: endpoint.slotId },
    });
    continue;
  }

  // TODO: Add time axis compatibility check across all writers
  // For now, this validates that the combine mode is valid for the target port type.
  // Full writer type compatibility (ensuring all writers have same time axis)
  // requires looking up each writer's output type from block definitions.
}
```

### Test Location
Need test in `/src/compiler/__tests__/` that verifies:
- Multiple writers with incompatible types produce error
- Multiple writers with compatible types compile successfully

---

## P4: Pipeline Placeholders

### Location
**Path:** `/Users/bmf/code/oscilla-animator-v2/src/compiler/compile.ts`
**Lines:** 150-157, 239-270

### Current State
```typescript
// Lines 150-157
    // Pass 7: Schedule Construction
    const scheduleIR = pass7Schedule(unlinkedIR, acyclicPatch);

    // Pass 8: Link Resolution
    // TODO: Implement pass8LinkResolution
    // const linkedIR = pass8LinkResolution(unlinkedIR, acyclicPatch);

    // Convert to CompiledProgramIR
    // TODO: Implement convertLinkedIRToProgram
    // const compiledIR = convertLinkedIRToProgram(linkedIR, scheduleIR);
    const compiledIR = createStubProgramIR(scheduleIR, unlinkedIR);

// Lines 239-270 - createStubProgramIR function
/**
 * Create a stub CompiledProgramIR for testing.
 * TODO: Replace with real convertLinkedIRToProgram implementation.
 */
function createStubProgramIR(scheduleIR: any, unlinkedIR: any): CompiledProgramIR {
  // ... actual working code that creates CompiledProgramIR
}
```

### Investigation Questions
1. What does pass8LinkResolution need to do? Is it needed for current functionality?
2. Is `createStubProgramIR` actually complete, or is it missing functionality?
3. What would a "real" `convertLinkedIRToProgram` do differently?

### Related Files
- `/src/compiler/passes-v2/pass8-link-resolution.ts` - exists but may be incomplete
- Design docs on compilation pipeline

### Resolution Options

**Option A: Implement missing passes**
If pass8 and convertLinkedIRToProgram are actually needed for correctness.

**Option B: Document as intentionally deferred**
If the "stub" is actually sufficient for current scope:
1. Rename `createStubProgramIR` â†’ `createProgramIR` (remove "stub")
2. Remove misleading TODOs
3. Add comment explaining what's deferred and why

**Option C: File ticket and clean up**
If unclear, file a ticket with investigation notes and clean up the misleading comments.

---

## Summary Table

| Work Item | Files | Complexity | Risk |
|-----------|-------|------------|------|
| P0 | 1 file deleted | Low | Low |
| P1 | 1 dir deleted | Low | Zero |
| P2 | 3 files | Low | Low |
| P3 | 1 file + tests | Medium | Medium |
| P4 | 1-2 files | Medium | Medium |
