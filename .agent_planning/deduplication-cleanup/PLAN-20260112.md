# Deduplication & Cleanup Sprint 1 - 2026-01-12

**Scope:** Safe cleanup + restore missing validation + complete pipeline placeholders
**Philosophy:** Fix real gaps, don't just delete code

---

## Sprint Goal

Clean up dead code, restore missing type validation for combined inputs, and complete the compilation pipeline placeholders.

---

## Scope

**In scope (this sprint):**
- Delete duplicate bridge.ts file
- Delete empty viewer module
- Remove debug console statements from critical paths
- Restore type compatibility validation for combined inputs (pass6)
- Complete pass8LinkResolution and convertLinkedIRToProgram (or properly defer)

**Explicitly out of scope:**
- IRBuilder state methods (user requested to keep)
- Block factory extraction (feature work, not cleanup)

---

## Work Items

### P0: Delete bridge.ts duplicate

**Rationale:** `bridge.ts` is a simplified wrapper superseded by `bridges.ts`. Neither is exported from index.ts. Tests import from `bridges.ts` only.

**Acceptance Criteria:**
- [ ] File `/src/compiler/ir/bridge.ts` does not exist
- [ ] `npm run typecheck` passes
- [ ] No "bridge" imports remain in codebase (excluding `bridges.ts`)

**Technical Notes:**
- Delete `/src/compiler/ir/bridge.ts` (161 lines)
- Verify no imports exist (already confirmed - zero matches)

---

### P1: Delete empty viewer module

**Rationale:** `/src/viewer/` contains only a placeholder `index.ts` with `export {}`. Zero imports anywhere. Dead module taking cognitive space.

**Acceptance Criteria:**
- [ ] Directory `/src/viewer/` does not exist
- [ ] `npm run typecheck` passes

**Technical Notes:**
- Delete `/src/viewer/index.ts`
- Delete `/src/viewer/` directory

---

### P2: Remove debug console statements

**Rationale:** 7 console statements in critical compiler/diagnostic paths. These are debug instrumentation, not integrated with DiagnosticHub. Removing has zero functional impact.

**Acceptance Criteria:**
- [ ] DiagnosticHub.ts: Zero `console.log` statements in handleCompileEnd method
- [ ] pass7-schedule.ts: Zero `console.warn` statements in createRenderSteps function
- [ ] pass6-block-lowering.ts: Zero `console.debug` statement in lowerBlock function
- [ ] `npm run typecheck` passes

**Technical Notes:**
- `/src/diagnostics/DiagnosticHub.ts`: Delete lines 172, 177, 186
- `/src/compiler/passes-v2/pass7-schedule.ts`: Delete lines 127, 139, 143
- `/src/compiler/passes-v2/pass6-block-lowering.ts`: Delete line 286

---

### P3: Restore type compatibility validation for combined inputs

**Rationale:** The commented-out validation block in pass6 (lines 112-129) was for validating that all writers to a combined input have compatible types. Combined inputs must have the same time axis - this is a real invariant that was disabled during a refactor and never restored.

**Acceptance Criteria:**
- [ ] When multiple writers target an input, their SignalTypes are validated for compatibility
- [ ] Incompatible time axes produce a `PortTypeMismatch` error with clear message
- [ ] Validation uses `validateCombineMode` from combine-utils.ts (already imported)
- [ ] Tests verify that incompatible writers are rejected
- [ ] The commented-out block is removed (replaced with working code)

**Technical Notes:**

The validation needs to:
1. Get the SignalType of each writer (from blockOutputs lookup)
2. Check that all writers have compatible types (especially time axis)
3. Call `validateCombineMode(combine.mode, world, payload)` for mode/domain validation
4. Report errors with context if validation fails

Location: `/src/compiler/passes-v2/pass6-block-lowering.ts:112-129`

The `ResolvedInputSpec` has:
- `portType: SignalType` - the target port's type
- `writers: Writer[]` - each writer has `from.blockId` and `from.slotId`

Need to look up each writer's output type from the block definition or blockOutputs map.

---

### P4: Complete pipeline placeholders (pass8 & convertLinkedIRToProgram)

**Rationale:** The compile pipeline has placeholder comments for pass8LinkResolution and convertLinkedIRToProgram. Currently using `createStubProgramIR` as a workaround. This needs to either be properly implemented or explicitly documented as deferred with a ticket.

**Acceptance Criteria:**
- [ ] Either: pass8LinkResolution is implemented and called
- [ ] Or: The TODO is replaced with explicit deferral comment explaining why it's not needed yet
- [ ] Either: convertLinkedIRToProgram is implemented
- [ ] Or: createStubProgramIR is renamed to be the real implementation (not "stub")
- [ ] No misleading "TODO: Implement" comments remain in compile.ts

**Technical Notes:**

Location: `/src/compiler/compile.ts:150-157`

Current state:
```typescript
// Pass 8: Link Resolution
// TODO: Implement pass8LinkResolution
// const linkedIR = pass8LinkResolution(unlinkedIR, acyclicPatch);

// Convert to CompiledProgramIR
// TODO: Implement convertLinkedIRToProgram
// const compiledIR = convertLinkedIRToProgram(linkedIR, scheduleIR);
const compiledIR = createStubProgramIR(scheduleIR, unlinkedIR);
```

Options:
1. Implement the missing passes if needed for current functionality
2. If not needed yet, document why and rename "stub" to real implementation
3. File a ticket for future implementation with clear scope

---

## Execution Order

1. P0: Delete bridge.ts (simple file deletion)
2. P1: Delete viewer (simple directory deletion)
3. P2: Remove console statements (quick edits)
4. P3: Restore type validation (requires understanding + new code)
5. P4: Pipeline placeholders (investigation + decision)

**Verification after each step:** `npm run typecheck`
**Final verification:** `npm run test` (full test suite)

---

## Dependencies

- P0, P1, P2 are independent
- P3 depends on understanding the type system and combine semantics
- P4 may depend on understanding what the pipeline actually needs

---

## Risks

- P0-P2: Low risk - confirmed dead code
- P3: Medium risk - need to understand what "compatible types" means exactly
- P4: Medium risk - may uncover that stub is incomplete

---

## Sprint Complete Criteria

- [ ] All 5 work items pass their acceptance criteria
- [ ] `npm run test` passes (full test suite)
- [ ] `npm run build` succeeds
- [ ] No misleading TODOs remain in modified files
