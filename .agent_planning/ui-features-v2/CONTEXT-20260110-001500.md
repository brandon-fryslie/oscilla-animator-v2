# Implementation Context: UI Features v2 - Phase 2

**For**: Implementing agent with write-only access
**Plan**: PLAN-20260110-001500.md

## Key Files

### Type Definitions
- `src/types/index.ts` - Core types including DefaultSource (line 185-187), RailId (line 260-266)
- `src/graph/Patch.ts` - Block interface (line 14-20), Patch interface (line 68-71)

### UI Components
- `src/ui/components/TableView.ts` - Table component, needs Rails section
- `src/ui/components/BlockInspector.ts` - Inspector, needs default source + domain display
- `src/ui/components/BlockLibrary.ts` - Library, needs to set preview type on click

### State & Registry
- `src/ui/state/selection.ts` - Selection state, needs previewType field
- `src/ui/registry/blockTypes.ts` - Block type registry, needs defaultSource on ports

### Demo Patch
- `src/main.ts` - buildAndCompile() function builds demo patch (line 191-311)

## Current Implementations

### DefaultSource (src/types/index.ts:185-187)
```typescript
export interface DefaultSource {
  readonly value: unknown;
}
```
**Change to:**
```typescript
export interface DefaultSource {
  readonly kind: 'rail' | 'constant';
  readonly railId?: RailId;  // When kind='rail'
  readonly value?: unknown;   // When kind='constant'
}
```

### Block (src/graph/Patch.ts:14-20)
```typescript
export interface Block {
  readonly id: BlockId;
  readonly type: BlockType;
  readonly params: Readonly<Record<string, unknown>>;
  readonly label?: string;
}
```
**Add:**
```typescript
  readonly domainId?: string;  // Reference to domain block ID
```

### Rail Block Type
- Located: `src/compiler/blocks/rail/index.ts`
- Kind: `'Rail'`
- Purpose: Passthrough block for signal routing

### RailId Values (src/types/index.ts:260-266)
```typescript
export type RailId =
  | 'time'
  | 'phaseA'
  | 'phaseB'
  | 'pulse'
  | 'palette'
  | 'energy';
```

## Selection State Structure

Current (`src/ui/state/selection.ts`):
```typescript
interface SelectionState {
  selectedBlockId: BlockId | null;
}
```

**Add:**
```typescript
interface SelectionState {
  selectedBlockId: BlockId | null;
  previewType: string | null;  // Block type name for preview
}
```

## Block Type Registry Structure

In `src/ui/registry/blockTypes.ts`, each port definition:
```typescript
interface PortDefinition {
  name: string;
  type: string;
  description?: string;
}
```

**Enhance to:**
```typescript
interface PortDefinition {
  name: string;
  type: string;
  description?: string;
  defaultSource?: DefaultSource;
}
```

### Common Default Sources to Add
- `phase` inputs → `{ kind: 'rail', railId: 'phaseA' }`
- `id01` inputs → No default (requires connection)
- Numeric parameters → `{ kind: 'constant', value: <default> }`

## Table View Section Logic

In `TableView.ts`, partition blocks:
```typescript
const regularBlocks = Array.from(patch.blocks.values())
  .filter(b => b.type !== 'Rail');
const railBlocks = Array.from(patch.blocks.values())
  .filter(b => b.type === 'Rail');
```

Render two sections with headers.

## Demo Patch Domain Assignment

In `main.ts` buildAndCompile(), after creating blocks, the domain block is `b1` (DomainN).
Field blocks that need domain:
- b2 (FieldFromDomainId)
- b8 (FieldPulse)
- b10-b14 (various Field* blocks)
- b17 (FieldJitter2D)
- b20 (FieldHueFromPhase)
- b25 (FieldPulse)
- b26 (RenderInstances2D)

Since PatchBuilder doesn't support domainId yet, either:
1. Extend PatchBuilder.addBlock() to accept domainId
2. Manually set after build (modify the Map)

Option 1 is cleaner.

## Inspector Preview Mode

When `previewType` is set:
- Show block type info from registry
- Header: "TYPE PREVIEW" instead of block ID
- Show all ports from registry definition
- No "From:"/"To:" connections (it's a type, not instance)

When `selectedBlockId` is set (and previewType is null):
- Show actual block from patch
- Show real connections
- Current behavior

## Colors/Theme

From `src/ui/theme.ts` (if exists) or inline in components:
- Section headers: `#16213e` background
- Rail section: Consider slightly different accent color
