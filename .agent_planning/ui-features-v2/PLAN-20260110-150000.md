# Sprint Plan: UI Features v2 - Phase 2 Completion + DefaultSource Display

**Generated**: 2026-01-10 15:00
**Topic**: ui-features-v2
**Predecessor**: PLAN-20260110-003000.md (Phase 2 items P0-P2 complete)

## Current Status Assessment

### Completed Items (Already Implemented)
- ✅ **P0: Block Model Enhancements** - `displayName`, `domainId`, `role` fields exist in Block interface
- ✅ **P1: BlockRole System** - All roles have meta fields, helper functions exist
- ✅ **P2: Bus Block** - `src/compiler/blocks/bus/index.ts` implemented with 2-in/2-out
- ✅ **P6: RailId Type** - Already removed from `src/types/index.ts`

### Incomplete Phase 2 Items
- ❌ **P3: Connection Matrix** - Current TableView is block list, NOT connection matrix
- ❌ **P4: Split Sidebar** - Left sidebar uses tabs (Library/Inspector), not split layout
- ❌ **P5: TimeRoot Hidden** - No filtering currently implemented

### Deferred Features (from previous plans)
- DefaultSource display in Inspector
- Block type preview in Inspector when browsing Library

---

## Sprint Goal

Complete Phase 2 remaining items (P3-P5) and implement DefaultSource display feature for full read-only visualization capability.

---

## Scope

**In scope (this sprint):**
1. P3: Connection Matrix transformation
2. P4: Split sidebar layout
3. P5: TimeRoot filtering
4. P7: DefaultSource display in Inspector
5. P8: Block type preview when selecting from Library

**Out of scope (future):**
- Editing capabilities (add/remove blocks, wiring)
- Domain propagation logic
- Variadic ports

---

## Work Items

### P3: Connection Matrix Table View (Major Rewrite)

**Goal**: Transform TableView from block list to blocks × blocks adjacency matrix.

**Current state**: TableView displays a vertical list of blocks with expand/collapse.

**Target state**: Matrix where:
- Rows = source blocks (sorted by role: user, bus, then others)
- Columns = target blocks (same ordering)
- Cells = connection indicators

**Visual:**
```
           │ dom   │ id01  │ pulse │ pos   │ render│
───────────┼───────┼───────┼───────┼───────┼───────┤
time       │   -   │       │   ●   │       │       │
dom        │   =   │   ●   │       │       │   ●   │
id01       │       │   =   │   ●   │       │       │
pulse      │       │       │   =   │   ●   │       │
pos        │       │       │       │   =   │   ●   │
render     │       │       │       │       │   =   │
───────────┴───────┴───────┴───────┴───────┴───────┤
BUSES                                               │
phaseA     │       │       │   ●   │       │       │
```

**Implementation approach:**
1. Keep existing TableView file, refactor internally
2. Add matrix rendering mode
3. Group blocks by role (filter timeRoot entirely)
4. Show buses in separate section below main matrix
5. Cell click → select edge
6. Row header click → select block

**Acceptance Criteria:**
- [ ] Matrix renders with block names as row/column headers
- [ ] Cells show ● when edge exists (source row → target column)
- [ ] Multiple edges between blocks shows count (●2)
- [ ] Click cell → selects edge(s) between those blocks
- [ ] Click row header → selects block
- [ ] Diagonal shows = (self-connection indicator)
- [ ] Buses displayed in separate bottom section
- [ ] TimeRoot blocks hidden entirely
- [ ] Matrix scrolls horizontally for many blocks

**Files to modify:**
- `src/ui/components/TableView.ts` - Major rewrite

---

### P4: Split Sidebar Layout

**Goal**: Left sidebar shows Library (top) and Inspector (bottom) simultaneously, not as tabs.

**Current state**: TabbedContent with Library/Inspector tabs - only one visible at a time.

**Target state**: Vertical split panel with resizable divider:
```
┌─────────────────────┐
│ LIBRARY             │
│ [Search...]         │
│ ▸ Time              │
│ ▸ Domain            │
│ ▸ Field Operations  │
│ ...                 │
├─────────────────────┤ ← Draggable divider
│ INSPECTOR           │
│ block_name          │
│ BlockType           │
│ ─────────           │
│ INPUTS              │
│ ...                 │
└─────────────────────┘
```

**Implementation approach:**
1. Create `SplitPanel.ts` component
2. Replace TabbedContent in setupUI with SplitPanel
3. Library in top region, Inspector in bottom region
4. Divider at ~40% from top by default
5. Min heights: Library 150px, Inspector 200px

**Acceptance Criteria:**
- [ ] SplitPanel component created
- [ ] Left sidebar uses SplitPanel instead of TabbedContent
- [ ] Library visible in top section
- [ ] Inspector visible in bottom section
- [ ] Divider is draggable
- [ ] Divider respects min heights
- [ ] Right sidebar unchanged (still tabbed)

**Files to modify:**
- `src/ui/components/SplitPanel.ts` - New file
- `src/ui/components/index.ts` - Export SplitPanel
- `src/main.ts` - Update setupUI() for split layout

---

### P5: TimeRoot Hidden from UI

**Goal**: Blocks with `role.kind === 'timeRoot'` are hidden from all UI views.

**Current state**: No filtering - all blocks visible.

**Changes required:**
1. TableView: Filter out timeRoot blocks from matrix rows/columns
2. BlockLibrary: Don't show InfiniteTimeRoot, FiniteTimeRoot
3. Inspector: Handle edge case where selected block is timeRoot (shouldn't happen normally)

**Implementation approach:**
```typescript
// In TableView
const visibleBlocks = Array.from(patch.blocks.values())
  .filter(b => b.role.kind !== 'timeRoot');

// In BlockLibrary registry
// Add isTimeRoot flag to BlockTypeInfo and filter in display
```

**Acceptance Criteria:**
- [ ] TimeRoot blocks not visible in connection matrix
- [ ] TimeRoot block types not shown in Library
- [ ] If timeRoot block somehow selected, Inspector shows "Hidden block" message
- [ ] Demo patch time blocks have `role: timeRootRole()`

**Files to modify:**
- `src/ui/components/TableView.ts` - Add filter
- `src/ui/registry/blockTypes.ts` - Add `isTimeRoot` flag
- `src/ui/components/BlockLibrary.ts` - Filter out timeRoot types
- `src/main.ts` - Ensure demo patch uses timeRootRole()

---

### P7: DefaultSource Display in Inspector

**Goal**: Show default sources for each input port in the Inspector.

**Concept from spec (13-DefaultSources.md):**
- Every input always has exactly one source
- If no explicit source connected, DefaultSource provides fallback
- DefaultSource can be: rail reference, constant value, or none

**Current DefaultSource type:**
```typescript
interface DefaultSource {
  readonly value: unknown;
}
```

**Enhanced type needed:**
```typescript
interface DefaultSource {
  readonly kind: 'rail' | 'constant' | 'none';
  readonly railId?: string;    // When kind='rail' - e.g., 'phaseA'
  readonly value?: unknown;    // When kind='constant' - e.g., 0.5
}
```

**Inspector display:**
```
INPUTS
├─ phase    Signal<phase>    ← time.phaseA
├─ id01     Field<float>     ← domain.id01
├─ base     Signal<float>    (not connected)
│                            └─ Default: 0.35 (constant)
├─ spread   Signal<float>    (not connected)
│                            └─ Default: phaseA (rail)
└─ amplitude Signal<float>   (not connected)
                             └─ Default: (none)

DEFAULT SOURCES (collapsed by default)
├─ phase    ← phaseA (rail)
├─ base     ← 0.35 (constant)
├─ spread   ← phaseA (rail)
└─ amplitude ← (none)
```

**Implementation approach:**
1. Enhance DefaultSource type in `src/types/index.ts`
2. Add `defaultSources?: Map<PortId, DefaultSource>` to BlockTypeInfo
3. In BlockInspector, show default source below unconnected ports
4. Add collapsible "DEFAULT SOURCES" section showing all defaults

**Data flow:**
1. Block registry defines default sources per port
2. Inspector reads block type from registry
3. For each input port, check if connected (has edge)
4. If not connected, show default source from registry

**Acceptance Criteria:**
- [ ] DefaultSource type enhanced with kind discriminant
- [ ] BlockTypeInfo has optional defaultSources map
- [ ] At least 3 block types have default sources defined
- [ ] Inspector shows default source for unconnected inputs
- [ ] Default source shows kind (rail/constant/none) and value
- [ ] Clickable rail references navigate to rail block (if visible)

**Files to modify:**
- `src/types/index.ts` - Enhance DefaultSource type
- `src/ui/registry/blockTypes.ts` - Add defaultSources to block defs
- `src/ui/components/BlockInspector.ts` - Display default sources

---

### P8: Block Type Preview in Inspector

**Goal**: When selecting a block type in Library, show its info in Inspector (preview mode).

**Current state**: Library shows block list, clicking does nothing special.

**Target state**:
- Click block type in Library → Inspector shows type preview
- Preview shows: type name, description, input/output ports with types
- Clearly distinguished from "inspecting actual block" mode

**Inspector preview mode:**
```
┌─────────────────────────────────────┐
│ [TYPE PREVIEW]                      │
│ FieldPulse                          │
│ Field Operations                    │
├─────────────────────────────────────┤
│ Per-element pulsing animation       │
│ with phase offset                   │
├─────────────────────────────────────┤
│ INPUTS                              │
│ ├─ phase     Signal<phase>          │
│ ├─ id01      Field<float>           │
│ ├─ base      Signal<float>          │
│ │            Default: 0.35          │
│ ├─ amplitude Signal<float>          │
│ │            Default: 1.0           │
│ └─ spread    Signal<float>          │
│              Default: phaseA        │
├─────────────────────────────────────┤
│ OUTPUTS                             │
│ └─ value     Field<float>           │
└─────────────────────────────────────┘
```

**Implementation approach:**
1. Add `previewType: string | null` to selection state
2. BlockLibrary sets previewType on click
3. Inspector checks: block selected? Show block. previewType set? Show type preview.
4. Type preview shows info from BlockTypeInfo registry

**Acceptance Criteria:**
- [ ] Selection state has `previewType` field
- [ ] Clicking block type in Library sets previewType
- [ ] Inspector shows type preview when previewType set
- [ ] Preview clearly labeled "[TYPE PREVIEW]"
- [ ] Shows description, inputs, outputs, defaults
- [ ] Selecting actual block clears previewType

**Files to modify:**
- `src/ui/state/selection.ts` - Add previewType
- `src/ui/components/BlockLibrary.ts` - Set previewType on click
- `src/ui/components/BlockInspector.ts` - Render type preview mode

---

## Dependencies

```
P5 (TimeRoot Hidden)
    ↓
P3 (Connection Matrix) ← needs filtering to work correctly
    ↓
P4 (Split Sidebar) ← independent, can be parallel
    ↓
P7 (DefaultSource) ← needs enhanced types first
    ↓
P8 (Type Preview) ← builds on P7 defaults display
```

**Recommended order:**
1. P5: TimeRoot Hidden (quick, enables P3)
2. P4: Split Sidebar (parallel, standalone)
3. P3: Connection Matrix (major work)
4. P7: DefaultSource Display (type changes + UI)
5. P8: Type Preview (builds on P7)

---

## Risks

1. **Connection Matrix complexity** - Major TableView rewrite, could have scrolling/sizing issues
2. **Split Panel drag UX** - Need smooth drag handling, edge cases for min sizes
3. **DefaultSource data** - Need to populate default sources in registry for many block types

---

## Verification Checklist

### Automated
- [ ] TypeScript compiles without errors (`npm run typecheck`)
- [ ] All tests pass (`npm run test`)

### Manual Runtime
- [ ] Connection matrix displays correctly with test patch
- [ ] Matrix cells clickable, highlights correct edges
- [ ] TimeRoot blocks not visible anywhere
- [ ] Split sidebar works with resize
- [ ] Inspector shows default sources for unconnected ports
- [ ] Library click shows type preview in Inspector
- [ ] All UI states render cleanly (no selection, block selected, type preview)

---

## Files Summary

**New files:**
- `src/ui/components/SplitPanel.ts`

**Major modifications:**
- `src/ui/components/TableView.ts` (connection matrix rewrite)
- `src/ui/components/BlockInspector.ts` (default sources, type preview)
- `src/ui/registry/blockTypes.ts` (default sources, timeRoot flag)
- `src/ui/state/selection.ts` (previewType)
- `src/main.ts` (split sidebar)

**Minor modifications:**
- `src/types/index.ts` (DefaultSource enhancement)
- `src/ui/components/BlockLibrary.ts` (timeRoot filter, preview click)
- `src/ui/components/index.ts` (SplitPanel export)
