# Sprint Plan: UI Features v2 - Phase 2

**Generated**: 2026-01-10 00:15
**Topic**: ui-features-v2
**Predecessor**: PLAN-20260109-235000.md (Phase 1 complete)

## Sprint Goal

Complete remaining visualization features: Connection matrix table, Rails section, DefaultSource display, Domain assignment display, block type preview, and split sidebar layout.

## Scope

**In scope (this sprint):**
1. P0: Rewrite Table View as Connection Matrix
2. P1: Rails section in Connection Matrix
3. P2: DefaultSource on ports model + display
4. P3: Domain assignment (domainId on Block - NOT optional, can be null)
5. P4: Block type preview in Inspector
6. P5: Split sidebar layout (Library top, Inspector bottom)

**Out of scope (future):**
- Domain propagation logic (auto-assignment)
- Editing capabilities (add/remove blocks, edges)
- Rail creation/editing

---

## Work Items

### P0: Rewrite Table View as Connection Matrix

**Goal**: Display blocks × blocks matrix showing edge connections between all blocks.

**Visual:**
```
           │ b0    │ b1     │ b2    │ b3    │ ...
───────────┼───────┼────────┼───────┼───────┼─────
b0 (Time)  │   -   │        │       │       │
b1 (Domain)│       │   -    │ ●(1)  │       │
b2 (Field) │ ●(1)  │        │   -   │       │
b3 (Const) │       │        │       │   -   │ ●(1)
...        │       │        │       │       │
```

**Acceptance Criteria:**
- [ ] Rows = all blocks, Columns = all blocks (same order)
- [ ] Row headers show block ID and type
- [ ] Column headers show block ID (abbreviated)
- [ ] Cell shows edge indicator when connection exists (source row → target col)
- [ ] Cell can show edge count if multiple edges between same blocks
- [ ] Clicking cell selects the edge(s) between those blocks
- [ ] Clicking row header selects that block
- [ ] Diagonal cells marked as N/A (self-connection)

**Technical Notes:**
- Build adjacency matrix from patch.edges
- Edge from A→B means cell[A][B] is filled
- Consider hover to show port details

**Files to modify:**
- `src/ui/components/TableView.ts` - Complete rewrite

---

### P1: Rails Section in Connection Matrix

**Goal**: Show Rail blocks in a separate "Rails" section in the matrix.

**Acceptance Criteria:**
- [ ] Matrix divided: Blocks section, then Rails section (both rows and columns)
- [ ] Section headers visually distinct
- [ ] Rails can connect to Blocks and other Rails
- [ ] Same click behavior for rail rows/columns

**Technical Notes:**
- Partition blocks by `block.type === 'Rail'`
- Matrix structure:
  ```
            │ BLOCKS        │ RAILS    │
  ──────────┼───────────────┼──────────┤
  BLOCKS    │ block×block   │ block→rail│
  ──────────┼───────────────┼──────────┤
  RAILS     │ rail→block    │ rail×rail │
  ```

**Files to modify:**
- `src/ui/components/TableView.ts`

---

### P2: DefaultSource on Ports

**Goal**: Add defaultSource field to port definitions and display in Inspector.

**Acceptance Criteria:**
- [ ] `DefaultSource` interface enhanced: `{ kind: 'rail' | 'constant'; railId?: RailId; value?: unknown }`
- [ ] Block type registry includes defaultSource for applicable inputs
- [ ] Inspector shows "Default: phaseA" or "Default: 0.5" for ports with defaults
- [ ] Ports without defaults show no default indicator

**Technical Notes:**
- Enhance `DefaultSource` in `src/types/index.ts`
- Update `blockTypes.ts` registry with default sources for common ports
- Common defaults: phase inputs → phaseA rail, numeric inputs → constant values
- Inspector displays default source below connection info for each port

**Files to modify:**
- `src/types/index.ts` - Enhance DefaultSource interface
- `src/ui/registry/blockTypes.ts` - Add defaultSource to port definitions
- `src/ui/components/BlockInspector.ts` - Display default sources

---

### P3: Domain Assignment Display

**Goal**: Add domainId to Block model (REQUIRED field, can be null) and display with clickable link.

**Acceptance Criteria:**
- [ ] `Block` interface has `domainId: string | null` field (NOT optional - property MUST exist)
- [ ] Inspector shows "DOMAIN" section with clickable link to domain details
- [ ] Clicking domain link navigates to Domains panel and highlights that domain
- [ ] Demo patch field blocks have domainId set to domain block's ID

**Technical Notes:**
- `domainId` is REQUIRED field that can be null (not optional with ?)
- Clicking domain link: switch right sidebar to Domains tab, scroll to/highlight domain
- For demo patch, manually set domainId on field blocks in `buildAndCompile()`

**Files to modify:**
- `src/graph/Patch.ts` - Add `domainId: string | null` to Block interface
- `src/graph/Patch.ts` - Update PatchBuilder.addBlock() to require domainId
- `src/main.ts` - Set domainId on all blocks in demo patch
- `src/ui/components/BlockInspector.ts` - Display clickable domain link
- `src/ui/components/DomainsPanel.ts` - Add method to highlight/scroll to domain

---

### P4: Block Type Preview in Inspector

**Goal**: Show block type details in Inspector when clicking Library items.

**Acceptance Criteria:**
- [ ] Clicking block type in Library shows preview in Inspector
- [ ] Preview shows: name, description, all ports with types
- [ ] Preview has "TYPE PREVIEW" header to distinguish from selected block
- [ ] Clicking a patch block replaces preview with actual block inspection

**Technical Notes:**
- Add `previewType` to selection state (separate from `selectedBlockId`)
- Inspector checks: if previewType set → show type preview, else show block
- Library click sets `previewType`, patch click clears it and sets `selectedBlockId`

**Files to modify:**
- `src/ui/state/selection.ts` - Add previewType field
- `src/ui/components/BlockLibrary.ts` - Set previewType on click
- `src/ui/components/BlockInspector.ts` - Handle preview mode
- `src/ui/components/TableView.ts` - Clear previewType on block click

---

### P5: Split Sidebar Layout

**Goal**: Left sidebar has horizontal split: Library on top, Inspector on bottom (not tabs).

**Acceptance Criteria:**
- [ ] Left sidebar divided horizontally: Library (top), Inspector (bottom)
- [ ] Resizable divider between Library and Inspector
- [ ] Both panels visible simultaneously
- [ ] Right sidebar unchanged (Domains + Help tabs)

**Technical Notes:**
- Replace TabbedContent in left region with split panel layout
- Create `SplitPanel` component or use CSS flexbox with resizable divider
- Default split: ~40% Library, ~60% Inspector (or configurable)

**Files to modify:**
- `src/ui/components/SplitPanel.ts` - New component for horizontal split
- `src/main.ts` - Update setupUI() to use split layout for left sidebar
- `src/ui/components/index.ts` - Export SplitPanel

---

## Dependencies

- P0 depends on: Rail block type existing (confirmed: 'Rail' in registry)
- P1 depends on: Block type registry (complete from Phase 1)
- P2 depends on: Nothing new
- P3 depends on: Selection state (complete from Phase 1)

## Risks

1. **Demo patch doesn't use Rails** - May need to add a Rail to demo for testing
2. **Domain assignment manual** - Need to update demo patch builder to set domainIds
3. **DefaultSource inference** - Keeping it simple (manual) for now, future work for auto

## Estimated Effort

- P0: 30 min (partition and render sections)
- P1: 45 min (type updates, registry updates, inspector display)
- P2: 45 min (type update, demo patch changes, UI display)
- P3: 30 min (selection state, inspector preview mode)

Total: ~2.5 hours
