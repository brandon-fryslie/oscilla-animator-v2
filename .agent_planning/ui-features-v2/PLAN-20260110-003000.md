# Sprint Plan: UI Features v2 - Phase 2 (Revised)

**Generated**: 2026-01-10 00:30
**Topic**: ui-features-v2
**Predecessor**: PLAN-20260109-235000.md (Phase 1 complete)

## Sprint Goal

Complete visualization features with proper Block model: Connection matrix, BlockRole system, Bus blocks, displayName, and split sidebar layout.

## Scope

**In scope (this sprint):**
1. P0: Block model enhancements (role, displayName, domainId)
2. P1: BlockRole system redesign (all roles have meta)
3. P2: Bus block (rename Rail, fixed 2-in/2-out)
4. P3: Connection Matrix table view
5. P4: Split sidebar layout (Library top, Inspector bottom)
6. P5: TimeRoot blocks hidden from UI
7. P6: Delete RailId type

**Out of scope (future):**
- Variadic ports (not needed - use chained blocks)
- Domain propagation logic
- Editing capabilities
- DefaultSource display (defer to later sprint)
- Block type preview in Inspector (defer to later sprint)

---

## Work Items

### P0: Block Model Enhancements

**Goal**: Add required fields to Block interface.

**Changes to Block interface:**
```typescript
interface Block {
  readonly id: BlockId;
  readonly type: BlockType;
  readonly params: Readonly<Record<string, unknown>>;
  readonly label?: string;  // KEEP for backwards compat, but prefer displayName
  readonly displayName: string | null;  // NEW: User-editable name
  readonly domainId: string | null;     // NEW: Reference to domain block
  readonly role: BlockRole;             // NEW: Semantic role
}
```

**Acceptance Criteria:**
- [ ] Block interface has `displayName: string | null` (REQUIRED, not optional)
- [ ] Block interface has `domainId: string | null` (REQUIRED, not optional)
- [ ] Block interface has `role: BlockRole` (REQUIRED, not optional)
- [ ] PatchBuilder updated to require these fields
- [ ] All existing tests updated to provide new fields
- [ ] Demo patch in main.ts updated

**Files to modify:**
- `src/graph/Patch.ts` - Block interface, PatchBuilder
- `src/main.ts` - Demo patch construction
- All test files that create blocks

---

### P1: BlockRole System Redesign

**Goal**: All roles have meta. Add semantic roles for editor behavior.

**New BlockRole type:**
```typescript
type BlockRole =
  | { readonly kind: 'user';      readonly meta: UserBlockMeta }
  | { readonly kind: 'timeRoot';  readonly meta: TimeRootMeta }
  | { readonly kind: 'bus';       readonly meta: BusMeta }
  | { readonly kind: 'domain';    readonly meta: DomainMeta }
  | { readonly kind: 'renderer';  readonly meta: RendererMeta }
  | { readonly kind: 'derived';   readonly meta: DerivedBlockMeta };

// Meta types - empty for now, structure allows future extension
interface UserBlockMeta {}
interface TimeRootMeta {}
interface BusMeta {}
interface DomainMeta {}
interface RendererMeta {}
// DerivedBlockMeta already exists
```

**Acceptance Criteria:**
- [ ] All BlockRole kinds have a meta field
- [ ] New roles added: `timeRoot`, `bus`, `domain`, `renderer`
- [ ] Helper functions to create each role type
- [ ] Existing code using BlockRole updated

**Files to modify:**
- `src/types/index.ts` - BlockRole type definition

---

### P2: Bus Block (Rename Rail)

**Goal**: Rename Rail to Bus, fixed 2-in/2-out ports.

**Bus block definition:**
```typescript
registerBlock({
  kind: 'Bus',
  inputs: [
    { portId: 'in_0', type: sigType('float'), optional: true },
    { portId: 'in_1', type: sigType('float'), optional: true },
  ],
  outputs: [
    { portId: 'out_0', type: sigType('float') },
    { portId: 'out_1', type: sigType('float') },
  ],
  lower: lowerBus,
});
```

**Acceptance Criteria:**
- [ ] Rail block renamed to Bus
- [ ] Bus has 2 inputs (in_0, in_1) and 2 outputs (out_0, out_1)
- [ ] Passthrough behavior: out_0 = in_0, out_1 = in_1
- [ ] Optional inputs default to 0 if not connected
- [ ] Test coverage for Bus block

**Files to modify:**
- `src/compiler/blocks/rail/index.ts` → rename to `bus/index.ts`
- `src/compiler/blocks/index.ts` - Update import
- `src/compiler/blocks/__tests__/rail.test.ts` → `bus.test.ts`

---

### P3: Connection Matrix Table View

**Goal**: Display blocks × blocks matrix showing edge connections.

**Visual:**
```
           │ b0    │ b1     │ b2    │ b3    │ ...
───────────┼───────┼────────┼───────┼───────┼─────
b0 (Time)  │   -   │        │   ●   │       │
b1 (Domain)│       │   -    │   ●   │       │
b2 (Field) │       │        │   -   │       │
b3 (Const) │       │        │   ●   │   -   │
```

**Sections:**
1. Blocks with role != 'bus' and role != 'timeRoot'
2. Bus blocks (role.kind === 'bus')
3. TimeRoot blocks HIDDEN (role.kind === 'timeRoot')

**Acceptance Criteria:**
- [ ] Rows = blocks, Columns = blocks (same order)
- [ ] Row headers show displayName (or id if null) and type
- [ ] Column headers show displayName (or id)
- [ ] Cell shows ● when edge exists (row → col)
- [ ] Cell shows edge count if multiple edges
- [ ] Clicking cell selects edge(s)
- [ ] Clicking row header selects block
- [ ] Diagonal cells marked N/A
- [ ] Bus blocks in separate "Buses" section
- [ ] TimeRoot blocks hidden entirely

**Files to modify:**
- `src/ui/components/TableView.ts` - Complete rewrite

---

### P4: Split Sidebar Layout

**Goal**: Left sidebar has horizontal split: Library (top), Inspector (bottom).

**Acceptance Criteria:**
- [ ] Left sidebar divided horizontally
- [ ] Library panel on top
- [ ] Inspector panel on bottom
- [ ] Resizable divider between them
- [ ] Both visible simultaneously (no tabs)
- [ ] Right sidebar unchanged (Domains + Help tabs)

**Files to modify:**
- `src/ui/components/SplitPanel.ts` - New component
- `src/main.ts` - Update setupUI() for split layout
- `src/ui/components/index.ts` - Export SplitPanel

---

### P5: TimeRoot Hidden from UI

**Goal**: Blocks with role.kind === 'timeRoot' are hidden from all UI views.

**Acceptance Criteria:**
- [ ] Table view filters out timeRoot blocks
- [ ] Block Library does not show timeRoot block types
- [ ] Inspector handles case where selected block is timeRoot (shouldn't happen)
- [ ] Demo patch TimeBlock has role: { kind: 'timeRoot', meta: {} }

**Files to modify:**
- `src/ui/components/TableView.ts` - Filter timeRoot
- `src/ui/registry/blockTypes.ts` - Mark InfiniteTimeRoot etc. as timeRoot
- `src/main.ts` - Set timeRoot role on time blocks

---

### P6: Delete RailId Type

**Goal**: Remove RailId - no longer needed.

**Acceptance Criteria:**
- [ ] RailId type deleted from src/types/index.ts
- [ ] All references to RailId removed
- [ ] DefaultSource type updated (if it references RailId)

**Files to modify:**
- `src/types/index.ts` - Delete RailId
- Any files referencing RailId

---

## Dependencies

- P0 must be done first (other items depend on new Block fields)
- P1 must be done before P3/P5 (role system needed for filtering)
- P2 can be done in parallel with P1
- P3/P4/P5 can be done after P0/P1

## Risks

1. **Many test updates** - Block interface changes require updating all tests
2. **Breaking change** - Existing code using old Block interface will fail
3. **Demo patch complexity** - Need to assign roles/domains to many blocks

## Order of Implementation

1. P1: BlockRole redesign (types only)
2. P0: Block model enhancements (interface + builder)
3. P6: Delete RailId
4. P2: Bus block
5. P3: Connection Matrix
6. P4: Split sidebar
7. P5: TimeRoot hidden
