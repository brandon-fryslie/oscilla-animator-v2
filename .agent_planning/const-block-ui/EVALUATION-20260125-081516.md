# Evaluation: Const Block UI and Value Validation

Timestamp: 2026-01-25-081516
Git Commit: 141705b

## Executive Summary

Overall: 40% complete | Critical issues: 2 | Tests reliable: partial

The Const block exists with functional lowering for all payload types, but the UI layer assumes all values are numeric (float) with basic slider controls. No type-appropriate editors exist for vec2, color, or bool. Value validation at type resolution time is also missing.

---

## Work Items Evaluated

### 1. "UI for Const block should show type-appropriate value editor"
### 2. "Validate value representation when type is resolved"

---

## Current Implementation Analysis

### Const Block Definition (signal-blocks.ts:31-159)

**Status**: PARTIAL

The Const block is properly defined as payload-generic with ALL_CONCRETE_PAYLOADS:
- Allowed: `float`, `int`, `bool`, `vec2`, `color`, `shape`, `cameraProjection`
- The `lower` function handles all types correctly at compile time
- Type resolution happens in `pass0-payload-resolution.ts`

**Evidence**:
```typescript
// signal-blocks.ts:44-54
payload: {
  allowedPayloads: {
    out: ALL_CONCRETE_PAYLOADS,  // ['float', 'int', 'bool', 'vec2', 'color', 'shape', 'cameraProjection']
  },
  combinations: ALL_CONCRETE_PAYLOADS.map(p => ({
    inputs: [] as PayloadType[],
    output: p,
  })),
  semantics: 'typeSpecific',
},
```

**Issues**:
1. The `value` input is hardcoded as `type: signalType('float')` (line 57), which is misleading
2. No `uiHint` that adapts based on resolved type

### UI Editor Components (BlockInspector.tsx, ParameterControls.tsx)

**Status**: PARTIAL - Float-only support

**Evidence from BlockInspector.tsx:1424-1435**:
```typescript
{/* Const Block - Direct Value Editor */}
{isConstBlock && (
  <div style={{ marginBottom: '12px' }}>
    <SliderWithInput
      label="Value"
      value={constValue}
      onChange={(value) => handleParamChange('value', value)}
      min={getConstSliderMin(inputDef, portType)}
      max={getConstSliderMax(inputDef, portType)}
      step={getConstSliderStep(inputDef, portType)}
    />
  </div>
)}
```

This code ONLY renders a slider, which is appropriate for `float` but NOT for:
- `vec2` - needs X/Y coordinate editors
- `color` - needs color picker (MuiColorInput exists)
- `bool` - needs checkbox
- `int` - needs integer slider/input

**Available UI Control Types** (types/index.ts:277-285):
```typescript
export type UIControlHint =
  | { kind: 'slider'; min: number; max: number; step: number }
  | { kind: 'int'; min?: number; max?: number; step?: number }
  | { kind: 'float'; min?: number; max?: number; step?: number }
  | { kind: 'select'; options: { value: string; label: string }[] }
  | { kind: 'color' }
  | { kind: 'boolean' }
  | { kind: 'text' }
  | { kind: 'xy' };
```

The `HintedControl` component (BlockInspector.tsx:1849-1949) ALREADY supports:
- `color` via MuiColorInput
- `boolean` via MuiCheckboxInput
- `xy` via dual SliderWithInput

But the Const block editor doesn't use HintedControl - it uses a hardcoded slider.

### Type Resolution (pass0-payload-resolution.ts)

**Status**: COMPLETE for inference, MISSING validation

The pass correctly propagates payload types from connected blocks:
- Forward resolution: Const -> target input type
- Backward resolution: source output -> Const
- Resolved type stored in `block.params.payloadType`

**Missing**: No validation that `block.params.value` matches the resolved `payloadType`.

**Evidence** (pass0-payload-resolution.ts:126-137):
```typescript
// Update block params with inferred payload type
if (inferredPayloadType) {
  const updatedBlock: Block = {
    ...block,
    params: {
      ...block.params,
      payloadType: inferredPayloadType,  // Sets type, but doesn't validate value!
    },
  };
```

### Value Validation in Lower Function (signal-blocks.ts:94-151)

**Status**: Runtime validation exists, compile-time validation missing

The `lower` function validates value structure at compile time:
```typescript
case 'vec2': {
  const val = rawValue as { x?: number; y?: number };
  if (typeof val !== 'object' || val === null) {
    throw new Error(`Const<vec2> requires {x, y} object, got ${typeof rawValue}`);
  }
  // ... validates x and y are numbers
}
```

But this error only surfaces during compilation, not when the user edits the value.

---

## Missing Checks

### 1. Type-aware value editor selector
When displaying a Const block's value editor, the UI should:
- Read `block.params.payloadType` to determine resolved type
- Select appropriate editor based on that type
- Handle undefined payloadType (unresolved) gracefully

### 2. Value validation on edit
When user changes a Const block value:
- If payloadType is known, validate value matches expected structure
- For vec2: validate `{x: number, y: number}`
- For color: validate `{r: number, g: number, b: number, a: number}`
- For bool: validate boolean
- For int: validate integer (no decimals)

---

## Findings

### Component: Const Block UI Editor

**Status**: PARTIAL
**Evidence**: BlockInspector.tsx:1424-1435 shows hardcoded SliderWithInput
**Issues**:
1. No type dispatch based on resolved payloadType
2. Missing vec2 editor (needs xy hint)
3. Missing color editor (MuiColorInput exists but not used)
4. Missing boolean editor (MuiCheckboxInput exists but not used)
5. Integer constraint not enforced for int type

### Component: Value Validation

**Status**: NOT_STARTED
**Evidence**: pass0-payload-resolution.ts sets payloadType but doesn't validate value
**Issues**:
1. Type-value mismatch can persist until lowering phase
2. User gets cryptic error at compile time instead of immediate feedback
3. No diagnostic emitted for invalid value representation

---

## Ambiguities Found

| Area | Question | How LLM Guessed | Impact |
|------|----------|-----------------|--------|
| Default value structure | When payloadType changes, should existing value be migrated or reset? | Not addressed | LOW - can reset to defaults |
| Unresolved type display | What editor to show when payloadType is undefined? | Could use float as fallback | MEDIUM - user confusion |
| Invalid value state | Should invalid values prevent compilation or just warn? | Current behavior: runtime error in lower() | LOW - existing behavior is acceptable |

---

## Recommendations

### Priority 1: Type-aware editor selector

In `PortDefaultSourceEditor` (BlockInspector.tsx) or create a new `ConstValueEditor`:

```typescript
// Pseudo-code
const payloadType = currentParams.payloadType || 'float';
switch (payloadType) {
  case 'float':
    return <SliderWithInput ... />;
  case 'int':
    return <SliderWithInput step={1} ... />;
  case 'vec2':
    return <HintedControl hint={{ kind: 'xy' }} ... />;
  case 'color':
    return <HintedControl hint={{ kind: 'color' }} ... />;
  case 'bool':
    return <HintedControl hint={{ kind: 'boolean' }} ... />;
  default:
    return <SliderWithInput ... />; // Fallback
}
```

### Priority 2: Value validation in pass0 or authoringValidators

Add diagnostic when value doesn't match resolved type:
- E_CONST_VALUE_TYPE_MISMATCH: "Const block expects {payloadType} but value is {typeof value}"

### Priority 3: Default value initialization

When payloadType is resolved/changed, provide sensible defaults:
- float: 0.5
- int: 1
- vec2: {x: 0.5, y: 0.5}
- color: {r: 1, g: 1, b: 1, a: 1}
- bool: true

---

## Dependencies

1. **Blocking**: None - UI components exist, just need connection
2. **Required Components**:
   - MuiColorInput (exists at src/ui/components/common/ColorInput.tsx)
   - MuiCheckboxInput (exists)
   - SliderWithInput for xy (HintedControl already handles it)

---

## Verdict

- [x] CONTINUE - Issues clear, implementer can fix

The work is well-scoped. All required UI primitives exist. The main task is:
1. Dispatch to correct editor based on `payloadType`
2. Add value validation in compiler pass or authoring validators
3. Handle type transitions gracefully

No spec ambiguities block implementation.

---

## Files Involved

| File | Role | Lines |
|------|------|-------|
| `/Users/bmf/code/oscilla-animator-v2/src/blocks/signal-blocks.ts` | Const block definition | 31-159 |
| `/Users/bmf/code/oscilla-animator-v2/src/ui/components/BlockInspector.tsx` | Port/default source editors | 1311-1497, 1849-1949 |
| `/Users/bmf/code/oscilla-animator-v2/src/ui/reactFlowEditor/ParameterControls.tsx` | Inline parameter controls | 225-377 |
| `/Users/bmf/code/oscilla-animator-v2/src/compiler/passes-v2/pass0-payload-resolution.ts` | Type inference | 31-148 |
| `/Users/bmf/code/oscilla-animator-v2/src/diagnostics/validators/authoringValidators.ts` | Authoring-time validation | (add validation here) |
| `/Users/bmf/code/oscilla-animator-v2/src/types/index.ts` | UIControlHint types | 277-285 |
