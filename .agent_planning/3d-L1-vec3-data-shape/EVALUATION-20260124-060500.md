# Evaluation: 3D Level 1 - vec3 Data Shape

## Current State

Level 1 has existing implementation in `src/projection/` (fields.ts, layout-kernels.ts) and passing tests
in `src/projection/__tests__/level1-vec3-data.test.ts` (14 tests pass). However:

### Critical Gap

The existing L1 tests exercise the **projection module's own** data structures (`createPositionField`,
`gridLayout3D`, etc.) — NOT the real runtime pipeline. The L1 INVARIANT explicitly requires:

> `executeFrame()` with any patch containing a layout block produces a position buffer that is a
> contiguous `Float32Array` with stride 3, and the app's Materializer writes to it via the standard
> field-slot pipeline

The core runtime currently uses **vec2 (stride 2)** for positions:
- `PayloadType` has `'vec2'` but no `'vec3'`
- `BufferFormat` has `'vec2f32'` but no `'vec3f32'`
- `allocateBuffer('vec2f32', N)` → `new Float32Array(N * 2)`
- Layout kernels in `FieldKernels.ts` write stride-2 (`outArr[i*2+0]`, `outArr[i*2+1]`)
- Position intrinsic produces vec2

### What Must Change

1. **Type system**: Add `'vec3'` to `PayloadType`
2. **Buffer pool**: Add `'vec3f32'` format, allocate `count * 3`
3. **Layout kernels**: Change `gridLayout`, `circleLayout`, `lineLayout` to write stride-3 with z=0.0
4. **Position intrinsic**: Change to produce vec3
5. **Materializer broadcast**: Handle vec3 broadcast case
6. **makeVec2 → makeVec3?**: Either keep makeVec2 for non-position fields or add makeVec3
7. **RenderAssembler**: Update position reading (currently expects stride 2)
8. **Integration test**: Write test going through real `executeFrame()` pipeline

### Risk Assessment

This is a **significant refactor** of a core data type. Every consumer of position data must be updated:
- RenderAssembler reads position as vec2 → must handle vec3
- Canvas2DRenderer and SVGRenderer consume position from RenderPassIR
- The `makeVec2` kernel is used to construct positions from x,y fields

### Score Disqualifiers Present

- **Checkbox 9** ("Compile a minimal patch"): Current test simulates compilation (Score Disqualifier #4)
- **L1 INVARIANT**: No test exercises `executeFrame()` through the Materializer

## Verdict: CONTINUE

The path is clear, albeit with significant scope. The work is:
1. Extend the type system and buffer pool (mechanical)
2. Update layout kernels to stride-3 (mechanical)
3. Update position consumers (RenderAssembler, backends) (moderate)
4. Write proper integration test through `executeFrame()` (the real verification)

No blockers. No ambiguities requiring user input.
