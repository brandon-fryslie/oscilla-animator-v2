# Definition of Done: RenderAssembler v2

**Bead**: oscilla-animator-v2-583
**Created**: 2026-01-22

## Acceptance Criteria

### Must Have

- [ ] `assembleDrawPathInstancesOp()` function exists and produces valid `DrawPathInstancesOp`
- [ ] `assembleRenderFrame_v2()` function exists and returns `RenderFrameIR_Future` with `version: 2`
- [ ] Output types match `src/render/future-types.ts` exactly (no deviations)
- [ ] All existing tests pass (v1 path unchanged and functional)
- [ ] New unit tests validate v2 output structure
- [ ] Type-safe implementation: no `as any` casts

### Structure Validation

The `DrawPathInstancesOp` must contain:

```typescript
{
  kind: 'drawPathInstances',
  geometry: {
    topologyId: number,           // From resolved shape
    verbs: Uint8Array,            // From topology registry
    points: Float32Array,         // Local-space control points
    pointsCount: number,          // vec2 count
    flags?: number                // Optional path flags
  },
  instances: {
    count: number,                // Instance count
    position: Float32Array,       // World-space [0,1] positions
    size: number | Float32Array,  // Isotropic scale
    rotation?: Float32Array,      // Optional per-instance rotation
    scale2?: Float32Array         // Optional anisotropic scale
  },
  style: {
    fillColor: Uint8ClampedArray, // RGBA color data
    fillRule?: 'nonzero' | 'evenodd',
    globalAlpha?: number | Float32Array
  }
}
```

### Code Quality

- [ ] Functions have JSDoc comments explaining purpose and contracts
- [ ] Helper functions are small and focused (single responsibility)
- [ ] Error messages are actionable (tell user what to do)
- [ ] No console.log statements left in production code

### Non-Breaking Guarantee

- [ ] Existing `assembleRenderPass()` function unchanged
- [ ] Existing `assembleAllPasses()` function unchanged
- [ ] `RenderPassIR` type unchanged
- [ ] Canvas2DRenderer continues to work with v1 format
- [ ] All existing integration tests pass

## Out of Scope

These are explicitly NOT part of this work:

- Renderer changes (separate bead: oscilla-animator-v2-46m)
- Per-instance shapes (Field<shape>) support
- Stroke rendering implementation
- SVG renderer (separate bead: oscilla-animator-v2-0uk)
- Converting topology IDs from string to numeric
- Removing v1 code path

## Verification Steps

1. Run `npm run typecheck` - must pass
2. Run `npm run test` - must pass
3. Run `npm run build` - must pass
4. Manual verification: existing animation renders correctly
5. Unit tests confirm v2 structure matches future-types.ts
