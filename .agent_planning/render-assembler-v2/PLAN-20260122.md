# RenderAssembler v2: Produce DrawPathInstancesOp

**Bead**: oscilla-animator-v2-583
**Status**: Planning
**Created**: 2026-01-22

## Summary

Enhance RenderAssembler to produce `DrawPathInstancesOp` structures that align with the future render IR model. This is the bridge between the current v1 `RenderPassIR` and the target v2 `RenderFrameIR_Future`.

## Current State

**RenderAssembler.ts** (294 lines) produces v1 `RenderPassIR`:
```typescript
interface RenderPassIR {
  kind: 'instances2d';
  count: number;
  position: ArrayBufferView;
  color: ArrayBufferView;
  scale: number;
  shape: ShapeDescriptor | ArrayBufferView | number; // @deprecated
  resolvedShape: ResolvedShape; // REQUIRED
}
```

**Canvas2DRenderer.ts** consumes v1 format with:
- Control point scaling by `width/height` (world-space assumption)
- `_size` parameter unused
- Topology dispatch via `getTopology()`

## Target State

**RenderAssembler** produces `DrawPathInstancesOp` (from `future-types.ts`):
```typescript
interface DrawPathInstancesOp {
  kind: 'drawPathInstances';
  geometry: PathGeometry;        // Local-space points
  instances: InstanceTransforms; // World-space transforms
  style: PathStyle;              // Explicit styling
}
```

## Gap Analysis

| Aspect | Current | Target | Gap |
|--------|---------|--------|-----|
| Output type | `RenderPassIR` | `DrawPathInstancesOp` | New structure |
| Geometry points | In `resolvedShape.controlPoints` | In `geometry.points` | Restructure |
| Instance data | Mixed with shape | Explicit `instances` struct | Separate |
| Style | Implicit via color buffer | Explicit `PathStyle` | Extract |
| Rotation | Not supported | `instances.rotation?` | Add plumbing |
| Scale2 | Not supported | `instances.scale2?` | Add plumbing |
| Coordinate space | World-space points | Local-space geometry | Already correct (polygonVertex outputs local) |

## Implementation Strategy

### Phase 1: Add V2 Output Path (Non-Breaking)

Keep v1 path working while adding v2 producer functions.

**Step 1.1**: Create `assembleDrawPathInstancesOp()` function
- Takes same inputs as current `assembleRenderPass()`
- Returns `DrawPathInstancesOp` structure
- Extracts geometry into `PathGeometry`
- Builds `InstanceTransforms` from position/size
- Builds `PathStyle` from color buffer

**Step 1.2**: Add `assembleRenderFrame_v2()` function
- Returns `RenderFrameIR_Future` with `version: 2`
- Calls `assembleDrawPathInstancesOp()` for each render step
- Lives alongside existing `assembleAllPasses()`

**Step 1.3**: Update ScheduleExecutor to support both versions
- Add version flag or runtime check
- When v2 requested, call v2 assembly path
- Existing v1 path unchanged

### Phase 2: Renderer Dual-Mode Support (Prerequisite for Phase 3)

**Step 2.1**: Update Canvas2DRenderer to accept both formats
- Type guard: `isRenderFrameV2(frame)`
- V2 path: iterate `ops`, dispatch on `op.kind`
- V1 path: existing implementation

**Step 2.2**: Implement `renderDrawPathInstances(op)`
- Use local-space geometry
- Apply instance transforms via `ctx.translate/rotate/scale`
- Apply explicit style from `PathStyle`

### Phase 3: Wire Through Instance Transforms (StepRender Enhancement)

**Step 3.1**: Extend `StepRender` IR type
```typescript
interface StepRender {
  // ... existing fields ...
  rotation?: { readonly k: 'sig' | 'slot'; ... }; // Optional rotation
  scale2?: { readonly k: 'slot'; readonly slot: ValueSlot }; // Optional vec2 scale
}
```

**Step 3.2**: Update compiler to emit rotation/scale2 slots when present
- Pass7 schedule generation needs update

**Step 3.3**: RenderAssembler reads new slots into InstanceTransforms

### Phase 4: Migrate to V2 Only (Breaking Change)

**Step 4.1**: Remove v1 assembly path
**Step 4.2**: Remove v1 renderer path
**Step 4.3**: Simplify types (remove deprecated fields)

## File Changes

### `src/runtime/RenderAssembler.ts`
- Add `assembleDrawPathInstancesOp()` function
- Add `assembleRenderFrame_v2()` function
- Add helper: `buildPathGeometry()`
- Add helper: `buildInstanceTransforms()`
- Add helper: `buildPathStyle()`

### `src/render/future-types.ts`
- Already has correct types ✓
- May need minor adjustments if gaps found

### `src/render/Canvas2DRenderer.ts` (Phase 2)
- Add `renderFrameV2()` dispatcher
- Add `renderDrawPathInstances()`
- Implement local-space transform rendering

### `src/compiler/ir/types.ts` (Phase 3)
- Extend `StepRender` with rotation/scale2

### `src/runtime/ScheduleExecutor.ts`
- Add version switch for v1 vs v2 assembly

## Algorithm: `assembleDrawPathInstancesOp()`

From spec section 6.1 (`.agent_planning/_future/3-local-space-spec-deeper.md`):

```
1. Resolve shape handle (uniform for now):
   - Read shape2d from scalar slot
   - Extract topologyId, pointsFieldSlot, pointsCount, flags

2. Materialize control points (local-space):
   - Get field decl from pointsFieldSlot
   - Materialize to Float32Array via Materializer

3. Materialize instance transforms (world-space):
   - Position: materialize position field
   - Size: read from signal or field slot
   - Rotation: read if present (optional)
   - Scale2: read if present (optional)

4. Assemble style:
   - Extract fillColor from color buffer
   - fillRule from flags
   - (Future: stroke, opacity, etc.)

5. Return DrawPathInstancesOp
```

## Definition of Done

1. ✅ `assembleDrawPathInstancesOp()` produces valid `DrawPathInstancesOp`
2. ✅ `assembleRenderFrame_v2()` returns `RenderFrameIR_Future`
3. ✅ All existing tests pass (v1 path unchanged)
4. ✅ New tests validate v2 output structure
5. ✅ Type-safe: no `as any` casts
6. ✅ Types align with `future-types.ts` exactly

## Out of Scope (Separate Beads)

- Renderer migration to use v2 (oscilla-animator-v2-46m)
- Per-instance shapes (Field<shape>)
- Stroke rendering
- SVG renderer (oscilla-animator-v2-0uk)
- Numeric topology IDs (currently strings)

## Dependencies

**Blocked by**: None (this is foundational work)

**Blocks**:
- oscilla-animator-v2-46m: Local-space renderer migration
- oscilla-animator-v2-0uk: SVG renderer with defs/use reuse

## Risk Assessment

| Risk | Mitigation |
|------|------------|
| Breaking existing renders | Phase 1 is non-breaking; v1 path preserved |
| Type mismatches | future-types.ts already defines target; follow exactly |
| Coordinate space confusion | Control points already local-space from polygonVertex |

## Testing Strategy

1. **Unit tests**: `RenderAssembler.test.ts`
   - Test `assembleDrawPathInstancesOp()` output structure
   - Test geometry extraction
   - Test instance transform building
   - Test style extraction

2. **Integration tests**:
   - V2 frame assembly produces renderable output
   - Existing v1 path still works

## Estimation

- Phase 1: ~200 lines of new code
- Phase 2: ~100 lines (renderer changes) - separate bead
- Phase 3: ~50 lines (IR extension) - may be part of this or separate
- Phase 4: Deletion, cleanup - separate bead

## Next Steps

1. Implement `assembleDrawPathInstancesOp()` and helpers
2. Add `assembleRenderFrame_v2()`
3. Write tests for v2 assembly
4. Verify no regression on v1 path
