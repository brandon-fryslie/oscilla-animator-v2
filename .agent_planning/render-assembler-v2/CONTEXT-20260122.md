# Context: RenderAssembler v2

**Bead**: oscilla-animator-v2-583
**Created**: 2026-01-22

## Problem Statement

The current render pipeline produces `RenderPassIR` (v1) which mixes geometry, instance data, and style together. The target architecture separates these concerns into explicit structures for better composability and to enable future optimizations (SVG defs/use reuse, batching, etc.).

## Architecture Background

### Current Flow (v1)

```
ScheduleExecutor.executeFrame()
  └─> assembleRenderPass() → RenderPassIR
        ├─ position: ArrayBufferView
        ├─ color: ArrayBufferView
        ├─ scale: number
        ├─ shape: ShapeDescriptor (deprecated)
        └─ resolvedShape: ResolvedShape
              ├─ topologyId, mode, params
              ├─ verbs (for paths)
              └─ controlPoints (for paths)

Canvas2DRenderer.renderFrame()
  └─> renderInstances2D()
        └─> renderPathAtParticle()
              └─> scales points by width/height (WRONG)
```

### Target Flow (v2)

```
ScheduleExecutor.executeFrame()
  └─> assembleRenderFrame_v2() → RenderFrameIR_Future
        └─> ops: DrawPathInstancesOp[]
              ├─ geometry: PathGeometry (local-space)
              ├─ instances: InstanceTransforms (world-space)
              └─ style: PathStyle (explicit)

Canvas2DRenderer.renderFrame() (future)
  └─> renderDrawPathInstances()
        └─> ctx.translate/rotate/scale → draw local points
```

## Key Files

### Source Files

| File | Purpose |
|------|---------|
| `src/runtime/RenderAssembler.ts` | Current v1 assembly (will add v2 functions) |
| `src/runtime/ScheduleExecutor.ts` | Frame execution, calls assembler |
| `src/render/future-types.ts` | Target type definitions (already exist) |
| `src/render/Canvas2DRenderer.ts` | Current renderer (unchanged in this work) |

### Spec Files

| File | Section |
|------|---------|
| `.agent_planning/_future/3-local-space-spec-deeper.md` | Section 6: RenderAssembler Algorithm |
| `.agent_planning/_future/8-before-render.md` | Full "before renderer" architecture |
| `.agent_planning/_future/9-renderer.md` | Renderer contract and future direction |

## Type Definitions

### Current Types (v1 - in ScheduleExecutor.ts)

```typescript
interface RenderPassIR {
  kind: 'instances2d';
  count: number;
  position: ArrayBufferView;
  color: ArrayBufferView;
  scale: number;
  shape: ShapeDescriptor | ArrayBufferView | number; // deprecated
  resolvedShape: ResolvedShape;
}

interface ResolvedShape {
  resolved: true;
  topologyId: TopologyId;
  mode: 'path' | 'primitive';
  params: Record<string, number>;
  verbs?: Uint8Array;
  controlPoints?: ArrayBufferView;
}
```

### Target Types (v2 - in future-types.ts)

```typescript
interface DrawPathInstancesOp {
  kind: 'drawPathInstances';
  geometry: PathGeometry;
  instances: InstanceTransforms;
  style: PathStyle;
}

interface PathGeometry {
  topologyId: number;
  verbs: Uint8Array;
  points: Float32Array;
  pointsCount: number;
  flags?: number;
}

interface InstanceTransforms {
  count: number;
  position: Float32Array;
  size: number | Float32Array;
  rotation?: Float32Array;
  scale2?: Float32Array;
}

interface PathStyle {
  fillColor: Uint8ClampedArray;
  strokeColor?: Uint8ClampedArray;
  strokeWidth?: number | Float32Array;
  fillRule?: 'nonzero' | 'evenodd';
  globalAlpha?: number | Float32Array;
}

interface RenderFrameIR_Future {
  version: 2;
  ops: readonly DrawOp[];
}
```

## Coordinate Space Invariants

From spec (3-local-space-spec-deeper.md):

1. **Local Space (L)**: Geometry/control points live here
   - Origin at (0,0), typical magnitude |L| ≈ O(1)
   - Example: Regular pentagon vertices at radius 1.0

2. **World Space (W)**: Instance transforms live here
   - Normalized coordinates xW, yW ∈ [0, 1]
   - Position, size are in world space

3. **Viewport Space (V)**: Backend-specific
   - Canvas: pixel coordinates
   - SVG: viewBox coordinates

**Key**: Control points from `polygonVertex` kernel are already local-space (centered at origin with configurable radius). No kernel changes needed.

## Dependencies

### This Bead Blocks

- **oscilla-animator-v2-46m**: Local-space renderer migration
- **oscilla-animator-v2-0uk**: SVG renderer with defs/use reuse

### This Bead Is Blocked By

- Nothing - this is foundational work

## Testing Strategy

1. **Unit tests** in `src/runtime/__tests__/RenderAssembler.test.ts`
   - Test `assembleDrawPathInstancesOp()` with mock inputs
   - Validate output structure matches types
   - Test edge cases (empty instances, missing optional fields)

2. **Integration tests**
   - V2 frame produces same visual output as v1 (when renderer supports it)
   - V1 path continues to work unchanged

## Risk Mitigation

| Risk | Mitigation |
|------|------------|
| Breaking existing renders | V1 path completely unchanged; v2 is additive |
| Type drift from future-types.ts | Import types directly; no duplication |
| Coordinate space confusion | Control points already local-space; verified |
