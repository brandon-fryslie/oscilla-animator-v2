# Sprint: RenderAssembler v2

**Bead**: oscilla-animator-v2-583
**Created**: 2026-01-22

## Sprint Goal

Add v2 render assembly functions that produce `DrawPathInstancesOp` structures, keeping v1 path intact.

## Tasks

### Task 1: Add Helper Functions to RenderAssembler.ts

**File**: `src/runtime/RenderAssembler.ts`

Add three helper functions:

```typescript
/**
 * Build PathGeometry from resolved shape
 */
function buildPathGeometry(
  resolvedShape: ResolvedShape,
  controlPoints: Float32Array
): PathGeometry

/**
 * Build InstanceTransforms from render step data
 */
function buildInstanceTransforms(
  count: number,
  position: Float32Array,
  size: number,
  rotation?: Float32Array,
  scale2?: Float32Array
): InstanceTransforms

/**
 * Build PathStyle from color buffer
 */
function buildPathStyle(
  color: Uint8ClampedArray,
  fillRule?: 'nonzero' | 'evenodd'
): PathStyle
```

**Estimated**: ~60 lines

---

### Task 2: Add assembleDrawPathInstancesOp() Function

**File**: `src/runtime/RenderAssembler.ts`

Main assembly function that:
1. Resolves shape via existing `resolveShapeFully()`
2. Calls helper functions to build structures
3. Returns `DrawPathInstancesOp`

```typescript
export function assembleDrawPathInstancesOp(
  step: StepRender,
  context: AssemblerContext
): DrawPathInstancesOp | null
```

**Estimated**: ~50 lines

---

### Task 3: Add assembleRenderFrame_v2() Function

**File**: `src/runtime/RenderAssembler.ts`

Top-level function that assembles all render steps into v2 format:

```typescript
export function assembleRenderFrame_v2(
  renderSteps: readonly StepRender[],
  context: AssemblerContext
): RenderFrameIR_Future
```

**Estimated**: ~20 lines

---

### Task 4: Export New Types and Functions

**File**: `src/runtime/index.ts`

Add exports for new functions and re-export future types.

**Estimated**: ~5 lines

---

### Task 5: Write Unit Tests

**File**: `src/runtime/__tests__/RenderAssembler.test.ts` (create or extend)

Test cases:
1. `buildPathGeometry()` produces correct structure
2. `buildInstanceTransforms()` handles uniform vs per-instance size
3. `buildPathStyle()` extracts color correctly
4. `assembleDrawPathInstancesOp()` returns valid op
5. `assembleRenderFrame_v2()` returns correct frame structure
6. Edge case: empty instance count returns null
7. Edge case: primitive topology (non-path) handling

**Estimated**: ~100 lines

---

## Execution Order

1. Task 1: Helper functions (foundation)
2. Task 2: Main assembly function (uses helpers)
3. Task 3: Frame assembly (uses main function)
4. Task 4: Exports
5. Task 5: Tests (validates all)

## Verification

After each task:
- `npm run typecheck` must pass
- `npm run test` must pass (after Task 5)

Final verification:
- `npm run build` must pass
- Existing animation still renders (v1 path)

## Notes

- Import types from `../render/future-types.ts` directly
- Use `isPathTopology()` guard already in RenderAssembler
- For primitive topologies, v2 assembly may return null (only paths for now)
- Rotation and scale2 are optional - wire through when StepRender supports them
