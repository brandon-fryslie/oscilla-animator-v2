Agent: iterative-implementer | 2026-01-22-211845
Mode: manual (no existing tests for per-instance shapes feature)
Completed: Per-instance shapes support (Field<shape>) in RenderAssembler v2
Files Modified: 3 | Commits: 1 | Tests Added: 8
Cache invalidated: N/A (no eval-cache entries for RenderAssembler)
Status: complete

## Summary

Implemented full per-instance shape support in RenderAssembler, enabling instances
with different topologies to be rendered efficiently in batched draw operations.

## Implementation Details

### Core Functionality (RenderAssembler.ts)
1. **groupInstancesByTopology()** - O(N) single-pass grouping algorithm
   - Groups by (topologyId, controlPointsSlot) key
   - Tracks instance indices for buffer slicing
   - Pass-level buffer validation (not per-instance)

2. **sliceInstanceBuffers()** - Extract per-group instance data
   - Copies position (Float32Array, vec2) and color (Uint8ClampedArray, RGBA)
   - Preserves instance order within groups
   - Creates new buffers (optimization deferred)

3. **assemblePerInstanceShapes()** - Handle Shape2D buffer case
   - Validates topology existence at group level
   - Resolves control points per group
   - Builds DrawPathInstancesOp for each group
   - Skips non-path topologies with warning

4. **Return type changes**
   - assembleDrawPathInstancesOp(): DrawPathInstancesOp[] (was single op)
   - assembleRenderFrame_v2(): Flattens ops from all steps

### Testing (RenderAssembler-per-instance-shapes.test.ts)
Created comprehensive test suite with 8 tests covering:
- Shape buffer validation (length mismatch detection)
- Topology grouping scenarios (uniform, mixed, interleaved)
- Buffer slicing correctness (position/color extraction)
- Error handling (missing topology, missing control points)
- Integration with assembleRenderFrame_v2 (multi-step flattening)

Updated existing tests (RenderAssembler.test.ts):
- Changed expectations from null/single op to empty array/array of ops
- All 22 existing tests passing with new return types

## Validation

Manual mode validation:
- All 276 runtime tests passing (including 30 new tests)
- Typecheck passing with no errors
- Existing RenderAssembler tests updated and passing
- New per-instance shapes tests all passing

Testing scenarios validated:
1. Single topology, all instances → 1 op
2. Multiple topologies, grouped → N ops (one per topology)
3. Interleaved topologies → correct grouping and slicing
4. Buffer slicing → correct position/color values per group
5. Error cases → clear error messages with instance indices
6. Multi-step frames → ops correctly flattened

## Deferred Work (Documented in DOD)

Per DOD, the following are explicitly out of scope:
- Per-instance size/rotation/scale2 (only uniform supported)
- Buffer view optimization (currently copies, can use views later)
- Topology group caching across frames
- Performance benchmarking dashboard
- Grouping optimizations (spatial/style sorting)

## Files Modified

1. src/runtime/RenderAssembler.ts (+374 lines)
   - Added groupInstancesByTopology(), sliceInstanceBuffers()
   - Added assemblePerInstanceShapes()
   - Updated assembleDrawPathInstancesOp() return type
   - Updated assembleRenderFrame_v2() to flatten ops

2. src/runtime/__tests__/RenderAssembler.test.ts (+21 lines, modified)
   - Updated 4 test expectations for new return type
   - Changed from null/single op to []/array

3. src/runtime/__tests__/RenderAssembler-per-instance-shapes.test.ts (+560 lines, new)
   - 8 comprehensive tests for per-instance shapes
   - Covers grouping, slicing, validation, integration

## Commit

5083529 feat(runtime): Add per-instance shape support in RenderAssembler

Ready for evaluation and integration testing.
