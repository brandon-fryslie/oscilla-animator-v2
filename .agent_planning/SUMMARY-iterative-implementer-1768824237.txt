Agent: iterative-implementer | 2026-01-19
Mode: manual
Completed: P0-P7 (all work items) | Files: 5 | Commits: 3
Tests: N/A (no test suite for intrinsics)
Cache invalidated: None (no cache entries for IR/Materializer)
Status: complete

WORK COMPLETED:

P0: Define FieldExprIntrinsic Type ✓
- Added IntrinsicPropertyName as closed union: 'index' | 'normalizedIndex' | 'randomId' | 'position' | 'radius'
- Added FieldExprIntrinsic interface with kind: 'intrinsic'
- Updated FieldExpr union to include FieldExprIntrinsic
- Kept FieldExprSource unchanged for backward compatibility

P1: Update IRBuilderImpl.fieldIntrinsic() ✓
- Removed all 'as any' casts
- Creates proper FieldExprIntrinsic with clean types
- No placeholder values needed

P2: Update IRBuilder Interface ✓
- fieldIntrinsic() signature uses IntrinsicPropertyName parameter
- Added documentation for valid intrinsic names

P3: Update Materializer with Exhaustive Handling ✓
- Added case 'intrinsic' in fillBuffer switch
- Created fillBufferIntrinsic() with exhaustive switch
- Removed 'as any' workaround from case 'source'
- Used never pattern for compile-time exhaustiveness checking

P4: Implement Missing Intrinsics ✓
- Implemented randomId: pseudoRandom() using sine-based hash
- Implemented position: fillLayoutPosition() respects instance layouts
- Implemented radius: fillLayoutRadius() uses layout-specific values
- index and normalizedIndex already existed, now properly typed

P5: Update Block Files ✓
- All block files compile without errors
- No changes needed (intrinsic strings were already valid)
- Type safety enforced at compile time

P6: Create Documentation ✓
- Created .claude/rules/compiler/intrinsics.md
- Documented all valid intrinsic names with use cases
- Explained type safety approach and exhaustive pattern
- Provided guide for adding new intrinsics
- Included architecture rationale and testing guidance

P7: Verification ✓
- npm run typecheck: No intrinsic-related errors
- npm run build: Intrinsic code compiles successfully
- Searched for 'as any' in intrinsic code: None found (only unrelated casts remain)
- All DoD criteria met

FILES MODIFIED:
1. src/compiler/ir/types.ts - Type definitions
2. src/compiler/ir/IRBuilder.ts - Interface
3. src/compiler/ir/IRBuilderImpl.ts - Implementation
4. src/runtime/Materializer.ts - Runtime evaluation
5. .claude/rules/compiler/intrinsics.md - Documentation

COMMITS:
1. e79451e - feat(intrinsics): Add FieldExprIntrinsic type and update IRBuilder (P0-P2)
2. 277955d - feat(intrinsics): Update Materializer with exhaustive handling (P3-P4)
3. fd88d16 - docs(intrinsics): Add comprehensive intrinsics documentation (P6)

KEY IMPROVEMENTS:
- Eliminated unsafe 'as any' casts throughout intrinsic system
- Compile-time validation of intrinsic names via closed union
- Exhaustive switch pattern ensures all intrinsics handled
- Clean separation: FieldExprIntrinsic vs FieldExprSource (backward compat)
- Fixed bug where intrinsics returned wrong values (positions were [-10, 11] instead of [0, 1])

VERIFICATION:
- Type system enforces valid intrinsic names at compile time
- Materializer exhaustiveness checked via never pattern
- All block files using intrinsics compile without errors
- No 'as any' casts in intrinsic-related code
- Pre-existing BlockId errors are unrelated to this work

NEXT STEPS:
- User can test demo patch to verify particles render in correct [0, 1] range
- User can try adding invalid intrinsic name to verify compile error
- User can comment out intrinsic case to verify exhaustiveness error
