# Sprint Plan: React Root Consolidation

**Generated**: 2026-01-10 20:30
**Topic**: ui-react-consolidation

## Sprint Goal

**Replace the entire vanilla DOM page structure with a single React application.**

Success = `main.ts` calls `createRoot()` exactly once, renders `<App />`, and everything inside is React.

---

## Current State

- **5 separate React roots** created in contentFactory callbacks
- **TabbedContent.ts** is vanilla DOM managing React lifecycle
- **main.ts** builds the entire page layout with vanilla DOM
- **Canvas, toolbar, logs** all vanilla DOM

## Target State

- **1 React root** in main.ts: `createRoot(container).render(<App />)`
- **Everything is React** except canvas rendering context (keep 2D API)
- **No TabbedContent.ts** - replaced by React `<Tabs>` component
- **No vanilla DOM layout** - all JSX

---

## Scope

### In Scope (This Sprint)

**Two Critical Deliverables:**

1. **React Application Root** - Everything in React with single root
2. **Split Sidebar with jsPanel** - Library + Inspector visible simultaneously

Convert the entire page to React with these parts:

1. **App.tsx** - Root component that renders everything
   - Toolbar (title + stats)
   - Workspace (3-column layout: left sidebar, center, right sidebar)
   - Bottom log panel
   - **jsPanel integration baked in deeply**

2. **SplitPanel.tsx** - jsPanel-based split view component
   - Uses custom jsPanel4 fork from `~/code/brandon-fryslie_jsPanel4`
   - Left sidebar split horizontally: Library (top) + Inspector (bottom)
   - Resizable split with drag handle
   - Both panels always visible

3. **Tabs.tsx** - React tab component for center/right regions
   - Tab bar with active state
   - Content area that switches components
   - No unmount/remount on tab switch (keep mounted, hide/show)

4. **Canvas integration** - Canvas component with ref
   - Canvas element managed by React
   - 2D context passed to animation loop (stays vanilla)
   - No breaking the render loop

5. **All existing React components** stay as-is:
   - BlockLibrary.tsx
   - BlockInspector.tsx
   - TableView.tsx
   - ConnectionMatrix.tsx
   - DomainsPanel.tsx

6. **New React components for vanilla parts**:
   - Toolbar.tsx (title + stats)
   - LogPanel.tsx (bottom logs)
   - HelpPanel.tsx (help content)
   - CanvasTab.tsx (wrapper for canvas)

### Out of Scope (Future)

- Keyboard shortcuts
- Additional layout improvements beyond split sidebars
- Feature work beyond basic usability

---

## Work Items

### P0: Single React Root

**Goal**: `main.ts` renders one React app, everything else is components.

**Implementation**:

1. **Create App.tsx** (~200 lines)
   - Root layout with toolbar, workspace, bottom panel
   - CSS flexbox layout (copy from index.html)
   - Render all regions

2. **Create Tabs.tsx** (~150 lines)
   - Generic tabbed panel component
   - Props: `tabs: Array<{ id, label, icon?, component }>`
   - State: `activeTab` (useState)
   - Render: tab bar + content area
   - **Critical**: Keep all tab content mounted (display: none for hidden)

3. **Create new React components**:
   - **Toolbar.tsx** (~50 lines) - Title, stats display
   - **LogPanel.tsx** (~100 lines) - Log messages with auto-scroll
   - **HelpPanel.tsx** (~50 lines) - Help content as JSX
   - **CanvasTab.tsx** (~100 lines) - Canvas with useRef, pass to animation loop

4. **Update main.ts** (~100 line changes)
   - Delete all vanilla DOM creation (lines 46-529)
   - Keep only: stores, demo patch, animation loop
   - Add: `createRoot(document.getElementById('app-container')).render(<App />)`
   - Pass canvas ref to animation loop

5. **Delete TabbedContent.ts** (364 lines removed)

**Acceptance Criteria**:
- [ ] main.ts has exactly 1 `createRoot()` call
- [ ] App.tsx renders entire page layout with jsPanel integration
- [ ] SplitPanel.tsx uses custom jsPanel4 from `~/code/brandon-fryslie_jsPanel4`
- [ ] Left sidebar shows Library (top) + Inspector (bottom) simultaneously
- [ ] Split is resizable with drag handle
- [ ] Tabs.tsx handles center/right region tab switching
- [ ] All 5 existing React components render correctly
- [ ] Canvas renders and animation loop runs
- [ ] Logs display at bottom
- [ ] No console errors on load
- [ ] Tab switching works without unmounting components
- [ ] Selecting block in Library shows preview in Inspector (both visible)

---

## Technical Notes

### Canvas Handling

**Problem**: Canvas 2D context must persist across renders

**Solution**:
```typescript
// CanvasTab.tsx
function CanvasTab() {
  const canvasRef = useRef<HTMLCanvasElement>(null);

  useEffect(() => {
    if (canvasRef.current) {
      const ctx = canvasRef.current.getContext('2d');
      // Pass ctx to animation loop somehow
    }
  }, []);

  return <canvas ref={canvasRef} width={800} height={600} />;
}
```

### Tab Mounting Strategy

**Problem**: Unmounting tabs loses state

**Solution**: Keep all tabs mounted, use CSS to hide:
```typescript
// Tabs.tsx
{tabs.map(tab => (
  <div
    key={tab.id}
    style={{ display: activeTab === tab.id ? 'block' : 'none' }}
  >
    <tab.component />
  </div>
))}
```

### Layout CSS

**Keep existing CSS** from `public/index.html` - copy flex layout exactly

### Store Access

**All components already use rootStore** - no changes needed

---

## Dependencies

- Evaluation complete ✓
- All React components already converted ✓
- MobX stores working ✓

**Blockers**: None

---

## Risks

| Risk | Severity | Mitigation |
|------|----------|------------|
| Canvas context lost on render | HIGH | Use useRef + useEffect, don't recreate |
| Animation loop breaks | HIGH | Pass canvas ref, not element |
| Tab state lost on switch | MEDIUM | Keep mounted, hide with CSS |
| Layout breaks | LOW | Copy exact CSS from index.html |

---

## Estimated Effort

| Task | Estimate |
|------|----------|
| App.tsx + layout | 2 hours |
| Tabs.tsx | 1.5 hours |
| Toolbar/Log/Help components | 1.5 hours |
| Canvas integration | 2 hours |
| main.ts cleanup | 1 hour |
| Testing/fixes | 1 hour |
| **Total** | **9 hours** |

---

## Success Metric

Run this and it returns **1**:
```bash
grep -c "createRoot" src/main.ts
```

And the app loads without errors.
