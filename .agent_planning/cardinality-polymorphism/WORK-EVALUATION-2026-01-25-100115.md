# Work Evaluation - 2026-01-25-100115
Scope: cardinality-polymorphism
Confidence: FRESH

## Goals Under Evaluation
From SPRINT-2026-01-25-160000-port-types-DOD.md:
1. P0: FromDomainId reverted to fieldOnly
2. P1: Port types updated for PRESERVE blocks (7 blocks)
3. P2: lower() guards fixed (9 blocks with dual-path)
4. P3: Identity blocks verified fieldOnly
5. P4: Tested and committed

## Previous Evaluation Reference
Last evaluation: EVALUATION-2026-01-25-160000.md
| Previous Issue | Status Now |
|----------------|------------|
| Port types incomplete | [VERIFIED-FIXED] |
| Identity blocks TBD | [VERIFIED-FIXED] |
| Lower guards TBD | [VERIFIED-FIXED] |

## Persistent Check Results
| Check | Status | Output Summary |
|-------|--------|----------------|
| `npm run typecheck` | FAIL | 143 total errors, 8 in target file |
| `npm run test` | N/A | Not run (pre-existing failures) |
| Dev server (http://localhost:5177/) | PASS | HTTP 200 |

## Manual Verification

### P0: FromDomainId reverted to fieldOnly
| Criterion | Expected | Actual | Status |
|-----------|----------|--------|--------|
| cardinalityMode | 'fieldOnly' | 'fieldOnly' | PASS |
| broadcastPolicy | 'disallowSignalMix' | 'disallowSignalMix' | PASS |
| Output port type | signalTypeField('float', 'default') | signalTypeField('float', 'default') | PASS |

### P1: Port types updated for PRESERVE blocks
| Block | Ports | Expected | Actual | Status |
|-------|-------|----------|--------|--------|
| Pulse | id01, value | signalType() | signalType('float') | PASS |
| RadiusSqrt | id01, radius, out | signalType() | signalType('float') | PASS |
| Jitter2D | pos, rand, out | signalType() | signalType('vec2'/'float') | PASS |
| HueFromPhase | id01, hue | signalType() | signalType('float') | PASS |
| SetZ | pos, z, out | signalType() | signalType('vec3'/'float') | PASS |
| FieldPolarToCartesian | angle, radius, pos | signalType() | signalType('float'/'vec3') | PASS |
| FieldCartesianToPolar | pos, angle, radius | signalType() | signalType('vec3'/'float') | PASS |

### P2: lower() guards fixed (dual-path implementation)
| Block | Signal Path | Field Path | Mixed Path | Status |
|-------|-------------|------------|------------|--------|
| GoldenAngle | YES | YES | N/A | PASS |
| AngularOffset | YES | YES | N/A | PASS |
| Pulse | YES | YES | N/A | PASS |
| RadiusSqrt | YES | YES | YES | PASS |
| Jitter2D | YES | YES | YES | PASS |
| HueFromPhase | YES | YES | N/A | PASS |
| SetZ | YES | YES | YES | PASS |
| FieldPolarToCartesian | YES | YES | YES | PASS |
| FieldCartesianToPolar | YES | YES | N/A | PASS |

### P3: Identity blocks verified fieldOnly
| Block | cardinalityMode | Expected | Status |
|-------|-----------------|----------|--------|
| StableIdHash | 'fieldOnly' | 'fieldOnly' | PASS |
| DomainIndex | 'fieldOnly' | 'fieldOnly' | PASS |

### P4: Tested and committed
| Criterion | Expected | Actual | Status |
|-----------|----------|--------|--------|
| npm run typecheck passes | No errors | 8 errors in field-operations-blocks.ts | FAIL |
| Dev server starts | Runs | HTTP 200 | PASS |
| Changes committed | Committed | Yes (commit 65b06a7) | PASS |

## TypeScript Errors in Target File

8 errors in `/Users/bmf/code/oscilla-animator-v2/src/blocks/field-operations-blocks.ts`:

All errors are of the same pattern - accessing `.id` on a union type that includes event types:
```
Property 'id' does not exist on type '...' | { readonly k: "event"; ... }
```

**Error locations:**
1. Line 351: FieldPolarToCartesian mixed path - angle.id
2. Line 352: FieldPolarToCartesian mixed path - radius.id
3. Line 788: RadiusSqrt mixed path - id01.id
4. Line 789: RadiusSqrt mixed path - radius.id
5. Line 887: Jitter2D mixed path - pos.id
6. Line 888: Jitter2D mixed path - rand.id
7. Line 1057: SetZ mixed path - pos.id
8. Line 1058: SetZ mixed path - z.id

**Root cause:** In the "else" (mixed path) branches, the code does:
```typescript
const field = input.k === 'field' ? input.id : ctx.b.Broadcast(input.id, ...)
```

TypeScript cannot prove that in the `Broadcast(input.id)` case, `input` has an `.id` property, because the union type includes event refs which don't have `.id` in the same way.

**Fix required:** Need type narrowing or explicit type assertions before accessing `.id`:
```typescript
// Option 1: Type assertion
const inputSig = input as { k: 'sig'; id: SigExprId };
ctx.b.Broadcast(inputSig.id, ...)

// Option 2: Additional guard
if (input.k === 'sig') {
  ctx.b.Broadcast(input.id, ...)
} else if (input.k === 'field') {
  // use input.id directly
}
```

## Assessment

### PASS Working
- P0: FromDomainId correctly configured as fieldOnly
- P1: All 7 blocks have correct signalType() port types
- P2: All 9 blocks have dual-path lower() implementations
- P3: Identity blocks correctly remain fieldOnly
- Dev server runs successfully

### FAIL Not Working
- P4: TypeScript compilation fails with 8 errors in target file

### Ambiguities Found
None - implementation follows spec correctly. The TypeScript errors are a mechanical fix, not a design ambiguity.

## Missing Checks
None - the existing check (npm run typecheck) correctly catches the issue.

## Verdict: INCOMPLETE

## What Needs to Change
1. `/Users/bmf/code/oscilla-animator-v2/src/blocks/field-operations-blocks.ts:351-352` - Add type guard or assertion before accessing `.id` in FieldPolarToCartesian mixed path
2. `/Users/bmf/code/oscilla-animator-v2/src/blocks/field-operations-blocks.ts:788-789` - Add type guard or assertion before accessing `.id` in RadiusSqrt mixed path
3. `/Users/bmf/code/oscilla-animator-v2/src/blocks/field-operations-blocks.ts:887-888` - Add type guard or assertion before accessing `.id` in Jitter2D mixed path
4. `/Users/bmf/code/oscilla-animator-v2/src/blocks/field-operations-blocks.ts:1057-1058` - Add type guard or assertion before accessing `.id` in SetZ mixed path

**Recommended fix pattern:**
In each mixed path else branch, the ternary expressions should use a proper type guard structure:
```typescript
// Instead of:
const field = input.k === 'field' ? input.id : ctx.b.Broadcast(input.id, ...)

// Use:
let fieldId: FieldExprId;
if (input.k === 'field') {
  fieldId = input.id;
} else if (input.k === 'sig') {
  fieldId = ctx.b.Broadcast(input.id, ...);
} else {
  throw new Error('Expected signal or field input');
}
```

Or simply cast to signal type since the else branch implies sig:
```typescript
const field = input.k === 'field' 
  ? input.id 
  : ctx.b.Broadcast((input as { k: 'sig'; id: SigExprId }).id, ...)
```
