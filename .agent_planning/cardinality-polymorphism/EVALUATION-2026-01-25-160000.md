# Evaluation: Cardinality Polymorphism for Field Operation Blocks

**Generated:** 2026-01-25T16:00:00
**Topic:** cardinality-polymorphism
**Verdict:** CONTINUE

## Context

This work addresses a type system issue where blocks that should work with both signals (single values) and fields (arrays of values) were incorrectly restricted to fields only. The user insight driving this work:

> "A signal is just 1 item. A field is just a bunch of signals. There isn't anything different about operating as a signal or a field."

## Completed Work (Committed)

### Pass 2 Type Graph Fix (commit 436f5a8)

Modified `src/compiler/passes-v2/pass2-types.ts`:
- `isTypeCompatible()` now accepts cardinality mismatches for polymorphic blocks
- Blocks with `cardinalityMode: 'preserve'` and `broadcastPolicy: 'allowZipSig'` allow Signal→Field connections

## In-Progress Work (Uncommitted)

### field-operations-blocks.ts Changes

**Metadata updates** (cardinalityMode: 'fieldOnly' → 'preserve'):
- ✅ FromDomainId
- ✅ GoldenAngle
- ✅ AngularOffset
- ✅ FieldPolarToCartesian
- ✅ FieldCartesianToPolar
- ✅ Pulse
- ✅ RadiusSqrt
- ✅ Jitter2D
- ✅ HueFromPhase
- ✅ SetZ

**Port type updates** (signalTypeField → canonicalType):
- ✅ FromDomainId (output: id01)
- ✅ GoldenAngle (input: id01, output: angle)
- ✅ AngularOffset (input: id01, output: offset)
- ❌ FieldPolarToCartesian (inputs: angle, radius; output: pos) — still uses signalTypeField
- ❌ FieldCartesianToPolar (input: pos; outputs: angle, radius) — still uses signalTypeField
- ❌ Pulse (input: id01; output: value) — still uses signalTypeField
- ❌ RadiusSqrt (inputs: id01, radius; output: out) — still uses signalTypeField
- ❌ Jitter2D (inputs: pos, rand; output: out) — still uses signalTypeField
- ❌ HueFromPhase (input: id01; output: hue) — still uses signalTypeField
- ❌ SetZ (inputs: pos, z; output: out) — still uses signalTypeField

## Remaining Work

### 1. Complete port type updates in field-operations-blocks.ts

7 blocks still need port types changed from `signalTypeField('X', 'domain')` to `canonicalType('X')`.

### 2. Update identity-blocks.ts

- **StableIdHash**: Change to `cardinalityMode: 'preserve'`, update output port types
- **DomainIndex**: Change to `cardinalityMode: 'preserve'`, update output port types

### 3. Consider path-operators-blocks.ts and render-blocks.ts

- **PathField**: Currently fieldOnly — may need to stay that way (path-specific)
- **LayoutAlongPath**: Currently transform mode — likely fine as-is
- **RenderInstances2D**: Currently fieldOnly — may need to stay that way (render sink)

### 4. Verify lower() functions

The `lower()` functions have guards like:
```typescript
if (!id01 || id01.k !== 'field') {
  throw new Error('GoldenAngle id01 must be a field');
}
```

Per user guidance, signals are single-element fields at runtime, so these guards may cause runtime failures when a signal is passed. Need to verify or update.

### 5. Test and commit

- Run typecheck
- Test with actual patches that mix signal→field connections
- Commit all changes

## Risks

1. **Lower function guards**: The guards that require `k === 'field'` will fail if signals are passed. May need to either:
   - Update guards to accept both
   - Trust that the runtime handles signals as single-element fields

2. **Instance context propagation**: Some blocks rely on `ctx.inferredInstance` which comes from field inputs. If all inputs are signals, instance context may be undefined.

## Confidence Assessment

| Work Item | Confidence |
|-----------|------------|
| Complete port type updates | HIGH |
| Update identity-blocks.ts | HIGH |
| Verify lower() functions | MEDIUM |
| Test and commit | HIGH |

**Overall:** Sprint ready for implementation with some investigation needed for lower() function handling.
