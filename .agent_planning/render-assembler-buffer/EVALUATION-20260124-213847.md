# Evaluation: RenderAssembler Buffer Type Issue
Timestamp: 2026-01-24-213847
Git Commit: 436cd12

## Executive Summary
Overall: 85% complete | Critical issues: 2 (test/contract mismatch) | Tests reliable: NO

The user's report of "fillColor returned as Float32Array but tests expect Uint8ClampedArray" is **incorrect**. The actual failures are:

1. **Position buffer stride mismatch**: Tests expect stride-3 vec3 world-space, implementation returns stride-2 vec2 screen-space
2. **Reference equality expectation**: Tests use `.toBe()` expecting same buffer object, implementation creates new buffers

The fillColor type is correctly Uint8ClampedArray in both types and implementation. The user's description appears to be a misdiagnosis of the actual error.

## Runtime Check Results

| Check | Status | Output |
|-------|--------|--------|
| npm test RenderAssembler.test.ts | FAIL | 1/12 tests fail (position reference equality) |
| npm test RenderAssembler-per-instance-shapes.test.ts | FAIL | 1/8 tests fail (position stride-3 vs stride-2) |
| npm test level1-vec3-data.test.ts | FAIL | 1/14 tests fail (position stride-3 expectation) |
| npm run typecheck | PASS | No type errors |

## Missing Checks
- No runtime assertion that position buffer stride matches renderer expectations
- No type-level distinction between world-space vec3 and screen-space vec2 positions

## Findings

### Position Buffer Contract (Critical)
**Status**: PARTIAL - Implementation correct but tests outdated
**Evidence**:
- `src/runtime/RenderAssembler.ts:243` allocates `count * 2` for screenPosition
- `src/projection/ortho-kernel.ts:135-136` writes stride-2 positions
- `src/render/types.ts:127-142` InstanceTransforms comments document both world-space and screen-space modes
**Issues**:
- Tests at `RenderAssembler.test.ts:231` expect `.toBe(positionBuffer)` - reference equality
- Tests at `RenderAssembler-per-instance-shapes.test.ts:433-436` expect stride-3 vec3
- Tests at `level1-vec3-data.test.ts:233` expect `N * 3` length

The InstanceTransforms type comments explicitly document:
```typescript
/** Positions in normalized [0,1] space (x,y interleaved)
 * WHEN PROJECTED: screen-space positions (stride-2, normalized [0,1]) */
```

**Verdict**: Implementation is correct. Tests are outdated and expect pre-projection behavior.

### Color Buffer Type
**Status**: COMPLETE - No issue here
**Evidence**:
- `src/render/types.ts:49`: `fillColor?: Uint8ClampedArray`
- `src/runtime/RenderAssembler.ts:1107-1111`: Validates `colorBuffer instanceof Uint8ClampedArray`
- `src/runtime/RenderAssembler.ts:815`: Returns `compacted.color as Uint8ClampedArray`
**Issues**: None - color type is correctly Uint8ClampedArray throughout

### depthSortAndCompact Contract
**Status**: COMPLETE
**Evidence**:
- Function at line 113 explicitly returns `screenPosition: Float32Array` (stride-2)
- `ProjectionOutput` at line 88 has `screenPosition: Float32Array` (stride-2)
**Issues**: None - the contract is clear, tests don't match it

## Ambiguities Found

| Area | Question | How LLM Guessed | Impact |
|------|----------|-----------------|--------|
| Position stride after projection | Should renderer receive world-space vec3 or screen-space vec2? | Implemented screen-space vec2 (stride-2) | Tests expect stride-3, need update |
| Buffer ownership | Should output buffer be the same object as input buffer? | Created new buffers (projection writes to new arrays) | Test uses `.toBe()` for reference equality |
| Test contract | Were tests written before projection was added? | Appears yes - tests expect pre-projection behavior | Tests are stale |

## Root Cause Analysis

### Why Tests Fail

1. **Projection was added after tests were written**: The tests expect the assembler to pass through world-space position buffers unchanged. The projection feature was added later, which:
   - Transforms world-space vec3 (stride-3) to screen-space vec2 (stride-2)
   - Creates new output buffers (breaking reference equality)

2. **Test at RenderAssembler.test.ts:231**:
   ```typescript
   expect(op.instances.position).toBe(positionBuffer);
   ```
   Uses `.toBe()` which checks Object.is() reference equality. After projection, position is a new buffer.

3. **Test at RenderAssembler-per-instance-shapes.test.ts:433**:
   ```typescript
   expect(circleOp.instances.position).toEqual(new Float32Array([
     0.1, 0.1, 0, // instance 0 (vec3)
     0.4, 0.4, 0, // instance 3 (vec3)
   ]));
   ```
   Expects stride-3 positions with z values. Projection discards z, outputs stride-2.

4. **Test at level1-vec3-data.test.ts:233**:
   ```typescript
   expect(position.length).toBe(N * 3); // 16 instances * 3 floats per position
   ```
   Expects vec3 stride-3 output. Gets vec2 stride-2 output.

### Correct Resolution

**Tests need updating to match the new contract**. The implementation is correct:
- Projection IS happening (documented in InstanceTransforms type)
- Screen-space vec2 IS the correct output format for rendering
- New buffers ARE correct (projection output must be separate from world-space input)

## Recommendations

1. **Update RenderAssembler.test.ts line 231**: Change `.toBe(positionBuffer)` to verify position VALUES match projected output, not reference equality
2. **Update RenderAssembler-per-instance-shapes.test.ts lines 433-451**: Expect stride-2 screen-space positions, not stride-3 world-space
3. **Update level1-vec3-data.test.ts line 233**: Either:
   - Test the WORLD-SPACE buffer before projection (test Materializer output directly)
   - Or expect stride-2 screen-space output from executeFrame()
4. **Add test clarification**: Document in test comments which stage is being tested (pre-projection vs post-projection)

## Scope of Fix

| File | Changes Needed |
|------|----------------|
| `src/runtime/__tests__/RenderAssembler.test.ts` | Line 231: Remove reference equality check, verify projected values |
| `src/runtime/__tests__/RenderAssembler-per-instance-shapes.test.ts` | Lines 433-451: Update expected values to stride-2 |
| `src/projection/__tests__/level1-vec3-data.test.ts` | Line 233: Either test pre-projection or expect stride-2 |

## Cascading Impacts

1. **None on implementation** - RenderAssembler is correct
2. **None on renderers** - They already expect screen-space stride-2
3. **Potential on other tests** - Any test verifying position buffer shape after executeFrame may need updates

## Steel-Thread Failures (Separate Issue)

The steel-thread tests fail with a different error:
```
NoConversionPath: Type mismatch: cannot connect one+continuous<shape, unit:none> to one+continuous<float, unit:none>
```

This is a **type system/compiler issue**, not related to RenderAssembler buffers. These failures are in the compilation pass, not the runtime assembly.

## Verdict

- [x] CONTINUE - Issues clear, implementer can fix

The test failures are straightforward to fix:
1. Tests expect outdated contract (pre-projection)
2. Implementation is correct per documented type comments
3. Update tests to match the new projection-based output format

**No architectural issues. No ambiguities requiring clarification.**

---

```
project-evaluator complete
  Scope: RenderAssembler buffer types | Completion: 85% | Gaps: 3 (stale tests)
  Workflow: CONTINUE
  -> Update 3 test files to expect stride-2 screen-space positions instead of stride-3 world-space
```
