# Definition of Done: Update Blocks to Use Type Helpers

**Sprint:** Update existing blocks to use new type helpers
**Generated:** 2026-01-05

---

## Deliverable 1: Type Helper Functions

**Definition of Done:**

- [ ] File `src/core/types.ts` contains function:
  ```typescript
  export function eventType(domain: Domain = 'float'): TypeDesc {
    return createTypeDesc('event', domain, 'core', true);
  }
  ```

- [ ] File `src/core/types.ts` contains function:
  ```typescript
  export function scalarType(domain: Domain): TypeDesc {
    return createTypeDesc('scalar', domain, 'core', true);
  }
  ```

- [ ] Both functions are exported from `src/types/index.ts`

- [ ] Functions are placed immediately after existing `sigType()` and `fieldType()` helpers

- [ ] TypeScript compilation succeeds: `npx tsc --noEmit` returns 0 errors

---

## Deliverable 2: Updated Block Implementations

**Definition of Done:**

**FiniteTimeRoot.ts:**
- [ ] Line ~59: `{ world: 'event', domain: 'float' }` replaced with `eventType('float')`
- [ ] Import statement includes `eventType` from `src/types`

**InfiniteTimeRoot.ts:**
- [ ] Line ~46: `{ world: 'event', domain: 'float' }` replaced with `eventType('float')`
- [ ] Import statement includes `eventType` from `src/types`

**DomainN.ts:**
- [ ] Line ~34: `{ world: 'scalar', domain: 'float' }` replaced with `scalarType('float')`
- [ ] Import statement includes `scalarType` from `src/types`

**GridDomain.ts:**
- [ ] Line ~43: `{ world: 'scalar', domain: 'float' }` replaced with `scalarType('float')`
- [ ] Import statement includes `scalarType` from `src/types`

**FieldFromDomainId.ts:**
- [ ] Line ~24: `{ world: 'scalar', domain: 'float' }` replaced with `scalarType('float')`
- [ ] Import statement includes `scalarType` from `src/types`

**RenderInstances2D.ts:**
- [ ] Line ~64: `{ world: 'scalar', domain: 'float' }` replaced with `scalarType('float')`
- [ ] Import statement includes `scalarType` from `src/types`

**All 6 blocks:**
- [ ] Each block's `registerBlock()` call uses helper functions for all TypeDesc values
- [ ] No inline object literals with `{ world: '...', domain: '...' }` remain in output declarations
- [ ] Code style matches existing blocks (consistent indentation, spacing)

---

## Deliverable 3: Fix Unsafe Type Casting

**FieldAttract2D.ts:**
- [ ] Lines ~20-24: Remove unsafe `as { kind: 'field'; id: any; type: any }` casting

**Options (choose one):**

**Option A: Manual type checking (consistent with 18 other blocks)**
- [ ] Replace with:
  ```typescript
  const pos = inputsById.pos;
  if (!pos || pos.kind !== 'field') {
    throw new Error('FieldAttract2D requires field input at pos');
  }
  ```

**Option B: Extraction helper (if available)**
- [ ] Replace with:
  ```typescript
  const pos = field(inputsById, 'pos');
  ```

**Either way:**
- [ ] No `any` type assertions remain in the block
- [ ] Type narrowing is explicit and safe
- [ ] Block compiles without type errors

---

## Deliverable 4: Verification & Testing

**TypeScript Compilation:**
- [ ] Command `npx tsc --noEmit` completes successfully
- [ ] Output contains ZERO errors
- [ ] Output contains ZERO warnings related to blocks or types

**Block Functionality:**
- [ ] All 24 blocks in `src/compiler/blocks/` compile without errors
- [ ] Existing demo in `src/main.ts` still compiles and runs
- [ ] No functional behavior changes (blocks still register and lower correctly)

**Code Review:**
- [ ] All changes follow existing code style and patterns
- [ ] Import statements are organized and correct
- [ ] Function calls match the helper function signatures

---

## Acceptance Checklist

**Must pass all of these:**

- [ ] `eventType()` helper exists and exports correctly
- [ ] `scalarType()` helper exists and exports correctly
- [ ] All 6 blocks use helper functions instead of inline literals
- [ ] FieldAttract2D has no unsafe `any` type casting
- [ ] TypeScript compilation returns 0 errors
- [ ] No new errors introduced in any dependent code
- [ ] All changes are mechanical and safe (no logic changes)

---

## Sign-Off

When all criteria above are met:

```
âœ… Definition of Done SATISFIED
   Date: [completion date]
   Blocks updated: 6
   Type casting fixed: 1
   Type errors: 0
   Ready for: Next sprint or integration
```

---

## Rollback Criteria

If any of the following occur, STOP and rollback:

- [ ] TypeScript compilation fails with NEW errors (not pre-existing)
- [ ] A block's `lower()` function changes behavior
- [ ] Type safety is compromised (more `any` types, not fewer)
- [ ] More than 10 TypeScript errors remain after all updates

**Rollback process:**
1. Revert modified block files to main branch
2. Keep type helper functions (eventType, scalarType) - they're still needed
3. Report which blocks still have issues to next sprint
