# Handoff: Update Blocks to Use Type Helpers

**Created**: 2026-01-05
**Status**: PLAN SUPERSEDED - Codebase evolved

---

## ⚠️ Important Notice

**The plan we created is now outdated.** The codebase has undergone significant changes:

- `core/types.ts` was replaced with `core/canonical-types.ts`
- Type system evolved from simple `TypeDesc { world, domain }` to `SignalType` with:
  - `payload` (float, int, vec2, color, bool, etc.)
  - `extent` with `cardinality` (zero/one/many) and `temporality` (continuous/discrete)
  - `binding` and `axes` for advanced type information
- All IRBuilder methods now use `SignalType` instead of simple TypeDesc
- Block registry updated to use `SignalType` in InputDef/OutputDef
- Pass2 refactored to use canonical type system
- Transform registry updated for `SignalType`

---

## What Was Planned

Original plan was to update 24 blocks to use simple type helpers:
- Create `eventType()` and `scalarType()` helpers
- Update 6 blocks with inline TypeDesc literals
- Fix 1 block with unsafe casting
- Verify TypeScript compilation

**This approach is no longer valid** given the evolved type system.

---

## What Needs to Happen Now

### Option A: Abandon the Plan
The simple type helpers (`eventType()`, `scalarType()`) are no longer needed since blocks should use the canonical `SignalType` system.

### Option B: Understand the New System & Plan Accordingly
1. Understand how `SignalType` and canonical types work
2. Audit how blocks currently use types
3. Determine if any refactoring is still needed
4. Create a new plan aligned with canonical types

### Option C: Partial Implementation
Keep the simple helpers for backward compatibility, but:
- Update blocks to use `SignalType` where needed
- Keep helpers as convenience wrappers if appropriate

---

## Files Changed Since Planning

### Core Type System
- `src/core/canonical-types.ts` - New canonical type system (REPLACES old core/types.ts)
  - `SignalType` interface with payload, extent, cardinality, temporality
  - Helper functions: `signalType()`, `signalTypeSignal()`, `signalTypeField()`, etc.
  - Axis and binding utilities for type compatibility

### Compiler Infrastructure
- `src/compiler/ir/IRBuilder.ts` - Updated to use `SignalType`
- `src/compiler/ir/IRBuilderImpl.ts` - All methods now accept `SignalType`
- `src/compiler/ir/lowerTypes.ts` - Uses `SignalType` in LowerCtx, LowerResult
- `src/blocks/registry.ts` - InputDef/OutputDef now use `SignalType`

### Compiler Passes
- `src/compiler/passes-v2/pass2-types.ts` - Refactored to use SignalType
- `src/compiler/passes-v2/combine-utils.ts` - Updated for SignalType

### Type Exports
- `src/types/index.ts` - Consolidated to re-export from canonical-types.ts
- `src/transforms/index.ts` - Updated to use SignalType

### Graph
- `src/graph/Patch.ts` - Block now has displayName, domainId, role properties
- Block role system introduced: user, timeRoot, bus, domain, renderer, derived

---

## Current State Assessment

### What Works
✅ Core canonical type system is in place
✅ IRBuilder interface and impl use SignalType
✅ Block registry defines blocks with SignalType
✅ Pass2 validates type compatibility using canonical rules
✅ Transform system updated for SignalType

### What's Unclear
❓ Are existing blocks fully updated to use SignalType?
❓ What helpers/convenience functions exist for SignalType?
❓ Are there still inline type literals that should be refactored?
❓ Is TypeScript compiling cleanly?

---

## Recommended Next Steps

**Before proceeding, you need to decide:**

1. **Do you want to complete the original plan?**
   - If yes, it needs to be redesigned for the canonical type system
   - The simple helpers approach is no longer applicable

2. **Do you want to audit the current state?**
   - Check if all blocks properly use SignalType
   - Identify any type system inconsistencies
   - Verify TypeScript compilation

3. **Do you want to move forward with passes-v2 integration?**
   - The type system work is foundational
   - Passes-v2 depends on correct type usage
   - Current state might be sufficient to proceed

---

## Questions for User

- [ ] Should we abandon the "simple type helpers" plan given the canonical type system?
- [ ] Do you want to audit blocks to see if they're using SignalType correctly?
- [ ] Should we focus on getting passes-v2 working instead?
- [ ] Should we document how the new canonical type system works?

---

## Reference

### New Type System
- `src/core/canonical-types.ts` - Canonical SignalType definition
- `src/types/index.ts` - Re-exports and helpers
- Helper functions exported:
  - `signalType(payload, extent)`
  - `signalTypeSignal()`, `signalTypeField()`, `signalTypeTrigger()`, etc.

### Block System
- `src/blocks/registry.ts` - Block definitions with SignalType
- `src/graph/Patch.ts` - Block interface with role system

### Passes
- `src/compiler/passes-v2/pass2-types.ts` - Type compatibility checking
- `src/compiler/passes-v2/combine-utils.ts` - Multi-input combining

---

## What Happened

The codebase appears to have been updated with a more sophisticated type system based on:
- Payload types (what kind of value: float, color, vec2, etc.)
- Cardinality (how many: zero/one/many elements)
- Temporality (when: continuous/discrete)
- Binding and axes for advanced type relationships

This is more powerful than the simple `{world, domain}` system we were planning for.

---

## Decision Required

**Do you want to:**

A) **Investigate and adapt** - Understand the new system and create a revised plan
B) **Move forward anyway** - Implement simple helpers as a compatibility layer
C) **Pivot to passes-v2** - Focus on getting the compiler passes working instead
D) **Pause and reassess** - Take time to understand the full picture

Choose one and we can move forward accordingly.
