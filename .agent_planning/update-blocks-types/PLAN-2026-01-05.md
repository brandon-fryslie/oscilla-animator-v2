# Sprint Plan: Update Blocks to Use Type Helpers

**Generated:** 2026-01-05
**Topic:** Update existing blocks to use new type helpers
**Status:** Ready for Review

---

## Sprint Goal

Refactor 24 existing block implementations to consistently use centralized type helper functions (`sigType()`, `fieldType()`, `scalarType()`, `eventType()`) instead of inline TypeDesc literals, reducing duplication and improving maintainability.

---

## Scope

**In scope (this sprint):**
1. Create `eventType()` and `scalarType()` helper functions in `src/core/types.ts`
2. Update 6 blocks that use inline TypeDesc literals to use helper functions
3. Fix 1 block with unsafe type casting (`FieldAttract2D`)
4. Verify all 24 blocks compile successfully with unified type system

**Explicitly out of scope (future sprints):**
- Refactoring 18 blocks to use optional extraction helpers (sig(), field()) - pattern is correct but verbose
- Adding new blocks or modifying block signatures
- Runtime behavior changes

---

## Work Items

### P0: Create Missing Type Helper Functions

**Acceptance Criteria:**
- [ ] `eventType()` function exists in `src/core/types.ts`
- [ ] `scalarType()` function exists in `src/core/types.ts`
- [ ] Both functions return TypeDesc with correct world/domain/category/busEligible/lanes
- [ ] Functions are exported from `src/types/index.ts`
- [ ] TypeScript compilation succeeds with new functions

**Technical Notes:**
- Add functions after existing `sigType()` and `fieldType()` helpers
- Use same pattern: `createTypeDesc(world, domain, 'core', true)`
- Helper functions are convenience shortcuts for the 24 existing blocks

**Files to modify:**
- `src/core/types.ts` - Add eventType() and scalarType()
- `src/types/index.ts` - Export new helpers

---

### P1: Update 6 Blocks with Inline TypeDesc Literals

**Blocks to update:**
1. `src/compiler/blocks/time/FiniteTimeRoot.ts` - Line 59
2. `src/compiler/blocks/time/InfiniteTimeRoot.ts` - Line 46
3. `src/compiler/blocks/domain/DomainN.ts` - Line 34
4. `src/compiler/blocks/domain/GridDomain.ts` - Line 43
5. `src/compiler/blocks/render/FieldFromDomainId.ts` - Line 24
6. `src/compiler/blocks/render/RenderInstances2D.ts` - Line 64

**Acceptance Criteria:**
- [ ] All 6 blocks replaced inline `{ world: '...', domain: '...' }` with helper function calls
- [ ] All blocks compile without type errors
- [ ] No functional behavior changes (blocks still register and lower correctly)
- [ ] Inline literals remain ONLY where they appear in example code or comments

**Technical Notes:**
- Replace `{ world: 'event', domain: 'float' }` with `eventType('float')`
- Replace `{ world: 'scalar', domain: 'float' }` with `scalarType('float')`
- Update import statements to include new helpers from `src/types`

---

### P2: Fix Unsafe Type Casting in FieldAttract2D

**Acceptance Criteria:**
- [ ] `src/compiler/blocks/render/FieldAttract2D.ts` removes `as { kind: 'field'; id: any; type: any }` casting
- [ ] Safe type narrowing replaces unsafe casting (manual checks or extraction helpers)
- [ ] Block compiles without `any` type assertions
- [ ] Block behavior unchanged (lower function still works)

**Technical Notes:**
- Current code at lines 20-24 uses `as` with `any` types
- Can either:
  - Add manual type checks like other blocks do
  - Use extraction helper if available: `const pos = field(inputsById, 'pos')`
- Prefer consistency with the 18 blocks that do manual checks

**File to modify:**
- `src/compiler/blocks/render/FieldAttract2D.ts`

---

### P3: Verify TypeScript Compilation

**Acceptance Criteria:**
- [ ] Running `npx tsc --noEmit` completes with ZERO errors
- [ ] All 24 blocks compile successfully
- [ ] No new type errors introduced by helper functions
- [ ] Existing compiler functionality remains intact

**Technical Notes:**
- This is the final validation gate
- Should only take 30 seconds after P0, P1, P2 complete
- If errors remain, they're likely in dependent code, not the blocks themselves

---

## Dependencies

**Prerequisites:**
- `src/core/types.ts` with `createTypeDesc()` function - ✅ Already exists
- `src/types/index.ts` as centralized export point - ✅ Already consolidated
- All 24 blocks already compile (with existing workarounds) - ✅ True

**Blockers:**
- None identified

---

## Risks & Mitigation

| Risk | Probability | Mitigation |
|------|-------------|-----------|
| Typo in helper functions | Low | Simple functions, copy existing pattern from `sigType()` |
| Import path confusion | Medium | Update all imports to use `src/types` consistently |
| Type inference breaks in dependent code | Low | Helpers match existing pattern, no behavior change |
| Merge conflicts in blocks/ | Low | All changes are in different files, sequential updates |

---

## Effort Estimate

**Per block:** ~5 minutes
- P0 (helpers): 10 min
- P1 (6 blocks × 5 min): 30 min
- P2 (1 block fix): 10 min
- P3 (TypeScript verify): 2 min

**Total: ~52 minutes** (well within one sprint)

---

## Success Criteria

✅ All 24 blocks compile with zero type errors
✅ No inline TypeDesc literals in output registrations
✅ No unsafe `any` type casting in block implementations
✅ 100% of type creation uses centralized helpers
✅ No functional behavior changes to any block

---

## Notes

This is a **low-risk, high-value refactoring**:
- Reduces code duplication (6 blocks)
- Eliminates unsafe casting (1 block)
- Makes type system more maintainable
- Zero functional impact
- All changes are mechanical (find/replace patterns)
