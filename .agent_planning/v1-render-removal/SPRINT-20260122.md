# Sprint: V1 Render Removal

**Bead**: oscilla-animator-v2-ry2
**Created**: 2026-01-22
**Status**: BLOCKED (Dependencies incomplete)
**Confidence**: HIGH (when unblocked)

## Sprint Goal

Remove deprecated v1 RenderPassIR code path after v2 DrawPathInstancesOp is fully operational and proven.

## Prerequisites (BLOCKERS)

**MUST complete before starting:**
1. ✅ oscilla-animator-v2-583 (RenderAssembler v2) = CLOSED
2. ✅ oscilla-animator-v2-46m (Renderer local-space) = CLOSED
3. ✅ Visual regression test passes with v2
4. ✅ Performance benchmarks acceptable

**Current Status**: Dependencies in progress. This sprint is BLOCKED.

## Scope

### In Scope
- Delete v1 assembly functions from RenderAssembler.ts
- Delete v1 types from ScheduleExecutor.ts
- Update renderer to use only v2 dispatch
- Update type exports
- Update tests for v2 expectations

### Out of Scope
- New features (rotation, scale2, stroke)
- Performance optimization
- SVG renderer implementation
- Topology ID format migration

## Task Breakdown

### Task 1: Verify V2 Operational (PREREQUISITE)
**Priority**: P0
**Estimated**: 15 minutes
**Dependencies**: None (verification step)

**Acceptance Criteria:**
- [ ] RenderAssembler v2 bead marked closed
- [ ] Renderer local-space bead marked closed
- [ ] `npm test` passes
- [ ] Visual regression passed
- [ ] No console errors in dev mode

**Verification Commands:**
```bash
bd show oscilla-animator-v2-583 --json | jq '.status'
bd show oscilla-animator-v2-46m --json | jq '.status'
npm test
npm run dev # Manual visual check
```

---

### Task 2: Delete V1 Assembly Functions
**Priority**: P0
**Estimated**: 20 minutes
**Dependencies**: Task 1

**Files**: `src/runtime/RenderAssembler.ts`

**Acceptance Criteria:**
- [ ] `assembleRenderPass()` deleted (lines 52-104)
- [ ] `assembleAllPasses()` deleted (lines 279-293)
- [ ] `resolveScale()` deleted (lines 112-132)
- [ ] `resolveShape()` deleted (lines 143-176)
- [ ] `resolveControlPoints()` deleted (lines 180-194)
- [ ] `resolveShapeFully()` deleted (lines 224-270)
- [ ] `isShapeDescriptor()` deleted (lines 206-210)
- [ ] V2 functions retained (assembleDrawPathInstancesOp, etc.)
- [ ] File compiles without errors

**Technical Notes:**
- Keep helper functions: `buildPathGeometry`, `buildInstanceTransforms`, `buildPathStyle`
- Keep type guards: `isPathTopology`, `isRenderStep`
- Keep exports: `AssemblerContext`

**Verification:**
```bash
# Should return no results
rg "assembleRenderPass\(" --type ts src/
rg "assembleAllPasses\(" --type ts src/

# Should still find v2 functions
rg "assembleRenderFrame_v2" --type ts src/
```

---

### Task 3: Remove V1 Types from ScheduleExecutor
**Priority**: P0
**Estimated**: 25 minutes
**Dependencies**: Task 2

**Files**: `src/runtime/ScheduleExecutor.ts`

**Acceptance Criteria:**
- [ ] `RenderFrameIR` interface deleted (lines 34-37)
- [ ] `ShapeDescriptor` interface deleted (lines 42-46)
- [ ] `ResolvedShape` interface deleted (lines 58-80)
- [ ] `RenderPassIR` interface deleted (lines 96-124)
- [ ] Import of `assembleRenderPass` removed (line 21)
- [ ] Import of `assembleRenderFrame_v2` added
- [ ] Render step case updated to use v2
- [ ] File compiles without errors

**Technical Notes:**
- Update render step dispatch (lines 230-243):
  ```typescript
  case 'render': {
    const assemblerContext: AssemblerContext = {
      signals,
      instances: instances as ReadonlyMap<string, InstanceDecl>,
      state,
    };

    // Collect all render steps
    const renderSteps = steps.filter(s => s.kind === 'render') as StepRender[];

    // V2 assembly
    const frame = assembleRenderFrame_v2(renderSteps, assemblerContext);

    // Store/return frame
    return frame;
  }
  ```

**Verification:**
```bash
# Should return no results
rg "RenderPassIR" --type ts src/ | grep -v future-types
rg "ShapeDescriptor" --type ts src/ | grep -v future-types
rg "ResolvedShape" --type ts src/
```

---

### Task 4: Update Renderer Dispatch
**Priority**: P0
**Estimated**: 30 minutes
**Dependencies**: Task 3

**Files**: `src/render/Canvas2DRenderer.ts`

**Acceptance Criteria:**
- [ ] Import `RenderFrameIR_Future, DrawPathInstancesOp` from future-types
- [ ] Remove import of `RenderPassIR, ResolvedShape`
- [ ] `renderFrame()` accepts `RenderFrameIR_Future`
- [ ] `renderInstances2D()` function deleted
- [ ] `convertResolvedShapeToMode()` function deleted
- [ ] `ShapeMode` type deleted
- [ ] New `renderDrawPathInstancesOp()` function added
- [ ] New `drawPath()` helper added
- [ ] Instance transforms applied correctly
- [ ] Local-space points used (no width/height scaling)
- [ ] File compiles without errors

**Technical Notes:**

**New renderFrame signature:**
```typescript
export function renderFrame(
  ctx: CanvasRenderingContext2D,
  frame: RenderFrameIR_Future,
  width: number,
  height: number
): void {
  ctx.fillStyle = '#000000';
  ctx.fillRect(0, 0, width, height);

  for (const op of frame.ops) {
    renderDrawPathInstancesOp(ctx, op, width, height);
  }
}
```

**New renderDrawPathInstancesOp:**
```typescript
function renderDrawPathInstancesOp(
  ctx: CanvasRenderingContext2D,
  op: DrawPathInstancesOp,
  width: number,
  height: number
): void {
  const { geometry, instances, style } = op;
  const { points, verbs } = geometry;
  const { position, size, rotation, scale2, count } = instances;

  const scaleRef = Math.min(width, height);

  for (let i = 0; i < count; i++) {
    const xPx = position[i * 2] * width;
    const yPx = position[i * 2 + 1] * height;
    const sizeVal = typeof size === 'number' ? size : size[i];
    const sizePx = sizeVal * scaleRef;
    const rot = rotation ? rotation[i] : 0;

    ctx.save();
    ctx.translate(xPx, yPx);
    if (rot !== 0) ctx.rotate(rot);
    ctx.scale(sizePx, sizePx);

    drawPath(ctx, verbs, points);

    const fc = style.fillColor;
    ctx.fillStyle = `rgba(${fc[i*4]},${fc[i*4+1]},${fc[i*4+2]},${fc[i*4+3]/255})`;
    ctx.fill();

    ctx.restore();
  }
}
```

**New drawPath helper:**
```typescript
function drawPath(
  ctx: CanvasRenderingContext2D,
  verbs: Uint8Array,
  points: Float32Array
): void {
  ctx.beginPath();
  let pointIndex = 0;

  for (let i = 0; i < verbs.length; i++) {
    const verb = verbs[i];
    switch (verb) {
      case 0: // MOVE
        ctx.moveTo(points[pointIndex * 2], points[pointIndex * 2 + 1]);
        pointIndex++;
        break;
      case 1: // LINE
        ctx.lineTo(points[pointIndex * 2], points[pointIndex * 2 + 1]);
        pointIndex++;
        break;
      case 2: // CUBIC
        ctx.bezierCurveTo(
          points[pointIndex * 2], points[pointIndex * 2 + 1],
          points[pointIndex * 2 + 2], points[pointIndex * 2 + 3],
          points[pointIndex * 2 + 4], points[pointIndex * 2 + 5]
        );
        pointIndex += 3;
        break;
      case 3: // QUAD
        ctx.quadraticCurveTo(
          points[pointIndex * 2], points[pointIndex * 2 + 1],
          points[pointIndex * 2 + 2], points[pointIndex * 2 + 3]
        );
        pointIndex += 2;
        break;
      case 4: // CLOSE
        ctx.closePath();
        break;
      default:
        throw new Error(`Unknown path verb: ${verb}`);
    }
  }
}
```

**Verification:**
```bash
# Should find no v1 dispatch code
rg "renderInstances2D" --type ts src/
rg "convertResolvedShapeToMode" --type ts src/

# Should find v2 dispatch
rg "renderDrawPathInstancesOp" --type ts src/
```

---

### Task 5: Update Type Exports
**Priority**: P0
**Estimated**: 10 minutes
**Dependencies**: Task 4

**Files**:
- `src/runtime/index.ts`
- `src/render/index.ts`

**Acceptance Criteria:**
- [ ] `RenderPassIR` export removed from runtime/index.ts
- [ ] `ShapeDescriptor` export removed from runtime/index.ts
- [ ] `ResolvedShape` export removed from runtime/index.ts
- [ ] `RenderFrameIR` export removed from runtime/index.ts
- [ ] Old type exports removed from render/index.ts
- [ ] `RenderFrameIR_Future` export added to render/index.ts
- [ ] `DrawPathInstancesOp` export added to render/index.ts
- [ ] `PathGeometry` export added to render/index.ts
- [ ] `InstanceTransforms` export added to render/index.ts
- [ ] `PathStyle` export added to render/index.ts
- [ ] All index files compile without errors

**Technical Notes:**

**src/render/index.ts:**
```typescript
// OLD (delete)
// export type { RenderFrameIR, RenderPassIR } from '../runtime/ScheduleExecutor';

// NEW (add)
export type {
  RenderFrameIR_Future,
  DrawPathInstancesOp,
  PathGeometry,
  InstanceTransforms,
  PathStyle,
} from './future-types';
```

**Verification:**
```bash
npm run typecheck
```

---

### Task 6: Update Tests
**Priority**: P0
**Estimated**: 30 minutes
**Dependencies**: Task 5

**Files**: `src/runtime/__tests__/RenderAssembler.test.ts`

**Acceptance Criteria:**
- [ ] All v1 test cases removed
- [ ] V2 test cases added/updated
- [ ] Tests expect `DrawPathInstancesOp` structure
- [ ] Tests expect `RenderFrameIR_Future` (version: 2)
- [ ] `npm test` passes with 0 failures
- [ ] No type errors in tests

**Technical Notes:**

**Update test expectations:**
```typescript
describe('RenderAssembler v2', () => {
  describe('assembleDrawPathInstancesOp', () => {
    it('returns DrawPathInstancesOp for path topology', () => {
      const result = assembleDrawPathInstancesOp(step, context);

      expect(result).toBeDefined();
      expect(result?.kind).toBe('drawPathInstances');
      expect(result?.geometry).toBeDefined();
      expect(result?.geometry.topologyId).toBeDefined();
      expect(result?.geometry.points).toBeInstanceOf(Float32Array);
      expect(result?.instances).toBeDefined();
      expect(result?.instances.count).toBeGreaterThan(0);
      expect(result?.style).toBeDefined();
      expect(result?.style.fillColor).toBeInstanceOf(Uint8ClampedArray);
    });

    it('returns null for primitive topology', () => {
      // V2 only supports path rendering for now
      const result = assembleDrawPathInstancesOp(primitiveStep, context);
      expect(result).toBeNull();
    });
  });

  describe('assembleRenderFrame_v2', () => {
    it('returns RenderFrameIR_Future with ops array', () => {
      const frame = assembleRenderFrame_v2([step1, step2], context);

      expect(frame.version).toBe(2);
      expect(frame.ops).toBeInstanceOf(Array);
      expect(frame.ops.length).toBeGreaterThan(0);
    });

    it('filters out null ops', () => {
      const frame = assembleRenderFrame_v2([pathStep, primitiveStep], context);

      // Only path step produces an op
      expect(frame.ops.length).toBe(1);
    });
  });
});
```

**Verification:**
```bash
npm test
```

---

### Task 7: Visual Verification
**Priority**: P0
**Estimated**: 15 minutes
**Dependencies**: Task 6

**Acceptance Criteria:**
- [ ] Load test patches in dev mode
- [ ] Polygon shapes render correctly
- [ ] Colors are correct
- [ ] Sizes are correct
- [ ] Positions are correct
- [ ] No visual artifacts or distortion
- [ ] Console shows 0 errors
- [ ] Console shows 0 warnings
- [ ] Frame rate >= 60fps

**Technical Notes:**

**Test cases:**
1. Regular polygon (5 sides, default size)
2. Multiple instances with different positions
3. Different colors per instance
4. Varying sizes

**Verification procedure:**
```bash
npm run dev
# Open browser, load test patch
# Check console for errors
# Verify visual output
# Monitor frame rate
```

---

### Task 8: Cleanup and Documentation
**Priority**: P0
**Estimated**: 10 minutes
**Dependencies**: Task 7

**Acceptance Criteria:**
- [ ] PLAN-20260122.md marked complete
- [ ] DOD-20260122.md all items checked
- [ ] CONTEXT-20260122.md updated with final state
- [ ] Git diff shows ~600 lines deleted
- [ ] Commit message clear and descriptive

**Technical Notes:**

**Commit message template:**
```
chore: remove v1 RenderPassIR code path

Remove deprecated v1 rendering code after v2 migration complete.

Deleted:
- assembleRenderPass(), assembleAllPasses() from RenderAssembler
- RenderPassIR, ShapeDescriptor, ResolvedShape types
- V1 renderer dispatch logic

Kept:
- V2 assembly (assembleRenderFrame_v2, DrawPathInstancesOp)
- Local-space rendering with instance transforms
- All tests passing

Closes: oscilla-animator-v2-ry2
Depends on: oscilla-animator-v2-583, oscilla-animator-v2-46m

Lines deleted: ~600
```

**Verification:**
```bash
git diff --stat
git status
npm run typecheck
npm test
```

---

## Sprint Summary

**Total Estimated Time**: ~155 minutes (~2.5 hours)

**Task Dependencies:**
```
Task 1 (Verify V2)
  ↓
Task 2 (Delete assembly functions)
  ↓
Task 3 (Remove types)
  ↓
Task 4 (Update renderer)
  ↓
Task 5 (Update exports)
  ↓
Task 6 (Update tests)
  ↓
Task 7 (Visual verification)
  ↓
Task 8 (Cleanup)
```

**Risk Assessment:**
- Overall risk: LOW (when dependencies complete)
- Each task is incremental with clear verification
- V2 path already proven before cleanup
- Can roll back if issues found

**Success Criteria:**
- ✅ All v1 code deleted
- ✅ TypeScript compiles
- ✅ All tests pass
- ✅ Visual output unchanged
- ✅ Console clean
- ✅ ~600 lines removed

## Notes

**IMPORTANT**: This sprint is BLOCKED until dependencies complete. Do not start without:
1. RenderAssembler v2 fully working
2. Renderer local-space migration complete
3. Visual regression test passed
4. Performance acceptable

This is the LAST step in the render pipeline migration. Only execute when v2 is fully proven.
