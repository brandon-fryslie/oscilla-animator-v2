# Implementation Plan: Remove v1 RenderPassIR Code Path

**Bead**: oscilla-animator-v2-ry2
**Created**: 2026-01-22
**Priority**: P4 (Cleanup/Debt)
**Status**: BLOCKED - Dependencies not complete

## Dependencies

**MUST complete before starting this work:**

1. **oscilla-animator-v2-583** (RenderAssembler v2) - COMPLETION REQUIRED
   - Status: in_progress
   - Need: `assembleRenderFrame_v2()` fully working and tested
   - Need: All consumers successfully using v2 path

2. **oscilla-animator-v2-46m** (Renderer local-space migration) - COMPLETION REQUIRED
   - Status: open
   - Need: Canvas2DRenderer using instance transforms
   - Need: Control points rendered without width/height scaling

**Why these are blockers:**
- We cannot remove v1 code while any part of the system still depends on it
- V2 must be fully operational and proven before v1 removal
- This cleanup is the LAST step, not the first

## Overview

This is a pure cleanup task to remove deprecated v1 RenderPassIR code paths after the v2 migration is complete. Once all consumers use `DrawPathInstancesOp` and local-space rendering, we can safely delete:
- V1 assembly functions
- V1 types (RenderPassIR, ShapeDescriptor, ResolvedShape)
- V1 renderer dispatch paths
- Deprecated `shape` field from types

## Scope

### Files to Modify

| File | Changes | Risk |
|------|---------|------|
| `src/runtime/RenderAssembler.ts` | Delete v1 functions, keep v2 | Low (v2 path separate) |
| `src/runtime/ScheduleExecutor.ts` | Delete v1 types, use v2 only | Medium (central module) |
| `src/render/Canvas2DRenderer.ts` | Delete v1 dispatch paths | Low (after migration) |
| `src/runtime/__tests__/RenderAssembler.test.ts` | Update test expectations | Low |

### What Gets Deleted

#### From RenderAssembler.ts (~300 lines removed)

**V1 assembly functions:**
```typescript
// DELETE: Lines 52-104
export function assembleRenderPass(
  step: StepRender,
  context: AssemblerContext
): RenderPassIR | null { ... }

// DELETE: Lines 279-293
export function assembleAllPasses(
  renderSteps: readonly StepRender[],
  context: AssemblerContext
): RenderPassIR[] { ... }

// DELETE: Lines 112-132
function resolveScale(...): number { ... }

// DELETE: Lines 143-176
function resolveShape(...): ShapeDescriptor | ArrayBufferView { ... }

// DELETE: Lines 180-194
function resolveControlPoints(...): ArrayBufferView | undefined { ... }

// DELETE: Lines 224-270
function resolveShapeFully(...): ResolvedShape { ... }

// DELETE: Lines 206-210
function isShapeDescriptor(...): shape is ShapeDescriptor { ... }
```

**Keep v2 assembly functions:**
- `assembleDrawPathInstancesOp()` (lines 403-491)
- `assembleRenderFrame_v2()` (lines 503-520)
- `buildPathGeometry()` (lines 316-341)
- `buildInstanceTransforms()` (lines 357-371)
- `buildPathStyle()` (lines 383-391)

#### From ScheduleExecutor.ts (~90 lines removed)

**V1 type definitions:**
```typescript
// DELETE: Lines 34-37
export interface RenderFrameIR {
  version: 1;
  passes: RenderPassIR[];
}

// DELETE: Lines 42-46
export interface ShapeDescriptor {
  readonly topologyId: TopologyId;
  readonly params: Record<string, number>;
}

// DELETE: Lines 58-80
export interface ResolvedShape {
  readonly resolved: true;
  readonly topologyId: TopologyId;
  readonly mode: 'path' | 'primitive';
  readonly params: Record<string, number>;
  readonly verbs?: Uint8Array;
  readonly controlPoints?: ArrayBufferView;
}

// DELETE: Lines 96-124
export interface RenderPassIR {
  kind: 'instances2d';
  count: number;
  position: ArrayBufferView;
  color: ArrayBufferView;
  scale: number;
  shape: ShapeDescriptor | ArrayBufferView | number; // @deprecated
  resolvedShape: ResolvedShape; // REQUIRED
}
```

**V1 render step dispatch:**
```typescript
// DELETE: Line 21 import
import { assembleRenderPass, type AssemblerContext } from './RenderAssembler';

// REPLACE: Lines 230-243 with v2 call
case 'render': {
  // OLD v1 path - DELETE
  const assemblerContext: AssemblerContext = {
    signals,
    instances: instances as ReadonlyMap<string, InstanceDecl>,
    state,
  };
  const pass = assembleRenderPass(step, assemblerContext);
  if (pass) {
    passes.push(pass);
  }
  break;
}
```

#### From Canvas2DRenderer.ts (~220 lines removed)

**V1 dispatch logic:**
```typescript
// DELETE: Lines 106-143
function renderInstances2D(
  ctx: CanvasRenderingContext2D,
  pass: RenderPassIR, // OLD type
  width: number,
  height: number
): void { ... }

// DELETE: Lines 262-282
type ShapeMode = { topology: TopologyDef; params: Record<string, number> };

function convertResolvedShapeToMode(resolved: ResolvedShape): ShapeMode { ... }
```

**After local-space migration, renderPathAtParticle changes:**
```typescript
// CURRENT (wrong - multiplies by width/height):
const px = controlPoints[pointIndex * 2] * width;
const py = controlPoints[pointIndex * 2 + 1] * height;

// AFTER migration (correct - local-space):
const px = controlPoints[pointIndex * 2];
const py = controlPoints[pointIndex * 2 + 1];
```

### What Stays

**Keep these exports from RenderAssembler.ts:**
- `AssemblerContext` interface
- `isPathTopology()` type guard
- `isRenderStep()` type guard
- All v2 functions (`assembleDrawPathInstancesOp`, `assembleRenderFrame_v2`, etc.)

**Keep these from ScheduleExecutor.ts:**
- `executeFrame()` function (update to use v2)
- All non-render step handling
- Continuity system logic
- State write logic

**Keep these from Canvas2DRenderer.ts:**
- `renderFrame()` entry point (update signature)
- Path rendering logic (after local-space migration)

## Migration Strategy

### Phase 1: Verify V2 Complete (PREREQUISITE)

**Before starting any deletions, confirm:**
1. ✅ All render steps use `assembleRenderFrame_v2()`
2. ✅ Renderer accepts `RenderFrameIR_Future` (version: 2)
3. ✅ Tests pass with v2 path only
4. ✅ Visual output matches v1 exactly

**Verification commands:**
```bash
# Check for any remaining v1 calls
rg "assembleRenderPass\(" --type ts src/
rg "RenderPassIR" --type ts src/ | grep -v "future-types"

# Run integration tests
npm test

# Visual regression test (manual)
npm run dev
# Load test patches, verify shapes render correctly
```

### Phase 2: Delete V1 Code (This Work)

**Step 1: Remove v1 functions from RenderAssembler.ts**
```typescript
// Keep only v2 functions:
// - assembleDrawPathInstancesOp
// - assembleRenderFrame_v2
// - buildPathGeometry
// - buildInstanceTransforms
// - buildPathStyle
// - Helper type guards
```

**Step 2: Update ScheduleExecutor.ts**
```typescript
// Replace import
- import { assembleRenderPass, type AssemblerContext } from './RenderAssembler';
+ import { assembleRenderFrame_v2, type AssemblerContext } from './RenderAssembler';

// Update executeFrame() render step handling
case 'render': {
  const assemblerContext: AssemblerContext = {
    signals,
    instances: instances as ReadonlyMap<string, InstanceDecl>,
    state,
  };

  // V2 path - assemble entire frame
  const frame = assembleRenderFrame_v2(
    steps.filter(s => s.kind === 'render') as StepRender[],
    assemblerContext
  );

  // Store in appropriate slot or return
  return frame;
}
```

**Step 3: Update Canvas2DRenderer.ts**
```typescript
// Update imports
- import type { RenderFrameIR, RenderPassIR, ResolvedShape } from '../runtime/ScheduleExecutor';
+ import type { RenderFrameIR_Future, DrawPathInstancesOp } from './future-types';

// Update renderFrame signature
export function renderFrame(
  ctx: CanvasRenderingContext2D,
- frame: RenderFrameIR,
+ frame: RenderFrameIR_Future,
  width: number,
  height: number
): void {
  ctx.fillStyle = '#000000';
  ctx.fillRect(0, 0, width, height);

  // Dispatch to v2 renderer
- for (const pass of frame.passes) {
-   renderPass(ctx, pass, width, height);
- }
+ for (const op of frame.ops) {
+   renderDrawPathInstancesOp(ctx, op, width, height);
+ }
}

// New v2 rendering function
function renderDrawPathInstancesOp(
  ctx: CanvasRenderingContext2D,
  op: DrawPathInstancesOp,
  width: number,
  height: number
): void {
  const { geometry, instances, style } = op;
  const { points, verbs } = geometry;
  const { position, size, rotation, scale2, count } = instances;

  // Compute scale reference (isotropic across non-square viewports)
  const scaleRef = Math.min(width, height);

  for (let i = 0; i < count; i++) {
    // Extract instance data
    const xNorm = position[i * 2];
    const yNorm = position[i * 2 + 1];
    const xPx = xNorm * width;
    const yPx = yNorm * height;

    const sizeVal = typeof size === 'number' ? size : size[i];
    const sizePx = sizeVal * scaleRef;

    const rot = rotation ? rotation[i] : 0;

    // Apply instance transform
    ctx.save();
    ctx.translate(xPx, yPx);
    if (rot !== 0) {
      ctx.rotate(rot);
    }
    ctx.scale(sizePx, sizePx);

    // Draw path with LOCAL-SPACE points (no width/height scaling)
    drawPath(ctx, verbs, points);

    // Apply style
    const fillColor = style.fillColor;
    ctx.fillStyle = `rgba(${fillColor[i * 4]},${fillColor[i * 4 + 1]},${fillColor[i * 4 + 2]},${fillColor[i * 4 + 3] / 255})`;
    ctx.fill();

    ctx.restore();
  }
}

function drawPath(
  ctx: CanvasRenderingContext2D,
  verbs: Uint8Array,
  points: Float32Array
): void {
  ctx.beginPath();
  let pointIndex = 0;

  for (let i = 0; i < verbs.length; i++) {
    const verb = verbs[i];

    switch (verb) {
      case 0: // MOVE
        ctx.moveTo(points[pointIndex * 2], points[pointIndex * 2 + 1]);
        pointIndex++;
        break;
      case 1: // LINE
        ctx.lineTo(points[pointIndex * 2], points[pointIndex * 2 + 1]);
        pointIndex++;
        break;
      case 2: // CUBIC
        ctx.bezierCurveTo(
          points[pointIndex * 2], points[pointIndex * 2 + 1],
          points[pointIndex * 2 + 2], points[pointIndex * 2 + 3],
          points[pointIndex * 2 + 4], points[pointIndex * 2 + 5]
        );
        pointIndex += 3;
        break;
      case 3: // QUAD
        ctx.quadraticCurveTo(
          points[pointIndex * 2], points[pointIndex * 2 + 1],
          points[pointIndex * 2 + 2], points[pointIndex * 2 + 3]
        );
        pointIndex += 2;
        break;
      case 4: // CLOSE
        ctx.closePath();
        break;
      default:
        throw new Error(`Unknown path verb: ${verb}`);
    }
  }
}
```

**Step 4: Delete deprecated type exports**
```typescript
// Remove from src/runtime/index.ts
- export type { RenderPassIR, ShapeDescriptor, ResolvedShape } from './ScheduleExecutor';
- export type { RenderFrameIR } from './ScheduleExecutor';

// Remove from src/render/index.ts
- export type { RenderFrameIR, RenderPassIR } from '../runtime/ScheduleExecutor';

// Add v2 exports
+ export type { RenderFrameIR_Future, DrawPathInstancesOp, PathGeometry, InstanceTransforms, PathStyle } from './future-types';
```

**Step 5: Update tests**
```typescript
// src/runtime/__tests__/RenderAssembler.test.ts

describe('RenderAssembler v2', () => {
  it('assembles DrawPathInstancesOp from render step', () => {
    const result = assembleDrawPathInstancesOp(step, context);

    expect(result).toBeDefined();
    expect(result?.kind).toBe('drawPathInstances');
    expect(result?.geometry.topologyId).toBeDefined();
    expect(result?.instances.count).toBe(5);
    expect(result?.style.fillColor).toBeInstanceOf(Uint8ClampedArray);
  });

  it('assembles full render frame', () => {
    const frame = assembleRenderFrame_v2([step1, step2], context);

    expect(frame.version).toBe(2);
    expect(frame.ops).toHaveLength(2);
  });
});
```

### Phase 3: Verification

**Required checks after deletion:**
1. TypeScript compilation succeeds: `npm run typecheck`
2. All tests pass: `npm test`
3. No references to deleted types: `rg "RenderPassIR|ShapeDescriptor|ResolvedShape" src/`
4. Visual output unchanged: Manual test with example patches
5. No console errors in dev mode: `npm run dev`

## Risks and Mitigations

| Risk | Likelihood | Impact | Mitigation |
|------|------------|--------|------------|
| Missed v1 reference | Low | High | Use grep to find all references before deletion |
| Type imports break | Medium | Medium | Update all index.ts exports |
| Renderer fails | Low | High | Verify v2 path works BEFORE deleting v1 |
| Tests fail | Low | Medium | Update test expectations for v2 types |

## Success Criteria

1. ✅ All v1 functions deleted from RenderAssembler.ts
2. ✅ All v1 types deleted from ScheduleExecutor.ts
3. ✅ Renderer uses only v2 path (DrawPathInstancesOp)
4. ✅ TypeScript compiles with no errors
5. ✅ All unit tests pass
6. ✅ Visual output matches pre-deletion state
7. ✅ No console errors or warnings
8. ✅ Code size reduced by ~600 lines

## Out of Scope

- **NOT** implementing new features (rotation, scale2, stroke)
- **NOT** optimizing v2 performance
- **NOT** adding SVG renderer
- **NOT** changing topology ID format (string → number)

This is ONLY about removing deprecated v1 code after v2 is fully operational.

## Estimated Effort

- Code deletion: 30 minutes
- Type updates: 20 minutes
- Test updates: 30 minutes
- Verification: 20 minutes
- **Total**: ~100 minutes (2 hours)

## Notes

This work is **BLOCKED** until:
1. RenderAssembler v2 is complete and proven
2. Renderer local-space migration is complete
3. All consumers successfully use v2 path

Do not attempt this cleanup prematurely. The v2 path must be fully operational before v1 deletion.
