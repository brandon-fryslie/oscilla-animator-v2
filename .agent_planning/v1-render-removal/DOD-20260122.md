# Definition of Done: Remove v1 RenderPassIR Code Path

**Bead**: oscilla-animator-v2-ry2
**Created**: 2026-01-22
**Plan**: PLAN-20260122.md

## Prerequisites (BLOCKERS)

These MUST be complete before starting:

- [ ] **oscilla-animator-v2-583** (RenderAssembler v2) marked as `closed`
  - `assembleRenderFrame_v2()` fully working
  - All tests passing with v2
  - Visual output verified

- [ ] **oscilla-animator-v2-46m** (Renderer local-space migration) marked as `closed`
  - Canvas2DRenderer using instance transforms
  - Control points rendered without width/height scaling
  - Size parameter correctly applied

- [ ] Visual regression verification complete
  - Test patches render identically with v2
  - No artifacts or distortion
  - Performance acceptable

## Acceptance Criteria

### 1. Code Deletion Complete

**RenderAssembler.ts v1 functions removed:**
- [ ] `assembleRenderPass()` deleted (lines 52-104)
- [ ] `assembleAllPasses()` deleted (lines 279-293)
- [ ] `resolveScale()` deleted (lines 112-132)
- [ ] `resolveShape()` deleted (lines 143-176)
- [ ] `resolveControlPoints()` deleted (lines 180-194)
- [ ] `resolveShapeFully()` deleted (lines 224-270)
- [ ] `isShapeDescriptor()` type guard deleted (lines 206-210)

**RenderAssembler.ts v2 functions retained:**
- [ ] `assembleDrawPathInstancesOp()` present
- [ ] `assembleRenderFrame_v2()` present
- [ ] `buildPathGeometry()` present
- [ ] `buildInstanceTransforms()` present
- [ ] `buildPathStyle()` present
- [ ] `isPathTopology()` type guard present
- [ ] `isRenderStep()` type guard present
- [ ] `AssemblerContext` interface present

**ScheduleExecutor.ts v1 types removed:**
- [ ] `RenderFrameIR` type deleted
- [ ] `ShapeDescriptor` type deleted
- [ ] `ResolvedShape` type deleted
- [ ] `RenderPassIR` type deleted
- [ ] Import of `assembleRenderPass` removed

**ScheduleExecutor.ts v2 integration:**
- [ ] Import of `assembleRenderFrame_v2` added
- [ ] `executeFrame()` uses v2 assembly
- [ ] Render step case updated to call v2

**Canvas2DRenderer.ts v1 dispatch removed:**
- [ ] `renderInstances2D()` function deleted
- [ ] `convertResolvedShapeToMode()` deleted
- [ ] `ShapeMode` type deleted
- [ ] Import of `RenderPassIR` removed
- [ ] Import of `ResolvedShape` removed

**Canvas2DRenderer.ts v2 rendering:**
- [ ] `renderFrame()` accepts `RenderFrameIR_Future`
- [ ] `renderDrawPathInstancesOp()` function added
- [ ] `drawPath()` helper uses local-space points
- [ ] Instance transforms applied correctly (translate/rotate/scale)
- [ ] Scale reference uses `min(width, height)`

### 2. Type Export Updates

**src/runtime/index.ts:**
- [ ] `RenderPassIR` export removed
- [ ] `ShapeDescriptor` export removed
- [ ] `ResolvedShape` export removed
- [ ] `RenderFrameIR` export removed

**src/render/index.ts:**
- [ ] Old type exports removed
- [ ] `RenderFrameIR_Future` export added
- [ ] `DrawPathInstancesOp` export added
- [ ] `PathGeometry` export added
- [ ] `InstanceTransforms` export added
- [ ] `PathStyle` export added

### 3. Test Updates

**Unit tests pass:**
- [ ] `RenderAssembler.test.ts` updated for v2
- [ ] Tests expect `DrawPathInstancesOp` structure
- [ ] Tests expect `RenderFrameIR_Future` (version: 2)
- [ ] No tests reference deleted v1 types

**Integration verification:**
- [ ] `npm test` passes with 0 failures
- [ ] TypeScript compilation succeeds: `npm run typecheck`
- [ ] No type errors in console

### 4. Code Verification

**No v1 references remain:**
- [ ] `rg "assembleRenderPass\(" --type ts src/` returns 0 results
- [ ] `rg "assembleAllPasses\(" --type ts src/` returns 0 results
- [ ] `rg "RenderPassIR" --type ts src/ | grep -v future-types` returns 0 results
- [ ] `rg "ShapeDescriptor" --type ts src/ | grep -v future-types` returns 0 results
- [ ] `rg "ResolvedShape" --type ts src/` returns 0 results
- [ ] `rg "resolveShapeFully" --type ts src/` returns 0 results

**Only v2 code remains:**
- [ ] `rg "assembleRenderFrame_v2" --type ts src/` finds usage in ScheduleExecutor
- [ ] `rg "DrawPathInstancesOp" --type ts src/` finds usage in renderer
- [ ] `rg "RenderFrameIR_Future" --type ts src/` finds usage in renderer

### 5. Visual Verification

**Rendering unchanged:**
- [ ] Load test patches in dev mode (`npm run dev`)
- [ ] Polygon shapes render correctly
- [ ] Colors are correct
- [ ] Sizes are correct
- [ ] Positions are correct
- [ ] No visual artifacts or distortion
- [ ] Console shows 0 errors
- [ ] Console shows 0 warnings

**Performance acceptable:**
- [ ] Frame rate >= 60fps for typical scenes
- [ ] No new memory leaks
- [ ] No unexpected GC pauses

### 6. Documentation Updates

- [ ] PLAN-20260122.md marked complete
- [ ] DOD-20260122.md all items checked
- [ ] Update CONTEXT-20260122.md with final state
- [ ] Add migration notes for future reference

### 7. Code Metrics

**Lines of code reduced:**
- [ ] RenderAssembler.ts: ~300 lines removed
- [ ] ScheduleExecutor.ts: ~90 lines removed
- [ ] Canvas2DRenderer.ts: ~220 lines removed (net after v2 additions)
- [ ] Total: ~600 lines removed

**Complexity reduced:**
- [ ] Fewer type discriminators
- [ ] Simpler renderer dispatch
- [ ] Single assembly path
- [ ] Clearer data flow

## Exit Criteria (to raise confidence from BLOCKED → READY)

This work is **BLOCKED** until dependencies complete. To proceed:

1. ✅ RenderAssembler v2 bead (`oscilla-animator-v2-583`) status = `closed`
2. ✅ Renderer local-space bead (`oscilla-animator-v2-46m`) status = `closed`
3. ✅ Visual regression test passed
4. ✅ Performance benchmarks passed

Once these are satisfied, this work becomes **READY FOR IMPLEMENTATION**.

## Deferred Work

These are explicitly OUT OF SCOPE for this cleanup:

### Future Enhancements (Not Now)
- Rotation support in DrawPathInstancesOp
- Scale2 (anisotropic) support
- Stroke rendering
- Gradient fills
- Blend modes
- SVG renderer implementation

### Future Refactors (Not Now)
- Topology ID migration (string → number)
- Path caching/reuse optimization
- Multi-backend abstraction
- WebGL renderer

## Notes

- This is a **pure cleanup task** - no new features
- Must not change visual output or behavior
- Safe to execute only after v2 is fully operational
- Reduces maintenance burden and complexity
- Improves code clarity and type safety
