# Explore Output: Circular Dependencies (blocks/registry <-> compiler <-> stores)
Timestamp: 2026-02-03-131723

## Trigger

Test file `src/patch-dsl/__tests__/composite-roundtrip.test.ts:524` has a local (uncommitted) modification adding `describe.skip` with comment:
```
// SKIP: Store Integration tests cause heap exhaustion due to circular dependency
// between blocks/registry -> compiler modules -> stores
```

The committed version (fa107a3) does NOT have this skip -- the tests were written with `describe('Store Integration', ...)` and use dynamic `await import()` already.

## Module Dependency Map

### blocks/registry.ts imports from compiler (ALL type-only, erased at runtime)
- `import type { IRBuilder } from '../compiler/ir/IRBuilder'` (line 13)
- `import type { InstanceId, StateSlotId } from '../compiler/ir/Indices'` (line 15)
- `export type { ValueRefPacked, ValueRefExpr, LowerEffects } from '../compiler/ir/lowerTypes'` (line 21)

### Block implementation files import from compiler (VALUE imports, exist at runtime)
- ~30+ block files import `{ OpCode }` from `../../compiler/ir/types`
- ~5 block files import `{ stableStateId }` from `../../compiler/ir/types`
- `blocks/signal/default-source.ts` imports `{ LowerSandbox }` from `../../compiler/ir/LowerSandbox`
- `blocks/time/infinite-time-root.ts` imports `{ valueSlot, SYSTEM_PALETTE_SLOT }` from `../../compiler/ir/Indices`

### compiler/ imports from blocks/ (VALUE imports)
- `compiler/ir/LowerSandbox.ts:24`: `import { requireBlockDef, type LowerArgs, type LowerCtx } from '../../blocks/registry'`
- `compiler/backend/lower-blocks.ts:13`: `import { getBlockDefinition, type LowerCtx, type LowerResult, hasLowerOutputsOnly } from "../../blocks/registry"`
- `compiler/compile.ts:40`: `import '../blocks/all'` (side-effect: registers all blocks)
- `compiler/reachability.ts:11`: `import { getBlockDefinition } from '../blocks/registry'`
- `compiler/frontend/*.ts`: Multiple files import `getBlockDefinition`, `requireBlockDef` etc from `blocks/registry`
- `compiler/frontend/normalize-composites.ts`: imports from `blocks/composite-types`
- `compiler/frontend/normalize-adapters.ts`: imports `findAdapter` from `blocks/adapter-spec`

### stores/ imports from blocks/ (VALUE imports)
- `stores/PatchStore.ts:18`: `import { requireAnyBlockDef } from '../blocks/registry'`
- `stores/PortHighlightStore.ts:17`: `import { requireAnyBlockDef } from '../blocks/registry'`
- `stores/CompositeEditorStore.ts:18-28`: imports `registerComposite`, `unregisterComposite`, `getCompositeDefinition`, `getAnyBlockDefinition`, `validateCompositeDefinition`, `compositeStorage`, `compositeDefToJSON` from blocks/

### stores/ <-> compiler/ (NO direct imports in either direction)
- compiler/ does NOT import from stores/
- stores/ does NOT import from compiler/

### compiler/ir/types.ts imports (NO blocks or stores)
- Only imports from `core/canonical-types`, `./Indices`, `../../shapes/types`, `./schedule`, `../../runtime/KernelRegistry`

### compiler/ir/Indices.ts imports (NO blocks or stores)
- Only imports/re-exports from `../../core/ids`

## Actual Cycle Analysis

### Cycle 1: blocks/ <-> compiler/ir/LowerSandbox
```
blocks/signal/default-source.ts
  -> compiler/ir/LowerSandbox.ts (value import: LowerSandbox class)
    -> blocks/registry.ts (value import: requireBlockDef)
```

This is a real runtime circular dependency, BUT:
- `blocks/registry.ts` is the hub being imported by both sides
- `LowerSandbox` needs the registry to look up block definitions for macro expansion
- `default-source.ts` needs `LowerSandbox` to lower default-source blocks

### NOT Actually Circular at Runtime
The `blocks/registry.ts` -> `compiler/ir/` path is TYPE-ONLY (erased at runtime), so:
- `compiler/ir/types.ts` does NOT import from blocks at all
- `compiler/ir/Indices.ts` does NOT import from blocks at all
- The OpCode/stableStateId imports from blocks into compiler/ir/types.ts are one-directional (blocks -> compiler)

### Module Load Order
When `blocks/all.ts` is loaded:
1. Each block file loads -> imports OpCode etc from compiler/ir/types.ts (one-way, no cycle)
2. `blocks/signal/default-source.ts` loads -> imports LowerSandbox -> LowerSandbox imports requireBlockDef from registry
3. At this point, registry.ts is ALREADY being loaded (as the hub), so this IS a circular load order issue

Node.js/Vitest handles this via partial module initialization -- the registry module may not be fully initialized when LowerSandbox tries to import from it.

## Store Integration Tests

The 3 "Store Integration" tests in `composite-roundtrip.test.ts` use dynamic `await import()` for CompositeEditorStore. The original (committed) version runs these without `.skip`.

The local modification adds `.skip` claiming heap exhaustion, but:
- Store integration tests in `src/stores/__tests__/integration.test.ts` pass fine (11 tests, 2.38s)
- The composite-roundtrip test file itself runs fine (27 passed, 3 skipped)
- Full test suite: 144 passed, 6 skipped

## Architectural Status

Per CLAUDE.md, the intended dependency direction is:
```
UI/React <-- Stores (MobX) <-- Compiler + Runtime
         |
       Graph <-- Patch (user-facing)
                   |
                 Blocks Registry
                   |
                 Types & Core
```

Current violations:
1. blocks/ imports from compiler/ir/ (value imports: OpCode, LowerSandbox, stableStateId, valueSlot)
2. compiler/ imports from blocks/ (value imports: getBlockDefinition, requireBlockDef, etc.)

This creates a bidirectional dependency between blocks/ and compiler/ layers.

## Test Suite Status
- 144 passed, 6 skipped test files
- 2137 passed, 25 skipped, 2 todo tests
- The 3 skipped tests in composite-roundtrip.test.ts are the ONLY ones related to this issue
