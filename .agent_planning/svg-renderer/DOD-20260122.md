# Definition of Done: SVG Renderer

**Bead ID**: oscilla-animator-v2-0uk
**Generated**: 2026-01-22
**Confidence**: HIGH
**Plan**: PLAN-20260122.md

## Prerequisites (Blocking Dependencies)

- [ ] **oscilla-animator-v2-46m COMPLETE**: Local-space renderer migration
  - Control points MUST be in local space (centered at origin, |p|≈O(1))
  - Canvas2DRenderer updated to apply instance transforms
  - Materializer kernels updated to output local-space coordinates
- [ ] **oscilla-animator-v2-583 COMPLETE**: RenderAssembler v2 produces DrawPathInstancesOp
  - assembleDrawPathInstancesOp() function working
  - PathGeometry with local-space points
  - InstanceTransforms with world-space position/size/rotation/scale2
  - PathStyle with fillColor/fillRule

## Core Implementation

### 1. SVGRenderer Class Structure

- [ ] SVGRenderer class created in `src/render/SVGRenderer.ts`
- [ ] Constructor creates SVG element with viewBox
- [ ] `<defs>` element created for geometry templates
- [ ] `<g>` element created for instances
- [ ] Public API: `constructor()`, `render()`, `clear()`, `dispose()`

### 2. Geometry Cache

- [ ] GeometryCache class implemented
- [ ] Cache key computed from (topologyId, buffer identity)
- [ ] Buffer identity tracked via WeakMap OR content hash
- [ ] Cache stores d strings
- [ ] Cache reuses d strings for same buffer reference
- [ ] Cache clears all entries on demand

### 3. Path D String Generation

- [ ] `pathToSvgD()` function implemented
- [ ] MOVE verb (0) → `M x y`
- [ ] LINE verb (1) → `L x y`
- [ ] CUBIC verb (2) → `C cp1x cp1y cp2x cp2y x y`
- [ ] QUAD verb (3) → `Q cpx cpy x y`
- [ ] CLOSE verb (4) → `Z`
- [ ] Point index tracking correct for all verbs
- [ ] Validation: throws error if pointsCount insufficient
- [ ] Numbers formatted with 6 decimal precision

### 4. Geometry Definition Management

- [ ] `ensureGeometryDef()` function implemented
- [ ] Creates `<path id="{geomKey}" d="...">` in `<defs>`
- [ ] Reuses existing path if id matches
- [ ] One `<path>` per unique (topologyId, buffer) pair

### 5. Instance Transform Computation

- [ ] `computeInstanceTransform()` function implemented
- [ ] Position mapped from normalized [0,1] to viewport coordinates
- [ ] Size scaled by D = min(width, height)
- [ ] Rotation converted from radians to degrees
- [ ] scale2 (anisotropic) supported and overrides isotropic if present
- [ ] Transform order: `translate(x,y) rotate(θ) scale(sx,sy)`
- [ ] Numbers formatted with 6 decimal precision

### 6. Style Attribute Mapping

- [ ] `buildStyleAttributes()` function implemented
- [ ] Fill color extracted from Uint8ClampedArray
- [ ] Per-instance colors supported (index * 4 offset)
- [ ] Uniform colors supported
- [ ] Alpha channel mapped to fill-opacity [0,1]
- [ ] Fill rule ('nonzero' | 'evenodd') mapped correctly

### 7. Instance Rendering

- [ ] `renderInstances()` function implemented
- [ ] Clears existing instances before rendering
- [ ] Creates one `<use>` element per instance
- [ ] Sets `href="#geomKey"` attribute
- [ ] Sets `transform` attribute
- [ ] Sets `fill`, `fill-opacity`, `fill-rule` attributes
- [ ] Appends `<use>` elements to render group

### 8. Main Render Function

- [ ] `render(frame, width, height)` implemented
- [ ] Updates viewBox if dimensions change
- [ ] Iterates frame.ops (DrawPathInstancesOp array)
- [ ] For each op: ensure geometry def, render instances
- [ ] Handles errors gracefully (logs, doesn't crash)
- [ ] Multiple ops can coexist in same frame

## Testing & Validation

### Unit Tests

- [ ] `pathToSvgD()` tested with all verb types
- [ ] `computeGeometryKey()` tested for cache reuse
- [ ] `computeInstanceTransform()` tested for coordinate mapping
- [ ] `buildStyleAttributes()` tested for color/opacity formatting

### Integration Tests

- [ ] Render single op with 1 instance (minimal case)
- [ ] Render single op with N instances (instancing)
- [ ] Render multiple ops with different topologies
- [ ] Verify geometry reuse (same topology → same `<path>`)

### Visual Verification

- [ ] Test page created (e.g., `test-svg-renderer.html`)
- [ ] Renders pentagon topology correctly
- [ ] Renders multiple instances with different positions
- [ ] Renders multiple instances with different colors
- [ ] Visual output matches Canvas2DRenderer (side-by-side comparison)

### DOM Inspection

- [ ] Inspect `<defs>`: one `<path>` per topology
- [ ] Inspect render group: N `<use>` elements for N instances
- [ ] Verify `href` attributes point to correct geometry
- [ ] Verify `transform` attributes are correct
- [ ] Verify `fill`, `fill-opacity` attributes are correct

## Documentation

- [ ] Module-level JSDoc describes purpose and usage
- [ ] Coordinate space assumptions documented (local vs world vs viewport)
- [ ] Dependency on local-space geometry documented
- [ ] Public API documented (constructor params, render signature)
- [ ] pathToSvgD verb mapping documented
- [ ] Transform composition order documented

## Code Quality

- [ ] No TypeScript errors
- [ ] No linter warnings
- [ ] Follows project naming conventions
- [ ] Follows architectural invariants (single source of truth, etc.)
- [ ] Error handling present (throws with clear messages)
- [ ] No console.log (use console.warn/error appropriately)

## Integration

- [ ] SVGRenderer exported from `src/render/SVGRenderer.ts`
- [ ] Can be imported and used independently
- [ ] Optional integration with App.tsx (toggle between Canvas/SVG)
- [ ] No breaking changes to existing renderers

## Acceptance Criteria Summary

**MUST HAVE** (blocking sign-off):
1. SVGRenderer renders DrawPathInstancesOp correctly
2. Geometry reused via `<defs>`/`<use>` (verified via DOM inspection)
3. Instance transforms correct (position, size, rotation, scale2)
4. Style attributes correct (fill, opacity, fillRule)
5. Visual output matches Canvas2DRenderer
6. Local-space geometry assumption documented
7. Test page demonstrates functionality

**SHOULD HAVE** (nice to have):
- Unit tests for core functions
- Integration tests
- App.tsx integration (renderer toggle)

**OUT OF SCOPE** (deferred to future work):
- Stroke rendering (oscilla-animator-v2-02h)
- Per-instance shapes (oscilla-animator-v2-f2w)
- Element pooling/reuse optimization
- SVG export to file
- Animation/SMIL
- Filters, gradients, patterns

## Sign-Off Checklist

- [ ] All blocking dependencies complete
- [ ] All core implementation tasks complete
- [ ] All testing & validation tasks complete
- [ ] All documentation tasks complete
- [ ] Code quality checks pass
- [ ] Visual verification passed
- [ ] DOM inspection passed
- [ ] Ready for code review
