# Definition of Done: Store Foundation

## Acceptance Criteria

### 1. MobX Strict Mode Configured
- [ ] `configure({ enforceActions: 'always' })` is called before any store is created
- [ ] Attempting mutation outside action throws error (test this)

### 2. PatchStore is Single Source of Truth
- [ ] `PatchStore` class exists with `patch` getter returning `ImmutablePatch`
- [ ] `blocks` and `edges` computed getters derive from internal state
- [ ] `buses` computed getter filters blocks by role
- [ ] Actions: `addBlock`, `removeBlock`, `updateBlockParams`, `addEdge`, `removeEdge`
- [ ] `loadPatch()` and `clear()` for bulk operations

### 3. SelectionStore Stores IDs Only
- [ ] `selectedBlockId`, `selectedEdgeId` are observable IDs (not block objects)
- [ ] `selectedBlock` is a computed that derives from `PatchStore`
- [ ] Constructor takes `PatchStore` dependency
- [ ] Actions: `selectBlock`, `selectEdge`, `clearSelection`

### 4. ViewportStore is Independent
- [ ] `pan` and `zoom` observables
- [ ] Actions: `setPan`, `setZoom`, `panBy`, `zoomBy`, `resetView`
- [ ] No dependency on other stores

### 5. PlaybackStore is Independent
- [ ] `time`, `isPlaying`, `speed`, `seed` observables
- [ ] Actions: `play`, `pause`, `togglePlayPause`, `setSpeed`, `setSeed`
- [ ] No dependency on other stores

### 6. DiagnosticsStore is Independent
- [ ] `errors`, `warnings`, `logs` observable arrays
- [ ] Computed: `hasErrors`, `errorCount`, `warningCount`
- [ ] Actions: `addError`, `addWarning`, `log`, `clearDiagnostics`
- [ ] No dependency on other stores

### 7. RootStore Composes All Stores
- [ ] Creates and owns all child stores
- [ ] Passes `PatchStore` to `SelectionStore` constructor
- [ ] Single instance pattern via React context

### 8. React Context Integration
- [ ] `StoreProvider` component wraps app
- [ ] `useStores()` hook returns `RootStore`
- [ ] `useStore('patch')` convenience hook pattern

### 9. TypeScript Enforcement
- [ ] `ImmutablePatch` type cannot be constructed outside stores module
- [ ] `mobx` import only appears in `src/stores/` (verify with grep)
- [ ] Components can only import from `src/stores` or `mobx-react-lite`

### 10. Tests
- [ ] PatchStore: add/remove block, add/remove edge
- [ ] PatchStore: computed properties update correctly
- [ ] SelectionStore: selection derives from patch
- [ ] Integration: selecting a block, then removing it clears selection

## Verification Commands

```bash
# Type check
npm run typecheck

# Run tests
npm test

# Verify mobx imports are only in stores/
grep -r "from 'mobx'" src/ --include="*.ts" --include="*.tsx" | grep -v "src/stores/"

# Should return nothing (mobx-react-lite is allowed elsewhere)
```

## Files to Create

```
src/stores/
├── index.ts
├── internal.ts
├── configure.ts
├── RootStore.ts
├── PatchStore.ts
├── SelectionStore.ts
├── ViewportStore.ts
├── PlaybackStore.ts
├── DiagnosticsStore.ts
├── context.tsx
└── __tests__/
    ├── PatchStore.test.ts
    ├── SelectionStore.test.ts
    └── integration.test.ts
```
