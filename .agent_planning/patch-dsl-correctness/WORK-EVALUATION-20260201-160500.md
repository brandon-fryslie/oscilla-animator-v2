# Work Evaluation - 2026-02-01T16:05:00

Scope: patch-dsl-correctness
Confidence: FRESH

## Goals Under Evaluation

From SPRINT-20260201-patch-dsl-fixes-DOD.md:
1. AC1: Garbage input does not throw
2. AC2: Dashed identifiers lex correctly
3. AC3: Vararg, lens, port-override round-trip
4. AC4: Negative number literals
5. AC5: Null keyword round-trip
6. AC6: Quoted param keys
7. AC7: Tripwire test file
8. AC8: recoverToBlockEnd bracket depth
9. AC9: Error messages use blockName.portName format
10. AC10: No regressions
11. AC11: Typecheck passes
12. AC12: Child beads closed

## Previous Evaluation Reference

No previous evaluation exists.

## Persistent Check Results

| Check | Status | Output Summary |
|-------|--------|----------------|
| `npx vitest run src/patch-dsl/` | PASS | 122/122 tests, 7 files |
| `npm run typecheck` | PASS | Clean |
| `npm run test` | PASS | 2005/2005 tests (135 files, 6 skipped) |

## Manual Runtime Testing

### What I Tried

1. Garbage input: `deserializePatchFromHCL('!@#$%^&*()')` - returns errors, no throw
2. Unterminated string: `'block "Foo" { x = "unterminated'` - returns errors, no throw
3. Empty string input - returns empty patch, no errors (correct)
4. 10,000 character input - returns errors, no throw
5. Script injection `<script>alert(1)</script>` - returns errors, no throw
6. Negative numbers: `-1`, `-0.5`, `-.5` all lex as NUMBER tokens
7. `a=-1` correctly tokenizes as IDENT EQUALS NUMBER
8. `null` in objects, lists, and top-level params round-trips correctly
9. Dashed identifiers: `golden-spiral` lexes as single IDENT
10. Quoted param keys with spaces round-trip correctly
11. Port override round-trip with registered blocks (Phasor.frequency) works
12. Vararg round-trip with registered blocks (Array.element) works
13. Lens deserialization tested

### What Actually Happened

1-5. All error handling works correctly. Never throws.
6-7. Negative numbers work as specified.
8. Null round-trips perfectly in all positions.
9. Dashed identifiers work. `-foo` correctly throws (caught by deserializer).
10. Quoted keys work. Valid identifiers correctly stay unquoted.
11. Port override survives serialize -> deserialize -> serialize.
12. Vararg connections survive full round-trip with exact match.
13. **Lens deserialization is NOT implemented.** Code at `src/patch-dsl/patch-from-ast.ts:247` contains `TODO: Determine which port this lens attaches to` and emits a warning: "Lens deserialization not fully implemented."

## Data Flow Verification

| Step | Expected | Actual | Status |
|------|----------|--------|--------|
| Garbage input -> errors | No throw, errors returned | No throw, errors returned | PASS |
| Dashed ident lex | Single IDENT token | Single IDENT token | PASS |
| Negative number lex | NUMBER token | NUMBER token | PASS |
| Null lex | NULL token | NULL token | PASS |
| Null round-trip (object) | `{ a = null }` -> null -> `{ a = null }` | Exact match | PASS |
| Null round-trip (list) | `[1, null, 2]` -> `[1, null, 2]` | Exact match | PASS |
| Quoted key round-trip | `"my key" = 123` -> 123 -> `"my key" = 123` | Exact match | PASS |
| Port override round-trip | combineMode/defaultSource preserved | Preserved exactly | PASS |
| Vararg round-trip | Connections with alias/sortKey preserved | Preserved exactly | PASS |
| Lens round-trip | Lens data preserved | **DROPPED with warning** | FAIL |
| Error message format | blockName.portName | `nonexistent.out` (correct) | PASS |

## Break-It Testing

| Attack | Expected | Actual | Severity |
|--------|----------|--------|----------|
| Empty string | Empty patch, no errors | Empty patch, no errors | n/a |
| 10k chars | Errors returned | 1 error, empty patch | n/a |
| `<script>` injection | Errors returned | 1 error, empty patch | n/a |
| `a - 1` (space before dash) | Graceful error | Lexer throws, caught by try/catch | LOW |
| `foo-` trailing dash | Valid or error | Lexes as IDENT `foo-` | LOW |
| `foo--bar` double dash | Valid or error | Lexes as IDENT `foo--bar` | LOW |
| Bad block + good block recovery | Both blocks parsed | Only bad block, good block lost | MEDIUM |
| Deeply nested objects (50 levels) | Parse or error | Parses successfully | n/a |
| Vararg on unknown block type | Warning or error | Warning, varargs silently dropped | MEDIUM |

## Evidence

### Lens deserialization is stubbed
File: `src/patch-dsl/patch-from-ast.ts:227-248`
```typescript
} else if (child.type === 'lens' && child.labels.length === 1) {
  // ...
  // TODO: Determine which port this lens attaches to
  warnings.push(new PatchDslWarning(`Lens deserialization not fully implemented: "${lensType}"`, child.pos));
}
```
Runtime output: `warnings: ['Lens deserialization not fully implemented: "Adapter_DegreesToRadians"']`

### Recovery does not recover second block
Input with malformed first block `{ a = 1` (missing `}`) followed by valid second block:
- Result: 1 error, 1 block (the bad one partially), good block lost
- The tripwire test at `tripwire.test.ts:339-363` is too weak -- it only checks `blocks.length > 0`, not that recovery actually rescued the second block.

### Tripwire vararg test is insufficient
`tripwire.test.ts:292-337`: The vararg/port-override tests use unregistered block types ("Oscillator") which means:
- The port "phase" is never created in `inputPorts`
- The vararg block hits the "unknown port" path and silently drops data
- The test checks `errors.toHaveLength(0)` but doesn't check warnings
- The test never verifies that vararg connections actually exist on the port

This test would pass even if vararg deserialization was completely broken.

## Assessment

### PASS Working

- **AC1**: Garbage input returns errors, never throws. Verified with multiple inputs including empty, garbage, unterminated strings, script injection, 10k chars.
- **AC2**: Dashed identifiers lex as single IDENT. `golden-spiral` round-trips correctly. `-foo` correctly throws (caught by deserializer).
- **AC4**: Negative numbers `-1`, `-0.5`, `-.5` all work. `a=-1` tokenizes correctly. Round-trip preserves negative values.
- **AC5**: Null keyword works everywhere: top-level, in objects, in lists. Full round-trip preserves null values.
- **AC6**: Quoted param keys with spaces/special chars work. Valid identifiers stay unquoted.
- **AC7**: Tripwire test file exists with 24 tests covering all topics. (But see quality concerns below.)
- **AC8**: `recoverToBlockEnd` tracks bracket depth (code at parser.ts:395-421 tracks both `braceDepth` and `bracketDepth`). Does not consume past bracket boundaries.
- **AC9**: Error messages use `blockName.portName` format, not JSON blobs. Verified: `"Unresolved from reference: nonexistent.out"`.
- **AC10**: All 2005 existing tests pass. No regressions.
- **AC11**: `npm run typecheck` passes cleanly.

### FAIL Not Working

- **AC3 (partial)**: Vararg connections and port overrides survive round-trip correctly. **Lens attachments do NOT survive round-trip.** The deserializer has a TODO stub that emits a warning and drops the data. This violates the explicit AC3 requirement: "lens attachments ... survive serialize->deserialize round-trip."

### WARNING Ambiguities Found

| Decision | What Was Assumed | Should Have Asked | Impact |
|----------|------------------|-------------------|--------|
| Trailing dash in identifiers | `foo-` is a valid identifier | Is trailing dash intentional? Could cause issues with future operators | LOW |
| Recovery depth | `braceDepth = 1` on entry | Correct assumption for "inside a block", but second block after bad block is lost | MEDIUM |
| AC12 bead structure | Beads are closed individually | Beads exist but have no parent link to j6h0 epic | LOW |

## Test Quality Issues

### Insufficient Tripwire Test (vararg/port-override)
`src/patch-dsl/__tests__/tripwire.test.ts:292-337`

The vararg test at line 311 uses unregistered block type "Oscillator". Because the block type is unknown, `inputPorts` is empty, so `inputPorts.get('phase')` returns undefined, and the vararg connections are silently dropped. The test only checks `errors.toHaveLength(0)` and `osc.toBeDefined()` -- it never verifies that the data was actually deserialized.

**Verdict**: INSUFFICIENT -- a broken vararg implementation would pass this test.

**Fix needed**: Either use registered block types or verify that `osc.inputPorts.get('phase')?.varargConnections` exists and has the correct data. The separate serialize test at `serialize.test.ts:207-225` does verify vararg serialization works, and there are integration round-trip tests that pass, so the implementation is correct -- the tripwire test just doesn't guard it properly.

### Weak Recovery Test
`src/patch-dsl/__tests__/tripwire.test.ts:339-363`

The test claims to verify recovery but only checks `blocks.length > 0` and comments "this is best-effort." In reality, the "good" block is never recovered. The test passes but doesn't test what it claims to test.

## Missing Checks (implementer should create)

1. **Lens round-trip test with registered blocks**: `src/patch-dsl/__tests__/tripwire.test.ts` -- add test that builds a Patch with lens attachments via PatchBuilder, serializes to HCL, deserializes back, and verifies lens data is preserved on the port.

2. **Vararg tripwire test with registered blocks**: Fix `tripwire.test.ts` vararg test to use a registered block type (like "Array") and verify `varargConnections` array contents after deserialization.

3. **Port override tripwire test with registered blocks**: Fix `tripwire.test.ts` port override test to use a registered block type (like "Phasor") and verify `combineMode` and `defaultSource` after deserialization.

## Verdict: INCOMPLETE

AC3 is partially met -- vararg and port-override round-trip works, but lens deserialization is explicitly stubbed with a TODO. The code at `patch-from-ast.ts:247` drops lens data with a warning.

## What Needs to Change

1. `src/patch-dsl/patch-from-ast.ts:227-248` -- Lens deserialization is stubbed with TODO. Must implement actual lens attachment to the correct port. The serializer already emits lens blocks correctly (serialize.ts:272-295), but the deserializer does not consume them.

2. `src/patch-dsl/__tests__/tripwire.test.ts:292-337` -- Vararg/port-override tripwire tests use unregistered block types. Must use registered types ("Array" for vararg, "Phasor" for port-override) and verify actual data on `inputPorts` after deserialization.

3. `src/patch-dsl/__tests__/tripwire.test.ts:339-363` -- Recovery test is too weak. Either strengthen to verify the second block is recovered, or document explicitly that recovery of subsequent blocks is not guaranteed (and adjust the test name/description accordingly).
