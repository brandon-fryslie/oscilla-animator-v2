# Definition of Done: Numeric Topology IDs

**Bead**: oscilla-animator-v2-4h6
**Plan**: PLAN-20260122.md
**Created**: 2026-01-22
**Confidence**: HIGH (Well-defined, mechanical change)

## Summary

Topology IDs converted from string-based Map lookups to numeric array-indexed access. All shape system consumers updated. Renderer achieves O(1) topology dispatch.

## Acceptance Criteria

### 1. Type System Correctness

**Deliverable**: `TopologyId = number` throughout codebase

- [ ] `src/shapes/types.ts:16` defines `TopologyId` as `number`
- [ ] All imports of `TopologyId` compile without type errors
- [ ] No `as any` or type escape hatches for topology IDs
- [ ] `TopologyDef.id` field is `number` type
- [ ] `ShapeRef.topologyId` field uses `TopologyId` type (already `number`)
- [ ] Compiler IR types (`StepRender`, etc.) use numeric `TopologyId`

**Verification**: `npm run typecheck` succeeds with no errors

---

### 2. Registry Implementation

**Deliverable**: Array-based topology storage with O(1) lookup

- [ ] `TOPOLOGY_REGISTRY` is `TopologyDef[]` (not `Map`)
- [ ] Built-in topologies pre-assigned to indices 0 and 1
  - [ ] Ellipse → ID 0 (`TOPOLOGY_ID_ELLIPSE`)
  - [ ] Rect → ID 1 (`TOPOLOGY_ID_RECT`)
- [ ] Dynamic topologies auto-assigned IDs starting at 100
- [ ] `getTopology(id: number)` performs array index `TOPOLOGY_REGISTRY[id]`
- [ ] `getTopology()` throws on invalid ID (negative, out of bounds, undefined slot)
- [ ] `hasTopology(id)` checks array bounds and slot occupancy
- [ ] `getAllTopologyIds()` returns array of assigned numeric IDs

**Verification**: Registry tests pass (see Test Coverage section)

---

### 3. Dynamic Topology Registration

**Deliverable**: `registerDynamicTopology()` assigns and returns numeric ID

- [ ] Function signature: `registerDynamicTopology(topology: Omit<TopologyDef, 'id'>, debugName?: string): TopologyId`
- [ ] Returns assigned numeric ID to caller
- [ ] ID assignment is sequential starting from 100
- [ ] Debug name mapping stored in `TOPOLOGY_BY_NAME` map (optional feature)
- [ ] No ID collisions (sequential counter guarantees uniqueness)

**Verification**: Dynamic registration test passes (see Test Coverage)

---

### 4. Block System Integration

**Deliverable**: Path blocks handle numeric topology IDs

- [ ] `createPolygonTopology()` omits `id` field (assigned by registry)
- [ ] `ProceduralPolygon` block lowering calls `registerDynamicTopology()` and stores returned ID
- [ ] Block lowering passes numeric ID to compiler IR (not string)
- [ ] All blocks using `registerDynamicTopology()` updated (only path-blocks.ts per grep)

**Verification**: Block integration test passes (polygon registration returns numeric ID)

---

### 5. Compiler IR Updates

**Deliverable**: IR types and builders use numeric topology IDs

- [ ] `src/compiler/ir/types.ts` imports `TopologyId` (type change propagates)
- [ ] `src/compiler/ir/IRBuilderImpl.ts` handles numeric IDs (no string manipulation)
- [ ] `src/compiler/ir/IRBuilder.ts` type-checks correctly
- [ ] `src/compiler/passes-v2/pass7-schedule.ts` compiles without errors
- [ ] No hardcoded string topology IDs in compiler code

**Verification**: Full compilation of example patch with polygons succeeds

---

### 6. Runtime Assembly

**Deliverable**: RenderAssembler resolves numeric topology IDs

- [ ] `src/runtime/RenderAssembler.ts` calls `getTopology(numericId)`
- [ ] `ResolvedShape` type (if embedding topology ID) uses `number`
- [ ] No string concatenation or manipulation of topology IDs in assembly
- [ ] Runtime state does not cache topology lookups incorrectly

**Verification**: RenderAssembler tests pass with numeric IDs

---

### 7. Renderer Updates

**Deliverable**: Canvas2DRenderer dispatches on numeric topology IDs

- [ ] `src/render/Canvas2DRenderer.ts` calls `getTopology(id: number)`
- [ ] No switch statements on string topology IDs
- [ ] Topology dispatch uses array-indexed lookup (follows registry change)
- [ ] `future-types.ts` already defines numeric `topologyId` (no conflict)

**Verification**: Renderer integration test passes (see Test Coverage)

---

### 8. Test Coverage

**Deliverable**: Comprehensive tests for numeric ID system

**Registry Tests** (`src/shapes/__tests__/registry.test.ts`):
- [ ] Built-in topologies have correct reserved IDs (0, 1)
- [ ] Dynamic registration assigns IDs starting at 100
- [ ] Sequential ID assignment (no gaps, no collisions)
- [ ] `getTopology()` throws on invalid ID
- [ ] `hasTopology()` returns false for out-of-bounds ID
- [ ] `getTopologyIdByName()` debug helper works correctly

**Block Tests** (`src/blocks/__tests__/path-blocks.test.ts`):
- [ ] `createPolygonTopology()` + `registerDynamicTopology()` returns numeric ID
- [ ] Registered polygon topology retrievable via numeric ID

**Renderer Tests** (`src/render/__tests__/Canvas2DRenderer.test.ts`):
- [ ] Renders ellipse using `TOPOLOGY_ID_ELLIPSE` (numeric)
- [ ] Renders rect using `TOPOLOGY_ID_RECT` (numeric)
- [ ] Renders dynamic polygon using returned numeric ID

**All Existing Tests**:
- [ ] `npm run test` succeeds with no failures
- [ ] No tests broken by type change

**Verification**: `npm run test` passes all tests

---

### 9. Debug Experience

**Deliverable**: Numeric IDs don't degrade debugging

- [ ] `TOPOLOGY_BY_NAME` map available for reverse lookup (name → ID)
- [ ] `getTopologyIdByName(name: string)` function exported
- [ ] Error messages include both numeric ID and name when available
  - Example: `"Unknown topology ID: 5 (expected 'polygon-5')"`
- [ ] Topology constants exported for readability in code:
  - `export const TOPOLOGY_ID_ELLIPSE = 0;`
  - `export const TOPOLOGY_ID_RECT = 1;`

**Verification**: Log topology registry during manual testing; verify names are visible

---

### 10. Performance Validation

**Deliverable**: Lookup performance improves (or is neutral)

- [ ] Microbenchmark: 1M topology lookups complete in <100ms
- [ ] No frame time regression for 10k polygon instances
- [ ] Topology lookup is O(1) (verified via implementation - array index)

**Verification**: Run performance test (see PLAN-20260122.md Phase 8)

**Note**: Performance gain is a bonus, not a requirement. Primary goal is consistency with slot-addressed philosophy.

---

### 11. Code Quality

**Deliverable**: Clean, maintainable implementation

- [ ] No type escape hatches (`as any`, `@ts-ignore`)
- [ ] No string manipulation of topology IDs anywhere
- [ ] Registry bounds checking prevents undefined array access
- [ ] ID allocation strategy documented in code comments
- [ ] Future migration path documented (serialization, multi-module topologies)

**Verification**: Code review checklist

---

### 12. Manual Verification

**Deliverable**: Visual confirmation of correct rendering

- [ ] Load dev server with example patch containing:
  - Ellipse instances
  - Rect instances
  - Pentagon (polygon-5)
  - Heptagon (polygon-7)
- [ ] All shapes render correctly (no visual regressions)
- [ ] Console logs show numeric topology IDs (not strings)
- [ ] Hot swap: Change polygon sides, verify new topology ID assigned
- [ ] Dev tools: Inspect `TOPOLOGY_REGISTRY` array, verify structure

**Verification**: Manual testing session with visual inspection

---

## Exit Criteria

This work is **COMPLETE** when:

1. All acceptance criteria checkboxes are checked
2. `npm run typecheck` succeeds
3. `npm run test` succeeds
4. Manual verification session confirms visual correctness
5. Code review approved (if applicable)

## Non-Goals (Explicitly Out of Scope)

- **Serialization**: Not addressing persistence of numeric IDs (defer to future work)
- **Multi-module topologies**: Not addressing cross-module ID allocation
- **Topology versioning**: Not implementing migration paths for topology definition changes
- **Renderer performance tuning**: Only validating no regression, not optimizing beyond lookup change
- **Dynamic topology unregistration**: Not supporting removal of registered topologies (YAGNI)

## Known Limitations

- Array may be sparse (gaps between built-in and dynamic IDs)
- No compaction strategy (dynamic IDs monotonically increase)
- Debug name mapping is best-effort (not required for correctness)

## Rollback Plan

If critical issues discovered:

1. Revert single atomic commit (type change + all consumers)
2. String-based system restored
3. No partial migration state (type system enforces completeness)

**Risk**: Low - type system enforces exhaustive updates, tests validate correctness.

## Success Metrics

- **Type Safety**: 100% of topology ID usage is type-safe `number`
- **Test Coverage**: All new registry functions covered by unit tests
- **Performance**: Lookup microbenchmark ≥ baseline (no regression)
- **Code Quality**: Zero type escape hatches, zero string ID manipulation

## Sign-Off

This DoD will be considered **PASSED** when:

- All checkboxes marked complete
- Test suite passes
- Manual verification completed
- Performance validation shows no regression
- Code review approved (if required by project policy)

**Confidence Level**: HIGH (mechanical type change, comprehensive tests, type system enforces correctness)
