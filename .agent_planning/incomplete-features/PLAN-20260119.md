# Incomplete Feature Implementations - Analysis and Plan

**Created:** 2026-01-19
**Source:** Audit Finding 6 (P2)
**Status:** PLANNING

---

## Executive Summary

This plan addresses multiple TODO comments indicating incomplete implementations across the codebase. After analysis, these TODOs fall into four categories:

1. **Sprint 3 Continuity Items** - Deferred per roadmap, crossfade already tracked
2. **State Management Stubs** - Part of existing `compilation-pipeline` bead
3. **Layout Variants** - Not needed now, outdated TODO
4. **Diagnostic Validators** - Sprint 2 items, already documented

**Recommendation:** NO NEW BEADS NEEDED. The existing tracking is adequate. Actions:
- Add detail to existing beads
- Remove/update misleading TODOs
- Document decisions

---

## Category Analysis

### 1. Runtime/Continuity (Sprint 3) TODOs

**Files:**
- `src/runtime/ScheduleExecutor.ts:237` - domain change detection and mapping
- `src/runtime/ScheduleExecutor.ts:244` - gauge/slew application
- `src/runtime/ContinuityApply.ts:312` - crossfade for unmappable cases

**Analysis:**

The continuity system is documented in ROADMAP.md with `continuity-crossfade` already PROPOSED in Phase 1. The Schedule Executor cases are stubs that exist for exhaustive switch handling. The spec reference Â§3.7 refers to field projection policies.

Looking at the actual code:
- `continuityMapBuild` and `continuityApply` step kinds exist in the schedule
- These are SKIPPED by design - they are placeholders for Sprint 3 work
- `ContinuityApply.ts` crossfade case has a passthrough implementation

**Status:** APPROPRIATELY DEFERRED

The roadmap already tracks this:
```
#### ðŸ’¡ continuity-crossfade [PROPOSED]
- **Spec:** design-docs/CANONICAL-oscilla-v2.5-20260109/topics/11-continuity-system.md Â§3.7
```

**Action:** No change needed. When continuity-crossfade sprint is planned, it will address all three TODOs together.

---

### 2. State Management Stubs (IRBuilder)

**Files:**
- `src/compiler/ir/IRBuilderImpl.ts:614` - timepoint markers
- `src/compiler/ir/IRBuilderImpl.ts:626` - state declaration
- `src/compiler/ir/IRBuilderImpl.ts:630` - state reading
- `src/compiler/ir/IRBuilderImpl.ts:636` - state writing

**Analysis:**

These methods exist in the IRBuilder interface but have stub implementations:
- `getTimepointMarkers()` returns null
- `declareState()` is empty
- `readState()` returns a dummy const
- `writeState()` is empty

These are part of the **compilation-pipeline** epic (Phase 1 P3), specifically related to:
- State management for stateful blocks
- UnitDelay implementation (in primitives-catalog)
- Per-spec state migration (I3 invariant: StateId stability)

**Existing Tracking:**
- `oscilla-animator-v2-k0v`: compilation-pipeline [in_progress] P1
- `oscilla-animator-v2-1hi`: primitives-catalog [open] P3 (includes UnitDelay)

**Status:** COVERED BY EXISTING BEADS

The primitives-catalog sprint specifically calls out UnitDelay, which requires state read/write. When that sprint is implemented, these stubs will be completed.

**Action:** Update the `compilation-pipeline` bead description to note state management APIs are stubs pending primitives-catalog sprint.

---

### 3. Materializer Incomplete Layouts

**File:**
- `src/runtime/Materializer.ts:466` - "Implement other layouts (circular, linear, etc.)"

**Analysis:**

Reading the actual code at that line, there is NO such TODO. The line numbers have shifted, and the current Materializer has:
- Grid layout âœ…
- Circular layout âœ…
- Linear layout âœ…
- Unordered layout âœ…

The TODO in the audit references an OLD version of the code. The layouts are now implemented in `fillBufferIntrinsic()` for the `position` and `radius` intrinsics.

**Status:** STALE TODO - ALREADY IMPLEMENTED

**Action:** The TODO doesn't exist anymore. No action needed.

---

### 4. Diagnostic Validators (Commented Out)

**Files:**
- `src/diagnostics/validators/authoringValidators.ts:143` - disconnected block detection
- `src/diagnostics/validators/authoringValidators.ts:152` - unused output detection

**Analysis:**

These are COMMENTED OUT functions with `// Sprint 2+: Not implemented yet` annotation. They are explicitly documented as future work.

From `ROADMAP.md`:
```
#### âœ… diagnostics-system [COMPLETED (Sprint 1)]
- **Sprint 2 Planned:** Runtime diagnostics (NaN/performance monitoring), bus warnings, quick fixes, UI badges
```

The validators are part of diagnostics Sprint 2, not Sprint 1 (which is complete).

**Status:** APPROPRIATELY DEFERRED TO SPRINT 2

**Action:** No new tracking needed. These are documented in the roadmap as Sprint 2 scope.

---

## Summary of Actions

| Category | Status | Action |
|----------|--------|--------|
| Continuity (Sprint 3) | Tracked in roadmap | None |
| State management | Covered by existing beads | Update bead description |
| Layout variants | Already implemented | None (stale audit) |
| Diagnostic validators | Sprint 2 scope | None |

---

## Recommended Bead Updates

### Update: compilation-pipeline (oscilla-animator-v2-k0v)

Add note:
```
Note: State management APIs (declareState, readState, writeState, getTimepointMarkers)
in IRBuilderImpl.ts are stubs. Will be completed when primitives-catalog implements
stateful blocks (UnitDelay).
```

**Command:**
```bash
bd update oscilla-animator-v2-k0v --description "Passes 5-10: execution class, tables, schedule, slots, debug. Note: State APIs in IRBuilderImpl are stubs pending primitives-catalog (UnitDelay)." --json
```

---

## Decision: No New Beads

Creating beads for each TODO would:
1. Duplicate existing tracking (compilation-pipeline, primitives-catalog, roadmap)
2. Fragment related work across multiple items
3. Create unnecessary overhead

The current tracking is adequate:
- Roadmap has continuity-crossfade PROPOSED
- Roadmap has diagnostics Sprint 2 scope
- Beads have compilation-pipeline and primitives-catalog
- Sprint labeling in TODOs provides context

---

## Appendix: TODO Audit Accuracy

The audit referenced line numbers that have shifted. Actual current state:

| Audit Line | Actual Line | Status |
|------------|-------------|--------|
| ScheduleExecutor.ts:237 | ~237 | Accurate |
| ScheduleExecutor.ts:244 | ~244 | Accurate |
| ContinuityApply.ts:312 | ~312 | Accurate |
| Materializer.ts:466 | N/A | Layout TODO removed, layouts implemented |
| IRBuilderImpl.ts:654 | ~614 | Line shifted |
| IRBuilderImpl.ts:666-676 | ~626-637 | Line shifted |
| authoringValidators.ts:143 | ~143 | Accurate |
| authoringValidators.ts:152 | ~152 | Accurate |

---

## Conclusion

This audit finding is **low priority** because:
1. All items are already tracked or appropriately deferred
2. One item (layouts) is already implemented
3. Sprint labels in TODOs indicate intentional deferral
4. Roadmap and beads cover the scope

**No implementation work required.** The recommended action is a minor bead description update for documentation purposes.
