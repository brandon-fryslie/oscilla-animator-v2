# EVALUATION: Reusable Graph Editor Refactor

**Generated:** 2026-01-27-120000
**Topic:** Refactor ReactFlow editor to be reusable for both main patch and composite editor
**Status:** INITIAL EVALUATION

## Executive Summary

The codebase currently has **two separate graph editor implementations**:
1. **ReactFlowEditor** (`src/ui/reactFlowEditor/`) - Full-featured main patch editor
2. **CompositeInternalGraph** (`src/ui/components/CompositeInternalGraph.tsx`) - Simplified composite editor

This violates the "ONE TYPE PER BEHAVIOR" architectural law. Both implementations render ReactFlow graphs with blocks, edges, type-colored ports, and drag/drop support, but CompositeInternalGraph has a significantly reduced feature set that will need to be maintained in parallel.

## Current State Analysis

### ReactFlowEditor (Main Editor) - Feature Complete

**Location:** `src/ui/reactFlowEditor/`

**Components:**
- `ReactFlowEditor.tsx` (654 lines) - Main orchestration component
- `OscillaNode.tsx` (429 lines) - Custom node with full features
- `sync.ts` (502 lines) - Bidirectional sync with PatchStore
- `nodes.ts` (371 lines) - Node/edge data transformation
- `typeValidation.ts` (313 lines) - Type compatibility checking
- `ParameterControls.tsx` (378 lines) - Inline param editing
- `layout.ts` - ELK auto-layout
- `PortInfoPopover.tsx` - Port hover details
- `menus/BlockContextMenu.tsx` - Block right-click menu
- `menus/EdgeContextMenu.tsx` - Edge right-click menu
- `menus/PortContextMenu.tsx` (413 lines) - Port right-click menu with quick connect

**Features:**
- [x] Type-colored port handles
- [x] Type tooltips on hover
- [x] Port connection validation
- [x] Inline parameter editing (sliders, checkboxes, dropdowns)
- [x] Default source value editing on nodes
- [x] DisplayName inline editing (double-click)
- [x] Port info popover on hover
- [x] Context menus (block, edge, port)
- [x] Quick connect suggestions
- [x] Combine mode cycling
- [x] Add compatible block from context menu
- [x] MobX reaction sync with PatchStore
- [x] LayoutStore position persistence
- [x] ELK auto-arrange layout
- [x] Non-contributing edge dimming
- [x] Adapter edge labels
- [x] Port highlight on hover (compatible ports glow)
- [x] Edge hover debug values
- [x] Selection sync with SelectionStore
- [x] MiniMap, Controls, Background

### CompositeInternalGraph (Composite Editor) - Minimal

**Location:** `src/ui/components/CompositeInternalGraph.tsx` (512 lines)

**Features:**
- [x] Type-colored port handles
- [x] Type tooltips
- [x] Basic connection validation
- [x] MobX reaction sync with CompositeEditorStore
- [x] Basic drag/drop block addition
- [x] MiniMap, Controls, Background
- [ ] Inline parameter editing - MISSING
- [ ] Default source value editing - MISSING
- [ ] DisplayName editing - MISSING
- [ ] Port info popover - MISSING
- [ ] Context menus - MISSING
- [ ] Quick connect - MISSING
- [ ] Combine mode - MISSING
- [ ] ELK auto-arrange - MISSING
- [ ] Non-contributing edge dimming - MISSING
- [ ] Port highlight - MISSING
- [ ] Edge hover debug - MISSING

### Key Differences in Data Models

| Aspect | ReactFlowEditor | CompositeInternalGraph |
|--------|-----------------|------------------------|
| Store | PatchStore | CompositeEditorStore |
| Block ID type | `BlockId` | `InternalBlockId` |
| Edge storage | `Edge[]` on PatchStore | `InternalEdge[]` on store |
| Block storage | `Map<BlockId, Block>` | `Map<InternalBlockId, InternalBlockState>` |
| Position storage | LayoutStore | In-place on InternalBlockState |
| Node data | `OscillaNodeData` | `InternalNodeData` |

### Store Interfaces

**PatchStore Actions Used by ReactFlowEditor:**
```typescript
addBlock(type, params, options): BlockId
removeBlock(id: BlockId)
updateBlockParams(id, params)
updateBlockDisplayName(id, displayName)
updateInputPort(blockId, portId, updates)
updateInputPortCombineMode(blockId, portId, combineMode)
addEdge(from, to, options): string
removeEdge(id)
```

**CompositeEditorStore Actions:**
```typescript
addBlock(type, position): InternalBlockId
removeBlock(id: InternalBlockId)
updateBlockPosition(id, position)
addEdge(edge: InternalEdge)
removeEdge(fromBlock, fromPort, toBlock, toPort)
exposeInputPort(...)
unexposeInputPort(...)
exposeOutputPort(...)
unexposeOutputPort(...)
```

## Gap Analysis

### Critical Gaps

1. **No Abstraction Layer**
   - ReactFlowEditor is hardcoded to PatchStore
   - CompositeInternalGraph is hardcoded to CompositeEditorStore
   - No shared interface for "graph data source"

2. **Duplicated Type Validation**
   - `typeValidation.ts` used by ReactFlowEditor
   - `CompositeInternalGraph` reimplements `validateInternalConnection()`

3. **Duplicated Node Creation**
   - `nodes.ts` creates `OscillaNodeData`
   - `CompositeInternalGraph` has inline `createNodeFromInternalBlock()`

4. **Duplicated Node Rendering**
   - `OscillaNode.tsx` - full featured
   - `InternalBlockNode` - inline in CompositeInternalGraph, minimal

5. **No Multi-Patch Support**
   - PatchStore is singleton in RootStore
   - No concept of "active patch" or "multiple patches open"

### Feature Parity Gaps (CompositeInternalGraph Missing)

| Feature | Priority | Complexity |
|---------|----------|------------|
| Inline parameter editing | P0 | Medium |
| Default source editing | P1 | Medium |
| DisplayName editing | P1 | Low |
| Port info popover | P2 | Low |
| Context menus | P1 | Medium |
| ELK auto-arrange | P2 | Low (reuse) |
| Non-contributing edge dimming | P2 | Low (reuse) |
| Port highlight | P2 | Low (reuse) |
| Debug edge values | P3 | Medium |

## Architectural Options

### Option A: Adapter Pattern (Recommended)

Create a `GraphDataAdapter` interface that both PatchStore and CompositeEditorStore implement:

```typescript
interface GraphDataAdapter<BlockIdT, EdgeT> {
  readonly blocks: ReadonlyMap<BlockIdT, BlockLike>;
  readonly edges: readonly EdgeLike[];

  addBlock(type: string, position?: XY): BlockIdT;
  removeBlock(id: BlockIdT): void;
  updateBlockPosition(id: BlockIdT, position: XY): void;
  addEdge(from: Endpoint, to: Endpoint): string;
  removeEdge(id: string): void;

  // For param editing (optional - composite may not need)
  updateBlockParams?(id: BlockIdT, params: Record<string, unknown>): void;
}
```

**Pros:**
- Clean separation
- Both stores keep their domain-specific logic
- Editor becomes truly reusable

**Cons:**
- Requires implementing adapter on both stores
- Some features may need conditional behavior

### Option B: Unified Store Layer

Create a new `GraphEditorStore` that wraps both PatchStore and CompositeEditorStore:

```typescript
class GraphEditorStore {
  constructor(
    mode: 'patch' | 'composite',
    patchStore?: PatchStore,
    compositeStore?: CompositeEditorStore
  )
}
```

**Pros:**
- Single store interface
- Easier to add editor-specific state (selection, hover)

**Cons:**
- Another layer of abstraction
- Mode-switching complexity

### Option C: Props-Based Injection (Simplest)

Pass all graph operations as props/callbacks to the unified editor:

```typescript
interface UnifiedGraphEditorProps {
  nodes: Node[];
  edges: Edge[];
  onNodesChange: OnNodesChange;
  onEdgesChange: OnEdgesChange;
  onConnect: OnConnect;
  // ... all callbacks
}
```

**Pros:**
- Lowest coupling
- Works immediately

**Cons:**
- Many props to manage
- Parent components become complex

## Recommendation

**Option A (Adapter Pattern)** is the right choice because:

1. Follows "ONE TYPE PER BEHAVIOR" - one editor type, multiple data sources
2. Follows "SINGLE ENFORCER" - editor owns rendering, stores own persistence
3. Allows gradual migration - CompositeInternalGraph can be replaced incrementally
4. Supports future use cases (subgraph editing, clipboard patches, etc.)

## Implementation Approach

### Phase 1: Extract Reusable Components
1. Create `UnifiedGraphNode` component from `OscillaNode` with data adapter
2. Extract `GraphEditorCore` from `ReactFlowEditor` with adapter interface
3. Keep existing components working during transition

### Phase 2: Define Adapter Interface
1. Define `GraphDataAdapter` interface
2. Create `PatchStoreAdapter` implementing the interface
3. Create `CompositeStoreAdapter` implementing the interface

### Phase 3: Migrate Editors
1. Update `ReactFlowEditor` to use `GraphEditorCore` + `PatchStoreAdapter`
2. Replace `CompositeInternalGraph` with `GraphEditorCore` + `CompositeStoreAdapter`
3. Remove duplicated code

### Phase 4: Multi-Patch Support (Future)
1. Add `PatchRegistry` for multiple open patches
2. Add `ActivePatchContext` for switching
3. Tab-based UI for patch switching

## Quantitative Metrics

| Metric | Current | Target |
|--------|---------|--------|
| Duplicated LOC | ~600 | 0 |
| Node components | 2 | 1 |
| Sync implementations | 2 | 1 (parameterized) |
| Type validation implementations | 2 | 1 |
| Feature parity gap | 12 features | 0 |

## Risk Assessment

### High Risk
- **Breaking PatchStore sync** - ReactFlowEditor sync is complex with position persistence, MobX reactions, and reconciliation. Refactoring must preserve this exactly.

### Medium Risk
- **Performance regression** - Adding abstraction layer could add overhead in hot paths (node/edge rendering). Need benchmarking.

### Low Risk
- **CompositeEditorStore changes** - Store is simpler and less coupled.

## Dependencies

- None external
- Internal: PatchStore, CompositeEditorStore, LayoutStore, SelectionStore, PortHighlightStore

## Test Coverage Requirements

1. Unit tests for GraphDataAdapter implementations
2. Integration tests for editor with both adapters
3. E2E tests for composite editor with full features
4. Performance benchmarks comparing before/after

## Files to Modify

### Create
- `src/ui/graphEditor/types.ts` - Adapter interface
- `src/ui/graphEditor/PatchStoreAdapter.ts`
- `src/ui/graphEditor/CompositeStoreAdapter.ts`
- `src/ui/graphEditor/GraphEditorCore.tsx`
- `src/ui/graphEditor/UnifiedNode.tsx`
- `src/ui/graphEditor/index.ts`

### Modify
- `src/ui/reactFlowEditor/ReactFlowEditor.tsx` - Refactor to use core
- `src/ui/components/CompositeEditor.tsx` - Replace CompositeInternalGraph
- `src/stores/CompositeEditorStore.ts` - May need minor API adjustments

### Delete
- `src/ui/components/CompositeInternalGraph.tsx` - After migration
