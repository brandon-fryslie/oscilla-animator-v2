# Work Evaluation - 2026-01-27T05:28:09

Scope: work/deprecated-removal-sprint
Confidence: FRESH

## Goals Under Evaluation

From SPRINT-20260127-120000-deprecated-removal-DOD.md:

### Code Quality
1. [ ] No `@deprecated` comments remain in production code
2. [ ] No TypeScript errors or warnings
3. [ ] All tests pass (`npm run test`)
4. [ ] Build succeeds (`npm run build`)

### Specific Removals
5. [ ] `NumericUnit` type alias removed
6. [ ] `PAYLOAD_STRIDE` constant removed
7. [ ] `getStateSlots()` method removed
8. [ ] `CompileError.kind`, `.location`, `.severity` fields removed
9. [ ] `createRuntimeState()` function removed (or retained with justification)
10. [ ] `TypeEnv` type alias and related removed

### Migration Verification
11. [ ] diagnosticConversion.ts uses `error.code` (not `error.kind`)
12. [ ] pass7-schedule.ts uses `getStateMappings()`
13. [ ] All typecheck() calls use TypeCheckContext

## Previous Evaluation Reference

Last evaluation: EVALUATION-20260127-120000.md
| Previous Issue | Status Now |
|----------------|------------|
| Items identified for removal | PARTIALLY ADDRESSED |

## Persistent Check Results

| Check | Status | Output Summary |
|-------|--------|----------------|
| `grep @deprecated` | PASS | No @deprecated found in src/ |
| `npm run typecheck` | FAIL | 28 TypeScript errors |
| `npm run test` | FAIL | 100 tests failed (1550 passed) |
| `npm run build` | FAIL | TypeScript errors block build |

## Critical Finding: Uncommitted Breaking Changes

The working directory contains unstaged changes that break the build:
- `src/runtime/RuntimeState.ts` - partial refactor
- `src/blocks/__tests__/event-blocks.test.ts` - incomplete migration
- `src/blocks/__tests__/stateful-primitives.test.ts` - incomplete migration
- `src/__tests__/runtime-test-helpers.ts` - incomplete migration

**Even the committed code (HEAD) has TypeScript errors** - the sprint was committed with broken tests.

## Specific Removals Verification

| Item | DoD Target | Actual Status |
|------|------------|---------------|
| `NumericUnit` | Removed | **PARTIAL** - Comment still references it (line 11 canonical-types.ts) |
| `PAYLOAD_STRIDE` | Removed | **PASS** - Removed from canonical-types.ts and types/index.ts |
| `getStateSlots()` | Removed | **PASS** - Removed from IRBuilder*.ts |
| `CompileError.kind` | Removed | **FAIL** - Still used in diagnosticConversion.ts (line 109, 115, 119) |
| `CompileError.location` | Removed | **PASS** - Not found in code |
| `CompileError.severity` | Removed | **PASS** - Not found in code |
| `createRuntimeState()` | Removed or Retained | **BROKEN** - Function exists in HEAD, but index.ts exports it while implementation was removed in unstaged changes |
| `TypeEnv` | Removed | **FAIL** - Still exists at typecheck.ts:42, 62 |
| `isTypeEnv()` | Removed | **PASS** - Not found |

## Migration Verification

| Migration Point | Expected | Actual | Status |
|-----------------|----------|--------|--------|
| diagnosticConversion.ts uses error.code | Uses error.code | Still uses error.kind (line 109) | **FAIL** |
| pass7-schedule.ts uses getStateMappings() | Uses getStateMappings() | Uses getStateMappings() (line 550) | **PASS** |
| typecheck() uses TypeCheckContext | TypeCheckContext only | TypeEnv still in TypeCheckContext interface | **FAIL** |

## Root Cause Analysis

The sprint implementation was **INCOMPLETE**:

1. **Commit 7017912** ("docs(planning): Document completed legacy cleanup") claims completion but the code has TypeScript errors
2. **Test files** were modified to use new patterns but imports were not properly updated
3. **TypeEnv** was NOT removed despite being in the DoD
4. **diagnosticConversion.ts** still uses `error.kind` instead of `error.code`
5. **Working directory** has further uncommitted changes that compound the breakage

### Error Pattern Analysis

The 100 test failures all trace to:
```
TypeError: createRuntimeState is not a function
```

This happens because:
1. `src/runtime/index.ts` exports `createRuntimeState`
2. `src/runtime/RuntimeState.ts` (in working directory) removed the function
3. Many test files import and use `createRuntimeState`

## Evidence

### TypeScript Errors (committed code - via git stash test)
```
src/blocks/__tests__/event-blocks.test.ts(71,27): error TS2345: 
  Argument of type '{ values: ValueStore; ... }' is not assignable to parameter of type 'RuntimeState'.
  Property 'externalChannels' is missing...

src/blocks/__tests__/stateful-primitives.test.ts(100,19): error TS2304: 
  Cannot find name 'createRuntimeState'.
```

### diagnosticConversion.ts still uses error.kind
```typescript
// Line 109:
const code = ERROR_KIND_TO_CODE[error.kind] || 'E_UNKNOWN_BLOCK_TYPE';
// Line 115:
const title = formatTitle(error.kind);
// Line 119:
const id = generateDiagnosticId(code, primaryTarget, patchRevision, error.kind);
```

### TypeEnv still exists
```typescript
// typecheck.ts:42
export type TypeEnv = ReadonlyMap<string, PayloadType>;
// typecheck.ts:62
readonly inputs: TypeEnv;
```

## Assessment

### ✅ Working
- NumericUnit type alias definition removed
- PAYLOAD_STRIDE constant removed from both locations
- getStateSlots() method removed
- pass7-schedule.ts correctly uses getStateMappings()

### ❌ Not Working
- **TypeScript compilation fails** (28 errors)
- **100 tests fail** (createRuntimeState not found)
- **Build fails** (blocked by TypeScript errors)
- diagnosticConversion.ts still uses legacy error.kind
- TypeEnv still exists in typecheck.ts
- Test files have incorrect imports/usage patterns

### ⚠️ Ambiguities Found

| Decision | What Was Assumed | Should Have Asked | Impact |
|----------|------------------|-------------------|--------|
| createRuntimeState retention | "Convenience, not deprecated" | Is removal actually desired? The DoD says remove, but commit 7629637 says keep | High - tests expect it |
| Test migration pattern | Spread session + program | Should tests use createRuntimeStateFromSession? | High - type mismatches |

## Missing Checks (implementer should add)

1. **Pre-commit hook** or CI check: `npm run typecheck && npm run test` must pass before merge
2. **Import validation**: Ensure all imports resolve to existing exports

## Verdict: INCOMPLETE

The sprint claimed completion but:
1. TypeScript compilation fails
2. 100 tests fail
3. 3 DoD items are not met (TypeEnv, diagnosticConversion migration, build success)

## What Needs to Change

1. **src/runtime/RuntimeState.ts** - Decision needed: Either keep createRuntimeState() or properly remove it AND update all consumers
2. **src/runtime/index.ts:25** - Remove `createRuntimeState` export if function is removed, OR keep function
3. **src/__tests__/runtime-test-helpers.ts:14,101,127** - Update to use correct function (createRuntimeStateFromSession if createRuntimeState removed)
4. **src/blocks/__tests__/event-blocks.test.ts** - Fix state creation pattern and imports
5. **src/blocks/__tests__/stateful-primitives.test.ts** - Fix state creation pattern and imports
6. **src/expr/typecheck.ts:42,62** - Remove TypeEnv type alias as per DoD
7. **src/compiler/diagnosticConversion.ts:109,115,119** - Migrate from error.kind to error.code

## Questions Needing Answers

1. **createRuntimeState**: The DoD says remove it, but commit 7629637 explicitly kept it as "convenience, not deprecated". What is the actual intent?
   - Option A: Keep createRuntimeState (revert working directory changes, update DoD)
   - Option B: Remove createRuntimeState (complete the migration in all test files)

2. **Test state creation pattern**: What is the canonical pattern for tests?
   - Option A: `createRuntimeState(slotCount, ...)` (simple convenience)
   - Option B: `createSessionState()` + `createRuntimeStateFromSession(session, ...)` (production pattern)
   - Option C: `{ ...createSessionState(), ...createProgramState(...) }` (manual spread)

## Recommended Path Forward

1. **Restore git HEAD state** - discard uncommitted changes: `git checkout -- .`
2. **Make a decision** on createRuntimeState (keep or remove)
3. **Complete TypeEnv removal** - this was never done
4. **Complete diagnosticConversion.ts migration** - change error.kind to error.code
5. **Fix all test imports and patterns** - consistent state creation
6. **Verify** - `npm run typecheck && npm run test && npm run build` must all pass
7. **Re-commit** with passing CI
