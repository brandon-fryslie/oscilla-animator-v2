# Evaluation: Constraint-Based Unit Type Inference

Generated: 2026-01-24T16:50:00Z
Verdict: CONTINUE

## Problem Statement

The current branch introduced unit-aware type checking but has an incomplete inference system that causes 16 test failures. The root cause is a **half-implemented** unit inference:

1. **pass0** sometimes infers `resolvedUnit` from neighbors (but not exhaustively)
2. **pass2** assumes `resolvedUnit` exists, and if not, silently defaults to `scalar`
3. The silent fallback turns "inference missed a node" into "unit mismatch everywhere"

## The Correct Architecture (from spec doc)

Per `design-docs/_to_integrate/01-Units-and-Type-Inference.md`, the solution requires:

1. **Strict unit checking at edges** — no implicit conversion (already have this)
2. **Generic blocks adapt** — Const outputs become `float<deg>` when feeding Camera.tiltDeg
3. **No hacks** — no special-casing unit checks for generics
4. **Constraint solver** — resolve all polymorphic types or emit compile error
5. **No fallback** — unresolved polymorphic ports are hard errors, not `scalar` defaults

## Current State Analysis

### What Already Exists
- `pass0-polymorphic-types.ts` — bidirectional payload inference (partial unit inference)
- `pass1-default-sources.ts` — materializes default sources as explicit Const blocks
- `pass2-adapters.ts` — inserts adapters for type mismatches (including unit adapters)
- `pass3-indexing.ts` — normalizes to BlockIndex-based edges
- `pass2-types.ts` (compiler) — validates type compatibility, enforces strictness
- Adapter registry with 10 unit-conversion adapters
- `BlockPayloadMetadata` — declares allowed payloads per port

### What's Missing
1. **UnitVar concept** — Const output is `float<scalar>` not `float<u>` where u is a variable
2. **Constraint gathering** — no explicit constraint collection from edges
3. **Unification solver** — no proper constraint propagation
4. **Hard error for unresolved** — falls back to `scalar` instead of erroring
5. **resolvedPortTypes cache** — types stored ad-hoc in `block.params`

### Files That Need Changes

| File | Change Type | Purpose |
|------|-------------|---------|
| `src/core/canonical-types.ts` | Add | `UnitVar` type for unresolved unit variables |
| `src/graph/passes/pass0-polymorphic-types.ts` | Replace | Become structural-only, defer type resolution |
| `src/graph/passes/pass0.5-type-constraints.ts` | **New** | Constraint solver for payload + unit |
| `src/compiler/passes-v2/pass2-types.ts` | Modify | Use resolved types cache, error on unresolved |
| `src/blocks/signal-blocks.ts` | Modify | Const output becomes `float<UnitVar>` |
| `src/blocks/registry.ts` | Add | `UnitMetadata` for allowed units per port |

## Test Impact

All 16 unit-mismatch failures will be fixed by proper constraint solving:
- `Const → FieldHueFromPhase.phase` will resolve to `float<phase01>`
- `Const → Camera.tiltDeg` will resolve to `float<deg>`
- Unconnected/unconstrained Const blocks will error with actionable diagnostic
