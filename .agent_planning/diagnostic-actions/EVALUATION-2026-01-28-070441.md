# Evaluation: Diagnostic Actions
Timestamp: 2026-01-28-070441
Git Commit: 92c7787

## Executive Summary
Overall: **5% complete** | Critical issues: 0 | Tests reliable: N/A (no tests exist)

**Status**: Infrastructure exists but feature is completely unimplemented. This is **by design** - explicitly deferred to Sprint 2 per spec and code comments.

## Runtime Check Results
| Check | Status | Output |
|-------|--------|--------|
| Type definition exists | ‚úÖ PASS | `src/diagnostics/types.ts:181-186` |
| Actions attached to diagnostics | ‚ùå FAIL | Zero diagnostics have actions property set |
| Action handler exists | ‚ùå FAIL | No execution/dispatch code found |
| Action UI components | ‚ùå FAIL | DiagnosticConsole shows no action buttons |
| Tests for actions | ‚ùå FAIL | Zero test files for action execution |

## Missing Checks
Since this feature is unimplemented, implementer should create these **persistent checks** during implementation:

1. **Type safety check**: TypeScript compilation ensures all 7 action kinds compile
2. **Unit tests**: Each action kind has execution tests (goToTarget, insertBlock, etc.)
3. **Integration tests**: End-to-end test that creates diagnostic with action, renders UI button, executes action
4. **Idempotency test**: Verify each action can be safely executed twice without error
5. **Undo/redo test**: Verify graph mutations from actions integrate with undo system

## Findings

### Type Definition (src/diagnostics/types.ts:171-186)
**Status**: STUB  
**Evidence**: 
- Lines 171-186: Generic placeholder interface with `id`, `label`, `kind: 'automated'|'guided'`, `payload?: unknown`
- Line 178: Explicit comment "Sprint 1: No actions implemented."
- Line 179: Explicit comment "Sprint 2+: Quick fixes like 'Insert Adapter', 'Add TimeRoot', etc."

**Issues**: 
- Current interface does NOT match spec's discriminated union (spec lines 368-379)
- Spec defines 7 specific action kinds with typed payloads
- Current code uses generic `payload?: unknown` instead of discriminated union

**Spec Definition** (design-docs/.../07-diagnostics-system.md:368-379):
```typescript
type DiagnosticAction =
  | { kind: 'goToTarget'; target: TargetRef }
  | { kind: 'insertBlock'; blockType: string; position?: 'before' | 'after'; nearBlockId?: string }
  | { kind: 'removeBlock'; blockId: string }
  | { kind: 'addAdapter'; fromPort: PortTargetRef; adapterType: string }
  | { kind: 'createTimeRoot'; timeRootKind: 'Infinite' }
  | { kind: 'muteDiagnostic'; diagnosticId: string }
  | { kind: 'openDocs'; docUrl: string };
```

**Gap**: Type definition needs complete rewrite to match spec.

---

### Action Attachment (Diagnostics Creation Sites)
**Status**: NOT_STARTED  
**Evidence**:
- `src/diagnostics/validators/authoringValidators.ts:87-102`: Creates `E_TIME_ROOT_MISSING` without actions
- `src/diagnostics/validators/authoringValidators.ts:115-130`: Creates `E_TIME_ROOT_MULTIPLE` without actions
- `src/compiler/diagnosticConversion.ts:173-189`: Converts compile errors to diagnostics without actions
- Grep for `actions?:` shows only type definitions, never actual array assignments

**Issues**: 
- No diagnostic creation site populates the `actions` array
- Diagnostic type has `actions?: readonly DiagnosticAction[]` (optional), always left undefined
- Even obvious candidates like `E_TIME_ROOT_MISSING` (which should offer "Add InfiniteTimeRoot" action) don't have actions

**Example Gap** - `E_TIME_ROOT_MISSING` diagnostic (authoringValidators.ts:87-102):
```typescript
return [{
  id,
  code: 'E_TIME_ROOT_MISSING',
  severity: 'error',
  domain: 'authoring',
  primaryTarget: target,
  title: 'No TimeRoot',
  message: 'Patch must have exactly one TimeRoot block. Add an InfiniteTimeRoot.',
  scope: { patchRevision },
  metadata: {
    firstSeenAt: Date.now(),
    lastSeenAt: Date.now(),
    occurrenceCount: 1,
  },
  // ‚ùå MISSING: actions array
}];
```

Should have:
```typescript
actions: [{
  kind: 'createTimeRoot',
  timeRootKind: 'Infinite'
}]
```

---

### Action Execution (Handler/Dispatcher)
**Status**: NOT_STARTED  
**Evidence**:
- Grep for `executeAction`, `applyAction`, `handleAction`: 0 results
- No files matching `*ActionExecutor*`, `*ActionHandler*`, `*QuickFix*`
- `src/stores/DiagnosticsStore.ts`: No action execution methods
- `src/stores/PatchStore.ts`: Has mutation methods (`addBlock:250`, `removeBlock:330`, `addEdge:897`, `removeEdge:929`) but no action dispatcher calls them

**Issues**:
- No central dispatch function to route action kinds to handlers
- Dependencies exist (PatchStore has all needed mutations) but no glue code
- No integration with undo/redo system
- Spec requirement (lines 835-854) for "Action Determinism Contract" completely unimplemented

**Required Architecture** (not present):
```typescript
// MISSING FILE: src/diagnostics/actionExecutor.ts
function executeAction(
  action: DiagnosticAction, 
  stores: { patch: PatchStore, selection: SelectionStore, ... }
): void {
  switch (action.kind) {
    case 'goToTarget':
      // Use SelectionStore to navigate
      break;
    case 'insertBlock':
      // Use PatchStore.addBlock()
      break;
    case 'removeBlock':
      // Use PatchStore.removeBlock()
      break;
    // ... 5 more cases
  }
}
```

---

### UI Components (Action Buttons)
**Status**: NOT_STARTED  
**Evidence**:
- `src/ui/components/app/DiagnosticConsole.tsx:276-310`: `DiagnosticRow` component renders diagnostic
- Lines 291-307: Displays icon, title, message, code, target - **no action buttons**
- Grep for "action" in DiagnosticConsole.tsx: Only matches `ToggleButton` (severity filter), no action buttons

**Current DiagnosticRow Layout** (lines 281-309):
```tsx
<div style={{ /* border, background */ }}>
  <div>
    <span>{icon}</span>
    <span>{diagnostic.title}</span>
    <span>{diagnostic.code}</span>
  </div>
  <div>{diagnostic.message}</div>
  <div>Target: {targetStr}</div>
  {/* ‚ùå MISSING: Action buttons */}
</div>
```

**Should Have**:
```tsx
{diagnostic.actions?.map(action => (
  <button onClick={() => executeAction(action)}>
    {action.label}
  </button>
))}
```

---

### Test Coverage
**Status**: NOT_STARTED  
**Evidence**:
- `npm test -- --listTests | grep -i action`: 0 results
- Existing diagnostic tests (`DiagnosticHub.test.ts`, `authoringValidators.test.ts`) never test actions
- No tests for action execution, idempotency, undo/redo integration

**Test Gaps**:
1. No unit tests for individual action kinds
2. No integration tests for action ‚Üí PatchStore mutation flow
3. No UI tests for action button rendering/clicking
4. No tests verifying Action Determinism Contract (spec requirement)

---

### Dependencies (Ready vs Missing)
**Status**: PARTIAL (infrastructure ready, glue code missing)  

| Component | Status | Location | Notes |
|-----------|--------|----------|-------|
| PatchStore mutations | ‚úÖ READY | `src/stores/PatchStore.ts` | `addBlock:250`, `removeBlock:330`, `addEdge:897`, `removeEdge:929` |
| SelectionStore | ‚úÖ READY | `src/stores/SelectionStore.ts` | For `goToTarget` action |
| EventHub | ‚úÖ READY | `src/events/EventHub.ts` | For emitting mutation events |
| DiagnosticsStore | ‚úÖ READY | `src/stores/DiagnosticsStore.ts` | MobX wrapper for UI |
| Action executor | ‚ùå MISSING | (needed) | Central dispatch function |
| Action UI buttons | ‚ùå MISSING | DiagnosticConsole.tsx | No buttons in DiagnosticRow |
| Undo/redo integration | ‚ùå MISSING | (needed) | Actions should be undoable |
| Action type definitions | ‚ö†Ô∏è WRONG | types.ts:181-186 | Generic stub, not spec's discriminated union |

---

## Ambiguities Found

| Area | Question | How LLM Guessed | Impact |
|------|----------|-----------------|--------|
| N/A | N/A | N/A | N/A |

**Note**: No ambiguities detected because feature is completely unimplemented. Spec is clear and explicit (lines 368-379, 835-854). No implementation exists to be ambiguous.

---

## Recommendations

### Priority 1: Type Definitions (1-2 hours)
1. Replace generic `DiagnosticAction` interface with spec's discriminated union
2. Define 7 action kinds with proper TypeScript typing:
   - `goToTarget` with `target: TargetRef`
   - `insertBlock` with `blockType: string`, `position?`, `nearBlockId?`
   - `removeBlock` with `blockId: string`
   - `addAdapter` with `fromPort: PortTargetRef`, `adapterType: string`
   - `createTimeRoot` with `timeRootKind: 'Infinite'`
   - `muteDiagnostic` with `diagnosticId: string`
   - `openDocs` with `docUrl: string`
3. Add `label` field to discriminated union (for UI button text)
4. Verify TypeScript compilation passes

**File**: `src/diagnostics/types.ts:171-186`  
**Test**: TypeScript compiler ensures all action kinds type-check

---

### Priority 2: Action Attachment (2-3 hours)
Attach actions to obvious diagnostic candidates:

1. **E_TIME_ROOT_MISSING** (authoringValidators.ts:87-102)
   ```typescript
   actions: [
     { kind: 'createTimeRoot', timeRootKind: 'Infinite', label: 'Add InfiniteTimeRoot' }
   ]
   ```

2. **W_GRAPH_DISCONNECTED_BLOCK** (authoringValidators.ts:133-155)
   ```typescript
   actions: [
     { kind: 'goToTarget', target: blockRef, label: 'Go to Block' },
     { kind: 'removeBlock', blockId, label: 'Remove Block' }
   ]
   ```

3. **Type mismatch errors** (diagnosticConversion.ts)
   ```typescript
   actions: [
     { kind: 'addAdapter', fromPort, adapterType: 'SignalToValue', label: 'Insert Adapter' }
   ]
   ```

**Test**: Unit tests verify diagnostics have actions array populated

---

### Priority 3: Action Executor (4-6 hours)
Create central dispatch mechanism:

1. New file: `src/diagnostics/actionExecutor.ts`
2. Implement `executeAction(action, stores)` with switch on `action.kind`
3. Route each action kind to appropriate PatchStore/SelectionStore method
4. Emit events via EventHub for graph mutations
5. Handle errors gracefully (e.g., blockId not found)

**Dependencies**: Requires Priority 1 (type definitions) complete  
**Test**: Unit tests for each action kind execution

---

### Priority 4: UI Components (3-4 hours)
Add action buttons to DiagnosticConsole:

1. Modify `DiagnosticRow` component (DiagnosticConsole.tsx:276-310)
2. Render action buttons when `diagnostic.actions` exists
3. Wire button `onClick` to action executor
4. Style buttons (primary for automated, secondary for guided)
5. Add loading/success/error states

**Test**: Integration test verifying button click executes action

---

### Priority 5: Undo/Redo Integration (2-3 hours)
Make actions undoable:

1. Investigate existing undo/redo system (if any)
2. Wrap action mutations in undo boundaries
3. Test undo after action execution restores state

**Blocker**: Depends on whether undo/redo exists (not verified in this evaluation)

---

### Priority 6: Test Coverage (4-6 hours)
Create comprehensive test suite:

1. Unit tests for each action kind execution
2. Integration tests for diagnostic ‚Üí action ‚Üí mutation flow
3. Idempotency tests (execute action twice, verify safe)
4. UI tests for button rendering/clicking
5. Action Determinism Contract tests (serialization, replay)

**Coverage Target**: 90%+ for action execution paths

---

## Blockers

**None identified**. All dependencies are ready:
- ‚úÖ PatchStore has mutation methods
- ‚úÖ SelectionStore exists for navigation
- ‚úÖ EventHub exists for event emission
- ‚úÖ UI framework (React/MobX) ready
- ‚úÖ Spec is clear and explicit

Only blocker is **time** - feature deliberately deferred to Sprint 2.

---

## Sprint Status Context

From `README.md` and code comments:
- **Sprint 1** ‚úÖ: Core types, EventHub, DiagnosticHub, authoring validators (complete)
- **Sprint 2** üöß: Runtime diagnostics, **DiagnosticAction implementation**, bus warnings (in progress)
- **Sprint 3** üîÆ: Grouping, export diagnostics, advanced UI (future)

Current implementation is **exactly where it should be** for Sprint 1. DiagnosticAction is a Sprint 2 feature, correctly deferred.

---

## Verdict

- [x] **CONTINUE** - No ambiguities, spec is clear, dependencies ready, implementer can proceed

**Rationale**: 
1. Feature is **deliberately unimplemented** (Sprint 2 scope)
2. Spec provides **explicit type definitions** (lines 368-379)
3. Spec provides **clear requirements** for determinism (lines 835-854)
4. **All dependencies exist** (PatchStore, SelectionStore, EventHub, UI)
5. **No blockers** - straightforward implementation path
6. **No ambiguity** - LLM has nothing to guess about

---

## Implementation Confidence

| Component | Confidence | Reason |
|-----------|------------|--------|
| Type definitions | **HIGH** | Spec provides exact TypeScript types |
| Action attachment | **HIGH** | Clear candidates (E_TIME_ROOT_MISSING, etc.) |
| Action executor | **MEDIUM** | Straightforward dispatch, but undo/redo unclear |
| UI components | **HIGH** | Standard React button rendering |
| Test coverage | **HIGH** | Standard unit/integration test patterns |
| **Overall** | **MEDIUM-HIGH** | Undo/redo integration is only uncertainty |

---

## Next Steps for Implementer

1. **Start with Priority 1** (type definitions) - defines contract for everything else
2. **Then Priority 2** (action attachment) - makes diagnostics actionable
3. **Then Priority 3** (action executor) - makes buttons functional
4. **Then Priority 4** (UI components) - surfaces functionality to users
5. **Check undo/redo** - if exists, integrate (Priority 5)
6. **Then Priority 6** (test coverage) - lock in correctness

**Estimated Total Effort**: 16-24 hours for full implementation + testing

---

## Evidence Summary

**Files Examined**:
- ‚úÖ `src/diagnostics/types.ts` (lines 171-186, 241, 280)
- ‚úÖ `src/diagnostics/validators/authoringValidators.ts` (lines 37-155)
- ‚úÖ `src/compiler/diagnosticConversion.ts` (lines 152-209)
- ‚úÖ `src/ui/components/app/DiagnosticConsole.tsx` (full file, 408 lines)
- ‚úÖ `src/stores/PatchStore.ts` (lines 250, 330, 897, 929)
- ‚úÖ `src/stores/DiagnosticsStore.ts` (no action methods)
- ‚úÖ `design-docs/CANONICAL-oscilla-v2.5-20260109/topics/07-diagnostics-system.md` (lines 368-379, 835-854)
- ‚úÖ Test suite: 0 action-related tests found

**Search Patterns Used**:
- Grep: `actions?: *DiagnosticAction` ‚Üí Found type definitions only, no usage
- Grep: `executeAction|applyAction|handleAction` ‚Üí 0 results
- Grep: `TODO|FIXME` ‚Üí Found diagnostics config migration note, not action-related
- File search: `*ActionExecutor*`, `*ActionHandler*`, `*QuickFix*` ‚Üí 0 results
- Test search: `npm test --listTests | grep -i action` ‚Üí 0 results

**Runtime Checks**: N/A (feature unimplemented, no runtime behavior exists)

---

## Final Evaluation

**Completion**: 5% (type placeholder exists, nothing else)  
**Blockers**: 0  
**Ambiguities**: 0  
**Confidence**: MEDIUM-HIGH (undo/redo integration uncertainty only)  
**Workflow**: **CONTINUE** ‚úÖ

Implementation can proceed immediately. Spec is clear, dependencies ready, path forward obvious.
