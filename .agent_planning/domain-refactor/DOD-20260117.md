# Domain Refactor - Definition of Done

**Topic:** Complete and total domain refactor
**Created:** 2026-01-17
**Plan Reference:** `PLAN-20260117.md`

---

## Overall Success Criteria

The refactor is complete when ALL of the following are true:

### 1. Old Types Removed

- [ ] `DomainId` (old unbranded string type) no longer exists in `src/core/canonical-types.ts`
- [ ] `DomainRef` (old conflated reference) no longer exists
- [ ] `DomainShape` no longer exists
- [ ] `DomainDecl` no longer exists
- [ ] `domainRef()` factory no longer exists
- [ ] `domainDeclFixedCount()` factory no longer exists
- [ ] `domainDeclGrid2d()` factory no longer exists
- [ ] `domainDeclVoices()` factory no longer exists
- [ ] `domainDeclMeshVertices()` factory no longer exists
- [ ] `DomainDef` no longer exists in `src/compiler/ir/types.ts`
- [ ] Old `DomainId` no longer exported from `src/types/index.ts`

### 2. New Types Exist

- [ ] `DomainTypeId` branded type exists with factory
- [ ] `InstanceId` branded type exists with factory
- [ ] `InstanceRef` interface exists (`{ kind: 'instance', domainType, instanceId }`)
- [ ] `InstanceDecl` interface exists (`{ id, domainType, count, layout, lifecycle }`)
- [ ] `LayoutSpec` discriminated union exists (grid, circular, linear, random, custom)
- [ ] `DomainType` interface exists (`{ id, parent, intrinsics }`)
- [ ] `IntrinsicSpec` interface exists (`{ name, type, computation }`)

### 3. Domain Registry Exists

- [ ] `src/core/domain-registry.ts` exists
- [ ] Domain type constants defined: `DOMAIN_SHAPE`, `DOMAIN_CIRCLE`, `DOMAIN_RECTANGLE`, `DOMAIN_CONTROL`, `DOMAIN_EVENT`
- [ ] `getDomainType(id)` function works
- [ ] `isSubdomainOf(sub, parent)` function works (circle is subdomain of shape)
- [ ] `getIntrinsics(domainType)` returns correct intrinsics including inherited
- [ ] `hasIntrinsic(domainType, name)` function works

### 4. Old Blocks Deleted

- [ ] `GridDomain` block no longer exists
- [ ] `DomainN` block no longer exists
- [ ] `src/blocks/domain-blocks.ts` is either deleted or contains only new instance blocks
- [ ] No block registration references deleted blocks

### 5. New Instance Blocks Exist

- [ ] `CircleInstance` block exists with:
  - Inputs: count, layout
  - Outputs: position, radius, index, t (intrinsics)
- [ ] At least one layout block exists (e.g., `GridLayout`)
- [ ] Instance blocks create `InstanceDecl` via `createInstance()`

### 6. Field Operations Use Instance Context

- [ ] No hardcoded `domainId('default')` in any block file
- [ ] `LoweringContext` has `instance?: InstanceId` field
- [ ] `LoweringContext` has `inferredInstance?: InstanceId` field
- [ ] Field operation blocks use instance context from lowering
- [ ] Instance mismatch throws compile error

### 7. Render Blocks Use Instance Inference

- [ ] Render blocks don't have "domain" input (the confusing one)
- [ ] Render blocks infer instance from field inputs
- [ ] Render steps have `instanceId`, not `domain`

### 8. IR Uses Instance Model

- [ ] `IRBuilder.createInstance()` method exists
- [ ] `IRBuilder.getInstances()` method exists
- [ ] `IRBuilder.fieldIntrinsic()` method exists
- [ ] `IRBuilderImpl` implements new methods
- [ ] `FieldExprSource` uses `instanceId` and `intrinsic`
- [ ] `StepMaterialize` uses `instanceId`
- [ ] `StepRender` uses `instanceId`
- [ ] `IRProgram.instances` exists (not `domains`)

### 9. Compiler Passes Updated

- [ ] `pass7-schedule.ts` uses `InstanceId` and `InstanceDecl`
- [ ] `ScheduleIR.instances` exists (not `domains`)
- [ ] Instance unification tests pass

### 10. Runtime Updated

- [ ] `Materializer.materialize()` uses `instanceId` and `instances` map
- [ ] Buffer sizing uses instance count correctly
- [ ] Execution produces correct results

### 11. Tests Pass

- [ ] All existing tests pass (275+ tests)
- [ ] No tests reference old type names
- [ ] `instance-unification.test.ts` exists (renamed from domain-unification)
- [ ] Steel-thread test works with new model

### 12. No Old Model References

- [ ] `grep -r "DomainDef" src/` returns nothing
- [ ] `grep -r "GridDomain" src/` returns nothing
- [ ] `grep -r "DomainN" src/` returns nothing
- [ ] `grep -r "domainId('default')" src/` returns nothing
- [ ] No TypeScript errors

---

## Sprint-Specific Acceptance Criteria

### Sprint 1: Foundation Types

- [ ] Domain registry file created
- [ ] New types added to canonical-types.ts
- [ ] Old types still work (temporary)
- [ ] All tests pass

### Sprint 2: IR Types

- [ ] InstanceDecl and LayoutSpec added
- [ ] IRBuilder interface updated
- [ ] IRBuilderImpl has new methods
- [ ] Old methods still work (temporary)
- [ ] All tests pass

### Sprint 3: Instance Blocks

- [ ] CircleInstance block works
- [ ] GridLayout block works
- [ ] LoweringContext has instance fields
- [ ] Instance propagation works
- [ ] All tests pass

### Sprint 4: Field Operations

- [ ] 20+ field blocks updated
- [ ] No hardcoded domainId('default')
- [ ] Instance context used correctly
- [ ] All tests pass

### Sprint 5: Render & Cleanup

- [ ] Render blocks use instance inference
- [ ] domain-blocks.ts deleted or cleaned
- [ ] GridDomain/DomainN removed
- [ ] All tests pass

### Sprint 6: Compiler Passes

- [ ] pass7-schedule uses instances
- [ ] Steps use instanceId
- [ ] Instance unification works
- [ ] All tests pass

### Sprint 7: Runtime

- [ ] Materializer updated
- [ ] Execution works
- [ ] Rendered output correct
- [ ] All tests pass

### Sprint 8: Cleanup

- [ ] Old types deleted
- [ ] All tests updated
- [ ] No old references remain
- [ ] All tests pass

---

## Verification Commands

```bash
# All tests pass
npm run test

# No old type references
grep -r "DomainDef" src/ --include="*.ts"
grep -r "GridDomain" src/ --include="*.ts"
grep -r "DomainN" src/ --include="*.ts"
grep -r "domainId('default')" src/ --include="*.ts"

# TypeScript compiles
npm run typecheck

# Build succeeds
npm run build
```

---

## Rollback Plan

If refactor fails:
1. Each sprint is designed to keep old paths working until deleted
2. Git revert to pre-refactor commit
3. Cherry-pick any unrelated fixes

---

## Notes

- Tests should assert on BEHAVIOR, not STRUCTURE
- Old types are kept during migration for gradual transition
- Final cleanup sprint removes all old types
- Domain registry is a new module, not a modification
