# Evaluation: Unify Inputs and Params

**Generated:** 2026-01-20
**Topic:** Fold params into inputs, make outputs symmetric

## Final Architecture

### InputDef (Unified)

```typescript
interface InputDef {
  // Identity & Display
  readonly id: string;              // Port/param identifier
  readonly label?: string;          // Display label (defaults to id)
  readonly type?: SignalType;       // Type for wirable ports

  // Value & Defaults
  readonly value?: unknown;         // Default value (replaces params[key])
  readonly defaultSource?: DefaultSource;  // What to wire if unwired

  // Port Exposure
  readonly exposedAsPort?: boolean; // true = wirable port, false = config only (default: true for back-compat)
  readonly optional?: boolean;      // For ports: is wiring optional?

  // UI
  readonly uiHint?: UIControlHint;  // How to render in inspector
  readonly hidden?: boolean;        // Hide from UI (e.g., payloadType)
}
```

### OutputDef (Symmetric)

```typescript
interface OutputDef {
  readonly id: string;
  readonly label?: string;          // Display label (defaults to id)
  readonly type: SignalType;        // Required for outputs

  // Future extensibility - keep symmetric with InputDef
  readonly hidden?: boolean;        // Hide from UI if needed
}
```

### BlockDef Changes

```typescript
interface BlockDef {
  // ... existing identity, category, form, capability ...

  // CHANGED: inputs is now Record, not array
  readonly inputs: Record<string, InputDef>;

  // CHANGED: outputs is now Record for symmetry
  readonly outputs: Record<string, OutputDef>;

  // REMOVED: params - folded into inputs
  // readonly params?: Record<string, unknown>;  // DELETED

  readonly lower: (args: LowerArgs) => LowerResult;
}
```

## Migration Examples

### Circle (port with config fallback)

**Before:**
```typescript
registerBlock({
  type: 'Circle',
  inputs: [
    {
      id: 'radius',
      label: 'Radius',
      type: signalType('float'),
      defaultValue: 0.02,
      defaultSource: defaultSourceConst(0.02),
      uiHint: { kind: 'slider', min: 0.01, max: 0.5, step: 0.01 },
    },
  ],
  outputs: [
    { id: 'circle', label: 'Circle', type: signalType('float') },
  ],
  params: {
    radius: 0.02,
  },
  lower: ...
});
```

**After:**
```typescript
registerBlock({
  type: 'Circle',
  inputs: {
    radius: {
      label: 'Radius',
      type: signalType('float'),
      value: 0.02,
      defaultSource: defaultSourceConst(0.02),
      uiHint: { kind: 'slider', min: 0.01, max: 0.5, step: 0.01 },
      exposedAsPort: true,
    },
  },
  outputs: {
    circle: { label: 'Circle', type: signalType('float') },
  },
  lower: ...
});
```

### Const (config only, no port)

**Before:**
```typescript
registerBlock({
  type: 'Const',
  inputs: [],
  outputs: [
    { id: 'out', label: 'Output', type: signalType('???') },
  ],
  params: {
    value: 0,
    uiHint: { kind: 'slider', min: 1, max: 10000, step: 1 },  // BROKEN
  },
  lower: ...
});
```

**After:**
```typescript
registerBlock({
  type: 'Const',
  inputs: {
    value: {
      value: 0,
      uiHint: { kind: 'slider', min: 1, max: 10000, step: 1 },
      exposedAsPort: false,  // Config only, no wire
    },
    payloadType: {
      value: undefined,
      hidden: true,  // Set by normalizer
      exposedAsPort: false,
    },
  },
  outputs: {
    out: { label: 'Output', type: signalType('???') },
  },
  lower: ...
});
```

### Add (ports only, must wire)

**Before:**
```typescript
registerBlock({
  type: 'Add',
  inputs: [
    { id: 'a', label: 'A', type: signalType('float') },
    { id: 'b', label: 'B', type: signalType('float') },
  ],
  outputs: [
    { id: 'out', label: 'Output', type: signalType('float') },
  ],
  params: {},
  lower: ...
});
```

**After:**
```typescript
registerBlock({
  type: 'Add',
  inputs: {
    a: { label: 'A', type: signalType('float'), exposedAsPort: true },
    b: { label: 'B', type: signalType('float'), exposedAsPort: true },
  },
  outputs: {
    out: { label: 'Output', type: signalType('float') },
  },
  lower: ...
});
```

## Scope of Changes

### Type Changes
1. `src/blocks/registry.ts` - InputDef, OutputDef, BlockDef interfaces
2. `src/types/index.ts` - May have duplicate types to consolidate

### Block Files (~15 files)
- `src/blocks/array-blocks.ts`
- `src/blocks/color-blocks.ts`
- `src/blocks/field-blocks.ts`
- `src/blocks/field-operations-blocks.ts`
- `src/blocks/geometry-blocks.ts`
- `src/blocks/identity-blocks.ts`
- `src/blocks/instance-blocks.ts`
- `src/blocks/math-blocks.ts`
- `src/blocks/primitive-blocks.ts`
- `src/blocks/render-blocks.ts`
- `src/blocks/signal-blocks.ts`
- `src/blocks/test-blocks.ts`
- `src/blocks/time-blocks.ts`

### Consumer Code
1. `src/ui/components/BlockInspector.tsx` - Render inputs as config UI
2. `src/graph/normalize.ts` - Reads inputs for port info
3. `src/compiler/passes-v2/*.ts` - May access inputs/outputs
4. Any code that iterates `def.inputs` as array

### Key Pattern Changes
- `def.inputs.find(i => i.id === 'x')` → `def.inputs.x` or `def.inputs['x']`
- `def.inputs.map(...)` → `Object.entries(def.inputs).map(...)`
- `config?.paramKey` → `def.inputs.paramKey.value` (for defaults)
- Port list = `Object.entries(def.inputs).filter(([_, d]) => d.exposedAsPort !== false)`

## Risks

1. **Breaking change** - All block registrations change format
2. **Consumer code** - Need to find all places that iterate inputs as array
3. **Normalizer** - Heavy user of input/output definitions

## Verdict

**CONTINUE** - Architecture is clear, scope is understood.
