# Explore Output: ValueExpr Migration State
Timestamp: 2026-01-31-110000

## Files Examined

### Type Definitions
- `src/compiler/ir/value-expr.ts` (301 lines) - 10-kind discriminated union, all variants carry CanonicalType
- `src/compiler/ir/Indices.ts` - ValueExprId branded type
- `src/compiler/ir/program.ts:187` - ValueExprTable interface with nodes, sigToValue, fieldToValue, eventToValue

### Lowering Pass
- `src/compiler/ir/lowerToValueExprs.ts` (341 lines) - Post-compilation pass, 4-phase lowering
- Called from `src/compiler/compile.ts:670` as final step of compilation
- Handles reduceField ordering (deferred to Phase 3 after fields)

### Signal Evaluator
- `src/runtime/ValueExprSignalEvaluator.ts` (587 lines)
- Handles all signal-extent kinds with exhaustive switch
- `reduce` case returns 0 (matches legacy SignalEvaluator behavior at line 202-207)
- `shapeRef` returns 0 (same approach)
- `palette` returns 0 (hardcoded)
- Duplicates `applySignalKernel` from legacy (300+ lines of kernel implementations)
- `PureFn.expr` throws "not yet implemented" (matches legacy)

### Event Evaluator
- `src/runtime/ValueExprEventEvaluator.ts` (151 lines)
- Handles all 5 event kinds (const, never, pulse, combine, wrap)
- Cycle detection via Uint8Array on state
- Uses separate `state.eventPrevPredicateValue` for edge detection (indexed by ValueExprId)
- Cross-evaluator call to `evaluateValueExprSignal` for wrap input

### Materializer
- `src/runtime/ValueExprMaterializer.ts` (656 lines)
- Handles const, intrinsic (property + placement), kernel (broadcast, map, zip, zipSig, pathDerivative), state
- Uses dummy CanonicalType at lines 515-518 with `instanceId as any as string` cast
- Buffer caching via `state.cache.valueExprFieldBuffers` and `valueExprFieldStamps`

### ScheduleExecutor Integration
- `src/runtime/ScheduleExecutor.ts`
- Signal: `SHADOW_EVAL = false`, `VALUE_EXPR_ONLY = false` (both disabled)
- Materializer: `SHADOW_MATERIALIZE = false`, `VALUE_EXPR_MATERIALIZE = false` (both disabled)
- Event: Shadow mode only (SHADOW_EVAL reused), NO cutover flag exists
- Shadow mode comparison: signals (exact + epsilon), fields (Float32Array element-wise), events (boolean exact)
- Sampling: fields sampled at `SHADOW_MAT_FRAME_INTERVAL=10`, `SHADOW_MAT_PER_FRAME_LIMIT=5`

### RuntimeState Cache
- `src/runtime/RuntimeState.ts`
- `valueExprValues: Float64Array`, `valueExprStamps: Uint32Array` - signal cache
- `valueExprFieldBuffers: (Float32Array | null)[]`, `valueExprFieldStamps: number[]` - field cache
- `eventPrevPredicateValue: Uint8Array` - separate from legacy event edge detection
- `eventCycleDetection?: Uint8Array` - lazy allocation

### Tests
- `src/compiler/ir/__tests__/value-expr-invariants.test.ts` - structural invariants, compile-time exhaustiveness
- `src/compiler/ir/__tests__/lowerToValueExprs.test.ts` - lowering pass unit tests
- `src/runtime/__tests__/ValueExprEventEvaluator.test.ts` - event evaluator tests
- `src/runtime/__tests__/valueexpr-signal-shadow.test.ts` - shadow mode integration tests
- NO dedicated ValueExprSignalEvaluator unit tests
- NO dedicated ValueExprMaterializer unit tests
- `.orig` file: `src/compiler/ir/__tests__/lowerToValueExprs.test.ts.orig` (leftover)

### Test Results
- 132 test files, 2057 passed, 15 skipped, 2 todo
- `npx tsc --noEmit` clean (0 errors)

### Key Observations
1. All cutover flags are `false` - system runs legacy-only by default
2. Shadow mode flags are `false` - shadow validation is NOT actively running
3. No reverse mappings (valueToSig, valueToField) exist - clean design
4. Event cutover flag is missing entirely (signal + materializer have cutover flags)
5. Significant code duplication between legacy and ValueExpr evaluators
6. `lowerToValueExprs.test.ts.orig` file should be cleaned up
