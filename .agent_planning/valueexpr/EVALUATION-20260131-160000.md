# Evaluation: ValueExpr Direct Lowering (Legacy Deletion)
Generated: 2026-01-31T16:00:00Z
Verdict: CONTINUE

## Context

User directive: Skip gradual migration. Delete legacy SigExpr/FieldExpr/EventExpr types entirely. Block lowering emits ValueExpr directly. No dual world.

Previous plans (dual-emit, shadow mode, validation-cutover) are **superseded** by this directive.

## Current State Assessment

### What's Already Done (✅)
1. **ValueExpr type system** — Complete (10 kinds, all with CanonicalType) in `value-expr.ts`
2. **ValueExprId** — Branded number, defined in `Indices.ts`
3. **Runtime evaluators** — Fully migrated to ValueExpr:
   - `ValueExprSignalEvaluator.ts` — signal-extent
   - `ValueExprMaterializer.ts` — field-extent
   - `ValueExprEventEvaluator.ts` — event-extent
4. **Legacy evaluators deleted** — SignalEvaluator.ts, EventEvaluator.ts, Materializer.ts removed
5. **Tripwire test** — `no-legacy-evaluator.test.ts` prevents reintroduction
6. **SignalKernelLibrary** — Extracted shared kernels (commits f55b3ae, 44c04ae)
7. **RenderAssembler** — No longer calls evaluateSignal (commit d6cbff0)

### What's Still Legacy (❌)
1. **IRBuilder** — Only emits SigExpr/FieldExpr/EventExpr. No ValueExpr methods.
2. **11 block files** — All `lower()` functions use legacy builder API (sigMap, fieldZip, etc.)
3. **Schedule Step types** — Reference SigExprId/FieldExprId/EventExprId
4. **schedule-program.ts** — Builds steps with legacy IDs
5. **ScheduleExecutor** — Maps legacy IDs → ValueExprId at runtime (per-step translation)
6. **ValueRefPacked** — Discriminated on `kind: 'signal'|'field'|'event'` with legacy IDs
7. **lowerToValueExprs.ts** — Bridge pass converting legacy → ValueExpr (342 lines)
8. **CompiledProgramIR** — Contains both legacy tables and ValueExpr table

### Dual-World Tax (Quantified)
- **Memory**: 4 expression tables + 3 translation maps instead of 1 table
- **CPU**: Per-step array lookup every frame for ID translation
- **Cognitive**: Two type systems, two naming schemes, no direct builder path
- **Files affected**: ~33 files reference legacy types

## Risk Assessment

| Risk | Severity | Mitigation |
|------|----------|------------|
| Block lowering regression | HIGH | Existing test suite (2057+ tests) validates end-to-end |
| Schedule step type change breaks runtime | HIGH | ScheduleExecutor already evaluates via ValueExpr; just removing indirection |
| Missed legacy reference | LOW | Tripwire test catches any survivors |
| ValueExprBuilder API mismatch | MEDIUM | lowerToValueExprs proves type equivalence — use it as specification |

## Verdict: CONTINUE

No blockers. The runtime has already proven ValueExpr works end-to-end. The remaining work is mechanical: replace the builder API, update blocks, update schedule types, delete bridge.

**Key insight**: `lowerToValueExprs.ts` is the *specification* for what the new builder must produce. Every legacy → ValueExpr conversion in that file tells us exactly what the direct builder method should emit.
