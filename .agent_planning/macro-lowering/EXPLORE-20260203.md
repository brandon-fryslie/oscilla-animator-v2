# Explore: Macro Lowering
Timestamp: 2026-02-03

## Design Doc

File: `design-docs/_new/pure-lowering-blocks/01-macro-lowering.md` (139 lines)

Three-part design:
1. **DefaultSource block**: Polymorphic structural block inserted by normalization for unconnected inputs. Defers value to lowering time. Uses type-indexed policy table (DefaultKey -> DefaultPlan). Plans: rail, const, construct, error. Per-port profile overrides via profileId.
2. **LowerSandbox**: Constrained IR builder for macro invocation. API: emitConst, emitOp, emitKernel, emitExtract, emitConstruct, readRail. NOT allowed: slot allocation, schedule step registration, reading other blocks/edges, mutable globals.
3. **Pure lowering contract**: Two-result model (exprOutputs + effects). Purity tagging on BlockDef: `loweringPurity: "pure" | "stateful" | "impure"`. Mechanical enforcement (determinism check, deepFreeze, forbidden imports).

## Current State: normalize-default-sources.ts

File: `src/compiler/frontend/normalize-default-sources.ts` (296 lines)

- Line 199-205: Fallback for inputs with no defaultSource creates a `DefaultSource` block:
  ```typescript
  const effectiveDefault: DefaultSource = portOverride ?? registryDefault ?? {
      blockType: 'DefaultSource',
      output: 'out',
      params: {},
  };
  ```
- Line 232: `applyDefaultSourceInsertions` calls `requireBlockDef(ins.block.type)` which THROWS for 'DefaultSource' since NO SUCH BLOCK IS REGISTERED.

### CRITICAL: 11 test failures due to this

```
UnknownBlockTypeError: Unknown block type: "DefaultSource" is not registered
```

The normalization pass creates `DefaultSource` blocks but there is NO `DefaultSource` block definition registered anywhere in the codebase. This causes compilation to fail for any graph with unconnected inputs that lack an explicit defaultSource in the registry.

Affected test files:
- src/compiler/__tests__/compile.test.ts (4 failures)
- src/compiler/backend/__tests__/backend-preconditions.test.ts (3 failures)
- src/compiler/frontend/__tests__/frontend-independence.test.ts (4 failures)

## Current State: lower-blocks.ts (Pass 6)

File: `src/compiler/backend/lower-blocks.ts` (987 lines)

### LowerCtx interface (registry.ts:26-60)
```typescript
interface LowerCtx {
  blockIdx, blockType, instanceId, label,
  inTypes, outTypes,
  b: IRBuilder,  // FULL IRBuilder - no sandbox restriction
  seedConstId,
  instance?, inferredInstance?,
  varargConnections?, addressRegistry?
}
```

### LowerArgs interface (registry.ts:65-83)
```typescript
interface LowerArgs {
  ctx: LowerCtx,
  inputs: ValueRefExpr[],
  inputsById: Record<string, ValueRefExpr>,
  varargInputsById?: Record<string, ValueRefExpr[]>,
  config?: Record<string, unknown>,
  block?: Block,  // ACCESS TO SOURCE BLOCK (impure!)
  existingOutputs?: Partial<LowerResult>
}
```

### LowerResult interface (registry.ts:88-104)
```typescript
interface LowerResult {
  outputsById: Record<string, ValueRefExpr>,
  instanceContext?: InstanceId,
  stateSlot?: StateSlotId
}
```

Key observations:
- Lower functions receive the FULL IRBuilder (not a sandbox)
- Lower functions receive the source Block object (can read graph state)
- LowerResult is a SINGLE result (no effects separation)
- No `loweringPurity` field on BlockDef

### Slot allocation in lower-blocks.ts (lines 516-542)
After a block's lower() returns, pass6 does slot registration:
```
builder.registerFieldSlot(ref.id, ref.slot);
builder.registerSlotType(ref.slot, ref.type);
builder.registerSigSlot(ref.id, ref.slot);
```

But blocks ALSO call `ctx.b.allocSlot()` inside their lower() - 132 total occurrences across 80 block files.

## Purity Analysis of Current lower() Functions

### Pure blocks (allocSlot only - no state, no side effects beyond slot allocation)
- All math blocks (add, subtract, multiply, divide, sin, cos, etc.)
- All adapter blocks (phase-to-scalar, clamp01, etc.)
- All lens blocks (scale-bias, smoothstep, etc.)
- Color blocks (mix-color, hsl-to-rgba, etc.)
- Const block
- Broadcast, Reduce
- 65+ blocks

### Stateful blocks (allocStateSlot + state read/write)
- unit-delay.ts (allocStateSlot)
- phasor.ts (allocStateSlot)
- accumulator.ts (allocStateSlot)
- lag.ts (allocStateSlot)
- sample-hold.ts (allocStateSlot)
- slew.ts (allocStateSlot)

### Complex/impure blocks
- infinite-time-root.ts (7 slot operations, step registrations)
- array.ts (createInstance, 4 allocSlots)
- expression.ts (addressRegistry access)
- render blocks (camera, render-instances-2d - render global registration)

## DefaultSource / HueRainbow Gap

- NO `DefaultSource` block is registered. The normalization pass references it but it doesn't exist.
- NO `HueRainbow` block exists anywhere in the codebase.
- Color-related blocks: `Adapter_HslToRgba`, `MakeColorHSL`, `MixColor`, `ColorPicker`, `HueShift`, `SplitColorHSL`, `AlphaMultiply`, `FieldConstColor`
- The design doc's example of "default color via HueRainbow(phaseA)" has NO implementation target.

## BlockDef Interface Gap

- No `loweringPurity` field exists on BlockDef
- No `LowerSandbox` type exists
- No `LowerEffects` type exists
- No two-result model (exprOutputs + effects)
- Current: single LowerResult with outputsById + optional instanceContext/stateSlot

## IRBuilder Surface Area vs Sandbox

Current IRBuilder exposes 40+ methods including:
- Slot allocation: allocSlot, allocTypedSlot, allocEventSlot, allocStateSlot
- Step registration: stepSlotWriteStrided, stepStateWrite, stepFieldStateWrite, stepEvalSig, stepMaterialize, stepContinuityMapBuild, stepContinuityApply
- Instance creation: createInstance
- Render globals: addRenderGlobal
- Build results: getSteps, getStateMappings, etc.

Design doc's LowerSandbox would expose only:
- emitConst, emitOp, emitKernel, emitExtract, emitConstruct, readRail

This is roughly: constant, kernelMap, kernelZip, extract, construct, time (for rails).

## DefaultSource Type (types/index.ts)

```typescript
type DefaultSource = {
  blockType: string;
  output: string;
  params?: Record<string, unknown>;
};
```

Helper constructors: `defaultSourceConst(value)`, `defaultSourceTimeRoot(output)`, `defaultSource(blockType, output, params)`.

No `DefaultPlan`, `DefaultKey`, or policy table types exist.
