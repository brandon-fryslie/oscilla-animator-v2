# Explore Output: Pure Lowering Two-Result Model
Timestamp: 2026-02-03-033701
Git Commit: 9f0aaec (branch: bmf_type_system_refactor)

## Files Examined

### Spec
- `design-docs/_new/pure-lowering-blocks/01-macro-lowering.md` (139 lines)

### Implementation Files
- `src/blocks/registry.ts` - BlockDef, LowerResult, LowerArgs, LowerCtx, LoweringPurity type
- `src/compiler/backend/lower-blocks.ts` - Pass 6 orchestrator with pure block slot allocation
- `src/compiler/ir/LowerSandbox.ts` - Macro expansion utility (127 lines)
- `src/compiler/ir/PureIRBuilder.ts` - Interface definition (127 lines)
- `src/compiler/ir/lowerTypes.ts` - ValueRefExpr with optional slot
- `src/blocks/math/add.ts` - Pure block example
- `src/blocks/signal/default-source.ts` - DefaultSource with type-indexed dispatch
- `src/blocks/color/hue-rainbow.ts` - HueRainbow pure block

## Test Results

- `npx vitest run`: 142 passed, 6 skipped, 1 unhandled error (worker crash, unrelated)
- `npx tsc --noEmit`: Clean (0 errors)
- No test files cover LowerSandbox, PureIRBuilder, DefaultSource block, or HueRainbow block

## Key Findings

### 1. PureIRBuilder is Dead Code
- Defined in `src/compiler/ir/PureIRBuilder.ts`
- Never imported or used anywhere except a comment in LowerSandbox.ts
- LowerSandbox passes full IRBuilder to ctx.b (line 105)
- No compile-time restriction is actually enforced

### 2. LoweringPurity Type is Incomplete
- `registry.ts:139`: `export type LoweringPurity = 'pure';`
- Spec requires: `'pure' | 'stateful' | 'impure'`
- Only 3 blocks tagged pure: Add, DefaultSource, HueRainbow

### 3. Slot Allocation Flow Works
- Pure blocks return `slot: undefined`
- Orchestrator at `lower-blocks.ts:518-525` detects this and allocates
- Non-null assertions `slot!` at lines 549-560 are safe (post-allocation)

### 4. LowerSandbox Purity Not Enforced at Runtime
- Line 105: `b: this.builder` passes full IRBuilder
- Pure blocks CAN call allocSlot, stepSlotWriteStrided, etc. at runtime
- Only compile-time restriction is TypeScript interface (but it's not used)

### 5. PureIRBuilder Includes createInstance (Contradicts Purity)
- Line 121-125: createInstance() is in PureIRBuilder interface
- Comment says "may read instance context but not create new instances"
- But the method signature creates instances

### 6. LowerResult Still Uses Old Model
- `registry.ts:88-104`: `{ outputsById, instanceContext?, stateSlot? }`
- Spec requires: `{ exprOutputs: Record<PortId, ValueExprId>, effects?: LowerEffects }`
- No LowerEffects type exists anywhere
- No separate compiler stage for turning effects into slot allocations

### 7. DefaultSource Uses Direct IR Emission (No DefaultPlan)
- No `DefaultPlan` type (rail, const, construct, error variants)
- No `DefaultKey` type
- No `chooseDefault()` function
- Switch statement directly emits IR per payload kind

### 8. No Per-Port Profile Overrides
- No `profileId` system
- No `DefaultSourceBlockParams` interface
- No profile lookup

### 9. No Mechanical Purity Enforcement
- No determinism check (run twice, compare)
- No deepFreeze on params/inputs
- No ESLint rule for forbidden imports
- No record-and-replay mode

### 10. No Macro Trace Diagnostics
- No `{ producer: DefaultSource(anchor), expandedUsing: HueRainbow }` trace
- Errors are thrown as plain Error objects, not diagnostic structures

### Blocks Using loweringPurity:'pure'
```
src/blocks/math/add.ts:20
src/blocks/signal/default-source.ts:38
src/blocks/color/hue-rainbow.ts:23
```

### Files Referencing loweringPurity (non-docs)
```
src/blocks/registry.ts (type definition + BlockDef field)
src/compiler/backend/lower-blocks.ts (orchestrator check at line 520, 688)
src/compiler/ir/LowerSandbox.ts (runtime purity gate at line 63)
```
