# Index Output Format Specification

This document defines the exact format for document index files generated by the doc-index skill.

## File Naming

- Source: `{path}/{filename}.md`
- Index: `{path}/{filename}.INDEX.md`

## Frontmatter

All index files MUST include YAML frontmatter with these fields:

```yaml
---
indexed: true                           # Boolean: marks this as an index file
source: {relative_path}                 # String: path to source from repo root
source_hash: sha256:{first_12_chars}    # String: truncated SHA-256 of source
source_mtime: {ISO_timestamp}           # String: modification time (ISO 8601)
original_tokens: ~{estimate}            # Number: estimated token count of source
index_tokens: ~{estimate}               # Number: estimated token count of index
compression: {percentage}%              # Number: index/original ratio
index_version: 1.0                      # String: format version for future compatibility
---
```

### Field Descriptions

| Field | Type | Example | Purpose |
|-------|------|---------|---------|
| `indexed` | boolean | `true` | Marker for index files (enables glob filtering) |
| `source` | string | `design-docs/spec/00-invariants.md` | Relative path from repo root |
| `source_hash` | string | `sha256:a1b2c3d4e5f6` | First 12 chars of SHA-256 for staleness detection |
| `source_mtime` | string | `2026-01-11T10:00:00Z` | ISO 8601 timestamp for quick staleness check |
| `original_tokens` | number | `~2400` | Approximate token count (word_count * 1.3) |
| `index_tokens` | number | `~520` | Approximate index token count |
| `compression` | string | `48%` | Compression ratio (index/original * 100), typically 40-50% with full line ranges |
| `index_version` | string | `1.0` | Format version for future migrations |

## Body Structure

After frontmatter, the index body MUST include:

```markdown
# Index: {source_filename}

## Key Assertions
{list_of_MUST_MUST_NOT_statements}

## Definitions
{list_of_canonical_term_definitions}

## Invariants
{list_of_named_invariants}

## Data Structures
{list_of_interface_field_signatures}

## Dependencies
{what_depends_on_what}

## Decisions
{architectural_choices_with_rationale}

## Tier Classification
{suggested_tier_with_rationale}
```

### Section: Key Assertions

**Purpose:** Capture all non-negotiable constraints.

**Format:**
```markdown
## Key Assertions
- MUST: {assertion} [L{start}-{end}]
- MUST NOT: {constraint} [L{start}-{end}]
- SHALL: {requirement} [L{start}-{end}]
```

**Rules:**
- One bullet per assertion
- Include complete subject-verb-object when possible
- **Always include line range** `[L{start}-{end}]` for multi-line, `[L{num}]` for single line
- Sort by line number (ascending)

**Example:**
```markdown
## Key Assertions
- MUST: All signals flow through typed ports [L12]
- MUST: Types unify only if all 5 axes compatible [L34]
- MUST NOT: Blocks reference future state [L78]
- MUST NOT: Domain cross compilation boundaries [L92]
```

### Section: Definitions

**Purpose:** Capture canonical term definitions for contradiction detection.

**Format:**
```markdown
## Definitions
- **{Term}**: {concise_definition} [L{start}-{end}]
```

**Rules:**
- Term in bold
- Definition max 1 sentence
- Include line reference
- Sort alphabetically by term

**Example:**
```markdown
## Definitions
- **Extent**: 5-tuple (time, freq, amp, spat, batch) defining signal shape [L30]
- **PayloadType**: Either Float or Int, determines value representation [L25]
- **CanonicalType**: Union of PayloadType and Extent (5-axis model) [L23]
```

### Section: Invariants

**Purpose:** Capture named rules that must always hold.

**Format:**
```markdown
## Invariants
- **{ID}**: {rule} [L{start}-{end}]
```

**Rules:**
- ID in bold (preserve original ID: I1, INV-001, Rule 5, etc.)
- Complete rule statement
- Include line reference
- Sort by ID (numerical/lexicographic)

**Example:**
```markdown
## Invariants
- **I1**: Port type compatibility checked at wire creation [L55]
- **I2**: Each block has exactly one canonical definition location [L62]
- **I3**: State machines have explicit, enumerable states [L70]
```

### Section: Data Structures

**Purpose:** Capture interface signatures for structural comparison.

**Format:**
```markdown
## Data Structures
- **{Name}**: { {field1}, {field2}, ... } [L{start}-{end}]
```

**Rules:**
- Structure name in bold
- Field names only (omit types)
- Use `?` suffix for optional fields
- Alphabetize fields
- Include line reference

**Example:**
```markdown
## Data Structures
- **Block**: { id, parameters, ports, role, state? } [L100]
- **Port**: { connected, direction, id, canonicalType } [L120]
- **Wire**: { from, canonicalType, to } [L140]
```

### Section: Dependencies

**Purpose:** Track document relationships for impact analysis.

**Format:**
```markdown
## Dependencies
- **Depends on**: {comma_separated_list_or_none}
- **Referenced by**: {comma_separated_list_or_none}
```

**Rules:**
- List filenames only (not full paths)
- Use "(none)" for empty lists
- Sort lists alphabetically
- Include both directions

**Example:**
```markdown
## Dependencies
- **Depends on**: (none - foundational)
- **Referenced by**: 01-type-system.md, 02-topology.md, all block definitions
```

### Section: Decisions

**Purpose:** Capture architectural choices for understanding rationale.

**Format:**
```markdown
## Decisions
- DECISION: {choice} over {alternative} [L{start}-{end}]
  - Rationale: {why}
  - Alternative rejected: {what_and_why}
```

**Rules:**
- Start with "DECISION:"
- State chosen approach and rejected alternative
- Include rationale (1-2 sentences)
- Include line reference on decision line
- Indent sub-points

**Example:**
```markdown
## Decisions
- DECISION: 5-axis extent model over arbitrary dimensions [L35]
  - Rationale: Fixed axes enable compile-time optimization
  - Alternative rejected: Dynamic axis system (too complex, runtime cost)
- DECISION: Discriminated union for BlockRole over inheritance [L89]
  - Rationale: Exhaustive pattern matching prevents missing cases
  - Alternative rejected: Class hierarchy (implicit, error-prone)
```

### Section: Tier Classification

**Purpose:** Suggest appropriate tier for this content in three-tier organization.

**Format:**
```markdown
## Tier Classification
- **Suggested**: T{1|2|3} ({tier_name})
- **Rationale**: {why_this_tier}
```

**Rules:**
- Suggest exactly one tier
- Include tier name: T1 (Foundational), T2 (Structural), or T3 (Optional)
- Provide clear rationale (1-2 sentences)

**Tier Decision Criteria:**

| Tier | When to Use |
|------|-------------|
| T1 | Document defines core invariants, fundamental principles, or what makes this system unique. Changing it would make it a different application. |
| T2 | Document defines architecture, major design patterns, or data structures used across components. Changes are possible but costly. |
| T3 | Document contains implementation details, UI specs, examples, or configuration. Can change with clear justification. |

**Example:**
```markdown
## Tier Classification
- **Suggested**: T1 (Foundational)
- **Rationale**: Contains invariants (I1-I29) that define what this application IS. Changing these would fundamentally alter the system's identity and break core assumptions throughout the codebase.
```

---

## Complete Example

```markdown
---
indexed: true
source: design-docs/spec/00-invariants.md
source_hash: sha256:a1b2c3d4e5f6
source_mtime: 2026-01-11T10:00:00Z
original_tokens: ~2400
index_tokens: ~520
compression: 22%
index_version: 1.0
---

# Index: 00-invariants.md

## Key Assertions
- MUST: All signals flow through typed ports [L12]
- MUST: Time is monotonically increasing within a frame [L45]
- MUST NOT: Blocks reference future state [L78]
- MUST NOT: Direct mutation of BlockState outside runtime [L92]

## Definitions
- **Extent**: 5-tuple (time, freq, amp, spat, batch) defining signal shape [L30]
- **PayloadType**: Either Float or Int, determines value representation [L25]
- **CanonicalType**: Union of PayloadType and Extent (5-axis model) [L23]

## Invariants
- **I1**: Port type compatibility checked at wire creation [L55]
- **I2**: Each block has exactly one canonical definition location [L62]
- **I3**: State machines have explicit, enumerable states [L70]

## Data Structures
- **Block**: { id, parameters, ports, role, state? } [L100]
- **Port**: { connected, direction, id, canonicalType } [L120]
- **Wire**: { from, canonicalType, to } [L140]

## Dependencies
- **Depends on**: (none - foundational)
- **Referenced by**: 01-type-system.md, 02-topology.md, all block definitions

## Decisions
- DECISION: 5-axis extent model over arbitrary dimensions [L35]
  - Rationale: Fixed axes enable compile-time optimization
  - Alternative rejected: Dynamic axis system (too complex)

## Tier Classification
- **Suggested**: T1 (Foundational)
- **Rationale**: Contains invariants (I1-I29) that define what this application IS. Changing these would fundamentally alter the system's identity.
```

---

## Validation Rules

An index file is valid if:

1. ✅ Frontmatter contains all required fields
2. ✅ All sections present (even if empty: "None found")
3. ✅ All list items include line references `[L{start}-{end}]`
4. ✅ Compression ratio is 15-30% (acceptable range)
5. ✅ Tier classification includes suggested tier + rationale
6. ✅ No duplicate line references within a section
7. ✅ Line references are ascending within sections

---

## Version History

### 1.0 (2026-01-11)
- Initial format specification
- Seven required sections
- Frontmatter with staleness detection
- Tier classification integration
